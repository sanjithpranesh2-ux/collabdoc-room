var BZ=Object.defineProperty;var jZ=(u,_,E)=>_ in u?BZ(u,_,{enumerable:!0,configurable:!0,writable:!0,value:E}):u[_]=E;var p1=(u,_,E)=>jZ(u,typeof _!="symbol"?_+"":_,E);(function(){const _=document.createElement("link").relList;if(_&&_.supports&&_.supports("modulepreload"))return;for(const A of document.querySelectorAll('link[rel="modulepreload"]'))R(A);new MutationObserver(A=>{for(const P of A)if(P.type==="childList")for(const G of P.addedNodes)G.tagName==="LINK"&&G.rel==="modulepreload"&&R(G)}).observe(document,{childList:!0,subtree:!0});function E(A){const P={};return A.integrity&&(P.integrity=A.integrity),A.referrerPolicy&&(P.referrerPolicy=A.referrerPolicy),A.crossOrigin==="use-credentials"?P.credentials="include":A.crossOrigin==="anonymous"?P.credentials="omit":P.credentials="same-origin",P}function R(A){if(A.ep)return;A.ep=!0;const P=E(A);fetch(A.href,P)}})();var dx=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function GZ(u){return u&&u.__esModule&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u}var oJ={exports:{}},uV={},sJ={exports:{}},lr={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var eM=Symbol.for("react.element"),WZ=Symbol.for("react.portal"),HZ=Symbol.for("react.fragment"),KZ=Symbol.for("react.strict_mode"),YZ=Symbol.for("react.profiler"),zZ=Symbol.for("react.provider"),qZ=Symbol.for("react.context"),XZ=Symbol.for("react.forward_ref"),JZ=Symbol.for("react.suspense"),QZ=Symbol.for("react.memo"),ZZ=Symbol.for("react.lazy"),XX=Symbol.iterator;function $Z(u){return u===null||typeof u!="object"?null:(u=XX&&u[XX]||u["@@iterator"],typeof u=="function"?u:null)}var aJ={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},cJ=Object.assign,dJ={};function qy(u,_,E){this.props=u,this.context=_,this.refs=dJ,this.updater=E||aJ}qy.prototype.isReactComponent={};qy.prototype.setState=function(u,_){if(typeof u!="object"&&typeof u!="function"&&u!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,u,_,"setState")};qy.prototype.forceUpdate=function(u){this.updater.enqueueForceUpdate(this,u,"forceUpdate")};function lJ(){}lJ.prototype=qy.prototype;function Xq(u,_,E){this.props=u,this.context=_,this.refs=dJ,this.updater=E||aJ}var Jq=Xq.prototype=new lJ;Jq.constructor=Xq;cJ(Jq,qy.prototype);Jq.isPureReactComponent=!0;var JX=Array.isArray,uJ=Object.prototype.hasOwnProperty,Qq={current:null},hJ={key:!0,ref:!0,__self:!0,__source:!0};function pJ(u,_,E){var R,A={},P=null,G=null;if(_!=null)for(R in _.ref!==void 0&&(G=_.ref),_.key!==void 0&&(P=""+_.key),_)uJ.call(_,R)&&!hJ.hasOwnProperty(R)&&(A[R]=_[R]);var q=arguments.length-2;if(q===1)A.children=E;else if(1<q){for(var ee=Array(q),de=0;de<q;de++)ee[de]=arguments[de+2];A.children=ee}if(u&&u.defaultProps)for(R in q=u.defaultProps,q)A[R]===void 0&&(A[R]=q[R]);return{$$typeof:eM,type:u,key:P,ref:G,props:A,_owner:Qq.current}}function e$(u,_){return{$$typeof:eM,type:u.type,key:_,ref:u.ref,props:u.props,_owner:u._owner}}function Zq(u){return typeof u=="object"&&u!==null&&u.$$typeof===eM}function t$(u){var _={"=":"=0",":":"=2"};return"$"+u.replace(/[=:]/g,function(E){return _[E]})}var QX=/\/+/g;function N9(u,_){return typeof u=="object"&&u!==null&&u.key!=null?t$(""+u.key):_.toString(36)}function wx(u,_,E,R,A){var P=typeof u;(P==="undefined"||P==="boolean")&&(u=null);var G=!1;if(u===null)G=!0;else switch(P){case"string":case"number":G=!0;break;case"object":switch(u.$$typeof){case eM:case WZ:G=!0}}if(G)return G=u,A=A(G),u=R===""?"."+N9(G,0):R,JX(A)?(E="",u!=null&&(E=u.replace(QX,"$&/")+"/"),wx(A,_,E,"",function(de){return de})):A!=null&&(Zq(A)&&(A=e$(A,E+(!A.key||G&&G.key===A.key?"":(""+A.key).replace(QX,"$&/")+"/")+u)),_.push(A)),1;if(G=0,R=R===""?".":R+":",JX(u))for(var q=0;q<u.length;q++){P=u[q];var ee=R+N9(P,q);G+=wx(P,_,E,ee,A)}else if(ee=$Z(u),typeof ee=="function")for(u=ee.call(u),q=0;!(P=u.next()).done;)P=P.value,ee=R+N9(P,q++),G+=wx(P,_,E,ee,A);else if(P==="object")throw _=String(u),Error("Objects are not valid as a React child (found: "+(_==="[object Object]"?"object with keys {"+Object.keys(u).join(", ")+"}":_)+"). If you meant to render a collection of children, use an array instead.");return G}function lx(u,_,E){if(u==null)return u;var R=[],A=0;return wx(u,R,"","",function(P){return _.call(E,P,A++)}),R}function i$(u){if(u._status===-1){var _=u._result;_=_(),_.then(function(E){(u._status===0||u._status===-1)&&(u._status=1,u._result=E)},function(E){(u._status===0||u._status===-1)&&(u._status=2,u._result=E)}),u._status===-1&&(u._status=0,u._result=_)}if(u._status===1)return u._result.default;throw u._result}var vc={current:null},bx={transition:null},r$={ReactCurrentDispatcher:vc,ReactCurrentBatchConfig:bx,ReactCurrentOwner:Qq};function _J(){throw Error("act(...) is not supported in production builds of React.")}lr.Children={map:lx,forEach:function(u,_,E){lx(u,function(){_.apply(this,arguments)},E)},count:function(u){var _=0;return lx(u,function(){_++}),_},toArray:function(u){return lx(u,function(_){return _})||[]},only:function(u){if(!Zq(u))throw Error("React.Children.only expected to receive a single React element child.");return u}};lr.Component=qy;lr.Fragment=HZ;lr.Profiler=YZ;lr.PureComponent=Xq;lr.StrictMode=KZ;lr.Suspense=JZ;lr.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=r$;lr.act=_J;lr.cloneElement=function(u,_,E){if(u==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+u+".");var R=cJ({},u.props),A=u.key,P=u.ref,G=u._owner;if(_!=null){if(_.ref!==void 0&&(P=_.ref,G=Qq.current),_.key!==void 0&&(A=""+_.key),u.type&&u.type.defaultProps)var q=u.type.defaultProps;for(ee in _)uJ.call(_,ee)&&!hJ.hasOwnProperty(ee)&&(R[ee]=_[ee]===void 0&&q!==void 0?q[ee]:_[ee])}var ee=arguments.length-2;if(ee===1)R.children=E;else if(1<ee){q=Array(ee);for(var de=0;de<ee;de++)q[de]=arguments[de+2];R.children=q}return{$$typeof:eM,type:u.type,key:A,ref:P,props:R,_owner:G}};lr.createContext=function(u){return u={$$typeof:qZ,_currentValue:u,_currentValue2:u,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},u.Provider={$$typeof:zZ,_context:u},u.Consumer=u};lr.createElement=pJ;lr.createFactory=function(u){var _=pJ.bind(null,u);return _.type=u,_};lr.createRef=function(){return{current:null}};lr.forwardRef=function(u){return{$$typeof:XZ,render:u}};lr.isValidElement=Zq;lr.lazy=function(u){return{$$typeof:ZZ,_payload:{_status:-1,_result:u},_init:i$}};lr.memo=function(u,_){return{$$typeof:QZ,type:u,compare:_===void 0?null:_}};lr.startTransition=function(u){var _=bx.transition;bx.transition={};try{u()}finally{bx.transition=_}};lr.unstable_act=_J;lr.useCallback=function(u,_){return vc.current.useCallback(u,_)};lr.useContext=function(u){return vc.current.useContext(u)};lr.useDebugValue=function(){};lr.useDeferredValue=function(u){return vc.current.useDeferredValue(u)};lr.useEffect=function(u,_){return vc.current.useEffect(u,_)};lr.useId=function(){return vc.current.useId()};lr.useImperativeHandle=function(u,_,E){return vc.current.useImperativeHandle(u,_,E)};lr.useInsertionEffect=function(u,_){return vc.current.useInsertionEffect(u,_)};lr.useLayoutEffect=function(u,_){return vc.current.useLayoutEffect(u,_)};lr.useMemo=function(u,_){return vc.current.useMemo(u,_)};lr.useReducer=function(u,_,E){return vc.current.useReducer(u,_,E)};lr.useRef=function(u){return vc.current.useRef(u)};lr.useState=function(u){return vc.current.useState(u)};lr.useSyncExternalStore=function(u,_,E){return vc.current.useSyncExternalStore(u,_,E)};lr.useTransition=function(){return vc.current.useTransition()};lr.version="18.3.1";sJ.exports=lr;var st=sJ.exports;/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var n$=st,o$=Symbol.for("react.element"),s$=Symbol.for("react.fragment"),a$=Object.prototype.hasOwnProperty,c$=n$.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,d$={key:!0,ref:!0,__self:!0,__source:!0};function fJ(u,_,E){var R,A={},P=null,G=null;E!==void 0&&(P=""+E),_.key!==void 0&&(P=""+_.key),_.ref!==void 0&&(G=_.ref);for(R in _)a$.call(_,R)&&!d$.hasOwnProperty(R)&&(A[R]=_[R]);if(u&&u.defaultProps)for(R in _=u.defaultProps,_)A[R]===void 0&&(A[R]=_[R]);return{$$typeof:o$,type:u,key:P,ref:G,props:A,_owner:c$.current}}uV.Fragment=s$;uV.jsx=fJ;uV.jsxs=fJ;oJ.exports=uV;var Ct=oJ.exports,mJ={exports:{}},fl={},EJ={exports:{}},gJ={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(u){function _(mt,vi){var Ni=mt.length;mt.push(vi);e:for(;0<Ni;){var Ln=Ni-1>>>1,hr=mt[Ln];if(0<A(hr,vi))mt[Ln]=vi,mt[Ni]=hr,Ni=Ln;else break e}}function E(mt){return mt.length===0?null:mt[0]}function R(mt){if(mt.length===0)return null;var vi=mt[0],Ni=mt.pop();if(Ni!==vi){mt[0]=Ni;e:for(var Ln=0,hr=mt.length,yc=hr>>>1;Ln<yc;){var kn=2*(Ln+1)-1,aE=mt[kn],ql=kn+1,El=mt[ql];if(0>A(aE,Ni))ql<hr&&0>A(El,aE)?(mt[Ln]=El,mt[ql]=Ni,Ln=ql):(mt[Ln]=aE,mt[kn]=Ni,Ln=kn);else if(ql<hr&&0>A(El,Ni))mt[Ln]=El,mt[ql]=Ni,Ln=ql;else break e}}return vi}function A(mt,vi){var Ni=mt.sortIndex-vi.sortIndex;return Ni!==0?Ni:mt.id-vi.id}if(typeof performance=="object"&&typeof performance.now=="function"){var P=performance;u.unstable_now=function(){return P.now()}}else{var G=Date,q=G.now();u.unstable_now=function(){return G.now()-q}}var ee=[],de=[],Ie=1,he=null,me=3,je=!1,ve=!1,ge=!1,Ge=typeof setTimeout=="function"?setTimeout:null,pe=typeof clearTimeout=="function"?clearTimeout:null,ce=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function fe(mt){for(var vi=E(de);vi!==null;){if(vi.callback===null)R(de);else if(vi.startTime<=mt)R(de),vi.sortIndex=vi.expirationTime,_(ee,vi);else break;vi=E(de)}}function We(mt){if(ge=!1,fe(mt),!ve)if(E(ee)!==null)ve=!0,rd(lt);else{var vi=E(de);vi!==null&&gi(We,vi.startTime-mt)}}function lt(mt,vi){ve=!1,ge&&(ge=!1,pe(zt),zt=-1),je=!0;var Ni=me;try{for(fe(vi),he=E(ee);he!==null&&(!(he.expirationTime>vi)||mt&&!is());){var Ln=he.callback;if(typeof Ln=="function"){he.callback=null,me=he.priorityLevel;var hr=Ln(he.expirationTime<=vi);vi=u.unstable_now(),typeof hr=="function"?he.callback=hr:he===E(ee)&&R(ee),fe(vi)}else R(ee);he=E(ee)}if(he!==null)var yc=!0;else{var kn=E(de);kn!==null&&gi(We,kn.startTime-vi),yc=!1}return yc}finally{he=null,me=Ni,je=!1}}var jt=!1,dt=null,zt=-1,Pn=5,Ri=-1;function is(){return!(u.unstable_now()-Ri<Pn)}function ci(){if(dt!==null){var mt=u.unstable_now();Ri=mt;var vi=!0;try{vi=dt(!0,mt)}finally{vi?Va():(jt=!1,dt=null)}}else jt=!1}var Va;if(typeof ce=="function")Va=function(){ce(ci)};else if(typeof MessageChannel<"u"){var ur=new MessageChannel,Zy=ur.port2;ur.port1.onmessage=ci,Va=function(){Zy.postMessage(null)}}else Va=function(){Ge(ci,0)};function rd(mt){dt=mt,jt||(jt=!0,Va())}function gi(mt,vi){zt=Ge(function(){mt(u.unstable_now())},vi)}u.unstable_IdlePriority=5,u.unstable_ImmediatePriority=1,u.unstable_LowPriority=4,u.unstable_NormalPriority=3,u.unstable_Profiling=null,u.unstable_UserBlockingPriority=2,u.unstable_cancelCallback=function(mt){mt.callback=null},u.unstable_continueExecution=function(){ve||je||(ve=!0,rd(lt))},u.unstable_forceFrameRate=function(mt){0>mt||125<mt?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):Pn=0<mt?Math.floor(1e3/mt):5},u.unstable_getCurrentPriorityLevel=function(){return me},u.unstable_getFirstCallbackNode=function(){return E(ee)},u.unstable_next=function(mt){switch(me){case 1:case 2:case 3:var vi=3;break;default:vi=me}var Ni=me;me=vi;try{return mt()}finally{me=Ni}},u.unstable_pauseExecution=function(){},u.unstable_requestPaint=function(){},u.unstable_runWithPriority=function(mt,vi){switch(mt){case 1:case 2:case 3:case 4:case 5:break;default:mt=3}var Ni=me;me=mt;try{return vi()}finally{me=Ni}},u.unstable_scheduleCallback=function(mt,vi,Ni){var Ln=u.unstable_now();switch(typeof Ni=="object"&&Ni!==null?(Ni=Ni.delay,Ni=typeof Ni=="number"&&0<Ni?Ln+Ni:Ln):Ni=Ln,mt){case 1:var hr=-1;break;case 2:hr=250;break;case 5:hr=1073741823;break;case 4:hr=1e4;break;default:hr=5e3}return hr=Ni+hr,mt={id:Ie++,callback:vi,priorityLevel:mt,startTime:Ni,expirationTime:hr,sortIndex:-1},Ni>Ln?(mt.sortIndex=Ni,_(de,mt),E(ee)===null&&mt===E(de)&&(ge?(pe(zt),zt=-1):ge=!0,gi(We,Ni-Ln))):(mt.sortIndex=hr,_(ee,mt),ve||je||(ve=!0,rd(lt))),mt},u.unstable_shouldYield=is,u.unstable_wrapCallback=function(mt){var vi=me;return function(){var Ni=me;me=vi;try{return mt.apply(this,arguments)}finally{me=Ni}}}})(gJ);EJ.exports=gJ;var l$=EJ.exports;/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var u$=st,_l=l$;function ze(u){for(var _="https://reactjs.org/docs/error-decoder.html?invariant="+u,E=1;E<arguments.length;E++)_+="&args[]="+encodeURIComponent(arguments[E]);return"Minified React error #"+u+"; visit "+_+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var SJ=new Set,x1={};function jR(u,_){jy(u,_),jy(u+"Capture",_)}function jy(u,_){for(x1[u]=_,u=0;u<_.length;u++)SJ.add(_[u])}var cf=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),iq=Object.prototype.hasOwnProperty,h$=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,ZX={},$X={};function p$(u){return iq.call($X,u)?!0:iq.call(ZX,u)?!1:h$.test(u)?$X[u]=!0:(ZX[u]=!0,!1)}function _$(u,_,E,R){if(E!==null&&E.type===0)return!1;switch(typeof _){case"function":case"symbol":return!0;case"boolean":return R?!1:E!==null?!E.acceptsBooleans:(u=u.toLowerCase().slice(0,5),u!=="data-"&&u!=="aria-");default:return!1}}function f$(u,_,E,R){if(_===null||typeof _>"u"||_$(u,_,E,R))return!0;if(R)return!1;if(E!==null)switch(E.type){case 3:return!_;case 4:return _===!1;case 5:return isNaN(_);case 6:return isNaN(_)||1>_}return!1}function Cc(u,_,E,R,A,P,G){this.acceptsBooleans=_===2||_===3||_===4,this.attributeName=R,this.attributeNamespace=A,this.mustUseProperty=E,this.propertyName=u,this.type=_,this.sanitizeURL=P,this.removeEmptyString=G}var la={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(u){la[u]=new Cc(u,0,!1,u,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(u){var _=u[0];la[_]=new Cc(_,1,!1,u[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(u){la[u]=new Cc(u,2,!1,u.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(u){la[u]=new Cc(u,2,!1,u,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(u){la[u]=new Cc(u,3,!1,u.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(u){la[u]=new Cc(u,3,!0,u,null,!1,!1)});["capture","download"].forEach(function(u){la[u]=new Cc(u,4,!1,u,null,!1,!1)});["cols","rows","size","span"].forEach(function(u){la[u]=new Cc(u,6,!1,u,null,!1,!1)});["rowSpan","start"].forEach(function(u){la[u]=new Cc(u,5,!1,u.toLowerCase(),null,!1,!1)});var $q=/[\-:]([a-z])/g;function eX(u){return u[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(u){var _=u.replace($q,eX);la[_]=new Cc(_,1,!1,u,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(u){var _=u.replace($q,eX);la[_]=new Cc(_,1,!1,u,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(u){var _=u.replace($q,eX);la[_]=new Cc(_,1,!1,u,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(u){la[u]=new Cc(u,1,!1,u.toLowerCase(),null,!1,!1)});la.xlinkHref=new Cc("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(u){la[u]=new Cc(u,1,!1,u.toLowerCase(),null,!0,!0)});function tX(u,_,E,R){var A=la.hasOwnProperty(_)?la[_]:null;(A!==null?A.type!==0:R||!(2<_.length)||_[0]!=="o"&&_[0]!=="O"||_[1]!=="n"&&_[1]!=="N")&&(f$(_,E,A,R)&&(E=null),R||A===null?p$(_)&&(E===null?u.removeAttribute(_):u.setAttribute(_,""+E)):A.mustUseProperty?u[A.propertyName]=E===null?A.type===3?!1:"":E:(_=A.attributeName,R=A.attributeNamespace,E===null?u.removeAttribute(_):(A=A.type,E=A===3||A===4&&E===!0?"":""+E,R?u.setAttributeNS(R,_,E):u.setAttribute(_,E))))}var hf=u$.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,ux=Symbol.for("react.element"),Cy=Symbol.for("react.portal"),yy=Symbol.for("react.fragment"),iX=Symbol.for("react.strict_mode"),rq=Symbol.for("react.profiler"),TJ=Symbol.for("react.provider"),RJ=Symbol.for("react.context"),rX=Symbol.for("react.forward_ref"),nq=Symbol.for("react.suspense"),oq=Symbol.for("react.suspense_list"),nX=Symbol.for("react.memo"),jm=Symbol.for("react.lazy"),vJ=Symbol.for("react.offscreen"),e7=Symbol.iterator;function _1(u){return u===null||typeof u!="object"?null:(u=e7&&u[e7]||u["@@iterator"],typeof u=="function"?u:null)}var _o=Object.assign,D9;function v1(u){if(D9===void 0)try{throw Error()}catch(E){var _=E.stack.trim().match(/\n( *(at )?)/);D9=_&&_[1]||""}return`
`+D9+u}var P9=!1;function L9(u,_){if(!u||P9)return"";P9=!0;var E=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(_)if(_=function(){throw Error()},Object.defineProperty(_.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(_,[])}catch(de){var R=de}Reflect.construct(u,[],_)}else{try{_.call()}catch(de){R=de}u.call(_.prototype)}else{try{throw Error()}catch(de){R=de}u()}}catch(de){if(de&&R&&typeof de.stack=="string"){for(var A=de.stack.split(`
`),P=R.stack.split(`
`),G=A.length-1,q=P.length-1;1<=G&&0<=q&&A[G]!==P[q];)q--;for(;1<=G&&0<=q;G--,q--)if(A[G]!==P[q]){if(G!==1||q!==1)do if(G--,q--,0>q||A[G]!==P[q]){var ee=`
`+A[G].replace(" at new "," at ");return u.displayName&&ee.includes("<anonymous>")&&(ee=ee.replace("<anonymous>",u.displayName)),ee}while(1<=G&&0<=q);break}}}finally{P9=!1,Error.prepareStackTrace=E}return(u=u?u.displayName||u.name:"")?v1(u):""}function m$(u){switch(u.tag){case 5:return v1(u.type);case 16:return v1("Lazy");case 13:return v1("Suspense");case 19:return v1("SuspenseList");case 0:case 2:case 15:return u=L9(u.type,!1),u;case 11:return u=L9(u.type.render,!1),u;case 1:return u=L9(u.type,!0),u;default:return""}}function sq(u){if(u==null)return null;if(typeof u=="function")return u.displayName||u.name||null;if(typeof u=="string")return u;switch(u){case yy:return"Fragment";case Cy:return"Portal";case rq:return"Profiler";case iX:return"StrictMode";case nq:return"Suspense";case oq:return"SuspenseList"}if(typeof u=="object")switch(u.$$typeof){case RJ:return(u.displayName||"Context")+".Consumer";case TJ:return(u._context.displayName||"Context")+".Provider";case rX:var _=u.render;return u=u.displayName,u||(u=_.displayName||_.name||"",u=u!==""?"ForwardRef("+u+")":"ForwardRef"),u;case nX:return _=u.displayName||null,_!==null?_:sq(u.type)||"Memo";case jm:_=u._payload,u=u._init;try{return sq(u(_))}catch{}}return null}function E$(u){var _=u.type;switch(u.tag){case 24:return"Cache";case 9:return(_.displayName||"Context")+".Consumer";case 10:return(_._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return u=_.render,u=u.displayName||u.name||"",_.displayName||(u!==""?"ForwardRef("+u+")":"ForwardRef");case 7:return"Fragment";case 5:return _;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return sq(_);case 8:return _===iX?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof _=="function")return _.displayName||_.name||null;if(typeof _=="string")return _}return null}function tE(u){switch(typeof u){case"boolean":case"number":case"string":case"undefined":return u;case"object":return u;default:return""}}function CJ(u){var _=u.type;return(u=u.nodeName)&&u.toLowerCase()==="input"&&(_==="checkbox"||_==="radio")}function g$(u){var _=CJ(u)?"checked":"value",E=Object.getOwnPropertyDescriptor(u.constructor.prototype,_),R=""+u[_];if(!u.hasOwnProperty(_)&&typeof E<"u"&&typeof E.get=="function"&&typeof E.set=="function"){var A=E.get,P=E.set;return Object.defineProperty(u,_,{configurable:!0,get:function(){return A.call(this)},set:function(G){R=""+G,P.call(this,G)}}),Object.defineProperty(u,_,{enumerable:E.enumerable}),{getValue:function(){return R},setValue:function(G){R=""+G},stopTracking:function(){u._valueTracker=null,delete u[_]}}}}function hx(u){u._valueTracker||(u._valueTracker=g$(u))}function yJ(u){if(!u)return!1;var _=u._valueTracker;if(!_)return!0;var E=_.getValue(),R="";return u&&(R=CJ(u)?u.checked?"true":"false":u.value),u=R,u!==E?(_.setValue(u),!0):!1}function jx(u){if(u=u||(typeof document<"u"?document:void 0),typeof u>"u")return null;try{return u.activeElement||u.body}catch{return u.body}}function aq(u,_){var E=_.checked;return _o({},_,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:E??u._wrapperState.initialChecked})}function t7(u,_){var E=_.defaultValue==null?"":_.defaultValue,R=_.checked!=null?_.checked:_.defaultChecked;E=tE(_.value!=null?_.value:E),u._wrapperState={initialChecked:R,initialValue:E,controlled:_.type==="checkbox"||_.type==="radio"?_.checked!=null:_.value!=null}}function IJ(u,_){_=_.checked,_!=null&&tX(u,"checked",_,!1)}function cq(u,_){IJ(u,_);var E=tE(_.value),R=_.type;if(E!=null)R==="number"?(E===0&&u.value===""||u.value!=E)&&(u.value=""+E):u.value!==""+E&&(u.value=""+E);else if(R==="submit"||R==="reset"){u.removeAttribute("value");return}_.hasOwnProperty("value")?dq(u,_.type,E):_.hasOwnProperty("defaultValue")&&dq(u,_.type,tE(_.defaultValue)),_.checked==null&&_.defaultChecked!=null&&(u.defaultChecked=!!_.defaultChecked)}function i7(u,_,E){if(_.hasOwnProperty("value")||_.hasOwnProperty("defaultValue")){var R=_.type;if(!(R!=="submit"&&R!=="reset"||_.value!==void 0&&_.value!==null))return;_=""+u._wrapperState.initialValue,E||_===u.value||(u.value=_),u.defaultValue=_}E=u.name,E!==""&&(u.name=""),u.defaultChecked=!!u._wrapperState.initialChecked,E!==""&&(u.name=E)}function dq(u,_,E){(_!=="number"||jx(u.ownerDocument)!==u)&&(E==null?u.defaultValue=""+u._wrapperState.initialValue:u.defaultValue!==""+E&&(u.defaultValue=""+E))}var C1=Array.isArray;function My(u,_,E,R){if(u=u.options,_){_={};for(var A=0;A<E.length;A++)_["$"+E[A]]=!0;for(E=0;E<u.length;E++)A=_.hasOwnProperty("$"+u[E].value),u[E].selected!==A&&(u[E].selected=A),A&&R&&(u[E].defaultSelected=!0)}else{for(E=""+tE(E),_=null,A=0;A<u.length;A++){if(u[A].value===E){u[A].selected=!0,R&&(u[A].defaultSelected=!0);return}_!==null||u[A].disabled||(_=u[A])}_!==null&&(_.selected=!0)}}function lq(u,_){if(_.dangerouslySetInnerHTML!=null)throw Error(ze(91));return _o({},_,{value:void 0,defaultValue:void 0,children:""+u._wrapperState.initialValue})}function r7(u,_){var E=_.value;if(E==null){if(E=_.children,_=_.defaultValue,E!=null){if(_!=null)throw Error(ze(92));if(C1(E)){if(1<E.length)throw Error(ze(93));E=E[0]}_=E}_==null&&(_=""),E=_}u._wrapperState={initialValue:tE(E)}}function AJ(u,_){var E=tE(_.value),R=tE(_.defaultValue);E!=null&&(E=""+E,E!==u.value&&(u.value=E),_.defaultValue==null&&u.defaultValue!==E&&(u.defaultValue=E)),R!=null&&(u.defaultValue=""+R)}function n7(u){var _=u.textContent;_===u._wrapperState.initialValue&&_!==""&&_!==null&&(u.value=_)}function wJ(u){switch(u){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function uq(u,_){return u==null||u==="http://www.w3.org/1999/xhtml"?wJ(_):u==="http://www.w3.org/2000/svg"&&_==="foreignObject"?"http://www.w3.org/1999/xhtml":u}var px,bJ=function(u){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(_,E,R,A){MSApp.execUnsafeLocalFunction(function(){return u(_,E,R,A)})}:u}(function(u,_){if(u.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in u)u.innerHTML=_;else{for(px=px||document.createElement("div"),px.innerHTML="<svg>"+_.valueOf().toString()+"</svg>",_=px.firstChild;u.firstChild;)u.removeChild(u.firstChild);for(;_.firstChild;)u.appendChild(_.firstChild)}});function V1(u,_){if(_){var E=u.firstChild;if(E&&E===u.lastChild&&E.nodeType===3){E.nodeValue=_;return}}u.textContent=_}var b1={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},S$=["Webkit","ms","Moz","O"];Object.keys(b1).forEach(function(u){S$.forEach(function(_){_=_+u.charAt(0).toUpperCase()+u.substring(1),b1[_]=b1[u]})});function OJ(u,_,E){return _==null||typeof _=="boolean"||_===""?"":E||typeof _!="number"||_===0||b1.hasOwnProperty(u)&&b1[u]?(""+_).trim():_+"px"}function NJ(u,_){u=u.style;for(var E in _)if(_.hasOwnProperty(E)){var R=E.indexOf("--")===0,A=OJ(E,_[E],R);E==="float"&&(E="cssFloat"),R?u.setProperty(E,A):u[E]=A}}var T$=_o({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function hq(u,_){if(_){if(T$[u]&&(_.children!=null||_.dangerouslySetInnerHTML!=null))throw Error(ze(137,u));if(_.dangerouslySetInnerHTML!=null){if(_.children!=null)throw Error(ze(60));if(typeof _.dangerouslySetInnerHTML!="object"||!("__html"in _.dangerouslySetInnerHTML))throw Error(ze(61))}if(_.style!=null&&typeof _.style!="object")throw Error(ze(62))}}function pq(u,_){if(u.indexOf("-")===-1)return typeof _.is=="string";switch(u){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var _q=null;function oX(u){return u=u.target||u.srcElement||window,u.correspondingUseElement&&(u=u.correspondingUseElement),u.nodeType===3?u.parentNode:u}var fq=null,Uy=null,xy=null;function o7(u){if(u=rM(u)){if(typeof fq!="function")throw Error(ze(280));var _=u.stateNode;_&&(_=mV(_),fq(u.stateNode,u.type,_))}}function DJ(u){Uy?xy?xy.push(u):xy=[u]:Uy=u}function PJ(){if(Uy){var u=Uy,_=xy;if(xy=Uy=null,o7(u),_)for(u=0;u<_.length;u++)o7(_[u])}}function LJ(u,_){return u(_)}function kJ(){}var k9=!1;function MJ(u,_,E){if(k9)return u(_,E);k9=!0;try{return LJ(u,_,E)}finally{k9=!1,(Uy!==null||xy!==null)&&(kJ(),PJ())}}function F1(u,_){var E=u.stateNode;if(E===null)return null;var R=mV(E);if(R===null)return null;E=R[_];e:switch(_){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(R=!R.disabled)||(u=u.type,R=!(u==="button"||u==="input"||u==="select"||u==="textarea")),u=!R;break e;default:u=!1}if(u)return null;if(E&&typeof E!="function")throw Error(ze(231,_,typeof E));return E}var mq=!1;if(cf)try{var f1={};Object.defineProperty(f1,"passive",{get:function(){mq=!0}}),window.addEventListener("test",f1,f1),window.removeEventListener("test",f1,f1)}catch{mq=!1}function R$(u,_,E,R,A,P,G,q,ee){var de=Array.prototype.slice.call(arguments,3);try{_.apply(E,de)}catch(Ie){this.onError(Ie)}}var O1=!1,Gx=null,Wx=!1,Eq=null,v$={onError:function(u){O1=!0,Gx=u}};function C$(u,_,E,R,A,P,G,q,ee){O1=!1,Gx=null,R$.apply(v$,arguments)}function y$(u,_,E,R,A,P,G,q,ee){if(C$.apply(this,arguments),O1){if(O1){var de=Gx;O1=!1,Gx=null}else throw Error(ze(198));Wx||(Wx=!0,Eq=de)}}function GR(u){var _=u,E=u;if(u.alternate)for(;_.return;)_=_.return;else{u=_;do _=u,_.flags&4098&&(E=_.return),u=_.return;while(u)}return _.tag===3?E:null}function UJ(u){if(u.tag===13){var _=u.memoizedState;if(_===null&&(u=u.alternate,u!==null&&(_=u.memoizedState)),_!==null)return _.dehydrated}return null}function s7(u){if(GR(u)!==u)throw Error(ze(188))}function I$(u){var _=u.alternate;if(!_){if(_=GR(u),_===null)throw Error(ze(188));return _!==u?null:u}for(var E=u,R=_;;){var A=E.return;if(A===null)break;var P=A.alternate;if(P===null){if(R=A.return,R!==null){E=R;continue}break}if(A.child===P.child){for(P=A.child;P;){if(P===E)return s7(A),u;if(P===R)return s7(A),_;P=P.sibling}throw Error(ze(188))}if(E.return!==R.return)E=A,R=P;else{for(var G=!1,q=A.child;q;){if(q===E){G=!0,E=A,R=P;break}if(q===R){G=!0,R=A,E=P;break}q=q.sibling}if(!G){for(q=P.child;q;){if(q===E){G=!0,E=P,R=A;break}if(q===R){G=!0,R=P,E=A;break}q=q.sibling}if(!G)throw Error(ze(189))}}if(E.alternate!==R)throw Error(ze(190))}if(E.tag!==3)throw Error(ze(188));return E.stateNode.current===E?u:_}function xJ(u){return u=I$(u),u!==null?VJ(u):null}function VJ(u){if(u.tag===5||u.tag===6)return u;for(u=u.child;u!==null;){var _=VJ(u);if(_!==null)return _;u=u.sibling}return null}var FJ=_l.unstable_scheduleCallback,a7=_l.unstable_cancelCallback,A$=_l.unstable_shouldYield,w$=_l.unstable_requestPaint,Fo=_l.unstable_now,b$=_l.unstable_getCurrentPriorityLevel,sX=_l.unstable_ImmediatePriority,BJ=_l.unstable_UserBlockingPriority,Hx=_l.unstable_NormalPriority,O$=_l.unstable_LowPriority,jJ=_l.unstable_IdlePriority,hV=null,cp=null;function N$(u){if(cp&&typeof cp.onCommitFiberRoot=="function")try{cp.onCommitFiberRoot(hV,u,void 0,(u.current.flags&128)===128)}catch{}}var hh=Math.clz32?Math.clz32:L$,D$=Math.log,P$=Math.LN2;function L$(u){return u>>>=0,u===0?32:31-(D$(u)/P$|0)|0}var _x=64,fx=4194304;function y1(u){switch(u&-u){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return u&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return u&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return u}}function Kx(u,_){var E=u.pendingLanes;if(E===0)return 0;var R=0,A=u.suspendedLanes,P=u.pingedLanes,G=E&268435455;if(G!==0){var q=G&~A;q!==0?R=y1(q):(P&=G,P!==0&&(R=y1(P)))}else G=E&~A,G!==0?R=y1(G):P!==0&&(R=y1(P));if(R===0)return 0;if(_!==0&&_!==R&&!(_&A)&&(A=R&-R,P=_&-_,A>=P||A===16&&(P&4194240)!==0))return _;if(R&4&&(R|=E&16),_=u.entangledLanes,_!==0)for(u=u.entanglements,_&=R;0<_;)E=31-hh(_),A=1<<E,R|=u[E],_&=~A;return R}function k$(u,_){switch(u){case 1:case 2:case 4:return _+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return _+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function M$(u,_){for(var E=u.suspendedLanes,R=u.pingedLanes,A=u.expirationTimes,P=u.pendingLanes;0<P;){var G=31-hh(P),q=1<<G,ee=A[G];ee===-1?(!(q&E)||q&R)&&(A[G]=k$(q,_)):ee<=_&&(u.expiredLanes|=q),P&=~q}}function gq(u){return u=u.pendingLanes&-1073741825,u!==0?u:u&1073741824?1073741824:0}function GJ(){var u=_x;return _x<<=1,!(_x&4194240)&&(_x=64),u}function M9(u){for(var _=[],E=0;31>E;E++)_.push(u);return _}function tM(u,_,E){u.pendingLanes|=_,_!==536870912&&(u.suspendedLanes=0,u.pingedLanes=0),u=u.eventTimes,_=31-hh(_),u[_]=E}function U$(u,_){var E=u.pendingLanes&~_;u.pendingLanes=_,u.suspendedLanes=0,u.pingedLanes=0,u.expiredLanes&=_,u.mutableReadLanes&=_,u.entangledLanes&=_,_=u.entanglements;var R=u.eventTimes;for(u=u.expirationTimes;0<E;){var A=31-hh(E),P=1<<A;_[A]=0,R[A]=-1,u[A]=-1,E&=~P}}function aX(u,_){var E=u.entangledLanes|=_;for(u=u.entanglements;E;){var R=31-hh(E),A=1<<R;A&_|u[R]&_&&(u[R]|=_),E&=~A}}var on=0;function WJ(u){return u&=-u,1<u?4<u?u&268435455?16:536870912:4:1}var HJ,cX,KJ,YJ,zJ,Sq=!1,mx=[],zm=null,qm=null,Xm=null,B1=new Map,j1=new Map,Wm=[],x$="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function c7(u,_){switch(u){case"focusin":case"focusout":zm=null;break;case"dragenter":case"dragleave":qm=null;break;case"mouseover":case"mouseout":Xm=null;break;case"pointerover":case"pointerout":B1.delete(_.pointerId);break;case"gotpointercapture":case"lostpointercapture":j1.delete(_.pointerId)}}function m1(u,_,E,R,A,P){return u===null||u.nativeEvent!==P?(u={blockedOn:_,domEventName:E,eventSystemFlags:R,nativeEvent:P,targetContainers:[A]},_!==null&&(_=rM(_),_!==null&&cX(_)),u):(u.eventSystemFlags|=R,_=u.targetContainers,A!==null&&_.indexOf(A)===-1&&_.push(A),u)}function V$(u,_,E,R,A){switch(_){case"focusin":return zm=m1(zm,u,_,E,R,A),!0;case"dragenter":return qm=m1(qm,u,_,E,R,A),!0;case"mouseover":return Xm=m1(Xm,u,_,E,R,A),!0;case"pointerover":var P=A.pointerId;return B1.set(P,m1(B1.get(P)||null,u,_,E,R,A)),!0;case"gotpointercapture":return P=A.pointerId,j1.set(P,m1(j1.get(P)||null,u,_,E,R,A)),!0}return!1}function qJ(u){var _=DR(u.target);if(_!==null){var E=GR(_);if(E!==null){if(_=E.tag,_===13){if(_=UJ(E),_!==null){u.blockedOn=_,zJ(u.priority,function(){KJ(E)});return}}else if(_===3&&E.stateNode.current.memoizedState.isDehydrated){u.blockedOn=E.tag===3?E.stateNode.containerInfo:null;return}}}u.blockedOn=null}function Ox(u){if(u.blockedOn!==null)return!1;for(var _=u.targetContainers;0<_.length;){var E=Tq(u.domEventName,u.eventSystemFlags,_[0],u.nativeEvent);if(E===null){E=u.nativeEvent;var R=new E.constructor(E.type,E);_q=R,E.target.dispatchEvent(R),_q=null}else return _=rM(E),_!==null&&cX(_),u.blockedOn=E,!1;_.shift()}return!0}function d7(u,_,E){Ox(u)&&E.delete(_)}function F$(){Sq=!1,zm!==null&&Ox(zm)&&(zm=null),qm!==null&&Ox(qm)&&(qm=null),Xm!==null&&Ox(Xm)&&(Xm=null),B1.forEach(d7),j1.forEach(d7)}function E1(u,_){u.blockedOn===_&&(u.blockedOn=null,Sq||(Sq=!0,_l.unstable_scheduleCallback(_l.unstable_NormalPriority,F$)))}function G1(u){function _(A){return E1(A,u)}if(0<mx.length){E1(mx[0],u);for(var E=1;E<mx.length;E++){var R=mx[E];R.blockedOn===u&&(R.blockedOn=null)}}for(zm!==null&&E1(zm,u),qm!==null&&E1(qm,u),Xm!==null&&E1(Xm,u),B1.forEach(_),j1.forEach(_),E=0;E<Wm.length;E++)R=Wm[E],R.blockedOn===u&&(R.blockedOn=null);for(;0<Wm.length&&(E=Wm[0],E.blockedOn===null);)qJ(E),E.blockedOn===null&&Wm.shift()}var Vy=hf.ReactCurrentBatchConfig,Yx=!0;function B$(u,_,E,R){var A=on,P=Vy.transition;Vy.transition=null;try{on=1,dX(u,_,E,R)}finally{on=A,Vy.transition=P}}function j$(u,_,E,R){var A=on,P=Vy.transition;Vy.transition=null;try{on=4,dX(u,_,E,R)}finally{on=A,Vy.transition=P}}function dX(u,_,E,R){if(Yx){var A=Tq(u,_,E,R);if(A===null)K9(u,_,R,zx,E),c7(u,R);else if(V$(A,u,_,E,R))R.stopPropagation();else if(c7(u,R),_&4&&-1<x$.indexOf(u)){for(;A!==null;){var P=rM(A);if(P!==null&&HJ(P),P=Tq(u,_,E,R),P===null&&K9(u,_,R,zx,E),P===A)break;A=P}A!==null&&R.stopPropagation()}else K9(u,_,R,null,E)}}var zx=null;function Tq(u,_,E,R){if(zx=null,u=oX(R),u=DR(u),u!==null)if(_=GR(u),_===null)u=null;else if(E=_.tag,E===13){if(u=UJ(_),u!==null)return u;u=null}else if(E===3){if(_.stateNode.current.memoizedState.isDehydrated)return _.tag===3?_.stateNode.containerInfo:null;u=null}else _!==u&&(u=null);return zx=u,null}function XJ(u){switch(u){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(b$()){case sX:return 1;case BJ:return 4;case Hx:case O$:return 16;case jJ:return 536870912;default:return 16}default:return 16}}var Km=null,lX=null,Nx=null;function JJ(){if(Nx)return Nx;var u,_=lX,E=_.length,R,A="value"in Km?Km.value:Km.textContent,P=A.length;for(u=0;u<E&&_[u]===A[u];u++);var G=E-u;for(R=1;R<=G&&_[E-R]===A[P-R];R++);return Nx=A.slice(u,1<R?1-R:void 0)}function Dx(u){var _=u.keyCode;return"charCode"in u?(u=u.charCode,u===0&&_===13&&(u=13)):u=_,u===10&&(u=13),32<=u||u===13?u:0}function Ex(){return!0}function l7(){return!1}function ml(u){function _(E,R,A,P,G){this._reactName=E,this._targetInst=A,this.type=R,this.nativeEvent=P,this.target=G,this.currentTarget=null;for(var q in u)u.hasOwnProperty(q)&&(E=u[q],this[q]=E?E(P):P[q]);return this.isDefaultPrevented=(P.defaultPrevented!=null?P.defaultPrevented:P.returnValue===!1)?Ex:l7,this.isPropagationStopped=l7,this}return _o(_.prototype,{preventDefault:function(){this.defaultPrevented=!0;var E=this.nativeEvent;E&&(E.preventDefault?E.preventDefault():typeof E.returnValue!="unknown"&&(E.returnValue=!1),this.isDefaultPrevented=Ex)},stopPropagation:function(){var E=this.nativeEvent;E&&(E.stopPropagation?E.stopPropagation():typeof E.cancelBubble!="unknown"&&(E.cancelBubble=!0),this.isPropagationStopped=Ex)},persist:function(){},isPersistent:Ex}),_}var Xy={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(u){return u.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},uX=ml(Xy),iM=_o({},Xy,{view:0,detail:0}),G$=ml(iM),U9,x9,g1,pV=_o({},iM,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:hX,button:0,buttons:0,relatedTarget:function(u){return u.relatedTarget===void 0?u.fromElement===u.srcElement?u.toElement:u.fromElement:u.relatedTarget},movementX:function(u){return"movementX"in u?u.movementX:(u!==g1&&(g1&&u.type==="mousemove"?(U9=u.screenX-g1.screenX,x9=u.screenY-g1.screenY):x9=U9=0,g1=u),U9)},movementY:function(u){return"movementY"in u?u.movementY:x9}}),u7=ml(pV),W$=_o({},pV,{dataTransfer:0}),H$=ml(W$),K$=_o({},iM,{relatedTarget:0}),V9=ml(K$),Y$=_o({},Xy,{animationName:0,elapsedTime:0,pseudoElement:0}),z$=ml(Y$),q$=_o({},Xy,{clipboardData:function(u){return"clipboardData"in u?u.clipboardData:window.clipboardData}}),X$=ml(q$),J$=_o({},Xy,{data:0}),h7=ml(J$),Q$={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},Z$={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},$$={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function eee(u){var _=this.nativeEvent;return _.getModifierState?_.getModifierState(u):(u=$$[u])?!!_[u]:!1}function hX(){return eee}var tee=_o({},iM,{key:function(u){if(u.key){var _=Q$[u.key]||u.key;if(_!=="Unidentified")return _}return u.type==="keypress"?(u=Dx(u),u===13?"Enter":String.fromCharCode(u)):u.type==="keydown"||u.type==="keyup"?Z$[u.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:hX,charCode:function(u){return u.type==="keypress"?Dx(u):0},keyCode:function(u){return u.type==="keydown"||u.type==="keyup"?u.keyCode:0},which:function(u){return u.type==="keypress"?Dx(u):u.type==="keydown"||u.type==="keyup"?u.keyCode:0}}),iee=ml(tee),ree=_o({},pV,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),p7=ml(ree),nee=_o({},iM,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:hX}),oee=ml(nee),see=_o({},Xy,{propertyName:0,elapsedTime:0,pseudoElement:0}),aee=ml(see),cee=_o({},pV,{deltaX:function(u){return"deltaX"in u?u.deltaX:"wheelDeltaX"in u?-u.wheelDeltaX:0},deltaY:function(u){return"deltaY"in u?u.deltaY:"wheelDeltaY"in u?-u.wheelDeltaY:"wheelDelta"in u?-u.wheelDelta:0},deltaZ:0,deltaMode:0}),dee=ml(cee),lee=[9,13,27,32],pX=cf&&"CompositionEvent"in window,N1=null;cf&&"documentMode"in document&&(N1=document.documentMode);var uee=cf&&"TextEvent"in window&&!N1,QJ=cf&&(!pX||N1&&8<N1&&11>=N1),_7=" ",f7=!1;function ZJ(u,_){switch(u){case"keyup":return lee.indexOf(_.keyCode)!==-1;case"keydown":return _.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function $J(u){return u=u.detail,typeof u=="object"&&"data"in u?u.data:null}var Iy=!1;function hee(u,_){switch(u){case"compositionend":return $J(_);case"keypress":return _.which!==32?null:(f7=!0,_7);case"textInput":return u=_.data,u===_7&&f7?null:u;default:return null}}function pee(u,_){if(Iy)return u==="compositionend"||!pX&&ZJ(u,_)?(u=JJ(),Nx=lX=Km=null,Iy=!1,u):null;switch(u){case"paste":return null;case"keypress":if(!(_.ctrlKey||_.altKey||_.metaKey)||_.ctrlKey&&_.altKey){if(_.char&&1<_.char.length)return _.char;if(_.which)return String.fromCharCode(_.which)}return null;case"compositionend":return QJ&&_.locale!=="ko"?null:_.data;default:return null}}var _ee={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function m7(u){var _=u&&u.nodeName&&u.nodeName.toLowerCase();return _==="input"?!!_ee[u.type]:_==="textarea"}function eQ(u,_,E,R){DJ(R),_=qx(_,"onChange"),0<_.length&&(E=new uX("onChange","change",null,E,R),u.push({event:E,listeners:_}))}var D1=null,W1=null;function fee(u){uQ(u,0)}function _V(u){var _=by(u);if(yJ(_))return u}function mee(u,_){if(u==="change")return _}var tQ=!1;if(cf){var F9;if(cf){var B9="oninput"in document;if(!B9){var E7=document.createElement("div");E7.setAttribute("oninput","return;"),B9=typeof E7.oninput=="function"}F9=B9}else F9=!1;tQ=F9&&(!document.documentMode||9<document.documentMode)}function g7(){D1&&(D1.detachEvent("onpropertychange",iQ),W1=D1=null)}function iQ(u){if(u.propertyName==="value"&&_V(W1)){var _=[];eQ(_,W1,u,oX(u)),MJ(fee,_)}}function Eee(u,_,E){u==="focusin"?(g7(),D1=_,W1=E,D1.attachEvent("onpropertychange",iQ)):u==="focusout"&&g7()}function gee(u){if(u==="selectionchange"||u==="keyup"||u==="keydown")return _V(W1)}function See(u,_){if(u==="click")return _V(_)}function Tee(u,_){if(u==="input"||u==="change")return _V(_)}function Ree(u,_){return u===_&&(u!==0||1/u===1/_)||u!==u&&_!==_}var _h=typeof Object.is=="function"?Object.is:Ree;function H1(u,_){if(_h(u,_))return!0;if(typeof u!="object"||u===null||typeof _!="object"||_===null)return!1;var E=Object.keys(u),R=Object.keys(_);if(E.length!==R.length)return!1;for(R=0;R<E.length;R++){var A=E[R];if(!iq.call(_,A)||!_h(u[A],_[A]))return!1}return!0}function S7(u){for(;u&&u.firstChild;)u=u.firstChild;return u}function T7(u,_){var E=S7(u);u=0;for(var R;E;){if(E.nodeType===3){if(R=u+E.textContent.length,u<=_&&R>=_)return{node:E,offset:_-u};u=R}e:{for(;E;){if(E.nextSibling){E=E.nextSibling;break e}E=E.parentNode}E=void 0}E=S7(E)}}function rQ(u,_){return u&&_?u===_?!0:u&&u.nodeType===3?!1:_&&_.nodeType===3?rQ(u,_.parentNode):"contains"in u?u.contains(_):u.compareDocumentPosition?!!(u.compareDocumentPosition(_)&16):!1:!1}function nQ(){for(var u=window,_=jx();_ instanceof u.HTMLIFrameElement;){try{var E=typeof _.contentWindow.location.href=="string"}catch{E=!1}if(E)u=_.contentWindow;else break;_=jx(u.document)}return _}function _X(u){var _=u&&u.nodeName&&u.nodeName.toLowerCase();return _&&(_==="input"&&(u.type==="text"||u.type==="search"||u.type==="tel"||u.type==="url"||u.type==="password")||_==="textarea"||u.contentEditable==="true")}function vee(u){var _=nQ(),E=u.focusedElem,R=u.selectionRange;if(_!==E&&E&&E.ownerDocument&&rQ(E.ownerDocument.documentElement,E)){if(R!==null&&_X(E)){if(_=R.start,u=R.end,u===void 0&&(u=_),"selectionStart"in E)E.selectionStart=_,E.selectionEnd=Math.min(u,E.value.length);else if(u=(_=E.ownerDocument||document)&&_.defaultView||window,u.getSelection){u=u.getSelection();var A=E.textContent.length,P=Math.min(R.start,A);R=R.end===void 0?P:Math.min(R.end,A),!u.extend&&P>R&&(A=R,R=P,P=A),A=T7(E,P);var G=T7(E,R);A&&G&&(u.rangeCount!==1||u.anchorNode!==A.node||u.anchorOffset!==A.offset||u.focusNode!==G.node||u.focusOffset!==G.offset)&&(_=_.createRange(),_.setStart(A.node,A.offset),u.removeAllRanges(),P>R?(u.addRange(_),u.extend(G.node,G.offset)):(_.setEnd(G.node,G.offset),u.addRange(_)))}}for(_=[],u=E;u=u.parentNode;)u.nodeType===1&&_.push({element:u,left:u.scrollLeft,top:u.scrollTop});for(typeof E.focus=="function"&&E.focus(),E=0;E<_.length;E++)u=_[E],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}}var Cee=cf&&"documentMode"in document&&11>=document.documentMode,Ay=null,Rq=null,P1=null,vq=!1;function R7(u,_,E){var R=E.window===E?E.document:E.nodeType===9?E:E.ownerDocument;vq||Ay==null||Ay!==jx(R)||(R=Ay,"selectionStart"in R&&_X(R)?R={start:R.selectionStart,end:R.selectionEnd}:(R=(R.ownerDocument&&R.ownerDocument.defaultView||window).getSelection(),R={anchorNode:R.anchorNode,anchorOffset:R.anchorOffset,focusNode:R.focusNode,focusOffset:R.focusOffset}),P1&&H1(P1,R)||(P1=R,R=qx(Rq,"onSelect"),0<R.length&&(_=new uX("onSelect","select",null,_,E),u.push({event:_,listeners:R}),_.target=Ay)))}function gx(u,_){var E={};return E[u.toLowerCase()]=_.toLowerCase(),E["Webkit"+u]="webkit"+_,E["Moz"+u]="moz"+_,E}var wy={animationend:gx("Animation","AnimationEnd"),animationiteration:gx("Animation","AnimationIteration"),animationstart:gx("Animation","AnimationStart"),transitionend:gx("Transition","TransitionEnd")},j9={},oQ={};cf&&(oQ=document.createElement("div").style,"AnimationEvent"in window||(delete wy.animationend.animation,delete wy.animationiteration.animation,delete wy.animationstart.animation),"TransitionEvent"in window||delete wy.transitionend.transition);function fV(u){if(j9[u])return j9[u];if(!wy[u])return u;var _=wy[u],E;for(E in _)if(_.hasOwnProperty(E)&&E in oQ)return j9[u]=_[E];return u}var sQ=fV("animationend"),aQ=fV("animationiteration"),cQ=fV("animationstart"),dQ=fV("transitionend"),lQ=new Map,v7="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function rE(u,_){lQ.set(u,_),jR(_,[u])}for(var G9=0;G9<v7.length;G9++){var W9=v7[G9],yee=W9.toLowerCase(),Iee=W9[0].toUpperCase()+W9.slice(1);rE(yee,"on"+Iee)}rE(sQ,"onAnimationEnd");rE(aQ,"onAnimationIteration");rE(cQ,"onAnimationStart");rE("dblclick","onDoubleClick");rE("focusin","onFocus");rE("focusout","onBlur");rE(dQ,"onTransitionEnd");jy("onMouseEnter",["mouseout","mouseover"]);jy("onMouseLeave",["mouseout","mouseover"]);jy("onPointerEnter",["pointerout","pointerover"]);jy("onPointerLeave",["pointerout","pointerover"]);jR("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));jR("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));jR("onBeforeInput",["compositionend","keypress","textInput","paste"]);jR("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));jR("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));jR("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var I1="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Aee=new Set("cancel close invalid load scroll toggle".split(" ").concat(I1));function C7(u,_,E){var R=u.type||"unknown-event";u.currentTarget=E,y$(R,_,void 0,u),u.currentTarget=null}function uQ(u,_){_=(_&4)!==0;for(var E=0;E<u.length;E++){var R=u[E],A=R.event;R=R.listeners;e:{var P=void 0;if(_)for(var G=R.length-1;0<=G;G--){var q=R[G],ee=q.instance,de=q.currentTarget;if(q=q.listener,ee!==P&&A.isPropagationStopped())break e;C7(A,q,de),P=ee}else for(G=0;G<R.length;G++){if(q=R[G],ee=q.instance,de=q.currentTarget,q=q.listener,ee!==P&&A.isPropagationStopped())break e;C7(A,q,de),P=ee}}}if(Wx)throw u=Eq,Wx=!1,Eq=null,u}function Jn(u,_){var E=_[wq];E===void 0&&(E=_[wq]=new Set);var R=u+"__bubble";E.has(R)||(hQ(_,u,2,!1),E.add(R))}function H9(u,_,E){var R=0;_&&(R|=4),hQ(E,u,R,_)}var Sx="_reactListening"+Math.random().toString(36).slice(2);function K1(u){if(!u[Sx]){u[Sx]=!0,SJ.forEach(function(E){E!=="selectionchange"&&(Aee.has(E)||H9(E,!1,u),H9(E,!0,u))});var _=u.nodeType===9?u:u.ownerDocument;_===null||_[Sx]||(_[Sx]=!0,H9("selectionchange",!1,_))}}function hQ(u,_,E,R){switch(XJ(_)){case 1:var A=B$;break;case 4:A=j$;break;default:A=dX}E=A.bind(null,_,E,u),A=void 0,!mq||_!=="touchstart"&&_!=="touchmove"&&_!=="wheel"||(A=!0),R?A!==void 0?u.addEventListener(_,E,{capture:!0,passive:A}):u.addEventListener(_,E,!0):A!==void 0?u.addEventListener(_,E,{passive:A}):u.addEventListener(_,E,!1)}function K9(u,_,E,R,A){var P=R;if(!(_&1)&&!(_&2)&&R!==null)e:for(;;){if(R===null)return;var G=R.tag;if(G===3||G===4){var q=R.stateNode.containerInfo;if(q===A||q.nodeType===8&&q.parentNode===A)break;if(G===4)for(G=R.return;G!==null;){var ee=G.tag;if((ee===3||ee===4)&&(ee=G.stateNode.containerInfo,ee===A||ee.nodeType===8&&ee.parentNode===A))return;G=G.return}for(;q!==null;){if(G=DR(q),G===null)return;if(ee=G.tag,ee===5||ee===6){R=P=G;continue e}q=q.parentNode}}R=R.return}MJ(function(){var de=P,Ie=oX(E),he=[];e:{var me=lQ.get(u);if(me!==void 0){var je=uX,ve=u;switch(u){case"keypress":if(Dx(E)===0)break e;case"keydown":case"keyup":je=iee;break;case"focusin":ve="focus",je=V9;break;case"focusout":ve="blur",je=V9;break;case"beforeblur":case"afterblur":je=V9;break;case"click":if(E.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":je=u7;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":je=H$;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":je=oee;break;case sQ:case aQ:case cQ:je=z$;break;case dQ:je=aee;break;case"scroll":je=G$;break;case"wheel":je=dee;break;case"copy":case"cut":case"paste":je=X$;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":je=p7}var ge=(_&4)!==0,Ge=!ge&&u==="scroll",pe=ge?me!==null?me+"Capture":null:me;ge=[];for(var ce=de,fe;ce!==null;){fe=ce;var We=fe.stateNode;if(fe.tag===5&&We!==null&&(fe=We,pe!==null&&(We=F1(ce,pe),We!=null&&ge.push(Y1(ce,We,fe)))),Ge)break;ce=ce.return}0<ge.length&&(me=new je(me,ve,null,E,Ie),he.push({event:me,listeners:ge}))}}if(!(_&7)){e:{if(me=u==="mouseover"||u==="pointerover",je=u==="mouseout"||u==="pointerout",me&&E!==_q&&(ve=E.relatedTarget||E.fromElement)&&(DR(ve)||ve[df]))break e;if((je||me)&&(me=Ie.window===Ie?Ie:(me=Ie.ownerDocument)?me.defaultView||me.parentWindow:window,je?(ve=E.relatedTarget||E.toElement,je=de,ve=ve?DR(ve):null,ve!==null&&(Ge=GR(ve),ve!==Ge||ve.tag!==5&&ve.tag!==6)&&(ve=null)):(je=null,ve=de),je!==ve)){if(ge=u7,We="onMouseLeave",pe="onMouseEnter",ce="mouse",(u==="pointerout"||u==="pointerover")&&(ge=p7,We="onPointerLeave",pe="onPointerEnter",ce="pointer"),Ge=je==null?me:by(je),fe=ve==null?me:by(ve),me=new ge(We,ce+"leave",je,E,Ie),me.target=Ge,me.relatedTarget=fe,We=null,DR(Ie)===de&&(ge=new ge(pe,ce+"enter",ve,E,Ie),ge.target=fe,ge.relatedTarget=Ge,We=ge),Ge=We,je&&ve)t:{for(ge=je,pe=ve,ce=0,fe=ge;fe;fe=gy(fe))ce++;for(fe=0,We=pe;We;We=gy(We))fe++;for(;0<ce-fe;)ge=gy(ge),ce--;for(;0<fe-ce;)pe=gy(pe),fe--;for(;ce--;){if(ge===pe||pe!==null&&ge===pe.alternate)break t;ge=gy(ge),pe=gy(pe)}ge=null}else ge=null;je!==null&&y7(he,me,je,ge,!1),ve!==null&&Ge!==null&&y7(he,Ge,ve,ge,!0)}}e:{if(me=de?by(de):window,je=me.nodeName&&me.nodeName.toLowerCase(),je==="select"||je==="input"&&me.type==="file")var lt=mee;else if(m7(me))if(tQ)lt=Tee;else{lt=gee;var jt=Eee}else(je=me.nodeName)&&je.toLowerCase()==="input"&&(me.type==="checkbox"||me.type==="radio")&&(lt=See);if(lt&&(lt=lt(u,de))){eQ(he,lt,E,Ie);break e}jt&&jt(u,me,de),u==="focusout"&&(jt=me._wrapperState)&&jt.controlled&&me.type==="number"&&dq(me,"number",me.value)}switch(jt=de?by(de):window,u){case"focusin":(m7(jt)||jt.contentEditable==="true")&&(Ay=jt,Rq=de,P1=null);break;case"focusout":P1=Rq=Ay=null;break;case"mousedown":vq=!0;break;case"contextmenu":case"mouseup":case"dragend":vq=!1,R7(he,E,Ie);break;case"selectionchange":if(Cee)break;case"keydown":case"keyup":R7(he,E,Ie)}var dt;if(pX)e:{switch(u){case"compositionstart":var zt="onCompositionStart";break e;case"compositionend":zt="onCompositionEnd";break e;case"compositionupdate":zt="onCompositionUpdate";break e}zt=void 0}else Iy?ZJ(u,E)&&(zt="onCompositionEnd"):u==="keydown"&&E.keyCode===229&&(zt="onCompositionStart");zt&&(QJ&&E.locale!=="ko"&&(Iy||zt!=="onCompositionStart"?zt==="onCompositionEnd"&&Iy&&(dt=JJ()):(Km=Ie,lX="value"in Km?Km.value:Km.textContent,Iy=!0)),jt=qx(de,zt),0<jt.length&&(zt=new h7(zt,u,null,E,Ie),he.push({event:zt,listeners:jt}),dt?zt.data=dt:(dt=$J(E),dt!==null&&(zt.data=dt)))),(dt=uee?hee(u,E):pee(u,E))&&(de=qx(de,"onBeforeInput"),0<de.length&&(Ie=new h7("onBeforeInput","beforeinput",null,E,Ie),he.push({event:Ie,listeners:de}),Ie.data=dt))}uQ(he,_)})}function Y1(u,_,E){return{instance:u,listener:_,currentTarget:E}}function qx(u,_){for(var E=_+"Capture",R=[];u!==null;){var A=u,P=A.stateNode;A.tag===5&&P!==null&&(A=P,P=F1(u,E),P!=null&&R.unshift(Y1(u,P,A)),P=F1(u,_),P!=null&&R.push(Y1(u,P,A))),u=u.return}return R}function gy(u){if(u===null)return null;do u=u.return;while(u&&u.tag!==5);return u||null}function y7(u,_,E,R,A){for(var P=_._reactName,G=[];E!==null&&E!==R;){var q=E,ee=q.alternate,de=q.stateNode;if(ee!==null&&ee===R)break;q.tag===5&&de!==null&&(q=de,A?(ee=F1(E,P),ee!=null&&G.unshift(Y1(E,ee,q))):A||(ee=F1(E,P),ee!=null&&G.push(Y1(E,ee,q)))),E=E.return}G.length!==0&&u.push({event:_,listeners:G})}var wee=/\r\n?/g,bee=/\u0000|\uFFFD/g;function I7(u){return(typeof u=="string"?u:""+u).replace(wee,`
`).replace(bee,"")}function Tx(u,_,E){if(_=I7(_),I7(u)!==_&&E)throw Error(ze(425))}function Xx(){}var Cq=null,yq=null;function Iq(u,_){return u==="textarea"||u==="noscript"||typeof _.children=="string"||typeof _.children=="number"||typeof _.dangerouslySetInnerHTML=="object"&&_.dangerouslySetInnerHTML!==null&&_.dangerouslySetInnerHTML.__html!=null}var Aq=typeof setTimeout=="function"?setTimeout:void 0,Oee=typeof clearTimeout=="function"?clearTimeout:void 0,A7=typeof Promise=="function"?Promise:void 0,Nee=typeof queueMicrotask=="function"?queueMicrotask:typeof A7<"u"?function(u){return A7.resolve(null).then(u).catch(Dee)}:Aq;function Dee(u){setTimeout(function(){throw u})}function Y9(u,_){var E=_,R=0;do{var A=E.nextSibling;if(u.removeChild(E),A&&A.nodeType===8)if(E=A.data,E==="/$"){if(R===0){u.removeChild(A),G1(_);return}R--}else E!=="$"&&E!=="$?"&&E!=="$!"||R++;E=A}while(E);G1(_)}function Jm(u){for(;u!=null;u=u.nextSibling){var _=u.nodeType;if(_===1||_===3)break;if(_===8){if(_=u.data,_==="$"||_==="$!"||_==="$?")break;if(_==="/$")return null}}return u}function w7(u){u=u.previousSibling;for(var _=0;u;){if(u.nodeType===8){var E=u.data;if(E==="$"||E==="$!"||E==="$?"){if(_===0)return u;_--}else E==="/$"&&_++}u=u.previousSibling}return null}var Jy=Math.random().toString(36).slice(2),ap="__reactFiber$"+Jy,z1="__reactProps$"+Jy,df="__reactContainer$"+Jy,wq="__reactEvents$"+Jy,Pee="__reactListeners$"+Jy,Lee="__reactHandles$"+Jy;function DR(u){var _=u[ap];if(_)return _;for(var E=u.parentNode;E;){if(_=E[df]||E[ap]){if(E=_.alternate,_.child!==null||E!==null&&E.child!==null)for(u=w7(u);u!==null;){if(E=u[ap])return E;u=w7(u)}return _}u=E,E=u.parentNode}return null}function rM(u){return u=u[ap]||u[df],!u||u.tag!==5&&u.tag!==6&&u.tag!==13&&u.tag!==3?null:u}function by(u){if(u.tag===5||u.tag===6)return u.stateNode;throw Error(ze(33))}function mV(u){return u[z1]||null}var bq=[],Oy=-1;function nE(u){return{current:u}}function Qn(u){0>Oy||(u.current=bq[Oy],bq[Oy]=null,Oy--)}function Dn(u,_){Oy++,bq[Oy]=u.current,u.current=_}var iE={},xa=nE(iE),ed=nE(!1),UR=iE;function Gy(u,_){var E=u.type.contextTypes;if(!E)return iE;var R=u.stateNode;if(R&&R.__reactInternalMemoizedUnmaskedChildContext===_)return R.__reactInternalMemoizedMaskedChildContext;var A={},P;for(P in E)A[P]=_[P];return R&&(u=u.stateNode,u.__reactInternalMemoizedUnmaskedChildContext=_,u.__reactInternalMemoizedMaskedChildContext=A),A}function td(u){return u=u.childContextTypes,u!=null}function Jx(){Qn(ed),Qn(xa)}function b7(u,_,E){if(xa.current!==iE)throw Error(ze(168));Dn(xa,_),Dn(ed,E)}function pQ(u,_,E){var R=u.stateNode;if(_=_.childContextTypes,typeof R.getChildContext!="function")return E;R=R.getChildContext();for(var A in R)if(!(A in _))throw Error(ze(108,E$(u)||"Unknown",A));return _o({},E,R)}function Qx(u){return u=(u=u.stateNode)&&u.__reactInternalMemoizedMergedChildContext||iE,UR=xa.current,Dn(xa,u),Dn(ed,ed.current),!0}function O7(u,_,E){var R=u.stateNode;if(!R)throw Error(ze(169));E?(u=pQ(u,_,UR),R.__reactInternalMemoizedMergedChildContext=u,Qn(ed),Qn(xa),Dn(xa,u)):Qn(ed),Dn(ed,E)}var nf=null,EV=!1,z9=!1;function _Q(u){nf===null?nf=[u]:nf.push(u)}function kee(u){EV=!0,_Q(u)}function oE(){if(!z9&&nf!==null){z9=!0;var u=0,_=on;try{var E=nf;for(on=1;u<E.length;u++){var R=E[u];do R=R(!0);while(R!==null)}nf=null,EV=!1}catch(A){throw nf!==null&&(nf=nf.slice(u+1)),FJ(sX,oE),A}finally{on=_,z9=!1}}return null}var Ny=[],Dy=0,Zx=null,$x=0,Gl=[],Wl=0,xR=null,of=1,sf="";function wR(u,_){Ny[Dy++]=$x,Ny[Dy++]=Zx,Zx=u,$x=_}function fQ(u,_,E){Gl[Wl++]=of,Gl[Wl++]=sf,Gl[Wl++]=xR,xR=u;var R=of;u=sf;var A=32-hh(R)-1;R&=~(1<<A),E+=1;var P=32-hh(_)+A;if(30<P){var G=A-A%5;P=(R&(1<<G)-1).toString(32),R>>=G,A-=G,of=1<<32-hh(_)+A|E<<A|R,sf=P+u}else of=1<<P|E<<A|R,sf=u}function fX(u){u.return!==null&&(wR(u,1),fQ(u,1,0))}function mX(u){for(;u===Zx;)Zx=Ny[--Dy],Ny[Dy]=null,$x=Ny[--Dy],Ny[Dy]=null;for(;u===xR;)xR=Gl[--Wl],Gl[Wl]=null,sf=Gl[--Wl],Gl[Wl]=null,of=Gl[--Wl],Gl[Wl]=null}var pl=null,hl=null,io=!1,uh=null;function mQ(u,_){var E=Hl(5,null,null,0);E.elementType="DELETED",E.stateNode=_,E.return=u,_=u.deletions,_===null?(u.deletions=[E],u.flags|=16):_.push(E)}function N7(u,_){switch(u.tag){case 5:var E=u.type;return _=_.nodeType!==1||E.toLowerCase()!==_.nodeName.toLowerCase()?null:_,_!==null?(u.stateNode=_,pl=u,hl=Jm(_.firstChild),!0):!1;case 6:return _=u.pendingProps===""||_.nodeType!==3?null:_,_!==null?(u.stateNode=_,pl=u,hl=null,!0):!1;case 13:return _=_.nodeType!==8?null:_,_!==null?(E=xR!==null?{id:of,overflow:sf}:null,u.memoizedState={dehydrated:_,treeContext:E,retryLane:1073741824},E=Hl(18,null,null,0),E.stateNode=_,E.return=u,u.child=E,pl=u,hl=null,!0):!1;default:return!1}}function Oq(u){return(u.mode&1)!==0&&(u.flags&128)===0}function Nq(u){if(io){var _=hl;if(_){var E=_;if(!N7(u,_)){if(Oq(u))throw Error(ze(418));_=Jm(E.nextSibling);var R=pl;_&&N7(u,_)?mQ(R,E):(u.flags=u.flags&-4097|2,io=!1,pl=u)}}else{if(Oq(u))throw Error(ze(418));u.flags=u.flags&-4097|2,io=!1,pl=u}}}function D7(u){for(u=u.return;u!==null&&u.tag!==5&&u.tag!==3&&u.tag!==13;)u=u.return;pl=u}function Rx(u){if(u!==pl)return!1;if(!io)return D7(u),io=!0,!1;var _;if((_=u.tag!==3)&&!(_=u.tag!==5)&&(_=u.type,_=_!=="head"&&_!=="body"&&!Iq(u.type,u.memoizedProps)),_&&(_=hl)){if(Oq(u))throw EQ(),Error(ze(418));for(;_;)mQ(u,_),_=Jm(_.nextSibling)}if(D7(u),u.tag===13){if(u=u.memoizedState,u=u!==null?u.dehydrated:null,!u)throw Error(ze(317));e:{for(u=u.nextSibling,_=0;u;){if(u.nodeType===8){var E=u.data;if(E==="/$"){if(_===0){hl=Jm(u.nextSibling);break e}_--}else E!=="$"&&E!=="$!"&&E!=="$?"||_++}u=u.nextSibling}hl=null}}else hl=pl?Jm(u.stateNode.nextSibling):null;return!0}function EQ(){for(var u=hl;u;)u=Jm(u.nextSibling)}function Wy(){hl=pl=null,io=!1}function EX(u){uh===null?uh=[u]:uh.push(u)}var Mee=hf.ReactCurrentBatchConfig;function S1(u,_,E){if(u=E.ref,u!==null&&typeof u!="function"&&typeof u!="object"){if(E._owner){if(E=E._owner,E){if(E.tag!==1)throw Error(ze(309));var R=E.stateNode}if(!R)throw Error(ze(147,u));var A=R,P=""+u;return _!==null&&_.ref!==null&&typeof _.ref=="function"&&_.ref._stringRef===P?_.ref:(_=function(G){var q=A.refs;G===null?delete q[P]:q[P]=G},_._stringRef=P,_)}if(typeof u!="string")throw Error(ze(284));if(!E._owner)throw Error(ze(290,u))}return u}function vx(u,_){throw u=Object.prototype.toString.call(_),Error(ze(31,u==="[object Object]"?"object with keys {"+Object.keys(_).join(", ")+"}":u))}function P7(u){var _=u._init;return _(u._payload)}function gQ(u){function _(pe,ce){if(u){var fe=pe.deletions;fe===null?(pe.deletions=[ce],pe.flags|=16):fe.push(ce)}}function E(pe,ce){if(!u)return null;for(;ce!==null;)_(pe,ce),ce=ce.sibling;return null}function R(pe,ce){for(pe=new Map;ce!==null;)ce.key!==null?pe.set(ce.key,ce):pe.set(ce.index,ce),ce=ce.sibling;return pe}function A(pe,ce){return pe=eE(pe,ce),pe.index=0,pe.sibling=null,pe}function P(pe,ce,fe){return pe.index=fe,u?(fe=pe.alternate,fe!==null?(fe=fe.index,fe<ce?(pe.flags|=2,ce):fe):(pe.flags|=2,ce)):(pe.flags|=1048576,ce)}function G(pe){return u&&pe.alternate===null&&(pe.flags|=2),pe}function q(pe,ce,fe,We){return ce===null||ce.tag!==6?(ce=eq(fe,pe.mode,We),ce.return=pe,ce):(ce=A(ce,fe),ce.return=pe,ce)}function ee(pe,ce,fe,We){var lt=fe.type;return lt===yy?Ie(pe,ce,fe.props.children,We,fe.key):ce!==null&&(ce.elementType===lt||typeof lt=="object"&&lt!==null&&lt.$$typeof===jm&&P7(lt)===ce.type)?(We=A(ce,fe.props),We.ref=S1(pe,ce,fe),We.return=pe,We):(We=Vx(fe.type,fe.key,fe.props,null,pe.mode,We),We.ref=S1(pe,ce,fe),We.return=pe,We)}function de(pe,ce,fe,We){return ce===null||ce.tag!==4||ce.stateNode.containerInfo!==fe.containerInfo||ce.stateNode.implementation!==fe.implementation?(ce=tq(fe,pe.mode,We),ce.return=pe,ce):(ce=A(ce,fe.children||[]),ce.return=pe,ce)}function Ie(pe,ce,fe,We,lt){return ce===null||ce.tag!==7?(ce=MR(fe,pe.mode,We,lt),ce.return=pe,ce):(ce=A(ce,fe),ce.return=pe,ce)}function he(pe,ce,fe){if(typeof ce=="string"&&ce!==""||typeof ce=="number")return ce=eq(""+ce,pe.mode,fe),ce.return=pe,ce;if(typeof ce=="object"&&ce!==null){switch(ce.$$typeof){case ux:return fe=Vx(ce.type,ce.key,ce.props,null,pe.mode,fe),fe.ref=S1(pe,null,ce),fe.return=pe,fe;case Cy:return ce=tq(ce,pe.mode,fe),ce.return=pe,ce;case jm:var We=ce._init;return he(pe,We(ce._payload),fe)}if(C1(ce)||_1(ce))return ce=MR(ce,pe.mode,fe,null),ce.return=pe,ce;vx(pe,ce)}return null}function me(pe,ce,fe,We){var lt=ce!==null?ce.key:null;if(typeof fe=="string"&&fe!==""||typeof fe=="number")return lt!==null?null:q(pe,ce,""+fe,We);if(typeof fe=="object"&&fe!==null){switch(fe.$$typeof){case ux:return fe.key===lt?ee(pe,ce,fe,We):null;case Cy:return fe.key===lt?de(pe,ce,fe,We):null;case jm:return lt=fe._init,me(pe,ce,lt(fe._payload),We)}if(C1(fe)||_1(fe))return lt!==null?null:Ie(pe,ce,fe,We,null);vx(pe,fe)}return null}function je(pe,ce,fe,We,lt){if(typeof We=="string"&&We!==""||typeof We=="number")return pe=pe.get(fe)||null,q(ce,pe,""+We,lt);if(typeof We=="object"&&We!==null){switch(We.$$typeof){case ux:return pe=pe.get(We.key===null?fe:We.key)||null,ee(ce,pe,We,lt);case Cy:return pe=pe.get(We.key===null?fe:We.key)||null,de(ce,pe,We,lt);case jm:var jt=We._init;return je(pe,ce,fe,jt(We._payload),lt)}if(C1(We)||_1(We))return pe=pe.get(fe)||null,Ie(ce,pe,We,lt,null);vx(ce,We)}return null}function ve(pe,ce,fe,We){for(var lt=null,jt=null,dt=ce,zt=ce=0,Pn=null;dt!==null&&zt<fe.length;zt++){dt.index>zt?(Pn=dt,dt=null):Pn=dt.sibling;var Ri=me(pe,dt,fe[zt],We);if(Ri===null){dt===null&&(dt=Pn);break}u&&dt&&Ri.alternate===null&&_(pe,dt),ce=P(Ri,ce,zt),jt===null?lt=Ri:jt.sibling=Ri,jt=Ri,dt=Pn}if(zt===fe.length)return E(pe,dt),io&&wR(pe,zt),lt;if(dt===null){for(;zt<fe.length;zt++)dt=he(pe,fe[zt],We),dt!==null&&(ce=P(dt,ce,zt),jt===null?lt=dt:jt.sibling=dt,jt=dt);return io&&wR(pe,zt),lt}for(dt=R(pe,dt);zt<fe.length;zt++)Pn=je(dt,pe,zt,fe[zt],We),Pn!==null&&(u&&Pn.alternate!==null&&dt.delete(Pn.key===null?zt:Pn.key),ce=P(Pn,ce,zt),jt===null?lt=Pn:jt.sibling=Pn,jt=Pn);return u&&dt.forEach(function(is){return _(pe,is)}),io&&wR(pe,zt),lt}function ge(pe,ce,fe,We){var lt=_1(fe);if(typeof lt!="function")throw Error(ze(150));if(fe=lt.call(fe),fe==null)throw Error(ze(151));for(var jt=lt=null,dt=ce,zt=ce=0,Pn=null,Ri=fe.next();dt!==null&&!Ri.done;zt++,Ri=fe.next()){dt.index>zt?(Pn=dt,dt=null):Pn=dt.sibling;var is=me(pe,dt,Ri.value,We);if(is===null){dt===null&&(dt=Pn);break}u&&dt&&is.alternate===null&&_(pe,dt),ce=P(is,ce,zt),jt===null?lt=is:jt.sibling=is,jt=is,dt=Pn}if(Ri.done)return E(pe,dt),io&&wR(pe,zt),lt;if(dt===null){for(;!Ri.done;zt++,Ri=fe.next())Ri=he(pe,Ri.value,We),Ri!==null&&(ce=P(Ri,ce,zt),jt===null?lt=Ri:jt.sibling=Ri,jt=Ri);return io&&wR(pe,zt),lt}for(dt=R(pe,dt);!Ri.done;zt++,Ri=fe.next())Ri=je(dt,pe,zt,Ri.value,We),Ri!==null&&(u&&Ri.alternate!==null&&dt.delete(Ri.key===null?zt:Ri.key),ce=P(Ri,ce,zt),jt===null?lt=Ri:jt.sibling=Ri,jt=Ri);return u&&dt.forEach(function(ci){return _(pe,ci)}),io&&wR(pe,zt),lt}function Ge(pe,ce,fe,We){if(typeof fe=="object"&&fe!==null&&fe.type===yy&&fe.key===null&&(fe=fe.props.children),typeof fe=="object"&&fe!==null){switch(fe.$$typeof){case ux:e:{for(var lt=fe.key,jt=ce;jt!==null;){if(jt.key===lt){if(lt=fe.type,lt===yy){if(jt.tag===7){E(pe,jt.sibling),ce=A(jt,fe.props.children),ce.return=pe,pe=ce;break e}}else if(jt.elementType===lt||typeof lt=="object"&&lt!==null&&lt.$$typeof===jm&&P7(lt)===jt.type){E(pe,jt.sibling),ce=A(jt,fe.props),ce.ref=S1(pe,jt,fe),ce.return=pe,pe=ce;break e}E(pe,jt);break}else _(pe,jt);jt=jt.sibling}fe.type===yy?(ce=MR(fe.props.children,pe.mode,We,fe.key),ce.return=pe,pe=ce):(We=Vx(fe.type,fe.key,fe.props,null,pe.mode,We),We.ref=S1(pe,ce,fe),We.return=pe,pe=We)}return G(pe);case Cy:e:{for(jt=fe.key;ce!==null;){if(ce.key===jt)if(ce.tag===4&&ce.stateNode.containerInfo===fe.containerInfo&&ce.stateNode.implementation===fe.implementation){E(pe,ce.sibling),ce=A(ce,fe.children||[]),ce.return=pe,pe=ce;break e}else{E(pe,ce);break}else _(pe,ce);ce=ce.sibling}ce=tq(fe,pe.mode,We),ce.return=pe,pe=ce}return G(pe);case jm:return jt=fe._init,Ge(pe,ce,jt(fe._payload),We)}if(C1(fe))return ve(pe,ce,fe,We);if(_1(fe))return ge(pe,ce,fe,We);vx(pe,fe)}return typeof fe=="string"&&fe!==""||typeof fe=="number"?(fe=""+fe,ce!==null&&ce.tag===6?(E(pe,ce.sibling),ce=A(ce,fe),ce.return=pe,pe=ce):(E(pe,ce),ce=eq(fe,pe.mode,We),ce.return=pe,pe=ce),G(pe)):E(pe,ce)}return Ge}var Hy=gQ(!0),SQ=gQ(!1),eV=nE(null),tV=null,Py=null,gX=null;function SX(){gX=Py=tV=null}function TX(u){var _=eV.current;Qn(eV),u._currentValue=_}function Dq(u,_,E){for(;u!==null;){var R=u.alternate;if((u.childLanes&_)!==_?(u.childLanes|=_,R!==null&&(R.childLanes|=_)):R!==null&&(R.childLanes&_)!==_&&(R.childLanes|=_),u===E)break;u=u.return}}function Fy(u,_){tV=u,gX=Py=null,u=u.dependencies,u!==null&&u.firstContext!==null&&(u.lanes&_&&($c=!0),u.firstContext=null)}function Yl(u){var _=u._currentValue;if(gX!==u)if(u={context:u,memoizedValue:_,next:null},Py===null){if(tV===null)throw Error(ze(308));Py=u,tV.dependencies={lanes:0,firstContext:u}}else Py=Py.next=u;return _}var PR=null;function RX(u){PR===null?PR=[u]:PR.push(u)}function TQ(u,_,E,R){var A=_.interleaved;return A===null?(E.next=E,RX(_)):(E.next=A.next,A.next=E),_.interleaved=E,lf(u,R)}function lf(u,_){u.lanes|=_;var E=u.alternate;for(E!==null&&(E.lanes|=_),E=u,u=u.return;u!==null;)u.childLanes|=_,E=u.alternate,E!==null&&(E.childLanes|=_),E=u,u=u.return;return E.tag===3?E.stateNode:null}var Gm=!1;function vX(u){u.updateQueue={baseState:u.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function RQ(u,_){u=u.updateQueue,_.updateQueue===u&&(_.updateQueue={baseState:u.baseState,firstBaseUpdate:u.firstBaseUpdate,lastBaseUpdate:u.lastBaseUpdate,shared:u.shared,effects:u.effects})}function af(u,_){return{eventTime:u,lane:_,tag:0,payload:null,callback:null,next:null}}function Qm(u,_,E){var R=u.updateQueue;if(R===null)return null;if(R=R.shared,Nr&2){var A=R.pending;return A===null?_.next=_:(_.next=A.next,A.next=_),R.pending=_,lf(u,E)}return A=R.interleaved,A===null?(_.next=_,RX(R)):(_.next=A.next,A.next=_),R.interleaved=_,lf(u,E)}function Px(u,_,E){if(_=_.updateQueue,_!==null&&(_=_.shared,(E&4194240)!==0)){var R=_.lanes;R&=u.pendingLanes,E|=R,_.lanes=E,aX(u,E)}}function L7(u,_){var E=u.updateQueue,R=u.alternate;if(R!==null&&(R=R.updateQueue,E===R)){var A=null,P=null;if(E=E.firstBaseUpdate,E!==null){do{var G={eventTime:E.eventTime,lane:E.lane,tag:E.tag,payload:E.payload,callback:E.callback,next:null};P===null?A=P=G:P=P.next=G,E=E.next}while(E!==null);P===null?A=P=_:P=P.next=_}else A=P=_;E={baseState:R.baseState,firstBaseUpdate:A,lastBaseUpdate:P,shared:R.shared,effects:R.effects},u.updateQueue=E;return}u=E.lastBaseUpdate,u===null?E.firstBaseUpdate=_:u.next=_,E.lastBaseUpdate=_}function iV(u,_,E,R){var A=u.updateQueue;Gm=!1;var P=A.firstBaseUpdate,G=A.lastBaseUpdate,q=A.shared.pending;if(q!==null){A.shared.pending=null;var ee=q,de=ee.next;ee.next=null,G===null?P=de:G.next=de,G=ee;var Ie=u.alternate;Ie!==null&&(Ie=Ie.updateQueue,q=Ie.lastBaseUpdate,q!==G&&(q===null?Ie.firstBaseUpdate=de:q.next=de,Ie.lastBaseUpdate=ee))}if(P!==null){var he=A.baseState;G=0,Ie=de=ee=null,q=P;do{var me=q.lane,je=q.eventTime;if((R&me)===me){Ie!==null&&(Ie=Ie.next={eventTime:je,lane:0,tag:q.tag,payload:q.payload,callback:q.callback,next:null});e:{var ve=u,ge=q;switch(me=_,je=E,ge.tag){case 1:if(ve=ge.payload,typeof ve=="function"){he=ve.call(je,he,me);break e}he=ve;break e;case 3:ve.flags=ve.flags&-65537|128;case 0:if(ve=ge.payload,me=typeof ve=="function"?ve.call(je,he,me):ve,me==null)break e;he=_o({},he,me);break e;case 2:Gm=!0}}q.callback!==null&&q.lane!==0&&(u.flags|=64,me=A.effects,me===null?A.effects=[q]:me.push(q))}else je={eventTime:je,lane:me,tag:q.tag,payload:q.payload,callback:q.callback,next:null},Ie===null?(de=Ie=je,ee=he):Ie=Ie.next=je,G|=me;if(q=q.next,q===null){if(q=A.shared.pending,q===null)break;me=q,q=me.next,me.next=null,A.lastBaseUpdate=me,A.shared.pending=null}}while(!0);if(Ie===null&&(ee=he),A.baseState=ee,A.firstBaseUpdate=de,A.lastBaseUpdate=Ie,_=A.shared.interleaved,_!==null){A=_;do G|=A.lane,A=A.next;while(A!==_)}else P===null&&(A.shared.lanes=0);FR|=G,u.lanes=G,u.memoizedState=he}}function k7(u,_,E){if(u=_.effects,_.effects=null,u!==null)for(_=0;_<u.length;_++){var R=u[_],A=R.callback;if(A!==null){if(R.callback=null,R=E,typeof A!="function")throw Error(ze(191,A));A.call(R)}}}var nM={},dp=nE(nM),q1=nE(nM),X1=nE(nM);function LR(u){if(u===nM)throw Error(ze(174));return u}function CX(u,_){switch(Dn(X1,_),Dn(q1,u),Dn(dp,nM),u=_.nodeType,u){case 9:case 11:_=(_=_.documentElement)?_.namespaceURI:uq(null,"");break;default:u=u===8?_.parentNode:_,_=u.namespaceURI||null,u=u.tagName,_=uq(_,u)}Qn(dp),Dn(dp,_)}function Ky(){Qn(dp),Qn(q1),Qn(X1)}function vQ(u){LR(X1.current);var _=LR(dp.current),E=uq(_,u.type);_!==E&&(Dn(q1,u),Dn(dp,E))}function yX(u){q1.current===u&&(Qn(dp),Qn(q1))}var ho=nE(0);function rV(u){for(var _=u;_!==null;){if(_.tag===13){var E=_.memoizedState;if(E!==null&&(E=E.dehydrated,E===null||E.data==="$?"||E.data==="$!"))return _}else if(_.tag===19&&_.memoizedProps.revealOrder!==void 0){if(_.flags&128)return _}else if(_.child!==null){_.child.return=_,_=_.child;continue}if(_===u)break;for(;_.sibling===null;){if(_.return===null||_.return===u)return null;_=_.return}_.sibling.return=_.return,_=_.sibling}return null}var q9=[];function IX(){for(var u=0;u<q9.length;u++)q9[u]._workInProgressVersionPrimary=null;q9.length=0}var Lx=hf.ReactCurrentDispatcher,X9=hf.ReactCurrentBatchConfig,VR=0,po=null,Ss=null,Us=null,nV=!1,L1=!1,J1=0,Uee=0;function La(){throw Error(ze(321))}function AX(u,_){if(_===null)return!1;for(var E=0;E<_.length&&E<u.length;E++)if(!_h(u[E],_[E]))return!1;return!0}function wX(u,_,E,R,A,P){if(VR=P,po=_,_.memoizedState=null,_.updateQueue=null,_.lanes=0,Lx.current=u===null||u.memoizedState===null?Bee:jee,u=E(R,A),L1){P=0;do{if(L1=!1,J1=0,25<=P)throw Error(ze(301));P+=1,Us=Ss=null,_.updateQueue=null,Lx.current=Gee,u=E(R,A)}while(L1)}if(Lx.current=oV,_=Ss!==null&&Ss.next!==null,VR=0,Us=Ss=po=null,nV=!1,_)throw Error(ze(300));return u}function bX(){var u=J1!==0;return J1=0,u}function sp(){var u={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return Us===null?po.memoizedState=Us=u:Us=Us.next=u,Us}function zl(){if(Ss===null){var u=po.alternate;u=u!==null?u.memoizedState:null}else u=Ss.next;var _=Us===null?po.memoizedState:Us.next;if(_!==null)Us=_,Ss=u;else{if(u===null)throw Error(ze(310));Ss=u,u={memoizedState:Ss.memoizedState,baseState:Ss.baseState,baseQueue:Ss.baseQueue,queue:Ss.queue,next:null},Us===null?po.memoizedState=Us=u:Us=Us.next=u}return Us}function Q1(u,_){return typeof _=="function"?_(u):_}function J9(u){var _=zl(),E=_.queue;if(E===null)throw Error(ze(311));E.lastRenderedReducer=u;var R=Ss,A=R.baseQueue,P=E.pending;if(P!==null){if(A!==null){var G=A.next;A.next=P.next,P.next=G}R.baseQueue=A=P,E.pending=null}if(A!==null){P=A.next,R=R.baseState;var q=G=null,ee=null,de=P;do{var Ie=de.lane;if((VR&Ie)===Ie)ee!==null&&(ee=ee.next={lane:0,action:de.action,hasEagerState:de.hasEagerState,eagerState:de.eagerState,next:null}),R=de.hasEagerState?de.eagerState:u(R,de.action);else{var he={lane:Ie,action:de.action,hasEagerState:de.hasEagerState,eagerState:de.eagerState,next:null};ee===null?(q=ee=he,G=R):ee=ee.next=he,po.lanes|=Ie,FR|=Ie}de=de.next}while(de!==null&&de!==P);ee===null?G=R:ee.next=q,_h(R,_.memoizedState)||($c=!0),_.memoizedState=R,_.baseState=G,_.baseQueue=ee,E.lastRenderedState=R}if(u=E.interleaved,u!==null){A=u;do P=A.lane,po.lanes|=P,FR|=P,A=A.next;while(A!==u)}else A===null&&(E.lanes=0);return[_.memoizedState,E.dispatch]}function Q9(u){var _=zl(),E=_.queue;if(E===null)throw Error(ze(311));E.lastRenderedReducer=u;var R=E.dispatch,A=E.pending,P=_.memoizedState;if(A!==null){E.pending=null;var G=A=A.next;do P=u(P,G.action),G=G.next;while(G!==A);_h(P,_.memoizedState)||($c=!0),_.memoizedState=P,_.baseQueue===null&&(_.baseState=P),E.lastRenderedState=P}return[P,R]}function CQ(){}function yQ(u,_){var E=po,R=zl(),A=_(),P=!_h(R.memoizedState,A);if(P&&(R.memoizedState=A,$c=!0),R=R.queue,OX(wQ.bind(null,E,R,u),[u]),R.getSnapshot!==_||P||Us!==null&&Us.memoizedState.tag&1){if(E.flags|=2048,Z1(9,AQ.bind(null,E,R,A,_),void 0,null),xs===null)throw Error(ze(349));VR&30||IQ(E,_,A)}return A}function IQ(u,_,E){u.flags|=16384,u={getSnapshot:_,value:E},_=po.updateQueue,_===null?(_={lastEffect:null,stores:null},po.updateQueue=_,_.stores=[u]):(E=_.stores,E===null?_.stores=[u]:E.push(u))}function AQ(u,_,E,R){_.value=E,_.getSnapshot=R,bQ(_)&&OQ(u)}function wQ(u,_,E){return E(function(){bQ(_)&&OQ(u)})}function bQ(u){var _=u.getSnapshot;u=u.value;try{var E=_();return!_h(u,E)}catch{return!0}}function OQ(u){var _=lf(u,1);_!==null&&ph(_,u,1,-1)}function M7(u){var _=sp();return typeof u=="function"&&(u=u()),_.memoizedState=_.baseState=u,u={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:Q1,lastRenderedState:u},_.queue=u,u=u.dispatch=Fee.bind(null,po,u),[_.memoizedState,u]}function Z1(u,_,E,R){return u={tag:u,create:_,destroy:E,deps:R,next:null},_=po.updateQueue,_===null?(_={lastEffect:null,stores:null},po.updateQueue=_,_.lastEffect=u.next=u):(E=_.lastEffect,E===null?_.lastEffect=u.next=u:(R=E.next,E.next=u,u.next=R,_.lastEffect=u)),u}function NQ(){return zl().memoizedState}function kx(u,_,E,R){var A=sp();po.flags|=u,A.memoizedState=Z1(1|_,E,void 0,R===void 0?null:R)}function gV(u,_,E,R){var A=zl();R=R===void 0?null:R;var P=void 0;if(Ss!==null){var G=Ss.memoizedState;if(P=G.destroy,R!==null&&AX(R,G.deps)){A.memoizedState=Z1(_,E,P,R);return}}po.flags|=u,A.memoizedState=Z1(1|_,E,P,R)}function U7(u,_){return kx(8390656,8,u,_)}function OX(u,_){return gV(2048,8,u,_)}function DQ(u,_){return gV(4,2,u,_)}function PQ(u,_){return gV(4,4,u,_)}function LQ(u,_){if(typeof _=="function")return u=u(),_(u),function(){_(null)};if(_!=null)return u=u(),_.current=u,function(){_.current=null}}function kQ(u,_,E){return E=E!=null?E.concat([u]):null,gV(4,4,LQ.bind(null,_,u),E)}function NX(){}function MQ(u,_){var E=zl();_=_===void 0?null:_;var R=E.memoizedState;return R!==null&&_!==null&&AX(_,R[1])?R[0]:(E.memoizedState=[u,_],u)}function UQ(u,_){var E=zl();_=_===void 0?null:_;var R=E.memoizedState;return R!==null&&_!==null&&AX(_,R[1])?R[0]:(u=u(),E.memoizedState=[u,_],u)}function xQ(u,_,E){return VR&21?(_h(E,_)||(E=GJ(),po.lanes|=E,FR|=E,u.baseState=!0),_):(u.baseState&&(u.baseState=!1,$c=!0),u.memoizedState=E)}function xee(u,_){var E=on;on=E!==0&&4>E?E:4,u(!0);var R=X9.transition;X9.transition={};try{u(!1),_()}finally{on=E,X9.transition=R}}function VQ(){return zl().memoizedState}function Vee(u,_,E){var R=$m(u);if(E={lane:R,action:E,hasEagerState:!1,eagerState:null,next:null},FQ(u))BQ(_,E);else if(E=TQ(u,_,E,R),E!==null){var A=Tc();ph(E,u,R,A),jQ(E,_,R)}}function Fee(u,_,E){var R=$m(u),A={lane:R,action:E,hasEagerState:!1,eagerState:null,next:null};if(FQ(u))BQ(_,A);else{var P=u.alternate;if(u.lanes===0&&(P===null||P.lanes===0)&&(P=_.lastRenderedReducer,P!==null))try{var G=_.lastRenderedState,q=P(G,E);if(A.hasEagerState=!0,A.eagerState=q,_h(q,G)){var ee=_.interleaved;ee===null?(A.next=A,RX(_)):(A.next=ee.next,ee.next=A),_.interleaved=A;return}}catch{}finally{}E=TQ(u,_,A,R),E!==null&&(A=Tc(),ph(E,u,R,A),jQ(E,_,R))}}function FQ(u){var _=u.alternate;return u===po||_!==null&&_===po}function BQ(u,_){L1=nV=!0;var E=u.pending;E===null?_.next=_:(_.next=E.next,E.next=_),u.pending=_}function jQ(u,_,E){if(E&4194240){var R=_.lanes;R&=u.pendingLanes,E|=R,_.lanes=E,aX(u,E)}}var oV={readContext:Yl,useCallback:La,useContext:La,useEffect:La,useImperativeHandle:La,useInsertionEffect:La,useLayoutEffect:La,useMemo:La,useReducer:La,useRef:La,useState:La,useDebugValue:La,useDeferredValue:La,useTransition:La,useMutableSource:La,useSyncExternalStore:La,useId:La,unstable_isNewReconciler:!1},Bee={readContext:Yl,useCallback:function(u,_){return sp().memoizedState=[u,_===void 0?null:_],u},useContext:Yl,useEffect:U7,useImperativeHandle:function(u,_,E){return E=E!=null?E.concat([u]):null,kx(4194308,4,LQ.bind(null,_,u),E)},useLayoutEffect:function(u,_){return kx(4194308,4,u,_)},useInsertionEffect:function(u,_){return kx(4,2,u,_)},useMemo:function(u,_){var E=sp();return _=_===void 0?null:_,u=u(),E.memoizedState=[u,_],u},useReducer:function(u,_,E){var R=sp();return _=E!==void 0?E(_):_,R.memoizedState=R.baseState=_,u={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:u,lastRenderedState:_},R.queue=u,u=u.dispatch=Vee.bind(null,po,u),[R.memoizedState,u]},useRef:function(u){var _=sp();return u={current:u},_.memoizedState=u},useState:M7,useDebugValue:NX,useDeferredValue:function(u){return sp().memoizedState=u},useTransition:function(){var u=M7(!1),_=u[0];return u=xee.bind(null,u[1]),sp().memoizedState=u,[_,u]},useMutableSource:function(){},useSyncExternalStore:function(u,_,E){var R=po,A=sp();if(io){if(E===void 0)throw Error(ze(407));E=E()}else{if(E=_(),xs===null)throw Error(ze(349));VR&30||IQ(R,_,E)}A.memoizedState=E;var P={value:E,getSnapshot:_};return A.queue=P,U7(wQ.bind(null,R,P,u),[u]),R.flags|=2048,Z1(9,AQ.bind(null,R,P,E,_),void 0,null),E},useId:function(){var u=sp(),_=xs.identifierPrefix;if(io){var E=sf,R=of;E=(R&~(1<<32-hh(R)-1)).toString(32)+E,_=":"+_+"R"+E,E=J1++,0<E&&(_+="H"+E.toString(32)),_+=":"}else E=Uee++,_=":"+_+"r"+E.toString(32)+":";return u.memoizedState=_},unstable_isNewReconciler:!1},jee={readContext:Yl,useCallback:MQ,useContext:Yl,useEffect:OX,useImperativeHandle:kQ,useInsertionEffect:DQ,useLayoutEffect:PQ,useMemo:UQ,useReducer:J9,useRef:NQ,useState:function(){return J9(Q1)},useDebugValue:NX,useDeferredValue:function(u){var _=zl();return xQ(_,Ss.memoizedState,u)},useTransition:function(){var u=J9(Q1)[0],_=zl().memoizedState;return[u,_]},useMutableSource:CQ,useSyncExternalStore:yQ,useId:VQ,unstable_isNewReconciler:!1},Gee={readContext:Yl,useCallback:MQ,useContext:Yl,useEffect:OX,useImperativeHandle:kQ,useInsertionEffect:DQ,useLayoutEffect:PQ,useMemo:UQ,useReducer:Q9,useRef:NQ,useState:function(){return Q9(Q1)},useDebugValue:NX,useDeferredValue:function(u){var _=zl();return Ss===null?_.memoizedState=u:xQ(_,Ss.memoizedState,u)},useTransition:function(){var u=Q9(Q1)[0],_=zl().memoizedState;return[u,_]},useMutableSource:CQ,useSyncExternalStore:yQ,useId:VQ,unstable_isNewReconciler:!1};function dh(u,_){if(u&&u.defaultProps){_=_o({},_),u=u.defaultProps;for(var E in u)_[E]===void 0&&(_[E]=u[E]);return _}return _}function Pq(u,_,E,R){_=u.memoizedState,E=E(R,_),E=E==null?_:_o({},_,E),u.memoizedState=E,u.lanes===0&&(u.updateQueue.baseState=E)}var SV={isMounted:function(u){return(u=u._reactInternals)?GR(u)===u:!1},enqueueSetState:function(u,_,E){u=u._reactInternals;var R=Tc(),A=$m(u),P=af(R,A);P.payload=_,E!=null&&(P.callback=E),_=Qm(u,P,A),_!==null&&(ph(_,u,A,R),Px(_,u,A))},enqueueReplaceState:function(u,_,E){u=u._reactInternals;var R=Tc(),A=$m(u),P=af(R,A);P.tag=1,P.payload=_,E!=null&&(P.callback=E),_=Qm(u,P,A),_!==null&&(ph(_,u,A,R),Px(_,u,A))},enqueueForceUpdate:function(u,_){u=u._reactInternals;var E=Tc(),R=$m(u),A=af(E,R);A.tag=2,_!=null&&(A.callback=_),_=Qm(u,A,R),_!==null&&(ph(_,u,R,E),Px(_,u,R))}};function x7(u,_,E,R,A,P,G){return u=u.stateNode,typeof u.shouldComponentUpdate=="function"?u.shouldComponentUpdate(R,P,G):_.prototype&&_.prototype.isPureReactComponent?!H1(E,R)||!H1(A,P):!0}function GQ(u,_,E){var R=!1,A=iE,P=_.contextType;return typeof P=="object"&&P!==null?P=Yl(P):(A=td(_)?UR:xa.current,R=_.contextTypes,P=(R=R!=null)?Gy(u,A):iE),_=new _(E,P),u.memoizedState=_.state!==null&&_.state!==void 0?_.state:null,_.updater=SV,u.stateNode=_,_._reactInternals=u,R&&(u=u.stateNode,u.__reactInternalMemoizedUnmaskedChildContext=A,u.__reactInternalMemoizedMaskedChildContext=P),_}function V7(u,_,E,R){u=_.state,typeof _.componentWillReceiveProps=="function"&&_.componentWillReceiveProps(E,R),typeof _.UNSAFE_componentWillReceiveProps=="function"&&_.UNSAFE_componentWillReceiveProps(E,R),_.state!==u&&SV.enqueueReplaceState(_,_.state,null)}function Lq(u,_,E,R){var A=u.stateNode;A.props=E,A.state=u.memoizedState,A.refs={},vX(u);var P=_.contextType;typeof P=="object"&&P!==null?A.context=Yl(P):(P=td(_)?UR:xa.current,A.context=Gy(u,P)),A.state=u.memoizedState,P=_.getDerivedStateFromProps,typeof P=="function"&&(Pq(u,_,P,E),A.state=u.memoizedState),typeof _.getDerivedStateFromProps=="function"||typeof A.getSnapshotBeforeUpdate=="function"||typeof A.UNSAFE_componentWillMount!="function"&&typeof A.componentWillMount!="function"||(_=A.state,typeof A.componentWillMount=="function"&&A.componentWillMount(),typeof A.UNSAFE_componentWillMount=="function"&&A.UNSAFE_componentWillMount(),_!==A.state&&SV.enqueueReplaceState(A,A.state,null),iV(u,E,A,R),A.state=u.memoizedState),typeof A.componentDidMount=="function"&&(u.flags|=4194308)}function Yy(u,_){try{var E="",R=_;do E+=m$(R),R=R.return;while(R);var A=E}catch(P){A=`
Error generating stack: `+P.message+`
`+P.stack}return{value:u,source:_,stack:A,digest:null}}function Z9(u,_,E){return{value:u,source:null,stack:E??null,digest:_??null}}function kq(u,_){try{console.error(_.value)}catch(E){setTimeout(function(){throw E})}}var Wee=typeof WeakMap=="function"?WeakMap:Map;function WQ(u,_,E){E=af(-1,E),E.tag=3,E.payload={element:null};var R=_.value;return E.callback=function(){aV||(aV=!0,Hq=R),kq(u,_)},E}function HQ(u,_,E){E=af(-1,E),E.tag=3;var R=u.type.getDerivedStateFromError;if(typeof R=="function"){var A=_.value;E.payload=function(){return R(A)},E.callback=function(){kq(u,_)}}var P=u.stateNode;return P!==null&&typeof P.componentDidCatch=="function"&&(E.callback=function(){kq(u,_),typeof R!="function"&&(Zm===null?Zm=new Set([this]):Zm.add(this));var G=_.stack;this.componentDidCatch(_.value,{componentStack:G!==null?G:""})}),E}function F7(u,_,E){var R=u.pingCache;if(R===null){R=u.pingCache=new Wee;var A=new Set;R.set(_,A)}else A=R.get(_),A===void 0&&(A=new Set,R.set(_,A));A.has(E)||(A.add(E),u=rte.bind(null,u,_,E),_.then(u,u))}function B7(u){do{var _;if((_=u.tag===13)&&(_=u.memoizedState,_=_!==null?_.dehydrated!==null:!0),_)return u;u=u.return}while(u!==null);return null}function j7(u,_,E,R,A){return u.mode&1?(u.flags|=65536,u.lanes=A,u):(u===_?u.flags|=65536:(u.flags|=128,E.flags|=131072,E.flags&=-52805,E.tag===1&&(E.alternate===null?E.tag=17:(_=af(-1,1),_.tag=2,Qm(E,_,1))),E.lanes|=1),u)}var Hee=hf.ReactCurrentOwner,$c=!1;function Sc(u,_,E,R){_.child=u===null?SQ(_,null,E,R):Hy(_,u.child,E,R)}function G7(u,_,E,R,A){E=E.render;var P=_.ref;return Fy(_,A),R=wX(u,_,E,R,P,A),E=bX(),u!==null&&!$c?(_.updateQueue=u.updateQueue,_.flags&=-2053,u.lanes&=~A,uf(u,_,A)):(io&&E&&fX(_),_.flags|=1,Sc(u,_,R,A),_.child)}function W7(u,_,E,R,A){if(u===null){var P=E.type;return typeof P=="function"&&!VX(P)&&P.defaultProps===void 0&&E.compare===null&&E.defaultProps===void 0?(_.tag=15,_.type=P,KQ(u,_,P,R,A)):(u=Vx(E.type,null,R,_,_.mode,A),u.ref=_.ref,u.return=_,_.child=u)}if(P=u.child,!(u.lanes&A)){var G=P.memoizedProps;if(E=E.compare,E=E!==null?E:H1,E(G,R)&&u.ref===_.ref)return uf(u,_,A)}return _.flags|=1,u=eE(P,R),u.ref=_.ref,u.return=_,_.child=u}function KQ(u,_,E,R,A){if(u!==null){var P=u.memoizedProps;if(H1(P,R)&&u.ref===_.ref)if($c=!1,_.pendingProps=R=P,(u.lanes&A)!==0)u.flags&131072&&($c=!0);else return _.lanes=u.lanes,uf(u,_,A)}return Mq(u,_,E,R,A)}function YQ(u,_,E){var R=_.pendingProps,A=R.children,P=u!==null?u.memoizedState:null;if(R.mode==="hidden")if(!(_.mode&1))_.memoizedState={baseLanes:0,cachePool:null,transitions:null},Dn(ky,ul),ul|=E;else{if(!(E&1073741824))return u=P!==null?P.baseLanes|E:E,_.lanes=_.childLanes=1073741824,_.memoizedState={baseLanes:u,cachePool:null,transitions:null},_.updateQueue=null,Dn(ky,ul),ul|=u,null;_.memoizedState={baseLanes:0,cachePool:null,transitions:null},R=P!==null?P.baseLanes:E,Dn(ky,ul),ul|=R}else P!==null?(R=P.baseLanes|E,_.memoizedState=null):R=E,Dn(ky,ul),ul|=R;return Sc(u,_,A,E),_.child}function zQ(u,_){var E=_.ref;(u===null&&E!==null||u!==null&&u.ref!==E)&&(_.flags|=512,_.flags|=2097152)}function Mq(u,_,E,R,A){var P=td(E)?UR:xa.current;return P=Gy(_,P),Fy(_,A),E=wX(u,_,E,R,P,A),R=bX(),u!==null&&!$c?(_.updateQueue=u.updateQueue,_.flags&=-2053,u.lanes&=~A,uf(u,_,A)):(io&&R&&fX(_),_.flags|=1,Sc(u,_,E,A),_.child)}function H7(u,_,E,R,A){if(td(E)){var P=!0;Qx(_)}else P=!1;if(Fy(_,A),_.stateNode===null)Mx(u,_),GQ(_,E,R),Lq(_,E,R,A),R=!0;else if(u===null){var G=_.stateNode,q=_.memoizedProps;G.props=q;var ee=G.context,de=E.contextType;typeof de=="object"&&de!==null?de=Yl(de):(de=td(E)?UR:xa.current,de=Gy(_,de));var Ie=E.getDerivedStateFromProps,he=typeof Ie=="function"||typeof G.getSnapshotBeforeUpdate=="function";he||typeof G.UNSAFE_componentWillReceiveProps!="function"&&typeof G.componentWillReceiveProps!="function"||(q!==R||ee!==de)&&V7(_,G,R,de),Gm=!1;var me=_.memoizedState;G.state=me,iV(_,R,G,A),ee=_.memoizedState,q!==R||me!==ee||ed.current||Gm?(typeof Ie=="function"&&(Pq(_,E,Ie,R),ee=_.memoizedState),(q=Gm||x7(_,E,q,R,me,ee,de))?(he||typeof G.UNSAFE_componentWillMount!="function"&&typeof G.componentWillMount!="function"||(typeof G.componentWillMount=="function"&&G.componentWillMount(),typeof G.UNSAFE_componentWillMount=="function"&&G.UNSAFE_componentWillMount()),typeof G.componentDidMount=="function"&&(_.flags|=4194308)):(typeof G.componentDidMount=="function"&&(_.flags|=4194308),_.memoizedProps=R,_.memoizedState=ee),G.props=R,G.state=ee,G.context=de,R=q):(typeof G.componentDidMount=="function"&&(_.flags|=4194308),R=!1)}else{G=_.stateNode,RQ(u,_),q=_.memoizedProps,de=_.type===_.elementType?q:dh(_.type,q),G.props=de,he=_.pendingProps,me=G.context,ee=E.contextType,typeof ee=="object"&&ee!==null?ee=Yl(ee):(ee=td(E)?UR:xa.current,ee=Gy(_,ee));var je=E.getDerivedStateFromProps;(Ie=typeof je=="function"||typeof G.getSnapshotBeforeUpdate=="function")||typeof G.UNSAFE_componentWillReceiveProps!="function"&&typeof G.componentWillReceiveProps!="function"||(q!==he||me!==ee)&&V7(_,G,R,ee),Gm=!1,me=_.memoizedState,G.state=me,iV(_,R,G,A);var ve=_.memoizedState;q!==he||me!==ve||ed.current||Gm?(typeof je=="function"&&(Pq(_,E,je,R),ve=_.memoizedState),(de=Gm||x7(_,E,de,R,me,ve,ee)||!1)?(Ie||typeof G.UNSAFE_componentWillUpdate!="function"&&typeof G.componentWillUpdate!="function"||(typeof G.componentWillUpdate=="function"&&G.componentWillUpdate(R,ve,ee),typeof G.UNSAFE_componentWillUpdate=="function"&&G.UNSAFE_componentWillUpdate(R,ve,ee)),typeof G.componentDidUpdate=="function"&&(_.flags|=4),typeof G.getSnapshotBeforeUpdate=="function"&&(_.flags|=1024)):(typeof G.componentDidUpdate!="function"||q===u.memoizedProps&&me===u.memoizedState||(_.flags|=4),typeof G.getSnapshotBeforeUpdate!="function"||q===u.memoizedProps&&me===u.memoizedState||(_.flags|=1024),_.memoizedProps=R,_.memoizedState=ve),G.props=R,G.state=ve,G.context=ee,R=de):(typeof G.componentDidUpdate!="function"||q===u.memoizedProps&&me===u.memoizedState||(_.flags|=4),typeof G.getSnapshotBeforeUpdate!="function"||q===u.memoizedProps&&me===u.memoizedState||(_.flags|=1024),R=!1)}return Uq(u,_,E,R,P,A)}function Uq(u,_,E,R,A,P){zQ(u,_);var G=(_.flags&128)!==0;if(!R&&!G)return A&&O7(_,E,!1),uf(u,_,P);R=_.stateNode,Hee.current=_;var q=G&&typeof E.getDerivedStateFromError!="function"?null:R.render();return _.flags|=1,u!==null&&G?(_.child=Hy(_,u.child,null,P),_.child=Hy(_,null,q,P)):Sc(u,_,q,P),_.memoizedState=R.state,A&&O7(_,E,!0),_.child}function qQ(u){var _=u.stateNode;_.pendingContext?b7(u,_.pendingContext,_.pendingContext!==_.context):_.context&&b7(u,_.context,!1),CX(u,_.containerInfo)}function K7(u,_,E,R,A){return Wy(),EX(A),_.flags|=256,Sc(u,_,E,R),_.child}var xq={dehydrated:null,treeContext:null,retryLane:0};function Vq(u){return{baseLanes:u,cachePool:null,transitions:null}}function XQ(u,_,E){var R=_.pendingProps,A=ho.current,P=!1,G=(_.flags&128)!==0,q;if((q=G)||(q=u!==null&&u.memoizedState===null?!1:(A&2)!==0),q?(P=!0,_.flags&=-129):(u===null||u.memoizedState!==null)&&(A|=1),Dn(ho,A&1),u===null)return Nq(_),u=_.memoizedState,u!==null&&(u=u.dehydrated,u!==null)?(_.mode&1?u.data==="$!"?_.lanes=8:_.lanes=1073741824:_.lanes=1,null):(G=R.children,u=R.fallback,P?(R=_.mode,P=_.child,G={mode:"hidden",children:G},!(R&1)&&P!==null?(P.childLanes=0,P.pendingProps=G):P=vV(G,R,0,null),u=MR(u,R,E,null),P.return=_,u.return=_,P.sibling=u,_.child=P,_.child.memoizedState=Vq(E),_.memoizedState=xq,u):DX(_,G));if(A=u.memoizedState,A!==null&&(q=A.dehydrated,q!==null))return Kee(u,_,G,R,q,A,E);if(P){P=R.fallback,G=_.mode,A=u.child,q=A.sibling;var ee={mode:"hidden",children:R.children};return!(G&1)&&_.child!==A?(R=_.child,R.childLanes=0,R.pendingProps=ee,_.deletions=null):(R=eE(A,ee),R.subtreeFlags=A.subtreeFlags&14680064),q!==null?P=eE(q,P):(P=MR(P,G,E,null),P.flags|=2),P.return=_,R.return=_,R.sibling=P,_.child=R,R=P,P=_.child,G=u.child.memoizedState,G=G===null?Vq(E):{baseLanes:G.baseLanes|E,cachePool:null,transitions:G.transitions},P.memoizedState=G,P.childLanes=u.childLanes&~E,_.memoizedState=xq,R}return P=u.child,u=P.sibling,R=eE(P,{mode:"visible",children:R.children}),!(_.mode&1)&&(R.lanes=E),R.return=_,R.sibling=null,u!==null&&(E=_.deletions,E===null?(_.deletions=[u],_.flags|=16):E.push(u)),_.child=R,_.memoizedState=null,R}function DX(u,_){return _=vV({mode:"visible",children:_},u.mode,0,null),_.return=u,u.child=_}function Cx(u,_,E,R){return R!==null&&EX(R),Hy(_,u.child,null,E),u=DX(_,_.pendingProps.children),u.flags|=2,_.memoizedState=null,u}function Kee(u,_,E,R,A,P,G){if(E)return _.flags&256?(_.flags&=-257,R=Z9(Error(ze(422))),Cx(u,_,G,R)):_.memoizedState!==null?(_.child=u.child,_.flags|=128,null):(P=R.fallback,A=_.mode,R=vV({mode:"visible",children:R.children},A,0,null),P=MR(P,A,G,null),P.flags|=2,R.return=_,P.return=_,R.sibling=P,_.child=R,_.mode&1&&Hy(_,u.child,null,G),_.child.memoizedState=Vq(G),_.memoizedState=xq,P);if(!(_.mode&1))return Cx(u,_,G,null);if(A.data==="$!"){if(R=A.nextSibling&&A.nextSibling.dataset,R)var q=R.dgst;return R=q,P=Error(ze(419)),R=Z9(P,R,void 0),Cx(u,_,G,R)}if(q=(G&u.childLanes)!==0,$c||q){if(R=xs,R!==null){switch(G&-G){case 4:A=2;break;case 16:A=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:A=32;break;case 536870912:A=268435456;break;default:A=0}A=A&(R.suspendedLanes|G)?0:A,A!==0&&A!==P.retryLane&&(P.retryLane=A,lf(u,A),ph(R,u,A,-1))}return xX(),R=Z9(Error(ze(421))),Cx(u,_,G,R)}return A.data==="$?"?(_.flags|=128,_.child=u.child,_=nte.bind(null,u),A._reactRetry=_,null):(u=P.treeContext,hl=Jm(A.nextSibling),pl=_,io=!0,uh=null,u!==null&&(Gl[Wl++]=of,Gl[Wl++]=sf,Gl[Wl++]=xR,of=u.id,sf=u.overflow,xR=_),_=DX(_,R.children),_.flags|=4096,_)}function Y7(u,_,E){u.lanes|=_;var R=u.alternate;R!==null&&(R.lanes|=_),Dq(u.return,_,E)}function $9(u,_,E,R,A){var P=u.memoizedState;P===null?u.memoizedState={isBackwards:_,rendering:null,renderingStartTime:0,last:R,tail:E,tailMode:A}:(P.isBackwards=_,P.rendering=null,P.renderingStartTime=0,P.last=R,P.tail=E,P.tailMode=A)}function JQ(u,_,E){var R=_.pendingProps,A=R.revealOrder,P=R.tail;if(Sc(u,_,R.children,E),R=ho.current,R&2)R=R&1|2,_.flags|=128;else{if(u!==null&&u.flags&128)e:for(u=_.child;u!==null;){if(u.tag===13)u.memoizedState!==null&&Y7(u,E,_);else if(u.tag===19)Y7(u,E,_);else if(u.child!==null){u.child.return=u,u=u.child;continue}if(u===_)break e;for(;u.sibling===null;){if(u.return===null||u.return===_)break e;u=u.return}u.sibling.return=u.return,u=u.sibling}R&=1}if(Dn(ho,R),!(_.mode&1))_.memoizedState=null;else switch(A){case"forwards":for(E=_.child,A=null;E!==null;)u=E.alternate,u!==null&&rV(u)===null&&(A=E),E=E.sibling;E=A,E===null?(A=_.child,_.child=null):(A=E.sibling,E.sibling=null),$9(_,!1,A,E,P);break;case"backwards":for(E=null,A=_.child,_.child=null;A!==null;){if(u=A.alternate,u!==null&&rV(u)===null){_.child=A;break}u=A.sibling,A.sibling=E,E=A,A=u}$9(_,!0,E,null,P);break;case"together":$9(_,!1,null,null,void 0);break;default:_.memoizedState=null}return _.child}function Mx(u,_){!(_.mode&1)&&u!==null&&(u.alternate=null,_.alternate=null,_.flags|=2)}function uf(u,_,E){if(u!==null&&(_.dependencies=u.dependencies),FR|=_.lanes,!(E&_.childLanes))return null;if(u!==null&&_.child!==u.child)throw Error(ze(153));if(_.child!==null){for(u=_.child,E=eE(u,u.pendingProps),_.child=E,E.return=_;u.sibling!==null;)u=u.sibling,E=E.sibling=eE(u,u.pendingProps),E.return=_;E.sibling=null}return _.child}function Yee(u,_,E){switch(_.tag){case 3:qQ(_),Wy();break;case 5:vQ(_);break;case 1:td(_.type)&&Qx(_);break;case 4:CX(_,_.stateNode.containerInfo);break;case 10:var R=_.type._context,A=_.memoizedProps.value;Dn(eV,R._currentValue),R._currentValue=A;break;case 13:if(R=_.memoizedState,R!==null)return R.dehydrated!==null?(Dn(ho,ho.current&1),_.flags|=128,null):E&_.child.childLanes?XQ(u,_,E):(Dn(ho,ho.current&1),u=uf(u,_,E),u!==null?u.sibling:null);Dn(ho,ho.current&1);break;case 19:if(R=(E&_.childLanes)!==0,u.flags&128){if(R)return JQ(u,_,E);_.flags|=128}if(A=_.memoizedState,A!==null&&(A.rendering=null,A.tail=null,A.lastEffect=null),Dn(ho,ho.current),R)break;return null;case 22:case 23:return _.lanes=0,YQ(u,_,E)}return uf(u,_,E)}var QQ,Fq,ZQ,$Q;QQ=function(u,_){for(var E=_.child;E!==null;){if(E.tag===5||E.tag===6)u.appendChild(E.stateNode);else if(E.tag!==4&&E.child!==null){E.child.return=E,E=E.child;continue}if(E===_)break;for(;E.sibling===null;){if(E.return===null||E.return===_)return;E=E.return}E.sibling.return=E.return,E=E.sibling}};Fq=function(){};ZQ=function(u,_,E,R){var A=u.memoizedProps;if(A!==R){u=_.stateNode,LR(dp.current);var P=null;switch(E){case"input":A=aq(u,A),R=aq(u,R),P=[];break;case"select":A=_o({},A,{value:void 0}),R=_o({},R,{value:void 0}),P=[];break;case"textarea":A=lq(u,A),R=lq(u,R),P=[];break;default:typeof A.onClick!="function"&&typeof R.onClick=="function"&&(u.onclick=Xx)}hq(E,R);var G;E=null;for(de in A)if(!R.hasOwnProperty(de)&&A.hasOwnProperty(de)&&A[de]!=null)if(de==="style"){var q=A[de];for(G in q)q.hasOwnProperty(G)&&(E||(E={}),E[G]="")}else de!=="dangerouslySetInnerHTML"&&de!=="children"&&de!=="suppressContentEditableWarning"&&de!=="suppressHydrationWarning"&&de!=="autoFocus"&&(x1.hasOwnProperty(de)?P||(P=[]):(P=P||[]).push(de,null));for(de in R){var ee=R[de];if(q=A!=null?A[de]:void 0,R.hasOwnProperty(de)&&ee!==q&&(ee!=null||q!=null))if(de==="style")if(q){for(G in q)!q.hasOwnProperty(G)||ee&&ee.hasOwnProperty(G)||(E||(E={}),E[G]="");for(G in ee)ee.hasOwnProperty(G)&&q[G]!==ee[G]&&(E||(E={}),E[G]=ee[G])}else E||(P||(P=[]),P.push(de,E)),E=ee;else de==="dangerouslySetInnerHTML"?(ee=ee?ee.__html:void 0,q=q?q.__html:void 0,ee!=null&&q!==ee&&(P=P||[]).push(de,ee)):de==="children"?typeof ee!="string"&&typeof ee!="number"||(P=P||[]).push(de,""+ee):de!=="suppressContentEditableWarning"&&de!=="suppressHydrationWarning"&&(x1.hasOwnProperty(de)?(ee!=null&&de==="onScroll"&&Jn("scroll",u),P||q===ee||(P=[])):(P=P||[]).push(de,ee))}E&&(P=P||[]).push("style",E);var de=P;(_.updateQueue=de)&&(_.flags|=4)}};$Q=function(u,_,E,R){E!==R&&(_.flags|=4)};function T1(u,_){if(!io)switch(u.tailMode){case"hidden":_=u.tail;for(var E=null;_!==null;)_.alternate!==null&&(E=_),_=_.sibling;E===null?u.tail=null:E.sibling=null;break;case"collapsed":E=u.tail;for(var R=null;E!==null;)E.alternate!==null&&(R=E),E=E.sibling;R===null?_||u.tail===null?u.tail=null:u.tail.sibling=null:R.sibling=null}}function ka(u){var _=u.alternate!==null&&u.alternate.child===u.child,E=0,R=0;if(_)for(var A=u.child;A!==null;)E|=A.lanes|A.childLanes,R|=A.subtreeFlags&14680064,R|=A.flags&14680064,A.return=u,A=A.sibling;else for(A=u.child;A!==null;)E|=A.lanes|A.childLanes,R|=A.subtreeFlags,R|=A.flags,A.return=u,A=A.sibling;return u.subtreeFlags|=R,u.childLanes=E,_}function zee(u,_,E){var R=_.pendingProps;switch(mX(_),_.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return ka(_),null;case 1:return td(_.type)&&Jx(),ka(_),null;case 3:return R=_.stateNode,Ky(),Qn(ed),Qn(xa),IX(),R.pendingContext&&(R.context=R.pendingContext,R.pendingContext=null),(u===null||u.child===null)&&(Rx(_)?_.flags|=4:u===null||u.memoizedState.isDehydrated&&!(_.flags&256)||(_.flags|=1024,uh!==null&&(zq(uh),uh=null))),Fq(u,_),ka(_),null;case 5:yX(_);var A=LR(X1.current);if(E=_.type,u!==null&&_.stateNode!=null)ZQ(u,_,E,R,A),u.ref!==_.ref&&(_.flags|=512,_.flags|=2097152);else{if(!R){if(_.stateNode===null)throw Error(ze(166));return ka(_),null}if(u=LR(dp.current),Rx(_)){R=_.stateNode,E=_.type;var P=_.memoizedProps;switch(R[ap]=_,R[z1]=P,u=(_.mode&1)!==0,E){case"dialog":Jn("cancel",R),Jn("close",R);break;case"iframe":case"object":case"embed":Jn("load",R);break;case"video":case"audio":for(A=0;A<I1.length;A++)Jn(I1[A],R);break;case"source":Jn("error",R);break;case"img":case"image":case"link":Jn("error",R),Jn("load",R);break;case"details":Jn("toggle",R);break;case"input":t7(R,P),Jn("invalid",R);break;case"select":R._wrapperState={wasMultiple:!!P.multiple},Jn("invalid",R);break;case"textarea":r7(R,P),Jn("invalid",R)}hq(E,P),A=null;for(var G in P)if(P.hasOwnProperty(G)){var q=P[G];G==="children"?typeof q=="string"?R.textContent!==q&&(P.suppressHydrationWarning!==!0&&Tx(R.textContent,q,u),A=["children",q]):typeof q=="number"&&R.textContent!==""+q&&(P.suppressHydrationWarning!==!0&&Tx(R.textContent,q,u),A=["children",""+q]):x1.hasOwnProperty(G)&&q!=null&&G==="onScroll"&&Jn("scroll",R)}switch(E){case"input":hx(R),i7(R,P,!0);break;case"textarea":hx(R),n7(R);break;case"select":case"option":break;default:typeof P.onClick=="function"&&(R.onclick=Xx)}R=A,_.updateQueue=R,R!==null&&(_.flags|=4)}else{G=A.nodeType===9?A:A.ownerDocument,u==="http://www.w3.org/1999/xhtml"&&(u=wJ(E)),u==="http://www.w3.org/1999/xhtml"?E==="script"?(u=G.createElement("div"),u.innerHTML="<script><\/script>",u=u.removeChild(u.firstChild)):typeof R.is=="string"?u=G.createElement(E,{is:R.is}):(u=G.createElement(E),E==="select"&&(G=u,R.multiple?G.multiple=!0:R.size&&(G.size=R.size))):u=G.createElementNS(u,E),u[ap]=_,u[z1]=R,QQ(u,_,!1,!1),_.stateNode=u;e:{switch(G=pq(E,R),E){case"dialog":Jn("cancel",u),Jn("close",u),A=R;break;case"iframe":case"object":case"embed":Jn("load",u),A=R;break;case"video":case"audio":for(A=0;A<I1.length;A++)Jn(I1[A],u);A=R;break;case"source":Jn("error",u),A=R;break;case"img":case"image":case"link":Jn("error",u),Jn("load",u),A=R;break;case"details":Jn("toggle",u),A=R;break;case"input":t7(u,R),A=aq(u,R),Jn("invalid",u);break;case"option":A=R;break;case"select":u._wrapperState={wasMultiple:!!R.multiple},A=_o({},R,{value:void 0}),Jn("invalid",u);break;case"textarea":r7(u,R),A=lq(u,R),Jn("invalid",u);break;default:A=R}hq(E,A),q=A;for(P in q)if(q.hasOwnProperty(P)){var ee=q[P];P==="style"?NJ(u,ee):P==="dangerouslySetInnerHTML"?(ee=ee?ee.__html:void 0,ee!=null&&bJ(u,ee)):P==="children"?typeof ee=="string"?(E!=="textarea"||ee!=="")&&V1(u,ee):typeof ee=="number"&&V1(u,""+ee):P!=="suppressContentEditableWarning"&&P!=="suppressHydrationWarning"&&P!=="autoFocus"&&(x1.hasOwnProperty(P)?ee!=null&&P==="onScroll"&&Jn("scroll",u):ee!=null&&tX(u,P,ee,G))}switch(E){case"input":hx(u),i7(u,R,!1);break;case"textarea":hx(u),n7(u);break;case"option":R.value!=null&&u.setAttribute("value",""+tE(R.value));break;case"select":u.multiple=!!R.multiple,P=R.value,P!=null?My(u,!!R.multiple,P,!1):R.defaultValue!=null&&My(u,!!R.multiple,R.defaultValue,!0);break;default:typeof A.onClick=="function"&&(u.onclick=Xx)}switch(E){case"button":case"input":case"select":case"textarea":R=!!R.autoFocus;break e;case"img":R=!0;break e;default:R=!1}}R&&(_.flags|=4)}_.ref!==null&&(_.flags|=512,_.flags|=2097152)}return ka(_),null;case 6:if(u&&_.stateNode!=null)$Q(u,_,u.memoizedProps,R);else{if(typeof R!="string"&&_.stateNode===null)throw Error(ze(166));if(E=LR(X1.current),LR(dp.current),Rx(_)){if(R=_.stateNode,E=_.memoizedProps,R[ap]=_,(P=R.nodeValue!==E)&&(u=pl,u!==null))switch(u.tag){case 3:Tx(R.nodeValue,E,(u.mode&1)!==0);break;case 5:u.memoizedProps.suppressHydrationWarning!==!0&&Tx(R.nodeValue,E,(u.mode&1)!==0)}P&&(_.flags|=4)}else R=(E.nodeType===9?E:E.ownerDocument).createTextNode(R),R[ap]=_,_.stateNode=R}return ka(_),null;case 13:if(Qn(ho),R=_.memoizedState,u===null||u.memoizedState!==null&&u.memoizedState.dehydrated!==null){if(io&&hl!==null&&_.mode&1&&!(_.flags&128))EQ(),Wy(),_.flags|=98560,P=!1;else if(P=Rx(_),R!==null&&R.dehydrated!==null){if(u===null){if(!P)throw Error(ze(318));if(P=_.memoizedState,P=P!==null?P.dehydrated:null,!P)throw Error(ze(317));P[ap]=_}else Wy(),!(_.flags&128)&&(_.memoizedState=null),_.flags|=4;ka(_),P=!1}else uh!==null&&(zq(uh),uh=null),P=!0;if(!P)return _.flags&65536?_:null}return _.flags&128?(_.lanes=E,_):(R=R!==null,R!==(u!==null&&u.memoizedState!==null)&&R&&(_.child.flags|=8192,_.mode&1&&(u===null||ho.current&1?Ts===0&&(Ts=3):xX())),_.updateQueue!==null&&(_.flags|=4),ka(_),null);case 4:return Ky(),Fq(u,_),u===null&&K1(_.stateNode.containerInfo),ka(_),null;case 10:return TX(_.type._context),ka(_),null;case 17:return td(_.type)&&Jx(),ka(_),null;case 19:if(Qn(ho),P=_.memoizedState,P===null)return ka(_),null;if(R=(_.flags&128)!==0,G=P.rendering,G===null)if(R)T1(P,!1);else{if(Ts!==0||u!==null&&u.flags&128)for(u=_.child;u!==null;){if(G=rV(u),G!==null){for(_.flags|=128,T1(P,!1),R=G.updateQueue,R!==null&&(_.updateQueue=R,_.flags|=4),_.subtreeFlags=0,R=E,E=_.child;E!==null;)P=E,u=R,P.flags&=14680066,G=P.alternate,G===null?(P.childLanes=0,P.lanes=u,P.child=null,P.subtreeFlags=0,P.memoizedProps=null,P.memoizedState=null,P.updateQueue=null,P.dependencies=null,P.stateNode=null):(P.childLanes=G.childLanes,P.lanes=G.lanes,P.child=G.child,P.subtreeFlags=0,P.deletions=null,P.memoizedProps=G.memoizedProps,P.memoizedState=G.memoizedState,P.updateQueue=G.updateQueue,P.type=G.type,u=G.dependencies,P.dependencies=u===null?null:{lanes:u.lanes,firstContext:u.firstContext}),E=E.sibling;return Dn(ho,ho.current&1|2),_.child}u=u.sibling}P.tail!==null&&Fo()>zy&&(_.flags|=128,R=!0,T1(P,!1),_.lanes=4194304)}else{if(!R)if(u=rV(G),u!==null){if(_.flags|=128,R=!0,E=u.updateQueue,E!==null&&(_.updateQueue=E,_.flags|=4),T1(P,!0),P.tail===null&&P.tailMode==="hidden"&&!G.alternate&&!io)return ka(_),null}else 2*Fo()-P.renderingStartTime>zy&&E!==1073741824&&(_.flags|=128,R=!0,T1(P,!1),_.lanes=4194304);P.isBackwards?(G.sibling=_.child,_.child=G):(E=P.last,E!==null?E.sibling=G:_.child=G,P.last=G)}return P.tail!==null?(_=P.tail,P.rendering=_,P.tail=_.sibling,P.renderingStartTime=Fo(),_.sibling=null,E=ho.current,Dn(ho,R?E&1|2:E&1),_):(ka(_),null);case 22:case 23:return UX(),R=_.memoizedState!==null,u!==null&&u.memoizedState!==null!==R&&(_.flags|=8192),R&&_.mode&1?ul&1073741824&&(ka(_),_.subtreeFlags&6&&(_.flags|=8192)):ka(_),null;case 24:return null;case 25:return null}throw Error(ze(156,_.tag))}function qee(u,_){switch(mX(_),_.tag){case 1:return td(_.type)&&Jx(),u=_.flags,u&65536?(_.flags=u&-65537|128,_):null;case 3:return Ky(),Qn(ed),Qn(xa),IX(),u=_.flags,u&65536&&!(u&128)?(_.flags=u&-65537|128,_):null;case 5:return yX(_),null;case 13:if(Qn(ho),u=_.memoizedState,u!==null&&u.dehydrated!==null){if(_.alternate===null)throw Error(ze(340));Wy()}return u=_.flags,u&65536?(_.flags=u&-65537|128,_):null;case 19:return Qn(ho),null;case 4:return Ky(),null;case 10:return TX(_.type._context),null;case 22:case 23:return UX(),null;case 24:return null;default:return null}}var yx=!1,Ma=!1,Xee=typeof WeakSet=="function"?WeakSet:Set,Nt=null;function Ly(u,_){var E=u.ref;if(E!==null)if(typeof E=="function")try{E(null)}catch(R){vo(u,_,R)}else E.current=null}function Bq(u,_,E){try{E()}catch(R){vo(u,_,R)}}var z7=!1;function Jee(u,_){if(Cq=Yx,u=nQ(),_X(u)){if("selectionStart"in u)var E={start:u.selectionStart,end:u.selectionEnd};else e:{E=(E=u.ownerDocument)&&E.defaultView||window;var R=E.getSelection&&E.getSelection();if(R&&R.rangeCount!==0){E=R.anchorNode;var A=R.anchorOffset,P=R.focusNode;R=R.focusOffset;try{E.nodeType,P.nodeType}catch{E=null;break e}var G=0,q=-1,ee=-1,de=0,Ie=0,he=u,me=null;t:for(;;){for(var je;he!==E||A!==0&&he.nodeType!==3||(q=G+A),he!==P||R!==0&&he.nodeType!==3||(ee=G+R),he.nodeType===3&&(G+=he.nodeValue.length),(je=he.firstChild)!==null;)me=he,he=je;for(;;){if(he===u)break t;if(me===E&&++de===A&&(q=G),me===P&&++Ie===R&&(ee=G),(je=he.nextSibling)!==null)break;he=me,me=he.parentNode}he=je}E=q===-1||ee===-1?null:{start:q,end:ee}}else E=null}E=E||{start:0,end:0}}else E=null;for(yq={focusedElem:u,selectionRange:E},Yx=!1,Nt=_;Nt!==null;)if(_=Nt,u=_.child,(_.subtreeFlags&1028)!==0&&u!==null)u.return=_,Nt=u;else for(;Nt!==null;){_=Nt;try{var ve=_.alternate;if(_.flags&1024)switch(_.tag){case 0:case 11:case 15:break;case 1:if(ve!==null){var ge=ve.memoizedProps,Ge=ve.memoizedState,pe=_.stateNode,ce=pe.getSnapshotBeforeUpdate(_.elementType===_.type?ge:dh(_.type,ge),Ge);pe.__reactInternalSnapshotBeforeUpdate=ce}break;case 3:var fe=_.stateNode.containerInfo;fe.nodeType===1?fe.textContent="":fe.nodeType===9&&fe.documentElement&&fe.removeChild(fe.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(ze(163))}}catch(We){vo(_,_.return,We)}if(u=_.sibling,u!==null){u.return=_.return,Nt=u;break}Nt=_.return}return ve=z7,z7=!1,ve}function k1(u,_,E){var R=_.updateQueue;if(R=R!==null?R.lastEffect:null,R!==null){var A=R=R.next;do{if((A.tag&u)===u){var P=A.destroy;A.destroy=void 0,P!==void 0&&Bq(_,E,P)}A=A.next}while(A!==R)}}function TV(u,_){if(_=_.updateQueue,_=_!==null?_.lastEffect:null,_!==null){var E=_=_.next;do{if((E.tag&u)===u){var R=E.create;E.destroy=R()}E=E.next}while(E!==_)}}function jq(u){var _=u.ref;if(_!==null){var E=u.stateNode;switch(u.tag){case 5:u=E;break;default:u=E}typeof _=="function"?_(u):_.current=u}}function eZ(u){var _=u.alternate;_!==null&&(u.alternate=null,eZ(_)),u.child=null,u.deletions=null,u.sibling=null,u.tag===5&&(_=u.stateNode,_!==null&&(delete _[ap],delete _[z1],delete _[wq],delete _[Pee],delete _[Lee])),u.stateNode=null,u.return=null,u.dependencies=null,u.memoizedProps=null,u.memoizedState=null,u.pendingProps=null,u.stateNode=null,u.updateQueue=null}function tZ(u){return u.tag===5||u.tag===3||u.tag===4}function q7(u){e:for(;;){for(;u.sibling===null;){if(u.return===null||tZ(u.return))return null;u=u.return}for(u.sibling.return=u.return,u=u.sibling;u.tag!==5&&u.tag!==6&&u.tag!==18;){if(u.flags&2||u.child===null||u.tag===4)continue e;u.child.return=u,u=u.child}if(!(u.flags&2))return u.stateNode}}function Gq(u,_,E){var R=u.tag;if(R===5||R===6)u=u.stateNode,_?E.nodeType===8?E.parentNode.insertBefore(u,_):E.insertBefore(u,_):(E.nodeType===8?(_=E.parentNode,_.insertBefore(u,E)):(_=E,_.appendChild(u)),E=E._reactRootContainer,E!=null||_.onclick!==null||(_.onclick=Xx));else if(R!==4&&(u=u.child,u!==null))for(Gq(u,_,E),u=u.sibling;u!==null;)Gq(u,_,E),u=u.sibling}function Wq(u,_,E){var R=u.tag;if(R===5||R===6)u=u.stateNode,_?E.insertBefore(u,_):E.appendChild(u);else if(R!==4&&(u=u.child,u!==null))for(Wq(u,_,E),u=u.sibling;u!==null;)Wq(u,_,E),u=u.sibling}var ca=null,lh=!1;function Bm(u,_,E){for(E=E.child;E!==null;)iZ(u,_,E),E=E.sibling}function iZ(u,_,E){if(cp&&typeof cp.onCommitFiberUnmount=="function")try{cp.onCommitFiberUnmount(hV,E)}catch{}switch(E.tag){case 5:Ma||Ly(E,_);case 6:var R=ca,A=lh;ca=null,Bm(u,_,E),ca=R,lh=A,ca!==null&&(lh?(u=ca,E=E.stateNode,u.nodeType===8?u.parentNode.removeChild(E):u.removeChild(E)):ca.removeChild(E.stateNode));break;case 18:ca!==null&&(lh?(u=ca,E=E.stateNode,u.nodeType===8?Y9(u.parentNode,E):u.nodeType===1&&Y9(u,E),G1(u)):Y9(ca,E.stateNode));break;case 4:R=ca,A=lh,ca=E.stateNode.containerInfo,lh=!0,Bm(u,_,E),ca=R,lh=A;break;case 0:case 11:case 14:case 15:if(!Ma&&(R=E.updateQueue,R!==null&&(R=R.lastEffect,R!==null))){A=R=R.next;do{var P=A,G=P.destroy;P=P.tag,G!==void 0&&(P&2||P&4)&&Bq(E,_,G),A=A.next}while(A!==R)}Bm(u,_,E);break;case 1:if(!Ma&&(Ly(E,_),R=E.stateNode,typeof R.componentWillUnmount=="function"))try{R.props=E.memoizedProps,R.state=E.memoizedState,R.componentWillUnmount()}catch(q){vo(E,_,q)}Bm(u,_,E);break;case 21:Bm(u,_,E);break;case 22:E.mode&1?(Ma=(R=Ma)||E.memoizedState!==null,Bm(u,_,E),Ma=R):Bm(u,_,E);break;default:Bm(u,_,E)}}function X7(u){var _=u.updateQueue;if(_!==null){u.updateQueue=null;var E=u.stateNode;E===null&&(E=u.stateNode=new Xee),_.forEach(function(R){var A=ote.bind(null,u,R);E.has(R)||(E.add(R),R.then(A,A))})}}function ch(u,_){var E=_.deletions;if(E!==null)for(var R=0;R<E.length;R++){var A=E[R];try{var P=u,G=_,q=G;e:for(;q!==null;){switch(q.tag){case 5:ca=q.stateNode,lh=!1;break e;case 3:ca=q.stateNode.containerInfo,lh=!0;break e;case 4:ca=q.stateNode.containerInfo,lh=!0;break e}q=q.return}if(ca===null)throw Error(ze(160));iZ(P,G,A),ca=null,lh=!1;var ee=A.alternate;ee!==null&&(ee.return=null),A.return=null}catch(de){vo(A,_,de)}}if(_.subtreeFlags&12854)for(_=_.child;_!==null;)rZ(_,u),_=_.sibling}function rZ(u,_){var E=u.alternate,R=u.flags;switch(u.tag){case 0:case 11:case 14:case 15:if(ch(_,u),op(u),R&4){try{k1(3,u,u.return),TV(3,u)}catch(ge){vo(u,u.return,ge)}try{k1(5,u,u.return)}catch(ge){vo(u,u.return,ge)}}break;case 1:ch(_,u),op(u),R&512&&E!==null&&Ly(E,E.return);break;case 5:if(ch(_,u),op(u),R&512&&E!==null&&Ly(E,E.return),u.flags&32){var A=u.stateNode;try{V1(A,"")}catch(ge){vo(u,u.return,ge)}}if(R&4&&(A=u.stateNode,A!=null)){var P=u.memoizedProps,G=E!==null?E.memoizedProps:P,q=u.type,ee=u.updateQueue;if(u.updateQueue=null,ee!==null)try{q==="input"&&P.type==="radio"&&P.name!=null&&IJ(A,P),pq(q,G);var de=pq(q,P);for(G=0;G<ee.length;G+=2){var Ie=ee[G],he=ee[G+1];Ie==="style"?NJ(A,he):Ie==="dangerouslySetInnerHTML"?bJ(A,he):Ie==="children"?V1(A,he):tX(A,Ie,he,de)}switch(q){case"input":cq(A,P);break;case"textarea":AJ(A,P);break;case"select":var me=A._wrapperState.wasMultiple;A._wrapperState.wasMultiple=!!P.multiple;var je=P.value;je!=null?My(A,!!P.multiple,je,!1):me!==!!P.multiple&&(P.defaultValue!=null?My(A,!!P.multiple,P.defaultValue,!0):My(A,!!P.multiple,P.multiple?[]:"",!1))}A[z1]=P}catch(ge){vo(u,u.return,ge)}}break;case 6:if(ch(_,u),op(u),R&4){if(u.stateNode===null)throw Error(ze(162));A=u.stateNode,P=u.memoizedProps;try{A.nodeValue=P}catch(ge){vo(u,u.return,ge)}}break;case 3:if(ch(_,u),op(u),R&4&&E!==null&&E.memoizedState.isDehydrated)try{G1(_.containerInfo)}catch(ge){vo(u,u.return,ge)}break;case 4:ch(_,u),op(u);break;case 13:ch(_,u),op(u),A=u.child,A.flags&8192&&(P=A.memoizedState!==null,A.stateNode.isHidden=P,!P||A.alternate!==null&&A.alternate.memoizedState!==null||(kX=Fo())),R&4&&X7(u);break;case 22:if(Ie=E!==null&&E.memoizedState!==null,u.mode&1?(Ma=(de=Ma)||Ie,ch(_,u),Ma=de):ch(_,u),op(u),R&8192){if(de=u.memoizedState!==null,(u.stateNode.isHidden=de)&&!Ie&&u.mode&1)for(Nt=u,Ie=u.child;Ie!==null;){for(he=Nt=Ie;Nt!==null;){switch(me=Nt,je=me.child,me.tag){case 0:case 11:case 14:case 15:k1(4,me,me.return);break;case 1:Ly(me,me.return);var ve=me.stateNode;if(typeof ve.componentWillUnmount=="function"){R=me,E=me.return;try{_=R,ve.props=_.memoizedProps,ve.state=_.memoizedState,ve.componentWillUnmount()}catch(ge){vo(R,E,ge)}}break;case 5:Ly(me,me.return);break;case 22:if(me.memoizedState!==null){Q7(he);continue}}je!==null?(je.return=me,Nt=je):Q7(he)}Ie=Ie.sibling}e:for(Ie=null,he=u;;){if(he.tag===5){if(Ie===null){Ie=he;try{A=he.stateNode,de?(P=A.style,typeof P.setProperty=="function"?P.setProperty("display","none","important"):P.display="none"):(q=he.stateNode,ee=he.memoizedProps.style,G=ee!=null&&ee.hasOwnProperty("display")?ee.display:null,q.style.display=OJ("display",G))}catch(ge){vo(u,u.return,ge)}}}else if(he.tag===6){if(Ie===null)try{he.stateNode.nodeValue=de?"":he.memoizedProps}catch(ge){vo(u,u.return,ge)}}else if((he.tag!==22&&he.tag!==23||he.memoizedState===null||he===u)&&he.child!==null){he.child.return=he,he=he.child;continue}if(he===u)break e;for(;he.sibling===null;){if(he.return===null||he.return===u)break e;Ie===he&&(Ie=null),he=he.return}Ie===he&&(Ie=null),he.sibling.return=he.return,he=he.sibling}}break;case 19:ch(_,u),op(u),R&4&&X7(u);break;case 21:break;default:ch(_,u),op(u)}}function op(u){var _=u.flags;if(_&2){try{e:{for(var E=u.return;E!==null;){if(tZ(E)){var R=E;break e}E=E.return}throw Error(ze(160))}switch(R.tag){case 5:var A=R.stateNode;R.flags&32&&(V1(A,""),R.flags&=-33);var P=q7(u);Wq(u,P,A);break;case 3:case 4:var G=R.stateNode.containerInfo,q=q7(u);Gq(u,q,G);break;default:throw Error(ze(161))}}catch(ee){vo(u,u.return,ee)}u.flags&=-3}_&4096&&(u.flags&=-4097)}function Qee(u,_,E){Nt=u,nZ(u)}function nZ(u,_,E){for(var R=(u.mode&1)!==0;Nt!==null;){var A=Nt,P=A.child;if(A.tag===22&&R){var G=A.memoizedState!==null||yx;if(!G){var q=A.alternate,ee=q!==null&&q.memoizedState!==null||Ma;q=yx;var de=Ma;if(yx=G,(Ma=ee)&&!de)for(Nt=A;Nt!==null;)G=Nt,ee=G.child,G.tag===22&&G.memoizedState!==null?Z7(A):ee!==null?(ee.return=G,Nt=ee):Z7(A);for(;P!==null;)Nt=P,nZ(P),P=P.sibling;Nt=A,yx=q,Ma=de}J7(u)}else A.subtreeFlags&8772&&P!==null?(P.return=A,Nt=P):J7(u)}}function J7(u){for(;Nt!==null;){var _=Nt;if(_.flags&8772){var E=_.alternate;try{if(_.flags&8772)switch(_.tag){case 0:case 11:case 15:Ma||TV(5,_);break;case 1:var R=_.stateNode;if(_.flags&4&&!Ma)if(E===null)R.componentDidMount();else{var A=_.elementType===_.type?E.memoizedProps:dh(_.type,E.memoizedProps);R.componentDidUpdate(A,E.memoizedState,R.__reactInternalSnapshotBeforeUpdate)}var P=_.updateQueue;P!==null&&k7(_,P,R);break;case 3:var G=_.updateQueue;if(G!==null){if(E=null,_.child!==null)switch(_.child.tag){case 5:E=_.child.stateNode;break;case 1:E=_.child.stateNode}k7(_,G,E)}break;case 5:var q=_.stateNode;if(E===null&&_.flags&4){E=q;var ee=_.memoizedProps;switch(_.type){case"button":case"input":case"select":case"textarea":ee.autoFocus&&E.focus();break;case"img":ee.src&&(E.src=ee.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(_.memoizedState===null){var de=_.alternate;if(de!==null){var Ie=de.memoizedState;if(Ie!==null){var he=Ie.dehydrated;he!==null&&G1(he)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(ze(163))}Ma||_.flags&512&&jq(_)}catch(me){vo(_,_.return,me)}}if(_===u){Nt=null;break}if(E=_.sibling,E!==null){E.return=_.return,Nt=E;break}Nt=_.return}}function Q7(u){for(;Nt!==null;){var _=Nt;if(_===u){Nt=null;break}var E=_.sibling;if(E!==null){E.return=_.return,Nt=E;break}Nt=_.return}}function Z7(u){for(;Nt!==null;){var _=Nt;try{switch(_.tag){case 0:case 11:case 15:var E=_.return;try{TV(4,_)}catch(ee){vo(_,E,ee)}break;case 1:var R=_.stateNode;if(typeof R.componentDidMount=="function"){var A=_.return;try{R.componentDidMount()}catch(ee){vo(_,A,ee)}}var P=_.return;try{jq(_)}catch(ee){vo(_,P,ee)}break;case 5:var G=_.return;try{jq(_)}catch(ee){vo(_,G,ee)}}}catch(ee){vo(_,_.return,ee)}if(_===u){Nt=null;break}var q=_.sibling;if(q!==null){q.return=_.return,Nt=q;break}Nt=_.return}}var Zee=Math.ceil,sV=hf.ReactCurrentDispatcher,PX=hf.ReactCurrentOwner,Kl=hf.ReactCurrentBatchConfig,Nr=0,xs=null,ts=null,da=0,ul=0,ky=nE(0),Ts=0,$1=null,FR=0,RV=0,LX=0,M1=null,Zc=null,kX=0,zy=1/0,rf=null,aV=!1,Hq=null,Zm=null,Ix=!1,Ym=null,cV=0,U1=0,Kq=null,Ux=-1,xx=0;function Tc(){return Nr&6?Fo():Ux!==-1?Ux:Ux=Fo()}function $m(u){return u.mode&1?Nr&2&&da!==0?da&-da:Mee.transition!==null?(xx===0&&(xx=GJ()),xx):(u=on,u!==0||(u=window.event,u=u===void 0?16:XJ(u.type)),u):1}function ph(u,_,E,R){if(50<U1)throw U1=0,Kq=null,Error(ze(185));tM(u,E,R),(!(Nr&2)||u!==xs)&&(u===xs&&(!(Nr&2)&&(RV|=E),Ts===4&&Hm(u,da)),id(u,R),E===1&&Nr===0&&!(_.mode&1)&&(zy=Fo()+500,EV&&oE()))}function id(u,_){var E=u.callbackNode;M$(u,_);var R=Kx(u,u===xs?da:0);if(R===0)E!==null&&a7(E),u.callbackNode=null,u.callbackPriority=0;else if(_=R&-R,u.callbackPriority!==_){if(E!=null&&a7(E),_===1)u.tag===0?kee($7.bind(null,u)):_Q($7.bind(null,u)),Nee(function(){!(Nr&6)&&oE()}),E=null;else{switch(WJ(R)){case 1:E=sX;break;case 4:E=BJ;break;case 16:E=Hx;break;case 536870912:E=jJ;break;default:E=Hx}E=hZ(E,oZ.bind(null,u))}u.callbackPriority=_,u.callbackNode=E}}function oZ(u,_){if(Ux=-1,xx=0,Nr&6)throw Error(ze(327));var E=u.callbackNode;if(By()&&u.callbackNode!==E)return null;var R=Kx(u,u===xs?da:0);if(R===0)return null;if(R&30||R&u.expiredLanes||_)_=dV(u,R);else{_=R;var A=Nr;Nr|=2;var P=aZ();(xs!==u||da!==_)&&(rf=null,zy=Fo()+500,kR(u,_));do try{tte();break}catch(q){sZ(u,q)}while(!0);SX(),sV.current=P,Nr=A,ts!==null?_=0:(xs=null,da=0,_=Ts)}if(_!==0){if(_===2&&(A=gq(u),A!==0&&(R=A,_=Yq(u,A))),_===1)throw E=$1,kR(u,0),Hm(u,R),id(u,Fo()),E;if(_===6)Hm(u,R);else{if(A=u.current.alternate,!(R&30)&&!$ee(A)&&(_=dV(u,R),_===2&&(P=gq(u),P!==0&&(R=P,_=Yq(u,P))),_===1))throw E=$1,kR(u,0),Hm(u,R),id(u,Fo()),E;switch(u.finishedWork=A,u.finishedLanes=R,_){case 0:case 1:throw Error(ze(345));case 2:bR(u,Zc,rf);break;case 3:if(Hm(u,R),(R&130023424)===R&&(_=kX+500-Fo(),10<_)){if(Kx(u,0)!==0)break;if(A=u.suspendedLanes,(A&R)!==R){Tc(),u.pingedLanes|=u.suspendedLanes&A;break}u.timeoutHandle=Aq(bR.bind(null,u,Zc,rf),_);break}bR(u,Zc,rf);break;case 4:if(Hm(u,R),(R&4194240)===R)break;for(_=u.eventTimes,A=-1;0<R;){var G=31-hh(R);P=1<<G,G=_[G],G>A&&(A=G),R&=~P}if(R=A,R=Fo()-R,R=(120>R?120:480>R?480:1080>R?1080:1920>R?1920:3e3>R?3e3:4320>R?4320:1960*Zee(R/1960))-R,10<R){u.timeoutHandle=Aq(bR.bind(null,u,Zc,rf),R);break}bR(u,Zc,rf);break;case 5:bR(u,Zc,rf);break;default:throw Error(ze(329))}}}return id(u,Fo()),u.callbackNode===E?oZ.bind(null,u):null}function Yq(u,_){var E=M1;return u.current.memoizedState.isDehydrated&&(kR(u,_).flags|=256),u=dV(u,_),u!==2&&(_=Zc,Zc=E,_!==null&&zq(_)),u}function zq(u){Zc===null?Zc=u:Zc.push.apply(Zc,u)}function $ee(u){for(var _=u;;){if(_.flags&16384){var E=_.updateQueue;if(E!==null&&(E=E.stores,E!==null))for(var R=0;R<E.length;R++){var A=E[R],P=A.getSnapshot;A=A.value;try{if(!_h(P(),A))return!1}catch{return!1}}}if(E=_.child,_.subtreeFlags&16384&&E!==null)E.return=_,_=E;else{if(_===u)break;for(;_.sibling===null;){if(_.return===null||_.return===u)return!0;_=_.return}_.sibling.return=_.return,_=_.sibling}}return!0}function Hm(u,_){for(_&=~LX,_&=~RV,u.suspendedLanes|=_,u.pingedLanes&=~_,u=u.expirationTimes;0<_;){var E=31-hh(_),R=1<<E;u[E]=-1,_&=~R}}function $7(u){if(Nr&6)throw Error(ze(327));By();var _=Kx(u,0);if(!(_&1))return id(u,Fo()),null;var E=dV(u,_);if(u.tag!==0&&E===2){var R=gq(u);R!==0&&(_=R,E=Yq(u,R))}if(E===1)throw E=$1,kR(u,0),Hm(u,_),id(u,Fo()),E;if(E===6)throw Error(ze(345));return u.finishedWork=u.current.alternate,u.finishedLanes=_,bR(u,Zc,rf),id(u,Fo()),null}function MX(u,_){var E=Nr;Nr|=1;try{return u(_)}finally{Nr=E,Nr===0&&(zy=Fo()+500,EV&&oE())}}function BR(u){Ym!==null&&Ym.tag===0&&!(Nr&6)&&By();var _=Nr;Nr|=1;var E=Kl.transition,R=on;try{if(Kl.transition=null,on=1,u)return u()}finally{on=R,Kl.transition=E,Nr=_,!(Nr&6)&&oE()}}function UX(){ul=ky.current,Qn(ky)}function kR(u,_){u.finishedWork=null,u.finishedLanes=0;var E=u.timeoutHandle;if(E!==-1&&(u.timeoutHandle=-1,Oee(E)),ts!==null)for(E=ts.return;E!==null;){var R=E;switch(mX(R),R.tag){case 1:R=R.type.childContextTypes,R!=null&&Jx();break;case 3:Ky(),Qn(ed),Qn(xa),IX();break;case 5:yX(R);break;case 4:Ky();break;case 13:Qn(ho);break;case 19:Qn(ho);break;case 10:TX(R.type._context);break;case 22:case 23:UX()}E=E.return}if(xs=u,ts=u=eE(u.current,null),da=ul=_,Ts=0,$1=null,LX=RV=FR=0,Zc=M1=null,PR!==null){for(_=0;_<PR.length;_++)if(E=PR[_],R=E.interleaved,R!==null){E.interleaved=null;var A=R.next,P=E.pending;if(P!==null){var G=P.next;P.next=A,R.next=G}E.pending=R}PR=null}return u}function sZ(u,_){do{var E=ts;try{if(SX(),Lx.current=oV,nV){for(var R=po.memoizedState;R!==null;){var A=R.queue;A!==null&&(A.pending=null),R=R.next}nV=!1}if(VR=0,Us=Ss=po=null,L1=!1,J1=0,PX.current=null,E===null||E.return===null){Ts=1,$1=_,ts=null;break}e:{var P=u,G=E.return,q=E,ee=_;if(_=da,q.flags|=32768,ee!==null&&typeof ee=="object"&&typeof ee.then=="function"){var de=ee,Ie=q,he=Ie.tag;if(!(Ie.mode&1)&&(he===0||he===11||he===15)){var me=Ie.alternate;me?(Ie.updateQueue=me.updateQueue,Ie.memoizedState=me.memoizedState,Ie.lanes=me.lanes):(Ie.updateQueue=null,Ie.memoizedState=null)}var je=B7(G);if(je!==null){je.flags&=-257,j7(je,G,q,P,_),je.mode&1&&F7(P,de,_),_=je,ee=de;var ve=_.updateQueue;if(ve===null){var ge=new Set;ge.add(ee),_.updateQueue=ge}else ve.add(ee);break e}else{if(!(_&1)){F7(P,de,_),xX();break e}ee=Error(ze(426))}}else if(io&&q.mode&1){var Ge=B7(G);if(Ge!==null){!(Ge.flags&65536)&&(Ge.flags|=256),j7(Ge,G,q,P,_),EX(Yy(ee,q));break e}}P=ee=Yy(ee,q),Ts!==4&&(Ts=2),M1===null?M1=[P]:M1.push(P),P=G;do{switch(P.tag){case 3:P.flags|=65536,_&=-_,P.lanes|=_;var pe=WQ(P,ee,_);L7(P,pe);break e;case 1:q=ee;var ce=P.type,fe=P.stateNode;if(!(P.flags&128)&&(typeof ce.getDerivedStateFromError=="function"||fe!==null&&typeof fe.componentDidCatch=="function"&&(Zm===null||!Zm.has(fe)))){P.flags|=65536,_&=-_,P.lanes|=_;var We=HQ(P,q,_);L7(P,We);break e}}P=P.return}while(P!==null)}dZ(E)}catch(lt){_=lt,ts===E&&E!==null&&(ts=E=E.return);continue}break}while(!0)}function aZ(){var u=sV.current;return sV.current=oV,u===null?oV:u}function xX(){(Ts===0||Ts===3||Ts===2)&&(Ts=4),xs===null||!(FR&268435455)&&!(RV&268435455)||Hm(xs,da)}function dV(u,_){var E=Nr;Nr|=2;var R=aZ();(xs!==u||da!==_)&&(rf=null,kR(u,_));do try{ete();break}catch(A){sZ(u,A)}while(!0);if(SX(),Nr=E,sV.current=R,ts!==null)throw Error(ze(261));return xs=null,da=0,Ts}function ete(){for(;ts!==null;)cZ(ts)}function tte(){for(;ts!==null&&!A$();)cZ(ts)}function cZ(u){var _=uZ(u.alternate,u,ul);u.memoizedProps=u.pendingProps,_===null?dZ(u):ts=_,PX.current=null}function dZ(u){var _=u;do{var E=_.alternate;if(u=_.return,_.flags&32768){if(E=qee(E,_),E!==null){E.flags&=32767,ts=E;return}if(u!==null)u.flags|=32768,u.subtreeFlags=0,u.deletions=null;else{Ts=6,ts=null;return}}else if(E=zee(E,_,ul),E!==null){ts=E;return}if(_=_.sibling,_!==null){ts=_;return}ts=_=u}while(_!==null);Ts===0&&(Ts=5)}function bR(u,_,E){var R=on,A=Kl.transition;try{Kl.transition=null,on=1,ite(u,_,E,R)}finally{Kl.transition=A,on=R}return null}function ite(u,_,E,R){do By();while(Ym!==null);if(Nr&6)throw Error(ze(327));E=u.finishedWork;var A=u.finishedLanes;if(E===null)return null;if(u.finishedWork=null,u.finishedLanes=0,E===u.current)throw Error(ze(177));u.callbackNode=null,u.callbackPriority=0;var P=E.lanes|E.childLanes;if(U$(u,P),u===xs&&(ts=xs=null,da=0),!(E.subtreeFlags&2064)&&!(E.flags&2064)||Ix||(Ix=!0,hZ(Hx,function(){return By(),null})),P=(E.flags&15990)!==0,E.subtreeFlags&15990||P){P=Kl.transition,Kl.transition=null;var G=on;on=1;var q=Nr;Nr|=4,PX.current=null,Jee(u,E),rZ(E,u),vee(yq),Yx=!!Cq,yq=Cq=null,u.current=E,Qee(E),w$(),Nr=q,on=G,Kl.transition=P}else u.current=E;if(Ix&&(Ix=!1,Ym=u,cV=A),P=u.pendingLanes,P===0&&(Zm=null),N$(E.stateNode),id(u,Fo()),_!==null)for(R=u.onRecoverableError,E=0;E<_.length;E++)A=_[E],R(A.value,{componentStack:A.stack,digest:A.digest});if(aV)throw aV=!1,u=Hq,Hq=null,u;return cV&1&&u.tag!==0&&By(),P=u.pendingLanes,P&1?u===Kq?U1++:(U1=0,Kq=u):U1=0,oE(),null}function By(){if(Ym!==null){var u=WJ(cV),_=Kl.transition,E=on;try{if(Kl.transition=null,on=16>u?16:u,Ym===null)var R=!1;else{if(u=Ym,Ym=null,cV=0,Nr&6)throw Error(ze(331));var A=Nr;for(Nr|=4,Nt=u.current;Nt!==null;){var P=Nt,G=P.child;if(Nt.flags&16){var q=P.deletions;if(q!==null){for(var ee=0;ee<q.length;ee++){var de=q[ee];for(Nt=de;Nt!==null;){var Ie=Nt;switch(Ie.tag){case 0:case 11:case 15:k1(8,Ie,P)}var he=Ie.child;if(he!==null)he.return=Ie,Nt=he;else for(;Nt!==null;){Ie=Nt;var me=Ie.sibling,je=Ie.return;if(eZ(Ie),Ie===de){Nt=null;break}if(me!==null){me.return=je,Nt=me;break}Nt=je}}}var ve=P.alternate;if(ve!==null){var ge=ve.child;if(ge!==null){ve.child=null;do{var Ge=ge.sibling;ge.sibling=null,ge=Ge}while(ge!==null)}}Nt=P}}if(P.subtreeFlags&2064&&G!==null)G.return=P,Nt=G;else e:for(;Nt!==null;){if(P=Nt,P.flags&2048)switch(P.tag){case 0:case 11:case 15:k1(9,P,P.return)}var pe=P.sibling;if(pe!==null){pe.return=P.return,Nt=pe;break e}Nt=P.return}}var ce=u.current;for(Nt=ce;Nt!==null;){G=Nt;var fe=G.child;if(G.subtreeFlags&2064&&fe!==null)fe.return=G,Nt=fe;else e:for(G=ce;Nt!==null;){if(q=Nt,q.flags&2048)try{switch(q.tag){case 0:case 11:case 15:TV(9,q)}}catch(lt){vo(q,q.return,lt)}if(q===G){Nt=null;break e}var We=q.sibling;if(We!==null){We.return=q.return,Nt=We;break e}Nt=q.return}}if(Nr=A,oE(),cp&&typeof cp.onPostCommitFiberRoot=="function")try{cp.onPostCommitFiberRoot(hV,u)}catch{}R=!0}return R}finally{on=E,Kl.transition=_}}return!1}function eJ(u,_,E){_=Yy(E,_),_=WQ(u,_,1),u=Qm(u,_,1),_=Tc(),u!==null&&(tM(u,1,_),id(u,_))}function vo(u,_,E){if(u.tag===3)eJ(u,u,E);else for(;_!==null;){if(_.tag===3){eJ(_,u,E);break}else if(_.tag===1){var R=_.stateNode;if(typeof _.type.getDerivedStateFromError=="function"||typeof R.componentDidCatch=="function"&&(Zm===null||!Zm.has(R))){u=Yy(E,u),u=HQ(_,u,1),_=Qm(_,u,1),u=Tc(),_!==null&&(tM(_,1,u),id(_,u));break}}_=_.return}}function rte(u,_,E){var R=u.pingCache;R!==null&&R.delete(_),_=Tc(),u.pingedLanes|=u.suspendedLanes&E,xs===u&&(da&E)===E&&(Ts===4||Ts===3&&(da&130023424)===da&&500>Fo()-kX?kR(u,0):LX|=E),id(u,_)}function lZ(u,_){_===0&&(u.mode&1?(_=fx,fx<<=1,!(fx&130023424)&&(fx=4194304)):_=1);var E=Tc();u=lf(u,_),u!==null&&(tM(u,_,E),id(u,E))}function nte(u){var _=u.memoizedState,E=0;_!==null&&(E=_.retryLane),lZ(u,E)}function ote(u,_){var E=0;switch(u.tag){case 13:var R=u.stateNode,A=u.memoizedState;A!==null&&(E=A.retryLane);break;case 19:R=u.stateNode;break;default:throw Error(ze(314))}R!==null&&R.delete(_),lZ(u,E)}var uZ;uZ=function(u,_,E){if(u!==null)if(u.memoizedProps!==_.pendingProps||ed.current)$c=!0;else{if(!(u.lanes&E)&&!(_.flags&128))return $c=!1,Yee(u,_,E);$c=!!(u.flags&131072)}else $c=!1,io&&_.flags&1048576&&fQ(_,$x,_.index);switch(_.lanes=0,_.tag){case 2:var R=_.type;Mx(u,_),u=_.pendingProps;var A=Gy(_,xa.current);Fy(_,E),A=wX(null,_,R,u,A,E);var P=bX();return _.flags|=1,typeof A=="object"&&A!==null&&typeof A.render=="function"&&A.$$typeof===void 0?(_.tag=1,_.memoizedState=null,_.updateQueue=null,td(R)?(P=!0,Qx(_)):P=!1,_.memoizedState=A.state!==null&&A.state!==void 0?A.state:null,vX(_),A.updater=SV,_.stateNode=A,A._reactInternals=_,Lq(_,R,u,E),_=Uq(null,_,R,!0,P,E)):(_.tag=0,io&&P&&fX(_),Sc(null,_,A,E),_=_.child),_;case 16:R=_.elementType;e:{switch(Mx(u,_),u=_.pendingProps,A=R._init,R=A(R._payload),_.type=R,A=_.tag=ate(R),u=dh(R,u),A){case 0:_=Mq(null,_,R,u,E);break e;case 1:_=H7(null,_,R,u,E);break e;case 11:_=G7(null,_,R,u,E);break e;case 14:_=W7(null,_,R,dh(R.type,u),E);break e}throw Error(ze(306,R,""))}return _;case 0:return R=_.type,A=_.pendingProps,A=_.elementType===R?A:dh(R,A),Mq(u,_,R,A,E);case 1:return R=_.type,A=_.pendingProps,A=_.elementType===R?A:dh(R,A),H7(u,_,R,A,E);case 3:e:{if(qQ(_),u===null)throw Error(ze(387));R=_.pendingProps,P=_.memoizedState,A=P.element,RQ(u,_),iV(_,R,null,E);var G=_.memoizedState;if(R=G.element,P.isDehydrated)if(P={element:R,isDehydrated:!1,cache:G.cache,pendingSuspenseBoundaries:G.pendingSuspenseBoundaries,transitions:G.transitions},_.updateQueue.baseState=P,_.memoizedState=P,_.flags&256){A=Yy(Error(ze(423)),_),_=K7(u,_,R,E,A);break e}else if(R!==A){A=Yy(Error(ze(424)),_),_=K7(u,_,R,E,A);break e}else for(hl=Jm(_.stateNode.containerInfo.firstChild),pl=_,io=!0,uh=null,E=SQ(_,null,R,E),_.child=E;E;)E.flags=E.flags&-3|4096,E=E.sibling;else{if(Wy(),R===A){_=uf(u,_,E);break e}Sc(u,_,R,E)}_=_.child}return _;case 5:return vQ(_),u===null&&Nq(_),R=_.type,A=_.pendingProps,P=u!==null?u.memoizedProps:null,G=A.children,Iq(R,A)?G=null:P!==null&&Iq(R,P)&&(_.flags|=32),zQ(u,_),Sc(u,_,G,E),_.child;case 6:return u===null&&Nq(_),null;case 13:return XQ(u,_,E);case 4:return CX(_,_.stateNode.containerInfo),R=_.pendingProps,u===null?_.child=Hy(_,null,R,E):Sc(u,_,R,E),_.child;case 11:return R=_.type,A=_.pendingProps,A=_.elementType===R?A:dh(R,A),G7(u,_,R,A,E);case 7:return Sc(u,_,_.pendingProps,E),_.child;case 8:return Sc(u,_,_.pendingProps.children,E),_.child;case 12:return Sc(u,_,_.pendingProps.children,E),_.child;case 10:e:{if(R=_.type._context,A=_.pendingProps,P=_.memoizedProps,G=A.value,Dn(eV,R._currentValue),R._currentValue=G,P!==null)if(_h(P.value,G)){if(P.children===A.children&&!ed.current){_=uf(u,_,E);break e}}else for(P=_.child,P!==null&&(P.return=_);P!==null;){var q=P.dependencies;if(q!==null){G=P.child;for(var ee=q.firstContext;ee!==null;){if(ee.context===R){if(P.tag===1){ee=af(-1,E&-E),ee.tag=2;var de=P.updateQueue;if(de!==null){de=de.shared;var Ie=de.pending;Ie===null?ee.next=ee:(ee.next=Ie.next,Ie.next=ee),de.pending=ee}}P.lanes|=E,ee=P.alternate,ee!==null&&(ee.lanes|=E),Dq(P.return,E,_),q.lanes|=E;break}ee=ee.next}}else if(P.tag===10)G=P.type===_.type?null:P.child;else if(P.tag===18){if(G=P.return,G===null)throw Error(ze(341));G.lanes|=E,q=G.alternate,q!==null&&(q.lanes|=E),Dq(G,E,_),G=P.sibling}else G=P.child;if(G!==null)G.return=P;else for(G=P;G!==null;){if(G===_){G=null;break}if(P=G.sibling,P!==null){P.return=G.return,G=P;break}G=G.return}P=G}Sc(u,_,A.children,E),_=_.child}return _;case 9:return A=_.type,R=_.pendingProps.children,Fy(_,E),A=Yl(A),R=R(A),_.flags|=1,Sc(u,_,R,E),_.child;case 14:return R=_.type,A=dh(R,_.pendingProps),A=dh(R.type,A),W7(u,_,R,A,E);case 15:return KQ(u,_,_.type,_.pendingProps,E);case 17:return R=_.type,A=_.pendingProps,A=_.elementType===R?A:dh(R,A),Mx(u,_),_.tag=1,td(R)?(u=!0,Qx(_)):u=!1,Fy(_,E),GQ(_,R,A),Lq(_,R,A,E),Uq(null,_,R,!0,u,E);case 19:return JQ(u,_,E);case 22:return YQ(u,_,E)}throw Error(ze(156,_.tag))};function hZ(u,_){return FJ(u,_)}function ste(u,_,E,R){this.tag=u,this.key=E,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=_,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=R,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Hl(u,_,E,R){return new ste(u,_,E,R)}function VX(u){return u=u.prototype,!(!u||!u.isReactComponent)}function ate(u){if(typeof u=="function")return VX(u)?1:0;if(u!=null){if(u=u.$$typeof,u===rX)return 11;if(u===nX)return 14}return 2}function eE(u,_){var E=u.alternate;return E===null?(E=Hl(u.tag,_,u.key,u.mode),E.elementType=u.elementType,E.type=u.type,E.stateNode=u.stateNode,E.alternate=u,u.alternate=E):(E.pendingProps=_,E.type=u.type,E.flags=0,E.subtreeFlags=0,E.deletions=null),E.flags=u.flags&14680064,E.childLanes=u.childLanes,E.lanes=u.lanes,E.child=u.child,E.memoizedProps=u.memoizedProps,E.memoizedState=u.memoizedState,E.updateQueue=u.updateQueue,_=u.dependencies,E.dependencies=_===null?null:{lanes:_.lanes,firstContext:_.firstContext},E.sibling=u.sibling,E.index=u.index,E.ref=u.ref,E}function Vx(u,_,E,R,A,P){var G=2;if(R=u,typeof u=="function")VX(u)&&(G=1);else if(typeof u=="string")G=5;else e:switch(u){case yy:return MR(E.children,A,P,_);case iX:G=8,A|=8;break;case rq:return u=Hl(12,E,_,A|2),u.elementType=rq,u.lanes=P,u;case nq:return u=Hl(13,E,_,A),u.elementType=nq,u.lanes=P,u;case oq:return u=Hl(19,E,_,A),u.elementType=oq,u.lanes=P,u;case vJ:return vV(E,A,P,_);default:if(typeof u=="object"&&u!==null)switch(u.$$typeof){case TJ:G=10;break e;case RJ:G=9;break e;case rX:G=11;break e;case nX:G=14;break e;case jm:G=16,R=null;break e}throw Error(ze(130,u==null?u:typeof u,""))}return _=Hl(G,E,_,A),_.elementType=u,_.type=R,_.lanes=P,_}function MR(u,_,E,R){return u=Hl(7,u,R,_),u.lanes=E,u}function vV(u,_,E,R){return u=Hl(22,u,R,_),u.elementType=vJ,u.lanes=E,u.stateNode={isHidden:!1},u}function eq(u,_,E){return u=Hl(6,u,null,_),u.lanes=E,u}function tq(u,_,E){return _=Hl(4,u.children!==null?u.children:[],u.key,_),_.lanes=E,_.stateNode={containerInfo:u.containerInfo,pendingChildren:null,implementation:u.implementation},_}function cte(u,_,E,R,A){this.tag=_,this.containerInfo=u,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=M9(0),this.expirationTimes=M9(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=M9(0),this.identifierPrefix=R,this.onRecoverableError=A,this.mutableSourceEagerHydrationData=null}function FX(u,_,E,R,A,P,G,q,ee){return u=new cte(u,_,E,q,ee),_===1?(_=1,P===!0&&(_|=8)):_=0,P=Hl(3,null,null,_),u.current=P,P.stateNode=u,P.memoizedState={element:R,isDehydrated:E,cache:null,transitions:null,pendingSuspenseBoundaries:null},vX(P),u}function dte(u,_,E){var R=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:Cy,key:R==null?null:""+R,children:u,containerInfo:_,implementation:E}}function pZ(u){if(!u)return iE;u=u._reactInternals;e:{if(GR(u)!==u||u.tag!==1)throw Error(ze(170));var _=u;do{switch(_.tag){case 3:_=_.stateNode.context;break e;case 1:if(td(_.type)){_=_.stateNode.__reactInternalMemoizedMergedChildContext;break e}}_=_.return}while(_!==null);throw Error(ze(171))}if(u.tag===1){var E=u.type;if(td(E))return pQ(u,E,_)}return _}function _Z(u,_,E,R,A,P,G,q,ee){return u=FX(E,R,!0,u,A,P,G,q,ee),u.context=pZ(null),E=u.current,R=Tc(),A=$m(E),P=af(R,A),P.callback=_??null,Qm(E,P,A),u.current.lanes=A,tM(u,A,R),id(u,R),u}function CV(u,_,E,R){var A=_.current,P=Tc(),G=$m(A);return E=pZ(E),_.context===null?_.context=E:_.pendingContext=E,_=af(P,G),_.payload={element:u},R=R===void 0?null:R,R!==null&&(_.callback=R),u=Qm(A,_,G),u!==null&&(ph(u,A,G,P),Px(u,A,G)),G}function lV(u){if(u=u.current,!u.child)return null;switch(u.child.tag){case 5:return u.child.stateNode;default:return u.child.stateNode}}function tJ(u,_){if(u=u.memoizedState,u!==null&&u.dehydrated!==null){var E=u.retryLane;u.retryLane=E!==0&&E<_?E:_}}function BX(u,_){tJ(u,_),(u=u.alternate)&&tJ(u,_)}function lte(){return null}var fZ=typeof reportError=="function"?reportError:function(u){console.error(u)};function jX(u){this._internalRoot=u}yV.prototype.render=jX.prototype.render=function(u){var _=this._internalRoot;if(_===null)throw Error(ze(409));CV(u,_,null,null)};yV.prototype.unmount=jX.prototype.unmount=function(){var u=this._internalRoot;if(u!==null){this._internalRoot=null;var _=u.containerInfo;BR(function(){CV(null,u,null,null)}),_[df]=null}};function yV(u){this._internalRoot=u}yV.prototype.unstable_scheduleHydration=function(u){if(u){var _=YJ();u={blockedOn:null,target:u,priority:_};for(var E=0;E<Wm.length&&_!==0&&_<Wm[E].priority;E++);Wm.splice(E,0,u),E===0&&qJ(u)}};function GX(u){return!(!u||u.nodeType!==1&&u.nodeType!==9&&u.nodeType!==11)}function IV(u){return!(!u||u.nodeType!==1&&u.nodeType!==9&&u.nodeType!==11&&(u.nodeType!==8||u.nodeValue!==" react-mount-point-unstable "))}function iJ(){}function ute(u,_,E,R,A){if(A){if(typeof R=="function"){var P=R;R=function(){var de=lV(G);P.call(de)}}var G=_Z(_,R,u,0,null,!1,!1,"",iJ);return u._reactRootContainer=G,u[df]=G.current,K1(u.nodeType===8?u.parentNode:u),BR(),G}for(;A=u.lastChild;)u.removeChild(A);if(typeof R=="function"){var q=R;R=function(){var de=lV(ee);q.call(de)}}var ee=FX(u,0,!1,null,null,!1,!1,"",iJ);return u._reactRootContainer=ee,u[df]=ee.current,K1(u.nodeType===8?u.parentNode:u),BR(function(){CV(_,ee,E,R)}),ee}function AV(u,_,E,R,A){var P=E._reactRootContainer;if(P){var G=P;if(typeof A=="function"){var q=A;A=function(){var ee=lV(G);q.call(ee)}}CV(_,G,u,A)}else G=ute(E,_,u,A,R);return lV(G)}HJ=function(u){switch(u.tag){case 3:var _=u.stateNode;if(_.current.memoizedState.isDehydrated){var E=y1(_.pendingLanes);E!==0&&(aX(_,E|1),id(_,Fo()),!(Nr&6)&&(zy=Fo()+500,oE()))}break;case 13:BR(function(){var R=lf(u,1);if(R!==null){var A=Tc();ph(R,u,1,A)}}),BX(u,1)}};cX=function(u){if(u.tag===13){var _=lf(u,134217728);if(_!==null){var E=Tc();ph(_,u,134217728,E)}BX(u,134217728)}};KJ=function(u){if(u.tag===13){var _=$m(u),E=lf(u,_);if(E!==null){var R=Tc();ph(E,u,_,R)}BX(u,_)}};YJ=function(){return on};zJ=function(u,_){var E=on;try{return on=u,_()}finally{on=E}};fq=function(u,_,E){switch(_){case"input":if(cq(u,E),_=E.name,E.type==="radio"&&_!=null){for(E=u;E.parentNode;)E=E.parentNode;for(E=E.querySelectorAll("input[name="+JSON.stringify(""+_)+'][type="radio"]'),_=0;_<E.length;_++){var R=E[_];if(R!==u&&R.form===u.form){var A=mV(R);if(!A)throw Error(ze(90));yJ(R),cq(R,A)}}}break;case"textarea":AJ(u,E);break;case"select":_=E.value,_!=null&&My(u,!!E.multiple,_,!1)}};LJ=MX;kJ=BR;var hte={usingClientEntryPoint:!1,Events:[rM,by,mV,DJ,PJ,MX]},R1={findFiberByHostInstance:DR,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},pte={bundleType:R1.bundleType,version:R1.version,rendererPackageName:R1.rendererPackageName,rendererConfig:R1.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:hf.ReactCurrentDispatcher,findHostInstanceByFiber:function(u){return u=xJ(u),u===null?null:u.stateNode},findFiberByHostInstance:R1.findFiberByHostInstance||lte,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var Ax=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!Ax.isDisabled&&Ax.supportsFiber)try{hV=Ax.inject(pte),cp=Ax}catch{}}fl.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=hte;fl.createPortal=function(u,_){var E=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!GX(_))throw Error(ze(200));return dte(u,_,null,E)};fl.createRoot=function(u,_){if(!GX(u))throw Error(ze(299));var E=!1,R="",A=fZ;return _!=null&&(_.unstable_strictMode===!0&&(E=!0),_.identifierPrefix!==void 0&&(R=_.identifierPrefix),_.onRecoverableError!==void 0&&(A=_.onRecoverableError)),_=FX(u,1,!1,null,null,E,!1,R,A),u[df]=_.current,K1(u.nodeType===8?u.parentNode:u),new jX(_)};fl.findDOMNode=function(u){if(u==null)return null;if(u.nodeType===1)return u;var _=u._reactInternals;if(_===void 0)throw typeof u.render=="function"?Error(ze(188)):(u=Object.keys(u).join(","),Error(ze(268,u)));return u=xJ(_),u=u===null?null:u.stateNode,u};fl.flushSync=function(u){return BR(u)};fl.hydrate=function(u,_,E){if(!IV(_))throw Error(ze(200));return AV(null,u,_,!0,E)};fl.hydrateRoot=function(u,_,E){if(!GX(u))throw Error(ze(405));var R=E!=null&&E.hydratedSources||null,A=!1,P="",G=fZ;if(E!=null&&(E.unstable_strictMode===!0&&(A=!0),E.identifierPrefix!==void 0&&(P=E.identifierPrefix),E.onRecoverableError!==void 0&&(G=E.onRecoverableError)),_=_Z(_,null,u,1,E??null,A,!1,P,G),u[df]=_.current,K1(u),R)for(u=0;u<R.length;u++)E=R[u],A=E._getVersion,A=A(E._source),_.mutableSourceEagerHydrationData==null?_.mutableSourceEagerHydrationData=[E,A]:_.mutableSourceEagerHydrationData.push(E,A);return new yV(_)};fl.render=function(u,_,E){if(!IV(_))throw Error(ze(200));return AV(null,u,_,!1,E)};fl.unmountComponentAtNode=function(u){if(!IV(u))throw Error(ze(40));return u._reactRootContainer?(BR(function(){AV(null,null,u,!1,function(){u._reactRootContainer=null,u[df]=null})}),!0):!1};fl.unstable_batchedUpdates=MX;fl.unstable_renderSubtreeIntoContainer=function(u,_,E,R){if(!IV(E))throw Error(ze(200));if(u==null||u._reactInternals===void 0)throw Error(ze(38));return AV(u,_,E,!1,R)};fl.version="18.3.1-next-f1338f8080-20240426";function mZ(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(mZ)}catch(u){console.error(u)}}mZ(),mJ.exports=fl;var _te=mJ.exports,EZ,rJ=_te;EZ=rJ.createRoot,rJ.hydrateRoot;const fte=({children:u})=>Ct.jsxs("div",{className:"flex h-screen bg-gray-100 font-sans",children:[Ct.jsxs("div",{className:"w-64 bg-white border-r border-gray-200 p-4 hidden md:block",children:[Ct.jsx("h1",{className:"text-xl font-bold mb-6 text-indigo-600",children:"DocuChat"}),Ct.jsxs("ul",{children:[Ct.jsx("li",{className:"p-2 bg-indigo-50 text-indigo-700 rounded mb-2 cursor-pointer",children:"Files"}),Ct.jsx("li",{className:"p-2 hover:bg-gray-50 text-gray-600 rounded cursor-pointer",children:"Settings"})]})]}),Ct.jsxs("div",{className:"flex-1 flex flex-col h-full overflow-hidden relative",children:[Ct.jsx("header",{className:"h-16 bg-white border-b border-gray-200 flex items-center px-6 shadow-sm z-10",children:Ct.jsx("h2",{className:"font-semibold text-gray-700",children:"Document Viewer"})}),Ct.jsx("main",{className:"flex-1 overflow-auto bg-gray-50 relative p-4",children:u})]})]});var gZ={exports:{}};(function(u,_){(function(E,R){u.exports=R()})(dx,function(){function E(e,t){return t.forEach(function(i){i&&typeof i!="string"&&!Array.isArray(i)&&Object.keys(i).forEach(function(r){if(r!=="default"&&!(r in e)){var o=Object.getOwnPropertyDescriptor(i,r);Object.defineProperty(e,r,o.get?o:{enumerable:!0,get:function(){return i[r]}})}})}),Object.freeze(e)}var R=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof dx<"u"?dx:typeof self<"u"?self:{};function A(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var P=function(e){try{return!!e()}catch{return!0}},G=!P(function(){var e=(function(){}).bind();return typeof e!="function"||e.hasOwnProperty("prototype")}),q=G,ee=Function.prototype,de=ee.call,Ie=q&&ee.bind.bind(de,de),he=q?Ie:function(e){return function(){return de.apply(e,arguments)}},me=he({}.isPrototypeOf),je=function(e){return e&&e.Math===Math&&e},ve=je(typeof globalThis=="object"&&globalThis)||je(typeof window=="object"&&window)||je(typeof self=="object"&&self)||je(typeof R=="object"&&R)||je(typeof R=="object"&&R)||function(){return this}()||Function("return this")(),ge=G,Ge=Function.prototype,pe=Ge.apply,ce=Ge.call,fe=typeof Reflect=="object"&&Reflect.apply||(ge?ce.bind(pe):function(){return ce.apply(pe,arguments)}),We=he,lt=We({}.toString),jt=We("".slice),dt=function(e){return jt(lt(e),8,-1)},zt=dt,Pn=he,Ri=function(e){if(zt(e)==="Function")return Pn(e)},is=typeof document=="object"&&document.all,ci=is===void 0&&is!==void 0?function(e){return typeof e=="function"||e===is}:function(e){return typeof e=="function"},Va={},ur=!P(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!==7}),Zy=G,rd=Function.prototype.call,gi=Zy?rd.bind(rd):function(){return rd.apply(rd,arguments)},mt={},vi={}.propertyIsEnumerable,Ni=Object.getOwnPropertyDescriptor,Ln=Ni&&!vi.call({1:2},1);mt.f=Ln?function(e){var t=Ni(this,e);return!!t&&t.enumerable}:vi;var hr,yc,kn=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},aE=P,ql=dt,El=Object,NV=he("".split),lp=aE(function(){return!El("z").propertyIsEnumerable(0)})?function(e){return ql(e)==="String"?NV(e,""):El(e)}:El,up=function(e){return e==null},DV=up,PV=TypeError,Vs=function(e){if(DV(e))throw new PV("Can't call method on "+e);return e},LV=lp,kV=Vs,Fs=function(e){return LV(kV(e))},MV=ci,ir=function(e){return typeof e=="object"?e!==null:MV(e)},Qr={},cE=Qr,dE=ve,UV=ci,$y=function(e){return UV(e)?e:void 0},Sr=function(e,t){return arguments.length<2?$y(cE[e])||$y(dE[e]):cE[e]&&cE[e][t]||dE[e]&&dE[e][t]},eI=ve.navigator,tI=eI&&eI.userAgent,rs=tI?String(tI):"",iI=ve,lE=rs,rI=iI.process,nI=iI.Deno,oI=rI&&rI.versions||nI&&nI.version,sI=oI&&oI.v8;sI&&(yc=(hr=sI.split("."))[0]>0&&hr[0]<4?1:+(hr[0]+hr[1])),!yc&&lE&&(!(hr=lE.match(/Edge\/(\d+)/))||hr[1]>=74)&&(hr=lE.match(/Chrome\/(\d+)/))&&(yc=+hr[1]);var Fa=yc,aI=Fa,xV=P,VV=ve.String,nd=!!Object.getOwnPropertySymbols&&!xV(function(){var e=Symbol("symbol detection");return!VV(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&aI&&aI<41}),cI=nd&&!Symbol.sham&&typeof Symbol.iterator=="symbol",FV=Sr,BV=ci,jV=me,GV=Object,Xl=cI?function(e){return typeof e=="symbol"}:function(e){var t=FV("Symbol");return BV(t)&&jV(t.prototype,GV(e))},WV=String,od=function(e){try{return WV(e)}catch{return"Object"}},HV=ci,KV=od,YV=TypeError,Zr=function(e){if(HV(e))return e;throw new YV(KV(e)+" is not a function")},zV=Zr,qV=up,Jl=function(e,t){var i=e[t];return qV(i)?void 0:zV(i)},dI=gi,lI=ci,uI=ir,XV=TypeError,hI={exports:{}},pI=ve,JV=Object.defineProperty,QV=ve,ZV=function(e,t){try{JV(pI,e,{value:t,configurable:!0,writable:!0})}catch{pI[e]=t}return t},_I="__core-js_shared__",fI=hI.exports=QV[_I]||ZV(_I,{});(fI.versions||(fI.versions=[])).push({version:"3.46.0",mode:"pure",copyright:" 2014-2025 Denis Pushkarev (zloirock.ru), 2025 CoreJS Company (core-js.io)",license:"https://github.com/zloirock/core-js/blob/v3.46.0/LICENSE",source:"https://github.com/zloirock/core-js"});var uE=hI.exports,mI=uE,sd=function(e,t){return mI[e]||(mI[e]=t||{})},$V=Vs,eF=Object,Co=function(e){return eF($V(e))},tF=Co,iF=he({}.hasOwnProperty),Bi=Object.hasOwn||function(e,t){return iF(tF(e),t)},rF=he,nF=0,oF=Math.random(),sF=rF(1.1.toString),hE=function(e){return"Symbol("+(e===void 0?"":e)+")_"+sF(++nF+oF,36)},aF=sd,EI=Bi,cF=hE,dF=nd,lF=cI,ad=ve.Symbol,pE=aF("wks"),uF=lF?ad.for||ad:ad&&ad.withoutSetter||cF,qt=function(e){return EI(pE,e)||(pE[e]=dF&&EI(ad,e)?ad[e]:uF("Symbol."+e)),pE[e]},hF=gi,gI=ir,SI=Xl,pF=Jl,_F=function(e,t){var i,r;if(lI(i=e.toString)&&!uI(r=dI(i,e))||lI(i=e.valueOf)&&!uI(r=dI(i,e)))return r;throw new XV("Can't convert object to primitive value")},fF=TypeError,mF=qt("toPrimitive"),EF=function(e,t){if(!gI(e)||SI(e))return e;var i,r=pF(e,mF);if(r){if(i=hF(r,e,t),!gI(i)||SI(i))return i;throw new fF("Can't convert object to primitive value")}return _F(e)},gF=Xl,_E=function(e){var t=EF(e,"string");return gF(t)?t:t+""},TI=ir,fE=ve.document,SF=TI(fE)&&TI(fE.createElement),mE=function(e){return SF?fE.createElement(e):{}},TF=mE,RI=!ur&&!P(function(){return Object.defineProperty(TF("div"),"a",{get:function(){return 7}}).a!==7}),RF=ur,vF=gi,CF=mt,yF=kn,IF=Fs,AF=_E,wF=Bi,bF=RI,vI=Object.getOwnPropertyDescriptor;Va.f=RF?vI:function(e,t){if(e=IF(e),t=AF(t),bF)try{return vI(e,t)}catch{}if(wF(e,t))return yF(!vF(CF.f,e,t),e[t])};var OF=P,NF=ci,DF=/#|\.prototype\./,Ql=function(e,t){var i=LF[PF(e)];return i===MF||i!==kF&&(NF(t)?OF(t):!!t)},PF=Ql.normalize=function(e){return String(e).replace(DF,".").toLowerCase()},LF=Ql.data={},kF=Ql.NATIVE="N",MF=Ql.POLYFILL="P",CI=Ql,UF=Zr,xF=G,VF=Ri(Ri.bind),Bs=function(e,t){return UF(e),t===void 0?e:xF?VF(e,t):function(){return e.apply(t,arguments)}},Mn={},yI=ur&&P(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!==42}),FF=ir,BF=String,jF=TypeError,Ur=function(e){if(FF(e))return e;throw new jF(BF(e)+" is not an object")},GF=ur,WF=RI,HF=yI,hp=Ur,II=_E,KF=TypeError,EE=Object.defineProperty,YF=Object.getOwnPropertyDescriptor,gE="enumerable",SE="configurable",TE="writable";Mn.f=GF?HF?function(e,t,i){if(hp(e),t=II(t),hp(i),typeof e=="function"&&t==="prototype"&&"value"in i&&TE in i&&!i[TE]){var r=YF(e,t);r&&r[TE]&&(e[t]=i.value,i={configurable:SE in i?i[SE]:r[SE],enumerable:gE in i?i[gE]:r[gE],writable:!1})}return EE(e,t,i)}:EE:function(e,t,i){if(hp(e),t=II(t),hp(i),WF)try{return EE(e,t,i)}catch{}if("get"in i||"set"in i)throw new KF("Accessors not supported");return"value"in i&&(e[t]=i.value),e};var zF=Mn,qF=kn,Ba=ur?function(e,t,i){return zF.f(e,t,qF(1,i))}:function(e,t,i){return e[t]=i,e},Zl=ve,XF=fe,JF=Ri,QF=ci,ZF=Va.f,$F=CI,cd=Qr,eB=Bs,dd=Ba,AI=Bi,tB=function(e){var t=function(i,r,o){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(i);case 2:return new e(i,r)}return new e(i,r,o)}return XF(e,this,arguments)};return t.prototype=e.prototype,t},qe=function(e,t){var i,r,o,s,a,c,d,l,h,p=e.target,f=e.global,m=e.stat,g=e.proto,S=f?Zl:m?Zl[p]:Zl[p]&&Zl[p].prototype,T=f?cd:cd[p]||dd(cd,p,{})[p],C=T.prototype;for(s in t)r=!(i=$F(f?s:p+(m?".":"#")+s,e.forced))&&S&&AI(S,s),c=T[s],r&&(d=e.dontCallGetSet?(h=ZF(S,s))&&h.value:S[s]),a=r&&d?d:t[s],(i||g||typeof c!=typeof a)&&(l=e.bind&&r?eB(a,Zl):e.wrap&&r?tB(a):g&&QF(a)?JF(a):a,(e.sham||a&&a.sham||c&&c.sham)&&dd(l,"sham",!0),dd(T,s,l),g&&(AI(cd,o=p+"Prototype")||dd(cd,o,{}),dd(cd[o],s,a),e.real&&C&&(i||!C[s])&&dd(C,s,a)))},iB=Math.ceil,rB=Math.floor,nB=Math.trunc||function(e){var t=+e;return(t>0?rB:iB)(t)},oB=nB,RE=function(e){var t=+e;return t!=t||t===0?0:oB(t)},sB=RE,aB=Math.max,cB=Math.min,vE=function(e,t){var i=sB(e);return i<0?aB(i+t,0):cB(i,t)},dB=RE,lB=Math.min,wI=function(e){var t=dB(e);return t>0?lB(t,9007199254740991):0},uB=wI,js=function(e){return uB(e.length)},hB=Fs,pB=vE,_B=js,bI=function(e){return function(t,i,r){var o=hB(t),s=_B(o);if(s===0)return!e&&-1;var a,c=pB(r,s);if(e&&i!=i){for(;s>c;)if((a=o[c++])!=a)return!0}else for(;s>c;c++)if((e||c in o)&&o[c]===i)return e||c||0;return!e&&-1}},CE={includes:bI(!0),indexOf:bI(!1)},fB=CE.includes;qe({target:"Array",proto:!0,forced:P(function(){return!Array(1).includes()})},{includes:function(e){return fB(this,e,arguments.length>1?arguments[1]:void 0)}});var mB=ve,EB=Qr,ln=function(e,t){var i=EB[e+"Prototype"],r=i&&i[t];if(r)return r;var o=mB[e],s=o&&o.prototype;return s&&s[t]},gB=ln("Array","includes"),SB=ir,TB=dt,RB=qt("match"),yE=function(e){var t;return SB(e)&&((t=e[RB])!==void 0?!!t:TB(e)==="RegExp")},vB=yE,CB=TypeError,OI={};OI[qt("toStringTag")]="z";var IE=String(OI)==="[object z]",yB=IE,IB=ci,pp=dt,AB=qt("toStringTag"),wB=Object,bB=pp(function(){return arguments}())==="Arguments",Gs=yB?pp:function(e){var t,i,r;return e===void 0?"Undefined":e===null?"Null":typeof(i=function(o,s){try{return o[s]}catch{}}(t=wB(e),AB))=="string"?i:bB?pp(t):(r=pp(t))==="Object"&&IB(t.callee)?"Arguments":r},OB=Gs,NB=String,xr=function(e){if(OB(e)==="Symbol")throw new TypeError("Cannot convert a Symbol value to a string");return NB(e)},DB=qt("match"),PB=qe,LB=function(e){if(vB(e))throw new CB("The method doesn't accept regular expressions");return e},kB=Vs,NI=xr,MB=function(e){var t=/./;try{"/./"[e](t)}catch{try{return t[DB]=!1,"/./"[e](t)}catch{}}return!1},UB=he("".indexOf);PB({target:"String",proto:!0,forced:!MB("includes")},{includes:function(e){return!!~UB(NI(kB(this)),NI(LB(e)),arguments.length>1?arguments[1]:void 0)}});var xB=ln("String","includes"),DI=me,VB=gB,FB=xB,AE=Array.prototype,wE=String.prototype,BB=function(e){var t=e.includes;return e===AE||DI(AE,e)&&t===AE.includes?VB:typeof e=="string"||e===wE||DI(wE,e)&&t===wE.includes?FB:t},z=A(BB),jB=Zr,GB=Co,WB=lp,HB=js,PI=TypeError,LI="Reduce of empty array with no initial value",KB=function(e){return function(t,i,r,o){var s=GB(t),a=WB(s),c=HB(s);if(jB(i),c===0&&r<2)throw new PI(LI);var d=e?c-1:0,l=e?-1:1;if(r<2)for(;;){if(d in a){o=a[d],d+=l;break}if(d+=l,e?d<0:c<=d)throw new PI(LI)}for(;e?d>=0:c>d;d+=l)d in a&&(o=i(o,a[d],d,s));return o}},YB={left:KB(!1)},zB=P,_p=function(e,t){var i=[][e];return!!i&&zB(function(){i.call(null,t||function(){return 1},1)})},$l=ve,qB=rs,XB=dt,fp=function(e){return qB.slice(0,e.length)===e},bE=fp("Bun/")?"BUN":fp("Cloudflare-Workers")?"CLOUDFLARE":fp("Deno/")?"DENO":fp("Node.js/")?"NODE":$l.Bun&&typeof Bun.version=="string"?"BUN":$l.Deno&&typeof Deno.version=="object"?"DENO":XB($l.process)==="process"?"NODE":$l.window&&$l.document?"BROWSER":"REST",mp=bE==="NODE",JB=YB.left;qe({target:"Array",proto:!0,forced:!mp&&Fa>79&&Fa<83||!_p("reduce")},{reduce:function(e){var t=arguments.length;return JB(this,e,t,t>1?arguments[1]:void 0)}});var QB=ln("Array","reduce"),ZB=me,$B=QB,OE=Array.prototype,ej=function(e){var t=e.reduce;return e===OE||ZB(OE,e)&&t===OE.reduce?$B:t},kI=ej,un=A(kI),tj=dt,eu=Array.isArray||function(e){return tj(e)==="Array"},ij=qe,rj=eu,nj=he([].reverse),MI=[1,2];ij({target:"Array",proto:!0,forced:String(MI)===String(MI.reverse())},{reverse:function(){return rj(this)&&(this.length=this.length),nj(this)}});var oj=ln("Array","reverse"),sj=me,aj=oj,NE=Array.prototype,cj=function(e){var t=e.reverse;return e===NE||sj(NE,e)&&t===NE.reverse?aj:t},UI=cj,xI=A(UI),dj=hE,VI=sd("keys"),Ep=function(e){return VI[e]||(VI[e]=dj(e))},lj=!P(function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype}),uj=Bi,hj=ci,pj=Co,_j=lj,FI=Ep("IE_PROTO"),DE=Object,fj=DE.prototype,PE=_j?DE.getPrototypeOf:function(e){var t=pj(e);if(uj(t,FI))return t[FI];var i=t.constructor;return hj(i)&&t instanceof i?i.prototype:t instanceof DE?fj:null},mj=he,Ej=Zr,gj=ir,Sj=function(e){return gj(e)||e===null},Tj=String,Rj=TypeError,vj=function(e,t,i){try{return mj(Ej(Object.getOwnPropertyDescriptor(e,t)[i]))}catch{}},Cj=ir,yj=Vs,Ij=function(e){if(Sj(e))return e;throw new Rj("Can't set "+Tj(e)+" as a prototype")},Aj=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,i={};try{(e=vj(Object.prototype,"__proto__","set"))(i,[]),t=i instanceof Array}catch{}return function(r,o){return yj(r),Ij(o),Cj(r)&&(t?e(r,o):r.__proto__=o),r}}():void 0),gp={},Sp={},LE=Bi,wj=Fs,bj=CE.indexOf,Oj=Sp,BI=he([].push),jI=function(e,t){var i,r=wj(e),o=0,s=[];for(i in r)!LE(Oj,i)&&LE(r,i)&&BI(s,i);for(;t.length>o;)LE(r,i=t[o++])&&(~bj(s,i)||BI(s,i));return s},kE=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Nj=jI,Dj=kE.concat("length","prototype");gp.f=Object.getOwnPropertyNames||function(e){return Nj(e,Dj)};var tu={};tu.f=Object.getOwnPropertySymbols;var Pj=Sr,Lj=gp,kj=tu,Mj=Ur,Uj=he([].concat),xj=Pj("Reflect","ownKeys")||function(e){var t=Lj.f(Mj(e)),i=kj.f;return i?Uj(t,i(e)):t},GI=Bi,Vj=xj,Fj=Va,Bj=Mn,ME={},jj=jI,Gj=kE,Tp=Object.keys||function(e){return jj(e,Gj)},Wj=ur,Hj=yI,Kj=Mn,Yj=Ur,zj=Fs,qj=Tp;ME.f=Wj&&!Hj?Object.defineProperties:function(e,t){Yj(e);for(var i,r=zj(t),o=qj(t),s=o.length,a=0;s>a;)Kj.f(e,i=o[a++],r[i]);return e};var Rp,WI=Sr("document","documentElement"),Xj=Ur,Jj=ME,HI=kE,Qj=Sp,Zj=WI,$j=mE,UE="prototype",xE="script",KI=Ep("IE_PROTO"),VE=function(){},YI=function(e){return"<"+xE+">"+e+"</"+xE+">"},zI=function(e){e.write(YI("")),e.close();var t=e.parentWindow.Object;return e=null,t},vp=function(){try{Rp=new ActiveXObject("htmlfile")}catch{}var e,t,i;vp=typeof document<"u"?document.domain&&Rp?zI(Rp):(t=$j("iframe"),i="java"+xE+":",t.style.display="none",Zj.appendChild(t),t.src=String(i),(e=t.contentWindow.document).open(),e.write(YI("document.F=Object")),e.close(),e.F):zI(Rp);for(var r=HI.length;r--;)delete vp[UE][HI[r]];return vp()};Qj[KI]=!0;var iu=Object.create||function(e,t){var i;return e!==null?(VE[UE]=Xj(e),i=new VE,VE[UE]=null,i[KI]=e):i=vp(),t===void 0?i:Jj.f(i,t)},e3=ir,t3=Ba,qI=Error,i3=he("".replace),r3=String(new qI("zxcasd").stack),XI=/\n\s*at [^:]*:[^\n]*/,n3=XI.test(r3),o3=kn,s3=!P(function(){var e=new Error("a");return!("stack"in e)||(Object.defineProperty(e,"stack",o3(1,7)),e.stack!==7)}),a3=Ba,c3=function(e,t){if(n3&&typeof e=="string"&&!qI.prepareStackTrace)for(;t--;)e=i3(e,XI,"");return e},d3=s3,JI=Error.captureStackTrace,ld={},l3=ld,u3=qt("iterator"),h3=Array.prototype,QI=function(e){return e!==void 0&&(l3.Array===e||h3[u3]===e)},p3=Gs,ZI=Jl,_3=up,f3=ld,m3=qt("iterator"),Cp=function(e){if(!_3(e))return ZI(e,m3)||ZI(e,"@@iterator")||f3[p3(e)]},E3=gi,g3=Zr,S3=Ur,T3=od,R3=Cp,v3=TypeError,FE=function(e,t){var i=arguments.length<2?R3(e):t;if(g3(i))return S3(E3(i,e));throw new v3(T3(e)+" is not iterable")},C3=gi,$I=Ur,y3=Jl,eA=function(e,t,i){var r,o;$I(e);try{if(!(r=y3(e,"return"))){if(t==="throw")throw i;return i}r=C3(r,e)}catch(s){o=!0,r=s}if(t==="throw")throw i;if(o)throw r;return $I(r),i},I3=Bs,A3=gi,w3=Ur,b3=od,O3=QI,N3=js,tA=me,D3=FE,P3=Cp,iA=eA,L3=TypeError,yp=function(e,t){this.stopped=e,this.result=t},rA=yp.prototype,ru=function(e,t,i){var r,o,s,a,c,d,l,h=i&&i.that,p=!(!i||!i.AS_ENTRIES),f=!(!i||!i.IS_RECORD),m=!(!i||!i.IS_ITERATOR),g=!(!i||!i.INTERRUPTED),S=I3(t,h),T=function(b){return r&&iA(r,"normal"),new yp(!0,b)},C=function(b){return p?(w3(b),g?S(b[0],b[1],T):S(b[0],b[1])):g?S(b,T):S(b)};if(f)r=e.iterator;else if(m)r=e;else{if(!(o=P3(e)))throw new L3(b3(e)+" is not iterable");if(O3(o)){for(s=0,a=N3(e);a>s;s++)if((c=C(e[s]))&&tA(rA,c))return c;return new yp(!1)}r=D3(e,o)}for(d=f?e.next:r.next;!(l=A3(d,r)).done;){try{c=C(l.value)}catch(b){iA(r,"throw",b)}if(typeof c=="object"&&c&&tA(rA,c))return c}return new yp(!1)},k3=xr,M3=qe,U3=me,x3=PE,Ip=Aj,V3=function(e,t,i){for(var r=Vj(t),o=Bj.f,s=Fj.f,a=0;a<r.length;a++){var c=r[a];GI(e,c)||i&&GI(i,c)||o(e,c,s(t,c))}},nA=iu,BE=Ba,jE=kn,F3=function(e,t){e3(t)&&"cause"in t&&t3(e,"cause",t.cause)},B3=function(e,t,i,r){d3&&(JI?JI(e,t):a3(e,"stack",c3(i,r)))},j3=ru,G3=function(e,t){return e===void 0?arguments.length<2?"":t:k3(e)},W3=qt("toStringTag"),Ap=Error,H3=[].push,ud=function(e,t){var i,r=U3(GE,this);Ip?i=Ip(new Ap,r?x3(this):GE):(i=r?this:nA(GE),BE(i,W3,"Error")),t!==void 0&&BE(i,"message",G3(t)),B3(i,ud,i.stack,1),arguments.length>2&&F3(i,arguments[2]);var o=[];return j3(e,H3,{that:o}),BE(i,"errors",o),i};Ip?Ip(ud,Ap):V3(ud,Ap,{name:!0});var GE=ud.prototype=nA(Ap.prototype,{constructor:jE(1,ud),message:jE(1,""),name:jE(1,"AggregateError")});M3({global:!0},{AggregateError:ud});var wp,nu,bp,K3=ci,oA=ve.WeakMap,Y3=K3(oA)&&/native code/.test(String(oA)),sA=ve,z3=ir,q3=Ba,WE=Bi,HE=uE,X3=Ep,J3=Sp,aA="Object already initialized",KE=sA.TypeError,Q3=sA.WeakMap;if(Y3||HE.state){var yo=HE.state||(HE.state=new Q3);yo.get=yo.get,yo.has=yo.has,yo.set=yo.set,wp=function(e,t){if(yo.has(e))throw new KE(aA);return t.facade=e,yo.set(e,t),t},nu=function(e){return yo.get(e)||{}},bp=function(e){return yo.has(e)}}else{var hd=X3("state");J3[hd]=!0,wp=function(e,t){if(WE(e,hd))throw new KE(aA);return t.facade=e,q3(e,hd,t),t},nu=function(e){return WE(e,hd)?e[hd]:{}},bp=function(e){return WE(e,hd)}}var ja,cA,dA,Ga={set:wp,get:nu,has:bp,enforce:function(e){return bp(e)?nu(e):wp(e,{})},getterFor:function(e){return function(t){var i;if(!z3(t)||(i=nu(t)).type!==e)throw new KE("Incompatible receiver, "+e+" required");return i}}},YE=ur,Z3=Bi,lA=Function.prototype,$3=YE&&Object.getOwnPropertyDescriptor,uA=Z3(lA,"name"),hA={PROPER:uA&&(function(){}).name==="something",CONFIGURABLE:uA&&(!YE||YE&&$3(lA,"name").configurable)},eG=Ba,Ws=function(e,t,i,r){return r&&r.enumerable?e[t]=i:eG(e,t,i),e},tG=P,iG=ci,rG=ir,nG=iu,pA=PE,oG=Ws,zE=qt("iterator"),_A=!1;[].keys&&("next"in(dA=[].keys())?(cA=pA(pA(dA)))!==Object.prototype&&(ja=cA):_A=!0);var sG=!rG(ja)||tG(function(){var e={};return ja[zE].call(e)!==e});iG((ja=sG?{}:nG(ja))[zE])||oG(ja,zE,function(){return this});var fA={IteratorPrototype:ja,BUGGY_SAFARI_ITERATORS:_A},aG=Gs,cG=IE?{}.toString:function(){return"[object "+aG(this)+"]"},dG=IE,lG=Mn.f,uG=Ba,hG=Bi,pG=cG,mA=qt("toStringTag"),ns=function(e,t,i,r){var o=i?e:e&&e.prototype;o&&(hG(o,mA)||lG(o,mA,{configurable:!0,value:t}),r&&!dG&&uG(o,"toString",pG))},_G=fA.IteratorPrototype,fG=iu,mG=kn,EG=ns,gG=ld,SG=function(){return this},qE=function(e,t,i,r){var o=t+" Iterator";return e.prototype=fG(_G,{next:mG(+!r,i)}),EG(e,o,!1,!0),gG[o]=SG,e},TG=qe,RG=gi,vG=hA,CG=qE,yG=PE,IG=ns,EA=Ws,gA=ld,AG=fA,wG=vG.PROPER,Op=AG.BUGGY_SAFARI_ITERATORS,XE=qt("iterator"),SA="keys",Np="values",TA="entries",bG=function(){return this},RA=function(e,t,i,r,o,s,a){CG(i,t,r);var c,d,l,h=function(C){if(C===o&&S)return S;if(!Op&&C&&C in m)return m[C];switch(C){case SA:case Np:case TA:return function(){return new i(this,C)}}return function(){return new i(this)}},p=t+" Iterator",f=!1,m=e.prototype,g=m[XE]||m["@@iterator"]||o&&m[o],S=!Op&&g||h(o),T=t==="Array"&&m.entries||g;if(T&&(c=yG(T.call(new e)))!==Object.prototype&&c.next&&(IG(c,p,!0,!0),gA[p]=bG),wG&&o===Np&&g&&g.name!==Np&&(f=!0,S=function(){return RG(g,this)}),o)if(d={values:h(Np),keys:s?S:h(SA),entries:h(TA)},a)for(l in d)(Op||f||!(l in m))&&EA(m,l,d[l]);else TG({target:t,proto:!0,forced:Op||f},d);return a&&m[XE]!==S&&EA(m,XE,S,{}),gA[t]=S,d},Dp=function(e,t){return{value:e,done:t}},OG=Fs,vA=ld,CA=Ga;Mn.f;var NG=RA,Pp=Dp,yA="Array Iterator",DG=CA.set,PG=CA.getterFor(yA);NG(Array,"Array",function(e,t){DG(this,{type:yA,target:OG(e),index:0,kind:t})},function(){var e=PG(this),t=e.target,i=e.index++;if(!t||i>=t.length)return e.target=null,Pp(void 0,!0);switch(e.kind){case"keys":return Pp(i,!1);case"values":return Pp(t[i],!1)}return Pp([i,t[i]],!1)},"values"),vA.Arguments=vA.Array;var LG=Mn,Lp=function(e,t,i){return LG.f(e,t,i)},kG=Sr,MG=Lp,UG=ur,IA=qt("species"),xG=me,VG=TypeError,JE=function(e,t){if(xG(t,e))return e;throw new VG("Incorrect invocation")},FG=ci,QE=uE,BG=he(Function.toString);FG(QE.inspectSource)||(QE.inspectSource=function(e){return BG(e)});var AA=QE.inspectSource,jG=he,GG=P,wA=ci,WG=Gs,HG=AA,bA=function(){},OA=Sr("Reflect","construct"),ZE=/^\s*(?:class|function)\b/,KG=jG(ZE.exec),YG=!ZE.test(bA),ou=function(e){if(!wA(e))return!1;try{return OA(bA,[],e),!0}catch{return!1}},NA=function(e){if(!wA(e))return!1;switch(WG(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return YG||!!KG(ZE,HG(e))}catch{return!0}};NA.sham=!0;var su,pd,DA,$E,kp=!OA||GG(function(){var e;return ou(ou.call)||!ou(Object)||!ou(function(){e=!0})||e})?NA:ou,zG=kp,qG=od,XG=TypeError,PA=Ur,JG=function(e){if(zG(e))return e;throw new XG(qG(e)+" is not a constructor")},QG=up,ZG=qt("species"),eg=function(e,t){var i,r=PA(e).constructor;return r===void 0||QG(i=PA(r)[ZG])?t:JG(i)},Hs=he([].slice),$G=TypeError,Wa=function(e,t){if(e<t)throw new $G("Not enough arguments");return e},LA=/(?:ipad|iphone|ipod).*applewebkit/i.test(rs),hn=ve,e4=fe,t4=Bs,kA=ci,i4=Bi,MA=P,UA=WI,r4=Hs,xA=mE,n4=Wa,o4=LA,s4=mp,tg=hn.setImmediate,ig=hn.clearImmediate,a4=hn.process,rg=hn.Dispatch,c4=hn.Function,VA=hn.MessageChannel,d4=hn.String,ng=0,au={},FA="onreadystatechange";MA(function(){su=hn.location});var og=function(e){if(i4(au,e)){var t=au[e];delete au[e],t()}},sg=function(e){return function(){og(e)}},BA=function(e){og(e.data)},jA=function(e){hn.postMessage(d4(e),su.protocol+"//"+su.host)};tg&&ig||(tg=function(e){n4(arguments.length,1);var t=kA(e)?e:c4(e),i=r4(arguments,1);return au[++ng]=function(){e4(t,void 0,i)},pd(ng),ng},ig=function(e){delete au[e]},s4?pd=function(e){a4.nextTick(sg(e))}:rg&&rg.now?pd=function(e){rg.now(sg(e))}:VA&&!o4?($E=(DA=new VA).port2,DA.port1.onmessage=BA,pd=t4($E.postMessage,$E)):hn.addEventListener&&kA(hn.postMessage)&&!hn.importScripts&&su&&su.protocol!=="file:"&&!MA(jA)?(pd=jA,hn.addEventListener("message",BA,!1)):pd=FA in xA("script")?function(e){UA.appendChild(xA("script"))[FA]=function(){UA.removeChild(this),og(e)}}:function(e){setTimeout(sg(e),0)});var Mp={set:tg,clear:ig},GA=ve,l4=ur,u4=Object.getOwnPropertyDescriptor,WA=function(e){if(!l4)return GA[e];var t=u4(GA,e);return t&&t.value},HA=function(){this.head=null,this.tail=null};HA.prototype={add:function(e){var t={item:e,next:null},i=this.tail;i?i.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return(this.head=e.next)===null&&(this.tail=null),e.item}};var _d,ag,cg,dg,KA,YA=HA,h4=/ipad|iphone|ipod/i.test(rs)&&typeof Pebble<"u",p4=/web0s(?!.*chrome)/i.test(rs),fd=ve,_4=WA,zA=Bs,lg=Mp.set,f4=YA,m4=LA,E4=h4,g4=p4,ug=mp,qA=fd.MutationObserver||fd.WebKitMutationObserver,XA=fd.document,JA=fd.process,Up=fd.Promise,hg=_4("queueMicrotask");if(!hg){var xp=new f4,Vp=function(){var e,t;for(ug&&(e=JA.domain)&&e.exit();t=xp.get();)try{t()}catch(i){throw xp.head&&_d(),i}e&&e.enter()};m4||ug||g4||!qA||!XA?!E4&&Up&&Up.resolve?((dg=Up.resolve(void 0)).constructor=Up,KA=zA(dg.then,dg),_d=function(){KA(Vp)}):ug?_d=function(){JA.nextTick(Vp)}:(lg=zA(lg,fd),_d=function(){lg(Vp)}):(ag=!0,cg=XA.createTextNode(""),new qA(Vp).observe(cg,{characterData:!0}),_d=function(){cg.data=ag=!ag}),hg=function(e){xp.head||_d(),xp.add(e)}}var QA=hg,md=function(e){try{return{error:!1,value:e()}}catch(t){return{error:!0,value:t}}},Ha=ve.Promise,S4=ve,cu=Ha,T4=ci,R4=CI,v4=AA,C4=qt,ZA=bE,pg=Fa,$A=cu&&cu.prototype,y4=C4("species"),ew=T4(S4.PromiseRejectionEvent),I4=R4("Promise",function(){var e=v4(cu),t=e!==String(cu);if(!t&&pg===66||!$A.catch||!$A.finally)return!0;if(!pg||pg<51||!/native code/.test(e)){var i=new cu(function(o){o(1)}),r=function(o){o(function(){},function(){})};if((i.constructor={})[y4]=r,!(i.then(function(){})instanceof r))return!0}return!(t||ZA!=="BROWSER"&&ZA!=="DENO"||ew)}),du={CONSTRUCTOR:I4,REJECTION_EVENT:ew},Io={},tw=Zr,A4=TypeError,w4=function(e){var t,i;this.promise=new e(function(r,o){if(t!==void 0||i!==void 0)throw new A4("Bad Promise constructor");t=r,i=o}),this.resolve=tw(t),this.reject=tw(i)};Io.f=function(e){return new w4(e)};var _g,iw,rw,b4=qe,Fp=mp,Ks=ve,O4=Qr,lu=gi,N4=Ws,D4=ns,P4=function(e){var t=kG(e);UG&&t&&!t[IA]&&MG(t,IA,{configurable:!0,get:function(){return this}})},L4=Zr,fg=ci,k4=ir,M4=JE,U4=eg,nw=Mp.set,mg=QA,x4=function(e,t){try{arguments.length===1?console.error(e):console.error(e,t)}catch{}},V4=md,F4=YA,ow=Ga,Eg=Ha,sw=du,aw=Io,Bp="Promise",cw=sw.CONSTRUCTOR,B4=sw.REJECTION_EVENT,gg=ow.getterFor(Bp),j4=ow.set,G4=Eg&&Eg.prototype,uu=Eg,Sg=G4,dw=Ks.TypeError,Tg=Ks.document,Rg=Ks.process,vg=aw.f,W4=vg,H4=!!(Tg&&Tg.createEvent&&Ks.dispatchEvent),lw="unhandledrejection",uw=function(e){var t;return!(!k4(e)||!fg(t=e.then))&&t},hw=function(e,t){var i,r,o,s=t.value,a=t.state===1,c=a?e.ok:e.fail,d=e.resolve,l=e.reject,h=e.domain;try{c?(a||(t.rejection===2&&Y4(t),t.rejection=1),c===!0?i=s:(h&&h.enter(),i=c(s),h&&(h.exit(),o=!0)),i===e.promise?l(new dw("Promise-chain cycle")):(r=uw(i))?lu(r,i,d,l):d(i)):l(s)}catch(p){h&&!o&&h.exit(),l(p)}},pw=function(e,t){e.notified||(e.notified=!0,mg(function(){for(var i,r=e.reactions;i=r.get();)hw(i,e);e.notified=!1,t&&!e.rejection&&K4(e)}))},_w=function(e,t,i){var r,o;H4?((r=Tg.createEvent("Event")).promise=t,r.reason=i,r.initEvent(e,!1,!0),Ks.dispatchEvent(r)):r={promise:t,reason:i},!B4&&(o=Ks["on"+e])?o(r):e===lw&&x4("Unhandled promise rejection",i)},K4=function(e){lu(nw,Ks,function(){var t,i=e.facade,r=e.value;if(fw(e)&&(t=V4(function(){Fp?Rg.emit("unhandledRejection",r,i):_w(lw,i,r)}),e.rejection=Fp||fw(e)?2:1,t.error))throw t.value})},fw=function(e){return e.rejection!==1&&!e.parent},Y4=function(e){lu(nw,Ks,function(){var t=e.facade;Fp?Rg.emit("rejectionHandled",t):_w("rejectionhandled",t,e.value)})},Ed=function(e,t,i){return function(r){e(t,r,i)}},gd=function(e,t,i){e.done||(e.done=!0,i&&(e=i),e.value=t,e.state=2,pw(e,!0))},Cg=function(e,t,i){if(!e.done){e.done=!0,i&&(e=i);try{if(e.facade===t)throw new dw("Promise can't be resolved itself");var r=uw(t);r?mg(function(){var o={done:!1};try{lu(r,t,Ed(Cg,o,e),Ed(gd,o,e))}catch(s){gd(o,s,e)}}):(e.value=t,e.state=1,pw(e,!1))}catch(o){gd({done:!1},o,e)}}};cw&&(Sg=(uu=function(e){M4(this,Sg),L4(e),lu(_g,this);var t=gg(this);try{e(Ed(Cg,t),Ed(gd,t))}catch(i){gd(t,i)}}).prototype,(_g=function(e){j4(this,{type:Bp,done:!1,notified:!1,parent:!1,reactions:new F4,rejection:!1,state:0,value:null})}).prototype=N4(Sg,"then",function(e,t){var i=gg(this),r=vg(U4(this,uu));return i.parent=!0,r.ok=!fg(e)||e,r.fail=fg(t)&&t,r.domain=Fp?Rg.domain:void 0,i.state===0?i.reactions.add(r):mg(function(){hw(r,i)}),r.promise}),iw=function(){var e=new _g,t=gg(e);this.promise=e,this.resolve=Ed(Cg,t),this.reject=Ed(gd,t)},aw.f=vg=function(e){return e===uu||e===rw?new iw(e):W4(e)}),b4({global:!0,wrap:!0,forced:cw},{Promise:uu}),rw=O4.Promise,D4(uu,Bp,!1,!0),P4(Bp);var mw=qt("iterator"),Ew=!1;try{var z4=0,gw={next:function(){return{done:!!z4++}},return:function(){Ew=!0}};gw[mw]=function(){return this},Array.from(gw,function(){throw 2})}catch{}var q4=Ha,X4=function(e,t){try{if(!t&&!Ew)return!1}catch{return!1}var i=!1;try{var r={};r[mw]=function(){return{next:function(){return{done:i=!0}}}},e(r)}catch{}return i},jp=du.CONSTRUCTOR||!X4(function(e){q4.all(e).then(void 0,function(){})}),J4=gi,Q4=Zr,Z4=Io,$4=md,e5=ru;qe({target:"Promise",stat:!0,forced:jp},{all:function(e){var t=this,i=Z4.f(t),r=i.resolve,o=i.reject,s=$4(function(){var a=Q4(t.resolve),c=[],d=0,l=1;e5(e,function(h){var p=d++,f=!1;l++,J4(a,t,h).then(function(m){f||(f=!0,c[p]=m,--l||r(c))},o)}),--l||r(c)});return s.error&&o(s.value),i.promise}});var t5=qe,i5=du.CONSTRUCTOR;Ha&&Ha.prototype,t5({target:"Promise",proto:!0,forced:i5,real:!0},{catch:function(e){return this.then(void 0,e)}});var r5=gi,n5=Zr,o5=Io,s5=md,a5=ru;qe({target:"Promise",stat:!0,forced:jp},{race:function(e){var t=this,i=o5.f(t),r=i.reject,o=s5(function(){var s=n5(t.resolve);a5(e,function(a){r5(s,t,a).then(i.resolve,r)})});return o.error&&r(o.value),i.promise}});var c5=Io;qe({target:"Promise",stat:!0,forced:du.CONSTRUCTOR},{reject:function(e){var t=c5.f(this);return(0,t.reject)(e),t.promise}});var d5=Ur,l5=ir,u5=Io,Sw=function(e,t){if(d5(e),l5(t)&&t.constructor===e)return t;var i=u5.f(e);return(0,i.resolve)(t),i.promise},h5=qe,p5=Ha,_5=du.CONSTRUCTOR,f5=Sw,m5=Sr("Promise"),E5=!_5;h5({target:"Promise",stat:!0,forced:!0},{resolve:function(e){return f5(E5&&this===m5?p5:this,e)}});var g5=gi,S5=Zr,T5=Io,R5=md,v5=ru;qe({target:"Promise",stat:!0,forced:jp},{allSettled:function(e){var t=this,i=T5.f(t),r=i.resolve,o=i.reject,s=R5(function(){var a=S5(t.resolve),c=[],d=0,l=1;v5(e,function(h){var p=d++,f=!1;l++,g5(a,t,h).then(function(m){f||(f=!0,c[p]={status:"fulfilled",value:m},--l||r(c))},function(m){f||(f=!0,c[p]={status:"rejected",reason:m},--l||r(c))})}),--l||r(c)});return s.error&&o(s.value),i.promise}});var C5=gi,y5=Zr,I5=Sr,A5=Io,w5=md,b5=ru,Tw="No one promise resolved";qe({target:"Promise",stat:!0,forced:jp},{any:function(e){var t=this,i=I5("AggregateError"),r=A5.f(t),o=r.resolve,s=r.reject,a=w5(function(){var c=y5(t.resolve),d=[],l=0,h=1,p=!1;b5(e,function(f){var m=l++,g=!1;h++,C5(c,t,f).then(function(S){g||p||(p=!0,o(S))},function(S){g||p||(g=!0,d[m]=S,--h||s(new i(d,Tw)))})}),--h||s(new i(d,Tw))});return a.error&&s(a.value),r.promise}});var O5=qe,N5=fe,D5=Hs,P5=Io,L5=Zr,Rw=md,yg=ve.Promise,vw=!1;O5({target:"Promise",stat:!0,forced:!yg||!yg.try||Rw(function(){yg.try(function(e){vw=e===8},8)}).error||!vw},{try:function(e){var t=arguments.length>1?D5(arguments,1):[],i=P5.f(this),r=Rw(function(){return N5(L5(e),void 0,t)});return(r.error?i.reject:i.resolve)(r.value),i.promise}});var k5=Io;qe({target:"Promise",stat:!0},{withResolvers:function(){var e=k5.f(this);return{promise:e.promise,resolve:e.resolve,reject:e.reject}}});var M5=qe,Ig=Ha,U5=P,x5=Sr,V5=ci,F5=eg,Cw=Sw,B5=Ig&&Ig.prototype;M5({target:"Promise",proto:!0,real:!0,forced:!!Ig&&U5(function(){B5.finally.call({then:function(){}},function(){})})},{finally:function(e){var t=F5(this,x5("Promise")),i=V5(e);return this.then(i?function(r){return Cw(t,e()).then(function(){return r})}:e,i?function(r){return Cw(t,e()).then(function(){throw r})}:e)}});var Ag=he,j5=RE,G5=xr,W5=Vs,H5=Ag("".charAt),yw=Ag("".charCodeAt),K5=Ag("".slice),Iw=function(e){return function(t,i){var r,o,s=G5(W5(t)),a=j5(i),c=s.length;return a<0||a>=c?e?"":void 0:(r=yw(s,a))<55296||r>56319||a+1===c||(o=yw(s,a+1))<56320||o>57343?e?H5(s,a):r:e?K5(s,a,a+2):o-56320+(r-55296<<10)+65536}},wg={codeAt:Iw(!1),charAt:Iw(!0)},Y5=wg.charAt,z5=xr,Aw=Ga,q5=RA,ww=Dp,bw="String Iterator",X5=Aw.set,J5=Aw.getterFor(bw);q5(String,"String",function(e){X5(this,{type:bw,string:z5(e),index:0})},function(){var e,t=J5(this),i=t.string,r=t.index;return r>=i.length?ww(void 0,!0):(e=Y5(i,r),t.index+=e.length,ww(e,!1))});var Q5=Qr.Promise,Z5={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},$5=ve,eW=ns,Ow=ld;for(var bg in Z5)eW($5[bg],bg),Ow[bg]=Ow.Array;var Nw=Q5,Z=A(Nw),tW=ln("Array","values"),iW=Gs,rW=Bi,nW=me,oW=tW,Og=Array.prototype,sW={DOMTokenList:!0,NodeList:!0},aW=function(e){var t=e.values;return e===Og||nW(Og,e)&&t===Og.values||rW(sW,iW(e))?oW:t},Vr=A(aW),Dw=od,cW=TypeError,Pw=Hs,dW=Math.floor,Ng=function(e,t){var i=e.length;if(i<8)for(var r,o,s=1;s<i;){for(o=s,r=e[s];o&&t(e[o-1],r)>0;)e[o]=e[--o];o!==s++&&(e[o]=r)}else for(var a=dW(i/2),c=Ng(Pw(e,0,a),t),d=Ng(Pw(e,a),t),l=c.length,h=d.length,p=0,f=0;p<l||f<h;)e[p+f]=p<l&&f<h?t(c[p],d[f])<=0?c[p++]:d[f++]:p<l?c[p++]:d[f++];return e},Lw=Ng,kw=rs.match(/firefox\/(\d+)/i),lW=!!kw&&+kw[1],uW=/MSIE|Trident/.test(rs),Mw=rs.match(/AppleWebKit\/(\d+)\./),hW=!!Mw&&+Mw[1],pW=qe,Uw=he,_W=Zr,fW=Co,xw=js,mW=function(e,t){if(!delete e[t])throw new cW("Cannot delete property "+Dw(t)+" of "+Dw(e))},Vw=xr,Dg=P,EW=Lw,gW=_p,Fw=lW,SW=uW,Bw=Fa,jw=hW,Ys=[],Gw=Uw(Ys.sort),TW=Uw(Ys.push),RW=Dg(function(){Ys.sort(void 0)}),vW=Dg(function(){Ys.sort(null)}),CW=gW("sort"),Ww=!Dg(function(){if(Bw)return Bw<70;if(!(Fw&&Fw>3)){if(SW)return!0;if(jw)return jw<603;var e,t,i,r,o="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(r=0;r<47;r++)Ys.push({k:t+r,v:i})}for(Ys.sort(function(s,a){return a.v-s.v}),r=0;r<Ys.length;r++)t=Ys[r].k.charAt(0),o.charAt(o.length-1)!==t&&(o+=t);return o!=="DGBEFHACIJK"}});pW({target:"Array",proto:!0,forced:RW||!vW||!CW||!Ww},{sort:function(e){e!==void 0&&_W(e);var t=fW(this);if(Ww)return e===void 0?Gw(t):Gw(t,e);var i,r,o=[],s=xw(t);for(r=0;r<s;r++)r in t&&TW(o,t[r]);for(EW(o,function(a){return function(c,d){return d===void 0?-1:c===void 0?1:a!==void 0?+a(c,d)||0:Vw(c)>Vw(d)?1:-1}}(e)),i=xw(o),r=0;r<i;)t[r]=o[r++];for(;r<s;)mW(t,r++);return t}});var yW=ln("Array","sort"),IW=me,AW=yW,Pg=Array.prototype,wW=function(e){var t=e.sort;return e===Pg||IW(Pg,e)&&t===Pg.sort?AW:t},Ka=A(wW),bW=qe,OW=he,NW=vE,DW=RangeError,Hw=String.fromCharCode,Kw=String.fromCodePoint,PW=OW([].join);bW({target:"String",stat:!0,forced:!!Kw&&Kw.length!==1},{fromCodePoint:function(e){for(var t,i=[],r=arguments.length,o=0;r>o;){if(t=+arguments[o++],NW(t,1114111)!==t)throw new DW(t+" is not a valid code point");i[o]=t<65536?Hw(t):Hw(55296+((t-=65536)>>10),t%1024+56320)}return PW(i,"")}});var LW=P,kW=qt("iterator"),Gp=!LW(function(){var e=new URL("b?a=1&b=2&c=3","https://a"),t=e.searchParams,i=new URLSearchParams("a=1&a=2&b=3"),r="";return e.pathname="c%20d",t.forEach(function(o,s){t.delete("b"),r+=s+o}),i.delete("a",2),i.delete("b",void 0),!e.toJSON||!i.has("a",1)||i.has("a",2)||!i.has("a",void 0)||i.has("b")||!t.size&&!0||!t.sort||e.href!=="https://a/c%20d?a=1&c=3"||t.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!t[kW]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("https://").host!=="xn--e1aybc"||new URL("https://a#").hash!=="#%D0%B1"||r!=="a1c3"||new URL("https://x",void 0).host!=="x"}),MW=Ws,Lg=qe,Yw=ve,kg=WA,UW=Sr,Wp=gi,ro=he,hu=ur,zw=Gp,qw=Ws,xW=Lp,VW=function(e,t,i){for(var r in t)i&&i.unsafe&&e[r]?e[r]=t[r]:MW(e,r,t[r],i);return e},FW=ns,BW=qE,Mg=Ga,Xw=JE,Ug=ci,jW=Bi,GW=Bs,WW=Gs,HW=Ur,Jw=ir,Fr=xr,KW=iu,Qw=kn,Zw=FE,YW=Cp,Hp=Dp,Sd=Wa,zW=Lw,qW=qt("iterator"),Td="URLSearchParams",$w=Td+"Iterator",eb=Mg.set,Un=Mg.getterFor(Td),XW=Mg.getterFor($w),tb=kg("fetch"),Kp=kg("Request"),pu=kg("Headers"),xg=Kp&&Kp.prototype,ib=pu&&pu.prototype,JW=Yw.TypeError,QW=Yw.encodeURIComponent,ZW=String.fromCharCode,$W=UW("String","fromCodePoint"),e6=parseInt,Yp=ro("".charAt),rb=ro([].join),zs=ro([].push),nb=ro("".replace),t6=ro([].shift),ob=ro([].splice),sb=ro("".split),ab=ro("".slice),i6=ro(/./.exec),r6=/\+/g,n6=/^[0-9a-f]+$/i,cb=function(e,t){var i=ab(e,t,t+2);return i6(n6,i)?e6(i,16):NaN},o6=function(e){for(var t=0,i=128;i>0&&e&i;i>>=1)t++;return t},s6=function(e){var t=null;switch(e.length){case 1:t=e[0];break;case 2:t=(31&e[0])<<6|63&e[1];break;case 3:t=(15&e[0])<<12|(63&e[1])<<6|63&e[2];break;case 4:t=(7&e[0])<<18|(63&e[1])<<12|(63&e[2])<<6|63&e[3]}return t>1114111?null:t},db=function(e){for(var t=(e=nb(e,r6," ")).length,i="",r=0;r<t;){var o=Yp(e,r);if(o==="%"){if(Yp(e,r+1)==="%"||r+3>t){i+="%",r++;continue}var s=cb(e,r+1);if(s!=s){i+=o,r++;continue}r+=2;var a=o6(s);if(a===0)o=ZW(s);else{if(a===1||a>4){i+="",r++;continue}for(var c=[s],d=1;d<a&&!(++r+3>t||Yp(e,r)!=="%");){var l=cb(e,r+1);if(l!=l){r+=3;break}if(l>191||l<128)break;zs(c,l),r+=2,d++}if(c.length!==a){i+="";continue}var h=s6(c);h===null?i+="":o=$W(h)}}i+=o,r++}return i},a6=/[!'()~]|%20/g,c6={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},d6=function(e){return c6[e]},lb=function(e){return nb(QW(e),a6,d6)},Vg=BW(function(e,t){eb(this,{type:$w,target:Un(e).entries,index:0,kind:t})},Td,function(){var e=XW(this),t=e.target,i=e.index++;if(!t||i>=t.length)return e.target=null,Hp(void 0,!0);var r=t[i];switch(e.kind){case"keys":return Hp(r.key,!1);case"values":return Hp(r.value,!1)}return Hp([r.key,r.value],!1)},!0),ub=function(e){this.entries=[],this.url=null,e!==void 0&&(Jw(e)?this.parseObject(e):this.parseQuery(typeof e=="string"?Yp(e,0)==="?"?ab(e,1):e:Fr(e)))};ub.prototype={type:Td,bindURL:function(e){this.url=e,this.update()},parseObject:function(e){var t,i,r,o,s,a,c,d=this.entries,l=YW(e);if(l)for(i=(t=Zw(e,l)).next;!(r=Wp(i,t)).done;){if(s=(o=Zw(HW(r.value))).next,(a=Wp(s,o)).done||(c=Wp(s,o)).done||!Wp(s,o).done)throw new JW("Expected sequence with length 2");zs(d,{key:Fr(a.value),value:Fr(c.value)})}else for(var h in e)jW(e,h)&&zs(d,{key:h,value:Fr(e[h])})},parseQuery:function(e){if(e)for(var t,i,r=this.entries,o=sb(e,"&"),s=0;s<o.length;)(t=o[s++]).length&&(i=sb(t,"="),zs(r,{key:db(t6(i)),value:db(rb(i,"="))}))},serialize:function(){for(var e,t=this.entries,i=[],r=0;r<t.length;)e=t[r++],zs(i,lb(e.key)+"="+lb(e.value));return rb(i,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var zp=function(){Xw(this,Rd);var e=eb(this,new ub(arguments.length>0?arguments[0]:void 0));hu||(this.size=e.entries.length)},Rd=zp.prototype;if(VW(Rd,{append:function(e,t){var i=Un(this);Sd(arguments.length,2),zs(i.entries,{key:Fr(e),value:Fr(t)}),hu||this.length++,i.updateURL()},delete:function(e){for(var t=Un(this),i=Sd(arguments.length,1),r=t.entries,o=Fr(e),s=i<2?void 0:arguments[1],a=s===void 0?s:Fr(s),c=0;c<r.length;){var d=r[c];if(d.key!==o||a!==void 0&&d.value!==a)c++;else if(ob(r,c,1),a!==void 0)break}hu||(this.size=r.length),t.updateURL()},get:function(e){var t=Un(this).entries;Sd(arguments.length,1);for(var i=Fr(e),r=0;r<t.length;r++)if(t[r].key===i)return t[r].value;return null},getAll:function(e){var t=Un(this).entries;Sd(arguments.length,1);for(var i=Fr(e),r=[],o=0;o<t.length;o++)t[o].key===i&&zs(r,t[o].value);return r},has:function(e){for(var t=Un(this).entries,i=Sd(arguments.length,1),r=Fr(e),o=i<2?void 0:arguments[1],s=o===void 0?o:Fr(o),a=0;a<t.length;){var c=t[a++];if(c.key===r&&(s===void 0||c.value===s))return!0}return!1},set:function(e,t){var i=Un(this);Sd(arguments.length,1);for(var r,o=i.entries,s=!1,a=Fr(e),c=Fr(t),d=0;d<o.length;d++)(r=o[d]).key===a&&(s?ob(o,d--,1):(s=!0,r.value=c));s||zs(o,{key:a,value:c}),hu||(this.size=o.length),i.updateURL()},sort:function(){var e=Un(this);zW(e.entries,function(t,i){return t.key>i.key?1:-1}),e.updateURL()},forEach:function(e){for(var t,i=Un(this).entries,r=GW(e,arguments.length>1?arguments[1]:void 0),o=0;o<i.length;)r((t=i[o++]).value,t.key,this)},keys:function(){return new Vg(this,"keys")},values:function(){return new Vg(this,"values")},entries:function(){return new Vg(this,"entries")}},{enumerable:!0}),qw(Rd,qW,Rd.entries,{}),qw(Rd,"toString",function(){return Un(this).serialize()},{enumerable:!0}),hu&&xW(Rd,"size",{get:function(){return Un(this).entries.length},configurable:!0,enumerable:!0}),FW(zp,Td),Lg({global:!0,forced:!zw},{URLSearchParams:zp}),!zw&&Ug(pu)){var l6=ro(ib.has),u6=ro(ib.set),hb=function(e){if(Jw(e)){var t,i=e.body;if(WW(i)===Td)return t=e.headers?new pu(e.headers):new pu,l6(t,"content-type")||u6(t,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),KW(e,{body:Qw(0,Fr(i)),headers:Qw(0,t)})}return e};if(Ug(tb)&&Lg({global:!0,dontCallGetSet:!0,forced:!0},{fetch:function(e){return tb(e,arguments.length>1?hb(arguments[1]):{})}}),Ug(Kp)){var Fg=function(e){return Xw(this,xg),new Kp(e,arguments.length>1?hb(arguments[1]):{})};xg.constructor=Fg,Fg.prototype=xg,Lg({global:!0,dontCallGetSet:!0,forced:!0},{Request:Fg})}}var xn,h6={URLSearchParams:zp,getState:Un},p6=Qr.URLSearchParams,pb=ur,_6=he,f6=gi,m6=P,Bg=Tp,E6=tu,g6=mt,S6=Co,T6=lp,vd=Object.assign,_b=Object.defineProperty,R6=_6([].concat),v6=!vd||m6(function(){if(pb&&vd({b:1},vd(_b({},"a",{enumerable:!0,get:function(){_b(this,"b",{value:3,enumerable:!1})}}),{b:2})).b!==1)return!0;var e={},t={},i=Symbol("assign detection"),r="abcdefghijklmnopqrst";return e[i]=7,r.split("").forEach(function(o){t[o]=o}),vd({},e)[i]!==7||Bg(vd({},t)).join("")!==r})?function(e,t){for(var i=S6(e),r=arguments.length,o=1,s=E6.f,a=g6.f;r>o;)for(var c,d=T6(arguments[o++]),l=s?R6(Bg(d),s(d)):Bg(d),h=l.length,p=0;h>p;)c=l[p++],pb&&!f6(a,d,c)||(i[c]=d[c]);return i}:vd,C6=Ur,y6=eA,I6=ur,A6=Mn,w6=kn,jg=function(e,t,i){I6?A6.f(e,t,w6(0,i)):e[t]=i},b6=Bs,O6=gi,N6=Co,D6=function(e,t,i,r){try{return r?t(C6(i)[0],i[1]):t(i)}catch(o){y6(e,"throw",o)}},P6=QI,L6=kp,k6=js,fb=jg,M6=FE,U6=Cp,mb=Array,Ya=he,Gg=2147483647,x6=/[^\0-\u007E]/,Eb=/[.\u3002\uFF0E\uFF61]/g,gb="Overflow: input needs wider integers to process",Sb=RangeError,V6=Ya(Eb.exec),Cd=Math.floor,Wg=String.fromCharCode,Tb=Ya("".charCodeAt),Rb=Ya([].join),qs=Ya([].push),F6=Ya("".replace),B6=Ya("".split),j6=Ya("".toLowerCase),vb=function(e){return e+22+75*(e<26)},G6=function(e,t,i){var r=0;for(e=i?Cd(e/700):e>>1,e+=Cd(e/t);e>455;)e=Cd(e/35),r+=36;return Cd(r+36*e/(e+38))},W6=function(e){var t=[];e=function(C){for(var b=[],D=0,x=C.length;D<x;){var k=Tb(C,D++);if(k>=55296&&k<=56319&&D<x){var V=Tb(C,D++);(64512&V)==56320?qs(b,((1023&k)<<10)+(1023&V)+65536):(qs(b,k),D--)}else qs(b,k)}return b}(e);var i,r,o=e.length,s=128,a=0,c=72;for(i=0;i<e.length;i++)(r=e[i])<128&&qs(t,Wg(r));var d=t.length,l=d;for(d&&qs(t,"-");l<o;){var h=Gg;for(i=0;i<e.length;i++)(r=e[i])>=s&&r<h&&(h=r);var p=l+1;if(h-s>Cd((Gg-a)/p))throw new Sb(gb);for(a+=(h-s)*p,s=h,i=0;i<e.length;i++){if((r=e[i])<s&&++a>Gg)throw new Sb(gb);if(r===s){for(var f=a,m=36;;){var g=m<=c?1:m>=c+26?26:m-c;if(f<g)break;var S=f-g,T=36-g;qs(t,Wg(vb(g+S%T))),f=Cd(S/T),m+=36}qs(t,Wg(vb(f))),c=G6(a,p,l===d),a=0,l++}}a++,s++}return Rb(t,"")},H6=qe,Hg=ur,K6=Gp,Kg=ve,Cb=Bs,Vn=he,qp=Ws,Fn=Lp,Y6=JE,Yg=Bi,zg=v6,yd=function(e){var t=N6(e),i=L6(this),r=arguments.length,o=r>1?arguments[1]:void 0,s=o!==void 0;s&&(o=b6(o,r>2?arguments[2]:void 0));var a,c,d,l,h,p,f=U6(t),m=0;if(!f||this===mb&&P6(f))for(a=k6(t),c=i?new this(a):mb(a);a>m;m++)p=s?o(t[m],m):t[m],fb(c,m,p);else for(c=i?new this:[],h=(l=M6(t,f)).next;!(d=O6(h,l)).done;m++)p=s?D6(l,o,[d.value,m],!0):d.value,fb(c,m,p);return c.length=m,c},no=Hs,z6=wg.codeAt,q6=function(e){var t,i,r=[],o=B6(F6(j6(e),Eb,"."),".");for(t=0;t<o.length;t++)i=o[t],qs(r,V6(x6,i)?"xn--"+W6(i):i);return Rb(r,".")},os=xr,X6=ns,J6=Wa,yb=h6,Ib=Ga,Q6=Ib.set,Xp=Ib.getterFor("URL"),Z6=yb.URLSearchParams,$6=yb.getState,_u=Kg.URL,qg=Kg.TypeError,Jp=Kg.parseInt,eH=Math.floor,Ab=Math.pow,Bn=Vn("".charAt),oo=Vn(/./.exec),fu=Vn([].join),tH=Vn(1.1.toString),iH=Vn([].pop),Id=Vn([].push),Xg=Vn("".replace),rH=Vn([].shift),nH=Vn("".split),mu=Vn("".slice),Qp=Vn("".toLowerCase),oH=Vn([].unshift),Jg="Invalid scheme",Ad="Invalid host",wb="Invalid port",bb=/[a-z]/i,sH=/[\d+-.a-z]/i,Qg=/\d/,aH=/^0x/i,cH=/^[0-7]+$/,dH=/^\d+$/,Ob=/^[\da-f]+$/i,lH=/[\0\t\n\r #%/:<>?@[\\\]^|]/,uH=/[\0\t\n\r #/:<>?@[\\\]^|]/,hH=/^[\u0000-\u0020]+/,pH=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,_H=/[\t\n\r]/g,Eu=function(e){var t,i,r,o;if(typeof e=="number"){for(t=[],i=0;i<4;i++)oH(t,e%256),e=eH(e/256);return fu(t,".")}if(typeof e=="object"){for(t="",r=function(s){for(var a=null,c=1,d=null,l=0,h=0;h<8;h++)s[h]!==0?(l>c&&(a=d,c=l),d=null,l=0):(d===null&&(d=h),++l);return l>c?d:a}(e),i=0;i<8;i++)o&&e[i]===0||(o&&(o=!1),r===i?(t+=i?":":"::",o=!0):(t+=tH(e[i],16),i<7&&(t+=":")));return"["+t+"]"}return e},Zp={},Nb=zg({},Zp,{" ":1,'"':1,"<":1,">":1,"`":1}),Db=zg({},Nb,{"#":1,"?":1,"{":1,"}":1}),Zg=zg({},Db,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),Xs=function(e,t){var i=z6(e,0);return i>32&&i<127&&!Yg(t,e)?e:encodeURIComponent(e)},$p={ftp:21,file:null,http:80,https:443,ws:80,wss:443},gu=function(e,t){var i;return e.length===2&&oo(bb,Bn(e,0))&&((i=Bn(e,1))===":"||!t&&i==="|")},Pb=function(e){var t;return e.length>1&&gu(mu(e,0,2))&&(e.length===2||(t=Bn(e,2))==="/"||t==="\\"||t==="?"||t==="#")},fH=function(e){return e==="."||Qp(e)==="%2e"},$g={},Lb={},eS={},kb={},Mb={},tS={},Ub={},xb={},e_={},t_={},iS={},rS={},nS={},oS={},Vb={},sS={},wd={},Ao={},Fb={},za={},ss={},aS=function(e,t,i){var r,o,s,a=os(e);if(t){if(o=this.parse(a))throw new qg(o);this.searchParams=null}else{if(i!==void 0&&(r=new aS(i,!0)),o=this.parse(a,null,r))throw new qg(o);(s=$6(new Z6)).bindURL(this),this.searchParams=s}};aS.prototype={type:"URL",parse:function(e,t,i){var r,o,s,a,c,d=this,l=t||$g,h=0,p="",f=!1,m=!1,g=!1;for(e=os(e),t||(d.scheme="",d.username="",d.password="",d.host=null,d.port=null,d.path=[],d.query=null,d.fragment=null,d.cannotBeABaseURL=!1,e=Xg(e,hH,""),e=Xg(e,pH,"$1")),e=Xg(e,_H,""),r=yd(e);h<=r.length;){switch(o=r[h],l){case $g:if(!o||!oo(bb,o)){if(t)return Jg;l=eS;continue}p+=Qp(o),l=Lb;break;case Lb:if(o&&(oo(sH,o)||o==="+"||o==="-"||o==="."))p+=Qp(o);else{if(o!==":"){if(t)return Jg;p="",l=eS,h=0;continue}if(t&&(d.isSpecial()!==Yg($p,p)||p==="file"&&(d.includesCredentials()||d.port!==null)||d.scheme==="file"&&!d.host))return;if(d.scheme=p,t)return void(d.isSpecial()&&$p[d.scheme]===d.port&&(d.port=null));p="",d.scheme==="file"?l=oS:d.isSpecial()&&i&&i.scheme===d.scheme?l=kb:d.isSpecial()?l=xb:r[h+1]==="/"?(l=Mb,h++):(d.cannotBeABaseURL=!0,Id(d.path,""),l=Fb)}break;case eS:if(!i||i.cannotBeABaseURL&&o!=="#")return Jg;if(i.cannotBeABaseURL&&o==="#"){d.scheme=i.scheme,d.path=no(i.path),d.query=i.query,d.fragment="",d.cannotBeABaseURL=!0,l=ss;break}l=i.scheme==="file"?oS:tS;continue;case kb:if(o!=="/"||r[h+1]!=="/"){l=tS;continue}l=e_,h++;break;case Mb:if(o==="/"){l=t_;break}l=Ao;continue;case tS:if(d.scheme=i.scheme,o===xn)d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,d.path=no(i.path),d.query=i.query;else if(o==="/"||o==="\\"&&d.isSpecial())l=Ub;else if(o==="?")d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,d.path=no(i.path),d.query="",l=za;else{if(o!=="#"){d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,d.path=no(i.path),d.path.length--,l=Ao;continue}d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,d.path=no(i.path),d.query=i.query,d.fragment="",l=ss}break;case Ub:if(!d.isSpecial()||o!=="/"&&o!=="\\"){if(o!=="/"){d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,l=Ao;continue}l=t_}else l=e_;break;case xb:if(l=e_,o!=="/"||Bn(p,h+1)!=="/")continue;h++;break;case e_:if(o!=="/"&&o!=="\\"){l=t_;continue}break;case t_:if(o==="@"){f&&(p="%40"+p),f=!0,s=yd(p);for(var S=0;S<s.length;S++){var T=s[S];if(T!==":"||g){var C=Xs(T,Zg);g?d.password+=C:d.username+=C}else g=!0}p=""}else if(o===xn||o==="/"||o==="?"||o==="#"||o==="\\"&&d.isSpecial()){if(f&&p==="")return"Invalid authority";h-=yd(p).length+1,p="",l=iS}else p+=o;break;case iS:case rS:if(t&&d.scheme==="file"){l=sS;continue}if(o!==":"||m){if(o===xn||o==="/"||o==="?"||o==="#"||o==="\\"&&d.isSpecial()){if(d.isSpecial()&&p==="")return Ad;if(t&&p===""&&(d.includesCredentials()||d.port!==null))return;if(a=d.parseHost(p))return a;if(p="",l=wd,t)return;continue}o==="["?m=!0:o==="]"&&(m=!1),p+=o}else{if(p==="")return Ad;if(a=d.parseHost(p))return a;if(p="",l=nS,t===rS)return}break;case nS:if(!oo(Qg,o)){if(o===xn||o==="/"||o==="?"||o==="#"||o==="\\"&&d.isSpecial()||t){if(p!==""){var b=Jp(p,10);if(b>65535)return wb;d.port=d.isSpecial()&&b===$p[d.scheme]?null:b,p=""}if(t)return;l=wd;continue}return wb}p+=o;break;case oS:if(d.scheme="file",o==="/"||o==="\\")l=Vb;else{if(!i||i.scheme!=="file"){l=Ao;continue}switch(o){case xn:d.host=i.host,d.path=no(i.path),d.query=i.query;break;case"?":d.host=i.host,d.path=no(i.path),d.query="",l=za;break;case"#":d.host=i.host,d.path=no(i.path),d.query=i.query,d.fragment="",l=ss;break;default:Pb(fu(no(r,h),""))||(d.host=i.host,d.path=no(i.path),d.shortenPath()),l=Ao;continue}}break;case Vb:if(o==="/"||o==="\\"){l=sS;break}i&&i.scheme==="file"&&!Pb(fu(no(r,h),""))&&(gu(i.path[0],!0)?Id(d.path,i.path[0]):d.host=i.host),l=Ao;continue;case sS:if(o===xn||o==="/"||o==="\\"||o==="?"||o==="#"){if(!t&&gu(p))l=Ao;else if(p===""){if(d.host="",t)return;l=wd}else{if(a=d.parseHost(p))return a;if(d.host==="localhost"&&(d.host=""),t)return;p="",l=wd}continue}p+=o;break;case wd:if(d.isSpecial()){if(l=Ao,o!=="/"&&o!=="\\")continue}else if(t||o!=="?")if(t||o!=="#"){if(o!==xn&&(l=Ao,o!=="/"))continue}else d.fragment="",l=ss;else d.query="",l=za;break;case Ao:if(o===xn||o==="/"||o==="\\"&&d.isSpecial()||!t&&(o==="?"||o==="#")){if((c=Qp(c=p))===".."||c==="%2e."||c===".%2e"||c==="%2e%2e"?(d.shortenPath(),o==="/"||o==="\\"&&d.isSpecial()||Id(d.path,"")):fH(p)?o==="/"||o==="\\"&&d.isSpecial()||Id(d.path,""):(d.scheme==="file"&&!d.path.length&&gu(p)&&(d.host&&(d.host=""),p=Bn(p,0)+":"),Id(d.path,p)),p="",d.scheme==="file"&&(o===xn||o==="?"||o==="#"))for(;d.path.length>1&&d.path[0]==="";)rH(d.path);o==="?"?(d.query="",l=za):o==="#"&&(d.fragment="",l=ss)}else p+=Xs(o,Db);break;case Fb:o==="?"?(d.query="",l=za):o==="#"?(d.fragment="",l=ss):o!==xn&&(d.path[0]+=Xs(o,Zp));break;case za:t||o!=="#"?o!==xn&&(o==="'"&&d.isSpecial()?d.query+="%27":d.query+=o==="#"?"%23":Xs(o,Zp)):(d.fragment="",l=ss);break;case ss:o!==xn&&(d.fragment+=Xs(o,Nb))}h++}},parseHost:function(e){var t,i,r;if(Bn(e,0)==="["){if(Bn(e,e.length-1)!=="]"||(t=function(o){var s,a,c,d,l,h,p,f=[0,0,0,0,0,0,0,0],m=0,g=null,S=0,T=function(){return Bn(o,S)};if(T()===":"){if(Bn(o,1)!==":")return;S+=2,g=++m}for(;T();){if(m===8)return;if(T()!==":"){for(s=a=0;a<4&&oo(Ob,T());)s=16*s+Jp(T(),16),S++,a++;if(T()==="."){if(a===0||(S-=a,m>6))return;for(c=0;T();){if(d=null,c>0){if(!(T()==="."&&c<4))return;S++}if(!oo(Qg,T()))return;for(;oo(Qg,T());){if(l=Jp(T(),10),d===null)d=l;else{if(d===0)return;d=10*d+l}if(d>255)return;S++}f[m]=256*f[m]+d,++c!=2&&c!==4||m++}if(c!==4)return;break}if(T()===":"){if(S++,!T())return}else if(T())return;f[m++]=s}else{if(g!==null)return;S++,g=++m}}if(g!==null)for(h=m-g,m=7;m!==0&&h>0;)p=f[m],f[m--]=f[g+h-1],f[g+--h]=p;else if(m!==8)return;return f}(mu(e,1,-1)),!t))return Ad;this.host=t}else if(this.isSpecial()){if(e=q6(e),oo(lH,e)||(t=function(o){var s,a,c,d,l,h,p,f=nH(o,".");if(f.length&&f[f.length-1]===""&&f.length--,(s=f.length)>4)return o;for(a=[],c=0;c<s;c++){if((d=f[c])==="")return o;if(l=10,d.length>1&&Bn(d,0)==="0"&&(l=oo(aH,d)?16:8,d=mu(d,l===8?1:2)),d==="")h=0;else{if(!oo(l===10?dH:l===8?cH:Ob,d))return o;h=Jp(d,l)}Id(a,h)}for(c=0;c<s;c++)if(h=a[c],c===s-1){if(h>=Ab(256,5-s))return null}else if(h>255)return null;for(p=iH(a),c=0;c<a.length;c++)p+=a[c]*Ab(256,3-c);return p}(e),t===null))return Ad;this.host=t}else{if(oo(uH,e))return Ad;for(t="",i=yd(e),r=0;r<i.length;r++)t+=Xs(i[r],Zp);this.host=t}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||this.scheme==="file"},includesCredentials:function(){return this.username!==""||this.password!==""},isSpecial:function(){return Yg($p,this.scheme)},shortenPath:function(){var e=this.path,t=e.length;!t||this.scheme==="file"&&t===1&&gu(e[0],!0)||e.length--},serialize:function(){var e=this,t=e.scheme,i=e.username,r=e.password,o=e.host,s=e.port,a=e.path,c=e.query,d=e.fragment,l=t+":";return o!==null?(l+="//",e.includesCredentials()&&(l+=i+(r?":"+r:"")+"@"),l+=Eu(o),s!==null&&(l+=":"+s)):t==="file"&&(l+="//"),l+=e.cannotBeABaseURL?a[0]:a.length?"/"+fu(a,"/"):"",c!==null&&(l+="?"+c),d!==null&&(l+="#"+d),l},setHref:function(e){var t=this.parse(e);if(t)throw new qg(t);this.searchParams.update()},getOrigin:function(){var e=this.scheme,t=this.port;if(e==="blob")try{return new bd(e.path[0]).origin}catch{return"null"}return e!=="file"&&this.isSpecial()?e+"://"+Eu(this.host)+(t!==null?":"+t:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(e){this.parse(os(e)+":",$g)},getUsername:function(){return this.username},setUsername:function(e){var t=yd(os(e));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var i=0;i<t.length;i++)this.username+=Xs(t[i],Zg)}},getPassword:function(){return this.password},setPassword:function(e){var t=yd(os(e));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var i=0;i<t.length;i++)this.password+=Xs(t[i],Zg)}},getHost:function(){var e=this.host,t=this.port;return e===null?"":t===null?Eu(e):Eu(e)+":"+t},setHost:function(e){this.cannotBeABaseURL||this.parse(e,iS)},getHostname:function(){var e=this.host;return e===null?"":Eu(e)},setHostname:function(e){this.cannotBeABaseURL||this.parse(e,rS)},getPort:function(){var e=this.port;return e===null?"":os(e)},setPort:function(e){this.cannotHaveUsernamePasswordPort()||((e=os(e))===""?this.port=null:this.parse(e,nS))},getPathname:function(){var e=this.path;return this.cannotBeABaseURL?e[0]:e.length?"/"+fu(e,"/"):""},setPathname:function(e){this.cannotBeABaseURL||(this.path=[],this.parse(e,wd))},getSearch:function(){var e=this.query;return e?"?"+e:""},setSearch:function(e){(e=os(e))===""?this.query=null:(Bn(e,0)==="?"&&(e=mu(e,1)),this.query="",this.parse(e,za)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var e=this.fragment;return e?"#"+e:""},setHash:function(e){(e=os(e))!==""?(Bn(e,0)==="#"&&(e=mu(e,1)),this.fragment="",this.parse(e,ss)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var bd=function(e){var t=Y6(this,Br),i=J6(arguments.length,1)>1?arguments[1]:void 0,r=Q6(t,new aS(e,!1,i));Hg||(t.href=r.serialize(),t.origin=r.getOrigin(),t.protocol=r.getProtocol(),t.username=r.getUsername(),t.password=r.getPassword(),t.host=r.getHost(),t.hostname=r.getHostname(),t.port=r.getPort(),t.pathname=r.getPathname(),t.search=r.getSearch(),t.searchParams=r.getSearchParams(),t.hash=r.getHash())},Br=bd.prototype,jn=function(e,t){return{get:function(){return Xp(this)[e]()},set:t&&function(i){return Xp(this)[t](i)},configurable:!0,enumerable:!0}};if(Hg&&(Fn(Br,"href",jn("serialize","setHref")),Fn(Br,"origin",jn("getOrigin")),Fn(Br,"protocol",jn("getProtocol","setProtocol")),Fn(Br,"username",jn("getUsername","setUsername")),Fn(Br,"password",jn("getPassword","setPassword")),Fn(Br,"host",jn("getHost","setHost")),Fn(Br,"hostname",jn("getHostname","setHostname")),Fn(Br,"port",jn("getPort","setPort")),Fn(Br,"pathname",jn("getPathname","setPathname")),Fn(Br,"search",jn("getSearch","setSearch")),Fn(Br,"searchParams",jn("getSearchParams")),Fn(Br,"hash",jn("getHash","setHash"))),qp(Br,"toJSON",function(){return Xp(this).serialize()},{enumerable:!0}),qp(Br,"toString",function(){return Xp(this).serialize()},{enumerable:!0}),_u){var Bb=_u.createObjectURL,jb=_u.revokeObjectURL;Bb&&qp(bd,"createObjectURL",Cb(Bb,_u)),jb&&qp(bd,"revokeObjectURL",Cb(jb,_u))}X6(bd,"URL"),H6({global:!0,forced:!K6,sham:!Hg},{URL:bd});var mH=qe,Gb=P,EH=Wa,Wb=xr,gH=Gp,cS=Sr("URL"),SH=gH&&Gb(function(){cS.canParse()}),TH=Gb(function(){return cS.canParse.length!==1});mH({target:"URL",stat:!0,forced:!SH||TH},{canParse:function(e){var t=EH(arguments.length,1),i=Wb(e),r=t<2||arguments[1]===void 0?void 0:Wb(arguments[1]);try{return!!new cS(i,r)}catch{return!1}}});var RH=qe,vH=Wa,Hb=xr,CH=Gp,yH=Sr("URL");RH({target:"URL",stat:!0,forced:!CH},{parse:function(e){var t=vH(arguments.length,1),i=Hb(e),r=t<2||arguments[1]===void 0?void 0:Hb(arguments[1]);try{return new yH(i,r)}catch{return null}}});var i_=A(Qr.URL);let Kb=!0,Yb=!0;function r_(e,t,i){const r=e.match(t);return r&&r.length>=i&&parseInt(r[i],10)}function qa(e,t,i){if(!e.RTCPeerConnection)return;const r=e.RTCPeerConnection.prototype,o=r.addEventListener;r.addEventListener=function(a,c){if(a!==t)return o.apply(this,arguments);const d=l=>{const h=i(l);h&&(c.handleEvent?c.handleEvent(h):c(h))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(c,d),o.apply(this,[a,d])};const s=r.removeEventListener;r.removeEventListener=function(a,c){if(a!==t||!this._eventMap||!this._eventMap[t])return s.apply(this,arguments);if(!this._eventMap[t].has(c))return s.apply(this,arguments);const d=this._eventMap[t].get(c);return this._eventMap[t].delete(c),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,s.apply(this,[a,d])},Object.defineProperty(r,"on"+t,{get(){return this["_on"+t]},set(a){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),a&&this.addEventListener(t,this["_on"+t]=a)},enumerable:!0,configurable:!0})}function IH(e){return typeof e!="boolean"?new Error("Argument type: "+typeof e+". Please use a boolean."):(Kb=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function AH(e){return typeof e!="boolean"?new Error("Argument type: "+typeof e+". Please use a boolean."):(Yb=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function zb(){if(typeof window=="object"){if(Kb)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function dS(e,t){Yb&&console.warn(e+" is deprecated, please use "+t+" instead.")}function qb(e){return Object.prototype.toString.call(e)==="[object Object]"}function Xb(e){var t;return qb(e)?un(t=Object.keys(e)).call(t,function(i,r){const o=qb(e[r]),s=o?Xb(e[r]):e[r],a=o&&!Object.keys(s).length;return s===void 0||a?i:Object.assign(i,{[r]:s})},{}):e}function lS(e,t,i){t&&!i.has(t.id)&&(i.set(t.id,t),Object.keys(t).forEach(r=>{r.endsWith("Id")?lS(e,e.get(t[r]),i):r.endsWith("Ids")&&t[r].forEach(o=>{lS(e,e.get(o),i)})}))}function Jb(e,t,i){const r=i?"outbound-rtp":"inbound-rtp",o=new Map;if(t===null)return o;const s=[];return e.forEach(a=>{a.type==="track"&&a.trackIdentifier===t.id&&s.push(a)}),s.forEach(a=>{e.forEach(c=>{c.type===r&&c.trackId===a.id&&lS(e,c,o)})}),o}const Qb=zb;function Zb(e,t){const i=e&&e.navigator;if(!i.mediaDevices)return;const r=function(a){if(typeof a!="object"||a.mandatory||a.optional)return a;const c={};return Object.keys(a).forEach(d=>{if(d==="require"||d==="advanced"||d==="mediaSource")return;const l=typeof a[d]=="object"?a[d]:{ideal:a[d]};l.exact!==void 0&&typeof l.exact=="number"&&(l.min=l.max=l.exact);const h=function(p,f){return p?p+f.charAt(0).toUpperCase()+f.slice(1):f==="deviceId"?"sourceId":f};if(l.ideal!==void 0){c.optional=c.optional||[];let p={};typeof l.ideal=="number"?(p[h("min",d)]=l.ideal,c.optional.push(p),p={},p[h("max",d)]=l.ideal,c.optional.push(p)):(p[h("",d)]=l.ideal,c.optional.push(p))}l.exact!==void 0&&typeof l.exact!="number"?(c.mandatory=c.mandatory||{},c.mandatory[h("",d)]=l.exact):["min","max"].forEach(p=>{l[p]!==void 0&&(c.mandatory=c.mandatory||{},c.mandatory[h(p,d)]=l[p])})}),a.advanced&&(c.optional=(c.optional||[]).concat(a.advanced)),c},o=function(a,c){if(t.version>=61)return c(a);if((a=JSON.parse(JSON.stringify(a)))&&typeof a.audio=="object"){const d=function(l,h,p){h in l&&!(p in l)&&(l[p]=l[h],delete l[h])};d((a=JSON.parse(JSON.stringify(a))).audio,"autoGainControl","googAutoGainControl"),d(a.audio,"noiseSuppression","googNoiseSuppression"),a.audio=r(a.audio)}if(a&&typeof a.video=="object"){let d=a.video.facingMode;d=d&&(typeof d=="object"?d:{ideal:d});const l=t.version<66;if(d&&(d.exact==="user"||d.exact==="environment"||d.ideal==="user"||d.ideal==="environment")&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||l)){let h;if(delete a.video.facingMode,d.exact==="environment"||d.ideal==="environment"?h=["back","rear"]:d.exact!=="user"&&d.ideal!=="user"||(h=["front"]),h)return i.mediaDevices.enumerateDevices().then(p=>{p=p.filter(m=>m.kind==="videoinput");let f=p.find(m=>h.some(g=>{var S;return z(S=m.label.toLowerCase()).call(S,g)}));return!f&&p.length&&z(h).call(h,"back")&&(f=p[p.length-1]),f&&(a.video.deviceId=d.exact?{exact:f.deviceId}:{ideal:f.deviceId}),a.video=r(a.video),Qb("chrome: "+JSON.stringify(a)),c(a)})}a.video=r(a.video)}return Qb("chrome: "+JSON.stringify(a)),c(a)},s=function(a){return t.version>=64?a:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[a.name]||a.name,message:a.message,constraint:a.constraint||a.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=(function(a,c,d){o(a,l=>{i.webkitGetUserMedia(l,c,h=>{d&&d(s(h))})})}).bind(i),i.mediaDevices.getUserMedia){const a=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(c){return o(c,d=>a(d).then(l=>{if(d.audio&&!l.getAudioTracks().length||d.video&&!l.getVideoTracks().length)throw l.getTracks().forEach(h=>{h.stop()}),new DOMException("","NotFoundError");return l},l=>Z.reject(s(l))))}}}function $b(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function eO(e){if(typeof e=="object"&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(i){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=i)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",r=>{let o;o=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(a=>a.track&&a.track.id===r.track.id):{track:r.track};const s=new Event("track");s.track=r.track,s.receiver=o,s.transceiver={receiver:o},s.streams=[i.stream],this.dispatchEvent(s)}),i.stream.getTracks().forEach(r=>{let o;o=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(a=>a.track&&a.track.id===r.id):{track:r};const s=new Event("track");s.track=r,s.receiver=o,s.transceiver={receiver:o},s.streams=[i.stream],this.dispatchEvent(s)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else qa(e,"track",t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t))}function tO(e){if(typeof e=="object"&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(o,s){return{track:s,get dtmf(){return this._dtmf===void 0&&(s.kind==="audio"?this._dtmf=o.createDTMFSender(s):this._dtmf=null),this._dtmf},_pc:o}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const o=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(a,c){let d=o.apply(this,arguments);return d||(d=t(this,a),this._senders.push(d)),d};const s=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(a){s.apply(this,arguments);const c=this._senders.indexOf(a);c!==-1&&this._senders.splice(c,1)}}const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(o){this._senders=this._senders||[],i.apply(this,[o]),o.getTracks().forEach(s=>{this._senders.push(t(this,s))})};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(o){this._senders=this._senders||[],r.apply(this,[o]),o.getTracks().forEach(s=>{const a=this._senders.find(c=>c.track===s);a&&this._senders.splice(this._senders.indexOf(a),1)})}}else if(typeof e=="object"&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const i=t.apply(this,[]);return i.forEach(r=>r._pc=this),i},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function iO(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[i,r,o]=arguments;if(arguments.length>0&&typeof i=="function")return t.apply(this,arguments);if(t.length===0&&(arguments.length===0||typeof i!="function"))return t.apply(this,[]);const s=function(c){const d={};return c.result().forEach(l=>{const h={id:l.id,timestamp:l.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[l.type]||l.type};l.names().forEach(p=>{h[p]=l.stat(p)}),d[h.id]=h}),d},a=function(c){return new Map(Object.keys(c).map(d=>[d,c[d]]))};if(arguments.length>=2){const c=function(d){r(a(s(d)))};return t.apply(this,[c,i])}return new Z((c,d)=>{t.apply(this,[function(l){c(a(s(l)))},d])}).then(r,o)}}function rO(e){if(!(typeof e=="object"&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const i=e.RTCPeerConnection.prototype.getSenders;i&&(e.RTCPeerConnection.prototype.getSenders=function(){const o=i.apply(this,[]);return o.forEach(s=>s._pc=this),o});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const o=r.apply(this,arguments);return o._pc=this,o}),e.RTCRtpSender.prototype.getStats=function(){const o=this;return this._pc.getStats().then(s=>Jb(s,o.track,!0))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const i=e.RTCPeerConnection.prototype.getReceivers;i&&(e.RTCPeerConnection.prototype.getReceivers=function(){const r=i.apply(this,[]);return r.forEach(o=>o._pc=this),r}),qa(e,"track",r=>(r.receiver._pc=r.srcElement,r)),e.RTCRtpReceiver.prototype.getStats=function(){const r=this;return this._pc.getStats().then(o=>Jb(o,r.track,!1))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const i=arguments[0];let r,o,s;return this.getSenders().forEach(a=>{a.track===i&&(r?s=!0:r=a)}),this.getReceivers().forEach(a=>(a.track===i&&(o?s=!0:o=a),a.track===i)),s||r&&o?Z.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():o?o.getStats():Z.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function nO(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(s=>this._shimmedLocalStreams[s][0])};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(s,a){if(!a)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const c=t.apply(this,arguments);return this._shimmedLocalStreams[a.id]?this._shimmedLocalStreams[a.id].indexOf(c)===-1&&this._shimmedLocalStreams[a.id].push(c):this._shimmedLocalStreams[a.id]=[a,c],c};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(s){this._shimmedLocalStreams=this._shimmedLocalStreams||{},s.getTracks().forEach(d=>{if(this.getSenders().find(h=>h.track===d))throw new DOMException("Track already exists.","InvalidAccessError")});const a=this.getSenders();i.apply(this,arguments);const c=this.getSenders().filter(d=>a.indexOf(d)===-1);this._shimmedLocalStreams[s.id]=[s].concat(c)};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[s.id],r.apply(this,arguments)};const o=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},s&&Object.keys(this._shimmedLocalStreams).forEach(a=>{const c=this._shimmedLocalStreams[a].indexOf(s);c!==-1&&this._shimmedLocalStreams[a].splice(c,1),this._shimmedLocalStreams[a].length===1&&delete this._shimmedLocalStreams[a]}),o.apply(this,arguments)}}function oO(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return nO(e);const i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const d=i.apply(this);return this._reverseStreams=this._reverseStreams||{},d.map(l=>this._reverseStreams[l.id])};const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(d){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},d.getTracks().forEach(l=>{if(this.getSenders().find(p=>p.track===l))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[d.id]){const l=new e.MediaStream(d.getTracks());this._streams[d.id]=l,this._reverseStreams[l.id]=d,d=l}r.apply(this,[d])};const o=e.RTCPeerConnection.prototype.removeStream;function s(d,l){let h=l.sdp;return Object.keys(d._reverseStreams||[]).forEach(p=>{const f=d._reverseStreams[p],m=d._streams[f.id];h=h.replace(new RegExp(m.id,"g"),f.id)}),new RTCSessionDescription({type:l.type,sdp:h})}e.RTCPeerConnection.prototype.removeStream=function(d){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},o.apply(this,[this._streams[d.id]||d]),delete this._reverseStreams[this._streams[d.id]?this._streams[d.id].id:d.id],delete this._streams[d.id]},e.RTCPeerConnection.prototype.addTrack=function(d,l){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const h=[].slice.call(arguments,1);if(h.length!==1||!h[0].getTracks().find(m=>m===d))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(m=>m.track===d))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const f=this._streams[l.id];if(f)f.addTrack(d),Z.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const m=new e.MediaStream([d]);this._streams[l.id]=m,this._reverseStreams[m.id]=l,this.addStream(m)}return this.getSenders().find(m=>m.track===d)},["createOffer","createAnswer"].forEach(function(d){const l=e.RTCPeerConnection.prototype[d],h={[d](){const p=arguments;return arguments.length&&typeof arguments[0]=="function"?l.apply(this,[f=>{const m=s(this,f);p[0].apply(null,[m])},f=>{p[1]&&p[1].apply(null,f)},arguments[2]]):l.apply(this,arguments).then(f=>s(this,f))}};e.RTCPeerConnection.prototype[d]=h[d]});const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(d,l){let h=l.sdp;return Object.keys(d._reverseStreams||[]).forEach(p=>{const f=d._reverseStreams[p],m=d._streams[f.id];h=h.replace(new RegExp(f.id,"g"),m.id)}),new RTCSessionDescription({type:l.type,sdp:h})}(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const d=c.get.apply(this);return d.type===""?d:s(this,d)}}),e.RTCPeerConnection.prototype.removeTrack=function(d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!d._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(d._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let l;this._streams=this._streams||{},Object.keys(this._streams).forEach(h=>{this._streams[h].getTracks().find(p=>d.track===p)&&(l=this._streams[h])}),l&&(l.getTracks().length===1?this.removeStream(this._reverseStreams[l.id]):l.removeTrack(d.track),this.dispatchEvent(new Event("negotiationneeded")))}}function uS(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(i){const r=e.RTCPeerConnection.prototype[i],o={[i](){return arguments[0]=new(i==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};e.RTCPeerConnection.prototype[i]=o[i]})}function sO(e,t){qa(e,"negotiationneeded",i=>{const r=i.target;if(!(t.version<72||r.getConfiguration&&r.getConfiguration().sdpSemantics==="plan-b")||r.signalingState==="stable")return i})}var aO=Object.freeze({__proto__:null,fixNegotiationNeeded:sO,shimAddTrackRemoveTrack:oO,shimAddTrackRemoveTrackWithNative:nO,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(typeof t=="function"?e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then(r=>{const o=i.video&&i.video.width,s=i.video&&i.video.height,a=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:r,maxFrameRate:a||3}},o&&(i.video.mandatory.maxWidth=o),s&&(i.video.mandatory.maxHeight=s),e.navigator.mediaDevices.getUserMedia(i)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:tO,shimGetStats:iO,shimGetUserMedia:Zb,shimMediaStream:$b,shimOnTrack:eO,shimPeerConnection:uS,shimSenderReceiverGetStats:rO});function cO(e,t){const i=e&&e.navigator,r=e&&e.MediaStreamTrack;if(i.getUserMedia=function(o,s,a){dS("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(o).then(s,a)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const o=function(a,c,d){c in a&&!(d in a)&&(a[d]=a[c],delete a[c])},s=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(a){return typeof a=="object"&&typeof a.audio=="object"&&(a=JSON.parse(JSON.stringify(a)),o(a.audio,"autoGainControl","mozAutoGainControl"),o(a.audio,"noiseSuppression","mozNoiseSuppression")),s(a)},r&&r.prototype.getSettings){const a=r.prototype.getSettings;r.prototype.getSettings=function(){const c=a.apply(this,arguments);return o(c,"mozAutoGainControl","autoGainControl"),o(c,"mozNoiseSuppression","noiseSuppression"),c}}if(r&&r.prototype.applyConstraints){const a=r.prototype.applyConstraints;r.prototype.applyConstraints=function(c){return this.kind==="audio"&&typeof c=="object"&&(c=JSON.parse(JSON.stringify(c)),o(c,"autoGainControl","mozAutoGainControl"),o(c,"noiseSuppression","mozNoiseSuppression")),a.apply(this,[c])}}}}function dO(e){typeof e=="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function hS(e,t){if(typeof e!="object"||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(o){const s=e.RTCPeerConnection.prototype[o],a={[o](){return arguments[0]=new(o==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};e.RTCPeerConnection.prototype[o]=a[o]});const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[o,s,a]=arguments;return r.apply(this,[o||null]).then(c=>{if(t.version<53&&!s)try{c.forEach(d=>{d.type=i[d.type]||d.type})}catch(d){if(d.name!=="TypeError")throw d;c.forEach((l,h)=>{c.set(h,Object.assign({},l,{type:i[l.type]||l.type}))})}return c}).then(s,a)}}function lO(e){if(typeof e!="object"||!e.RTCPeerConnection||!e.RTCRtpSender||e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const r=t.apply(this,[]);return r.forEach(o=>o._pc=this),r});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const r=i.apply(this,arguments);return r._pc=this,r}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Z.resolve(new Map)}}function uO(e){if(typeof e!="object"||!e.RTCPeerConnection||!e.RTCRtpSender||e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const i=t.apply(this,[]);return i.forEach(r=>r._pc=this),i}),qa(e,"track",i=>(i.receiver._pc=i.srcElement,i)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function hO(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(t){dS("removeStream","removeTrack"),this.getSenders().forEach(i=>{var r;i.track&&z(r=t.getTracks()).call(r,i.track)&&this.removeTrack(i)})})}function pO(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function _O(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let i=arguments[1]&&arguments[1].sendEncodings;i===void 0&&(i=[]),i=[...i];const r=i.length>0;r&&i.forEach(s=>{if("rid"in s&&!/^[a-z0-9]{0,16}$/i.test(s.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in s&&!(parseFloat(s.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in s&&!(parseFloat(s.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const o=t.apply(this,arguments);if(r){const{sender:s}=o,a=s.getParameters();(!("encodings"in a)||a.encodings.length===1&&Object.keys(a.encodings[0]).length===0)&&(a.encodings=i,s.sendEncodings=i,this.setParametersPromises.push(s.setParameters(a).then(()=>{delete s.sendEncodings}).catch(()=>{delete s.sendEncodings})))}return o})}function fO(e){if(typeof e!="object"||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const i=t.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function mO(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Z.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function EO(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Z.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}var gO=Object.freeze({__proto__:null,shimAddTransceiver:_O,shimCreateAnswer:EO,shimCreateOffer:mO,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,Z.reject(r)}return i.video===!0?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})},shimGetParameters:fO,shimGetUserMedia:cO,shimOnTrack:dO,shimPeerConnection:hS,shimRTCDataChannel:pO,shimReceiverGetStats:uO,shimRemoveStream:hO,shimSenderGetStats:lO});function SO(e){if(typeof e=="object"&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(i){var r;this._localStreams||(this._localStreams=[]),z(r=this._localStreams).call(r,i)||this._localStreams.push(i),i.getAudioTracks().forEach(o=>t.call(this,o,i)),i.getVideoTracks().forEach(o=>t.call(this,o,i))},e.RTCPeerConnection.prototype.addTrack=function(i){for(var r=arguments.length,o=new Array(r>1?r-1:0),s=1;s<r;s++)o[s-1]=arguments[s];return o&&o.forEach(a=>{var c;this._localStreams?z(c=this._localStreams).call(c,a)||this._localStreams.push(a):this._localStreams=[a]}),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const i=this._localStreams.indexOf(t);if(i===-1)return;this._localStreams.splice(i,1);const r=t.getTracks();this.getSenders().forEach(o=>{z(r).call(r,o.track)&&this.removeTrack(o)})})}}function TO(e){if(typeof e=="object"&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(i){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=i),this.addEventListener("track",this._onaddstreampoly=r=>{r.streams.forEach(o=>{var s;if(this._remoteStreams||(this._remoteStreams=[]),z(s=this._remoteStreams).call(s,o))return;this._remoteStreams.push(o);const a=new Event("addstream");a.stream=o,this.dispatchEvent(a)})})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(o=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(o)>=0)return;i._remoteStreams.push(o);const s=new Event("addstream");s.stream=o,i.dispatchEvent(s)})}),t.apply(i,arguments)}}}function RO(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,i=t.createOffer,r=t.createAnswer,o=t.setLocalDescription,s=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(d,l){const h=arguments.length>=2?arguments[2]:arguments[0],p=i.apply(this,[h]);return l?(p.then(d,l),Z.resolve()):p},t.createAnswer=function(d,l){const h=arguments.length>=2?arguments[2]:arguments[0],p=r.apply(this,[h]);return l?(p.then(d,l),Z.resolve()):p};let c=function(d,l,h){const p=o.apply(this,[d]);return h?(p.then(l,h),Z.resolve()):p};t.setLocalDescription=c,c=function(d,l,h){const p=s.apply(this,[d]);return h?(p.then(l,h),Z.resolve()):p},t.setRemoteDescription=c,c=function(d,l,h){const p=a.apply(this,[d]);return h?(p.then(l,h),Z.resolve()):p},t.addIceCandidate=c}function vO(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const i=t.mediaDevices,r=i.getUserMedia.bind(i);t.mediaDevices.getUserMedia=o=>r(CO(o))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=(function(i,r,o){t.mediaDevices.getUserMedia(i).then(r,o)}).bind(t))}function CO(e){return e&&e.video!==void 0?Object.assign({},e,{video:Xb(e.video)}):e}function yO(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(i,r){if(i&&i.iceServers){const o=[];for(let s=0;s<i.iceServers.length;s++){let a=i.iceServers[s];!a.hasOwnProperty("urls")&&a.hasOwnProperty("url")?(dS("RTCIceServer.url","RTCIceServer.urls"),a=JSON.parse(JSON.stringify(a)),a.urls=a.url,delete a.url,o.push(a)):o.push(i.iceServers[s])}i.iceServers=o}return new t(i,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function IO(e){typeof e=="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function AO(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(i){if(i){i.offerToReceiveAudio!==void 0&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);const r=this.getTransceivers().find(s=>s.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):i.offerToReceiveAudio!==!0||r||this.addTransceiver("audio",{direction:"recvonly"}),i.offerToReceiveVideo!==void 0&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);const o=this.getTransceivers().find(s=>s.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&o?o.direction==="sendrecv"?o.setDirection?o.setDirection("sendonly"):o.direction="sendonly":o.direction==="recvonly"&&(o.setDirection?o.setDirection("inactive"):o.direction="inactive"):i.offerToReceiveVideo!==!0||o||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function wO(e){typeof e!="object"||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var bO=Object.freeze({__proto__:null,shimAudioContext:wO,shimCallbacksAPI:RO,shimConstraints:CO,shimCreateOfferLegacy:AO,shimGetUserMedia:vO,shimLocalStreamsAPI:SO,shimRTCIceServerUrls:yO,shimRemoteStreamsAPI:TO,shimTrackEventTransceiver:IO}),OO=`	
\v\f\r \u2028\u2029\uFEFF`,wH=Vs,bH=xr,pS=OO,NO=he("".replace),OH=RegExp("^["+pS+"]+"),NH=RegExp("(^|[^"+pS+"])["+pS+"]+$"),DH=function(e){return function(t){var i=bH(wH(t));return 1&e&&(i=NO(i,OH,"")),2&e&&(i=NO(i,NH,"$1")),i}},PH={trim:DH(3)},LH=hA.PROPER,kH=P,DO=OO,MH=PH.trim;qe({target:"String",proto:!0,forced:function(e){return kH(function(){return!!DO[e]()||""[e]()!==""||LH&&DO[e].name!==e})}("trim")},{trim:function(){return MH(this)}});var UH=ln("String","trim"),xH=me,VH=UH,_S=String.prototype,FH=function(e){var t=e.trim;return typeof e=="string"||e===_S||xH(_S,e)&&t===_S.trim?VH:t},rr=A(FH),PO={exports:{}};(function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(i){return i.trim().split(`
`).map(r=>r.trim())},t.splitSections=function(i){return i.split(`
m=`).map((r,o)=>(o>0?"m="+r:r).trim()+`\r
`)},t.getDescription=function(i){const r=t.splitSections(i);return r&&r[0]},t.getMediaSections=function(i){const r=t.splitSections(i);return r.shift(),r},t.matchPrefix=function(i,r){return t.splitLines(i).filter(o=>o.indexOf(r)===0)},t.parseCandidate=function(i){let r;r=i.indexOf("a=candidate:")===0?i.substring(12).split(" "):i.substring(10).split(" ");const o={foundation:r[0],component:{1:"rtp",2:"rtcp"}[r[1]]||r[1],protocol:r[2].toLowerCase(),priority:parseInt(r[3],10),ip:r[4],address:r[4],port:parseInt(r[5],10),type:r[7]};for(let s=8;s<r.length;s+=2)switch(r[s]){case"raddr":o.relatedAddress=r[s+1];break;case"rport":o.relatedPort=parseInt(r[s+1],10);break;case"tcptype":o.tcpType=r[s+1];break;case"ufrag":o.ufrag=r[s+1],o.usernameFragment=r[s+1];break;default:o[r[s]]===void 0&&(o[r[s]]=r[s+1])}return o},t.writeCandidate=function(i){const r=[];r.push(i.foundation);const o=i.component;o==="rtp"?r.push(1):o==="rtcp"?r.push(2):r.push(o),r.push(i.protocol.toUpperCase()),r.push(i.priority),r.push(i.address||i.ip),r.push(i.port);const s=i.type;return r.push("typ"),r.push(s),s!=="host"&&i.relatedAddress&&i.relatedPort&&(r.push("raddr"),r.push(i.relatedAddress),r.push("rport"),r.push(i.relatedPort)),i.tcpType&&i.protocol.toLowerCase()==="tcp"&&(r.push("tcptype"),r.push(i.tcpType)),(i.usernameFragment||i.ufrag)&&(r.push("ufrag"),r.push(i.usernameFragment||i.ufrag)),"candidate:"+r.join(" ")},t.parseIceOptions=function(i){return i.substring(14).split(" ")},t.parseRtpMap=function(i){let r=i.substring(9).split(" ");const o={payloadType:parseInt(r.shift(),10)};return r=r[0].split("/"),o.name=r[0],o.clockRate=parseInt(r[1],10),o.channels=r.length===3?parseInt(r[2],10):1,o.numChannels=o.channels,o},t.writeRtpMap=function(i){let r=i.payloadType;i.preferredPayloadType!==void 0&&(r=i.preferredPayloadType);const o=i.channels||i.numChannels||1;return"a=rtpmap:"+r+" "+i.name+"/"+i.clockRate+(o!==1?"/"+o:"")+`\r
`},t.parseExtmap=function(i){const r=i.substring(9).split(" ");return{id:parseInt(r[0],10),direction:r[0].indexOf("/")>0?r[0].split("/")[1]:"sendrecv",uri:r[1],attributes:r.slice(2).join(" ")}},t.writeExtmap=function(i){return"a=extmap:"+(i.id||i.preferredId)+(i.direction&&i.direction!=="sendrecv"?"/"+i.direction:"")+" "+i.uri+(i.attributes?" "+i.attributes:"")+`\r
`},t.parseFmtp=function(i){const r={};let o;const s=i.substring(i.indexOf(" ")+1).split(";");for(let a=0;a<s.length;a++)o=s[a].trim().split("="),r[o[0].trim()]=o[1];return r},t.writeFmtp=function(i){let r="",o=i.payloadType;if(i.preferredPayloadType!==void 0&&(o=i.preferredPayloadType),i.parameters&&Object.keys(i.parameters).length){const s=[];Object.keys(i.parameters).forEach(a=>{i.parameters[a]!==void 0?s.push(a+"="+i.parameters[a]):s.push(a)}),r+="a=fmtp:"+o+" "+s.join(";")+`\r
`}return r},t.parseRtcpFb=function(i){const r=i.substring(i.indexOf(" ")+1).split(" ");return{type:r.shift(),parameter:r.join(" ")}},t.writeRtcpFb=function(i){let r="",o=i.payloadType;return i.preferredPayloadType!==void 0&&(o=i.preferredPayloadType),i.rtcpFeedback&&i.rtcpFeedback.length&&i.rtcpFeedback.forEach(s=>{r+="a=rtcp-fb:"+o+" "+s.type+(s.parameter&&s.parameter.length?" "+s.parameter:"")+`\r
`}),r},t.parseSsrcMedia=function(i){const r=i.indexOf(" "),o={ssrc:parseInt(i.substring(7,r),10)},s=i.indexOf(":",r);return s>-1?(o.attribute=i.substring(r+1,s),o.value=i.substring(s+1)):o.attribute=i.substring(r+1),o},t.parseSsrcGroup=function(i){const r=i.substring(13).split(" ");return{semantics:r.shift(),ssrcs:r.map(o=>parseInt(o,10))}},t.getMid=function(i){const r=t.matchPrefix(i,"a=mid:")[0];if(r)return r.substring(6)},t.parseFingerprint=function(i){const r=i.substring(14).split(" ");return{algorithm:r[0].toLowerCase(),value:r[1].toUpperCase()}},t.getDtlsParameters=function(i,r){return{role:"auto",fingerprints:t.matchPrefix(i+r,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(i,r){let o="a=setup:"+r+`\r
`;return i.fingerprints.forEach(s=>{o+="a=fingerprint:"+s.algorithm+" "+s.value+`\r
`}),o},t.parseCryptoLine=function(i){const r=i.substring(9).split(" ");return{tag:parseInt(r[0],10),cryptoSuite:r[1],keyParams:r[2],sessionParams:r.slice(3)}},t.writeCryptoLine=function(i){return"a=crypto:"+i.tag+" "+i.cryptoSuite+" "+(typeof i.keyParams=="object"?t.writeCryptoKeyParams(i.keyParams):i.keyParams)+(i.sessionParams?" "+i.sessionParams.join(" "):"")+`\r
`},t.parseCryptoKeyParams=function(i){if(i.indexOf("inline:")!==0)return null;const r=i.substring(7).split("|");return{keyMethod:"inline",keySalt:r[0],lifeTime:r[1],mkiValue:r[2]?r[2].split(":")[0]:void 0,mkiLength:r[2]?r[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(i){return i.keyMethod+":"+i.keySalt+(i.lifeTime?"|"+i.lifeTime:"")+(i.mkiValue&&i.mkiLength?"|"+i.mkiValue+":"+i.mkiLength:"")},t.getCryptoParameters=function(i,r){return t.matchPrefix(i+r,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(i,r){const o=t.matchPrefix(i+r,"a=ice-ufrag:")[0],s=t.matchPrefix(i+r,"a=ice-pwd:")[0];return o&&s?{usernameFragment:o.substring(12),password:s.substring(10)}:null},t.writeIceParameters=function(i){let r="a=ice-ufrag:"+i.usernameFragment+`\r
a=ice-pwd:`+i.password+`\r
`;return i.iceLite&&(r+=`a=ice-lite\r
`),r},t.parseRtpParameters=function(i){const r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},o=t.splitLines(i)[0].split(" ");r.profile=o[2];for(let a=3;a<o.length;a++){const c=o[a],d=t.matchPrefix(i,"a=rtpmap:"+c+" ")[0];if(d){const l=t.parseRtpMap(d),h=t.matchPrefix(i,"a=fmtp:"+c+" ");switch(l.parameters=h.length?t.parseFmtp(h[0]):{},l.rtcpFeedback=t.matchPrefix(i,"a=rtcp-fb:"+c+" ").map(t.parseRtcpFb),r.codecs.push(l),l.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(l.name.toUpperCase())}}}t.matchPrefix(i,"a=extmap:").forEach(a=>{r.headerExtensions.push(t.parseExtmap(a))});const s=t.matchPrefix(i,"a=rtcp-fb:* ").map(t.parseRtcpFb);return r.codecs.forEach(a=>{s.forEach(c=>{a.rtcpFeedback.find(d=>d.type===c.type&&d.parameter===c.parameter)||a.rtcpFeedback.push(c)})}),r},t.writeRtpDescription=function(i,r){let o="";o+="m="+i+" ",o+=r.codecs.length>0?"9":"0",o+=" "+(r.profile||"UDP/TLS/RTP/SAVPF")+" ",o+=r.codecs.map(a=>a.preferredPayloadType!==void 0?a.preferredPayloadType:a.payloadType).join(" ")+`\r
`,o+=`c=IN IP4 0.0.0.0\r
`,o+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,r.codecs.forEach(a=>{o+=t.writeRtpMap(a),o+=t.writeFmtp(a),o+=t.writeRtcpFb(a)});let s=0;return r.codecs.forEach(a=>{a.maxptime>s&&(s=a.maxptime)}),s>0&&(o+="a=maxptime:"+s+`\r
`),r.headerExtensions&&r.headerExtensions.forEach(a=>{o+=t.writeExtmap(a)}),o},t.parseRtpEncodingParameters=function(i){const r=[],o=t.parseRtpParameters(i),s=o.fecMechanisms.indexOf("RED")!==-1,a=o.fecMechanisms.indexOf("ULPFEC")!==-1,c=t.matchPrefix(i,"a=ssrc:").map(f=>t.parseSsrcMedia(f)).filter(f=>f.attribute==="cname"),d=c.length>0&&c[0].ssrc;let l;const h=t.matchPrefix(i,"a=ssrc-group:FID").map(f=>f.substring(17).split(" ").map(m=>parseInt(m,10)));h.length>0&&h[0].length>1&&h[0][0]===d&&(l=h[0][1]),o.codecs.forEach(f=>{if(f.name.toUpperCase()==="RTX"&&f.parameters.apt){let m={ssrc:d,codecPayloadType:parseInt(f.parameters.apt,10)};d&&l&&(m.rtx={ssrc:l}),r.push(m),s&&(m=JSON.parse(JSON.stringify(m)),m.fec={ssrc:d,mechanism:a?"red+ulpfec":"red"},r.push(m))}}),r.length===0&&d&&r.push({ssrc:d});let p=t.matchPrefix(i,"b=");return p.length&&(p=p[0].indexOf("b=TIAS:")===0?parseInt(p[0].substring(7),10):p[0].indexOf("b=AS:")===0?1e3*parseInt(p[0].substring(5),10)*.95-16e3:void 0,r.forEach(f=>{f.maxBitrate=p})),r},t.parseRtcpParameters=function(i){const r={},o=t.matchPrefix(i,"a=ssrc:").map(c=>t.parseSsrcMedia(c)).filter(c=>c.attribute==="cname")[0];o&&(r.cname=o.value,r.ssrc=o.ssrc);const s=t.matchPrefix(i,"a=rtcp-rsize");r.reducedSize=s.length>0,r.compound=s.length===0;const a=t.matchPrefix(i,"a=rtcp-mux");return r.mux=a.length>0,r},t.writeRtcpParameters=function(i){let r="";return i.reducedSize&&(r+=`a=rtcp-rsize\r
`),i.mux&&(r+=`a=rtcp-mux\r
`),i.ssrc!==void 0&&i.cname&&(r+="a=ssrc:"+i.ssrc+" cname:"+i.cname+`\r
`),r},t.parseMsid=function(i){let r;const o=t.matchPrefix(i,"a=msid:");if(o.length===1)return r=o[0].substring(7).split(" "),{stream:r[0],track:r[1]};const s=t.matchPrefix(i,"a=ssrc:").map(a=>t.parseSsrcMedia(a)).filter(a=>a.attribute==="msid");return s.length>0?(r=s[0].value.split(" "),{stream:r[0],track:r[1]}):void 0},t.parseSctpDescription=function(i){const r=t.parseMLine(i),o=t.matchPrefix(i,"a=max-message-size:");let s;o.length>0&&(s=parseInt(o[0].substring(19),10)),isNaN(s)&&(s=65536);const a=t.matchPrefix(i,"a=sctp-port:");if(a.length>0)return{port:parseInt(a[0].substring(12),10),protocol:r.fmt,maxMessageSize:s};const c=t.matchPrefix(i,"a=sctpmap:");if(c.length>0){const d=c[0].substring(10).split(" ");return{port:parseInt(d[0],10),protocol:d[1],maxMessageSize:s}}},t.writeSctpDescription=function(i,r){let o=[];return o=i.protocol!=="DTLS/SCTP"?["m="+i.kind+" 9 "+i.protocol+" "+r.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+r.port+`\r
`]:["m="+i.kind+" 9 "+i.protocol+" "+r.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+r.port+" "+r.protocol+` 65535\r
`],r.maxMessageSize!==void 0&&o.push("a=max-message-size:"+r.maxMessageSize+`\r
`),o.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(i,r,o){let s;const a=r!==void 0?r:2;return s=i||t.generateSessionId(),`v=0\r
o=`+(o||"thisisadapterortc")+" "+s+" "+a+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},t.getDirection=function(i,r){const o=t.splitLines(i);for(let s=0;s<o.length;s++)switch(o[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return o[s].substring(2)}return r?t.getDirection(r):"sendrecv"},t.getKind=function(i){return t.splitLines(i)[0].split(" ")[0].substring(2)},t.isRejected=function(i){return i.split(" ",2)[1]==="0"},t.parseMLine=function(i){const r=t.splitLines(i)[0].substring(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},t.parseOLine=function(i){const r=t.matchPrefix(i,"o=")[0].substring(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},t.isValidSDP=function(i){if(typeof i!="string"||i.length===0)return!1;const r=t.splitLines(i);for(let o=0;o<r.length;o++)if(r[o].length<2||r[o].charAt(1)!=="=")return!1;return!0},e.exports=t})(PO);var LO=PO.exports,Od=A(LO),BH=E({__proto__:null,default:Od},[LO]);function n_(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&((i=JSON.parse(JSON.stringify(i))).candidate=i.candidate.substr(2)),i.candidate&&i.candidate.length){const r=new t(i),o=Od.parseCandidate(i.candidate),s=Object.assign(r,o);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new t(i)},e.RTCIceCandidate.prototype=t.prototype,qa(e,"icecandidate",i=>(i.candidate&&Object.defineProperty(i,"candidate",{value:new e.RTCIceCandidate(i.candidate),writable:"false"}),i))}function fS(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||qa(e,"icecandidate",t=>{if(t.candidate){const i=Od.parseCandidate(t.candidate.candidate);i.type==="relay"&&(t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[i.priority>>24])}return t})}function o_(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});const i=function(c){if(!c||!c.sdp)return!1;const d=Od.splitSections(c.sdp);return d.shift(),d.some(l=>{const h=Od.parseMLine(l);return h&&h.kind==="application"&&h.protocol.indexOf("SCTP")!==-1})},r=function(c){const d=c.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(d===null||d.length<2)return-1;const l=parseInt(d[1],10);return l!=l?-1:l},o=function(c){let d=65536;return t.browser==="firefox"&&(d=t.version<57?c===-1?16384:2147483637:t.version<60?t.version===57?65535:65536:2147483637),d},s=function(c,d){let l=65536;t.browser==="firefox"&&t.version===57&&(l=65535);const h=Od.matchPrefix(c.sdp,"a=max-message-size:");return h.length>0?l=parseInt(h[0].substr(19),10):t.browser==="firefox"&&d!==-1&&(l=2147483637),l},a=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){const{sdpSemantics:c}=this.getConfiguration();c==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){const c=r(arguments[0]),d=o(c),l=s(arguments[0],c);let h;h=d===0&&l===0?Number.POSITIVE_INFINITY:d===0||l===0?Math.max(d,l):Math.min(d,l);const p={};Object.defineProperty(p,"maxMessageSize",{get:()=>h}),this._sctp=p}return a.apply(this,arguments)}}function s_(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(r,o){const s=r.send;r.send=function(){const a=arguments[0],c=a.length||a.size||a.byteLength;if(r.readyState==="open"&&o.sctp&&c>o.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+o.sctp.maxMessageSize+" bytes)");return s.apply(r,arguments)}}const i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const r=i.apply(this,arguments);return t(r,this),r},qa(e,"datachannel",r=>(t(r.channel,r.target),r))}function mS(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(i){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),i&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=i)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(i=>{const r=t[i];t[i]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=o=>{const s=o.target;if(s._lastConnectionState!==s.connectionState){s._lastConnectionState=s.connectionState;const a=new Event("connectionstatechange",o);s.dispatchEvent(a)}return o},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}})}function ES(e,t){if(!e.RTCPeerConnection||t.browser==="chrome"&&t.version>=71||t.browser==="safari"&&t.version>=605)return;const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&r.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const o=r.sdp.split(`
`).filter(s=>rr(s).call(s)!=="a=extmap-allow-mixed").join(`
`);e.RTCSessionDescription&&r instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:r.type,sdp:o}):r.sdp=o}return i.apply(this,arguments)}}function a_(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.addIceCandidate;i&&i.length!==0&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Z.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Z.resolve())})}function c_(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.setLocalDescription;i&&i.length!==0&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if(typeof r!="object"||r.type&&r.sdp)return i.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer"}return r.sdp||r.type!=="offer"&&r.type!=="answer"?i.apply(this,[r]):(r.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(o=>i.apply(this,[o]))})}var jH=Object.freeze({__proto__:null,removeExtmapAllowMixed:ES,shimAddIceCandidateNullOrEmpty:a_,shimConnectionState:mS,shimMaxMessageSize:o_,shimParameterlessSetLocalDescription:c_,shimRTCIceCandidate:n_,shimRTCIceCandidateRelayProtocol:fS,shimSendThrowTypeError:s_});(function(){let{window:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const i=zb,r=function(s){const a={browser:null,version:null};if(s===void 0||!s.navigator)return a.browser="Not a browser.",a;const{navigator:c}=s;if(c.mozGetUserMedia)a.browser="firefox",a.version=r_(c.userAgent,/Firefox\/(\d+)\./,1);else if(c.webkitGetUserMedia||s.isSecureContext===!1&&s.webkitRTCPeerConnection)a.browser="chrome",a.version=r_(c.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!s.RTCPeerConnection||!c.userAgent.match(/AppleWebKit\/(\d+)\./))return a.browser="Not a supported browser.",a;a.browser="safari",a.version=r_(c.userAgent,/AppleWebKit\/(\d+)\./,1),a.supportsUnifiedPlan=s.RTCRtpTransceiver&&"currentDirection"in s.RTCRtpTransceiver.prototype}return a}(e),o={browserDetails:r,commonShim:jH,extractVersion:r_,disableLog:IH,disableWarnings:AH,sdp:BH};switch(r.browser){case"chrome":if(!aO||!uS||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),o;if(r.version===null)return i("Chrome shim can not determine version, not shimming."),o;i("adapter.js shimming chrome."),o.browserShim=aO,a_(e,r),c_(e),Zb(e,r),$b(e),uS(e,r),eO(e),oO(e,r),tO(e),iO(e),rO(e),sO(e,r),n_(e),fS(e),mS(e),o_(e,r),s_(e),ES(e,r);break;case"firefox":if(!gO||!hS||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),o;i("adapter.js shimming firefox."),o.browserShim=gO,a_(e,r),c_(e),cO(e,r),hS(e,r),dO(e),hO(e),lO(e),uO(e),pO(e),_O(e),fO(e),mO(e),EO(e),n_(e),mS(e),o_(e,r),s_(e);break;case"safari":if(!bO||!t.shimSafari)return i("Safari shim is not included in this adapter release."),o;i("adapter.js shimming safari."),o.browserShim=bO,a_(e,r),c_(e),yO(e),AO(e),RO(e),SO(e),TO(e),IO(e),vO(e),wO(e),n_(e),fS(e),o_(e,r),s_(e),ES(e,r);break;default:i("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var GH=P,kO=ve.RegExp,WH=!GH(function(){var e=!0;try{kO(".","d")}catch{e=!1}var t={},i="",r=e?"dgimsy":"gimsy",o=function(c,d){Object.defineProperty(t,c,{get:function(){return i+=d,!0}})},s={dotAll:"s",global:"g",ignoreCase:"i",multiline:"m",sticky:"y"};for(var a in e&&(s.hasIndices="d"),s)o(a,s[a]);return Object.getOwnPropertyDescriptor(kO.prototype,"flags").get.call(t)!==r||i!==r}),HH=Ur,KH=gi,YH=Bi,zH=me,MO={correct:WH},qH=function(){var e=HH(this),t="";return e.hasIndices&&(t+="d"),e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.unicodeSets&&(t+="v"),e.sticky&&(t+="y"),t},XH=RegExp.prototype,gS=MO.correct?function(e){return e.flags}:function(e){return MO.correct||!zH(XH,e)||YH(e,"flags")?e.flags:KH(qH,e)},SS=he,JH=Math.floor,TS=SS("".charAt),QH=SS("".replace),RS=SS("".slice),ZH=/\$([$&'`]|\d{1,2})/g,$H=qe,eK=gi,vS=he,UO=Vs,tK=ci,iK=ir,rK=yE,Nd=xr,nK=Jl,oK=gS,sK=function(e,t,i,r,o,s){var a=i+e.length,c=r.length,d=ZH;return QH(s,d,function(l,h){var p;switch(TS(h,0)){case"$":return"$";case"&":return e;case"`":return RS(t,0,i);case"'":return RS(t,a);case"<":p=o[RS(h,1,-1)];break;default:var f=+h;if(f===0)return l;if(f>c){var m=JH(f/10);return m===0?l:m<=c?r[m-1]===void 0?TS(h,1):r[m-1]+TS(h,1):l}p=r[f-1]}return p===void 0?"":p})},aK=qt("replace"),cK=TypeError,CS=vS("".indexOf),dK=vS("".replace),xO=vS("".slice),lK=Math.max;$H({target:"String",proto:!0},{replaceAll:function(e,t){var i,r,o,s,a,c,d,l,h,p,f=UO(this),m=0,g="";if(iK(e)){if((i=rK(e))&&(r=Nd(UO(oK(e))),!~CS(r,"g")))throw new cK("`.replaceAll` does not allow non-global regexes");if(o=nK(e,aK))return eK(o,e,f,t);if(i)return dK(Nd(f),e,t)}for(s=Nd(f),a=Nd(e),(c=tK(t))||(t=Nd(t)),d=a.length,l=lK(1,d),h=CS(s,a);h!==-1;)p=c?Nd(t(a,h,s)):sK(a,s,h,[],void 0,t),g+=xO(s,m,h)+p,m=h+d,h=h+l>s.length?-1:CS(s,a,h+l);return m<s.length&&(g+=xO(s,m)),g}});var uK=ln("String","replaceAll"),hK=me,pK=uK,yS=String.prototype,_K=function(e){var t=e.replaceAll;return typeof e=="string"||e===yS||hK(yS,e)&&t===yS.replaceAll?pK:t},fK=A(_K),IS=ve;qe({global:!0,forced:IS.globalThis!==IS},{globalThis:IS});var VO=A(ve),AS={exports:{}};(function(e,t){(function(i,r){var o="function",s="undefined",a="object",c="string",d="major",l="model",h="name",p="type",f="vendor",m="version",g="architecture",S="console",T="mobile",C="tablet",b="smarttv",D="wearable",x="embedded",k="Amazon",V="Apple",W="ASUS",K="BlackBerry",J="Browser",se="Chrome",Ne="Firefox",Ce="Google",De="Honor",Me="Huawei",et="LG",ae="Microsoft",Y="Motorola",ie="Nvidia",Q="OnePlus",w="Opera",v="OPPO",N="Samsung",j="Sharp",ne="Sony",Ve="Xiaomi",wt="Zebra",Ji="Facebook",Ro="Chromium OS",cl="Mac OS",nh=" Browser",oh=function(ti){for(var Ot={},si=0;si<ti.length;si++)Ot[ti[si].toUpperCase()]=ti[si];return Ot},jl=function(ti,Ot){return typeof ti===c&&dl(Ot).indexOf(dl(ti))!==-1},dl=function(ti){return ti.toLowerCase()},ll=function(ti,Ot){if(typeof ti===c)return ti=ti.replace(/^\s\s*/,""),typeof Ot===s?ti:ti.substring(0,500)},Pa=function(ti,Ot){for(var si,dn,Fi,qi,kt,Lt,gs=0;gs<Ot.length&&!kt;){var Ms=Ot[gs],np=Ot[gs+1];for(si=dn=0;si<Ms.length&&!kt&&Ms[si];)if(kt=Ms[si++].exec(ti))for(Fi=0;Fi<np.length;Fi++)Lt=kt[++dn],typeof(qi=np[Fi])===a&&qi.length>0?qi.length===2?typeof qi[1]==o?this[qi[0]]=qi[1].call(this,Lt):this[qi[0]]=qi[1]:qi.length===3?typeof qi[1]!==o||qi[1].exec&&qi[1].test?this[qi[0]]=Lt?Lt.replace(qi[1],qi[2]):r:this[qi[0]]=Lt?qi[1].call(this,Lt,qi[2]):r:qi.length===4&&(this[qi[0]]=Lt?qi[3].call(this,Lt.replace(qi[1],qi[2])):r):this[qi]=Lt||r;gs+=2}},sh=function(ti,Ot){for(var si in Ot)if(typeof Ot[si]===a&&Ot[si].length>0){for(var dn=0;dn<Ot[si].length;dn++)if(jl(Ot[si][dn],ti))return si==="?"?r:si}else if(jl(Ot[si],ti))return si==="?"?r:si;return Ot.hasOwnProperty("*")?Ot["*"]:ti},h1={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Qc={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[m,[h,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[m,[h,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[h,m],[/opios[\/ ]+([\w\.]+)/i],[m,[h,w+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[m,[h,w+" GX"]],[/\bopr\/([\w\.]+)/i],[m,[h,w]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[m,[h,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[m,[h,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon)\/([-\w\.]+)/i,/(heytap|ovi|115)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[h,m],[/quark(?:pc)?\/([-\w\.]+)/i],[m,[h,"Quark"]],[/\bddg\/([\w\.]+)/i],[m,[h,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[m,[h,"UC"+J]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[m,[h,"WeChat"]],[/konqueror\/([\w\.]+)/i],[m,[h,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[m,[h,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[m,[h,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[m,[h,"Smart Lenovo "+J]],[/(avast|avg)\/([\w\.]+)/i],[[h,/(.+)/,"$1 Secure "+J],m],[/\bfocus\/([\w\.]+)/i],[m,[h,Ne+" Focus"]],[/\bopt\/([\w\.]+)/i],[m,[h,w+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[m,[h,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[m,[h,"Dolphin"]],[/coast\/([\w\.]+)/i],[m,[h,w+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[m,[h,"MIUI"+nh]],[/fxios\/([\w\.-]+)/i],[m,[h,Ne]],[/\bqihoobrowser\/?([\w\.]*)/i],[m,[h,"360"]],[/\b(qq)\/([\w\.]+)/i],[[h,/(.+)/,"$1Browser"],m],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[h,/(.+)/,"$1"+nh],m],[/samsungbrowser\/([\w\.]+)/i],[m,[h,N+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[m,[h,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[h,"Sogou Mobile"],m],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[h,m],[/(lbbrowser|rekonq)/i,/\[(linkedin)app\]/i],[h],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[m,h],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[h,Ji],m],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/(daum)apps[\/ ]([\w\.]+)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[h,m],[/\bgsa\/([\w\.]+) .*safari\//i],[m,[h,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[m,[h,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[m,[h,se+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[h,se+" WebView"],m],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[m,[h,"Android "+J]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[h,m],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[m,[h,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[m,h],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[h,[m,sh,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[h,m],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[h,"Netscape"],m],[/(wolvic|librewolf)\/([\w\.]+)/i],[h,m],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[m,[h,Ne+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(amaya|dillo|doris|icab|ladybird|lynx|mosaic|netsurf|obigo|polaris|w3m|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/\b(links) \(([\w\.]+)/i],[h,[m,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[h,[m,/master.|lts./,""]]],cpu:[[/\b((amd|x|x86[-_]?|wow|win)64)\b/i],[[g,"amd64"]],[/(ia32(?=;))/i,/\b((i[346]|x)86)(pc)?\b/i],[[g,"ia32"]],[/\b(aarch64|arm(v?[89]e?l?|_?64))\b/i],[[g,"arm64"]],[/\b(arm(v[67])?ht?n?[fl]p?)\b/i],[[g,"armhf"]],[/( (ce|mobile); ppc;|\/[\w\.]+arm\b)/i],[[g,"arm"]],[/((ppc|powerpc)(64)?)( mac|;|\))/i],[[g,/ower/,"",dl]],[/ sun4\w[;\)]/i],[[g,"sparc"]],[/\b(avr32|ia64(?=;)|68k(?=\))|\barm(?=v([1-7]|[5-7]1)l?|;|eabi)|(irix|mips|sparc)(64)?\b|pa-risc)/i],[[g,dl]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[l,[f,N],[p,C]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr])[-\w]+)/i,/sec-(sgh\w+)/i],[l,[f,N],[p,T]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[l,[f,V],[p,T]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[l,[f,V],[p,C]],[/(macintosh);/i],[l,[f,V]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[l,[f,j],[p,T]],[/\b((?:brt|eln|hey2?|gdi|jdn)-a?[lnw]09|(?:ag[rm]3?|jdn2|kob2)-a?[lw]0[09]hn)(?: bui|\)|;)/i],[l,[f,De],[p,C]],[/honor([-\w ]+)[;\)]/i],[l,[f,De],[p,T]],[/\b((?:ag[rs][2356]?k?|bah[234]?|bg[2o]|bt[kv]|cmr|cpn|db[ry]2?|jdn2|got|kob2?k?|mon|pce|scm|sht?|[tw]gr|vrd)-[ad]?[lw][0125][09]b?|605hw|bg2-u03|(?:gem|fdr|m2|ple|t1)-[7a]0[1-4][lu]|t1-a2[13][lw]|mediapad[\w\. ]*(?= bui|\)))\b(?!.+d\/s)/i],[l,[f,Me],[p,C]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[l,[f,Me],[p,T]],[/oid[^\)]+; (2[\dbc]{4}(182|283|rp\w{2})[cgl]|m2105k81a?c)(?: bui|\))/i,/\b((?:red)?mi[-_ ]?pad[\w- ]*)(?: bui|\))/i],[[l,/_/g," "],[f,Ve],[p,C]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i,/ ([\w ]+) miui\/v?\d/i],[[l,/_/g," "],[f,Ve],[p,T]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[l,[f,v],[p,T]],[/\b(opd2(\d{3}a?))(?: bui|\))/i],[l,[f,sh,{OnePlus:["304","403","203"],"*":v}],[p,C]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[l,[f,"Vivo"],[p,T]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[l,[f,"Realme"],[p,T]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto(?! 360)[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[l,[f,Y],[p,T]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[l,[f,Y],[p,C]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[l,[f,et],[p,C]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv|watch)\w+)/i,/\blg-?([\d\w]+) bui/i],[l,[f,et],[p,T]],[/(ideatab[-\w ]+|602lv|d-42a|a101lv|a2109a|a3500-hv|s[56]000|pb-6505[my]|tb-?x?\d{3,4}(?:f[cu]|xu|[av])|yt\d?-[jx]?\d+[lfmx])( bui|;|\)|\/)/i,/lenovo ?(b[68]0[08]0-?[hf]?|tab(?:[\w- ]+?)|tb[\w-]{6,7})( bui|;|\)|\/)/i],[l,[f,"Lenovo"],[p,C]],[/(nokia) (t[12][01])/i],[f,l,[p,C]],[/(?:maemo|nokia).*(n900|lumia \d+|rm-\d+)/i,/nokia[-_ ]?(([-\w\. ]*))/i],[[l,/_/g," "],[p,T],[f,"Nokia"]],[/(pixel (c|tablet))\b/i],[l,[f,Ce],[p,C]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[l,[f,Ce],[p,T]],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[l,[f,ne],[p,T]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[l,"Xperia Tablet"],[f,ne],[p,C]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[l,[f,Q],[p,T]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[l,[f,k],[p,C]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[l,/(.+)/g,"Fire Phone $1"],[f,k],[p,T]],[/(playbook);[-\w\),; ]+(rim)/i],[l,f,[p,C]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[l,[f,K],[p,T]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[l,[f,W],[p,C]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[l,[f,W],[p,T]],[/(nexus 9)/i],[l,[f,"HTC"],[p,C]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[f,[l,/_/g," "],[p,T]],[/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])\w*(\)| bui)/i],[l,[f,"TCL"],[p,C]],[/(itel) ((\w+))/i],[[f,dl],l,[p,sh,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[l,[f,"Acer"],[p,C]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[l,[f,"Meizu"],[p,T]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[l,[f,"Ulefone"],[p,T]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[l,[f,"Energizer"],[p,T]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[l,[f,"Cat"],[p,T]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[l,[f,"Smartfren"],[p,T]],[/droid.+; (a(?:015|06[35]|142p?))/i],[l,[f,"Nothing"],[p,T]],[/; (x67 5g|tikeasy \w+|ac[1789]\d\w+)( b|\))/i,/archos ?(5|gamepad2?|([\w ]*[t1789]|hello) ?\d+[\w ]*)( b|\))/i],[l,[f,"Archos"],[p,C]],[/archos ([\w ]+)( b|\))/i,/; (ac[3-6]\d\w{2,8})( b|\))/i],[l,[f,"Archos"],[p,T]],[/(imo) (tab \w+)/i,/(infinix) (x1101b?)/i],[f,l,[p,C]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus(?! zenw)|dell|jolla|meizu|motorola|polytron|infinix|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (hmd|imo) ([\w ]+?)(?: bui|\))/i,/(hp) ([\w ]+\w)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w ]+?)(?: bui|\)|\/)/i,/(oppo) ?([\w ]+) bui/i],[f,l,[p,T]],[/(kobo)\s(ereader|touch)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[f,l,[p,C]],[/(surface duo)/i],[l,[f,ae],[p,C]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[l,[f,"Fairphone"],[p,T]],[/(u304aa)/i],[l,[f,"AT&T"],[p,T]],[/\bsie-(\w*)/i],[l,[f,"Siemens"],[p,T]],[/\b(rct\w+) b/i],[l,[f,"RCA"],[p,C]],[/\b(venue[\d ]{2,7}) b/i],[l,[f,"Dell"],[p,C]],[/\b(q(?:mv|ta)\w+) b/i],[l,[f,"Verizon"],[p,C]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[l,[f,"Barnes & Noble"],[p,C]],[/\b(tm\d{3}\w+) b/i],[l,[f,"NuVision"],[p,C]],[/\b(k88) b/i],[l,[f,"ZTE"],[p,C]],[/\b(nx\d{3}j) b/i],[l,[f,"ZTE"],[p,T]],[/\b(gen\d{3}) b.+49h/i],[l,[f,"Swiss"],[p,T]],[/\b(zur\d{3}) b/i],[l,[f,"Swiss"],[p,C]],[/\b((zeki)?tb.*\b) b/i],[l,[f,"Zeki"],[p,C]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[f,"Dragon Touch"],l,[p,C]],[/\b(ns-?\w{0,9}) b/i],[l,[f,"Insignia"],[p,C]],[/\b((nxa|next)-?\w{0,9}) b/i],[l,[f,"NextBook"],[p,C]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[f,"Voice"],l,[p,T]],[/\b(lvtel\-)?(v1[12]) b/i],[[f,"LvTel"],l,[p,T]],[/\b(ph-1) /i],[l,[f,"Essential"],[p,T]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[l,[f,"Envizen"],[p,C]],[/\b(trio[-\w\. ]+) b/i],[l,[f,"MachSpeed"],[p,C]],[/\btu_(1491) b/i],[l,[f,"Rotor"],[p,C]],[/((?:tegranote|shield t(?!.+d tv))[\w- ]*?)(?: b|\))/i],[l,[f,ie],[p,C]],[/(sprint) (\w+)/i],[f,l,[p,T]],[/(kin\.[onetw]{3})/i],[[l,/\./g," "],[f,ae],[p,T]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[l,[f,wt],[p,C]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[l,[f,wt],[p,T]],[/smart-tv.+(samsung)/i],[f,[p,b]],[/hbbtv.+maple;(\d+)/i],[[l,/^/,"SmartTV"],[f,N],[p,b]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[f,et],[p,b]],[/(apple) ?tv/i],[f,[l,V+" TV"],[p,b]],[/crkey/i],[[l,se+"cast"],[f,Ce],[p,b]],[/droid.+aft(\w+)( bui|\))/i],[l,[f,k],[p,b]],[/(shield \w+ tv)/i],[l,[f,ie],[p,b]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[l,[f,j],[p,b]],[/(bravia[\w ]+)( bui|\))/i],[l,[f,ne],[p,b]],[/(mi(tv|box)-?\w+) bui/i],[l,[f,Ve],[p,b]],[/Hbbtv.*(technisat) (.*);/i],[f,l,[p,b]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[f,ll],[l,ll],[p,b]],[/droid.+; ([\w- ]+) (?:android tv|smart[- ]?tv)/i],[l,[p,b]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[p,b]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[f,l,[p,S]],[/droid.+; (shield)( bui|\))/i],[l,[f,ie],[p,S]],[/(playstation \w+)/i],[l,[f,ne],[p,S]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[l,[f,ae],[p,S]],[/\b(sm-[lr]\d\d[0156][fnuw]?s?|gear live)\b/i],[l,[f,N],[p,D]],[/((pebble))app/i,/(asus|google|lg|oppo) ((pixel |zen)?watch[\w ]*)( bui|\))/i],[f,l,[p,D]],[/(ow(?:19|20)?we?[1-3]{1,3})/i],[l,[f,v],[p,D]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[l,[f,V],[p,D]],[/(opwwe\d{3})/i],[l,[f,Q],[p,D]],[/(moto 360)/i],[l,[f,Y],[p,D]],[/(smartwatch 3)/i],[l,[f,ne],[p,D]],[/(g watch r)/i],[l,[f,et],[p,D]],[/droid.+; (wt63?0{2,3})\)/i],[l,[f,wt],[p,D]],[/droid.+; (glass) \d/i],[l,[f,Ce],[p,D]],[/(pico) (4|neo3(?: link|pro)?)/i],[f,l,[p,D]],[/; (quest( \d| pro)?)/i],[l,[f,Ji],[p,D]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[f,[p,x]],[/(aeobc)\b/i],[l,[f,k],[p,x]],[/(homepod).+mac os/i],[l,[f,V],[p,x]],[/windows iot/i],[[p,x]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[l,[p,T]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[l,[p,C]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[p,C]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[p,T]],[/droid .+?; ([\w\. -]+)( bui|\))/i],[l,[f,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[m,[h,"EdgeHTML"]],[/(arkweb)\/([\w\.]+)/i],[h,m],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[m,[h,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[h,m],[/ladybird\//i],[[h,"LibWeb"]],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[m,h]],os:[[/microsoft (windows) (vista|xp)/i],[h,m],[/(windows (?:phone(?: os)?|mobile|iot))[\/ ]?([\d\.\w ]*)/i],[h,[m,sh,h1]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[m,sh,h1],[h,"Windows"]],[/[adehimnop]{4,7}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[m,/_/g,"."],[h,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[h,cl],[m,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[m,h],[/(ubuntu) ([\w\.]+) like android/i],[[h,/(.+)/,"$1 Touch"],m],[/(android|bada|blackberry|kaios|maemo|meego|openharmony|qnx|rim tablet os|sailfish|series40|symbian|tizen|webos)\w*[-\/; ]?([\d\.]*)/i],[h,m],[/\(bb(10);/i],[m,[h,K]],[/(?:symbian ?os|symbos|s60(?=;)|series ?60)[-\/ ]?([\w\.]*)/i],[m,[h,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[m,[h,Ne+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[m,[h,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[m,[h,"watchOS"]],[/crkey\/([\d\.]+)/i],[m,[h,se+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[h,Ro],m],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux)(?: arm\w*| x86\w*| ?)([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[h,m],[/(sunos) ?([\w\.\d]*)/i],[[h,"Solaris"],m],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[h,m]]},ks=function(ti,Ot){if(typeof ti===a&&(Ot=ti,ti=r),!(this instanceof ks))return new ks(ti,Ot).getResult();var si=typeof i!==s&&i.navigator?i.navigator:r,dn=ti||(si&&si.userAgent?si.userAgent:""),Fi=si&&si.userAgentData?si.userAgentData:r,qi=Ot?function(Lt,gs){var Ms={};for(var np in Lt)gs[np]&&gs[np].length%2==0?Ms[np]=gs[np].concat(Lt[np]):Ms[np]=Lt[np];return Ms}(Qc,Ot):Qc,kt=si&&si.userAgent==dn;return this.getBrowser=function(){var Lt={};return Lt[h]=r,Lt[m]=r,Pa.call(Lt,dn,qi.browser),Lt[d]=function(gs){return typeof gs===c?gs.replace(/[^\d\.]/g,"").split(".")[0]:r}(Lt[m]),kt&&si&&si.brave&&typeof si.brave.isBrave==o&&(Lt[h]="Brave"),Lt},this.getCPU=function(){var Lt={};return Lt[g]=r,Pa.call(Lt,dn,qi.cpu),Lt},this.getDevice=function(){var Lt={};return Lt[f]=r,Lt[l]=r,Lt[p]=r,Pa.call(Lt,dn,qi.device),kt&&!Lt[p]&&Fi&&Fi.mobile&&(Lt[p]=T),kt&&Lt[l]=="Macintosh"&&si&&typeof si.standalone!==s&&si.maxTouchPoints&&si.maxTouchPoints>2&&(Lt[l]="iPad",Lt[p]=C),Lt},this.getEngine=function(){var Lt={};return Lt[h]=r,Lt[m]=r,Pa.call(Lt,dn,qi.engine),Lt},this.getOS=function(){var Lt={};return Lt[h]=r,Lt[m]=r,Pa.call(Lt,dn,qi.os),kt&&!Lt[h]&&Fi&&Fi.platform&&Fi.platform!="Unknown"&&(Lt[h]=Fi.platform.replace(/chrome os/i,Ro).replace(/macos/i,cl)),Lt},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return dn},this.setUA=function(Lt){return dn=typeof Lt===c&&Lt.length>500?ll(Lt,500):Lt,this},this.setUA(dn),this};ks.VERSION="0.7.41",ks.BROWSER=oh([h,m,d]),ks.CPU=oh([g]),ks.DEVICE=oh([l,f,p,S,T,b,C,D,x]),ks.ENGINE=ks.OS=oh([h,m]),e.exports&&(t=e.exports=ks),t.UAParser=ks;var ah=typeof i!==s&&(i.jQuery||i.Zepto);if(ah&&!ah.ua){var Or=new ks;ah.ua=Or.getResult(),ah.ua.get=function(){return Or.getUA()},ah.ua.set=function(ti){Or.setUA(ti);var Ot=Or.getResult();for(var si in Ot)ah.ua[si]=Ot[si]}}})(typeof window=="object"?window:R)})(AS,AS.exports);var mK=A(AS.exports),FO=Mp.clear;qe({global:!0,bind:!0,forced:ve.clearImmediate!==FO},{clearImmediate:FO});var BO=ve,EK=fe,gK=ci,SK=bE,TK=rs,RK=Hs,vK=Wa,CK=BO.Function,yK=/MSIE .\./.test(TK)||SK==="BUN"&&function(){var e=BO.Bun.version.split(".");return e.length<3||e[0]==="0"&&(e[1]<3||e[1]==="3"&&e[2]==="0")}(),IK=qe,jO=ve,GO=Mp.set,AK=function(e,t){var i=1;return yK?function(r,o){var s=vK(arguments.length,1)>i,a=gK(r)?r:CK(r),c=s?RK(arguments,i):[],d=s?function(){EK(a,this,c)}:a;return e(d)}:e},WO=jO.setImmediate?AK(GO):GO;IK({global:!0,bind:!0,forced:jO.setImmediate!==WO},{setImmediate:WO});var HO=A(Qr.setImmediate),wK=ve,bK=QA,OK=Zr,NK=Wa,DK=ur;qe({global:!0,dontCallGetSet:!0,forced:P(function(){return DK&&Object.getOwnPropertyDescriptor(wK,"queueMicrotask").value.length!==1})},{queueMicrotask:function(e){NK(arguments.length,1),bK(OK(e))}});var KO=A(Qr.queueMicrotask);function YO(e,t){return function(){return e.apply(t,arguments)}}const{toString:PK}=Object.prototype,{getPrototypeOf:wS}=Object,{iterator:d_,toStringTag:zO}=Symbol,l_=(bS=Object.create(null),e=>{const t=PK.call(e);return bS[t]||(bS[t]=t.slice(8,-1).toLowerCase())});var bS;const so=e=>(e=e.toLowerCase(),t=>l_(t)===e),u_=e=>t=>typeof t===e,{isArray:Dd}=Array,Pd=u_("undefined");function Su(e){return e!==null&&!Pd(e)&&e.constructor!==null&&!Pd(e.constructor)&&$r(e.constructor.isBuffer)&&e.constructor.isBuffer(e)}const qO=so("ArrayBuffer"),LK=u_("string"),$r=u_("function"),XO=u_("number"),Tu=e=>e!==null&&typeof e=="object",h_=e=>{if(l_(e)!=="object")return!1;const t=wS(e);return!(t!==null&&t!==Object.prototype&&Object.getPrototypeOf(t)!==null||zO in e||d_ in e)},kK=so("Date"),MK=so("File"),UK=so("Blob"),xK=so("FileList"),VK=so("URLSearchParams"),[FK,BK,jK,GK]=["ReadableStream","Request","Response","Headers"].map(so);function Ru(e,t){let i,r,{allOwnKeys:o=!1}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(e!=null)if(typeof e!="object"&&(e=[e]),Dd(e))for(i=0,r=e.length;i<r;i++)t.call(null,e[i],i,e);else{if(Su(e))return;const s=o?Object.getOwnPropertyNames(e):Object.keys(e),a=s.length;let c;for(i=0;i<a;i++)c=s[i],t.call(null,e[c],c,e)}}function JO(e,t){if(Su(e))return null;t=t.toLowerCase();const i=Object.keys(e);let r,o=i.length;for(;o-- >0;)if(r=i[o],t===r.toLowerCase())return r;return null}const Xa=VO!==void 0?VO:typeof self<"u"?self:typeof window<"u"?window:dx,QO=e=>!Pd(e)&&e!==Xa,WK=(OS=typeof Uint8Array<"u"&&wS(Uint8Array),e=>OS&&e instanceof OS);var OS;const HK=so("HTMLFormElement"),ZO=(e=>{let{hasOwnProperty:t}=e;return(i,r)=>t.call(i,r)})(Object.prototype),KK=so("RegExp"),$O=(e,t)=>{const i=Object.getOwnPropertyDescriptors(e),r={};Ru(i,(o,s)=>{let a;(a=t(o,s,e))!==!1&&(r[s]=a||o)}),Object.defineProperties(e,r)},YK=so("AsyncFunction"),e0=(t0=typeof HO=="function",i0=$r(Xa.postMessage),t0?HO:i0?(NS="axios@".concat(Math.random()),p_=[],Xa.addEventListener("message",e=>{let{source:t,data:i}=e;t===Xa&&i===NS&&p_.length&&p_.shift()()},!1),e=>{p_.push(e),Xa.postMessage(NS,"*")}):e=>setTimeout(e));var t0,i0,NS,p_;const zK=KO!==void 0?KO.bind(Xa):typeof process<"u"&&process.nextTick||e0;var te={isArray:Dd,isArrayBuffer:qO,isBuffer:Su,isFormData:e=>{let t;return e&&(typeof FormData=="function"&&e instanceof FormData||$r(e.append)&&((t=l_(e))==="formdata"||t==="object"&&$r(e.toString)&&e.toString()==="[object FormData]"))},isArrayBufferView:function(e){let t;return t=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&qO(e.buffer),t},isString:LK,isNumber:XO,isBoolean:e=>e===!0||e===!1,isObject:Tu,isPlainObject:h_,isEmptyObject:e=>{if(!Tu(e)||Su(e))return!1;try{return Object.keys(e).length===0&&Object.getPrototypeOf(e)===Object.prototype}catch{return!1}},isReadableStream:FK,isRequest:BK,isResponse:jK,isHeaders:GK,isUndefined:Pd,isDate:kK,isFile:MK,isBlob:UK,isRegExp:KK,isFunction:$r,isStream:e=>Tu(e)&&$r(e.pipe),isURLSearchParams:VK,isTypedArray:WK,isFileList:xK,forEach:Ru,merge:function e(){const{caseless:t,skipUndefined:i}=QO(this)&&this||{},r={},o=(s,a)=>{const c=t&&JO(r,a)||a;h_(r[c])&&h_(s)?r[c]=e(r[c],s):h_(s)?r[c]=e({},s):Dd(s)?r[c]=s.slice():i&&Pd(s)||(r[c]=s)};for(let s=0,a=arguments.length;s<a;s++)arguments[s]&&Ru(arguments[s],o);return r},extend:function(e,t,i){let{allOwnKeys:r}=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};return Ru(t,(o,s)=>{i&&$r(o)?e[s]=YO(o,i):e[s]=o},{allOwnKeys:r}),e},trim:e=>rr(e)?rr(e).call(e):e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:e=>(e.charCodeAt(0)===65279&&(e=e.slice(1)),e),inherits:(e,t,i,r)=>{e.prototype=Object.create(t.prototype,r),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),i&&Object.assign(e.prototype,i)},toFlatObject:(e,t,i,r)=>{let o,s,a;const c={};if(t=t||{},e==null)return t;do{for(o=Object.getOwnPropertyNames(e),s=o.length;s-- >0;)a=o[s],r&&!r(a,e,t)||c[a]||(t[a]=e[a],c[a]=!0);e=i!==!1&&wS(e)}while(e&&(!i||i(e,t))&&e!==Object.prototype);return t},kindOf:l_,kindOfTest:so,endsWith:(e,t,i)=>{e=String(e),(i===void 0||i>e.length)&&(i=e.length),i-=t.length;const r=e.indexOf(t,i);return r!==-1&&r===i},toArray:e=>{if(!e)return null;if(Dd(e))return e;let t=e.length;if(!XO(t))return null;const i=new Array(t);for(;t-- >0;)i[t]=e[t];return i},forEachEntry:(e,t)=>{const i=(e&&e[d_]).call(e);let r;for(;(r=i.next())&&!r.done;){const o=r.value;t.call(e,o[0],o[1])}},matchAll:(e,t)=>{let i;const r=[];for(;(i=e.exec(t))!==null;)r.push(i);return r},isHTMLForm:HK,hasOwnProperty:ZO,hasOwnProp:ZO,reduceDescriptors:$O,freezeMethods:e=>{$O(e,(t,i)=>{if($r(e)&&["arguments","caller","callee"].indexOf(i)!==-1)return!1;const r=e[i];$r(r)&&(t.enumerable=!1,"writable"in t?t.writable=!1:t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+i+"'")}))})},toObjectSet:(e,t)=>{const i={},r=o=>{o.forEach(s=>{i[s]=!0})};return Dd(e)?r(e):r(String(e).split(t)),i},toCamelCase:e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(t,i,r){return i.toUpperCase()+r}),noop:()=>{},toFiniteNumber:(e,t)=>e!=null&&Number.isFinite(e=+e)?e:t,findKey:JO,global:Xa,isContextDefined:QO,isSpecCompliantForm:function(e){return!!(e&&$r(e.append)&&e[zO]==="FormData"&&e[d_])},toJSONObject:e=>{const t=new Array(10),i=(r,o)=>{if(Tu(r)){if(t.indexOf(r)>=0)return;if(Su(r))return r;if(!("toJSON"in r)){t[o]=r;const s=Dd(r)?[]:{};return Ru(r,(a,c)=>{const d=i(a,o+1);!Pd(d)&&(s[c]=d)}),t[o]=void 0,s}}return r};return i(e,0)},isAsyncFn:YK,isThenable:e=>e&&(Tu(e)||$r(e))&&$r(e.then)&&$r(e.catch),setImmediate:e0,asap:zK,isIterable:e=>e!=null&&$r(e[d_])};function nt(e,t,i,r,o){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=e,this.name="AxiosError",t&&(this.code=t),i&&(this.config=i),r&&(this.request=r),o&&(this.response=o,this.status=o.status?o.status:null)}te.inherits(nt,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:te.toJSONObject(this.config),code:this.code,status:this.status}}});const r0=nt.prototype,n0={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(e=>{n0[e]={value:e}}),Object.defineProperties(nt,n0),Object.defineProperty(r0,"isAxiosError",{value:!0}),nt.from=(e,t,i,r,o,s)=>{const a=Object.create(r0);te.toFlatObject(e,a,function(l){return l!==Error.prototype},l=>l!=="isAxiosError");const c=e&&e.message?e.message:"Error",d=t==null&&e?e.code:t;return nt.call(a,c,d,i,r,o),e&&a.cause==null&&Object.defineProperty(a,"cause",{value:e,configurable:!0}),a.name=e&&e.name||"Error",s&&Object.assign(a,s),a};function DS(e){return te.isPlainObject(e)||te.isArray(e)}function o0(e){return te.endsWith(e,"[]")?e.slice(0,-2):e}function s0(e,t,i){return e?e.concat(t).map(function(r,o){return r=o0(r),!i&&o?"["+r+"]":r}).join(i?".":""):t}const qK=te.toFlatObject(te,{},null,function(e){return/^is[A-Z]/.test(e)});function __(e,t,i){if(!te.isObject(e))throw new TypeError("target must be an object");t=t||new FormData;const r=(i=te.toFlatObject(i,{metaTokens:!0,dots:!1,indexes:!1},!1,function(f,m){return!te.isUndefined(m[f])})).metaTokens,o=i.visitor||l,s=i.dots,a=i.indexes,c=(i.Blob||typeof Blob<"u"&&Blob)&&te.isSpecCompliantForm(t);if(!te.isFunction(o))throw new TypeError("visitor must be a function");function d(f){if(f===null)return"";if(te.isDate(f))return f.toISOString();if(te.isBoolean(f))return f.toString();if(!c&&te.isBlob(f))throw new nt("Blob is not supported. Use a Buffer instead.");return te.isArrayBuffer(f)||te.isTypedArray(f)?c&&typeof Blob=="function"?new Blob([f]):Buffer.from(f):f}function l(f,m,g){let S=f;if(f&&!g&&typeof f=="object"){if(te.endsWith(m,"{}"))m=r?m:m.slice(0,-2),f=JSON.stringify(f);else if(te.isArray(f)&&function(T){return te.isArray(T)&&!T.some(DS)}(f)||(te.isFileList(f)||te.endsWith(m,"[]"))&&(S=te.toArray(f)))return m=o0(m),S.forEach(function(T,C){!te.isUndefined(T)&&T!==null&&t.append(a===!0?s0([m],C,s):a===null?m:m+"[]",d(T))}),!1}return!!DS(f)||(t.append(s0(g,m,s),d(f)),!1)}const h=[],p=Object.assign(qK,{defaultVisitor:l,convertValue:d,isVisitable:DS});if(!te.isObject(e))throw new TypeError("data must be an object");return function f(m,g){if(!te.isUndefined(m)){if(h.indexOf(m)!==-1)throw Error("Circular reference detected in "+g.join("."));h.push(m),te.forEach(m,function(S,T){(!(te.isUndefined(S)||S===null)&&o.call(t,S,te.isString(T)?rr(T).call(T):T,g,p))===!0&&f(S,g?g.concat(T):[T])}),h.pop()}}(e),t}function a0(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,function(i){return t[i]})}function PS(e,t){this._pairs=[],e&&__(e,this,t)}const c0=PS.prototype;function XK(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+")}function d0(e,t,i){if(!t)return e;const r=i&&i.encode||XK;te.isFunction(i)&&(i={serialize:i});const o=i&&i.serialize;let s;if(s=o?o(t,i):te.isURLSearchParams(t)?t.toString():new PS(t,i).toString(r),s){const a=e.indexOf("#");a!==-1&&(e=e.slice(0,a)),e+=(e.indexOf("?")===-1?"?":"&")+s}return e}c0.append=function(e,t){this._pairs.push([e,t])},c0.toString=function(e){const t=e?function(i){return e.call(this,i,a0)}:a0;return this._pairs.map(function(i){return t(i[0])+"="+t(i[1])},"").join("&")};var l0=class{constructor(){this.handlers=[]}use(e,t,i){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){te.forEach(this.handlers,function(t){t!==null&&e(t)})}},u0={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},h0={exports:{}},JK=qe,QK=ur,p0=Mn.f;JK({target:"Object",stat:!0,forced:Object.defineProperty!==p0,sham:!QK},{defineProperty:p0});var _0=Qr.Object,ZK=h0.exports=function(e,t,i){return _0.defineProperty(e,t,i)};_0.defineProperty.sham&&(ZK.sham=!0);var f0=A(h0.exports),$K=TypeError,m0=eu,e8=kp,t8=ir,i8=qt("species"),E0=Array,r8=function(e){var t;return m0(e)&&(t=e.constructor,(e8(t)&&(t===E0||m0(t.prototype))||t8(t)&&(t=t[i8])===null)&&(t=void 0)),t===void 0?E0:t},g0=function(e,t){return new(r8(e))(t===0?0:t)},n8=P,o8=Fa,s8=qt("species"),S0=function(e){return o8>=51||!n8(function(){var t=[];return(t.constructor={})[s8]=function(){return{foo:1}},t[e](Boolean).foo!==1})},a8=qe,c8=P,d8=eu,l8=ir,u8=Co,h8=js,T0=function(e){if(e>9007199254740991)throw $K("Maximum allowed index exceeded");return e},R0=jg,p8=g0,_8=S0,f8=Fa,v0=qt("isConcatSpreadable"),m8=f8>=51||!c8(function(){var e=[];return e[v0]=!1,e.concat()[0]!==e}),E8=function(e){if(!l8(e))return!1;var t=e[v0];return t!==void 0?!!t:d8(e)};a8({target:"Array",proto:!0,forced:!m8||!_8("concat")},{concat:function(e){var t,i,r,o,s,a=u8(this),c=p8(a,0),d=0;for(t=-1,r=arguments.length;t<r;t++)if(E8(s=t===-1?a:arguments[t]))for(o=h8(s),T0(d+o),i=0;i<o;i++,d++)i in s&&R0(c,d,s[i]);else T0(d+1),R0(c,d++,s);return c.length=d,c}});var C0={},g8=dt,S8=Fs,y0=gp.f,T8=Hs,I0=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];C0.f=function(e){return I0&&g8(e)==="Window"?function(t){try{return y0(t)}catch{return T8(I0)}}(e):y0(S8(e))};var Ld={},R8=qt;Ld.f=R8;var A0=Qr,v8=Bi,C8=Ld,y8=Mn.f,Ci=function(e){var t=A0.Symbol||(A0.Symbol={});v8(t,e)||y8(t,e,{value:C8.f(e)})},I8=gi,A8=Sr,w8=qt,b8=Ws,w0=function(){var e=A8("Symbol"),t=e&&e.prototype,i=t&&t.valueOf,r=w8("toPrimitive");t&&!t[r]&&b8(t,r,function(o){return I8(i,this)},{})},O8=Bs,N8=lp,D8=Co,P8=js,L8=g0,oM=he([].push),sM=function(e){var t=e===1,i=e===2,r=e===3,o=e===4,s=e===6,a=e===7,c=e===5||s;return function(d,l,h,p){for(var f,m,g=D8(d),S=N8(g),T=P8(S),C=O8(l,h),b=0,D=p||L8,x=t?D(d,T):i||a?D(d,0):void 0;T>b;b++)if((c||b in S)&&(m=C(f=S[b],b,g),e))if(t)x[b]=m;else if(m)switch(e){case 3:return!0;case 5:return f;case 6:return b;case 2:oM(x,f)}else switch(e){case 4:return!1;case 7:oM(x,f)}return s?-1:r||o?o:x}},LS={forEach:sM(0)},mh=qe,f_=ve,b0=gi,pf=he,kd=ur,_f=nd,Bo=P,jo=Bi,O0=me,ff=Ur,mf=Fs,N0=_E,D0=xr,Eh=kn,m_=iu,aM=Tp,cM=gp,dM=C0,lM=tu,P0=Va,uM=Mn,hM=ME,L0=mt,pM=Ws,k0=Lp,zR=sd,M0=Sp,_M=hE,k8=qt,M8=Ld,U8=Ci,x8=w0,fM=ns,kS=Ga,as=LS.forEach,cs=Ep("hidden"),gh="Symbol",MS="prototype",mM=kS.set,Ic=kS.getterFor(gh),ds=Object[MS],gl=f_.Symbol,qR=gl&&gl[MS],V8=f_.RangeError,U0=f_.TypeError,XR=f_.QObject,Sh=P0.f,Th=uM.f,EM=dM.f,gM=L0.f,Sl=pf([].push),Ja=zR("symbols"),US=zR("op-symbols"),x0=zR("wks"),JR=!XR||!XR[MS]||!XR[MS].findChild,QR=function(e,t,i){var r=Sh(ds,t);r&&delete ds[t],Th(e,t,i),r&&e!==ds&&Th(ds,t,r)},xS=kd&&Bo(function(){return m_(Th({},"a",{get:function(){return Th(this,"a",{value:7}).a}})).a!==7})?QR:Th,Ef=function(e,t){var i=Ja[e]=m_(qR);return mM(i,{type:gh,tag:e,description:t}),kd||(i.description=t),i},gf=function(e,t,i){e===ds&&gf(US,t,i),ff(e);var r=N0(t);return ff(i),jo(Ja,r)?(i.enumerable?(jo(e,cs)&&e[cs][r]&&(e[cs][r]=!1),i=m_(i,{enumerable:Eh(0,!1)})):(jo(e,cs)||Th(e,cs,Eh(1,m_(null))),e[cs][r]=!0),xS(e,r,i)):Th(e,r,i)},ZR=function(e,t){ff(e);var i=mf(t),r=aM(i).concat(j0(i));return as(r,function(o){kd&&!b0(V0,i,o)||gf(e,o,i[o])}),e},V0=function(e){var t=N0(e),i=b0(gM,this,t);return!(this===ds&&jo(Ja,t)&&!jo(US,t))&&(!(i||!jo(this,t)||!jo(Ja,t)||jo(this,cs)&&this[cs][t])||i)},F0=function(e,t){var i=mf(e),r=N0(t);if(i!==ds||!jo(Ja,r)||jo(US,r)){var o=Sh(i,r);return!o||!jo(Ja,r)||jo(i,cs)&&i[cs][r]||(o.enumerable=!0),o}},B0=function(e){var t=EM(mf(e)),i=[];return as(t,function(r){jo(Ja,r)||jo(M0,r)||Sl(i,r)}),i},j0=function(e){var t=e===ds,i=EM(t?US:mf(e)),r=[];return as(i,function(o){!jo(Ja,o)||t&&!jo(ds,o)||Sl(r,Ja[o])}),r};_f||(gl=function(){if(O0(qR,this))throw new U0("Symbol is not a constructor");var e=arguments.length&&arguments[0]!==void 0?D0(arguments[0]):void 0,t=_M(e),i=function(r){var o=this===void 0?f_:this;o===ds&&b0(i,US,r),jo(o,cs)&&jo(o[cs],t)&&(o[cs][t]=!1);var s=Eh(1,r);try{xS(o,t,s)}catch(a){if(!(a instanceof V8))throw a;QR(o,t,s)}};return kd&&JR&&xS(ds,t,{configurable:!0,set:i}),Ef(t,e)},pM(qR=gl[MS],"toString",function(){return Ic(this).tag}),pM(gl,"withoutSetter",function(e){return Ef(_M(e),e)}),L0.f=V0,uM.f=gf,hM.f=ZR,P0.f=F0,cM.f=dM.f=B0,lM.f=j0,M8.f=function(e){return Ef(k8(e),e)},kd&&k0(qR,"description",{configurable:!0,get:function(){return Ic(this).description}})),mh({global:!0,wrap:!0,forced:!_f,sham:!_f},{Symbol:gl}),as(aM(x0),function(e){U8(e)}),mh({target:gh,stat:!0,forced:!_f},{useSetter:function(){JR=!0},useSimple:function(){JR=!1}}),mh({target:"Object",stat:!0,forced:!_f,sham:!kd},{create:function(e,t){return t===void 0?m_(e):ZR(m_(e),t)},defineProperty:gf,defineProperties:ZR,getOwnPropertyDescriptor:F0}),mh({target:"Object",stat:!0,forced:!_f},{getOwnPropertyNames:B0}),x8(),fM(gl,gh),M0[cs]=!0;var SM=nd&&!!Symbol.for&&!!Symbol.keyFor,F8=qe,B8=Sr,j8=Bi,TM=xr,RM=sd,G0=SM,W0=RM("string-to-symbol-registry"),G8=RM("symbol-to-string-registry");F8({target:"Symbol",stat:!0,forced:!G0},{for:function(e){var t=TM(e);if(j8(W0,t))return W0[t];var i=B8("Symbol")(t);return W0[t]=i,G8[i]=t,i}});var W8=qe,H8=Bi,K8=Xl,Y8=od,vM=SM,H0=sd("symbol-to-string-registry");W8({target:"Symbol",stat:!0,forced:!vM},{keyFor:function(e){if(!K8(e))throw new TypeError(Y8(e)+" is not a symbol");if(H8(H0,e))return H0[e]}});var CM=eu,yM=ci,IM=dt,AM=xr,wM=he([].push),bM=qe,K0=Sr,OM=fe,VS=gi,Sf=he,Y0=P,z0=ci,q0=Xl,NM=Hs,z8=function(e){if(yM(e))return e;if(CM(e)){for(var t=e.length,i=[],r=0;r<t;r++){var o=e[r];typeof o=="string"?wM(i,o):typeof o!="number"&&IM(o)!=="Number"&&IM(o)!=="String"||wM(i,AM(o))}var s=i.length,a=!0;return function(c,d){if(a)return a=!1,d;if(CM(this))return d;for(var l=0;l<s;l++)if(i[l]===c)return d}}},q8=nd,Rh=String,Md=K0("JSON","stringify"),FS=Sf(/./.exec),DM=Sf("".charAt),X8=Sf("".charCodeAt),J8=Sf("".replace),Q8=Sf(1.1.toString),PM=/[\uD800-\uDFFF]/g,X0=/^[\uD800-\uDBFF]$/,J0=/^[\uDC00-\uDFFF]$/,Q0=!q8||Y0(function(){var e=K0("Symbol")("stringify detection");return Md([e])!=="[null]"||Md({a:e})!=="{}"||Md(Object(e))!=="{}"}),LM=Y0(function(){return Md("\uDF06\uD834")!=='"\\udf06\\ud834"'||Md("\uDEAD")!=='"\\udead"'}),Z8=function(e,t){var i=NM(arguments),r=z8(t);if(z0(r)||e!==void 0&&!q0(e))return i[1]=function(o,s){if(z0(r)&&(s=VS(r,this,Rh(o),s)),!q0(s))return s},OM(Md,null,i)},kM=function(e,t,i){var r=DM(i,t-1),o=DM(i,t+1);return FS(X0,e)&&!FS(J0,o)||FS(J0,e)&&!FS(X0,r)?"\\u"+Q8(X8(e,0),16):e};Md&&bM({target:"JSON",stat:!0,forced:Q0||LM},{stringify:function(e,t,i){var r=NM(arguments),o=OM(Q0?Z8:Md,null,r);return LM&&typeof o=="string"?J8(o,PM,kM):o}});var MM=tu,$8=Co;qe({target:"Object",stat:!0,forced:!nd||P(function(){MM.f(1)})},{getOwnPropertySymbols:function(e){var t=MM.f;return t?t($8(e)):[]}}),Ci("asyncDispose"),Ci("asyncIterator"),Ci("dispose"),Ci("hasInstance"),Ci("isConcatSpreadable"),Ci("iterator"),Ci("match"),Ci("matchAll"),Ci("replace"),Ci("search"),Ci("species"),Ci("split");var eY=w0;Ci("toPrimitive"),eY();var tY=Sr,iY=ns;Ci("toStringTag"),iY(tY("Symbol"),"Symbol"),Ci("unscopables"),ns(ve.JSON,"JSON",!0);var rY=Qr.Symbol,nY=qt,UM=Mn.f,Z0=nY("metadata"),xM=Function.prototype;xM[Z0]===void 0&&UM(xM,Z0,{value:null}),Ci("metadata");var oY=rY,$0=he,eN=Sr("Symbol"),sY=eN.keyFor,VM=$0(eN.prototype.valueOf),FM=eN.isRegisteredSymbol||function(e){try{return sY(VM(e))!==void 0}catch{return!1}};qe({target:"Symbol",stat:!0},{isRegisteredSymbol:FM});for(var BM=sd,jM=Sr,aY=he,cY=Xl,$R=qt,BS=jM("Symbol"),tN=BS.isWellKnownSymbol,GM=jM("Object","getOwnPropertyNames"),WM=aY(BS.prototype.valueOf),ev=BM("wks"),tv=0,HM=GM(BS),KM=HM.length;tv<KM;tv++)try{var iN=HM[tv];cY(BS[iN])&&$R(iN)}catch{}var E_=function(e){if(tN&&tN(e))return!0;try{for(var t=WM(e),i=0,r=GM(ev),o=r.length;i<o;i++)if(ev[r[i]]==t)return!0}catch{}return!1};qe({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:E_}),Ci("customMatcher"),Ci("observable"),qe({target:"Symbol",stat:!0},{isRegistered:FM}),qe({target:"Symbol",stat:!0,forced:!0},{isWellKnown:E_}),Ci("matcher"),Ci("metadataKey"),Ci("patternMatch"),Ci("replaceAll");var g_=A(oY),Tf=A(Ld.f("iterator"));function jS(e){return jS=typeof g_=="function"&&typeof Tf=="symbol"?function(t){return typeof t}:function(t){return t&&typeof g_=="function"&&t.constructor===g_&&t!==g_.prototype?"symbol":typeof t},jS(e)}var dY=A(Ld.f("toPrimitive"));function U(e){var t=function(i,r){if(jS(i)!="object"||!i)return i;var o=i[dY];if(o!==void 0){var s=o.call(i,r);if(jS(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(r==="string"?String:Number)(i)}(e,"string");return jS(t)=="symbol"?t:t+""}function M(e,t,i){return(t=U(t))in e?f0(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var YM=A(p6),rN={isBrowser:!0,classes:{URLSearchParams:YM!==void 0?YM:PS,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};const GS=typeof window<"u"&&typeof document<"u",nN=typeof navigator=="object"&&navigator||void 0,lY=GS&&(!nN||["ReactNative","NativeScript","NS"].indexOf(nN.product)<0),uY=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",zM=GS&&window.location.href||"http://localhost";function oN(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function ls(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?oN(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):oN(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}var us=ls(ls({},Object.freeze({__proto__:null,hasBrowserEnv:GS,hasStandardBrowserEnv:lY,hasStandardBrowserWebWorkerEnv:uY,navigator:nN,origin:zM})),rN);function qM(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function hY(e,t){return __(e,new us.classes.URLSearchParams,function(i){for(var r=1;r<arguments.length;r++){var o=arguments[r]!=null?arguments[r]:{};r%2?qM(Object(o),!0).forEach(function(s){M(i,s,o[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(o)):qM(Object(o)).forEach(function(s){Object.defineProperty(i,s,Object.getOwnPropertyDescriptor(o,s))})}return i}({visitor:function(i,r,o,s){return us.isNode&&te.isBuffer(i)?(this.append(r,i.toString("base64")),!1):s.defaultVisitor.apply(this,arguments)}},t))}var XM=wg.charAt,JM=gi,pY=Ur,_Y=ci,fY=dt,mY=/./.exec,EY=TypeError,QM=qe,sN=gi,ZM=Ri,iv=qE,WS=Dp,aN=Vs,Rf=wI,HS=xr,gY=Ur,SY=ir,TY=dt,$M=yE,eU=gS,RY=Jl,vY=P,CY=eg,yY=function(e,t,i){return t+(i?XM(e,t).length:1)},tU=function(e,t){var i=e.exec;if(_Y(i)){var r=JM(i,e,t);return r!==null&&pY(r),r}if(fY(e)==="RegExp")return JM(mY,e,t);throw new EY("RegExp#exec called on incompatible receiver")},iU=Ga,rU=qt("matchAll"),cN="RegExp String",nU=cN+" Iterator",IY=iU.set,AY=iU.getterFor(nU),dN=TypeError,vf=ZM("".indexOf),Cf=ZM("".matchAll),lN=!!Cf&&!vY(function(){Cf("a",/./)}),oU=iv(function(e,t,i,r){IY(this,{type:nU,regexp:e,string:t,global:i,unicode:r,done:!1})},cN,function(){var e=AY(this);if(e.done)return WS(void 0,!0);var t=e.regexp,i=e.string,r=tU(t,i);return r===null?(e.done=!0,WS(void 0,!0)):e.global?(HS(r[0])===""&&(t.lastIndex=yY(i,Rf(t.lastIndex),e.unicode)),WS(r,!1)):(e.done=!0,WS(r,!1))}),sU=function(e){var t,i,r,o=gY(this),s=HS(e),a=CY(o,RegExp),c=HS(eU(o));return t=new a(a===RegExp?o.source:o,c),i=!!~vf(c,"g"),r=!!~vf(c,"u"),t.lastIndex=Rf(o.lastIndex),new oU(t,s,i,r)};QM({target:"String",proto:!0,forced:lN},{matchAll:function(e){var t,i,r,o,s=aN(this);if(SY(e)){if($M(e)&&(t=HS(aN(eU(e))),!~vf(t,"g")))throw new dN("`.matchAll` does not allow non-global regexes");if(lN)return Cf(s,e);if((r=RY(e,rU))===void 0&&TY(e)==="RegExp"&&(r=sU),r)return sN(r,e,s)}else if(lN)return Cf(s,e);return i=HS(s),o=new RegExp(e,"g"),sN(sU,o,i)}});var wY=ln("String","matchAll"),bY=me,uN=wY,hN=String.prototype,OY=function(e){var t=e.matchAll;return typeof e=="string"||e===hN||bY(hN,e)&&t===hN.matchAll?uN:t},aU=A(OY);function rv(e){function t(i,r,o,s){let a=i[s++];if(a==="__proto__")return!0;const c=Number.isFinite(+a),d=s>=i.length;return a=!a&&te.isArray(o)?o.length:a,d?(te.hasOwnProp(o,a)?o[a]=[o[a],r]:o[a]=r,!c):(o[a]&&te.isObject(o[a])||(o[a]=[]),t(i,r,o[a],s)&&te.isArray(o[a])&&(o[a]=function(l){const h={},p=Object.keys(l);let f;const m=p.length;let g;for(f=0;f<m;f++)g=p[f],h[g]=l[g];return h}(o[a])),!c)}if(te.isFormData(e)&&te.isFunction(e.entries)){const i={};return te.forEachEntry(e,(r,o)=>{t(function(s){return aU(te).call(te,/\w+|\[(\w*)]/g,s).map(a=>a[0]==="[]"?"":a[1]||a[0])}(r),o,i,0)}),i}return null}const KS={transitional:u0,adapter:["xhr","http","fetch"],transformRequest:[function(e,t){const i=t.getContentType()||"",r=i.indexOf("application/json")>-1,o=te.isObject(e);if(o&&te.isHTMLForm(e)&&(e=new FormData(e)),te.isFormData(e))return r?JSON.stringify(rv(e)):e;if(te.isArrayBuffer(e)||te.isBuffer(e)||te.isStream(e)||te.isFile(e)||te.isBlob(e)||te.isReadableStream(e))return e;if(te.isArrayBufferView(e))return e.buffer;if(te.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let s;if(o){if(i.indexOf("application/x-www-form-urlencoded")>-1)return hY(e,this.formSerializer).toString();if((s=te.isFileList(e))||i.indexOf("multipart/form-data")>-1){const a=this.env&&this.env.FormData;return __(s?{"files[]":e}:e,a&&new a,this.formSerializer)}}return o||r?(t.setContentType("application/json",!1),function(a,c,d){if(te.isString(a))try{return(c||JSON.parse)(a),rr(te).call(te,a)}catch(l){if(l.name!=="SyntaxError")throw l}return(d||JSON.stringify)(a)}(e)):e}],transformResponse:[function(e){const t=this.transitional||KS.transitional,i=t&&t.forcedJSONParsing,r=this.responseType==="json";if(te.isResponse(e)||te.isReadableStream(e))return e;if(e&&te.isString(e)&&(i&&!this.responseType||r)){const o=!(t&&t.silentJSONParsing)&&r;try{return JSON.parse(e,this.parseReviver)}catch(s){if(o)throw s.name==="SyntaxError"?nt.from(s,nt.ERR_BAD_RESPONSE,this,null,this.response):s}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:us.classes.FormData,Blob:us.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};te.forEach(["delete","get","head","post","put","patch"],e=>{KS.headers[e]={}});var pN=KS;const cU=te.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),yf=Symbol("internals");function vh(e){var t;return e&&rr(t=String(e)).call(t).toLowerCase()}function If(e){return e===!1||e==null?e:te.isArray(e)?e.map(If):String(e)}function Af(e,t,i,r,o){return te.isFunction(r)?r.call(this,t,i):(o&&(t=i),te.isString(t)?te.isString(r)?t.indexOf(r)!==-1:te.isRegExp(r)?r.test(t):void 0:void 0)}class ua{constructor(t){t&&this.set(t)}set(t,i,r){const o=this;function s(d,l,h){const p=vh(l);if(!p)throw new Error("header name must be a non-empty string");const f=te.findKey(o,p);(!f||o[f]===void 0||h===!0||h===void 0&&o[f]!==!1)&&(o[f||l]=If(d))}const a=(d,l)=>te.forEach(d,(h,p)=>s(h,p,l));if(te.isPlainObject(t)||t instanceof this.constructor)a(t,i);else if(te.isString(t)&&(t=rr(t).call(t))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(rr(c=t).call(c)))a((d=>{const l={};let h,p,f;return d&&d.split(`
`).forEach(function(m){var g,S;f=m.indexOf(":"),h=rr(g=m.substring(0,f)).call(g).toLowerCase(),p=rr(S=m.substring(f+1)).call(S),!h||l[h]&&cU[h]||(h==="set-cookie"?l[h]?l[h].push(p):l[h]=[p]:l[h]=l[h]?l[h]+", "+p:p)}),l})(t),i);else if(te.isObject(t)&&te.isIterable(t)){let d,l,h={};for(const p of t){if(!te.isArray(p))throw TypeError("Object iterator must return a key-value pair");h[l=p[0]]=(d=h[l])?te.isArray(d)?[...d,p[1]]:[d,p[1]]:p[1]}a(h,i)}else t!=null&&s(i,t,r);var c;return this}get(t,i){if(t=vh(t)){const r=te.findKey(this,t);if(r){const o=this[r];if(!i)return o;if(i===!0)return function(s){const a=Object.create(null),c=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let d;for(;d=c.exec(s);)a[d[1]]=d[2];return a}(o);if(te.isFunction(i))return i.call(this,o,r);if(te.isRegExp(i))return i.exec(o);throw new TypeError("parser must be boolean|regexp|function")}}}has(t,i){if(t=vh(t)){const r=te.findKey(this,t);return!(!r||this[r]===void 0||i&&!Af(0,this[r],r,i))}return!1}delete(t,i){const r=this;let o=!1;function s(a){if(a=vh(a)){const c=te.findKey(r,a);!c||i&&!Af(0,r[c],c,i)||(delete r[c],o=!0)}}return te.isArray(t)?t.forEach(s):s(t),o}clear(t){const i=Object.keys(this);let r=i.length,o=!1;for(;r--;){const s=i[r];t&&!Af(0,this[s],s,t,!0)||(delete this[s],o=!0)}return o}normalize(t){const i=this,r={};return te.forEach(this,(o,s)=>{var a;const c=te.findKey(r,s);if(c)return i[c]=If(o),void delete i[s];const d=t?function(l){return rr(l).call(l).toLowerCase().replace(/([a-z\d])(\w*)/g,(h,p,f)=>p.toUpperCase()+f)}(s):rr(a=String(s)).call(a);d!==s&&delete i[s],i[d]=If(o),r[d]=!0}),this}concat(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];return this.constructor.concat(this,...i)}toJSON(t){const i=Object.create(null);return te.forEach(this,(r,o)=>{r!=null&&r!==!1&&(i[o]=t&&te.isArray(r)?r.join(", "):r)}),i}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(t=>{let[i,r]=t;return i+": "+r}).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(t){return t instanceof this?t:new this(t)}static concat(t){const i=new this(t);for(var r=arguments.length,o=new Array(r>1?r-1:0),s=1;s<r;s++)o[s-1]=arguments[s];return o.forEach(a=>i.set(a)),i}static accessor(t){const i=(this[yf]=this[yf]={accessors:{}}).accessors,r=this.prototype;function o(s){const a=vh(s);i[a]||(function(c,d){const l=te.toCamelCase(" "+d);["get","set","has"].forEach(h=>{Object.defineProperty(c,h+l,{value:function(p,f,m){return this[h].call(this,d,p,f,m)},configurable:!0})})}(r,s),i[a]=!0)}return te.isArray(t)?t.forEach(o):o(t),this}}ua.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),te.reduceDescriptors(ua.prototype,(e,t)=>{let{value:i}=e,r=t[0].toUpperCase()+t.slice(1);return{get:()=>i,set(o){this[r]=o}}}),te.freezeMethods(ua);var Qa=ua;function nv(e,t){const i=this||pN,r=t||i,o=Qa.from(r.headers);let s=r.data;return te.forEach(e,function(a){s=a.call(i,s,o.normalize(),t?t.status:void 0)}),o.normalize(),s}function S_(e){return!(!e||!e.__CANCEL__)}function T_(e,t,i){nt.call(this,e??"canceled",nt.ERR_CANCELED,t,i),this.name="CanceledError"}function YS(e,t,i){const r=i.config.validateStatus;i.status&&r&&!r(i.status)?t(new nt("Request failed with status code "+i.status,[nt.ERR_BAD_REQUEST,nt.ERR_BAD_RESPONSE][Math.floor(i.status/100)-4],i.config,i.request,i)):e(i)}te.inherits(T_,nt,{__CANCEL__:!0});const zS=function(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:3,r=0;const o=function(s,a){s=s||10;const c=new Array(s),d=new Array(s);let l,h=0,p=0;return a=a!==void 0?a:1e3,function(f){const m=Date.now(),g=d[p];l||(l=m),c[h]=f,d[h]=m;let S=p,T=0;for(;S!==h;)T+=c[S++],S%=s;if(h=(h+1)%s,h===p&&(p=(p+1)%s),m-l<a)return;const C=g&&m-g;return C?Math.round(1e3*T/C):void 0}}(50,250);return function(s,a){let c,d,l=0,h=1e3/a;const p=function(f){l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Date.now(),c=null,d&&(clearTimeout(d),d=null),s(...f)};return[function(){const f=Date.now(),m=f-l;for(var g=arguments.length,S=new Array(g),T=0;T<g;T++)S[T]=arguments[T];m>=h?p(S,f):(c=S,d||(d=setTimeout(()=>{d=null,p(c)},h-m)))},()=>c&&p(c)]}(s=>{const a=s.loaded,c=s.lengthComputable?s.total:void 0,d=a-r,l=o(d);r=a,e({loaded:a,total:c,progress:c?a/c:void 0,bytes:d,rate:l||void 0,estimated:l&&c&&a<=c?(c-a)/l:void 0,event:s,lengthComputable:c!=null,[t?"download":"upload"]:!0})},i)},_N=(e,t)=>{const i=e!=null;return[r=>t[0]({lengthComputable:i,total:e,loaded:r}),t[1]]},dU=e=>function(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];return te.asap(()=>e(...i))};var NY=us.hasStandardBrowserEnv?((e,t)=>i=>(i=new i_(i,us.origin),e.protocol===i.protocol&&e.host===i.host&&(t||e.port===i.port)))(new i_(us.origin),us.navigator&&/(msie|trident)/i.test(us.navigator.userAgent)):()=>!0,lU=us.hasStandardBrowserEnv?{write(e,t,i,r,o,s,a){if(typeof document>"u")return;const c=["".concat(e,"=").concat(encodeURIComponent(t))];te.isNumber(i)&&c.push("expires=".concat(new Date(i).toUTCString())),te.isString(r)&&c.push("path=".concat(r)),te.isString(o)&&c.push("domain=".concat(o)),s===!0&&c.push("secure"),te.isString(a)&&c.push("SameSite=".concat(a)),document.cookie=c.join("; ")},read(e){if(typeof document>"u")return null;const t=document.cookie.match(new RegExp("(?:^|; )"+e+"=([^;]*)"));return t?decodeURIComponent(t[1]):null},remove(e){this.write(e,"",Date.now()-864e5,"/")}}:{write(){},read:()=>null,remove(){}};function fN(e,t,i){let r=!function(o){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(o)}(t);return e&&(r||i==0)?function(o,s){return s?o.replace(/\/?\/$/,"")+"/"+s.replace(/^\/+/,""):o}(e,t):t}function ov(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function sv(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?ov(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ov(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}const Ch=e=>e instanceof Qa?sv({},e):e;function yh(e,t){t=t||{};const i={};function r(l,h,p,f){return te.isPlainObject(l)&&te.isPlainObject(h)?te.merge.call({caseless:f},l,h):te.isPlainObject(h)?te.merge({},h):te.isArray(h)?h.slice():h}function o(l,h,p,f){return te.isUndefined(h)?te.isUndefined(l)?void 0:r(void 0,l,0,f):r(l,h,0,f)}function s(l,h){if(!te.isUndefined(h))return r(void 0,h)}function a(l,h){return te.isUndefined(h)?te.isUndefined(l)?void 0:r(void 0,l):r(void 0,h)}function c(l,h,p){return p in t?r(l,h):p in e?r(void 0,l):void 0}const d={url:s,method:s,data:s,baseURL:a,transformRequest:a,transformResponse:a,paramsSerializer:a,timeout:a,timeoutMessage:a,withCredentials:a,withXSRFToken:a,adapter:a,responseType:a,xsrfCookieName:a,xsrfHeaderName:a,onUploadProgress:a,onDownloadProgress:a,decompress:a,maxContentLength:a,maxBodyLength:a,beforeRedirect:a,transport:a,httpAgent:a,httpsAgent:a,cancelToken:a,socketPath:a,responseEncoding:a,validateStatus:c,headers:(l,h,p)=>o(Ch(l),Ch(h),0,!0)};return te.forEach(Object.keys(sv(sv({},e),t)),function(l){const h=d[l]||o,p=h(e[l],t[l],l);te.isUndefined(p)&&h!==c||(i[l]=p)}),i}var uU=e=>{const t=yh({},e);let{data:i,withXSRFToken:r,xsrfHeaderName:o,xsrfCookieName:s,headers:a,auth:c}=t;if(t.headers=a=Qa.from(a),t.url=d0(fN(t.baseURL,t.url,t.allowAbsoluteUrls),e.params,e.paramsSerializer),c&&a.set("Authorization","Basic "+btoa((c.username||"")+":"+(c.password?unescape(encodeURIComponent(c.password)):""))),te.isFormData(i)){if(us.hasStandardBrowserEnv||us.hasStandardBrowserWebWorkerEnv)a.setContentType(void 0);else if(te.isFunction(i.getHeaders)){const d=i.getHeaders(),l=["content-type","content-length"];Object.entries(d).forEach(h=>{let[p,f]=h;z(l).call(l,p.toLowerCase())&&a.set(p,f)})}}if(us.hasStandardBrowserEnv&&(r&&te.isFunction(r)&&(r=r(t)),r||r!==!1&&NY(t.url))){const d=o&&s&&lU.read(s);d&&a.set(o,d)}return t},DY=typeof XMLHttpRequest<"u"&&function(e){return new Z(function(t,i){const r=uU(e);let o=r.data;const s=Qa.from(r.headers).normalize();let a,c,d,l,h,{responseType:p,onUploadProgress:f,onDownloadProgress:m}=r;function g(){l&&l(),h&&h(),r.cancelToken&&r.cancelToken.unsubscribe(a),r.signal&&r.signal.removeEventListener("abort",a)}let S=new XMLHttpRequest;function T(){if(!S)return;const b=Qa.from("getAllResponseHeaders"in S&&S.getAllResponseHeaders());YS(function(D){t(D),g()},function(D){i(D),g()},{data:p&&p!=="text"&&p!=="json"?S.response:S.responseText,status:S.status,statusText:S.statusText,headers:b,config:e,request:S}),S=null}S.open(r.method.toUpperCase(),r.url,!0),S.timeout=r.timeout,"onloadend"in S?S.onloadend=T:S.onreadystatechange=function(){S&&S.readyState===4&&(S.status!==0||S.responseURL&&S.responseURL.indexOf("file:")===0)&&setTimeout(T)},S.onabort=function(){S&&(i(new nt("Request aborted",nt.ECONNABORTED,e,S)),S=null)},S.onerror=function(b){const D=new nt(b&&b.message?b.message:"Network Error",nt.ERR_NETWORK,e,S);D.event=b||null,i(D),S=null},S.ontimeout=function(){let b=r.timeout?"timeout of "+r.timeout+"ms exceeded":"timeout exceeded";const D=r.transitional||u0;r.timeoutErrorMessage&&(b=r.timeoutErrorMessage),i(new nt(b,D.clarifyTimeoutError?nt.ETIMEDOUT:nt.ECONNABORTED,e,S)),S=null},o===void 0&&s.setContentType(null),"setRequestHeader"in S&&te.forEach(s.toJSON(),function(b,D){S.setRequestHeader(D,b)}),te.isUndefined(r.withCredentials)||(S.withCredentials=!!r.withCredentials),p&&p!=="json"&&(S.responseType=r.responseType),m&&([d,h]=zS(m,!0),S.addEventListener("progress",d)),f&&S.upload&&([c,l]=zS(f),S.upload.addEventListener("progress",c),S.upload.addEventListener("loadend",l)),(r.cancelToken||r.signal)&&(a=b=>{S&&(i(!b||b.type?new T_(null,e,S):b),S.abort(),S=null)},r.cancelToken&&r.cancelToken.subscribe(a),r.signal&&(r.signal.aborted?a():r.signal.addEventListener("abort",a)));const C=function(b){const D=/^([-+\w]{1,25})(:?\/\/|:)/.exec(b);return D&&D[1]||""}(r.url);C&&us.protocols.indexOf(C)===-1?i(new nt("Unsupported protocol "+C+":",nt.ERR_BAD_REQUEST,e)):S.send(o||null)})},mN=(e,t)=>{const{length:i}=e=e?e.filter(Boolean):[];if(t||i){let r,o=new AbortController;const s=function(l){if(!r){r=!0,c();const h=l instanceof Error?l:this.reason;o.abort(h instanceof nt?h:new T_(h instanceof Error?h.message:h))}};let a=t&&setTimeout(()=>{a=null,s(new nt("timeout ".concat(t," of ms exceeded"),nt.ETIMEDOUT))},t);const c=()=>{e&&(a&&clearTimeout(a),a=null,e.forEach(l=>{l.unsubscribe?l.unsubscribe(s):l.removeEventListener("abort",s)}),e=null)};e.forEach(l=>l.addEventListener("abort",s));const{signal:d}=o;return d.unsubscribe=()=>te.asap(c),d}},av=A(Nw),hU=Ld.f("asyncIterator"),EN=A(hU);function wo(e,t){this.v=e,this.k=t}function ao(e){return function(){return new St(e.apply(this,arguments))}}function St(e){var t,i;function r(s,a){try{var c=e[s](a),d=c.value,l=d instanceof wo;av.resolve(l?d.v:d).then(function(h){if(l){var p=s==="return"?"return":"next";if(!d.k||h.done)return r(p,h);h=e[p](h).value}o(c.done?"return":"normal",h)},function(h){r("throw",h)})}catch(h){o("throw",h)}}function o(s,a){switch(s){case"return":t.resolve({value:a,done:!0});break;case"throw":t.reject(a);break;default:t.resolve({value:a,done:!1})}(t=t.next)?r(t.key,t.arg):i=null}this._invoke=function(s,a){return new av(function(c,d){var l={key:s,arg:a,resolve:c,reject:d,next:null};i?i=i.next=l:(t=i=l,r(s,a))})},typeof e.return!="function"&&(this.return=void 0)}function Et(e){return new wo(e,0)}function vu(e){var t={},i=!1;function r(o,s){return i=!0,s=new av(function(a){a(e[o](s))}),{done:!1,value:new wo(s,1)}}return t[g_!==void 0&&Tf||"@@iterator"]=function(){return this},t.next=function(o){return i?(i=!1,o):r("next",o)},typeof e.throw=="function"&&(t.throw=function(o){if(i)throw i=!1,o;return r("throw",o)}),typeof e.return=="function"&&(t.return=function(o){return i?(i=!1,o):r("return",o)}),t}St.prototype[typeof g_=="function"&&EN||"@@asyncIterator"]=function(){return this},St.prototype.next=function(e){return this._invoke("next",e)},St.prototype.throw=function(e){return this._invoke("throw",e)},St.prototype.return=function(e){return this._invoke("return",e)};var wf=A(hU);function bf(e){var t,i,r,o=2;for(typeof Symbol<"u"&&(i=wf,r=Symbol.iterator);o--;){if(i&&(t=e[i])!=null)return t.call(e);if(r&&(t=e[r])!=null)return new cv(t.call(e));i="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function cv(e){function t(i){if(Object(i)!==i)return Z.reject(new TypeError(i+" is not an object."));var r=i.done;return Z.resolve(i.value).then(function(o){return{value:o,done:r}})}return cv=function(i){this.s=i,this.n=i.next},cv.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(i){var r=this.s.return;return r===void 0?Z.resolve({value:i,done:!0}):t(r.apply(this.s,arguments))},throw:function(i){var r=this.s.return;return r===void 0?Z.reject(i):t(r.apply(this.s,arguments))}},new cv(e)}const PY=function*(e,t){let i=e.byteLength;if(!t||i<t)return void(yield e);let r,o=0;for(;o<i;)r=o+t,yield e.slice(o,r),o=r},LY=function(){var e=ao(function*(t,i){var r,o=!1,s=!1;try{for(var a,c=bf(pU(t));o=!(a=yield Et(c.next())).done;o=!1){const d=a.value;yield*vu(bf(PY(d,i)))}}catch(d){s=!0,r=d}finally{try{o&&c.return!=null&&(yield Et(c.return()))}finally{if(s)throw r}}});return function(t,i){return e.apply(this,arguments)}}(),pU=function(){var e=ao(function*(t){if(t[wf])return void(yield*vu(bf(t)));const i=t.getReader();try{for(;;){const{done:r,value:o}=yield Et(i.read());if(r)break;yield o}}finally{yield Et(i.cancel())}});return function(t){return e.apply(this,arguments)}}(),gN=(e,t,i,r)=>{const o=LY(e,t);let s,a=0,c=d=>{s||(s=!0,r&&r(d))};return new ReadableStream({async pull(d){try{const{done:l,value:h}=await o.next();if(l)return c(),void d.close();let p=h.byteLength;if(i){let f=a+=p;i(f)}d.enqueue(new Uint8Array(h))}catch(l){throw c(l),l}},cancel:d=>(c(d),o.return())},{highWaterMark:2})};function SN(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function qS(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?SN(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):SN(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}const{isFunction:dv}=te,_U=(e=>{let{Request:t,Response:i}=e;return{Request:t,Response:i}})(te.global),{ReadableStream:TN,TextEncoder:RN}=te.global,fU=function(e){try{for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return!!e(...i)}catch{return!1}},kY=e=>{e=te.merge.call({skipUndefined:!0},_U,e);const{fetch:t,Request:i,Response:r}=e,o=t?dv(t):typeof fetch=="function",s=dv(i),a=dv(r);if(!o)return!1;const c=o&&dv(TN),d=o&&(typeof RN=="function"?(l=new RN,g=>l.encode(g)):async g=>new Uint8Array(await new i(g).arrayBuffer()));var l;const h=s&&c&&fU(()=>{let g=!1;const S=new i(us.origin,{body:new TN,method:"POST",get duplex(){return g=!0,"half"}}).headers.has("Content-Type");return g&&!S}),p=a&&c&&fU(()=>te.isReadableStream(new r("").body)),f={stream:p&&(g=>g.body)};o&&["text","arrayBuffer","blob","formData","stream"].forEach(g=>{!f[g]&&(f[g]=(S,T)=>{let C=S&&S[g];if(C)return C.call(S);throw new nt("Response type '".concat(g,"' is not supported"),nt.ERR_NOT_SUPPORT,T)})});const m=async(g,S)=>{const T=te.toFiniteNumber(g.getContentLength());return T??(async C=>C==null?0:te.isBlob(C)?C.size:te.isSpecCompliantForm(C)?(await new i(us.origin,{method:"POST",body:C}).arrayBuffer()).byteLength:te.isArrayBufferView(C)||te.isArrayBuffer(C)?C.byteLength:(te.isURLSearchParams(C)&&(C+=""),te.isString(C)?(await d(C)).byteLength:void 0))(S)};return async g=>{let{url:S,method:T,data:C,signal:b,cancelToken:D,timeout:x,onDownloadProgress:k,onUploadProgress:V,responseType:W,headers:K,withCredentials:J="same-origin",fetchOptions:se}=uU(g),Ne=t||fetch;W=W?(W+"").toLowerCase():"text";let Ce=mN([b,D&&D.toAbortSignal()],x),De=null;const Me=Ce&&Ce.unsubscribe&&(()=>{Ce.unsubscribe()});let et;try{if(V&&h&&T!=="get"&&T!=="head"&&(et=await m(K,C))!==0){let v,N=new i(S,{method:"POST",body:C,duplex:"half"});if(te.isFormData(C)&&(v=N.headers.get("content-type"))&&K.setContentType(v),N.body){const[j,ne]=_N(et,zS(dU(V)));C=gN(N.body,65536,j,ne)}}te.isString(J)||(J=J?"include":"omit");const ae=s&&"credentials"in i.prototype,Y=qS(qS({},se),{},{signal:Ce,method:T.toUpperCase(),headers:K.normalize().toJSON(),body:C,duplex:"half",credentials:ae?J:void 0});De=s&&new i(S,Y);let ie=await(s?Ne(De,se):Ne(S,Y));const Q=p&&(W==="stream"||W==="response");if(p&&(k||Q&&Me)){const v={};["status","statusText","headers"].forEach(Ve=>{v[Ve]=ie[Ve]});const N=te.toFiniteNumber(ie.headers.get("content-length")),[j,ne]=k&&_N(N,zS(dU(k),!0))||[];ie=new r(gN(ie.body,65536,j,()=>{ne&&ne(),Me&&Me()}),v)}W=W||"text";let w=await f[te.findKey(f,W)||"text"](ie,g);return!Q&&Me&&Me(),await new Z((v,N)=>{YS(v,N,{data:w,headers:Qa.from(ie.headers),status:ie.status,statusText:ie.statusText,config:g,request:De})})}catch(ae){throw Me&&Me(),ae&&ae.name==="TypeError"&&/Load failed|fetch/i.test(ae.message)?Object.assign(new nt("Network Error",nt.ERR_NETWORK,g,De),{cause:ae.cause||ae}):nt.from(ae,ae&&ae.code,g,De)}}},mU=new Map,lv=e=>{let t=e&&e.env||{};const{fetch:i,Request:r,Response:o}=t,s=[r,o,i];let a,c,d=s.length,l=mU;for(;d--;)a=s[d],c=l.get(a),c===void 0&&l.set(a,c=d?new Map:kY(t)),l=c;return c};lv();const uv={http:null,xhr:DY,fetch:{get:lv}};te.forEach(uv,(e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch{}Object.defineProperty(e,"adapterName",{value:t})}});const EU=e=>"- ".concat(e),gU=e=>te.isFunction(e)||e===null||e===!1;var hv={getAdapter:function(e,t){e=te.isArray(e)?e:[e];const{length:i}=e;let r,o;const s={};for(let a=0;a<i;a++){let c;if(r=e[a],o=r,!gU(r)&&(o=uv[(c=String(r)).toLowerCase()],o===void 0))throw new nt("Unknown adapter '".concat(c,"'"));if(o&&(te.isFunction(o)||(o=o.get(t))))break;s[c||"#"+a]=o}if(!o){const a=Object.entries(s).map(c=>{let[d,l]=c;return"adapter ".concat(d," ")+(l===!1?"is not supported by the environment":"is not available in the build")});throw new nt("There is no suitable adapter to dispatch the request "+(i?a.length>1?`since :
`+a.map(EU).join(`
`):" "+EU(a[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return o},adapters:uv};function pv(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new T_(null,e)}function vN(e){return pv(e),e.headers=Qa.from(e.headers),e.data=nv.call(e,e.transformRequest),["post","put","patch"].indexOf(e.method)!==-1&&e.headers.setContentType("application/x-www-form-urlencoded",!1),hv.getAdapter(e.adapter||pN.adapter,e)(e).then(function(t){return pv(e),t.data=nv.call(e,e.transformResponse,t),t.headers=Qa.from(t.headers),t},function(t){return S_(t)||(pv(e),t&&t.response&&(t.response.data=nv.call(e,e.transformResponse,t.response),t.response.headers=Qa.from(t.response.headers))),Z.reject(t)})}const XS="1.13.2",JS={};["object","boolean","number","function","string","symbol"].forEach((e,t)=>{JS[e]=function(i){return typeof i===e||"a"+(t<1?"n ":" ")+e}});const QS={};JS.transitional=function(e,t,i){function r(o,s){return"[Axios v"+XS+"] Transitional option '"+o+"'"+s+(i?". "+i:"")}return(o,s,a)=>{if(e===!1)throw new nt(r(s," has been removed"+(t?" in "+t:"")),nt.ERR_DEPRECATED);return t&&!QS[s]&&(QS[s]=!0,console.warn(r(s," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(o,s,a)}},JS.spelling=function(e){return(t,i)=>(console.warn("".concat(i," is likely a misspelling of ").concat(e)),!0)};var Za={assertOptions:function(e,t,i){if(typeof e!="object")throw new nt("options must be an object",nt.ERR_BAD_OPTION_VALUE);const r=Object.keys(e);let o=r.length;for(;o-- >0;){const s=r[o],a=t[s];if(a){const c=e[s],d=c===void 0||a(c,s,e);if(d!==!0)throw new nt("option "+s+" must be "+d,nt.ERR_BAD_OPTION_VALUE)}else if(i!==!0)throw new nt("Unknown option "+s,nt.ERR_BAD_OPTION)}},validators:JS};const $a=Za.validators;let R_=class{constructor(e){this.defaults=e||{},this.interceptors={request:new l0,response:new l0}}async request(e,t){try{return await this._request(e,t)}catch(i){if(i instanceof Error){let r={};Error.captureStackTrace?Error.captureStackTrace(r):r=new Error;const o=r.stack?r.stack.replace(/^.+\n/,""):"";try{i.stack?o&&!String(i.stack).endsWith(o.replace(/^.+\n.+\n/,""))&&(i.stack+=`
`+o):i.stack=o}catch{}}throw i}}_request(e,t){typeof e=="string"?(t=t||{}).url=e:t=e||{},t=yh(this.defaults,t);const{transitional:i,paramsSerializer:r,headers:o}=t;i!==void 0&&Za.assertOptions(i,{silentJSONParsing:$a.transitional($a.boolean),forcedJSONParsing:$a.transitional($a.boolean),clarifyTimeoutError:$a.transitional($a.boolean)},!1),r!=null&&(te.isFunction(r)?t.paramsSerializer={serialize:r}:Za.assertOptions(r,{encode:$a.function,serialize:$a.function},!0)),t.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?t.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:t.allowAbsoluteUrls=!0),Za.assertOptions(t,{baseUrl:$a.spelling("baseURL"),withXsrfToken:$a.spelling("withXSRFToken")},!0),t.method=(t.method||this.defaults.method||"get").toLowerCase();let s=o&&te.merge(o.common,o[t.method]);o&&te.forEach(["delete","get","head","post","put","patch","common"],m=>{delete o[m]}),t.headers=Qa.concat(s,o);const a=[];let c=!0;this.interceptors.request.forEach(function(m){typeof m.runWhen=="function"&&m.runWhen(t)===!1||(c=c&&m.synchronous,a.unshift(m.fulfilled,m.rejected))});const d=[];let l;this.interceptors.response.forEach(function(m){d.push(m.fulfilled,m.rejected)});let h,p=0;if(!c){const m=[vN.bind(this),void 0];for(m.unshift(...a),m.push(...d),h=m.length,l=Z.resolve(t);p<h;)l=l.then(m[p++],m[p++]);return l}h=a.length;let f=t;for(;p<h;){const m=a[p++],g=a[p++];try{f=m(f)}catch(S){g.call(this,S);break}}try{l=vN.call(this,f)}catch(m){return Z.reject(m)}for(p=0,h=d.length;p<h;)l=l.then(d[p++],d[p++]);return l}getUri(e){return d0(fN((e=yh(this.defaults,e)).baseURL,e.url,e.allowAbsoluteUrls),e.params,e.paramsSerializer)}};te.forEach(["delete","get","head","options"],function(e){R_.prototype[e]=function(t,i){return this.request(yh(i||{},{method:e,url:t,data:(i||{}).data}))}}),te.forEach(["post","put","patch"],function(e){function t(i){return function(r,o,s){return this.request(yh(s||{},{method:e,headers:i?{"Content-Type":"multipart/form-data"}:{},url:r,data:o}))}}R_.prototype[e]=t(),R_.prototype[e+"Form"]=t(!0)});var Of=R_;class CN{constructor(t){if(typeof t!="function")throw new TypeError("executor must be a function.");let i;this.promise=new Z(function(o){i=o});const r=this;this.promise.then(o=>{if(!r._listeners)return;let s=r._listeners.length;for(;s-- >0;)r._listeners[s](o);r._listeners=null}),this.promise.then=o=>{let s;const a=new Z(c=>{r.subscribe(c),s=c}).then(o);return a.cancel=function(){r.unsubscribe(s)},a},t(function(o,s,a){r.reason||(r.reason=new T_(o,s,a),i(r.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(t){this.reason?t(this.reason):this._listeners?this._listeners.push(t):this._listeners=[t]}unsubscribe(t){if(!this._listeners)return;const i=this._listeners.indexOf(t);i!==-1&&this._listeners.splice(i,1)}toAbortSignal(){const t=new AbortController,i=r=>{t.abort(r)};return this.subscribe(i),t.signal.unsubscribe=()=>this.unsubscribe(i),t.signal}static source(){let t;return{token:new CN(function(r){t=r}),cancel:t}}}var yN=CN;const IN={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511,WebServerIsDown:521,ConnectionTimedOut:522,OriginIsUnreachable:523,TimeoutOccurred:524,SslHandshakeFailed:525,InvalidSslCertificate:526};Object.entries(IN).forEach(e=>{let[t,i]=e;IN[i]=t});var fo=IN;const Qi=function e(t){const i=new Of(t),r=YO(Of.prototype.request,i);return te.extend(r,Of.prototype,i,{allOwnKeys:!0}),te.extend(r,i,null,{allOwnKeys:!0}),r.create=function(o){return e(yh(t,o))},r}(pN);Qi.Axios=Of,Qi.CanceledError=T_,Qi.CancelToken=yN,Qi.isCancel=S_,Qi.VERSION=XS,Qi.toFormData=__,Qi.AxiosError=nt,Qi.Cancel=Qi.CanceledError,Qi.all=function(e){return Z.all(e)},Qi.spread=function(e){return function(t){return e.apply(null,t)}},Qi.isAxiosError=function(e){return te.isObject(e)&&e.isAxiosError===!0},Qi.mergeConfig=yh,Qi.AxiosHeaders=Qa,Qi.formToJSON=e=>rv(te.isHTMLForm(e)?new FormData(e):e),Qi.getAdapter=hv.getAdapter,Qi.HttpStatusCode=fo,Qi.default=Qi;var hs=Qi;const ZS=()=>{};function Ih(){const e={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:ZS};return e.promise=new Z((t,i)=>{e.resolve=r=>{e.isFinished||(e.isResolved=!0,e.isFinished=!0,t(r),e.value=r)},e.reject=r=>{e.isFinished||(e.isRejected=!0,e.isFinished=!0,i(r))}}),e}const v_=new Map,ec=new Map,pr=new Map;let pt=function(e){return e.WIN_10="Windows 10",e.WIN_81="Windows 8.1",e.WIN_8="Windows 8",e.WIN_7="Windows 7",e.WIN_VISTA="Windows Vista",e.WIN_SERVER_2003="Windows Server 2003",e.WIN_XP="Windows XP",e.WIN_2000="Windows 2000",e.ANDROID="Android",e.HARMONY_OS="HarmonyOS",e.OPEN_BSD="Open BSD",e.SUN_OS="Sun OS",e.LINUX="Linux",e.IOS="iOS",e.MAC_OS="Mac OS",e.CHROMIUM_OS="Chromium OS",e.QNX="QNX",e.UNIX="UNIX",e.BEOS="BeOS",e.OS_2="OS/2",e.SEARCH_BOT="Search Bot",e}({}),di=function(e){return e.CHROME="Chrome",e.SAFARI="Safari",e.EDGE="Edge",e.FIREFOX="Firefox",e.OPERA="OPR",e.QQ="QQBrowser",e.WECHAT="MicroMessenger",e}({});const Ac=new mK;let tc=Ac.getResult(),Zt=null;function ii(e){if(!Zt){tc=Ac.getResult();const t=function(c){if(c.engine.name==="Blink"&&c.browser.name!=="WeChat")return di.CHROME;switch(c.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return di.CHROME;case"Safari":case"Mobile Safari":return di.SAFARI;case"Edge":return di.EDGE;case"Firefox":return di.FIREFOX;case"QQ":case"QQBrowser":return di.QQ;case"Opera":return di.OPERA;case"WeChat":return di.WECHAT;default:return c.browser.name||""}}(tc),i=$S(tc),r=function(c){return c.os.name==="Windows"?c.os.version?c.os.name+" "+c.os.version:c.os.name:c.os.name||""}(tc),o=tc.os.version,s=$S(tc,!1),a=tc.device.type;if(!(t&&i&&r&&o))return{name:t,version:i,os:r,osVersion:o,browserVersion:s,deviceType:a};Zt={name:t,version:i,os:r,osVersion:o,browserVersion:s,deviceType:a}}return Zt}function $S(e){let t,i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return t=e.engine.name==="Blink"?e.engine.version||"":e.browser.version||"",i?t.split(".")[0]:t}function eT(){return ii().os}function tT(){const e=ii();return"".concat(e.os," ").concat(e.osVersion)}function wc(){const e=ii();return!!(tc.engine.name==="WebKit"&&e.os===pt.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&e.name!==di.SAFARI||Dr()&&e.name!==di.SAFARI)}function Cr(){return ii().name===di.CHROME}function pn(){return ii().name===di.SAFARI}function AN(){const e=ii();if(e.name!==di.SAFARI||!e.browserVersion)return!1;const t=e.browserVersion.split(".");return Number(t[0])>15||Number(t[0])===15&&Number(t[1])>=4}function ji(){return ii().name===di.EDGE}function Ht(){return ii().name===di.FIREFOX}function Dr(){return ii().os===pt.IOS}function bc(e){const t=ii();return!(t.name!==di.CHROME||!t.osVersion)&&Number(t.version)>=e}function _v(e){const t=ii();return!(t.name!==di.CHROME||!t.osVersion)&&Number(t.version)<e}function Tl(e,t,i){const r=ii();return!(r.name!==e||!r.osVersion)&&(i?Number(r.version)>=t&&Number(r.version)<=i:Number(r.version)===t)}function Rl(e){const t=ii();return!(t.name!==di.EDGE||!t.osVersion)&&Number(t.version)>=e}function fv(e){const t=ii();return!(t.name!==di.FIREFOX||!t.osVersion)&&Number(t.version)>=e}function wN(e){const t=ii();return!(t.name!==di.SAFARI||!t.osVersion)&&Number(t.version)>=e}function bN(e,t,i){const r=ii();if(r.os!==pt.IOS||!r.osVersion)return!1;const o=r.osVersion.split(".");return i?t&&Number(o[0])===e&&Number(o[1])>t||Number(o[0])>e:t?Number(o[0])===e&&Number(o[1])>=t||Number(o[0])>e:Number(o[0])>=e}function mv(e,t,i){const r=ii();if(r.os!==pt.IOS||!r.osVersion)return!1;const o=r.osVersion.split(".");return i?t&&Number(o[0])===e&&Number(o[1])<t||Number(o[0])<e:t?Number(o[0])===e&&Number(o[1])<=t||Number(o[0])<e:Number(o[0])<=e}function Cu(e,t,i){const r=ii();if(r.name!==di.SAFARI||!r.osVersion||!r.browserVersion)return!1;const o=r.browserVersion.split(".");return i?t&&Number(o[0])===e&&Number(o[1])<t||Number(o[0])<e:t?Number(o[0])===e&&Number(o[1])<=t||Number(o[0])<e:Number(o[0])<=e}function Ah(e){const t=ii();return!(t.name!==di.OPERA||!t.osVersion)&&Number(t.version)>=e}function C_(){const e=ii();if(e.os!==pt.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])<14||Number(t[0])===14&&Number(t[1])<=6}function wh(){const e=ii();if(e.os!==pt.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===15}function Ev(){const e=ii();if(e.os!==pt.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===16}function ic(){const e=ii();if(e.os!==pt.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===15&&Number(t[1])>=1}function rc(){return pn()&&navigator.maxTouchPoints>0}function ON(){return ii().name===di.WECHAT}function NN(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function Ud(){const e=eT();return function(){const{deviceType:t}=ii();return t==="mobile"||t==="tablet"}()||e===pt.ANDROID||e===pt.IOS||e===pt.HARMONY_OS}function ha(){const e=ii();return e.name!==di.EDGE&&e.name!==di.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function yu(){return eT()===pt.ANDROID}function at(){const e=ii();return yu()&&(e.name===di.CHROME||e.name===di.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function ut(e,t,i){return(t=function(r){var o=function(s,a){if(typeof s!="object"||!s)return s;var c=s[Symbol.toPrimitive];if(c!==void 0){var d=c.call(s,"string");if(typeof d!="object")return d;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(s)}(r);return typeof o=="symbol"?o:o+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function Te(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function L(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Te(Object(i),!0).forEach(function(r){ut(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Te(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let O=function(e){return e.UNEXPECTED_ERROR="UNEXPECTED_ERROR",e.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",e.TIMEOUT="TIMEOUT",e.INVALID_PARAMS="INVALID_PARAMS",e.NOT_READABLE="NOT_READABLE",e.NOT_SUPPORTED="NOT_SUPPORTED",e.INVALID_OPERATION="INVALID_OPERATION",e.OPERATION_ABORTED="OPERATION_ABORTED",e.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",e.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",e.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",e.DATACHANNEL_FAILED="DATACHANNEL_FAILED",e.NETWORK_ERROR="NETWORK_ERROR",e.NETWORK_TIMEOUT="NETWORK_TIMEOUT",e.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",e.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",e.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",e.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",e.ELECTRON_IS_NULL="ELECTRON_IS_NULL",e.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",e.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",e.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",e.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",e.TRACK_IS_DISABLED="TRACK_IS_DISABLED",e.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",e.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",e.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",e.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",e.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",e.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",e.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",e.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",e.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",e.UID_CONFLICT="UID_CONFLICT",e.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",e.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",e.TOKEN_EXPIRE="TOKEN_EXPIRE",e.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",e.INVALID_TRACK="INVALID_TRACK",e.SENDER_NOT_FOUND="SENDER_NOT_FOUND",e.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",e.SET_ANSWER_FAILED="SET_ANSWER_FAILED",e.ICE_FAILED="ICE_FAILED",e.PC_CLOSED="PC_CLOSED",e.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",e.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",e.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",e.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",e.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",e.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",e.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",e.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",e.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",e.INVALID_REMOTE_USER="INVALID_REMOTE_USER",e.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",e.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",e.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",e.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",e.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",e.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",e.WS_ABORT="WS_ABORT",e.WS_DISCONNECT="WS_DISCONNECT",e.WS_ERR="WS_ERR",e.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",e.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",e.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",e.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",e.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",e.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",e.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",e.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",e.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",e.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",e.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",e.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",e.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",e.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",e.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",e.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",e.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",e.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",e.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",e.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",e.INVALID_PLUGIN="INVALID_PLUGIN",e.DISCONNECT_P2P="DISCONNECT_P2P",e.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",e.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",e.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",e.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",e.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",e.PROHIBITED_OPERATION="PROHIBITED_OPERATION",e.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",e.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",e}({}),oe=class extends Error{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",i=arguments.length>2?arguments[2]:void 0;super(t),ut(this,"code",void 0),ut(this,"message",void 0),ut(this,"data",void 0),ut(this,"name","AgoraRTCException"),this.code=e,this.message="AgoraRTCError ".concat(this.code,": ").concat(t),this.data=i}toString(){return this.data?"".concat(this.message,`
data: `).concat(JSON.stringify(this.data)):this.message}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",t=arguments.length>1?arguments[1]:void 0;return e==="error"&&(t||console).error(this.toString()),e==="warning"&&(t||console).warn(this.toString()),this}throw(e){throw this.print("error",e),this}};function xi(e,t){if(typeof e!="boolean")throw new oe(O.INVALID_PARAMS,"Invalid ".concat(t,": The value is of the boolean type."))}function Rt(e,t,i){if(!z(i).call(i,e))throw new oe(O.INVALID_PARAMS,"".concat(t," can only be set as ").concat(JSON.stringify(i)))}function Ai(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(e<i||e>r||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(o){return typeof o=="number"&&o%1==0}(e))throw new oe(O.INVALID_PARAMS,"invalid ".concat(t,": the value range is [").concat(i,", ").concat(r,"]. integer only"))}function _n(e,t){if(typeof e!="number"){if(!(e.min||e.max||e.ideal||e.exact))throw new oe(O.INVALID_PARAMS,"".concat(t," is not a valid ConstrainLong"));e.min!==void 0&&Ai(e.min,"".concat(t,".min"),0,1/0),e.max!==void 0&&Ai(e.max,"".concat(t,".max"),1,1/0),e.exact!==void 0&&Ai(e.exact,"".concat(t,".exact"),1,1/0),e.ideal!==void 0&&Ai(e.ideal,"".concat(t,".ideal"),1,1/0)}else Ai(e,t,1,1/0)}function Ar(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,o=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(e==null)throw new oe(O.INVALID_PARAMS,"".concat(t||"param"," cannot be empty"));if(!DN(e,i,r,o))throw new oe(O.INVALID_PARAMS,"Invalid ".concat(t||"string param",": Length of the string: [").concat(i,",").concat(r,"].").concat(o?" ASCII characters only.":""))}function Pi(e,t){if(!Array.isArray(e))throw new oe(O.INVALID_PARAMS,"".concat(t," should be an array"))}function _r(e){return e==null}function DN(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,r=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof e=="string"&&e.length<=i&&e.length>=t&&(!r||function(o){if(typeof o!="string")return!1;for(let s=0;s<o.length;s+=1){const a=o.charCodeAt(s);if(a<0||a>255)return!1}return!0}(e))}function PN(e,t,i){if("getBigUint64"in DataView.prototype)return e.getBigUint64(t,i);const r=e.getUint32(t,i),o=e.getUint32(t+4,i),s=0,a=+!i;return BigInt(r*a+o*s)<<BigInt(32)|BigInt(r*s+o*a)}function Nf(e,t,i,r){if("setBigUint64"in DataView.prototype)return e.setBigUint64(t,i,r);const o=Number(i>>BigInt(32)),s=Number(i&BigInt(4294967295));e.setUint32(t,o,r),e.setUint32(t+4,s,r)}var y_=function(e){return e.COVERED="COVERED",e.POSITION="POSITION",e.SIZE="SIZE",e.STYLE="STYLE",e}(y_||{}),gv=function(e){return e.UNMOUNTED="UNMOUNTED",e.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",e}(gv||{});const Sv=new class{constructor(){ut(this,"_clientSize",null),ut(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),ut(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),ut(this,"getStyle",e=>window.getComputedStyle(e,null)),ut(this,"checkCssVisibleProperty",e=>{var t;let i=!0;const r=this.getStyle(e),{display:o,visibility:s,opacity:a,filter:c}=r;return(o==="none"||z(t=["hidden","collapse"]).call(t,s)||Number(a)<.1)&&(i=!1),!!i&&(c&&c.split(" ").filter(d=>{var l;const h=d.split("(")[0];return z(l=["brightness","blur","opacity"]).call(l,h)}).map(d=>{const[l,h]=d.split(/\(|\)/);return[l,Number(h.match(/^[0-9\.]+/))]}).forEach(d=>{const[l,h]=d;switch(l){case"brightness":(h<.1||h>3)&&(i=!1);break;case"blur":h>3&&(i=!1);break;case"opacity":h<.1&&(i=!1)}}),i)}),ut(this,"checkPropertyUpToAllParentNodes",(e,t)=>{let i=!0,r=!0;const o=a=>t(a);let s=e;for(;s&&r;)o(s)||(i=!1,r=!1),s=s.parentElement,s||(r=!1);return i}),ut(this,"checkActualCssVisibleIncludeInherit",e=>this.checkPropertyUpToAllParentNodes(e,this.checkCssVisibleProperty)),ut(this,"getSizeAboutClient",e=>{const{width:t,height:i,left:r,right:o,top:s,bottom:a}=e.getBoundingClientRect(),c=this.getClientWidth(),d=this.getClientHeight();return{width:t,height:i,left:r,right:o,top:s,bottom:a,clientWidth:c,clientHeight:d,clientMin:Math.min(c,d)}}),ut(this,"checkActualSize",()=>{const{width:e,height:t,clientMin:i}=this._clientSize;return this.checkSizeIsVisible(e,t,i)}),ut(this,"elementFromPoint",(e,t)=>document.elementFromPoint?document.elementFromPoint(e,t):null),ut(this,"checkCoverForAPoint",(e,t,i)=>{const r=this.elementFromPoint(e,t);return r!==null&&r!==i}),ut(this,"getPointPositionList",()=>{const{width:e,height:t,left:i,top:r}=this._clientSize,o=e/6,s=t/6,a=[],c=10**6;for(let d=0;d<5;d++)for(let l=0;l<5;l++){const h=(i*c+(d===0?.1:d===4?(o*d*c-1e5)/c:o*d)*c)/c,p=(r*c+(l===0?.1:l===4?(s*l*c-1e5)/c:s*l)*c)/c;a.push({x:h,y:p})}return[...a]}),ut(this,"checkElementCover",e=>this.getPointPositionList().map(t=>this.checkCoverForAPoint(t.x,t.y,e)).filter(t=>!!t).length>6),ut(this,"checkSizeIsVisible",(e,t,i)=>(e>50||i/e<=10)&&(t>50||i/t<=10)),ut(this,"checkSizeOfPartInClient",()=>{const{left:e,right:t,top:i,bottom:r,clientHeight:o,clientWidth:s,clientMin:a}=this._clientSize;let c,d,l,h;if(e<0)c=0;else{if(!(e<s))return!1;c=e}if(t<0)return!1;if(d=t<s?t:s,i<0)l=0;else{if(!(i<o))return!1;l=i}if(r<0)return!1;h=r<o?r:o;const p=d-c,f=h-l;return this.checkSizeIsVisible(p,f,a)}),ut(this,"returnHiddenResult",e=>(this._clientSize=null,{visible:!1,reason:e})),ut(this,"checkOneElementVisible",e=>{if(e instanceof HTMLElement){if(this.checkElementIsMountedOnDom(e)){if(this.checkActualCssVisibleIncludeInherit(e)){if(this._clientSize=this.getSizeAboutClient(e),this.checkElementCover(e))return this.returnHiddenResult(y_.COVERED);{const t=this.checkActualSize(),i=this.checkSizeOfPartInClient();return t&&!i?this.returnHiddenResult(y_.POSITION):t?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(y_.SIZE)}}return this.returnHiddenResult(y_.STYLE)}return this.returnHiddenResult(gv.UNMOUNTED)}return this.returnHiddenResult(gv.INVALID_HTML_ELEMENT)}),ut(this,"checkElementIsMountedOnDom",e=>this.checkPropertyUpToAllParentNodes(e,t=>t.nodeName.toUpperCase()!=="HTML"?t.parentElement!==null:!!document.documentElement))}};function Tv(e){return new TextEncoder().encode(e)}const Rv=function(e,t){const i=new Uint8Array(e.byteLength+t.byteLength);return i.set(new Uint8Array(e),0),i.set(new Uint8Array(t),e.byteLength),i},Ki=async e=>function(t,i){let r="";return new Uint8Array(t).forEach(o=>{r+=o.toString(i).padStart(2,"0")}),r}(await crypto.subtle.digest("SHA-256",Tv(e)),16);let Vi=class{constructor(){ut(this,"_events",{}),ut(this,"addListener",this.on)}getListeners(e){return this._events[e]?this._events[e].map(t=>t.listener):[]}on(e,t){this._events[e]||(this._events[e]=[]);const i=this._events[e];this._indexOfListener(i,t)===-1&&i.push({listener:t,once:!1})}once(e,t){this._events[e]||(this._events[e]=[]);const i=this._events[e];this._indexOfListener(i,t)===-1&&i.push({listener:t,once:!0})}off(e,t){if(!this._events[e])return;const i=this._events[e],r=this._indexOfListener(i,t);r!==-1&&i.splice(r,1),this._events[e].length===0&&delete this._events[e]}removeAllListeners(e){e?delete this._events[e]:this._events={}}emit(e){this._events[e]||(this._events[e]=[]);const t=this._events[e].map(s=>s);for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];for(let s=0;s<t.length;s+=1){const a=t[s];a.once&&this.off(e,a.listener),a.listener.apply(this,r||[])}}safeEmit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];[...this._events[e]||[]].forEach(o=>{o.once&&this.off(e,o.listener);try{o.listener.apply(this,i)}catch(s){console.error("safeEmit event:".concat(e," error ").concat(s==null?void 0:s.toString()))}})}_indexOfListener(e,t){let i=e.length;for(;i--;)if(e[i].listener===t)return i;return-1}},Df=null;function Yi(){if(Df)return Df;if(window.electron)return Df=window.electron;if(!window.require)return null;try{return Df=window.require("electron"),Df}catch{return null}}let ct=function(e){return e.CREATE_CLIENT="createClient",e.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",e.SET_AREA="setArea",e.PRELOAD="PRELOAD",e.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",e.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",e.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",e.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",e.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",e.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",e.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",e.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",e.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",e.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",e.START_PROXY_SERVER="Client.startProxyServer",e.STOP_PROXY_SERVER="Client.stopProxyServer",e.SET_PROXY_SERVER="Client.setProxyServer",e.SET_TURN_SERVER="Client.setTurnServer",e.SET_CLIENT_ROLE="Client.setClientRole",e.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",e.ENABLE_DUAL_STREAM="Client.enableDualStream",e.DISABLE_DUAL_STREAM="Client.disableDualStream",e.JOIN="Client.join",e.LEAVE="Client.leave",e.PUBLISH="Client.publish",e.UNPUBLISH="Client.unpublish",e.SUBSCRIBE="Client.subscribe",e.MASS_SUBSCRIBE="Client.massSubscribe",e.MASS_UNSUBSCRIBE="Client.massUnsubscribe",e.UNSUBSCRIBE="Client.unsubscribe",e.RENEW_TOKEN="Client.renewToken",e.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",e.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",e.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",e.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",e.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",e.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",e.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",e.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",e.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",e.START_LIVE_STREAMING="Client.startLiveStreaming",e.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",e.STOP_LIVE_STREAMING="Client.stopLiveStreaming",e.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",e.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",e.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",e.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",e.SET_CONFIG_DISTRIBUTE="_configDistribute",e.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",e.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",e.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",e.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",e.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",e.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",e.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",e.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",e.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",e.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",e.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",e.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",e.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",e.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",e.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",e.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",e.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",e.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",e.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",e.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",e.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",e.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",e.STREAM_TYPE_CHANGE="streamTypeChange",e.CONNECTION_STATE_CHANGE="connectionStateChange",e.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",e.IMAGE_MODERATION_UPLOAD="imageModerationUpload",e.REPUB_AFTER_PC_CONNECTED="repubAfterPCConnected",e.PRELOAD_MEDIA_FAILED="preloadMediaFailed",e.MISMATCH_DTLS_PARAMETERS="mismatchDtlsParameters",e.VOS_FALLBACK_CN="vosFallbackCN",e.DATACHANNEL_FAILBACK="datachannelFailback",e}({}),bi=function(e){return e.TRACER="tracer",e}({});function SU(e){return Ai(e.timeout,"config.timeout",0,1e5),Ai(e.timeoutFactor,"config.timeoutFactor",0,100,!1),Ai(e.maxRetryCount,"config.maxRetryConfig",0,1/0),Ai(e.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let Gt=function(e){return e[e.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",e[e.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",e[e.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",e}({}),bt=function(e){return e.LEAVE="LEAVE",e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.UID_BANNED="UID_BANNED",e.FALLBACK="FALLBACK",e.IP_BANNED="IP_BANNED",e.CHANNEL_BANNED="CHANNEL_BANNED",e.LICENSE_MISSING="LICENSE_MISSING",e.LICENSE_EXPIRED="LICENSE_EXPIRED",e.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",e.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",e.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",e.LICENSE_ILLEGAL="LICENSE_ILLEGAL",e.TOKEN_EXPIRE="TOKEN_EXPIRE",e.FALLBACK_TO_HLS="FALLBACK_TO_HLS",e.UID_CONFLICT="UID_CONFLICT",e}({});function bh(e){if(!Array.isArray(e)||e.length<1)return!1;try{e.forEach(t=>{if(!t.urls)throw Error()})}catch{return!1}return!0}function I_(e){return Ar(e.turnServerURL,"turnServerURL"),Ar(e.username,"username"),Ar(e.password,"password"),e.udpport&&Ai(e.udpport,"udpport",1,99999,!0),e.forceturn&&xi(e.forceturn,"forceturn"),e.security&&xi(e.security,"security"),e.tcpport&&Ai(e.tcpport,"tcpport",1,99999,!0),!0}let Oh=function(e){return e[e.AUTO_SIMULCAST_STREAM=-1]="AUTO_SIMULCAST_STREAM",e[e.DISABLE_SIMULCAST_STREM=0]="DISABLE_SIMULCAST_STREM",e[e.ENABLE_SIMULCAST_STREAM=1]="ENABLE_SIMULCAST_STREAM",e}({});function It(e){return e.level!==void 0&&Rt(e.level,"level",[1,2,3]),e.delay!==void 0&&Ai(e.delay,"delay",0,3e3,!0),!0}let At=function(e){return e.PEERCONNECTION_STATE_CHANGE="peerconnection-state-change",e.AUDIO_METADATA="audio-metadata",e.AUDIO_PTS="audio-pts",e.CONNECTION_STATE_CHANGE="connection-state-change",e.MEDIA_RECONNECT_START="media-reconnect-start",e.MEDIA_RECONNECT_END="media-reconnect-end",e.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",e.USER_JOINED="user-joined",e.USER_LEAVED="user-left",e.USER_PUBLISHED="user-published",e.USER_UNPUBLISHED="user-unpublished",e.USER_INFO_UPDATED="user-info-updated",e.CLIENT_BANNED="client-banned",e.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",e.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",e.VOLUME_INDICATOR="volume-indicator",e.CRYPT_ERROR="crypt-error",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGED="stream-type-changed",e.STREAM_FALLBACK="stream-fallback",e.RECEIVE_METADATA="receive-metadata",e.STREAM_MESSAGE="stream-message",e.LIVE_STREAMING_ERROR="live-streaming-error",e.LIVE_STREAMING_WARNING="live-streaming-warning",e.EXCEPTION="exception",e.ERROR="error",e.P2P_LOST="p2p_lost",e.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",e.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",e.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",e.PUBLISHED_USER_LIST="published-user-list",e.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",e.CONTENT_INSPECT_ERROR="content-inspect-error",e.CONTENT_INSPECT_RESULT="content-inspect-result",e.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",e.FALLBACK_TO_HLS="fallback-to-hls",e.FIRST_VIDEO_BUFFER_READY="first-video-buffer-ready",e.FIRST_VIDEO_PRE_RENDER="first-video-pre-render",e.AV1_DECODABLE_RESULT="av1-decodable-result",e}({}),Cn=function(e){return e.CONFIG="config",e.VOSERROR="vos_error",e.AP_ERROR="ap_error",e}({}),Gi=function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e.REGIONAL_DISTRIBUTION="REGIONAL_DISTRIBUTION",e}({}),yn=function(e){return e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e}({}),fr=function(e){return e.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e}({});function yt(e,t){for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];return e.getListeners(t).length===0?Z.reject(new oe(O.UNEXPECTED_ERROR,"can not emit promise")):new Z((s,a)=>{e.emit(t,...r,s,a)})}function Xt(e,t){if(e.getListeners(t).length===0)return Z.resolve();for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];return yt(e,t,...r)}function co(e,t){if(e.getListeners(t).length===0)return null;for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];return Wi(e,t,...r)}function Wi(e,t){let i=null,r=null;for(var o=arguments.length,s=new Array(o>2?o-2:0),a=2;a<o;a++)s[a-2]=arguments[a];if(e.emit(t,...s,c=>{i=c},c=>{r=c}),r!==null)throw r;if(i===null)throw new oe(O.UNEXPECTED_ERROR,"handler is not sync");return i}const fi=new class extends Vi{set networkState(e){this.emit(fr.NETWORK_STATE_CHANGE,e,this._networkState),e===yn.ONLINE?this.emit(fr.ONLINE):e===yn.OFFLINE&&(this.onlineWaiter=new Z(t=>{this.once(fr.ONLINE,()=>{this.onlineWaiter=void 0,t(yn.ONLINE)})}),this.emit(fr.OFFLINE)),this._networkState=e}get networkState(){return this._networkState}get isOnline(){return this._networkState===yn.ONLINE}constructor(){super(),ut(this,"_moduleName","network-indicator"),ut(this,"_networkState",yn.ONLINE),ut(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=yn.ONLINE}),window.addEventListener("offline",()=>{this.networkState=yn.OFFLINE})}},Go=[];for(let e=0;e<256;++e)Go.push((e+256).toString(16).slice(1));const vv=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);let LN;const MY=new Uint8Array(16);function Cv(){return vv?vv():function(i,r,o){var s,a,c,d;const l=(s=(a=(i=i||{}).random)!==null&&a!==void 0?a:(c=(d=i).rng)===null||c===void 0?void 0:c.call(d))!==null&&s!==void 0?s:function(){if(!LN){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");LN=crypto.getRandomValues.bind(crypto)}return LN(MY)}();if(l.length<16)throw new Error("Random bytes length must be >= 16");if(l[6]=15&l[6]|64,l[8]=63&l[8]|128,r){if((o=o||0)<0||o+16>r.length)throw new RangeError("UUID byte range ".concat(o,":").concat(o+15," is out of buffer bounds"));for(let h=0;h<16;++h)r[o+h]=l[h];return r}return function(h){let p=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(Go[h[p+0]]+Go[h[p+1]]+Go[h[p+2]]+Go[h[p+3]]+"-"+Go[h[p+4]]+Go[h[p+5]]+"-"+Go[h[p+6]]+Go[h[p+7]]+"-"+Go[h[p+8]]+Go[h[p+9]]+"-"+Go[h[p+10]]+Go[h[p+11]]+Go[h[p+12]]+Go[h[p+13]]+Go[h[p+14]]+Go[h[p+15]]).toLowerCase()}(l)}(e,t,void 0);var e,t}function Iu(e,t){const i=e.indexOf(t);i!==-1&&e.splice(i,1)}function Au(e){const t=[];return e.forEach(i=>{t.indexOf(i)===-1&&t.push(i)}),t}function Li(e){Z!==void 0?Z.resolve().then(e):setTimeout(e,0)}function wi(e){return JSON.parse(JSON.stringify(e))}function Nh(e){try{return wi(e)}catch{return e}}const wu={};function pa(e,t){wu[t]||(wu[t]=!0,e())}function _a(e){const t=window.atob(e),i=new Uint8Array(new ArrayBuffer(t.length));for(let r=0;r<t.length;r+=1)i[r]=t.charCodeAt(r);return i}function bu(e){let t="";for(let i=0;i<e.length;i+=1)t+=String.fromCharCode(e[i]);return window.btoa(t)}function kN(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,i=new TextEncoder().encode(e);if(i.length>t)i=i.slice(0,t);else if(i.length<t){const r=new Uint8Array(t);r.set(i),i=r}return i}function xd(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const r=un(t).call(t,(a,c)=>a+c.length,0),o=new Uint8Array(new ArrayBuffer(r));let s=0;return t.forEach(a=>{o.set(a,s),s+=a.length}),o}function Vd(e){return window.TextEncoder?new TextEncoder().encode(e).length:e.length}function TU(e){let t=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&e.realFormData&&(e=e.realFormData),e.forEach(i=>{t+=typeof i=="string"?Vd(i):i.size}),t+138}function fn(e){const t=new oe(O.TIMEOUT,"timeout");return new Z((i,r)=>{window.setTimeout(()=>r(t),e)})}function vt(e){return new Z(t=>{window.setTimeout(t,e)})}function li(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,t=arguments.length>1?arguments[1]:void 0;const i=Math.random().toString(16).substr(2,e).toLowerCase();return i.length===e?"".concat(t).concat(i):"".concat(t).concat(i)+li(e-i.length,"")}function Fd(){let e,t=!1;try{var i;e=fK(i=Cv()).call(i,"-","")}catch{t=!0}return!t&&e&&e.length===32||(e=li(32,"")),e.toUpperCase()}const Pf=()=>{},MN=new class{constructor(){ut(this,"fnMap",new Map)}throttleByKey(e,t,i,r){for(var o=arguments.length,s=new Array(o>4?o-4:0),a=4;a<o;a++)s[a-4]=arguments[a];if(this.fnMap.has(t)){const c=this.fnMap.get(t);if(c.threshold!==i){c.fn(...c.args),clearTimeout(c.timer);const d=window.setTimeout(()=>{const l=this.fnMap.get(t);l&&l.fn(...l.args),this.fnMap.delete(t)},i);this.fnMap.set(t,{fn:e,threshold:i,timer:d,args:s,skipFn:r})}else c.skipFn&&c.skipFn(...c.args),this.fnMap.set(t,L(L({},c),{},{fn:e,args:s,skipFn:r}))}else{const c=window.setTimeout(()=>{const d=this.fnMap.get(t);d&&d.fn(...d.args),this.fnMap.delete(t)},i);this.fnMap.set(t,{fn:e,threshold:i,timer:c,args:s,skipFn:r})}}},UN=MN.throttleByKey.bind(MN);function yv(e){return typeof e=="object"&&e!==null&&!(e instanceof RegExp)}function Iv(e,t){if(!yv(e)||!yv(t)||Array.isArray(e)&&!Array.isArray(t)||!Array.isArray(e)&&Array.isArray(t))return t;if(Array.isArray(t)&&Array.isArray(e)){const i=[...e];for(let r=0;r<t.length;r++)i[r]=Iv(e[r],t[r]);return i}{const i=L({},e);for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&(Object.prototype.hasOwnProperty.call(e,r)?i[r]=Iv(e[r],t[r]):i[r]=t[r]);return i}}function A_(e,t){let i=[0];if(i=new Array(t).fill(0),e===0)return i;let r=0;for(;e>0&&(i[r]=255&e,e>>=8,r++,r!==t););return i}function Dh(e){return typeof e=="number"?e:e.exact||e.ideal||e.max||e.min||0}function iT(e,t){try{return typeof e=="object"&&typeof t=="object"&&JSON.stringify(e)===JSON.stringify(t)}catch{return!1}}function Av(e){return un(e).call(e,(t,i)=>t+i,0)}function RU(e){const t="0123456789abcdef";function i(D){let x,k="";for(x=0;x<=3;x++)k+=t.charAt(D>>8*x+4&15)+t.charAt(D>>8*x&15);return k}function r(D,x){const k=(65535&D)+(65535&x);return(D>>16)+(x>>16)+(k>>16)<<16|65535&k}function o(D,x,k,V,W,K){return r(function(J,se){return J<<se|J>>>32-se}(r(r(x,D),r(V,K)),W),k)}function s(D,x,k,V,W,K,J){return o(x&k|~x&V,D,x,W,K,J)}function a(D,x,k,V,W,K,J){return o(x&V|k&~V,D,x,W,K,J)}function c(D,x,k,V,W,K,J){return o(x^k^V,D,x,W,K,J)}function d(D,x,k,V,W,K,J){return o(k^(x|~V),D,x,W,K,J)}const l=function(D){let x;const k=1+(D.length+8>>6),V=new Array(16*k);for(x=0;x<16*k;x++)V[x]=0;for(x=0;x<D.length;x++)V[x>>2]|=D.charCodeAt(x)<<x%4*8;return V[x>>2]|=128<<x%4*8,V[16*k-2]=8*D.length,V}(e);let h,p,f,m,g,S=1732584193,T=-271733879,C=-1732584194,b=271733878;for(h=0;h<l.length;h+=16)p=S,f=T,m=C,g=b,S=s(S,T,C,b,l[h+0],7,-680876936),b=s(b,S,T,C,l[h+1],12,-389564586),C=s(C,b,S,T,l[h+2],17,606105819),T=s(T,C,b,S,l[h+3],22,-1044525330),S=s(S,T,C,b,l[h+4],7,-176418897),b=s(b,S,T,C,l[h+5],12,1200080426),C=s(C,b,S,T,l[h+6],17,-1473231341),T=s(T,C,b,S,l[h+7],22,-45705983),S=s(S,T,C,b,l[h+8],7,1770035416),b=s(b,S,T,C,l[h+9],12,-1958414417),C=s(C,b,S,T,l[h+10],17,-42063),T=s(T,C,b,S,l[h+11],22,-1990404162),S=s(S,T,C,b,l[h+12],7,1804603682),b=s(b,S,T,C,l[h+13],12,-40341101),C=s(C,b,S,T,l[h+14],17,-1502002290),T=s(T,C,b,S,l[h+15],22,1236535329),S=a(S,T,C,b,l[h+1],5,-165796510),b=a(b,S,T,C,l[h+6],9,-1069501632),C=a(C,b,S,T,l[h+11],14,643717713),T=a(T,C,b,S,l[h+0],20,-373897302),S=a(S,T,C,b,l[h+5],5,-701558691),b=a(b,S,T,C,l[h+10],9,38016083),C=a(C,b,S,T,l[h+15],14,-660478335),T=a(T,C,b,S,l[h+4],20,-405537848),S=a(S,T,C,b,l[h+9],5,568446438),b=a(b,S,T,C,l[h+14],9,-1019803690),C=a(C,b,S,T,l[h+3],14,-187363961),T=a(T,C,b,S,l[h+8],20,1163531501),S=a(S,T,C,b,l[h+13],5,-1444681467),b=a(b,S,T,C,l[h+2],9,-51403784),C=a(C,b,S,T,l[h+7],14,1735328473),T=a(T,C,b,S,l[h+12],20,-1926607734),S=c(S,T,C,b,l[h+5],4,-378558),b=c(b,S,T,C,l[h+8],11,-2022574463),C=c(C,b,S,T,l[h+11],16,1839030562),T=c(T,C,b,S,l[h+14],23,-35309556),S=c(S,T,C,b,l[h+1],4,-1530992060),b=c(b,S,T,C,l[h+4],11,1272893353),C=c(C,b,S,T,l[h+7],16,-155497632),T=c(T,C,b,S,l[h+10],23,-1094730640),S=c(S,T,C,b,l[h+13],4,681279174),b=c(b,S,T,C,l[h+0],11,-358537222),C=c(C,b,S,T,l[h+3],16,-722521979),T=c(T,C,b,S,l[h+6],23,76029189),S=c(S,T,C,b,l[h+9],4,-640364487),b=c(b,S,T,C,l[h+12],11,-421815835),C=c(C,b,S,T,l[h+15],16,530742520),T=c(T,C,b,S,l[h+2],23,-995338651),S=d(S,T,C,b,l[h+0],6,-198630844),b=d(b,S,T,C,l[h+7],10,1126891415),C=d(C,b,S,T,l[h+14],15,-1416354905),T=d(T,C,b,S,l[h+5],21,-57434055),S=d(S,T,C,b,l[h+12],6,1700485571),b=d(b,S,T,C,l[h+3],10,-1894986606),C=d(C,b,S,T,l[h+10],15,-1051523),T=d(T,C,b,S,l[h+1],21,-2054922799),S=d(S,T,C,b,l[h+8],6,1873313359),b=d(b,S,T,C,l[h+15],10,-30611744),C=d(C,b,S,T,l[h+6],15,-1560198380),T=d(T,C,b,S,l[h+13],21,1309151649),S=d(S,T,C,b,l[h+4],6,-145523070),b=d(b,S,T,C,l[h+11],10,-1120210379),C=d(C,b,S,T,l[h+2],15,718787259),T=d(T,C,b,S,l[h+9],21,-343485551),S=r(S,p),T=r(T,f),C=r(C,m),b=r(b,g);return i(S)+i(T)+i(C)+i(b)}let vU=1,mn=console,jr=class{static setLogger(e){mn=e}constructor(e,t){ut(this,"id",void 0),ut(this,"lockingPromise",Z.resolve()),ut(this,"locks",0),ut(this,"name",""),ut(this,"lockId",void 0),this.lockId=vU++,e&&(this.name=e),t&&(this.id=t),this.logger("created")}logger(e,t){const i=(this.id?"[".concat(this.id,"]"):"")+"[lock-".concat(this.name,"-").concat(this.lockId,"]"),r=e==="created"?"is ".concat(e,"."):"is ".concat(e,", current queue ").concat(this.locks,". ").concat(t??"");mn.debug("".concat(i," ").concat(r))}setId(e){this.id=e}get isLocked(){return this.locks>0}lock(e){let t;this.locks+=1,this.logger("locked",e);const i=new Z(o=>{t=()=>{this.locks-=1,this.logger("unlocked",e),o()}}),r=this.lockingPromise.then(()=>t);return this.lockingPromise=this.lockingPromise.then(()=>i),r}};function mr(e,t){return function(i,r,o){const s=o.value;if(typeof s!="function")throw new Error("Cannot use mutex on object property.");return o.value=async function(){const a=this[t];if(!a)throw new Error("mutex property key ".concat(t," doesn't exist on ").concat(e));const c=await a.lock("From ".concat(e,".").concat(r));try{for(var d=arguments.length,l=new Array(d),h=0;h<d;h++)l[h]=arguments[h];return await s.apply(this,l)}finally{c()}},o}}const yr={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function fa(e,t){const i=Math.floor(t.timeout*Math.pow(t.timeoutFactor,e));return Math.min(t.maxRetryTimeout,i)}function ma(e,t,i,r){const o=Object.assign({},yr,r);let s=o.timeout;const a=async()=>{await function(l){return new Z(h=>{window.setTimeout(h,l)})}(s),s*=o.timeoutFactor,s=Math.min(o.maxRetryTimeout,s)};let c=!1;const d=new Z(async(l,h)=>{t=t||(()=>!1),i=i||(()=>!0);for(let p=0;p<o.maxRetryCount;p+=1){if(c)return h(new oe(O.OPERATION_ABORTED));try{const f=await e();if(!t(f,p)||p+1===o.maxRetryCount)return l(f);await a()}catch(f){if(!i(f,p)||p+1===o.maxRetryCount)return h(f);await a()}}});return d.cancel=()=>c=!0,d}let Lf,kf=class{constructor(e){ut(this,"input",[]),ut(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}mean(){var e;return this.input.length===0?0:un(e=this.input).call(e,(t,i)=>t+i)/this.input.length}},Mf=0,rT=0;function xN(e,t,i,r){return new Z((o,s)=>{t.responseType=t.responseType||"json",t.data&&!i?(t.data=JSON.stringify(t.data),Mf+=Vd(t.data)):i&&(t.data.size?Mf+=t.data.size:t.data instanceof FormData?Mf+=TU(t.data):Mf+=Vd(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,hs.request(t).then(a=>{typeof a.data=="string"?rT+=Vd(a.data):a.data instanceof ArrayBuffer||a.data instanceof Uint8Array?rT+=a.data.byteLength:rT+=Vd(JSON.stringify(a.data)),o(a.data)}).catch(a=>{hs.isCancel(a)?s(new oe(O.OPERATION_ABORTED,"cancel token canceled")):a.code==="ECONNABORTED"?s(new oe(O.NETWORK_TIMEOUT,a.message)):a.response?s(new oe(O.NETWORK_RESPONSE_ERROR,a.response.status)):s(new oe(O.NETWORK_ERROR,a.message))})})}async function CU(e,t){const i=new Blob([t.data],{type:"buffer"});return await xN(e,L(L({},t),{},{data:i,headers:{"Content-Type":"application/octet-stream"}}),!0)}const nc=()=>window.isSecureContext!==void 0;function oc(e){if(Array.isArray(e))return e.map(i=>i);if(!wv(e))return e;const t={};for(const i in e){const r=e[i];wv(r)||Array.isArray(r)?t[i]=oc(r):t[i]=r}return t}function wv(e){return!(typeof e!="object"||Array.isArray(e)||!e)}let Ea=class{constructor(e){ut(this,"input",[]),ut(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}};const Rs={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},Uf={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],transport:{bytesSent:0,bytesReceived:0,packetsSent:0,packetsReceived:0},selectedCandidatePair:{id:"unknown",localCandidate:Rs,remoteCandidate:Rs},updateInterval:0},VN={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0,packetsDiscarded:0,framesAssembledFromMultiplePackets:0,totalProcessingDelay:0,avgDecodeMs:0,avgFramesAssembledFromMultiplePacketsMs:0,avgProcessingDelayMs:0,avgInterFrameDelayMs:0,totalAssemblyTime:0},FN={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},BN={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},bv={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packetsDiscarded:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0,totalSamplesReceived:0,silentConcealedSamples:0,concealmentEvents:0,freezeMs80:0,freezeMs200:0,freezeSamples80:0,freezeSamples200:0};let jN=class{constructor(e,t){ut(this,"onFirstVideoReceived",void 0),ut(this,"onFirstVideoDecoded",void 0),ut(this,"onFirstAudioReceived",void 0),ut(this,"onFirstVideoDecodedTimeout",void 0),ut(this,"onFirstAudioDecoded",void 0),ut(this,"onSelectedLocalCandidateChanged",void 0),ut(this,"onSelectedRemoteCandidateChanged",void 0),ut(this,"videoIsReady",!1),ut(this,"videoIsReady2",{}),ut(this,"pc",void 0),ut(this,"options",void 0),ut(this,"intervalTimer",void 0),ut(this,"stats",oc(Uf)),ut(this,"isFirstVideoReceived",{}),ut(this,"isFirstVideoDecoded",{}),ut(this,"isFirstAudioReceived",{}),ut(this,"isFirstAudioDecoded",{}),ut(this,"isFirstVideoDecodedTimeout",{}),ut(this,"lossRateWindowStats",[]),this.pc=e,this.options=t,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new Z(e=>{e({local:L({},Rs),remote:L({},Rs)})})}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,t){this.videoIsReady2[e]=t}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const t=this.lossRateWindowStats.length,i=["videoSend","audioSend","videoRecv","audioRecv"];let r=0,o=0,s=0,a=0;for(const c of i)e[c].forEach((d,l)=>{if(!this.lossRateWindowStats[t-1][c][l]||!this.lossRateWindowStats[0][c][l])return;const h=this.lossRateWindowStats[t-1][c][l].packets-this.lossRateWindowStats[0][c][l].packets,p=this.lossRateWindowStats[t-1][c][l].packetsLost-this.lossRateWindowStats[0][c][l].packetsLost;c==="videoSend"||c==="audioSend"?(r+=h,s+=p):(o+=h,a+=p),Number.isNaN(h)||Number.isNaN(h)?d.packetLostRate=0:d.packetLostRate=h<=0||p<=0?0:p/(h+p)});e.sendPacketLossRate=r<=0||s<=0?0:s/(r+s),e.recvPacketLossRate=o<=0||a<=0?0:a/(o+a)}},xf=class extends jN{constructor(){super(...arguments),ut(this,"_stats",Uf),ut(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const e=await this._getStats(),t=this.statsResponsesToObjects(e);this._stats=oc(Uf);const i=t.filter(o=>o.type==="ssrc");this.processSSRCStats(i);const r=t.find(o=>o.type==="VideoBwe");r&&this.processBandwidthStats(r),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach(t=>{var i;const r=z(i=t.id).call(i,"send");switch("".concat(t.mediaType,"_").concat(r?"send":"recv")){case"video_send":{const o=oc(FN);o.codec=t.googCodecName,o.adaptionChangeReason="none",t.googCpuLimitedResolution&&(o.adaptionChangeReason="cpu"),t.googBandwidthLimitedResolution&&(o.adaptionChangeReason="bandwidth"),o.avgEncodeMs=Number(t.googAvgEncodeMs),o.inputFrame={width:Number(t.googFrameWidthInput)||Number(t.googFrameWidthSent),height:Number(t.googFrameHeightInput)||Number(t.googFrameHeightSent),frameRate:Number(t.googFrameRateInput)},o.sentFrame={width:Number(t.googFrameWidthSent),height:Number(t.googFrameHeightSent),frameRate:Number(t.googFrameRateInput)},o.firsCount=Number(t.googFirReceived),o.nacksCount=Number(t.googNacksReceived),o.plisCount=Number(t.googPlisReceived),o.frameCount=Number(t.framesEncoded),o.bytes=Number(t.bytesSent),o.packets=Number(t.packetsSent),o.packetsLost=Number(t.packetsLost),o.ssrc=Number(t.ssrc),o.rttMs=Number(t.googRtt||0),this._stats.videoSend.push(o),this._stats.rtt=o.rttMs;break}case"video_recv":{const o=oc(VN),s=this.lastDecodeVideoReceiverStats.get(Number(t.ssrc));if(o.codec=t.googCodecName,o.targetDelayMs=Number(t.googTargetDelayMs),o.renderDelayMs=Number(t.googRenderDelayMs),o.currentDelayMs=Number(t.googCurrentDelayMs),o.minPlayoutDelayMs=Number(t.googMinPlayoutDelayMs),o.decodeMs=Number(t.googDecodeMs),o.maxDecodeMs=Number(t.googMaxDecodeMs),o.receivedFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateReceived)},o.decodedFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateDecoded)},o.decodeFrameRate=Number(t.googFrameRateDecoded),o.outputFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateOutput)},o.jitterBufferMs=Number(t.googJitterBufferMs),o.firsCount=Number(t.googFirsSent),o.nacksCount=Number(t.googNacksSent),o.plisCount=Number(t.googPlisSent),o.framesDecodeCount=Number(t.framesDecoded),o.bytes=Number(t.bytesReceived),o.packets=Number(t.packetsReceived),o.packetsLost=Number(t.packetsLost),o.ssrc=Number(t.ssrc),o.packets>0&&!this.isFirstVideoReceived[o.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(o.ssrc),this.isFirstVideoReceived[o.ssrc]=!0),o.framesDecodeCount>0&&!this.isFirstVideoDecoded[o.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(o.ssrc,o.decodedFrame.width,o.decodedFrame.height),this.isFirstVideoDecoded[o.ssrc]=!0),s){const a=s.stats,c=Date.now()-s.lts;o.framesDecodeFreezeTime=a.framesDecodeFreezeTime,o.framesDecodeInterval=a.framesDecodeInterval,o.framesDecodeCount>a.framesDecodeCount&&this.isFirstVideoDecoded[o.ssrc]?(s.lts=Date.now(),o.framesDecodeInterval=c,o.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc,10))?o.framesDecodeFreezeTime+=o.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):o.framesDecodeCount<s.stats.framesDecodeCount&&(o.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(o.ssrc,{stats:L({},o),lts:Date.now()}),this._stats.videoRecv.push(o);break}case"audio_recv":{const o=oc(bv);o.codec=t.googCodecName,o.outputLevel=Math.abs(Number(t.audioOutputLevel))/32767,o.decodingCNG=Number(t.googDecodingCNG),o.decodingCTN=Number(t.googDecodingCTN),o.decodingCTSG=Number(t.googDecodingCTSG),o.decodingNormal=Number(t.googDecodingNormal),o.decodingPLC=Number(t.googDecodingPLC),o.decodingPLCCNG=Number(t.googDecodingPLCCNG),o.expandRate=Number(t.googExpandRate),o.accelerateRate=Number(t.googAccelerateRate),o.preemptiveExpandRate=Number(t.googPreemptiveExpandRate),o.secondaryDecodedRate=Number(t.googSecondaryDecodedRate),o.speechExpandRate=Number(t.googSpeechExpandRate),o.preferredJitterBufferMs=Number(t.googPreferredJitterBufferMs),o.jitterBufferMs=Number(t.googJitterBufferMs),o.jitterMs=Number(t.googJitterReceived),o.bytes=Number(t.bytesReceived),o.packets=Number(t.packetsReceived),o.packetsLost=Number(t.packetsLost),o.ssrc=Number(t.ssrc),o.receivedFrames=Number(t.googDecodingCTN)||Number(t.packetsReceived),o.droppedFrames=Number(t.googDecodingPLC)+Number(t.googDecodingPLCCNG)||Number(t.packetsLost),o.receivedFrames>0&&!this.isFirstAudioReceived[o.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(o.ssrc),this.isFirstAudioReceived[o.ssrc]=!0),o.decodingNormal>0&&!this.isFirstAudioDecoded[o.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(o.ssrc),this.isFirstAudioDecoded[o.ssrc]=!0),this._stats.audioRecv.push(o);break}case"audio_send":{const o=oc(BN);o.codec=t.googCodecName,o.inputLevel=Math.abs(Number(t.audioInputLevel))/32767,o.aecReturnLoss=Number(t.googEchoCancellationReturnLoss||0),o.aecReturnLossEnhancement=Number(t.googEchoCancellationReturnLossEnhancement||0),o.residualEchoLikelihood=Number(t.googResidualEchoLikelihood||0),o.residualEchoLikelihoodRecentMax=Number(t.googResidualEchoLikelihoodRecentMax||0),o.bytes=Number(t.bytesSent),o.packets=Number(t.packetsSent),o.packetsLost=Number(t.packetsLost),o.ssrc=Number(t.ssrc),o.rttMs=Number(t.googRtt||0),this._stats.rtt=o.rttMs,this._stats.audioSend.push(o);break}}})}_getStats(){return new Z((e,t)=>{this.pc.getStats(e,t)})}statsResponsesToObjects(e){const t=[];return e.result().forEach(i=>{const r={id:i.id,timestamp:i.timestamp.valueOf().toString(),type:i.type};i.names().forEach(o=>{r[o]=i.stat(o)}),t.push(r)}),t}},Ou=function(e){return e.BANDWIDTH="bandwidth",e.CPU="cpu",e.NONE="none",e.OTHER="other",e}({}),Vf=function(e){return e.L1T1="L1T1",e.L1T2="L1T2",e.L1T3="L1T3",e.L1T3_KEY="L1T3_KEY",e.L2T1_KEY="L2T1_KEY",e.L2T2_KEY="L2T2_KEY",e.L2T3_KEY="L2T3_KEY",e.L3T1_KEY="L3T1_KEY",e.L3T2_KEY="L3T2_KEY",e.L3T3_KEY="L3T3_KEY",e}({}),vs=function(e){return e[e.new=0]="new",e[e.connecting=1]="connecting",e[e.connected=2]="connected",e[e.disconnected=3]="disconnected",e[e.failed=4]="failed",e[e.closed=5]="closed",e}({}),bo=function(e){return e.CERTIFICATE="certificate",e.CODEC="codec",e.CANDIDATE_PAIR="candidate-pair",e.LOCAL_CANDIDATE="local-candidate",e.REMOTE_CANDIDATE="remote-candidate",e.INBOUND="inbound-rtp",e.TRACK="track",e.OUTBOUND="outbound-rtp",e.PC="peer-connection",e.REMOTE_INBOUND="remote-inbound-rtp",e.REMOTE_OUTBOUND="remote-outbound-rtp",e.TRANSPORT="transport",e.CSRC="csrc",e.DATA_CHANNEL="data-channel",e.STREAM="stream",e.SENDER="sender",e.RECEIVER="receiver",e}({});var vl=function(e){return e[e.kNone=1]="kNone",e[e.kMillisecondsFromSeconds=1e3]="kMillisecondsFromSeconds",e[e.kBytesToBits=8]="kBytesToBits",e}(vl||{});function Ff(e,t,i,r){let o=arguments.length>4&&arguments[4]!==void 0?arguments[4]:vl.kNone;if(!t)return;const s=Number(t[i]);if(typeof s!="number")return;const a=Number(t[r]);if(typeof a!="number")return;if(!e)return a?s/a*o:void 0;const c=Number(e[i]);if(typeof c!="number")return;const d=Number(e[r]);if(typeof d!="number")return;const l=a-d;return l?(s-c)/l*o:void 0}let yU=class extends jN{constructor(){super(...arguments),ut(this,"_stats",Uf),ut(this,"report",void 0),ut(this,"lastDecodeVideoReceiverStats",new Map),ut(this,"lastVideoFramesRecv",new Map),ut(this,"lastVideoFramesSent",new Map),ut(this,"lastVideoFramesDecode",new Map),ut(this,"lastVideoFramesOutput",new Map),ut(this,"lastVideoJBDelay",new Map),ut(this,"lastAudioJBDelay",new Map),ut(this,"mediaBytesSent",new Map),ut(this,"mediaBytesRetransmit",new Map),ut(this,"mediaBytesTargetEncode",new Map),ut(this,"lastDecodeAudioReceiverStats",new Map),ut(this,"lastAudioConcealment",new Map),ut(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=oc(Uf),this.report.forEach(e=>{switch(e.type){case bo.OUTBOUND:case bo.INBOUND:{const t=e.mediaType||e.kind,i=!t&&"frameWidth"in e,r=!t&&!("frameWidth"in e);e.type===bo.OUTBOUND?t==="audio"||r?this.processAudioOutboundStats(e):(t==="video"||i)&&this.processVideoOutboundStats(e):e.type===bo.INBOUND&&(t==="audio"||r?this.processAudioInboundStats(e):(t==="video"||i)&&this.processVideoInboundStats(e));break}case bo.TRANSPORT:{this.processTransportStats(e);const t=this.report.get(e.selectedCandidatePairId);t&&this.processCandidatePairStats(t);break}case bo.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}}),this.updateSendBitrate(),this._stats.updateInterval=Date.now()-this.stats.timestamp,this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const e=await this.pc.getStats(),t={local:L({},Rs),remote:L({},Rs)};return e.forEach(i=>{let r;if(i.type===bo.TRANSPORT&&(r=e.get(i.selectedCandidatePairId)),i.type===bo.CANDIDATE_PAIR&&i.selected&&(r=i),r){const o=(s,a)=>{s.type=a.type,s.id=a.id,a.address&&(s.address=a.address),a.candidateType&&(s.candidateType=a.candidateType),a.port&&(s.port=a.port),a.priority&&(s.priority=a.priority),a.protocol&&(s.protocol=a.protocol),a.relayProtocol&&(s.relayProtocol=a.relayProtocol)};if(r.localCandidateId){const s=e.get(r.localCandidateId);s&&o(t.local,s)}if(r.remoteCandidateId){const s=e.get(r.remoteCandidateId);s&&o(t.remote,s)}}}),t}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach(t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)}),this._stats.audioSend.forEach(t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const t=this.report.get(e.localCandidateId);t&&this.processCandidateStats(t)}if(e.remoteCandidateId){const t=this.report.get(e.remoteCandidateId);t&&this.processCandidateStats(t)}}processCandidateStats(e){let t;e.type===bo.LOCAL_CANDIDATE&&(t=this._stats.selectedCandidatePair.localCandidate),e.type===bo.REMOTE_CANDIDATE&&(t=this._stats.selectedCandidatePair.remoteCandidate),t&&(t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol),e.type===bo.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==t.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(L({},t),L({},this.stats.selectedCandidatePair.localCandidate)),e.type===bo.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==t.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(L({},t),L({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let t=this._stats.audioRecv.find(r=>r.ssrc===e.ssrc);t||(t=oc(bv),this._stats.audioRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.packetsDiscarded=e.packetsDiscarded,t.bytes=e.bytesReceived,t.jitterMs=1e3*e.jitter,t.retransmittedBytesReceived=e.retransmittedBytesReceived,t.retransmittedPacketsReceived=e.retransmittedPacketsReceived,t.totalProcessingDelay=e.totalProcessingDelay,t.jitterBufferEmittedCount=e.jitterBufferEmittedCount,t.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp;const i=this.lastDecodeAudioReceiverStats.get(t.ssrc);t.avgProcessingDelayMs=Ff(i,t,"totalProcessingDelay","jitterBufferEmittedCount",vl.kMillisecondsFromSeconds),this.processAudioTrackReceiverStats(e,e.trackId,t),this.calculateAudioFreeze(t,i,e),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),t.receivedFrames||(t.receivedFrames=e.packetsReceived),t.droppedFrames||(t.droppedFrames=e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.outputLevel&&t.outputLevel>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),typeof e.concealedSamples=="number"&&(t.concealedSamples=e.concealedSamples),this.lastDecodeAudioReceiverStats.set(t.ssrc,L({},t))}calculateAudioFreeze(e,t,i){const r=this.lastAudioConcealment.get(e.ssrc);if(t!=null&&r!=null){const o=r.lts,s=i.timestamp,a=s-o;if(a<=0)return;const c=e.concealedSamples-t.concealedSamples-0,d=r.nonSilent+c,l=e.totalSamplesReceived-t.totalSamplesReceived;if(l<=0)return;const h=80*l/a,p=200*l/a,f=a/l;let m=0;e.freezeSamples80=t.freezeSamples80,e.freezeMs80=t.freezeMs80,d>h&&(r.plc80>0?(e.freezeSamples80+=c,e.freezeMs80+=Math.round(c*f)):(e.freezeSamples80+=d,e.freezeMs80+=Math.round(d*f)),m=r.plc80+1);let g=0;e.freezeSamples200=t.freezeSamples200,e.freezeMs200=t.freezeMs200,d>p&&(r.plc200>0?(e.freezeSamples200+=c,e.freezeMs200+=Math.round(c*f)):(e.freezeSamples200+=d,e.freezeMs200+=Math.round(d*f)),g=r.plc200+1),this.lastAudioConcealment.set(e.ssrc,{nonSilent:c,lts:s,plc80:m,plc200:g})}else e.freezeSamples80=0,e.freezeSamples200=0,e.freezeMs80=0,e.freezeMs200=0,this.lastAudioConcealment.set(e.ssrc,{nonSilent:0,lts:i.timestamp,plc80:0,plc200:0})}processVideoInboundStats(e){let t=this._stats.videoRecv.find(a=>a.ssrc===e.ssrc);t||(t=oc(VN),this._stats.videoRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.framesDecodeCount=e.framesDecoded,t.framesDroppedCount=e.framesDropped,t.totalInterFrameDelay=e.totalInterFrameDelay,t.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay,t.totalFreezesDuration=e.totalFreezesDuration,t.totalProcessingDelay=e.totalProcessingDelay,t.packetsDiscarded=e.packetsDiscarded,t.framesAssembledFromMultiplePackets=e.framesAssembledFromMultiplePackets,t.totalAssemblyTime=e.totalAssemblyTime,t.keyFramesDecoded=e.keyFramesDecoded,t.retransmittedBytesReceived=e.retransmittedBytesReceived,t.retransmittedPacketsReceived=e.retransmittedPacketsReceived,t.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp;const i=this.lastDecodeVideoReceiverStats.get(t.ssrc),r=this.lastVideoFramesDecode.get(t.ssrc),o=this.lastVideoFramesOutput.get(t.ssrc),s=Date.now();if(t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]){const a=t.decodedFrame?t.decodedFrame.width:0,c=t.decodedFrame?t.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,a,c),this.isFirstVideoDecoded[t.ssrc]=!0}if(i){const a=i.stats,c=s-i.lts;t.framesDecodeFreezeTime=a.framesDecodeFreezeTime,t.framesDecodeInterval=a.framesDecodeInterval,!this.isFirstVideoDecoded[t.ssrc]&&c>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[t.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(t.ssrc),this.isFirstVideoDecodedTimeout[t.ssrc]=!0),t.framesDecodeCount>a.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(i.lts=Date.now(),t.framesDecodeInterval=c,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<a.framesDecodeCount&&(t.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(i.stats.framesDecodeCount>e.framesDecoded?t.qpSumPerFrame=e.qpSum/e.framesDecoded:t.qpSumPerFrame=(e.qpSum-i.qpSum)/(e.framesDecoded-i.stats.framesDecodeCount))}e.totalDecodeTime&&(t.decodeMs=1e3*e.totalDecodeTime,t.avgDecodeMs=Ff(i==null?void 0:i.stats,t,"decodeMs","framesDecodeCount")),t.avgProcessingDelayMs=Ff(i==null?void 0:i.stats,t,"totalProcessingDelay","framesDecodeCount",vl.kMillisecondsFromSeconds),t.avgFramesAssembledFromMultiplePacketsMs=Ff(i==null?void 0:i.stats,t,"totalAssemblyTime","framesAssembledFromMultiplePackets",vl.kMillisecondsFromSeconds),t.avgInterFrameDelayMs=Ff(i==null?void 0:i.stats,t,"totalInterFrameDelay","framesDecodeCount",vl.kMillisecondsFromSeconds),r&&s-r.lts>=800?(t.decodeFrameRate=Math.round((t.framesDecodeCount-r.count)/((s-r.lts)/1e3)),this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:s,rate:t.decodeFrameRate})):r?t.decodeFrameRate=r.rate:this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:s,rate:0}),t.framesDroppedCount&&e.framesReceived&&(o&&s-o.lts>=800?(t.outputFrameRate=Math.round((e.framesReceived-t.framesDroppedCount-o.count)/((s-o.lts)/1e3)),this.lastVideoFramesOutput.set(t.ssrc,{count:e.framesReceived-t.framesDroppedCount,lts:s,rate:Math.max(t.outputFrameRate,0)})):o?t.outputFrameRate=o.rate:this.lastVideoFramesOutput.set(t.ssrc,{count:e.framesReceived-t.framesDroppedCount,lts:s,rate:0})),this.processVideoTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(t.framesRateFirefox=e.framerateMean),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:L({},t),lts:i?i.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let t=this._stats.videoSend.find(r=>r.ssrc===e.ssrc);t||(t=oc(FN),this._stats.videoSend.push(t));const i=this.mediaBytesSent.get(e.ssrc);if(i)i.add(e.bytesSent);else{const r=new Ea(10);r.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,r)}if(e.retransmittedBytesSent!==void 0){const r=this.mediaBytesRetransmit.get(e.ssrc);if(r)r.add(e.retransmittedBytesSent);else{const o=new Ea(10);o.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,o)}}if(e.totalEncodedBytesTarget){const r=this.mediaBytesTargetEncode.get(e.ssrc);if(r)r.add(e.totalEncodedBytesTarget);else{const o=new Ea(10);o.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,o)}}if(t.ssrc=e.ssrc,t.bytes=e.bytesSent,t.packets=e.packetsSent,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.frameCount=e.framesEncoded,t.adaptionChangeReason=e.qualityLimitationReason,t.scalabilityMode=e.scalabilityMode,t.retransmittedBytesSent=e.retransmittedBytesSent,t.retransmittedPacketsSent=e.retransmittedPacketsSent,t.hugeFramesSent=e.hugeFramesSent,t.keyFramesEncoded=e.keyFramesEncoded,t.targetBitrate=e.targetBitrate,e.totalEncodeTime&&e.framesEncoded){const r=this.lastEncoderMs.get(e.ssrc);if(!r||r.lastFrameCount>e.framesEncoded)t.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const o=e.framesEncoded-r.lastFrameCount,s=e.totalEncodeTime-r.lastEncoderTime;t.avgEncodeMs=1e3*s/o}}if(e.framesEncoded&&e.qpSum){const r=this.lastEncoderMs.get(e.ssrc);!r||r.lastFrameCount>e.framesEncoded?t.qpSumPerFrame=e.qpSum/e.framesEncoded:t.qpSumPerFrame=(e.qpSum-r.lastQpSum)/(e.framesEncoded-r.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,t),this.processVideoTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const r=this.findRemoteStatsId(e.ssrc,bo.REMOTE_INBOUND);r&&this.processRemoteInboundStats(r,t)}}processAudioOutboundStats(e){let t=this._stats.audioSend.find(i=>i.ssrc===e.ssrc);if(t||(t=oc(BN),this._stats.audioSend.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsSent,t.bytes=e.bytesSent,t.retransmittedBytesSent=e.retransmittedBytesSent,t.retransmittedPacketsSent=e.retransmittedPacketsSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,bo.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}processTransportStats(e){this._stats.transport.bytesReceived=e.bytesReceived||this._stats.transport.bytesReceived,this._stats.transport.bytesSent=e.bytesSent||this._stats.transport.bytesSent,this._stats.transport.packetsReceived=e.packetsReceived||this._stats.transport.packetsReceived,this._stats.transport.packetsSent=e.packetsSent||this._stats.transport.packetsSent}findRemoteStatsId(e,t){var i;const r=Array.from(Vr(i=this.report).call(i)).find(o=>o.type===t&&o.ssrc===e);return r?r.id:null}processVideoMediaSource(e,t){const i=this.report.get(e);i&&i.width&&i.height&&i.framesPerSecond&&(t.inputFrame={width:i.width,height:i.height,frameRate:i.framesPerSecond})}processAudioMediaSource(e,t){const i=this.report.get(e);i&&(t.inputLevel=i.audioLevel)}processVideoTrackSenderStats(e,t,i){var r,o,s,a;const c=t?this.report.get(t):void 0,d=(r=c==null?void 0:c.framesSent)!==null&&r!==void 0?r:e.framesSent;if(typeof d!="number")return;let l=(o=c==null?void 0:c.frameWidth)!==null&&o!==void 0?o:e.frameWidth,h=(s=c==null?void 0:c.frameHeight)!==null&&s!==void 0?s:e.frameHeight,p=(a=c==null?void 0:c.framesPerSecond)!==null&&a!==void 0?a:e.framesPerSecond;if(typeof l=="number"&&typeof h=="number"||(l=0,h=0),p==null){const f=Date.now(),m=this.lastVideoFramesSent.get(i.ssrc);m&&f-m.lts>=800?(p=Math.round((d-m.count)/((f-m.lts)/1e3)),this.lastVideoFramesSent.set(i.ssrc,{count:d,lts:f,rate:p})):m?p=m.rate:this.lastVideoFramesSent.set(i.ssrc,{count:d,lts:f,rate:0})}i.sentFrame={width:l,height:h,frameRate:Math.max(0,p)}}processVideoTrackReceiverStats(e,t,i){var r,o,s,a,c;const d=t?this.report.get(t):void 0,l=(r=d==null?void 0:d.framesReceived)!==null&&r!==void 0?r:e.framesReceived,h=(o=d==null?void 0:d.frameWidth)!==null&&o!==void 0?o:e.frameWidth,p=(s=d==null?void 0:d.frameHeight)!==null&&s!==void 0?s:e.frameHeight,f=(a=d==null?void 0:d.jitterBufferDelay)!==null&&a!==void 0?a:e.jitterBufferDelay,m=(c=d==null?void 0:d.jitterBufferEmittedCount)!==null&&c!==void 0?c:e.jitterBufferEmittedCount;if(typeof l=="number"){const g=this.lastVideoFramesRecv.get(i.ssrc),S=Date.now();i.framesReceivedCount=l;let T=0;g&&S-g.lts>=800?(T=Math.round((l-g.count)/((S-g.lts)/1e3)),this.lastVideoFramesRecv.set(i.ssrc,{count:l,lts:S,rate:T})):g?T=g.rate:this.lastVideoFramesRecv.set(i.ssrc,{count:l,lts:S,rate:0}),i.receivedFrame={width:h||0,height:p||0,frameRate:T||0},i.decodedFrame={width:h||0,height:p||0,frameRate:i.decodeFrameRate||0},i.outputFrame={width:h||0,height:p||0,frameRate:i.outputFrameRate||i.decodeFrameRate||0}}if(f&&m){const g=this.lastVideoJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let S=g.jitterBufferMs;const T=m-g.jitterBufferEmittedCount;T>0&&(S=1e3*(f-g.jitterBufferDelay)/T),i.jitterBufferMs=S,i.currentDelayMs=Math.round(S),this.lastVideoJBDelay.set(i.ssrc,{jitterBufferDelay:f,jitterBufferEmittedCount:m,jitterBufferMs:i.currentDelayMs})}}processAudioTrackSenderStats(e,t,i){var r,o,s,a;const c=t?this.report.get(t):void 0,d=(r=(o=c==null?void 0:c.echoReturnLoss)!==null&&o!==void 0?o:e.echoReturnLoss)!==null&&r!==void 0?r:0,l=(s=(a=c==null?void 0:c.echoReturnLossEnhancement)!==null&&a!==void 0?a:e.echoReturnLossEnhancement)!==null&&s!==void 0?s:0;i.aecReturnLoss=d,i.aecReturnLossEnhancement=l}processAudioTrackReceiverStats(e,t,i){var r,o,s,a,c,d,l,h,p;const f=t?this.report.get(t):void 0,m=(r=f==null?void 0:f.removedSamplesForAcceleration)!==null&&r!==void 0?r:e.removedSamplesForAcceleration,g=(o=f==null?void 0:f.totalSamplesReceived)!==null&&o!==void 0?o:e.totalSamplesReceived,S=(s=f==null?void 0:f.jitterBufferDelay)!==null&&s!==void 0?s:e.jitterBufferDelay,T=(a=f==null?void 0:f.jitterBufferEmittedCount)!==null&&a!==void 0?a:e.jitterBufferEmittedCount,C=(c=f==null?void 0:f.audioLevel)!==null&&c!==void 0?c:e==null?void 0:e.audioLevel,b=(d=f==null?void 0:f.totalSamplesDuration)!==null&&d!==void 0?d:e==null?void 0:e.totalSamplesDuration,D=(l=f==null?void 0:f.concealedSamples)!==null&&l!==void 0?l:e.concealedSamples,x=(h=f==null?void 0:f.silentConcealedSamples)!==null&&h!==void 0?h:e.silentConcealedSamples,k=(p=f==null?void 0:f.concealmentEvents)!==null&&p!==void 0?p:e.concealmentEvents;if(typeof g=="number"&&(i.totalSamplesReceived=g),typeof x=="number"&&(i.silentConcealedSamples=x),typeof k=="number"&&(i.concealmentEvents=k),typeof D=="number"&&(i.concealedSamples=D),m&&g&&(i.accelerateRate=m/g),S&&T){const W=this.lastAudioJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let K=W.jitterBufferMs;const J=T-W.jitterBufferEmittedCount;J>0&&(K=1e3*(S-W.jitterBufferDelay)/J),i.jitterBufferMs=Math.round(K),this.lastAudioJBDelay.set(i.ssrc,{jitterBufferDelay:S,jitterBufferEmittedCount:T,jitterBufferMs:i.jitterBufferMs})}i.outputLevel=C;let V=1920;b&&g&&(V=g/b/50,i.receivedFrames=Math.round(g/V)),D&&(i.droppedFrames=Math.round(D/V))}processRemoteInboundStats(e,t){const i=this.report.get(e);i&&(t.packetsLost=i.packetsLost,i.roundTripTime&&(t.rttMs=1e3*i.roundTripTime),i.jitter&&(t.jitterMs=1e3*i.jitter),i.timestamp&&(t.timestamp=i.timestamp))}getCodecFromCodecStats(e){const t=this.report.get(e);if(!t)return"";const i=t.mimeType.match(/\/(.*)$/);return i&&i[1]?i[1]:""}updateSendBitrate(){let e=0,t=null,i=null;this.mediaBytesSent.forEach(o=>{e+=o.diffMean()}),this.mediaBytesRetransmit.forEach(o=>{t=t===null?o.diffMean():t+o.diffMean()}),this.mediaBytesTargetEncode.forEach(o=>{i=i===null?o.diffMean():i+o.diffMean()});const r=t!==null?e-t:e;this._stats.bitrate={actualEncoded:8*r/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},t!==null&&(this._stats.bitrate.retransmit=8*t/(this.options.updateInterval/1e3)),i!==null&&(this._stats.bitrate.targetEncoded=8*i/(this.options.updateInterval/1e3))}},Ov=class extends jN{updateStats(){return Z.resolve()}};function nT(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,o=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4;const s=function(){const a=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return a&&a[0]?Number(a[0].split("/")[1]):null}();return s?s<76?new xf(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:r,firstVideoDecodedTimeout:o}):new yU(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:r,firstVideoDecodedTimeout:o}):function(a){if(!window.RTCStatsReport)return!1;const c=a.getStats();return!!(c instanceof Z||function(d){return!!d&&(typeof d=="object"||typeof d=="function")&&typeof d.then=="function"}(c))}(e)?new yU(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:r,firstVideoDecodedTimeout:o}):new Ov(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:r,firstVideoDecodedTimeout:o})}const Nv="websdk_ng_install_id";function Js(){try{if(B("INSTALL_ID"))return B("INSTALL_ID");let e=window.localStorage.getItem(Nv);return e||(e=Fd(),window.localStorage.setItem(Nv,e)),F("INSTALL_ID",e),e}catch{return}}const Qs=function(e){if(e.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return e;const t=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-([0-9]+)/);if(t&&t[1]&&t[2]){const i=t[1],r=t[2];return"".concat(i,".").concat(r)}return"4.0.0.999"}("4.24.2"),Nu=function(){try{return JSON.parse("true")===!0}catch{return!0}}();let Yr=function(e){return e.Default="default",e.Auto="auto",e.Relay="relay",e.SdRtn="sd-rtn",e}({});const En=function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),i=["t","s","t"];i.splice(1,0,"e");const r=i.join(""),o=[];for(let c=0;c<6;c++)o.push("1");const s=o.join(""),a={};return a[e]=r,a[t]=s,Object.assign(a,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=En;const Bf={ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,ENABLE_USER_LICENSE_CHECK:!0,DISABLE_FEC:void 0,ENABLE_NTP_REPORT:!1,ENABLE_INSTANT_VIDEO:!1,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:!0,FORCE_ENABLE_AUT_CC:!1,ENABLE_CC_FALLBACK:void 0,SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,ENABLE_SVC_DEFAULT_CODECS:["H264","VP8","VP9","AV1"],SVC:[],ENABLE_FULL_LINK_AV_SYNC:!1,SVC_MODE:null,PRE_SUB_NUM:1,ENABLE_AUT_FEEDBACK:!0,SVC_EXTENDED:["VP9"]},oT={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},sT="v4.24.2-0-g002485b1-dirty(12/12/2025, 5:26:54 PM)",Si={ENABLE_EVENT_REPORT:!0,UPLOAD_LOG:!1,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,ENABLE_PRELOAD:!0,NEW_ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,RESTART_SEQUENCE:["udp_tcp_relay","relay"],FIRST_TCP_CANDIDATE:!1,FIRST_TCP_CANDIDATE_INTERVAL:1e3,TURN_DOMAIN:"edge.agora.io",TURN_DOMAINS:["edge.agora.io"],USE_TURN_IP:!0,NEW_TURN_MODE:4,NEW_FORCE_TURN:!1,USE_NEW_RENDER_FREEZE_TIME:!1,FLS_FALLBACK_TIMEOUT:3e4,RTE_DETAIL_REPORT_INTERVAL:6e4,ENCODE_EXCEPTION_TIMES:5,ENABLE_ENCODE_EXCEPTION:!0,ENCODE_EXCEPTION_VALIDATE_CODEC:["h264"],VIDEO_ENCODER_CONFIG_LIST:[{width:240,height:180},{width:320,height:240},{width:400,height:300},{width:480,height:360},{width:560,height:420},{width:640,height:480}],DELETE_NEQ_AFTER_USER_LEAVE:!0,UPDATE_RTP_CAP_IN_HOST:!1,IOS_BG_TAG:!0,IOS_AUTO_RESTART_BG_TAG:!0,IGNORE_UID_CHECK:!1,ENABLE_UP_SPS_PPS:!1,ENABLE_DOWN_SPS_PPS:!1,NO_EDGES_RETRY:!0,BUFFER_READY_FRAMES:3,FLS_SYNC_AV_PLAY_LIMIT:0,FLS_BUFFER_WAIT_TIME:1500,VOS_CONFIGURE:void 0,ENABLE_QUALITY_FALLBACK:!1,QUALITY_FALLBACK_REHEARSAL:!0,ENABLE_FLS_AV1_FIRST:!1,ENABLE_AP_MULTI_IP:!0,FLS_ENABLE_AV1_DETECT:!0,FLS_ENABLE_AV1_DECODE_DETECT:!0},$e=L(L(L(L({},Si),{},{PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,NOT_REPORT_EVENT:[],PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,SHOW_REPORT_USER_INVOKER_LOG:!0,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,FIRST_H264_PROFILE_LEVEL_ID:"42001f",FIRST_PACKETIZATION_MODE:"",X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_MANAGER_WSS:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,FINGERPRINT:null,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,ENABLE_AUDIO_TOPN:!1,ENABLE_AUDIO_METADATA:!1,ENABLE_AUDIO_PTS:!1,TOPN_SMOOTH_LEVEL:void 0,TOPN_NEW_SPEAKER_DELAY:void 0,TOPN_SWITCH_HOLD_MS:void 0,TOPN_AUDIO_GAIN:void 0,TOPN_SILENCE_THRESHOLD:250,AP_AREA:!0,ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_WSS:"",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,DATASTREAM_MAX_RETRANSMITS:10,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ENABLE_AUDIO_RED:!1,OPUS_PTIME:void 0,AUDIO_DUPLICATE_NUM:void 0,ENABLE_ABSSENDTIME_AS_SENTTS:!0,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,DC_JOIN_WITH_FAILBACK:4e3,DC_CONNECTION_TIMEOUT:2e3,DC_PINGPONG_INTERVAL:2e3,DC_DEBUG_LOG:!1,UNSUPPORTED_VIDEO_UPLINK_CODEC:[],UNSUPPORTED_VIDEO_DOWNLINK_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:oT,CUSTOM_ADAPTATION_DEFAULT_MODE:"",HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,DISABLE_SCREEN_SHARE_REMB:!1},Bf),{},{USE_CANDIDATE_FROM_AP_DETAIL:!1,AP_REQUEST_DETAIL:void 0,ENABLE_ROLE_SELECT_EDGE:!1,CLIENT_ROLE_OPTIONS:void 0,REMOTE_VIDEO_STREAM_TYPE:void 0,COMPATIBLE_SDP_EXTENSION:["gdpr_forbidden"],LIMIT_BITRATE:void 0,EXPERIMENTS:{},USE_PUB_RTX:!0,USE_SUB_RTX:!0,ENABLE_DATASTREAM_2:!1,USE_XR:!0,ENABLE_PREALLOC_PC:!1,ENABLE_PRE_SUB:!1,ENABLE_SVC:!1,ENABLE_FORCE_HLS:!1,MAX_WEBAUDIO_VOLUME:300,ENABLE_VOS_FALLBACK:!1,ENABLE_FALLBACK_TO_HLS:!1,ENABLE_PRE_RENDER:!1,FORCE_DISABLE_AUTO_SUB:!1,ENABLE_PRE_SUB_WITH_PRE_PC:!0,PRE_USE_LOCAL_CODECS:!0},{INSTALL_ID:""}),{},{K_MIN_RENDER_DELAY:66,USE_STANDARD_BITRATE_DEFAULT:!1,VIDEO_NEW_BITRATE_RATIO:void 0,VIDEO_STANDARD_BITRATE_VERSION:2,BASELINE_MORE_H264_BITRATE_RATIO:1.1,IGNORE_RTC_DEVICE_CHECK:!1,FLS_AUTOPLAY_EMITS:!1,ENABLE_DUAL_STREAM_FLAG:!1,FORBID_MODIFY_LOCAL_OFFER_SDP:!1,RESERVE_MID_1_MLINE:!1});function F(e,t,i){var r,o,s;z(r=Object.keys($e)).call(r,e)&&(!i&&z(o=Object.keys(Ye)).call(o,e)||($e[e]=t,e!=="ENABLE_VIDEO_SEI"&&e!=="ENABLE_AUDIO_TOPN"&&e!=="ENABLE_AUDIO_METADATA"&&e!=="ENABLE_AUDIO_PTS"||t!==!0||($e.ENABLE_ENCODED_TRANSFORM=!0),e==="USE_NEW_NETWORK_CONFIG"&&t&&(s=!!t,$e.USE_NEW_NETWORK_CONFIG=s,s&&($e.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],$e.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],$e.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],$e.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],$e.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",$e.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",$e.GATEWAY_DOMAINS=["edge.sd-rtn.com"])),e==="ENABLE_PRE_SUB"&&t&&($e.ENABLE_INSTANT_VIDEO=!0,$e.ENABLE_PREALLOC_PC=!0),e==="ENABLE_SVC"&&t&&($e.ENABLE_AUT_CC=!0),e==="NEW_FORCE_TURN"&&t&&($e.NEW_TURN_MODE||($e.NEW_TURN_MODE=4))))}function B(e){if(e==="TURN_DOMAINS"){const t=$e.TURN_DOMAINS;return z(t).call(t,B("TURN_DOMAIN"))?t:[B("TURN_DOMAIN")].concat(t)}return $e[e]}Nu||($e.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],$e.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],$e.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],$e.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],$e.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],$e.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],$e.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",$e.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",$e.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",$e.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",$e.AREAS=["NORTH_AMERICA","OVERSEA"]);let Zs=function(e){return e[e.REALTIME=1]="REALTIME",e}({});const Ye={};var tt=function(e){return e.SET_SESSION_ID="SET_SESSION_ID",e.SET_RTE_URL="SET_RTE_URL",e.SET_RTE_SID="SET_RTE_SID",e.SET_P2P_ID="SET_P2P_id",e.SET_DC_ID="SET_DC_id",e.SET_UID="SET_UID",e.SET_INT_UID="SET_INT_UID",e.SET_PUB_ID="SET_PUB_ID",e.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",e.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",e.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",e.KEY_METRIC_PRELOAD_START="KEY_METRIC_PRELOAD_START",e.KEY_METRIC_PRELOAD_END="KEY_METRIC_PRELOAD_END",e.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",e.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",e.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",e.KEY_METRIC_REQUEST_SUA_END="KEY_METRIC_REQUEST_SUA_END",e.KEY_METRIC_BEFORE_CONNECT="KEY_METRIC_BEFORE_CONNECT",e.KEY_METRIC_PEER_RECEIVER="KEY_METRIC_PEER_RECEIVER",e.KEY_METRIC_SIGNAL_CONNECTED="KEY_METRIC_SIGNAL_CONNECTED",e.KEY_METRIC_JOIN_REQ="KEY_METRIC_JOIN_REQ",e.KEY_METRIC_JOIN_REP="KEY_METRIC_JOIN_REP",e.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",e.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",e.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",e.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",e.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED="KEY_METRIC_FIRST_VIDEO_FRAME_DECODED",e.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",e.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",e.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",e.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",e.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",e.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",e.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",e.RESET_KEY_METRICS="RESET_KEY_METRICS",e.RESET_FIRST_VIDEO_FRAME_DECODED="RESET_FIRST_VIDEO_FRAME_DECODED",e.SET_USE_P2P="SET_USE_P2P",e.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",e}(tt||{});let Ph=function(e){return e.h264="h264",e.h265="h265",e.vp8="vp8",e.vp9="vp9",e.av1="av1",e}({});(function(e){e.opus="opus",e.pcma="pcma",e.pcmu="pcmu",e.g722="g722"})({});const IU=128,AU=96,w_=1e3,jf=10;let wU=0;var Oo=(()=>{var e={8:(r,o,s)=>{s.r(o),s.d(o,{Parser:()=>J,Printer:()=>Me,parse:()=>ie,print:()=>Q});const a=`
`,c="".concat("\r").concat(a),d=" ";let l;function h(w){return w>="0"&&w<="9"}function p(w){return w>="!"&&w<="~"}function f(w){return p(w)||w>=""&&w<=""}function m(w){return w==="!"||w>="#"&&w<="'"||w>="*"&&w<="+"||w>="-"&&w<="."||w>="0"&&w<="9"||w>="A"&&w<="Z"||w>="^"&&w<="~"}function g(w){return w>="1"&&w<="9"}function S(w){return w>="A"&&w<="Z"||w>="a"&&w<="z"}function T(w){return w==="d"||w==="h"||w==="m"||w==="s"}function C(w){return w>""&&w<"	"||w>"\v"&&w<"\f"||w>""&&w<""}function b(w){return S(w)||h(w)||w==="+"||w==="/"}function D(w){return h(w)||S(w)||w==="+"||w==="/"||w==="-"||w==="_"}function x(w){return S(w)||h(w)||w==="+"||w==="/"}function k(w,v){var N=Object.keys(w);if(Object.getOwnPropertySymbols){var j=Object.getOwnPropertySymbols(w);v&&(j=j.filter(function(ne){return Object.getOwnPropertyDescriptor(w,ne).enumerable})),N.push.apply(N,j)}return N}function V(w){for(var v=1;v<arguments.length;v++){var N=arguments[v]!=null?arguments[v]:{};v%2?k(Object(N),!0).forEach(function(j){W(w,j,N[j])}):Object.getOwnPropertyDescriptors?Object.defineProperties(w,Object.getOwnPropertyDescriptors(N)):k(Object(N)).forEach(function(j){Object.defineProperty(w,j,Object.getOwnPropertyDescriptor(N,j))})}return w}function W(w,v,N){return v in w?Object.defineProperty(w,v,{value:N,enumerable:!0,configurable:!0,writable:!0}):w[v]=N,w}(function(w){w.VERSION="v",w.ORIGIN="o",w.SESSION_NAME="s",w.INFORMATION="i",w.URI="u",w.EMAIL="e",w.PHONE="p",w.CONNECTION="c",w.BANDWIDTH="b",w.TIME="t",w.REPEAT="r",w.ZONE_ADJUSTMENTS="z",w.KEY="k",w.ATTRIBUTE="a",w.MEDIA="m"})(l||(l={}));class K{consumeText(v,N){let j=N;for(;j<v.length;){const ne=v[j];if(ne==="\0"||ne==="\r"||ne===a)break;j+=1}if(j-N==0)throw new Error("Invalid text, at ".concat(v));return j}consumeUnicastAddress(v,N,j){return this.consumeTill(v,N,d)}consumeOneOrMore(v,N,j){let ne=N;for(;j(v[ne]);)ne++;if(ne-N==0)throw new Error("Invalid rule at ".concat(N,"."));return ne}consumeSpace(v,N){if(v[N]===d)return N+1;throw new Error("Invalid space at ".concat(N,"."))}consumeIP4Address(v,N){let j=N;for(let ne=0;ne<4;ne++)if(j=this.consumeDecimalUChar(v,j),ne!==3){if(v[j]!==".")throw new Error("Invalid IP4 address.");j++}return j}consumeDecimalUChar(v,N){let j=N;for(let Ve=0;Ve<3&&h(v[j]);Ve++,j++);if(j-N==0)throw new Error("Invalid decimal uchar.");const ne=parseInt(v.slice(N,j));if(ne>=0&&ne<=255)return j;throw new Error("Invalid decimal uchar")}consumeIP6Address(v,N){let j=this.consumeHexpart(v,N);return v[j]===":"&&(j+=1,j=this.consumeIP4Address(v,j)),j}consumeHexpart(v,N){let j=N;if(v[j]===":"&&v[j+1]===":"){j+=2;try{j=this.consumeHexseq(v,j)}catch{}return j}if(j=this.consumeHexseq(v,j),v[j]===":"&&v[j+1]===":"){j+=2;try{j=this.consumeHexseq(v,j)}catch{}return j}return j}consumeHexseq(v,N){let j=N;for(;j=this.consumeHex4(v,j),v[j]===":"&&v[j+1]!==":";)j+=1;return j}consumeHex4(v,N){let j=0;for(;j<4;j++)if(!((ne=v[N+j])>="0"&&ne<="9"||ne>="a"&&ne<="f"||ne>="A"&&ne<="F")){if(j===0)throw new Error("Invalid hex 4");break}var ne;return N+j}consumeFQDN(v,N){let j=N;for(;h(v[j])||S(v[j])||v[j]==="-"||v[j]===".";)j+=1;if(j-N<4)throw new Error("Invalid FQDN");return j}consumeExtnAddr(v,N){return this.consumeOneOrMore(v,N,f)}consumeMulticastAddress(v,N,j){switch(j){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(v,N);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(v,N);default:try{return this.consumeFQDN(v,N)}catch{return this.consumeExtnAddr(v,N)}}}consumeIP6MulticastAddress(v,N){const j=this.consumeHexpart(v,N);return v[j]==="/"?this.consumeInteger(v,j+1):j}consumeIP4MulticastAddress(v,N){let j=N+3;const ne=v.slice(N,j),Ve=parseInt(ne);if(Ve<224||Ve>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let wt=0;wt<3;wt++){if(v[j]!==".")throw new Error("Invalid IP4 multicast address.");j+=1,j=this.consumeDecimalUChar(v,j)}return v[j]==="/"&&(j+=1),j=this.consumeTTL(v,j),v[j]==="/"&&(j=this.consumeInteger(v,j)),j}consumeInteger(v,N){if(!g(v[N]))throw new Error("Invalid integer.");for(N+=1;h(v[N]);)N+=1;return N}consumeTTL(v,N){if(v[N]==="0")return N+1;if(!g(v[N]))throw new Error("Invalid TTL.");N+=1;for(let j=0;j<2&&h(v[N]);j++)N+=1;return N}consumeToken(v,N){return this.consumeOneOrMore(v,N,m)}consumeTime(v,N){let j=N;if(v[j]==="0")return j+1;for(g(v[j])&&(j+=1);h(v[j]);)j++;if(j-N<10)throw new Error("Invalid time");return j}consumeAddress(v,N){return this.consumeTill(v,N,d)}consumeTypedTime(v,N){let j=N;return j=this.consumeOneOrMore(v,j,h),T(v[j])?j+1:j}consumeRepeatInterval(v,N){if(!g(v[N]))throw new Error("Invalid repeat interval");for(N+=1;h(v[N]);)N+=1;return T(v[N])&&(N+=1),N}consumePort(v,N){return this.consumeOneOrMore(v,N,h)}consume(v,N,j){for(let ne=0;ne<j.length;ne++){if(N+ne>=v.length)throw new Error("consume exceeding value length");if(v[N+ne]!==j[ne])throw new Error("consume ".concat(j," failed at ").concat(ne))}return N+j.length}consumeTill(v,N,j){let ne=N;for(;ne<v.length&&(typeof j!="string"||v[ne]!==j)&&(typeof j!="function"||!j(v[ne]));)ne++;return ne}}class J extends K{constructor(){super(),W(this,"records",[]),W(this,"currentLine",0)}parse(v){const N=this.probeEOL(v);this.records=v.split(N).filter(sh=>!!rr(sh).call(sh)).map(this.parseLine),this.currentLine=0;const j=this.parseVersion(),ne=this.parseOrigin(),Ve=this.parseSessionName(),wt=this.parseInformation(),Ji=this.parseUri(),Ro=this.parseEmail(),cl=this.parsePhone(),nh=this.parseConnection(),oh=this.parseBandWidth(),jl=this.parseTimeFields(),dl=this.parseKey(),ll=this.parseSessionAttribute(),Pa=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:j,origin:ne,sessionName:Ve,information:wt,uri:Ji,emails:Ro,phones:cl,connection:nh,bandwidths:oh,timeFields:jl,key:dl,attributes:ll,mediaDescriptions:Pa}}getCurrentRecord(){const v=this.records[this.currentLine];if(!v)throw new Error("Record doesn't exit.");return v}probeEOL(v){for(let N=0;N<v.length;N++)if(v[N]===a)return v[N-1]==="\r"?c:a;throw new Error("Invalid newline character.")}parseLine(v,N){if(v.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const j=v[0];if(v[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:j,value:v.slice(2),line:N,cur:0}}parseSessionAttribute(){const v=new Ne;for(;this.currentLine<this.records.length;){const N=this.getCurrentRecord();if(N.type!==l.ATTRIBUTE)break;const j={attField:this.extractOneOrMore(N,ne=>m(ne)&&ne!==":"),_cur:0};N.value[N.cur]===":"&&(N.cur+=1,j.attValue=this.extractOneOrMore(N,C)),v.parse(j),this.currentLine++}return v.digest()}parseMediaAttributes(v){const N=new Ce(v);for(;this.currentLine<this.records.length;){const j=this.getCurrentRecord();if(j.type!==l.ATTRIBUTE)break;const ne={attField:this.extractOneOrMore(j,Ve=>m(Ve)&&Ve!==":"),_cur:0};j.value[j.cur]===":"&&(j.cur+=1,ne.attValue=this.extractOneOrMore(j,C)),N.parse(ne),this.currentLine++}return N.digest()}parseKey(){const v=this.getCurrentRecord();if(v.type===l.KEY){if(v.value==="prompt"||v.value==="clear:"||v.value==="base64:"||v.value==="uri:")return v.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const v=this.getCurrentRecord();if(v.type===l.ZONE_ADJUSTMENTS){const N=[];for(;;)try{const j=this.extract(v,this.consumeTime);this.consumeSpaceForRecord(v);let ne=!1;v.value[v.cur]==="-"&&(ne=!0,v.cur+=1);const Ve=this.extract(v,this.consumeTypedTime);N.push({time:j,typedTime:Ve,back:ne})}catch{break}if(N.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,N}return[]}parseRepeat(){const v=[];for(;;){const N=this.getCurrentRecord();if(N.type!==l.REPEAT)break;{const j=this.extract(N,this.consumeRepeatInterval),ne=this.parseTypedTime(N);v.push({repeatInterval:j,typedTimes:ne}),this.currentLine++}}return v}parseTypedTime(v){const N=[];for(;;)try{this.consumeSpaceForRecord(v),N.push(this.extract(v,this.consumeTypedTime))}catch{break}if(N.length===0)throw new Error("Invalid typed time.");return N}parseTime(){const v=this.getCurrentRecord(),N=this.extract(v,this.consumeTime);this.consumeSpaceForRecord(v);const j=this.extract(v,this.consumeTime);return this.currentLine++,{startTime:N,stopTime:j}}parseBandWidth(){const v=[];for(;this.currentLine<this.records.length;){const N=this.getCurrentRecord();if(N.type!==l.BANDWIDTH)break;{const j=this.extractOneOrMore(N,m);if(N.value[N.cur]!==":")throw new Error("Invalid bandwidth field.");N.cur++;const ne=this.extractOneOrMore(N,h);v.push({bwtype:j,bandwidth:ne}),this.currentLine++}}return v}parseVersion(){const v=this.getCurrentRecord();if(v.type!==l.VERSION)throw new Error("first sdp record must be version");const N=v.value.slice(0,this.consumeOneOrMore(v.value,0,h));if(N.length!==v.value.length)throw new Error('invalid proto version, "v='.concat(v.value,'"'));return this.currentLine++,N}parseOrigin(){const v=this.getCurrentRecord();if(v.type!==l.ORIGIN)throw new Error("second line of sdp must be origin");const N=this.extractOneOrMore(v,f);this.consumeSpaceForRecord(v);const j=this.extractOneOrMore(v,h);this.consumeSpaceForRecord(v);const ne=this.extractOneOrMore(v,h);this.consumeSpaceForRecord(v);const Ve=this.extractOneOrMore(v,m);this.consumeSpaceForRecord(v);const wt=this.extractOneOrMore(v,m);this.consumeSpaceForRecord(v);const Ji=this.extract(v,this.consumeUnicastAddress);return this.currentLine++,{username:N,sessId:j,sessVersion:ne,nettype:Ve,addrtype:wt,unicastAddress:Ji}}parseSessionName(){const v=this.getCurrentRecord();if(v.type===l.SESSION_NAME){const N=this.extract(v,this.consumeText);return this.currentLine++,N}}parseInformation(){const v=this.getCurrentRecord();if(v.type!==l.INFORMATION)return;const N=this.extract(v,this.consumeText);return this.currentLine++,N}parseUri(){const v=this.getCurrentRecord();if(v.type===l.URI)return this.currentLine++,v.value}parseEmail(){const v=[];for(;;){const N=this.getCurrentRecord();if(N.type!==l.EMAIL)break;v.push(N.value),this.currentLine++}return v}parsePhone(){const v=[];for(;;){const N=this.getCurrentRecord();if(N.type!==l.PHONE)break;v.push(N.value),this.currentLine++}return v}parseConnection(){const v=this.getCurrentRecord();if(v.type===l.CONNECTION){const N=this.extractOneOrMore(v,m);this.consumeSpaceForRecord(v);const j=this.extractOneOrMore(v,m);this.consumeSpaceForRecord(v);const ne=this.extract(v,this.consumeAddress);return this.currentLine++,{nettype:N,addrtype:j,address:ne}}}parseMedia(){const v=this.getCurrentRecord(),N=this.extract(v,this.consumeToken);this.consumeSpaceForRecord(v);let j=this.extract(v,this.consumePort);v.value[v.cur]==="/"&&(v.cur+=1,j+=this.extract(v,this.consumeInteger)),this.consumeSpaceForRecord(v);const ne=[];for(ne.push(this.extract(v,this.consumeToken));v.value[v.cur]==="/";)v.cur+=1,ne.push(this.extract(v,this.consumeToken));if(ne.length===0)throw new Error("Invalid proto");const Ve=this.parseFmt(v);return this.currentLine++,{mediaType:N,port:j,protos:ne,fmts:Ve}}parseTimeFields(){const v=[];for(;this.getCurrentRecord().type===l.TIME;){const N=this.parseTime(),j=this.parseRepeat(),ne=this.parseZone();v.push({time:N,repeats:j,zones:ne})}return v}parseMediaDescription(){const v=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===l.MEDIA;){const N=this.parseMedia(),j=this.parseInformation(),ne=this.parseConnections(),Ve=this.parseBandWidth(),wt=this.parseKey(),Ji=this.parseMediaAttributes(N);v.push({media:N,information:j,connections:ne,bandwidths:Ve,key:wt,attributes:Ji})}return v}parseConnections(){const v=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===l.CONNECTION;)v.push(this.parseConnection());return v}parseFmt(v){const N=[];for(;;)try{this.consumeSpaceForRecord(v),N.push(this.extract(v,this.consumeToken))}catch{break}if(N.length===0)throw new Error("Invalid fmts");return N}extract(v,N){for(var j=arguments.length,ne=new Array(j>2?j-2:0),Ve=2;Ve<j;Ve++)ne[Ve-2]=arguments[Ve];const wt=N.call(this,v.value,v.cur,...ne),Ji=v.value.slice(v.cur,wt);return v.cur=wt,Ji}extractOneOrMore(v,N){const j=this.consumeOneOrMore(v.value,v.cur,N),ne=v.value.slice(v.cur,j);return v.cur=j,ne}consumeSpaceForRecord(v){if(v.value[v.cur]!==d)throw new Error("Invalid space at ".concat(v.cur,"."));v.cur+=1}}class se extends K{constructor(){super(...arguments),W(this,"attributes",void 0),W(this,"digested",!1)}extractOneOrMore(v,N,j){const ne=this.consumeOneOrMore(v.attValue,v._cur,N),Ve=v.attValue.slice(v._cur,ne),[wt,Ji]=j||[];if(typeof wt=="number"&&Ve.length<wt)throw new Error("error in length, should be more or equal than ".concat(wt," characters."));if(typeof Ji=="number"&&Ve.length>Ji)throw new Error("error in length, should be less or equal than ".concat(Ji," characters."));return v._cur=ne,Ve}consumeAttributeSpace(v){if(v.attValue[v._cur]!==d)throw new Error("Invalid space at ".concat(v._cur,"."));v._cur+=1}extract(v,N){if(!v.attValue)throw new Error("Nothing to extract from attValue.");for(var j=arguments.length,ne=new Array(j>2?j-2:0),Ve=2;Ve<j;Ve++)ne[Ve-2]=arguments[Ve];const wt=N.call(this,v.attValue,v._cur,...ne),Ji=v.attValue.slice(v._cur,wt);return v._cur=wt,Ji}atEnd(v){if(!v.attValue)throw new Error;return v._cur>=v.attValue.length}peekChar(v){if(!v.attValue)throw new Error;return v.attValue[v._cur]}peek(v,N){if(!v.attValue)throw new Error;for(let j=0;j<N.length;j++)if(N[j]!==v.attValue[v._cur+j])return!1;return!0}parseIceUfrag(v){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(v,b,[4,256])}parseIcePwd(v){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(v,b,[22,256])}parseIceOptions(v){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const N=[];for(;!this.atEnd(v);){N.push(this.extractOneOrMore(v,b));try{this.consumeAttributeSpace(v)}catch(j){if(this.atEnd(v))break;throw j}}this.attributes.iceOptions=N}parseFingerprint(v){const N=this.extract(v,this.consumeToken);this.consumeAttributeSpace(v);const j=this.extract(v,this.consumeTill);this.attributes.fingerprints.push({hashFunction:N,fingerprint:j})}parseExtmap(v){const N=this.extractOneOrMore(v,h);let j;this.peekChar(v)==="/"&&(this.extract(v,this.consume,"/"),j=this.extract(v,this.consumeToken)),this.consumeAttributeSpace(v);const ne=this.extract(v,this.consumeTill,d),Ve=V(V({entry:parseInt(N,10)},j&&{direction:j}),{},{extensionName:ne});this.peekChar(v)===d&&(this.consumeAttributeSpace(v),Ve.extensionAttributes=this.extract(v,this.consumeTill)),this.attributes.extmaps.push(Ve)}parseSetup(v){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const N=this.extract(v,this.consumeTill);if(N!=="active"&&N!=="passive"&&N!=="actpass"&&N!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=N}}class Ne extends se{constructor(){super(...arguments),W(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(v){if(this.digested)throw new Error("already digested");try{switch(v.attField){case"group":this.parseGroup(v);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(v);break;case"ice-pwd":this.parseIcePwd(v);break;case"ice-options":this.parseIceOptions(v);break;case"fingerprint":this.parseFingerprint(v);break;case"setup":this.parseSetup(v);break;case"tls-id":this.parseTlsId(v);break;case"identity":this.parseIdentity(v);break;case"extmap":this.parseExtmap(v);break;case"msid-semantic":this.parseMsidSemantic(v);break;default:v.ignored=!0,this.attributes.unrecognized.push(v)}}catch(N){throw console.error("parsing session attribute ".concat(v.attField,' error, "a=').concat(v.attField,":").concat(v.attValue,'"')),N}if(!v.ignored&&v.attValue&&!this.atEnd(v))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(v){const N=this.extract(v,this.consumeToken),j=[];for(;!this.atEnd(v)&&this.peekChar(v)===d;)this.consumeAttributeSpace(v),j.push(this.extract(v,this.consumeToken));this.attributes.groups.push({semantic:N,identificationTag:j})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(v){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(v,D)}parseIdentity(v){const N=this.extractOneOrMore(v,x),j=[];for(;!this.atEnd(v)&&this.peekChar(v)===d;){this.consumeAttributeSpace(v);const ne=this.extract(v,this.consumeToken);this.extract(v,this.consume,"=");const Ve=this.extractOneOrMore(v,wt=>wt!==d&&C(wt));j.push({name:ne,value:Ve})}this.attributes.identities.push({assertionValue:N,extensions:j})}parseMsidSemantic(v){this.peekChar(v)===d&&this.consumeAttributeSpace(v);const N={semantic:this.extract(v,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(v)}catch{break}if(this.peekChar(v)==="*"){this.extract(v,this.consume,"*"),N.applyForAll=!0;break}{const j=this.extract(v,this.consumeTill,d);N.identifierList.push(j)}}this.attributes.msidSemantic=N}}class Ce extends se{constructor(v){super(),W(this,"attributes",void 0),v.protos.indexOf("RTP")!==-1||v.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(v){if(this.digested)throw new Error("already digested");try{switch(v.attField){case"extmap":this.parseExtmap(v);break;case"setup":this.parseSetup(v);break;case"ice-ufrag":this.parseIceUfrag(v);break;case"ice-pwd":this.parseIcePwd(v);break;case"ice-options":this.parseIceOptions(v);break;case"candidate":this.parseCandidate(v);break;case"remote-candidate":this.parseRemoteCandidate(v);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(v);break;case"rtpmap":this.parseRtpmap(v);break;case"ptime":this.parsePtime(v);break;case"maxptime":this.parseMaxPtime(v);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(v);break;case"ssrc":this.parseSSRC(v);break;case"fmtp":this.parseFmtp(v);break;case"rtcp-fb":this.parseRtcpFb(v);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(v);break;case"mid":this.parseMid(v);break;case"msid":this.parseMsid(v);break;case"imageattr":this.parseImageAttr(v);break;case"rid":this.parseRid(v);break;case"simulcast":this.parseSimulcast(v);break;case"sctp-port":this.parseSctpPort(v);break;case"max-message-size":this.parseMaxMessageSize(v);break;case"ssrc-group":this.parseSSRCGroup(v);break;default:v.ignored=!0,this.attributes.unrecognized.push(v)}}catch(N){throw console.error("parsing media attribute ".concat(v.attField,' error, "a=').concat(v.attField,":").concat(v.attValue,'"')),N}if(!v.ignored&&v.attValue&&!this.atEnd(v))throw new Error("attribute parsing error")}parseCandidate(v){const N=this.extractOneOrMore(v,b,[1,32]);this.consumeAttributeSpace(v);const j=this.extractOneOrMore(v,h,[1,5]);this.consumeAttributeSpace(v);const ne=this.extract(v,this.consumeToken);this.consumeAttributeSpace(v);const Ve=this.extractOneOrMore(v,h,[1,10]);this.consumeAttributeSpace(v);const wt=this.extract(v,this.consumeAddress);this.consumeAttributeSpace(v);const Ji=this.extract(v,this.consumePort);this.consumeAttributeSpace(v),this.extract(v,this.consume,"typ"),this.consumeAttributeSpace(v);const Ro={foundation:N,componentId:j,transport:ne,priority:Ve,connectionAddress:wt,port:Ji,type:this.extract(v,this.consumeToken),extension:{}};for(this.peek(v," raddr")&&(this.extract(v,this.consume," raddr"),this.consumeAttributeSpace(v),Ro.relAddr=this.extract(v,this.consumeAddress)),this.peek(v," rport")&&(this.extract(v,this.consume," rport"),this.consumeAttributeSpace(v),Ro.relPort=this.extract(v,this.consumePort));this.peekChar(v)===d;){this.consumeAttributeSpace(v);const cl=this.extract(v,this.consumeToken);this.consumeAttributeSpace(v),Ro.extension[cl]=this.extractOneOrMore(v,p)}this.attributes.candidates.push(Ro)}parseRemoteCandidate(v){const N=[];for(;;){const j=this.extractOneOrMore(v,h,[1,5]);this.consumeAttributeSpace(v);const ne=this.extract(v,this.consumeAddress);this.consumeAttributeSpace(v);const Ve=this.extract(v,this.consumePort);N.push({componentId:j,connectionAddress:ne,port:Ve});try{this.consumeAttributeSpace(v)}catch{break}}this.attributes.remoteCandidatesList.push(N)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(v){const N=this.extract(v,this.consumeToken);this.consumeAttributeSpace(v);const j=this.extract(v,this.consumeTill,"/");this.extract(v,this.consume,"/");const ne={encodingName:j,clockRate:this.extractOneOrMore(v,h)};this.atEnd(v)||this.peekChar(v)!=="/"||(this.extract(v,this.consume,"/"),ne.encodingParameters=parseInt(this.extract(v,this.consumeTill),10));const Ve=this.attributes.payloads.find(wt=>wt.payloadType===parseInt(N,10));Ve?Ve.rtpMap=ne:this.attributes.payloads.push({payloadType:parseInt(N,10),rtpMap:ne,rtcpFeedbacks:[]})}parsePtime(v){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(v,this.consumeTill)}parseMaxPtime(v){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(v,this.consumeTill)}parseDirection(v){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=v.attField}parseSSRC(v){const N=this.extractOneOrMore(v,h);this.consumeAttributeSpace(v);const j=this.extract(v,this.consumeTill,":");let ne;this.peekChar(v)===":"&&(this.extract(v,this.consume,":"),ne=this.extract(v,this.consumeTill));const Ve=this.attributes.ssrcs.find(wt=>wt.ssrcId===parseInt(N,10));Ve?Ve.attributes[j]=ne:this.attributes.ssrcs.push({ssrcId:parseInt(N,10),attributes:{[j]:ne}})}parseFmtp(v){const N=this.extract(v,this.consumeTill,d);this.consumeAttributeSpace(v);const j=this.extract(v,this.consumeTill),ne={};j.split(";").forEach(wt=>{let[Ji,Ro]=wt.split("=");Ji=rr(Ji).call(Ji);const cl=typeof Ro=="string"?rr(Ro).call(Ro):null;typeof Ji=="string"&&Ji.length>0&&(ne[Ji]=cl)});const Ve=this.attributes.payloads.find(wt=>wt.payloadType===parseInt(N,10));Ve?Ve.fmtp={parameters:ne}:this.attributes.payloads.push({payloadType:parseInt(N,10),rtcpFeedbacks:[],fmtp:{parameters:ne}})}parseFmtParameters(v){const N={},j=this.extract(v,this.consumeTill,"=");v._cur++;const ne=this.extract(v,this.consumeTill,";");for(N[j]=ne;v.attValue[v._cur]===";";){const Ve=this.extract(v,this.consumeTill,"=");v._cur++;const wt=this.extract(v,this.consumeTill,";");N[Ve]=wt}return N}parseRtcpFb(v){let N="";N=this.peekChar(v)==="*"?this.extract(v,this.consume,"*"):this.extract(v,this.consumeTill,d),this.consumeAttributeSpace(v);const j=this.extract(v,this.consumeTill,d);let ne;if(j==="trr-int")ne={type:j,interval:this.extract(v,this.consumeTill)};else{const Ve={type:j};this.peekChar(v)===d&&(this.consumeAttributeSpace(v),Ve.parameter=this.extract(v,this.consumeToken),this.peekChar(v)===d&&(Ve.additional=this.extract(v,this.consumeTill))),ne=Ve}if(N==="*")this.attributes.rtcpFeedbackWildcards.push(ne);else{const Ve=this.attributes.payloads.find(wt=>wt.payloadType===parseInt(N,10));Ve?Ve.rtcpFeedbacks.push(ne):this.attributes.payloads.push({payloadType:parseInt(N,10),rtcpFeedbacks:[ne]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(v){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const N={port:this.extract(v,this.consumePort)};this.peekChar(v)===d&&(this.consumeAttributeSpace(v),N.netType=this.extractOneOrMore(v,m),this.consumeAttributeSpace(v),N.addressType=this.extractOneOrMore(v,m),this.consumeAttributeSpace(v),N.address=this.extract(v,this.consumeAddress)),this.attributes.rtcp=N}parseMsid(v){const N={id:this.extractOneOrMore(v,m,[1,64])};this.peekChar(v)===d&&(this.consumeAttributeSpace(v),N.appdata=this.extractOneOrMore(v,m,[1,64])),this.attributes.msids.push(N)}parseImageAttr(v){this.attributes.imageattr.push(v.attValue)}parseRid(v){const N=this.extractOneOrMore(v,ne=>S(ne)||h(ne)||ne==="_"||ne==="-");this.consumeAttributeSpace(v);const j={id:N,direction:this.extract(v,this.consumeToken),params:[]};if(this.peekChar(v)===d){if(this.consumeAttributeSpace(v),this.peek(v,"pt=")){this.extract(v,this.consume,"pt=");const ne=[];for(;;){const Ve=this.extract(v,this.consumeToken);ne.push(Ve);try{this.extract(v,this.consume,",")}catch{break}}j.payloads=ne,this.peekChar(v)===d&&this.extract(v,this.consume,d)}for(;;){const ne=this.extract(v,this.consumeToken);switch(ne){case"depend":{const Ve={type:ne,rids:this.extract(v,this.consume,"=").split(",")};j.params.push(Ve);break}default:{const Ve={type:ne};this.peekChar(v)==="="&&(this.extract(v,this.consume,"="),Ve.val=this.extract(v,this.consumeTill,";")),j.params.push(Ve)}}try{this.extract(v,this.consume,";")}catch{break}}}this.attributes.rids.push(j)}parseSimulcast(v){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=v.attValue,this.extract(v,this.consumeTill)}parseSctpPort(v){this.attributes.sctpPort=this.extractOneOrMore(v,h,[1,5])}parseMaxMessageSize(v){this.attributes.maxMessageSize=this.extractOneOrMore(v,h,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(v){this.attributes.mid=this.extract(v,this.consumeToken)}parseSSRCGroup(v){const N=this.extract(v,this.consumeToken),j=[];for(;;)try{this.consumeAttributeSpace(v);const ne=this.extract(v,this.consumeInteger);j.push(parseInt(ne,10))}catch{break}this.attributes.ssrcGroups.push({semantic:N,ssrcIds:j})}}function De(w,v,N){return v in w?Object.defineProperty(w,v,{value:N,enumerable:!0,configurable:!0,writable:!0}):w[v]=N,w}class Me{constructor(){De(this,"eol",c)}print(v,N){let j="";return N&&(this.eol=N),j+=this.printVersion(v.version),j+=this.printOrigin(v.origin),j+=this.printSessionName(v.sessionName),j+=this.printInformation(v.information),j+=this.printUri(v.uri),j+=this.printEmail(v.emails),j+=this.printPhone(v.phones),j+=this.printConnection(v.connection),j+=this.printBandwidth(v.bandwidths),j+=this.printTimeFields(v.timeFields),j+=this.printKey(v.key),j+=this.printSessionAttributes(v.attributes),j+=this.printMediaDescription(v.mediaDescriptions),j}printVersion(v){return"v=".concat(v).concat(this.eol)}printOrigin(v){return"o=".concat(v.username," ").concat(v.sessId," ").concat(v.sessVersion," ").concat(v.nettype," ").concat(v.addrtype," ").concat(v.unicastAddress).concat(this.eol)}printSessionName(v){return v?"s=".concat(v).concat(this.eol):""}printInformation(v){return v?"i=".concat(v).concat(this.eol):""}printUri(v){return v?"u=".concat(v).concat(this.eol):""}printEmail(v){let N="";for(const j of v)N+="e=".concat(j).concat(this.eol);return N}printPhone(v){let N="";for(const j of v)N+="e=".concat(j).concat(this.eol);return N}printConnection(v){return v?"c=".concat(v.nettype," ").concat(v.addrtype," ").concat(v.address).concat(this.eol):""}printBandwidth(v){let N="";for(const j of v)N+="b=".concat(j.bwtype,":").concat(j.bandwidth).concat(this.eol);return N}printTimeFields(v){let N="";for(const j of v){N+="t=".concat(j.time.startTime," ").concat(j.time.startTime).concat(this.eol);for(const ne of j.repeats)N+="r=".concat(ne.repeatInterval," ").concat(ne.typedTimes.join(" ")).concat(this.eol);j.zoneAdjustments&&(N+="z=",N+="z=".concat(j.zoneAdjustments.map(ne=>"".concat(ne.time," ").concat(ne.back?"-":""," ").concat(ne.typedTime)).join(" ")).concat(this.eol),N+=this.eol)}return N}printKey(v){return v?"k=".concat(v).concat(this.eol):""}printAttributes(v){let N="";for(const j of v)N+="a=".concat(j.attField).concat(j.attValue?":".concat(j.attValue):"").concat(this.eol);return N}printMediaDescription(v){let N="";for(const j of v)N+=this.printMedia(j.media),N+=this.printInformation(j.information),N+=this.printConnections(j.connections),N+=this.printBandwidth(j.bandwidths),N+=this.printKey(j.key),N+=this.printMediaAttributes(j);return N}printConnections(v){let N="";for(const j of v)N+=this.printConnection(j);return N}printMedia(v){return"m=".concat(v.mediaType," ").concat(v.port," ").concat(v.protos.join("/")," ").concat(v.fmts.join(" ")).concat(this.eol)}printSessionAttributes(v){return new ae(this.eol).print(v)}printMediaAttributes(v){return new Y(this.eol).print(v)}}class et{constructor(v){De(this,"eol",void 0),this.eol=v}printIceUfrag(v){return v===void 0?"":"a=ice-ufrag:".concat(v).concat(this.eol)}printIcePwd(v){return v===void 0?"":"a=ice-pwd:".concat(v).concat(this.eol)}printIceOptions(v){return v===void 0?"":"a=ice-options:".concat(v.join(d)).concat(this.eol)}printFingerprints(v){return v.length>0?v.map(N=>"a=fingerprint:".concat(N.hashFunction).concat(d).concat(N.fingerprint)).join(this.eol)+this.eol:""}printExtmap(v){return v.map(N=>"a=extmap:".concat(N.entry).concat(N.direction?"/".concat(N.direction):"").concat(d).concat(N.extensionName).concat(N.extensionAttributes?"".concat(d).concat(N.extensionAttributes):"").concat(this.eol)).join("")}printSetup(v){return v===void 0?"":"a=setup:".concat(v).concat(this.eol)}printUnrecognized(v){return v.map(N=>"a=".concat(N.attField).concat(N.attValue?":".concat(N.attValue):"").concat(this.eol)).join("")}}class ae extends et{print(v){let N="";return N+=this.printGroups(v.groups),N+=this.printMsidSemantic(v.msidSemantic),N+=this.printIceLite(v.iceLite),N+=this.printIceUfrag(v.iceUfrag),N+=this.printIcePwd(v.icePwd),N+=this.printIceOptions(v.iceOptions),N+=this.printFingerprints(v.fingerprints),N+=this.printSetup(v.setup),N+=this.printTlsId(v.tlsId),N+=this.printIdentity(v.identities),N+=this.printExtmap(v.extmaps),N+=this.printUnrecognized(v.unrecognized),N}printGroups(v){let N="";return v.length>0&&(N+=v.map(j=>"a=group:".concat(j.semantic).concat(j.identificationTag.map(ne=>"".concat(d).concat(ne)).join("")).concat(this.eol)).join("")),N}printIceLite(v){return v===void 0?"":"a=ice-lite"+this.eol}printTlsId(v){return v?"a=tls-id:".concat(v).concat(this.eol):""}printIdentity(v){return v.length===0?"":v.map(N=>"a=identity:".concat(N.assertionValue).concat(N.extensions.map(j=>"".concat(d).concat(j.name).concat(j.value?"=".concat(j.value):"")))).join(this.eol)+this.eol}printMsidSemantic(v){if(!v)return"";let N="a=msid-semantic:".concat(v.semantic);return v.applyForAll?N+="".concat(d,"*"):v.identifierList.length>0&&(N+=v.identifierList.map(j=>"".concat(d).concat(j))),N+this.eol}}class Y extends et{print(v){const N=v.attributes;let j="";return j+=this.printRTCP(N.rtcp),j+=this.printIceUfrag(N.iceUfrag),j+=this.printIcePwd(N.icePwd),j+=this.printIceOptions(N.iceOptions),j+=this.printCandidates(N.candidates),j+=this.printRemoteCandidatesList(N.remoteCandidatesList),j+=this.printEndOfCandidates(N.endOfCandidates),j+=this.printFingerprints(N.fingerprints),j+=this.printSetup(N.setup),j+=this.printMid(N.mid),j+=this.printExtmap(N.extmaps),j+=this.printRTPRelated(N),j+=this.printPtime(N.ptime),j+=this.printMaxPtime(N.maxPtime),j+=this.printDirection(N.direction),j+=this.printSSRCGroups(N.ssrcGroups),j+=this.printSSRC(N.ssrcs),j+=this.printRTCPMux(N.rtcpMux),j+=this.printRTCPMuxOnly(N.rtcpMuxOnly),j+=this.printRTCPRsize(N.rtcpRsize),j+=this.printMSId(N.msids),j+=this.printImageattr(N.imageattr),j+=this.printRid(N.rids),j+=this.printSimulcast(N.simulcast),j+=this.printSCTPPort(N.sctpPort),j+=this.printMaxMessageSize(N.maxMessageSize),j+=this.printUnrecognized(N.unrecognized),j}printCandidates(v){return v.map(N=>"a=candidate:".concat(N.foundation).concat(d).concat(N.componentId).concat(d).concat(N.transport).concat(d).concat(N.priority).concat(d).concat(N.connectionAddress).concat(d).concat(N.port).concat(d,"typ").concat(d).concat(N.type).concat(N.relAddr?"".concat(d,"raddr").concat(d).concat(N.relAddr):"").concat(N.relPort?"".concat(d,"rport").concat(d).concat(N.relPort):"").concat(Object.keys(N.extension).map(j=>"".concat(d).concat(j).concat(d).concat(N.extension[j])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(v){return v.map(N=>"a=remote-candidates:".concat(N.join(d)).concat(this.eol)).join("")}printEndOfCandidates(v){return v===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(v){if(!v.payloads)return"";const N=v.payloads;let j="";j+=v.rtcpFeedbackWildcards.map(ne=>this.printRTCPFeedback("*",ne)).join("");for(const ne of N)j+=this.printRtpMap(ne.payloadType,ne.rtpMap),j+=this.printFmtp(ne.payloadType,ne.fmtp),j+=ne.rtcpFeedbacks.map(Ve=>this.printRTCPFeedback(ne.payloadType,Ve)).join("");return j}printFmtp(v,N){if(!N)return"";const j=Object.keys(N.parameters);return j.length===1&&N.parameters[j[0]]===null?"a=fmtp:".concat(v).concat(d).concat(j[0]).concat(this.eol):"a=fmtp:".concat(v).concat(d).concat(Object.keys(N.parameters).map(ne=>"".concat(ne,"=").concat(N.parameters[ne])).join(";")).concat(this.eol)}printRtpMap(v,N){return N?"a=rtpmap:".concat(v).concat(d).concat(N.encodingName,"/").concat(N.clockRate).concat(N.encodingParameters?"/".concat(N.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(v,N){let j="a=rtcp-fb:".concat(v).concat(d),ne=N;return ne.type==="trr-int"?j+="ttr-int".concat(d).concat(ne.interval):(j+="".concat(ne.type),ne.parameter&&(j+="".concat(d).concat(ne.parameter),ne.additional&&(j+="".concat(d).concat(ne.additional)))),j+this.eol}printPtime(v){return v===void 0?"":"a=ptime:".concat(v).concat(this.eol)}printMaxPtime(v){return v===void 0?"":"a=maxptime:".concat(v).concat(this.eol)}printDirection(v){return v===void 0?"":"a=".concat(v).concat(this.eol)}printSSRC(v){return v.map(N=>Object.keys(N.attributes).map(j=>"a=ssrc:".concat(N.ssrcId.toString(10)).concat(d).concat(j).concat(N.attributes[j]?":".concat(N.attributes[j]):"").concat(this.eol)).join("")).join("")}printRTCPMux(v){return v===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(v){return v===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(v){return v===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(v){if(v===void 0)return"";let N="a=rtcp:".concat(v.port);return v.netType&&(N+="".concat(d).concat(v.netType)),v.addressType&&(N+="".concat(d).concat(v.addressType)),v.address&&(N+="".concat(d).concat(v.address)),N+this.eol}printMSId(v){return v.map(N=>"a=msid:".concat(N.id).concat(N.appdata?"".concat(d).concat(N.appdata):"").concat(this.eol)).join("")}printImageattr(v){return v.map(N=>"a=imageattr:".concat(N).concat(this.eol)).join("")}printRid(v){return v.map(N=>{let j="a=rid:".concat(N.id).concat(d).concat(N.direction);return N.payloads&&(j+="".concat(d,"pt=").concat(N.payloads.join(","))),N.params.length>0&&(j+="".concat(d).concat(N.params.map(ne=>ne.type==="depend"?"depend=".concat(ne.rids.join(",")):"".concat(ne.type,"=").concat(ne.val)).join(";"))),j+this.eol}).join("")}printSimulcast(v){return v===void 0?"":"a=simulcast:".concat(v).concat(this.eol)}printSCTPPort(v){return v===void 0?"":"a=sctp-port:".concat(v).concat(this.eol)}printMaxMessageSize(v){return v===void 0?"":"a=max-message-size:".concat(v).concat(this.eol)}printMid(v){return v===void 0?"":"a=mid:".concat(v).concat(this.eol)}printSSRCGroups(v){return v.map(N=>"a=ssrc-group:".concat(N.semantic).concat(N.ssrcIds.map(j=>"".concat(d).concat(j.toString(10))).join("")).concat(this.eol)).join("")}}function ie(w){return new J().parse(w)}function Q(w,v){return new Me().print(w,v)}}},t={};function i(r){if(t[r])return t[r].exports;var o=t[r]={exports:{}};return e[r](o,o.exports,i),o.exports}return i.d=(r,o)=>{for(var s in o)i.o(o,s)&&!i.o(r,s)&&Object.defineProperty(r,s,{enumerable:!0,get:o[s]})},i.o=(r,o)=>Object.prototype.hasOwnProperty.call(r,o),i.r=r=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},i(8)})();function sn(e){return Oo.parse(e)}function Du(e,t){return Oo.print(e,t)}var UY=ln("Array","keys"),xY=Gs,VY=Bi,FY=me,GN=UY,WN=Array.prototype,BY={DOMTokenList:!0,NodeList:!0},mo=function(e){var t=e.keys;return e===WN||FY(WN,e)&&t===WN.keys||VY(BY,xY(e))?GN:t},ai=A(mo);function Er(e,t,i){return(t=function(r){var o=function(s,a){if(typeof s!="object"||!s)return s;var c=s[Symbol.toPrimitive];if(c!==void 0){var d=c.call(s,"string");if(typeof d!="object")return d;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(s)}(r);return typeof o=="symbol"?o:o+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function Tt(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function ft(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Tt(Object(i),!0).forEach(function(r){Er(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Tt(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}function Gf(e,t){return Gf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(i,r){return i.__proto__=r,i},Gf(e,t)}function Dv(){Dv=function(o,s){return new i(o,void 0,s)};var e=RegExp.prototype,t=new WeakMap;function i(o,s,a){var c=RegExp(o,s);return t.set(c,a||t.get(o)),Gf(c,i.prototype)}function r(o,s){var a,c=t.get(s);return un(a=Object.keys(c)).call(a,function(d,l){var h=c[l];if(typeof h=="number")d[l]=o[h];else{for(var p=0;o[h[p]]===void 0&&p+1<h.length;)p++;d[l]=o[h[p]]}return d},Object.create(null))}return function(o,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");o.prototype=Object.create(s&&s.prototype,{constructor:{value:o,writable:!0,configurable:!0}}),Object.defineProperty(o,"prototype",{writable:!1}),s&&Gf(o,s)}(i,RegExp),i.prototype.exec=function(o){var s=e.exec.call(this,o);if(s){s.groups=r(s,this);var a=s.indices;a&&(a.groups=r(a,this))}return s},i.prototype[Symbol.replace]=function(o,s){if(typeof s=="string"){var a=t.get(this);return e[Symbol.replace].call(this,o,s.replace(/\$<([^>]+)(>|$)/g,function(d,l,h){if(h==="")return d;var p=a[l];return Array.isArray(p)?"$"+p.join("$"):typeof p=="number"?"$"+p:""}))}if(typeof s=="function"){var c=this;return e[Symbol.replace].call(this,o,function(){var d=arguments;return typeof d[d.length-1]!="object"&&(d=[].slice.call(d)).push(r(d,c)),s.apply(this,d)})}return e[Symbol.replace].call(this,o,s)},Dv.apply(this,arguments)}const bU=new class extends Vi{constructor(){super(...arguments),Er(this,"currentUploadLogID",0)}reportLogUploadError(e){const{errorRange:t}=e;t[t.length-1]&&t[t.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=t[t.length-1],this.emit("REPORT_LOG_UPLOAD",e))}};class HN{constructor(t){Er(this,"logger",void 0),Er(this,"prefixLists",[]),this.logger=t}debug(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];this.logger.debug(...this.prefixLists,...i)}info(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];this.logger.info(...this.prefixLists,...i)}warning(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];this.logger.warning(...this.prefixLists,...i)}error(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];this.logger.error(...this.prefixLists,...i)}prefix(t){return this.prefixLists.push(t),this}popPrefix(){return this.prefixLists.pop(),this}}function Pv(){const e=new Date;return e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}function ga(){const e=new Date,t=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return t?(t==null?void 0:t[0])+":"+e.getUTCMilliseconds():e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}const Cs={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Lh=Date.now(),y=e=>{for(const t in Cs)if(Object.prototype.hasOwnProperty.call(Cs,t)&&Cs[t]===e)return t;return"DEFAULT"},I=new class{constructor(){Er(this,"proxyServerURL",void 0),Er(this,"logLevel",Cs.DEBUG),Er(this,"uploadState","collecting"),Er(this,"uploadLogWaitingList",[]),Er(this,"uploadLogUploadingList",[]),Er(this,"uploadErrorCount",0),Er(this,"currentLogID",0),Er(this,"url",void 0),Er(this,"extLog",(e,t)=>{this.appendLogToWaitingList(e,...t)})}debug(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const r=[Cs.DEBUG].concat(t);this.log.apply(this,r)}info(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const r=[Cs.INFO].concat(t);this.log.apply(this,r)}warning(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const r=[Cs.WARNING].concat(t);this.log.apply(this,r)}warn(){this.warning(...arguments)}error(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const r=[Cs.ERROR].concat(t);this.log.apply(this,r)}upload(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const r=[Cs.DEBUG].concat(t);this.uploadLog.apply(this,r)}setLogLevel(e){e=Math.min(Math.max(0,e),4),this.logLevel=e}enableLogUpload(){F("UPLOAD_LOG",!0)}disableLogUpload(){F("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(e){this.proxyServerURL=e}prefix(e){return new HN(this).prefix(e)}log(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];if(Date.now()-Lh<100)return void setTimeout(()=>{this.log(...t)},Date.now()-Lh);const r=Math.max(0,Math.min(4,t[0]));if(t[0]=Pv()+" Agora-SDK [".concat(y(r),"]:"),this.appendLogToWaitingList(r,...t),r<this.logLevel)return;const o=Pv()+" %cAgora-SDK [".concat(y(r),"]:");let s=[];if(!B("USE_NEW_LOG"))switch(r){case Cs.DEBUG:s=[o,"color: #64B5F6;"].concat(t.slice(1)),console.log.apply(console,s);break;case Cs.INFO:s=[o,"color: #1E88E5; font-weight: bold;"].concat(t.slice(1)),console.log.apply(console,s);break;case Cs.WARNING:s=[o,"color: #FB8C00; font-weight: bold;"].concat(t.slice(1)),console.warn.apply(console,s);break;case Cs.ERROR:s=[o,"color: #B00020; font-weight: bold;"].concat(t.slice(1)),console.error.apply(console,s)}}uploadLog(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];if(Date.now()-Lh<100)return void setTimeout(()=>{this.uploadLog(...t)},Date.now()-Lh);const r=Math.max(0,Math.min(4,t[0]));t[0]=Pv()+" Agora-SDK [".concat(y(r),"]:"),this.appendLogToWaitingList(r,...t)}appendLogToWaitingList(e){if(!B("UPLOAD_LOG"))return;for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];Array.isArray(i[0])?i[0][0]=ga()+" Agora-SDK [".concat(y(e),"]:"):i[0]=ga()+" Agora-SDK [".concat(y(e),"]:");let o="";i.forEach(s=>{typeof s=="object"&&(s=JSON.stringify(s)),o+="".concat(s," ")}),this.uploadLogWaitingList.push({payload_str:o,log_level:e,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){const e=this.uploadLogUploadingList,t={sdk_version:Qs,process_id:B("PROCESS_ID"),payload:JSON.stringify(e)};return ma(async()=>{const i=await hs.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(B("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(B("LOG_UPLOAD_SERVER"),"/upload/v1")),t,{responseType:"text"});if(i.data!=="OK"){const r=new Error("unexpected upload log response");throw r.response=i,r}},()=>(this.uploadLogUploadingList=[],!1),i=>{const r={status:-1,message:i.message,errorRange:e.map(o=>o.log_item_id)};return i.response?(r.status=i.response.status,r.data=i.response.data,r.headers=i.response.headers):i.request&&(r.status=i.request.status),bU.reportLogUploadError(r),!0},{timeout:B("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:B("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,B("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),B("UPLOAD_LOG_INTERVAL"))}).catch(e=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),B("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),B("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var OU;function jY(e){return Ar(e.reportId,"params.reportId",0,100,!1),Ar(e.category,"params.category",0,100,!1),Ar(e.event,"params.event",0,100,!1),Ar(e.label,"params.label",0,100,!1),Ai(e.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(OU={}).FREE="free",OU.UPLOADING="uploading",function(e){e[e.MISC=0]="MISC",e[e.INTERNAL_EVENT=1]="INTERNAL_EVENT",e[e.PUBLIC_EVENT=2]="PUBLIC_EVENT",e[e.WEB_EVENT=3]="WEB_EVENT",e[e.INTERNAL_API=4]="INTERNAL_API",e[e.WEB_API=5]="WEB_API",e[e.PUBLIC_API=6]="PUBLIC_API"}({});const en={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let Dt=function(e){return e.PUBLISH="publish",e.SUBSCRIBE="subscribe",e.WS_COMPRESSOR_INIT="ws_compressor_init",e.SESSION_INIT="session_init",e.JOIN_CHOOSE_SERVER="join_choose_server",e.RTE_DETAIL="rte_detail_stats",e.REQ_USER_ACCOUNT="req_user_account",e.JOIN_GATEWAY="join_gateway",e.REJOIN_GATEWAY="rejoin_gateway",e.STREAM_SWITCH="stream_switch",e.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",e.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",e.FIRST_VIDEO_RECEIVED="first_video_received",e.FIRST_AUDIO_RECEIVED="first_audio_received",e.FIRST_VIDEO_DECODE="first_video_decode",e.FIRST_AUDIO_DECODE="first_audio_decode",e.XLA_PEER_FIRST_VIDEO_FRAME="xla_peer_first_video_frame",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_UPDATE_STREAM="on_update_stream",e.ON_REMOVE_STREAM="on_remove_stream",e.USER_ANALYTICS="req_user_analytics",e.PC_STATS="pc_stats",e.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",e.AB_TEST="ab_test",e}({}),Xi=function(e){return e.SESSION="io.agora.pb.Wrtc.Session",e.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",e.RTE_DETAIL="io.agora.pb.Wrtc.RteDetailStats",e.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",e.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",e.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",e.PUBLISH="io.agora.pb.Wrtc.Publish",e.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",e.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",e.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",e.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",e.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",e.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",e.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",e.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",e.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",e.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",e.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",e.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",e.XLA_PEER_FIRST_VIDEO_FRAME="io.agora.pb.Wrtc.XLAPeerFirstVideoFrame",e.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",e.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",e.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",e.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",e.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",e.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",e.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",e.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",e.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",e.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",e.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",e.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",e.PC_STATS="io.agora.pb.Wrtc.PCStats",e.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",e.AB_TEST="io.agora.pb.Wrtc.ABTest",e}({});(function(e){e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"})({});let Xe=function(e){return e[e.SESSION=26]="SESSION",e[e.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",e[e.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",e[e.JOIN_GATEWAY=28]="JOIN_GATEWAY",e[e.PUBLISH=30]="PUBLISH",e[e.SUBSCRIBE=29]="SUBSCRIBE",e[e.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",e[e.STREAM_SWITCH=32]="STREAM_SWITCH",e[e.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",e[e.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",e[e.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",e[e.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",e[e.API_INVOKE=41]="API_INVOKE",e[e.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",e[e.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",e[e.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",e[e.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",e[e.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",e[e.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",e[e.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",e[e.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",e[e.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",e[e.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",e[e.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",e[e.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",e[e.USER_ANALYTICS=1e4]="USER_ANALYTICS",e[e.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",e}({});function _e(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(t,i,r){const o=r.value;if(typeof o=="function"){const s=e.className||t.__className__||(t.constructor.name==="AgoraRTCClient"?"Client":t.constructor.name);r.value=function(){for(var a,c=arguments.length,d=new Array(c),l=0;l<c;l++)d[l]=arguments[l];let h=d;if(e.argsMap)try{h=e.argsMap(this,...d)}catch(f){I.warning(f),h=[]}try{JSON.stringify(h)}catch{I.warning("arguments for method ".concat(s,".").concat(String(i)," not serializable for apiInvoke.")),h=[]}const p=(e.report||H).reportApiInvoke(this._sessionId||null,{id:this._clientId||((a=this.store)===null||a===void 0?void 0:a.clientId)||this._ID,name:"".concat(s,".").concat(String(i)),options:h,tag:bi.TRACER,reportResult:e.reportResult},e.throttleTime);try{const f=o.apply(this,d);return f instanceof Z?f.then(m=>(p.onSuccess(e.reportResult&&m),m)).catch(m=>{throw p.onError(m),m}):(p.onSuccess(e.reportResult&&f),f)}catch(f){throw p.onError(f),f}}}return r}}const H=new class{constructor(){Er(this,"baseInfoMap",new Map),Er(this,"proxyServer",void 0),Er(this,"eventUploadTimer",void 0),Er(this,"setSessionIdTimer",void 0),Er(this,"url",void 0),Er(this,"sids",new Set),Er(this,"backupUrl",void 0),Er(this,"_appId",void 0),Er(this,"_aid",0),Er(this,"keyEventUploadPendingItems",[]),Er(this,"normalEventUploadPendingItems",[]),Er(this,"apiInvokeUploadPendingItems",[]),Er(this,"apiInvokeCount",0),Er(this,"apiInvokeLoggedCount",0),Er(this,"ltsList",[]),Er(this,"lastSendNormalEventTime",Date.now()),Er(this,"customReportCounterTimer",void 0),Er(this,"customReportCount",0),Er(this,"extApiInvoke",async e=>{for(const t of e){const i=ft(ft({},t),{},{sid:null,invokeId:++this.apiInvokeCount,tag:bi.TRACER});this.sendApiInvoke(i)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),B("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),B("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(e){return this.baseInfoMap.get(e)}setAppId(e){this._appId=e,this._aid=parseInt(e.replace(/[a-fA-F0-9]{8}/g,t=>{let[i,r]=t;return i+r}),16)||0}reportApiInvoke(e,t,i){t.timeout=t.timeout||6e4,t.reportResult=t.reportResult===void 0||t.reportResult;const r=Date.now();this.apiInvokeCount+=1;const o=this.apiInvokeCount,s=!!B("SHOW_REPORT_INVOKER_LOG"),a=!!B("SHOW_REPORT_USER_INVOKER_LOG"),c=s||a&&t.id;c&&(this.apiInvokeLoggedCount+=1);const d=this.apiInvokeLoggedCount;function l(m,g){if(c){let S="[apiInvoke-".concat(d,"]");if(t.id&&(S+="[".concat(t.id,"]")),t.name&&(S+="[".concat(t.name,"]"),t.name===ct.JOIN))return I.info("".concat(S," ").concat(m));I.info("".concat(S," ").concat(m),m==="start"?t.options:g||"")}}const h=()=>({tag:t.tag,invokeId:o,sid:e,name:t.name,apiInvokeTime:r,options:t.options,states:t.states||null});l("start");let p=!1;vt(t.timeout).then(()=>{p||(this.sendApiInvoke(ft(ft({},h()),{},{error:O.API_INVOKE_TIMEOUT,success:!1})),l("timeout"))});const f=new oe(O.UNEXPECTED_ERROR,"".concat(t.name,": this api invoke is end"));return{onSuccess:m=>{const g=()=>{if(p)throw f;return p=!0,this.sendApiInvoke(ft(ft({},h()),{},{success:!0},t.reportResult&&{result:m})),l("onSuccess"),m};return i?UN(g,t.name+"Success",i,()=>p=!0):g()},onError:m=>{const g=()=>{if(p)throw m;p=!0,this.sendApiInvoke(ft(ft({},h()),{},{success:!1,error:m})),l("onFailure",m.toString())};return i?UN(g,t.name+"Error",i,()=>p=!0):g()}}}_send(e,t,i){this.send({type:e,data:t},i)}_sendApiInvoke(e){return this.sendApiInvoke(e)}sessionInit(e,t){if(this.baseInfoMap.has(e))return;const i=Date.now(),r=this.createBaseInfo(e,i);r.cname=t.cname,r.rteUrl=t.rteUrl;const o=Object.assign({},{willUploadConsoleLog:B("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:Nu?"global":"oversea",areas:B("AREAS")&&B("AREAS").join(",")},t.extend),{stringUid:s,channelProfile:a,channelMode:c,isABTestSuccess:d,lsid:l,clientRole:h}=t,p=Date.now(),f=ft(ft({},r),{},{eventType:Dt.SESSION_INIT,appid:t.appid,browser:navigator.userAgent,buildFormat:t.buildFormat,build:sT,lts:p,elapse:p-i,extend:JSON.stringify(o),mode:t.mode,process:B("PROCESS_ID"),appType:B("APP_TYPE"),success:!0,version:Qs,stringUid:s,channelProfile:a,channelMode:c,isABTestSuccess:d,lsid:l,clientType:z(m=window.navigator.userAgent).call(m,"AgoraWebView")?42:20,clientRole:h,serviceId:B("PROCESS_ID"),extensionID:B("PLUGIN_INFO").join(",")||"",rteUrl:t.rteUrl,rteSid:t.rteSid});var m;this.send({type:Xi.SESSION,data:f},!0)}reportRteDetail(e){const t=this.baseInfoMap.get(e);if(!t)return;const i=t.info,r=Date.now(),o=ft(ft({},i),{},{eventType:Dt.RTE_DETAIL,lts:r,success:!0,elapse:r-t.startTime,vid:i.vid===void 0?0:Number(i.vid),ua:navigator.userAgent});this.send({type:Xi.RTE_DETAIL,data:o},!0)}joinChooseServer(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info;t.vid&&(r.vid=t.vid);const o=Date.now(),s=ft(ft({},r),{},{role:t.role,eventType:Dt.JOIN_CHOOSE_SERVER,lts:o,eventElapse:t.elapse||o-t.lts,chooseServerAddr:t.csAddr,errorCode:t.ec,elapse:o-i.startTime,success:t.succ,chooseServerAddrList:JSON.stringify(t.serverList),uid:t.uid?parseInt(t.uid):null,cid:t.cid?parseInt(t.cid):null,chooseServerIp:t.csIp||"",opid:t.opid,unilbsServerIds:t.unilbsServerIds,extend:t.extend||void 0,isHttp3:t.isHttp3,corssRegionTagReq:t.corssRegionTagReq||void 0,corssRegionTagRes:t.corssRegionTagRes||void 0,ua:navigator.userAgent,resourceTimingInfo:t.resourceTimingInfo||void 0});this.send({type:Xi.JOIN_CHOOSE_SERVER,data:s},!0)}reqUserAccount(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=ft(ft({},r),{},{eventType:Dt.REQ_USER_ACCOUNT,lts:o,success:t.success,serverAddress:t.serverAddr,stringUid:t.stringUid,uid:t.uid,errorCode:t.errorCode,elapse:t.elapse||o-i.startTime,eventElapse:o-t.lts,extend:JSON.stringify(t.extend)});this.send({type:Xi.REQ_USER_ACCOUNT,data:s},!0)}joinGateway(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info;t.vid&&(r.vid=t.vid),r.uid=t.uid,r.cid=t.cid;const o=Date.now(),{firstSuccess:s,addr:a,isProxy:c}=t,d=o-i.startTime,l=ft(ft({},r),{},{eventType:Dt.JOIN_GATEWAY,lts:o,gatewayAddr:t.addr,success:t.succ,errorCode:t.ec,errorMsg:t.errorMsg||"",elapse:d,eventElapse:o-t.lts,firstSuccess:s,signalChannel:t.signalChannel,preload:t.preload?1:0,installId:Js(),isABTestSuccess:t.isABTestSuccess?1:0,gatewayIp:null,gatewayPort:null,isProxy:c?1:0}),h=l.success?1:0;if(t.succ&&(i.lastJoinSuccessTime=o),a)if(l.signalChannel==="1"){const p=Dv(/(\d+\.\d+\.\d+\.\d+):(\d+)/,{ip:1,port:2}),f=a.match(p);l.gatewayIp=f&&f.groups?f.groups.ip:"",l.gatewayPort=f&&f.groups?f.groups.port:""}else if(c){const p=a.match(/h=(\d{1,3}-){3}\d{1,3}/g),f=a.match(/p=[0-9]{1,6}/g);l.gatewayIp=p&&p.length?p[0].split("=")[1].replace(/-/g,"."):"",l.gatewayPort=f&&f.length?f[0].split("=")[1]:""}else{const p=a.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),f=a.match(/(:|p=)[0-9]{1,6}/g);l.gatewayIp=p&&p.length?p[0].split("//")[1].replace(/-/g,"."):"",l.gatewayPort=f&&f.length?f[0].split(/:|p=/g)[1]:""}if(s)this.send({type:Xi.JOIN_GATEWAY,data:l},!0);else{let p={isSuccess:h,port:l.gatewayPort};delete l.success,delete l.eventType,delete l.firstSuccess,delete l.gatewayPort,l.vid=Number(l.vid);const f=Object.assign({},l,p,{eventType:Dt.REJOIN_GATEWAY});this.send({type:Xi.RE_JOIN_GATEWAY,data:f},!0)}}joinChannelTimeout(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const r=Date.now(),o=ft(ft({},i.info),{},{lts:r,timeout:t,elapse:r-i.startTime});this.send({type:Xi.JOIN_CHANNEL_TIMEOUT,data:o},!0)}publish(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=ft(ft({},r),{},{eventType:Dt.PUBLISH,lts:o,eventElapse:t.eventElapse,elapse:o-i.startTime,success:t.succ,errorCode:t.ec,videoName:t.videoName,audioName:t.audioName,screenName:t.screenName,screenshare:t.screenshare,audio:t.audio,video:t.video,p2pid:t.p2pid,publishRequestid:t.publishRequestid});this.send({type:Xi.PUBLISH,data:s},!0)}subscribe(e,t,i){const r=this.baseInfoMap.get(e);if(!r)return;const o=r.info,s=Date.now(),a=ft(ft({},o),{},{eventType:Dt.SUBSCRIBE,lts:s,eventElapse:t.eventElapse,elapse:s-r.startTime,success:t.succ,errorCode:t.ec,video:t.video,audio:t.audio,subscribeRequestid:t.subscribeRequestid,p2pid:t.p2pid,preSsrc:t.preSsrc?1:0},i&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof t.peerid=="string"?a.peerSuid=t.peerid:a.peer=t.peerid,this.send({type:Xi.SUBSCRIBE,data:a},!0)}wsCompressorInit(e){var t;const i=[...ai(t=this.baseInfoMap).call(t)],r=i.length?i[0]:"UnableToGetSid",o=this.baseInfoMap.get(r);if(!o)return;const s=o.info,a=Date.now(),c=ft(ft({},s),{},{eventType:Dt.WS_COMPRESSOR_INIT,lts:a,eventElapse:e.eventElapse,elapse:a-o.startTime,status:e.status?1:2});this.send({type:Xi.WS_COMPRESSOR_INIT,data:c},!0)}firstXLAPeerFirstVideoFrame(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=t.peerPubStatusMs-(i.lastJoinSuccessTime||o),a=ft(ft({},r),{},{elapse:o-i.startTime,eventType:Dt.XLA_PEER_FIRST_VIDEO_FRAME,lts:o,peer:t.peer,width:t.width,height:t.height,ssrc:t.ssrc,p2pid:t.p2pid,peerPublishDuration:t.peerPublishDuration,joinChannelSuccessElapse:s,peerPubStatusMs:t.peerPubStatusMs-t.joinChannelStart,availablePublish:t.peerPublishDuration>s?1:0,preloadStart:Math.max(t.preloadStart-t.joinChannelStart,0),preloadEnd:Math.max(t.preloadEnd-t.joinChannelStart,0),encrypt:Math.max(t.apStart-t.joinChannelStart,0),ap:Math.max(t.apEnd-t.joinChannelStart,0),sua:Math.max(t.suaEnd-t.joinChannelStart,0),beforeConnect:Math.max(t.beforeConnect-t.joinChannelStart,0),peerRecevier:Math.max(t.peerReceiver-t.joinChannelStart,0),ice:Math.max(t.ice-t.joinChannelStart,0),pc:Math.max(t.pc-t.joinChannelStart,0),signalConnected:Math.max(t.signalConnected-t.joinChannelStart,0),joinReq:Math.max(t.joinReq-t.joinChannelStart,0),joinRes:Math.max(t.joinRes-t.joinChannelStart,0),userJoinNotify:Math.max(t.userJoinNotify-t.joinChannelStart,0),videoSsrcNotify:Math.max(t.videoAddNotify-t.joinChannelStart,0),subscribeDelayMs:Math.max(t.subscribeStart-t.videoAddNotify,0),subscribeStart:Math.max(t.subscribeStart-t.joinChannelStart,0),subscribeEnd:Math.max(t.subscribeEnd-t.joinChannelStart,0),firstReceived:Math.max(t.firstReceived-t.joinChannelStart,0),firstDecoded:Math.max(t.firstDecoded-t.joinChannelStart,0),firstPreRender:Math.max(t.firstPreRender-t.joinChannelStart,0),firstRender:Math.max(t.firstRender-t.joinChannelStart,0),playDelayMs:Math.max(t.playStart-t.subscribeEnd,0),playStart:Math.max(t.playStart-t.joinChannelStart,0),playEnd:Math.max(t.playEnd-t.joinChannelStart,0),isPreSub:t.isPreSub?1:0,isPrePc:t.isPrePc?1:0,isPreInstantVideo:t.isPreInstantVideo?1:0,firstReceivedEncodedFrame:t.firstReceivedEncodedFrame?Math.max(t.firstReceivedEncodedFrame-t.joinChannelStart,0):void 0,frameType:t.frameType||"",rtpTimestamp:t.rtpTimestamp||0,framePayloadType:t.framePayloadType||0,frameDataLength:t.frameDataLength||0,mimeType:t.mimeType||""});this.send({type:Xi.XLA_PEER_FIRST_VIDEO_FRAME,data:a},!0)}firstRemoteVideoDecode(e,t,i,r){const o=this.baseInfoMap.get(e);if(!o)return;const s=o.info,a=Date.now(),c=ft(ft(ft({},s),r),{},{elapse:a-o.startTime,eventType:t,lts:a,firstDecodeFrame:Math.max((r.firstFrame||a)-o.startTime,0),apEnd:Math.max(r.apEnd-o.startTime,0),apStart:Math.max(r.apStart-o.startTime,0),joinGwEnd:Math.max(r.joinGwEnd-o.startTime,0),joinGwStart:Math.max(r.joinGwStart-o.startTime,0),pcEnd:Math.max(r.pcEnd-o.startTime,0),pcStart:Math.max(r.pcStart-o.startTime,0),subscriberEnd:Math.max(r.subscriberEnd-o.startTime,0),subscriberStart:Math.max(r.subscriberStart-o.startTime,0),videoAddNotify:Math.max(r.videoAddNotify-o.startTime,0)});this.send({type:i,data:c},!0)}firstRemoteFrame(e,t,i,r){const o=this.baseInfoMap.get(e);if(!o)return;const s=o.info,a=Date.now(),c=ft(ft(ft({},s),r),{},{elapse:a-o.startTime,eventType:t,lts:a});this.send({type:i,data:c},!0)}abTest(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=ft(ft(ft({},r),t),{},{vid:r.vid===void 0?0:Number(r.vid),elapse:o-i.startTime,eventType:Dt.AB_TEST,lts:o});this.send({type:Xi.AB_TEST,data:s},!0)}pcStats(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=ft(ft(ft({},r),t),{},{vid:r.vid===void 0?0:Number(r.vid),elapse:o-i.startTime,eventType:Dt.PC_STATS,lts:o,preallocation:t.preallocation?1:0});this.send({type:Xi.PC_STATS,data:s},!0)}updateRemoteRTPCapabilities(e,t){if(e){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=ft(ft(ft({},r),t),{},{vid:r.vid===void 0?0:Number(r.vid),eventType:Dt.UPDATE_REMOTE_RTPCAPABILITIES,lts:o});this.send({type:Xi.UPDATE_REMOTE_RTPCAPABILITIES,data:s},!0)}}onGatewayStream(e,t,i,r){const o=this.baseInfoMap.get(e);if(!o)return;const s=o.info,a=Date.now(),c=ft(ft(ft({},s),r),{},{eventType:t,lts:a});this.send({type:i,data:c},!0)}streamSwitch(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=ft(ft({},r),{},{eventType:Dt.STREAM_SWITCH,lts:o,isDual:t.isdual,elapse:o-i.startTime,success:t.succ});this.send({type:Xi.STREAM_SWITCH,data:s},!0)}requestProxyAppCenter(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=ft(ft({},r),{},{eventType:Dt.REQUEST_PROXY_APPCENTER,lts:o,eventElapse:o-t.lts,elapse:o-i.startTime,APAddr:t.APAddr,workerManagerList:t.workerManagerList,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:Xi.REQUEST_PROXY_APPCENTER,data:s},!0)}requestProxyWorkerManager(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=ft(ft({},r),{},{eventType:Dt.REQUEST_PROXY_WORKER_MANAGER,lts:o,eventElapse:o-t.lts,elapse:o-i.startTime,workerManagerAddr:t.workerManagerAddr,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:Xi.REQUEST_PROXY_WORKER_MANAGER,data:s},!0)}setProxyServer(e){this.proxyServer=e,e?I.debug("reportProxyServerurl: ".concat(e)):I.debug("disable reportProxyServerurl: ".concat(e))}peerPublishStatus(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=ft(ft({},r),{},{subscribeElapse:t.subscribeElapse,peer:t.peer,peerPublishDuration:Math.max(t.audioPublishDuration,t.videoPublishDuration),audiotag:t.audioPublishDuration>0?1:-1,videotag:t.videoPublishDuration>0?1:-1,lts:o,elapse:o-i.startTime,joinChannelSuccessElapse:o-(i.lastJoinSuccessTime||o),peerPublishDurationVideo:t.videoPublishDuration,peerPublishDurationAudio:t.audioPublishDuration});this.send({type:Xi.PEER_PUBLISH_STATUS,data:s},!0)}workerEvent(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now();(function(s,a,c){const d=s[a];if(!d||typeof d!="string")return[s];s[a]="";const l=Vd(JSON.stringify(s));let h=0;const p=[];let f=0;for(let m=0;m<d.length;m++)f+=d.charCodeAt(m)<=127?1:3,f<=c-l||(p[p.length]=L(L({},s),{},{[a]:d.substring(h,m)}),h=m,f=d.charCodeAt(m)<=127?1:3);return h!==d.length-1&&(p[p.length]=L(L({},s),{},{[a]:d.substring(h)})),p})(ft(ft(ft({},r),t),{},{elapse:o-i.startTime,lts:o,productType:"WebRTC"}),"payload",1300).forEach(s=>this.send({type:Xi.WORKER_EVENT,data:s},!0))}apworkerEvent(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=ft(ft(ft({},r),t),{},{elapse:o-i.startTime,lts:o});this.send({type:Xi.AP_WORKER_EVENT,data:s},!0)}joinWebProxyAP(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=ft(ft(ft({},r),t),{},{elapse:o-i.startTime,lts:o,extend:t.extend||void 0});this.send({type:Xi.JOIN_WEB_PROXY_AP,data:s},!0)}WebSocketQuit(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=ft(ft(ft({},r),t),{},{elapse:o-i.startTime,lts:o});this.send({type:Xi.WEBSOCKET_QUIT,data:s},!0)}async sendCustomReportMessage(e,t){if(this.customReportCount+=t.length,this.customReportCount>B("CUSTOM_REPORT_LIMIT"))throw new oe(O.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));const i=Date.now(),r=t.map(o=>({type:Xi.USER_ANALYTICS,data:ft(ft({sid:e},o),{},{lts:i})}));try{B("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(r):await this.postDataToStatsCollector(r)}catch(o){throw I.error("send custom report message failed",o.toString()),new oe(O.CUSTOM_REPORT_SEND_FAILED,o.message)}}sendApiInvoke(e){const t=B("NOT_REPORT_EVENT");if(e.tag&&z(t)&&z(t).call(t,e.tag))return!1;if(e.sid===null)return this.apiInvokeUploadPendingItems.push(e),!1;const i=this.baseInfoMap.get(e.sid);if(!i)return this.apiInvokeUploadPendingItems.push(e),!1;const{cname:r,uid:o,cid:s}=i.info;let a;if(e.lts=e.lts||Date.now(),e.error)if(e.error instanceof oe){const{code:d,message:l}=e.error;a=d||l||e.error.toString()}else a=e.error.toString();const c={invokeId:e.invokeId,sid:e.sid,cname:r,cid:s,uid:o,lts:e.lts,success:e.success,elapse:e.lts-i.startTime,execElapse:e.lts-e.apiInvokeTime,apiName:e.name,options:e.options?JSON.stringify(e.options):void 0,execStates:e.states?JSON.stringify(e.states):void 0,execResult:e.result?JSON.stringify(e.result):void 0,errorCode:e.error?a:void 0,errorMsg:e.error?JSON.stringify(e.error):void 0};return this.send({type:Xi.API_INVOKE,data:c},!1),!0}addSid(e){this.sids.add(e)}removeSid(e){this.sids.delete(e)}appendSessionId(){const e=this.apiInvokeUploadPendingItems;if(e.length===0)return;const t=Array.from(this.sids).find(i=>i!==null);t&&e.forEach(i=>{i&&(i.sid=t,this.sendApiInvoke(Object.assign({},i)))}),e.length=0}send(e,t){if(t)return this.keyEventUploadPendingItems.push(e),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(e),this.normalEventUploadPendingItems.length>B("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(e,t){const i=[],r=[];for(;e.length;){const s=e.shift();i.length<20?i.push(s):r.push(s)}e.push(...r);for(const s of[...i]){var o;this.ltsList.indexOf(s.data.lts)!==-1?(s.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(s.data.lts)):(this.ltsList.push(s.data.lts),Ka(o=this.ltsList).call(o,(a,c)=>a-c))}return t||(this.lastSendNormalEventTime=Date.now()),B("ENABLE_EVENT_REPORT")&&i.length&&(B("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(i):this.postDataToStatsCollector(i)).catch((s=>a=>{B("EVENT_REPORT_RETRY")&&(t?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(s):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(s),this.normalEventUploadPendingItems.length>B("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-B("NORMAL_EVENT_QUEUE_CAPACITY")),I.warning("report: drop normal events"))))})(i)),e}async postDataToStatsCollector2(e){fi.networkState===yn.OFFLINE&&await Z.race([fi.onlineWaiter,vt(2*yr.maxRetryTimeout)]);const t=o=>{let s=new Uint8Array;return o.forEach(a=>{const c=Tv(JSON.stringify(a.data)),d=new ArrayBuffer(5),l=(p=>{let f=0;return Object.entries(Xi).forEach(m=>{let[g,S]=m;S===p.type&&(f=Xe[g])}),f})(a),h=new DataView(d);h.setUint16(0,c.byteLength,!0),h.setUint8(2,255&l),h.setUint8(3,l>>>8&255),h.setUint8(4,l>>>16&255),s=Rv(s,new Uint8Array(d)),s=Rv(s,c)}),s},i="event";let r=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(B("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(i):"https://".concat(B("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(i);for(let o=0;o<2;o+=1){o===1&&(r=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(B("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(i):"https://".concat(B("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(i));try{await xN(r,{timeout:1e4,data:t(e),headers:ft(ft({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(s){if(o===1)throw s;continue}return}}async postDataToStatsCollector(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const i=(c=>{const d=c&&c.data.sid&&this.baseInfoMap.get(c.data.sid);return d&&d.info.vid&&+d.info.vid||0})(e[0]),r=i?void 0:this._aid,o={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:e.map(c=>JSON.stringify(c)),vid:i,aid:r};fi.networkState===yn.OFFLINE&&await Z.race([fi.onlineWaiter,vt(2*yr.maxRetryTimeout)]);const s=t?"/events/proto-raws":"/events/messages";let a=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(B("EVENT_REPORT_DOMAIN"),"&p=").concat(B("STATS_COLLECTOR_PORT"),"&d=").concat(s):"https://".concat(B("EVENT_REPORT_DOMAIN"),":").concat(B("STATS_COLLECTOR_PORT")).concat(s));for(let c=0;c<2;c+=1){c===1&&(a=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(B("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(B("STATS_COLLECTOR_PORT"),"&d=").concat(s):"https://".concat(B("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(B("STATS_COLLECTOR_PORT")).concat(s)));try{t?await CU(a,{timeout:1e4,data:o}):await xN(a,{timeout:1e4,data:o})}catch(d){if(c===1)throw d;continue}return}}createBaseInfo(e,t){const i=Object.assign({},en);return i.sid=e,this.baseInfoMap.set(e,{info:i,startTime:t}),i}reportResourceTiming(e,t){const i=performance.getEntriesByName(e),r=i[i.length-1];r&&this.reportApiInvoke(t,{name:"Client.resourceTiming",options:r,tag:bi.TRACER}).onSuccess()}};bU.on("REPORT_LOG_UPLOAD",e=>{e.networkState=fi.networkState,H.reportApiInvoke(null,{name:"logUploadError",options:e,tag:bi.TRACER}).onSuccess("logUploadError")});let $=class extends oe{constructor(e){super(e,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),Er(this,"name","AgoraRTCException")}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(e,I)}throw(){super.throw(I)}};const ot={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1,supportSuppressLocalAudioPlayback:!1,supportRestrictOwnAudio:!1};function Mt(){return ot}function aT(){return"setSinkId"in HTMLAudioElement.prototype&&(!B("RESTRICTION_SET_PLAYBACK_DEVICE")||(Cr()||ji())&&!Ud())}function kh(){return!ot.supportUnifiedPlan||B("CHROME_FORCE_PLAN_B")&&ha()}function Wf(e){return!(Ht()||_v(87)||kh()||!B("ENABLE_PRE_SUB")&&(e==null||!e.autoSubscribe||B("FORCE_DISABLE_AUTO_SUB")))}function KN(e){return B("ENABLE_INSTANT_VIDEO")?B("ENABLE_INSTANT_VIDEO"):!(e==null||!e.autoSubscribe||B("FORCE_DISABLE_AUTO_SUB"))}function YN(){return navigator.mediaDevices&&"getSupportedConstraints"in navigator.mediaDevices}function zN(){if(YN()){const e=navigator.mediaDevices.getSupportedConstraints();return!(!("suppressLocalAudioPlayback"in e)||!e.suppressLocalAudioPlayback)}return bc(141)||Rl(141)||Ah(141)}function In(){if(YN()){const e=navigator.mediaDevices.getSupportedConstraints();return!(!("restrictOwnAudio"in e)||!e.restrictOwnAudio)}return bc(141)||Rl(141)||Ah(125)}let zr=function(e){return e.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",e.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",e.IOS_INTERRUPTION_START="ios-interruption-start",e.IOS_INTERRUPTION_END="ios-interruption-end",e.STATE_CHANGE="state-change",e}({});function Kt(e,t,i){return{sampleRate:e,stereo:t,bitrate:i}}function Pt(e,t,i,r,o){return{width:e,height:t,frameRate:i,bitrateMin:r,bitrateMax:o}}function Sa(e,t,i,r,o){return{width:{max:e},height:{max:t},frameRate:i,bitrateMin:r,bitrateMax:o}}function qN(e,t){return{numSpatialLayers:e,numTemporalLayers:t}}const GY={"90p":Pt(160,90),"90p_1":Pt(160,90),"120p":Pt(160,120,15,30,65),"120p_1":Pt(160,120,15,30,65),"120p_3":Pt(120,120,15,30,50),"120p_4":Pt(212,120),"180p":Pt(320,180,15,30,140),"180p_1":Pt(320,180,15,30,140),"180p_3":Pt(180,180,15,30,100),"180p_4":Pt(240,180,15,30,120),"240p":Pt(320,240,15,40,200),"240p_1":Pt(320,240,15,40,200),"240p_3":Pt(240,240,15,40,140),"240p_4":Pt(424,240,15,40,220),"360p":Pt(640,360,15,80,400),"360p_1":Pt(640,360,15,80,400),"360p_3":Pt(360,360,15,80,260),"360p_4":Pt(640,360,30,80,600),"360p_6":Pt(360,360,30,80,400),"360p_7":Pt(480,360,15,80,320),"360p_8":Pt(480,360,30,80,490),"360p_9":Pt(640,360,15,80,800),"360p_10":Pt(640,360,24,80,800),"360p_11":Pt(640,360,24,80,1e3),"480p":Pt(640,480,15,100,500),"480p_1":Pt(640,480,15,100,500),"480p_2":Pt(640,480,30,100,1e3),"480p_3":Pt(480,480,15,100,400),"480p_4":Pt(640,480,30,100,750),"480p_6":Pt(480,480,30,100,600),"480p_8":Pt(848,480,15,100,610),"480p_9":Pt(848,480,30,100,930),"480p_10":Pt(640,480,10,100,400),"720p":Pt(1280,720,15,120,1130),"720p_auto":Pt(1280,720,30,900,3e3),"720p_1":Pt(1280,720,15,120,1130),"720p_2":Pt(1280,720,30,120,2e3),"720p_3":Pt(1280,720,30,120,1710),"720p_5":Pt(960,720,15,120,910),"720p_6":Pt(960,720,30,120,1380),"1080p":Pt(1920,1080,15,120,2080),"1080p_1":Pt(1920,1080,15,120,2080),"1080p_2":Pt(1920,1080,30,120,3e3),"1080p_3":Pt(1920,1080,30,120,3150),"1080p_5":Pt(1920,1080,60,120,4780),"1440p":Pt(2560,1440,30,120,4850),"1440p_1":Pt(2560,1440,30,120,4850),"1440p_2":Pt(2560,1440,60,120,7350),"4k":Pt(3840,2160,30,120,8910),"4k_1":Pt(3840,2160,30,120,8910),"4k_3":Pt(3840,2160,60,120,13500)},WY={"480p":Sa(640,480,5),"480p_1":Sa(640,480,5),"480p_2":Sa(640,480,30),"480p_3":Sa(640,480,15),"720p":Sa(1280,720,5),"720p_auto":Pt(1280,720,30,900,3e3),"720p_1":Sa(1280,720,5),"720p_2":Sa(1280,720,30),"720p_3":Sa(1280,720,15),"1080p":Sa(1920,1080,5),"1080p_1":Sa(1920,1080,5),"1080p_2":Sa(1920,1080,30),"1080p_3":Sa(1920,1080,15)},Oc={"1SL1TL":qN(1,1),"3SL3TL":qN(3,3),"2SL3TL":qN(2,3)};function Ta(e){return e||(e="480p_1"),typeof e=="string"?Object.assign({},GY[e]):e}function Hf(e){return typeof e=="string"?Object.assign({},WY[e]):e}function Lv(e){return typeof e=="string"?Object.assign({},Oc[e]):e}const kv={speech_low_quality:Kt(16e3,!1),speech_standard:Kt(32e3,!1,18),music_standard:Kt(48e3,!1),standard_stereo:Kt(48e3,!0,56),high_quality:Kt(48e3,!1,128),high_quality_stereo:Kt(48e3,!0,192)};function Cl(e){return typeof e=="string"?Object.assign({},kv[e]):e}const Mh=[];function Ue(e){return Rt(e,"mediaSource",["screen","window","application"]),!0}let Re=function(e){return e.NEED_RENEGOTIATE="@need_renegotiate",e.NEED_REPLACE_TRACK="@need_replace_track",e.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",e.NEED_CLOSE="@need_close",e.NEED_ENABLE_TRACK="@need_enable_track",e.NEED_DISABLE_TRACK="@need_disable_track",e.NEED_SESSION_ID="@need_sid",e.SET_OPTIMIZATION_MODE="@set_optimization_mode",e.GET_STATS="@get_stats",e.GET_RTC_STATS="@get_rtc_stats",e.GET_LOW_VIDEO_TRACK="@get_low_video_track",e.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",e.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",e.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",e.NEED_MUTE_TRACK="@need_mute_track",e.NEED_UNMUTE_TRACK="@need_unmute_track",e}({}),ui=function(e){return e.SCREEN_TRACK="screen_track",e.CUSTOM_TRACK="custome_track",e.LOW_STREAM="low_stream",e.SCREEN_LOW_TRACK="screen_low_track",e}({}),Kf=function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e}({}),HY=function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e[e.HIGH_STREAM_LAYER1=4]="HIGH_STREAM_LAYER1",e[e.HIGH_STREAM_LAYER2=5]="HIGH_STREAM_LAYER2",e[e.HIGH_STREAM_LAYER3=6]="HIGH_STREAM_LAYER3",e[e.HIGH_STREAM_LAYER4=7]="HIGH_STREAM_LAYER4",e[e.HIGH_STREAM_LAYER5=8]="HIGH_STREAM_LAYER5",e[e.HIGH_STREAM_LAYER6=9]="HIGH_STREAM_LAYER6",e}({}),b_=function(e){return e[e.DISABLE=0]="DISABLE",e[e.LOW_STREAM=1]="LOW_STREAM",e[e.AUDIO_ONLY=2]="AUDIO_ONLY",e[e.HIGH_STREAM_LAYER1=3]="HIGH_STREAM_LAYER1",e[e.HIGH_STREAM_LAYER2=4]="HIGH_STREAM_LAYER2",e[e.HIGH_STREAM_LAYER3=5]="HIGH_STREAM_LAYER3",e[e.HIGH_STREAM_LAYER4=6]="HIGH_STREAM_LAYER4",e[e.HIGH_STREAM_LAYER5=7]="HIGH_STREAM_LAYER5",e[e.HIGH_STREAM_LAYER6=8]="HIGH_STREAM_LAYER6",e}({}),Nc=function(e){return e.TRANSCEIVER_UPDATED="transceiver-updated",e.SEI_TO_SEND="sei-to-send",e.SEI_RECEIVED="sei-received",e.TRACK_UPDATED="track-updated",e}({}),Wo=function(e){return e.SOURCE_STATE_CHANGE="source-state-change",e.TRACK_ENDED="track-ended",e.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.CLOSED="closed",e}({}),Ho=function(e){return e.FIRST_FRAME_DECODED="first-frame-decoded",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.VIDEO_STATE_CHANGED="video-state-changed",e.PLAY_START="play-start",e.PLAY_END="play-end",e.FIRST_FRAME_RENDER="first-frame-render",e}({}),No=function(e){return e.AUDIO="audio",e.VIDEO="video",e.DATA="data",e}({}),ys=function(e){return e.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",e.RECEIVE_TRACK_BUFFER="receive_track_buffer",e.ON_AUDIO_BUFFER="on_audio_buffer",e.UPDATE_SOURCE="update_source",e}({});(function(e){e.UPDATE_TRACK_SOURCE="update-track-source"})({});const cT={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},Mv={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},NU={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receivePacketsDiscarded:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},DU={uplinkNetworkQuality:0,downlinkNetworkQuality:0},Do={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let wr=function(e){return e.ON_TRACK="on_track",e.ON_NODE="on_node",e}({}),Ko=function(e){return e.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",e.REQUEST_CONSTRAINTS="request_constraints",e}({}),Bd=function(e){return e.IDLE="IDLE",e.INITING="INITING",e.INITEND="INITEND",e}({}),tn=function(e){return e.STATE_CHANGE="state_change",e.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",e.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",e.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",e}({}),Pr=function(e){return e.NONE="none",e.INIT="init",e.CANPLAY="canplay",e.PLAYING="playing",e.PAUSED="paused",e.SUSPEND="suspend",e.STALLED="stalled",e.WAITING="waiting",e.ERROR="error",e.DESTROYED="destroyed",e.ABORT="abort",e.ENDED="ended",e.EMPTIED="emptied",e.LOADEDDATA="loadeddata",e}({}),Dc=function(e){return e[e.VideoStateStopped=0]="VideoStateStopped",e[e.VideoStateStarting=1]="VideoStateStarting",e[e.VideoStateDecoding=2]="VideoStateDecoding",e[e.VideoStateFrozen=3]="VideoStateFrozen",e}({});const Yf={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};let Wt=function(e){return e.OPEN="open",e.MESSAGE="message",e.CLOSE="close",e.CLOSING="closing",e.ERROR="error",e}({});function X(e,t,i,r,o){var s,a,c={};return Object.keys(r).forEach(function(d){c[d]=r[d]}),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=un(s=xI(a=i.slice()).call(a)).call(s,function(d,l){return l(e,t,d)||d},c),o&&c.initializer!==void 0&&(c.value=c.initializer?c.initializer.call(o):void 0,c.initializer=void 0),c.initializer===void 0?(Object.defineProperty(e,t,c),null):c}function re(e,t,i){return(t=function(r){var o=function(s,a){if(typeof s!="object"||!s)return s;var c=s[Symbol.toPrimitive];if(c!==void 0){var d=c.call(s,"string");if(typeof d!="object")return d;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(s)}(r);return typeof o=="symbol"?o:o+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function ki(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function Mi(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?ki(Object(i),!0).forEach(function(r){re(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ki(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}class O_ extends Vi{set _mediaStreamTrack(t){t!==this.mediaStreamTrack&&(this.safeEmit(Nc.TRACK_UPDATED,t),this.mediaStreamTrack=t)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(t,i){super(),re(this,"trackMediaType",void 0),re(this,"_ID",void 0),re(this,"_rtpTransceiver",void 0),re(this,"_lowRtpTransceiver",void 0),re(this,"_hints",[]),re(this,"_isClosed",!1),re(this,"_originMediaStreamTrack",void 0),re(this,"mediaStreamTrack",void 0),re(this,"_external",{}),this._ID=i||li(8,"track-"),this._originMediaStreamTrack=t,this.mediaStreamTrack=t,function(r){z(Mh).call(Mh,r)||Mh.push(r)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(t){return t||pa(()=>{var i;H.reportApiInvoke(null,{name:ct.GET_MEDIA_STREAM_TRACK,options:[],tag:bi.TRACER}).onSuccess(((i=this._mediaStreamTrack)===null||i===void 0?void 0:i.label)||"")},this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(t){return t===Kf.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(t){const i=Mh.indexOf(t);i!==-1&&Mh.splice(i,1)}(this),this.emit(Wo.CLOSED),this.removeAllListeners(Nc.SEI_RECEIVED)}_updateRtpTransceiver(t,i){if(i===Kf.LOW_STREAM){if(this._lowRtpTransceiver===t)return;this._lowRtpTransceiver=t}else{if(this._rtpTransceiver===t)return;this._rtpTransceiver=t}this.emit(Nc.TRANSCEIVER_UPDATED,t,i)}}class N_ extends O_{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(t,i){super(t,i),re(this,"_enabled",!0),re(this,"_muted",!1),re(this,"_isExternalTrack",!1),re(this,"_isClosed",!1),re(this,"_enabledMutex",void 0),re(this,"processor",void 0),re(this,"_processorContext",void 0),re(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new jr("".concat(this.getTrackId())),t.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var t,i;return(t=(i=this._originMediaStreamTrack)===null||i===void 0?void 0:i.label)!==null&&t!==void 0?t:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,I.debug("[".concat(this.getTrackId(),"] close")),this.emit(Re.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(t,i){let r=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=r,t!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),i&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Xt(this,Re.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){I.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Wo.TRACK_ENDED)}stateCheck(t,i){if(I.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(t,": ").concat(i,"]")),xi(i,t),this._enabled&&this._muted&&t==="enabled"&&i===!1)throw new oe(O.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",I);if(!this._enabled&&!this._muted&&t==="muted"&&i===!0)throw new oe(O.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",I)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():Z.resolve([])}}const Uv=window.AudioContext||window.webkitAudioContext;let Is,Yt=null;const Ei=new class extends Vi{constructor(){super(...arguments),re(this,"prevState",void 0),re(this,"curState",void 0),re(this,"currentTime",void 0),re(this,"currentTimeStuckAt",void 0),re(this,"interruptDetectorTrack",void 0),re(this,"onLocalAudioTrackMute",()=>{I.info("ios15-interruption-start"),this.emit(zr.IOS_15_16_INTERRUPTION_START)}),re(this,"onLocalAudioTrackUnmute",async()=>{I.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?I.info("ios15-interruption-end-canceled"):(Yt&&await Yt.suspend(),this.emit(zr.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(e){I.debug("webaudio bindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=e,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(e){I.debug("webaudio unbindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===e&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function Pc(){if(!Yt){if(function(){if(!Uv)return void I.error("your browser is not support web audio");I.info("create audio context");const e=Mi({},B("WEBAUDIO_INIT_OPTIONS"));I.debug("audio context init option:",JSON.stringify(e)),Yt=new Uv(e),Ei.curState=Yt.state,Yt.onstatechange=()=>{Ei.prevState=Ei.curState,Ei.curState=Yt?Yt.state:void 0;const{prevState:t,curState:i}=Ei,r=i==="running",o=i==="interrupted",s=t==="running",a=t==="suspended",c=t==="interrupted",d=ii().osVersion;(Dr()||rc())&&s&&o&&(I.info("ios".concat(d,"-interruption-start")),Ei.emit(zr.IOS_INTERRUPTION_START)),(Dr()||rc())&&(a||c)&&r&&(I.info("ios".concat(d,"-interruption-end")),Ei.emit(zr.IOS_INTERRUPTION_END)),t!==i&&Ei.emit(zr.STATE_CHANGE,i,t)},setInterval(()=>{var t;const i=(t=Yt)===null||t===void 0?void 0:t.currentTime;Ei.currentTime!==i?(Ei.currentTimeStuckAt&&(I.debug("AudioContext current time resume at ".concat(i)),Ei.currentTimeStuckAt=void 0),Ei.currentTime=i):(i!==Ei.currentTimeStuckAt&&(H.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:i},tag:bi.TRACER}).onSuccess(),I.warning("AudioContext current time stuck at ".concat(i))),Ei.currentTimeStuckAt=i)},5e3),async function(t){const i=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let r,o,s=!1,a=!1,c=!1;function d(C){t.state==="running"?l(!1):Dr()||rc()?t.state==="suspended"&&(l(!0),C&&t.resume().then(h,h)):t.state!=="closed"&&(l(!0),C&&t.resume().then(h,h))}function l(C){if(s!==C){s=C;for(let b=0,D=i;b<D.length;b+=1){const x=D[b];C?window.addEventListener(x,p,{capture:!0,passive:!0}):window.removeEventListener(x,p,{capture:!0,passive:!0})}}}function h(){d(!1)}function p(){d(!0)}function f(){let C;try{C=r.play(),C?C.then(S,S):(r.addEventListener("playing",S),r.addEventListener("abort",S),r.addEventListener("error",S))}catch{S()}}function m(C){c||(r.paused?C?(g(!1),c=!0,f()):g(!0):g(!1))}function g(C){if(a!==C){a=C;for(let b=0,D=i;b<D.length;b++){const x=D[b];C?window.addEventListener(x,T,{capture:!0,passive:!0}):window.removeEventListener(x,T,{capture:!0,passive:!0})}}}function S(){r.removeEventListener("playing",S),r.removeEventListener("abort",S),r.removeEventListener("error",S),c=!1,m(!1)}function T(){m(!0)}if(Dr()&&B("IOS_BG_TAG")){const C=t.createMediaStreamDestination(),b=document.createElement("div");b.innerHTML="<audio x-webkit-airplay='deny'></audio>",r=b.children.item(0),r.controls=!1,r.disableRemotePlayback=!0,r.preload="auto",r.srcObject=C.stream,o=()=>{if(B("IOS_AUTO_RESTART_BG_TAG")&&r&&r.srcObject&&!c&&(!r.paused||a!==!0)){r.paused||r.pause();try{c=!0,f()}catch{c=!1}return!0}},m(!0)}return Ei.on(zr.STATE_CHANGE,function(){d(!0)}),d(!1),o}(Yt).then(t=>{Is=t})}(),!Yt)throw new oe(O.NOT_SUPPORTED,"can not create audio context");return Yt}return Yt}function Pu(e){if(function(){if(dT!==null)return dT;const r=Pc(),o=r.createBufferSource(),s=r.createGain(),a=r.createGain();o.connect(s),o.connect(a),o.disconnect(s);let c=!1;try{o.disconnect(s)}catch{c=!0}return o.disconnect(),dT=c,c}())return;const t=e.connect,i=e.disconnect;e.connect=(r,o,s)=>{var a;return e._inputNodes||(e._inputNodes=[]),z(a=e._inputNodes).call(a,r)||(r instanceof AudioNode?(e._inputNodes.push(r),t.call(e,r,o,s)):t.call(e,r,o)),e},e.disconnect=(r,o,s)=>{i.call(e),r?Iu(e._inputNodes,r):e._inputNodes=[];for(const a of e._inputNodes)t.call(e,a)}}let dT=null;function xv(e,t){let i=!1;const r=1/t;if(B("DISABLE_WEBAUDIO")){const o=window.setInterval(()=>{i?window.clearInterval(o):e(performance.now()/1e3)},1e3*r)}else{const o=Pc();let s=o.createGain();s.gain.value=0,s.connect(o.destination);const a=()=>{if(i)return void(s=null);const c=o.createOscillator();c.onended=a,c.connect(s),c.start(0),c.stop(o.currentTime+r),e(o.currentTime)};a()}return()=>{i=!0}}class XN{constructor(){re(this,"context",void 0),re(this,"analyserNode",void 0),re(this,"sourceNode",void 0),this.context=Pc(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(t){if(t!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=t,t==null||t.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||Dr()||rc()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;const t=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(t);else{const r=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(r);for(let o=0;o<t.length;++o)t[o]=r[o]/128-1}const i=un(t).call(t,(r,o)=>r+o*o,0)/t.length;return Math.max(10*Math.log10(i)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var t,i;(t=this.sourceNode)===null||t===void 0||t.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(i=this.sourceNode)===null||i===void 0||i.connect(this.analyserNode)}catch{I.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class Vv extends Vi{get processSourceNode(){return this.sourceNode}set processedNode(t){var i;if(!this.isDestroyed&&this._processedNode!==t){try{var r;(r=this.sourceNode)===null||r===void 0||r.disconnect(this.outputNode)}catch{}(i=this._processedNode)===null||i===void 0||i.disconnect(),this._processedNode=t,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),re(this,"outputNode",void 0),re(this,"outputTrack",void 0),re(this,"isPlayed",!1),re(this,"sourceNode",void 0),re(this,"context",void 0),re(this,"audioBufferNode",void 0),re(this,"destNode",void 0),re(this,"audioOutputLevel",0),re(this,"volumeLevelAnalyser",void 0),re(this,"_processedNode",void 0),re(this,"playNode",void 0),re(this,"isDestroyed",!1),re(this,"onNoAudioInput",void 0),re(this,"isNoAudioInput",!1),re(this,"_noAudioInputCount",0),this.context=Pc(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),Pu(this.outputNode),this.volumeLevelAnalyser=new XN}startGetAudioBuffer(t){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(t),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=i=>{this.emit(ys.ON_AUDIO_BUFFER,function(r){for(let o=0;o<r.outputBuffer.numberOfChannels;o+=1){const s=r.outputBuffer.getChannelData(o);for(let a=0;a<s.length;a+=1)s[a]=0}return r.inputBuffer}(i))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!Mt().webAudioMediaStreamDest)throw new oe(O.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(t){this.context.state!=="running"&&Li(()=>{Ei.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=t||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(t>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;Dr()||rc()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();const i=this.volumeLevelAnalyser.getAnalyserNode();let r;i.getFloatTimeDomainData?(r=new Float32Array(i.fftSize),i.getFloatTimeDomainData(r)):(r=new Uint8Array(i.fftSize),i.getByteTimeDomainData(r));let o=!1;for(let s=0;s<r.length;s++)r[s]!==0&&(o=!0);return o?(this.isNoAudioInput=!1,!0):(await vt(200),await this.checkHasAudioInput(t?t+1:1)&&o)}getAudioVolume(){return this.outputNode.gain.value}setVolume(t){this.outputNode.gain.setValueAtTime(t,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var t,i;(t=this.processedNode)===null||t===void 0||t.disconnect(),(i=this.sourceNode)===null||i===void 0||i.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var t;this.processedNode?(t=this.processedNode)===null||t===void 0||t.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class Fv extends Vv{get isFreeze(){return!1}constructor(t,i,r){var o;if(super(),re(this,"sourceNode",void 0),re(this,"track",void 0),re(this,"clonedTrack",void 0),re(this,"audioElement",void 0),re(this,"isCurrentTrackCloned",!1),re(this,"isRemoteTrack",!1),re(this,"originVolumeLevelAnalyser",void 0),re(this,"rebuildWebAudio",async()=>{if(I.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void I.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>I.info("resume success")),I.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const c=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?c.stop():this.isCurrentTrackCloned=!0;const d=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(d),Pu(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const l=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(l,this.context.currentTime),Pu(this.outputNode),this.emit(ys.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=d,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),t.kind!=="audio")throw new oe(O.UNEXPECTED_ERROR);this.track=t;const s=new MediaStream([this.track]);if(this.isRemoteTrack=!!i,this.sourceNode=this.context.createMediaStreamSource(s),Pu(this.sourceNode),r){const c=r.clone();c.enabled=!0,this.clonedTrack=c,I.debug("create an unmuted track ".concat(c.id," from the original track ").concat(r.id," to get the volume"));const d=this.context.createMediaStreamSource(new MediaStream([c]));Pu(d),this.originVolumeLevelAnalyser=new XN,this.originVolumeLevelAnalyser.updateSource(d)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=s;const a=ii();i&&a.os===pt.IOS&&Number((o=a.osVersion)===null||o===void 0?void 0:o.split(".")[0])<15&&(Ei.on(zr.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(c=>{c||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(t){this.sourceNode.disconnect(),this.track=t,this.isCurrentTrackCloned=!1;const i=new MediaStream([t]);this.sourceNode=this.context.createMediaStreamSource(i),Pu(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(ys.UPDATE_SOURCE),this.audioElement.srcObject=i}destroy(){var t;this.audioElement.srcObject=null,this.audioElement.remove(),Ei.off("state-change",this.rebuildWebAudio),(t=this.originVolumeLevelAnalyser)===null||t===void 0||t.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(t){return this.context.createMediaStreamSource(new MediaStream([t]))}updateOriginTrack(t){const i=t.clone();i.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=i),I.debug("create an unmuted track ".concat(i.id," from the original track ").concat(t.id," to get the volume"));const r=this.context.createMediaStreamSource(new MediaStream([i]));Pu(r),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(r)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function PU(e,t,i){const r=(s,a)=>s?typeof s!="number"?s.max||s.exact||s.ideal||s.min||a:s:a,o={audio:!!i&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxHeight:r(t.height,1080),maxWidth:r(t.width,1920)}}};return t.frameRate&&typeof t.frameRate!="number"?(o.video.mandatory.maxFrameRate=t.frameRate.max,o.video.mandatory.minFrameRate=t.frameRate.min):typeof t.frameRate=="number"&&(o.video.mandatory.maxFrameRate=t.frameRate),await navigator.mediaDevices.getUserMedia(o)}async function LU(e,t){const i=await Bv(e.mediaSource),{sourceId:r,audio:o}=await function(s){let a=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new Z((c,d)=>{const l=document.createElement("div");l.innerText="share screen",l.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const h=document.createElement("div");h.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const p=document.createElement("div");p.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",p.setAttribute("style","height: 12%;");const f=document.createElement("div");f.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const m=document.createElement("div");m.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const g=document.createElement("button");g.innerHTML="cancel",g.setAttribute("style","width: 85px;"),g.onclick=()=>{document.body.removeChild(C);const b=new Error("NotAllowedError");b.name="NotAllowedError",d(b)};let S=a;const T=document.createElement("div");if(a){const b=document.createElement("input");b.setAttribute("type","checkbox");const D=document.createElement("span");b.setAttribute("style","margin-right: 6px;"),D.innerText="Share audio",b.checked=S,b.onchange=()=>{S=b.checked},T.appendChild(b),T.appendChild(D)}m.appendChild(T),m.appendChild(g),h.appendChild(p),h.appendChild(f),h.appendChild(m);const C=document.createElement("div");C.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),C.appendChild(l),C.appendChild(h),document.body.appendChild(C),s.map(b=>{if(b.id){const D=document.createElement("div");D.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let x=b.thumbnail;try{const{width:k}=x.getSize();k>1920&&(x=x.resize({width:1920}))}catch(k){throw k&&k.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),k}D.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+x.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+b.name.replace(/[\u00A0-\u9999<>\&]/g,function(k){return"&#"+k.charCodeAt(0)+";"})+"</span>",D.onclick=()=>{document.body.removeChild(C),c({sourceId:b.id,audio:S})},f.appendChild(D)}})})}(i,t);return await PU(r,e,o)}async function Bv(e){let t=["window","screen"];e!=="application"&&e!=="window"||(t=["window"]),e==="screen"&&(t=["screen"]);const i=Yi();if(!i)throw console.error("failed to fetch electron, please mount it to window"),new oe(O.ELECTRON_IS_NULL);let r=null;try{var o;r=((o=i.desktopCapturer)===null||o===void 0?void 0:o.getSources({types:t}))||i.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:t})}catch{r=null}r&&r.then||(r=new Z((s,a)=>{i.desktopCapturer.getSources({types:t},(c,d)=>{c?a(c):s(d)})}));try{return await r}catch(s){throw new oe(O.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,s.toString())}}const jv=new jr("safari");let JN=!1,$s=!1;async function Ra(e,t){let i=0,r=null;for(;i<2;)try{r=await Gv(e,t,i>0);break}catch(o){if(o instanceof oe)throw I.error("[".concat(t,"] ").concat(o.toString())),o;const s=Lu(o.name||o.code||o,o.message);if(s.code===O.MEDIA_OPTION_INVALID){I.debug("[".concat(t,"] detect media option invalid, retry")),i+=1,await vt(500);continue}throw I.error("[".concat(t,"] ").concat(s.toString())),s}if(!r)throw new oe(O.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return r}async function Gv(e,t,i){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new oe(O.NOT_SUPPORTED,"can not find getUserMedia");i&&(e.video&&(delete e.video.width,delete e.video.height),e.screen&&(delete e.screen.width,delete e.screen.height));const r=Mt(),o=new MediaStream;if(e.audioSource&&o.addTrack(e.audioSource),e.videoSource&&o.addTrack(e.videoSource),!e.audio&&!e.video&&!e.screen)return I.debug("Using Video Source/ Audio Source"),o;if(e.screen)if(Yi())e.screen.sourceId?Po(o,await PU(e.screen.sourceId,e.screen,!!e.screenAudio)):Po(o,await LU(e.screen,!!e.screenAudio));else if(Cr()&&e.screen.extensionId&&e.screen.mandatory){if(!r.getStreamFromExtension)throw new oe(O.NOT_SUPPORTED,"This browser does not support screen sharing");I.debug("[".concat(t,'] Screen access on chrome stable, looking for extension"'));const f=await(a=e.screen.extensionId,c=t,new Z((m,g)=>{try{chrome.runtime.sendMessage(a,{getStream:!0},S=>{if(!S||!S.streamId)return I.error("[".concat(c,"] No response from Chrome Plugin. Plugin not installed properly"),S),void g(new oe(O.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));m(S.streamId)})}catch(S){I.error("[".concat(c,"] AgoraRTC screensharing plugin is not accessible(").concat(a,")"),S.toString()),g(new oe(O.CHROME_PLUGIN_NOT_INSTALL))}}));e.screen.mandatory.chromeMediaSourceId=f,Po(o,await navigator.mediaDevices.getUserMedia({video:{mandatory:e.screen.mandatory}}))}else if(r.getDisplayMedia){var s;e.screen.mediaSource&&Ue(e.screen.mediaSource);const f={width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate,displaySurface:(s=e.screen.displaySurface)!==null&&s!==void 0?s:e.screen.mediaSource==="screen"?"monitor":e.screen.mediaSource},{selfBrowserSurface:m,surfaceSwitching:g,systemAudio:S,preferCurrentTab:T,windowAudio:C,monitorTypeSurfaces:b}=e.screen,D={selfBrowserSurface:m,surfaceSwitching:g,systemAudio:S,preferCurrentTab:T,windowAudio:C,monitorTypeSurfaces:b};!m&&delete D.selfBrowserSurface,!g&&delete D.surfaceSwitching,!S&&delete D.systemAudio,!T&&delete D.preferCurrentTab,!C&&delete D.windowAudio,!b&&delete D.monitorTypeSurfaces,I.debug("[".concat(t,"] getDisplayMedia:"),JSON.stringify({video:f,audio:e.screenAudio,controls:D})),Po(o,await navigator.mediaDevices.getDisplayMedia(Mi({video:f,audio:e.screenAudio},D)))}else{if(!Ht())throw I.error("[".concat(t,"] This browser does not support screenSharing")),new oe(O.NOT_SUPPORTED,"This browser does not support screen sharing");{e.screen.mediaSource&&Ue(e.screen.mediaSource);const f={video:{mediaSource:e.screen.mediaSource,width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate}};I.debug("[".concat(t,"] getUserMedia: ").concat(JSON.stringify(f))),Po(o,await navigator.mediaDevices.getUserMedia(f))}}var a,c;if(!e.video&&!e.audio)return o;let d={video:e.video,audio:e.audio},l=B("MEDIA_DEVICE_CONSTRAINTS");if(l)try{typeof l=="string"&&(l=JSON.parse(l)),d=Iv(d,l)}catch{}I.debug("[".concat(t,"] GetUserMedia"),JSON.stringify(d)),ii();let h,p=null;(pn()||Dr()||wc())&&(p=await jv.lock());try{h=await navigator.mediaDevices.getUserMedia(d)}catch(f){throw p&&p(),f}return d.audio&&(JN=!0),d.video&&($s=!0),Po(o,h),p&&p(),o}function Lu(e,t){switch(e){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new oe(O.MEDIA_OPTION_INVALID,"".concat(e,": ").concat(t));case"NotFoundError":case"DevicesNotFoundError":return new oe(O.DEVICE_NOT_FOUND,"".concat(e,": ").concat(t));case"NotSupportedError":return new oe(O.NOT_SUPPORTED,"".concat(e,": ").concat(t));case"NotReadableError":return new oe(O.NOT_READABLE,"".concat(e,": ").concat(t));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new oe(O.PERMISSION_DENIED,"".concat(e,": ").concat(t));case"ConstraintNotSatisfiedError":return new oe(O.CONSTRAINT_NOT_SATISFIED,"".concat(e,": ").concat(t));default:return I.error("getUserMedia unexpected error",e),new oe(O.UNEXPECTED_ERROR,"".concat(e,": ").concat(t))}}function Po(e,t){const i=e.getVideoTracks()[0],r=e.getAudioTracks()[0],o=t.getVideoTracks()[0],s=t.getAudioTracks()[0];s&&(r&&e.removeTrack(r),e.addTrack(s)),o&&(i&&e.removeTrack(i),e.addTrack(o))}const As=new class extends Vi{get state(){return this._state}set state(e){e!==this._state&&(this.emit(tn.STATE_CHANGE,e),this._state=e)}constructor(){super(),re(this,"_state",Bd.IDLE),re(this,"isAccessMicrophonePermission",!1),re(this,"isAccessCameraPermission",!1),re(this,"lastAccessMicrophonePermission",!1),re(this,"lastAccessCameraPermission",!1),re(this,"checkdeviceMatched",!1),re(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(B("ENUMERATE_DEVICES_INTERVAL")||(yu()||eT()===pt.HARMONY_OS)&&ha())&&this.updateDevicesInfo()},B("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(e=>I.error(e.toString()))}async enumerateDevices(e,t){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)throw new oe(O.NOT_SUPPORTED,"enumerateDevices() not supported.");const r=await navigator.mediaDevices.enumerateDevices(),o=this.checkMediaDeviceInfoIsOk(r);let s=!this.isAccessMicrophonePermission&&e,a=!this.isAccessCameraPermission&&t;o.audio&&(s=!1),o.video&&(a=!1);let c=null,d=null,l=null;if(!i&&(s||a)){if(jv.isLocked&&(I.debug("[device manager] wait GUM lock"),(await jv.lock())(),I.debug("[device manager] GUM unlock")),JN&&(s=!1,this.isAccessMicrophonePermission=!0),$s&&(a=!1,this.isAccessCameraPermission=!0),I.debug("[device manager] check media device permissions",e,t,s,a),s&&a){try{l=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(h){const p=Lu(h.name||h.code||h,h.message);if(p.code===O.PERMISSION_DENIED)throw p;I.warning("getUserMedia failed in getDevices",p)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(s){try{c=await navigator.mediaDevices.getUserMedia({audio:e})}catch(h){const p=Lu(h.name||h.code||h,h.message);if(p.code===O.PERMISSION_DENIED)throw p;I.warning("getUserMedia failed in getDevices",p)}this.isAccessMicrophonePermission=!0}else if(a){try{d=await navigator.mediaDevices.getUserMedia({video:t})}catch(h){const p=Lu(h.name||h.code||h,h.message);if(p.code===O.PERMISSION_DENIED)throw p;I.warning("getUserMedia failed in getDevices",p)}this.isAccessCameraPermission=!0}I.debug("[device manager] mic permission",e,"cam permission",t)}try{const h=await navigator.mediaDevices.enumerateDevices();return c&&c.getTracks().forEach(p=>p.stop()),d&&d.getTracks().forEach(p=>p.stop()),l&&l.getTracks().forEach(p=>p.stop()),c=null,d=null,l=null,h}catch(h){return c&&c.getTracks().forEach(p=>p.stop()),d&&d.getTracks().forEach(p=>p.stop()),l&&l.getTracks().forEach(p=>p.stop()),c=null,d=null,l=null,new oe(O.ENUMERATE_DEVICES_FAILED,h.toString()).throw()}}async getRecordingDevices(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter(t=>t.kind==="audioinput")}async getCamerasDevices(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,e)).filter(t=>t.kind==="videoinput")}async getSpeakers(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter(t=>t.kind==="audiooutput")}searchDeviceIdByName(e){let t=null;return this.deviceInfoMap.forEach(i=>{i.device.label===e&&(t=i.device.deviceId)}),t}async getDeviceById(e){const t=(await this.enumerateDevices(!0,!0,!0)).find(i=>i.deviceId===e);if(!t)throw new oe(O.DEVICE_NOT_FOUND,"deviceId: ".concat(e));return t}async init(){this.state=Bd.INITING;try{await this.updateDevicesInfo(),this.state=Bd.INITEND}catch(e){throw this.state=Bd.IDLE,(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")?(I.warning("Device Detection functionality cannot start properly.",e.toString()),e):new oe(O.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.")}}async updateDevicesInfo(){const e=await this.enumerateDevices(!0,!0,!0),t=Date.now(),i=[];if(e[0]&&e[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;const o=e.find(a=>a.kind==="audioinput"&&a.deviceId==="default"),s=e.find(a=>a.kind==="audiooutput"&&a.deviceId==="default");o&&s?s.groupId===o.groupId?I.debug("[device-check] default input ".concat(o.label," and output ").concat(s.label," is the same group")):I.debug("[device-check] default input ".concat(o.label," and output ").concat(s.label," is not the same group")):I.debug("[device-check] default input or output not found")}const r=this.checkMediaDeviceInfoIsOk(e);if(e.forEach(o=>{if(!o.deviceId)return;const s=this.deviceInfoMap.get("".concat(o.kind,"_").concat(o.deviceId));if((s?s.state:"INACTIVE")!=="ACTIVE"){const a={initAt:t,updateAt:t,device:o,state:"ACTIVE"};this.deviceInfoMap.set("".concat(o.kind,"_").concat(o.deviceId),a),i.push(a)}s&&(s.updateAt=t)}),this.deviceInfoMap.forEach((o,s)=>{o.state==="ACTIVE"&&o.updateAt!==t&&(o.state="INACTIVE",i.push(o))}),this.state!==Bd.INITEND)return r.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(r.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));i.forEach(o=>{switch(o.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(tn.RECORDING_DEVICE_CHANGED,o);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(tn.CAMERA_DEVICE_CHANGED,o);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(tn.PLAYOUT_DEVICE_CHANGED,o)}}),r.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),r.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(e){const t=e.filter(o=>o.kind==="audioinput"),i=e.filter(o=>o.kind==="videoinput"),r={audio:!1,video:!1};for(const o of t)if(o.label&&o.deviceId){r.audio=!0;break}for(const o of i)if(o.label&&o.deviceId){r.video=!0;break}return r}};let Lo=!1;const Yo=new class extends Vi{constructor(){super(...arguments),re(this,"onAutoplayFailed",void 0),re(this,"onAudioAutoplayFailed",void 0)}};function QN(){if(Lo)return B("FLS_AUTOPLAY_EMITS")?(Yo.onAutoplayFailed&&Yo.onAutoplayFailed(),Yo.emit("autoplay-failed")):void 0;{const e=t=>{t.preventDefault(),Lo=!1,at()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};Lo=!0,at()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),I.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),Yo.onAutoplayFailed?Yo.onAutoplayFailed():Yo.onAudioAutoplayFailed?I.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):I.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),Yo.emit("autoplay-failed")}}function kU(e,t,i,r){if(!e)return;const o=H.getBaseInfoBySessionId(e);if(!o)return;const s=o.info,a=Date.now(),c=Mi(Mi({},s),{},{vid:s.vid===void 0?0:Number(s.vid),lts:a,elapse:a-o.startTime,cbRegistered:Yo.onAutoplayFailed||Yo.onAudioAutoplayFailed?1:-1,errorMsg:i,mediaType:t,trackId:r,extend:void 0});H.send({type:Xi.AUTOPLAY_FAILED,data:c},!0)}const ko=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],pi=new class{constructor(){re(this,"onAutoplayFailed",void 0),re(this,"elementMap",new Map),re(this,"elementStateMap",new Map),re(this,"elementsNeedToResume",[]),re(this,"sinkIdMap",new Map),re(this,"autoResumeAfterInterruption",e=>Z.all(Array.from(this.elementMap.entries()).map(async t=>{let[i,r]=t;const o=this.elementStateMap.get(i),s=r.srcObject.getAudioTracks()[0],a=s&&s.readyState;if(I.debug("resume after interrupted, ele: ".concat(o," audio: ").concat(a," ").concat(e)),a==="live"){if(e)return r.pause(),r.play();if(Ei.curState==="running")return wh()?(r.pause(),r.play()):o&&o==="paused"?r.play():void 0}}))),re(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(e=>{let[t,i]=e;const r=i.srcObject.getAudioTracks()[0];r&&r.readyState==="live"&&(I.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),i.pause(),i.play())})}),this.autoResumeAudioElement(),Ei.on(zr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Ei.on(zr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),Ei.on(zr.STATE_CHANGE,()=>{Dr()&&Ei.prevState==="suspended"&&Ei.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(e,t){const i=this.elementMap.get(e);if(this.sinkIdMap.set(e,t),i)try{await i.setSinkId(t)}catch(r){throw new oe(O.PERMISSION_DENIED,"can not set sink id: "+r.toString())}}play(e,t,i,r){if(this.elementMap.has(t))return;const o=document.createElement("audio");o.autoplay=!0,o.srcObject=new MediaStream([e]),this.bindAudioElementEvents(t,o),this.elementMap.set(t,o),this.elementStateMap.set(t,Pr.INIT),this.setVolume(t,i);const s=this.sinkIdMap.get(t);if(s)try{o.setSinkId(s).catch(c=>{I.warning("[".concat(t,"] set sink id failed"),c.toString())})}catch(c){I.warning("[".concat(t,"] set sink id failed"),c.toString())}const a=o.play();a&&a.then&&a.catch(c=>{r&&kU(r,"audio",c.message,t),I.warning("audio element play warning",c.toString()),this.elementMap.has(t)&&c.name==="NotAllowedError"&&(I.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(o),Li(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),QN()}))})}updateTrack(e,t){const i=this.elementMap.get(e);i&&(i.srcObject=new MediaStream([t]))}isPlaying(e){return this.elementMap.has(e)&&this.elementStateMap.get(e)==="playing"}setVolume(e,t){const i=this.elementMap.get(e);i&&(t=Math.max(0,Math.min(100,t)),i.volume=t/100)}getVolume(e){const t=this.elementMap.get(e);return t?t.volume:0}stop(e){const t=this.elementMap.get(e);if(this.sinkIdMap.delete(e),!t)return;const i=this.elementsNeedToResume.indexOf(t);this.elementsNeedToResume.splice(i,1),t.srcObject=null,t.remove(),this.elementMap.delete(e),this.elementStateMap.delete(e)}bindAudioElementEvents(e,t){ko.forEach(i=>{t.addEventListener(i,r=>{const o=this.elementStateMap.get(e),s=r.type==="pause"?"paused":r.type;if(I.debug("[".concat(e,"] audio-element-status change ").concat(o," => ").concat(s)),r.type==="error"){const a=t==null?void 0:t.error;a&&I.error("[".concat(e,"] media error, code: ").concat(a.code,", message: ").concat(a.message))}this.elementStateMap.set(e,s)})})}getPlayerState(e){return this.elementStateMap.get(e)||"uninit"}autoResumeAudioElement(){const e=()=>{this.elementsNeedToResume.forEach(t=>{t.play().then(i=>{I.debug("Auto resume audio element success")}).catch(i=>{I.warning("Auto resume audio element failed!",i)})}),this.elementsNeedToResume=[]};new Z(t=>{document.body?t():window.addEventListener("load",()=>t())}).then(()=>{at()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0))})}};function Tr(){return function(e,t,i){const r=i.value;return typeof r=="function"&&(i.value=function(){this._isClosed&&new oe(O.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",I);for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];const c=r.apply(this,s);return c instanceof Z?new Z((d,l)=>{c.then(d).catch(l)}):c}),i}}class ZN extends Vi{constructor(t){super(),re(this,"name","VideoProcessorDestination"),re(this,"ID","0"),re(this,"_source",void 0),re(this,"videoContext",void 0),re(this,"inputTrack",void 0),this.videoContext=t}get kind(){return"video"}get enabled(){return!0}pipe(){throw new oe(O.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new oe(O.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(t){if(t.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);t.track&&t.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=t.track,this.emit(wr.ON_TRACK,t.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(wr.ON_TRACK,void 0)}}class $N extends Vi{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,i){super(),re(this,"constraintsMap",new Map),re(this,"statsRegistry",[]),re(this,"usageRegistry",[]),re(this,"trackId",void 0),re(this,"direction",void 0),re(this,"_chained",!1),this.trackId=t,this.direction=i}async getConstraints(){return await yt(this,Ko.REQUEST_CONSTRAINTS)}async requestApplyConstraints(t,i){var r;return I.info("processor ".concat(i.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(i,t),Xt(this,Ko.REQUEST_UPDATE_CONSTRAINTS,Array.from(Vr(r=this.constraintsMap).call(r)))}async requestRevertConstraints(t){var i;if(this.constraintsMap.has(t))return I.info("processor ".concat(t.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(t),Xt(this,Ko.REQUEST_UPDATE_CONSTRAINTS,Array.from(Vr(i=this.constraintsMap).call(i)))}registerStats(t,i,r){this.statsRegistry.find(o=>o.processorID===t.ID&&o.processorName===t.name&&o.type===i)||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:i,cb:r})}unregisterStats(t,i){const r=this.statsRegistry.findIndex(o=>o.processorID===t.ID&&o.processorName===t.name&&o.type===i);r!==-1&&this.statsRegistry.splice(r,1)}gatherStats(){const t=[];for(const{processorID:i,processorName:r,type:o,cb:s}of this.statsRegistry)try{const a=s();t.push({processorID:i,processorName:r,type:o,stats:a})}catch(a){I.error(new oe(O.UNEXPECTED_ERROR,a.message))}return t}registerUsage(t,i){this.usageRegistry.find(r=>r.processorID===t.ID&&r.processorName===t.name)||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:i})}unregisterUsage(t){const i=this.usageRegistry.findIndex(r=>r.processorID===t.ID&&r.processorName===t.name);i!==-1&&this.usageRegistry.splice(i,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:i}of this.usageRegistry)try{let r=i();r instanceof Z&&(r=await r),t.push(Mi(Mi({},r),{},{direction:this.direction}))}catch(r){I.error("gather extension usage error",r)}return t}getDirection(){return this.direction}}class eD extends Vi{constructor(t){super(),re(this,"name","AudioProcessorDestination"),re(this,"ID","0"),re(this,"inputTrack",void 0),re(this,"inputNode",void 0),re(this,"audioProcessorContext",void 0),re(this,"_source",void 0),this.audioProcessorContext=t}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new oe(O.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new oe(O.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(wr.ON_TRACK,void 0),this.emit(wr.ON_NODE,void 0)}updateInput(t){if(t.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);t.track&&this.inputTrack!==t.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=t.track,this.emit(wr.ON_TRACK,this.inputTrack)),t.node&&this.inputNode!==t.node&&(this.audioProcessorContext.chained=!0,this.inputNode=t.node,this.emit(wr.ON_NODE,this.inputNode))}}class Wv extends Vi{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,i,r){super(),re(this,"constraintsMap",new Map),re(this,"statsRegistry",[]),re(this,"audioContext",void 0),re(this,"trackId",void 0),re(this,"direction",void 0),re(this,"usageRegistry",[]),re(this,"_chained",!1),this.audioContext=t,this.trackId=i,this.direction=r}async getConstraints(){return yt(this,Ko.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(t,i){var r;return I.info("processor ".concat(i.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(i,t),Xt(this,Ko.REQUEST_UPDATE_CONSTRAINTS,Array.from(Vr(r=this.constraintsMap).call(r)))}async requestRevertConstraints(t){var i;if(this.constraintsMap.has(t))return this.constraintsMap.delete(t),Xt(this,Ko.REQUEST_UPDATE_CONSTRAINTS,Array.from(Vr(i=this.constraintsMap).call(i)))}registerStats(t,i,r){this.statsRegistry.find(o=>o.processorID===t.ID&&o.processorName===t.name&&o.type===i)||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:i,cb:r})}unregisterStats(t,i){const r=this.statsRegistry.findIndex(o=>o.processorID===t.ID&&o.processorName===t.name&&o.type===i);r!==-1&&this.statsRegistry.splice(r,1)}gatherStats(){const t=[];for(const{processorID:i,processorName:r,type:o,cb:s}of this.statsRegistry)try{const a=s();t.push({processorID:i,processorName:r,type:o,stats:a})}catch(a){I.error(new oe(O.UNEXPECTED_ERROR,a.message))}return t}registerUsage(t,i){this.usageRegistry.find(r=>r.processorID===t.ID&&r.processorName===t.name)||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:i})}unregisterUsage(t){const i=this.usageRegistry.findIndex(r=>r.processorID===t.ID&&r.processorName===t.name);i!==-1&&this.usageRegistry.splice(i,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:i}of this.usageRegistry)try{let r=i();r instanceof Z&&(r=await r),t.push(Mi(Mi({},r),{},{direction:this.direction}))}catch(r){I.error("gather extension usage error",r)}return t}getDirection(){return this.direction}}class tD extends Vi{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),re(this,"context",void 0),re(this,"processSourceNode",void 0),re(this,"outputTrack",void 0),re(this,"processedNode",void 0),re(this,"clonedTrack",void 0),re(this,"outputNode",void 0),this.outputNode=new MU}setVolume(){}createOutputTrack(){throw new oe(O.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class MU{disconnect(){}connect(){}}function lT(e){return new Z((t,i)=>{let r=!1;const o=document.createElement("video");o.setAttribute("autoplay",""),o.setAttribute("muted",""),o.muted=!0,o.autoplay=!0,o.setAttribute("playsinline",""),o.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(o);const s=Dr()?"canplay":"playing";o.addEventListener(s,()=>{const a=o.videoWidth,c=o.videoHeight;!a&&Ht()||(r=!0,o.srcObject=null,o.remove(),t([a,c]))}),o.srcObject=new MediaStream([e]),o.play().catch(Pf),setTimeout(()=>{r||(o.srcObject=null,o.remove(),t([o.videoWidth,o.videoHeight]))},4e3)})}function uT(e){const t={};e.facingMode&&(t.facingMode=e.facingMode),e.cameraId&&(t.deviceId={exact:e.cameraId});const i=Ta(e.encoderConfig);return i.width!=null&&(t.width=i.width),i.height!=null&&(t.height=i.height),!NN()&&i.frameRate&&(t.frameRate=i.frameRate),ji()&&typeof t.frameRate=="object"&&(t.frameRate.max=60),Ht()&&(t.frameRate={ideal:30,max:30}),t}function iD(e){const t={};return NN()||(e.AGC!==void 0&&(t.autoGainControl=e.AGC),e.AEC!==void 0&&(t.echoCancellation=e.AEC),e.ANS!==void 0&&(t.noiseSuppression=e.ANS,Cr()&&e.ANS&&(t.googHighpassFilter=e.ANS))),t}function rD(e){const t=iD(e);if(e.encoderConfig){const i=Cl(e.encoderConfig);t.channelCount=i.stereo?2:1,t.sampleRate=i.sampleRate,t.sampleSize=i.sampleSize}return e.microphoneId&&(t.deviceId={exact:e.microphoneId}),yu()&&(t.sampleRate=void 0),t}const nD=e=>{const t=e._encoderConfig;if(!t)return;const{frameRate:i,width:r,height:o}=e.getMediaStreamTrackSettings();let{frameRate:s=i,width:a=r,height:c=o}=t;if(!s||!a||!c)return;a=Dh(a),c=Dh(c),s=Dh(s);const{max:d,min:l}=function(m,g,S){const T=200*Math.pow(S/15,.6)*Math.pow(m*g/640/360,.75);return{min:Math.floor(T),max:Math.floor(4*T)}}(a,c,s),{bitrateMax:h,bitrateMin:p}=t||{};h||I.debug("calculate bitrate: [w: ".concat(a,", h: ").concat(c,", fps: ").concat(s,"] => [brMax: ").concat(h,", brMin: ").concat(p,"]"));const{maxFramerate:f}=B("ENCODER_CONFIG_LIMIT");return f&&typeof f=="number"&&(s=Math.min(s,f)),{frameRate:s,bitrateMax:h||d,bitrateMin:p||l,scaleResolutionDownBy:1,scale:0}},Hv=async(e,t,i)=>await(async(r,o,s)=>{const a=function(l){const h=[];for(let p=0;p<l.length;p+=2)h.push(parseInt(l.slice(p,p+2),16));return Uint8Array.from(h)}(RU(""+o+s)).slice(0,16),c=a.slice(0,12),d=await window.crypto.subtle.importKey("raw",a,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:c},d,r))})(e.buffer,t,i),Kv=e=>{const t=document.createElement("canvas");return t.width=2,t.height=2,new Z((i,r)=>{t.toBlob(async o=>{if(t.remove(),o){const s=await oD(o);i({buffer:s,width:t.width,height:t.height})}else r(new oe(O.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},e,1)})},oD=async e=>{const t=await e.arrayBuffer();return new Uint8Array(t)};var sD,aD,cD,dD,lD,uD,hD,pD,_D,fD,mD,ED,gD,SD,TD,RD,vD,nr,or,CD,yD,ID,AD,wD,jd,Gd,bD,OD,ND,DD,PD,LD,kD,MD,UD,xD,VD,FD,Gn,ri;let Zi=(sD=_e({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),aD=_e({argsMap:(e,t)=>[e.getTrackId(),t]}),cD=Tr(),dD=mr("LocalAudioTrack","_enabledMutex"),lD=_e({argsMap:(e,t)=>[e.getTrackId(),t]}),uD=Tr(),hD=mr("LocalAudioTrack","_enabledMutex"),pD=_e({argsMap:(e,t)=>[e.getTrackId(),t]}),_D=Tr(),fD=Tr(),mD=Tr(),ED=_e({argsMap:e=>[e.getTrackId()]}),gD=Tr(),SD=_e({argsMap:e=>[e.getTrackId()]}),TD=Tr(),RD=_e({argsMap:e=>[e.getTrackId()]}),vD=_e({argsMap:(e,t)=>[e.getTrackId(),t.name]}),nr=_e({argsMap:e=>[e.getTrackId()]}),X((or=class extends N_{get _source(){return this.initWebAudio()}set _source(e){this._trackSource=e}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?pi.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(e,t,i,r){super(e,i),re(this,"trackMediaType",No.AUDIO),re(this,"_encoderConfig",void 0),re(this,"_trackSource",void 0),re(this,"metadata",[]),re(this,"_enabled",!0),re(this,"_volume",100),re(this,"_useAudioElement",!0),re(this,"_bypassWebAudio",!1),re(this,"processor",void 0),re(this,"_processorContext",void 0),re(this,"_processorDestination",void 0),re(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=t,this._getOriginVolumeLevel=!!r,this._trackSource=new tD,B("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),B("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),pn()&&!Yt?setTimeout(()=>this.initWebAudio()):this.initWebAudio()}setVolume(e){Ai(e,"volume",0,1e3),this._volume=e,this._source.setVolume(e/100),this._useAudioElement&&pi.setVolume(this.getTrackId(),e);try{if(this._bypassWebAudio)return void I.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const t=this._source.createOutputTrack();this._mediaStreamTrack!==t&&(this._mediaStreamTrack=t,Xt(this,Re.NEED_REPLACE_TRACK,this).then(()=>{I.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(i=>{I.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),i)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(e){if(!this._useAudioElement||!aT())throw new oe(O.NOT_SUPPORTED,"your browser does not support setting the audio output device");await pi.setSinkID(this.getTrackId(),e)}async setEnabled(e,t,i){return this._setEnabled(e,t,i)}async _setEnabled(e,t,i){if(!i){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(I.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){this._originMediaStreamTrack.enabled=!0;try{i||(this._enabled=!0),await Xt(this,Re.NEED_ENABLE_TRACK,this),I.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(e," success"))}catch(r){throw i||(this._enabled=!1),I.error("[".concat(this.getTrackId(),"] setEnabled to true error"),r.toString()),r}}else{this._originMediaStreamTrack.enabled=!1,i||(this._enabled=!1);try{await Xt(this,Re.NEED_DISABLE_TRACK,this)}catch(r){throw i||(this._enabled=!0),I.error("[".concat(this.getTrackId(),"] setEnabled to false error"),r.toString()),r}}}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,I.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await Xt(this,Re.NEED_MUTE_TRACK,this):await Xt(this,Re.NEED_UNMUTE_TRACK,this))}getStats(){return pa(()=>{I.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),co(this,Re.GET_STATS)||Mi({},cT)}setAudioFrameCallback(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(ys.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(ys.ON_AUDIO_BUFFER),this._source.on(ys.ON_AUDIO_BUFFER,i=>e(i))}play(){I.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(I.debug("[".concat(this.getTrackId(),"] start audio playback in element")),pi.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){I.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?pi.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];I.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&pi.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(e,t){this._originMediaStreamTrack!==e&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:e,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Xt(this,Re.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(e))}renewMediaStreamTrack(e){return Z.resolve(void 0)}pipe(e){if(this._bypassWebAudio)throw new oe(O.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===e)return e;if(e._source)throw new oe(O.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(!this.processor)return;const t=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(e){e.on(wr.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t),await Xt(this,Re.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Xt(this,Re.NEED_REPLACE_TRACK,this))}),e.on(wr.ON_NODE,t=>{this._source.processedNode=t})}unbindProcessorDestinationEvents(e){e.removeAllListeners(wr.ON_TRACK),e.removeAllListeners(wr.ON_NODE)}bindProcessorContextEvents(e){e.on(Ko.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}unbindProcessorContextEvents(e){e.removeAllListeners(Ko.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof tD&&(this._trackSource=new Fv(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const e=new Wv(this._source.context,this.getTrackId(),"local"),t=new eD(e);return this._processorContext=e,this._processorDestination=t,this.bindProcessorContextEvents(e),this.bindProcessorDestinationEvents(t),this._source.on(ys.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:e})}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(pi.stop(this.getTrackId()),this._source.play()),Xt(this,Re.NEED_REPLACE_MIXING_TRACK,this).then(()=>{I.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))}).catch(i=>{I.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),i)})),{processorContext:e,processorDestination:t}}}).prototype,"setVolume",[sD],Object.getOwnPropertyDescriptor(or.prototype,"setVolume"),or.prototype),X(or.prototype,"setPlaybackDevice",[aD,cD],Object.getOwnPropertyDescriptor(or.prototype,"setPlaybackDevice"),or.prototype),X(or.prototype,"setEnabled",[dD,lD,uD],Object.getOwnPropertyDescriptor(or.prototype,"setEnabled"),or.prototype),X(or.prototype,"setMuted",[hD,pD,_D],Object.getOwnPropertyDescriptor(or.prototype,"setMuted"),or.prototype),X(or.prototype,"getStats",[fD],Object.getOwnPropertyDescriptor(or.prototype,"getStats"),or.prototype),X(or.prototype,"setAudioFrameCallback",[mD],Object.getOwnPropertyDescriptor(or.prototype,"setAudioFrameCallback"),or.prototype),X(or.prototype,"play",[ED,gD],Object.getOwnPropertyDescriptor(or.prototype,"play"),or.prototype),X(or.prototype,"stop",[SD,TD],Object.getOwnPropertyDescriptor(or.prototype,"stop"),or.prototype),X(or.prototype,"close",[RD],Object.getOwnPropertyDescriptor(or.prototype,"close"),or.prototype),X(or.prototype,"pipe",[vD],Object.getOwnPropertyDescriptor(or.prototype,"pipe"),or.prototype),X(or.prototype,"unpipe",[nr],Object.getOwnPropertyDescriptor(or.prototype,"unpipe"),or.prototype),or),hT=(CD=_e({argsMap:(e,t)=>[e.getTrackId(),t]}),yD=Tr(),ID=mr("MicrophoneAudioTrack","_enabledMutex"),AD=_e({argsMap:(e,t,i)=>[e.getTrackId(),t,i]}),wD=Tr(),jd=_e({argsMap:e=>[e.getTrackId()]}),X((Gd=class extends Zi{get __className__(){return"MicrophoneAudioTrack"}constructor(e,t,i,r){super(e,t.encoderConfig?Cl(t.encoderConfig):{},r,B("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),re(this,"_config",void 0),re(this,"_deviceName","default"),re(this,"_constraints",void 0),re(this,"_originalConstraints",void 0),re(this,"_enabled",!0),this._config=t,this._constraints=i,this._originalConstraints=i,this._deviceName=e.label,typeof t.bypassWebAudio=="boolean"&&(this._bypassWebAudio=t.bypassWebAudio),(wh()||Ev())&&Ei.bindInterruptDetectorTrack(this)}async setDevice(e){if(I.info("[".concat(this.getTrackId(),"] start set device to ").concat(e)),this._enabled)try{const t=await As.getDeviceById(e),i={};i.audio=Mi({},this._constraints),i.audio.deviceId={exact:e},this._originMediaStreamTrack.stop();let r=null;try{r=await Ra(i,this.getTrackId())}catch(o){throw I.error("[".concat(this.getTrackId(),"] setDevice failed"),o.toString()),r=await Ra({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!1),o}await this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!1),this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(t){throw I.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}else try{const t=await As.getDeviceById(e);this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(t){throw I.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}I.info("[".concat(this.getTrackId(),"] set device to ").concat(e," success"))}async setEnabled(e,t,i){if(t)return I.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(e);if(!i){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(I.info("[".concat(this.getTrackId(),"] start setEnabled"),e),B("AUTO_RESET_AUDIO_ROUTE")&&(Dr()||rc())){const a=navigator.audioSession;a&&(e||(a.type="playback"),a.type="auto")}if(!e){var r;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(r=this._source.clonedTrack)===null||r===void 0||r.stop(),i||(this._enabled=!1);try{await Xt(this,Re.NEED_DISABLE_TRACK,this)}catch(a){throw I.error("[".concat(this.getTrackId(),"] setEnabled false failed"),a.toString()),a}return}const o=Mi({},this._constraints),s=As.searchDeviceIdByName(this._deviceName);s&&!o.deviceId&&(o.deviceId=s);try{i||(this._enabled=!0);const a=await Ra({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(a.getAudioTracks()[0],!1),await Xt(this,Re.NEED_ENABLE_TRACK,this)}catch(a){throw i||(this._enabled=!1),I.error("[".concat(this.getTrackId(),"] setEnabled true failed"),a.toString()),a}I.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(wh()||Ev())&&Ei.unbindInterruptDetectorTrack(this),Mh.some(e=>function(t){return"__className__"in t&&t.__className__==="MicrophoneAudioTrack"}(e))||Is&&Is()&&(H.reportApiInvoke(null,{name:"BG_AUDIO_TAG_RESTART",options:{},tag:bi.TRACER}).onSuccess(),I.debug("restart background audio tag success"))}onTrackEnded(){if((Dr()||rc())&&this._enabled&&!this._isClosed&&Ei.duringInterruption){const e=async()=>{Ei.off(zr.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(I.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Ei.on(zr.IOS_INTERRUPTION_END,e)}else I.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Wo.TRACK_ENDED)}async renewMediaStreamTrack(e){const t=e||this._constraints,i=As.searchDeviceIdByName(this._deviceName);if(i&&!t.deviceId&&(t.deviceId=i),this._constraints=t,this._enabled){this._originMediaStreamTrack.stop();const r=await Ra({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!0)}}bindProcessorContextEvents(e){super.bindProcessorContextEvents(e),e.on(Ko.REQUEST_UPDATE_CONSTRAINTS,async(t,i,r)=>{try{const o=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(o),i()}catch(o){r(o)}})}unbindProcessorContextEvents(e){super.unbindProcessorContextEvents(e),e.removeAllListeners(Ko.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[CD,yD],Object.getOwnPropertyDescriptor(Gd.prototype,"setDevice"),Gd.prototype),X(Gd.prototype,"setEnabled",[ID,AD,wD],Object.getOwnPropertyDescriptor(Gd.prototype,"setEnabled"),Gd.prototype),X(Gd.prototype,"close",[jd],Object.getOwnPropertyDescriptor(Gd.prototype,"close"),Gd.prototype),Gd),rn=(bD=_e({argsMap:(e,t)=>[e.getTrackId(),t,e.duration]}),OD=Tr(),ND=_e({argsMap:e=>[e.getTrackId()]}),DD=Tr(),PD=_e({argsMap:e=>[e.getTrackId()]}),LD=Tr(),kD=_e({argsMap:e=>[e.getTrackId()]}),MD=Tr(),UD=_e({argsMap:e=>[e.getTrackId()]}),xD=Tr(),VD=_e({argsMap:e=>[e.getTrackId()]}),FD=_e({argsMap:e=>[e.getTrackId()]}),Gn=Tr(),X((ri=class extends Zi{get __className__(){return"BufferSourceAudioTrack"}constructor(e,t,i,r){super(t.createOutputTrack(),i,r),re(this,"source",void 0),re(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=e,this._bufferSource=t,this._bufferSource.on(ys.AUDIO_SOURCE_STATE_CHANGE,o=>{this.safeEmit(Wo.SOURCE_STATE_CHANGE,o)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(e){e&&this._bufferSource.updateOptions(e),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(e){this._bufferSource.seekAudioBuffer(e)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(e){Ai(e,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(e)}}).prototype,"startProcessAudioBuffer",[bD,OD],Object.getOwnPropertyDescriptor(ri.prototype,"startProcessAudioBuffer"),ri.prototype),X(ri.prototype,"pauseProcessAudioBuffer",[ND,DD],Object.getOwnPropertyDescriptor(ri.prototype,"pauseProcessAudioBuffer"),ri.prototype),X(ri.prototype,"seekAudioBuffer",[PD,LD],Object.getOwnPropertyDescriptor(ri.prototype,"seekAudioBuffer"),ri.prototype),X(ri.prototype,"resumeProcessAudioBuffer",[kD,MD],Object.getOwnPropertyDescriptor(ri.prototype,"resumeProcessAudioBuffer"),ri.prototype),X(ri.prototype,"stopProcessAudioBuffer",[UD,xD],Object.getOwnPropertyDescriptor(ri.prototype,"stopProcessAudioBuffer"),ri.prototype),X(ri.prototype,"close",[VD],Object.getOwnPropertyDescriptor(ri.prototype,"close"),ri.prototype),X(ri.prototype,"setAudioBufferPlaybackSpeed",[FD,Gn],Object.getOwnPropertyDescriptor(ri.prototype,"setAudioBufferPlaybackSpeed"),ri.prototype),ri);class nn extends Zi{get __className__(){return"MixingAudioTrack"}get isActive(){for(const t of this.trackList)if(t._enabled&&!t._isClosed&&!t.muted)return!0;return!1}constructor(){const t=Pc().createMediaStreamDestination();super(t.stream.getAudioTracks()[0],void 0,li(8,"track-mix-")),re(this,"trackList",void 0),re(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=t,this.trackList=[]}hasAudioTrack(t){return this.trackList.indexOf(t)!==-1}addAudioTrack(t){this.trackList.indexOf(t)===-1?(I.debug("add ".concat(t.getTrackId()," to mixing track")),t._source.outputNode.connect(this.destNode),this.trackList.push(t),this.updateEncoderConfig()):I.debug("track ".concat(t.getTrackId()," is already added"))}removeAudioTrack(t){if(this.trackList.indexOf(t)!==-1){I.debug("remove ".concat(t.getTrackId()," from mixing track"));try{t._source.outputNode.disconnect(this.destNode)}catch{}Iu(this.trackList,t),this.updateEncoderConfig()}}updateEncoderConfig(){const t={};this.trackList.forEach(i=>{i._encoderConfig&&((i._encoderConfig.bitrate||0)>(t.bitrate||0)&&(t.bitrate=i._encoderConfig.bitrate),(i._encoderConfig.sampleRate||0)>(t.sampleRate||0)&&(t.sampleRate=i._encoderConfig.sampleRate),(i._encoderConfig.sampleSize||0)>(t.sampleSize||0)&&(t.sampleSize=i._encoderConfig.sampleSize),i._encoderConfig.stereo&&(t.stereo=!0))}),this._encoderConfig=t}_updateRtpTransceiver(t){this._rtpTransceiver!==t&&(this._rtpTransceiver=t,this.trackList.forEach(i=>{i instanceof nn?i.emit(Nc.TRANSCEIVER_UPDATED,t):i._updateRtpTransceiver(t)}))}}class UU extends Vv{set currentState(t){t!==this._currentState&&(this._currentState=t,this.safeEmit(ys.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),re(this,"audioBuffer",void 0),re(this,"sourceNode",void 0),re(this,"startPlayTime",0),re(this,"startPlayOffset",0),re(this,"pausePlayTime",0),re(this,"options",void 0),re(this,"currentLoopCount",0),re(this,"currentPlaybackSpeed",100),re(this,"_currentState","stopped"),this.audioBuffer=t,this.options=i,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(t){this.currentState==="stopped"?(this.options=t,this.startPlayOffset=this.options.startPlayTime||0):I.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(t){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=t,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=t))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(t){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=t/100),this.currentPlaybackSpeed=t}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const t=this.context.createBufferSource();return t.buffer=this.audioBuffer,t.loop=!!this.options.loop,t.connect(this.outputNode),t.playbackRate.value=this.currentPlaybackSpeed/100,t}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const BD=new Map;function Yv(e,t){if(e.length===0||t.length===0)return 1/0;const i=Av(e),r=Av(t);return Math.floor(r/i)}class zv{get rendFrameRate(){const t=Math.max(1,Yv(this._render_interframe_delays_sizes,this._render_interframe_delays));return Math.floor(1e3/t)}get videoElementStatus(){return this._isInPage?this._videoElementStatus:Pr.DESTROYED}set videoElementStatus(t){t!==this._videoElementStatus&&(I.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(t)),this._videoElementStatus=t)}get videoState(){return this._videoState}set videoState(t){var i;t!==this._videoState&&(this._videoState=t,(i=this.onVideoStateChanged)===null||i===void 0||i.call(this,this.videoState))}constructor(t){re(this,"trackId",void 0),re(this,"config",void 0),re(this,"onFirstVideoFrameDecoded",void 0),re(this,"onFirstVideoFrameRender",void 0),re(this,"onVideoBufferReady",void 0),re(this,"onVideoStateChanged",void 0),re(this,"freezeTimeCounterList",[]),re(this,"renderFreezeAccTime",0),re(this,"renderFreezeAccTime2",0),re(this,"isKeepLastFrame",!1),re(this,"isDestroyed",!1),re(this,"timeUpdatedCount",0),re(this,"freezeTime",0),re(this,"playbackTime",0),re(this,"lastTimeUpdatedTime",0),re(this,"autoplayFailed",!1),re(this,"videoTrack",void 0),re(this,"videoElement",void 0),re(this,"cacheVideoElement",void 0),re(this,"cancelRVFId",void 0),re(this,"internal",!1),re(this,"_render_interframe_delays",[]),re(this,"_render_interframe_delays_sizes",[]),re(this,"_videoState",Dc.VideoStateStopped),re(this,"videoElementCheckInterval",void 0),re(this,"videoElementFreezeTimeout",void 0),re(this,"_videoElementStatus",Pr.NONE),re(this,"_isInPage",!0),re(this,"isGettingVideoDimensions",!1),re(this,"startGetVideoDimensions",()=>{const i=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return I.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(i,500)};!this.isGettingVideoDimensions&&i()}),re(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&Ei.curState==="running"&&(I.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(tT())),ic()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),re(this,"handleVideoEvents",i=>{switch(i.type){case"play":case"playing":i.type==="play"&&I.debug("[".concat(this.trackId,"] video element status: play")),this.startGetVideoDimensions(),this.videoElementStatus=Pr.PLAYING;break;case"loadeddata":if(this.videoState=Dc.VideoStateStarting,this.onFirstVideoFrameRender&&this.onFirstVideoFrameRender(),this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=Pr.CANPLAY;break;case"stalled":this.videoElementStatus=Pr.STALLED;break;case"suspend":this.videoElementStatus=Pr.SUSPEND;break;case"pause":this.videoElementStatus=Pr.PAUSED,Dr()||rc()||pn()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(I.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=Pr.WAITING;break;case"abort":this.videoElementStatus=Pr.ABORT;break;case"ended":this.videoElementStatus=Pr.ENDED;break;case"emptied":this.videoElementStatus=Pr.EMPTIED;break;case"error":{const r=this.videoElement.error;r&&(this.videoElementStatus=Pr.ERROR,I.error("[".concat(this.trackId,"] media error: ").concat(r.message," (").concat(r.code,")")));break}case"timeupdate":{const r=performance.now();if(this.timeUpdatedCount+=1,this.onVideoBufferReady&&this.timeUpdatedCount>B("BUFFER_READY_FRAMES")&&this.onVideoBufferReady(),this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=r);const o=r-this.lastTimeUpdatedTime,s=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=r,ws.lastVisibleTime<ws.lastHiddenTime||s<ws.lastHiddenTime||s<ws.lastVisibleTime||this.isSkipCalcRenderFreezeTime())return;for(o>B("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=o),this.playbackTime+=o;this.playbackTime>=6e3;){this.playbackTime-=6e3;const a=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(a),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),re(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(I.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(tT())),ic()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=t.trackId,this.config=t,t.element instanceof HTMLVideoElement?this.videoElement=t.element:this.videoElement=document.createElement("video"),Ei.on(zr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Ei.on(zr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var t;return(t=this.videoElement.parentElement)!==null&&t!==void 0?t:void 0}updateConfig(t){this.config=t,this.trackId=t.trackId,t.element!==this.videoElement&&(this.destroy(),this.videoElement=t.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.initVideoElement())}play(t){const i=this.videoElement.play();i&&i.catch&&i.catch(o=>{t&&kU(t,"video",o.message,this.trackId),o.name==="NotAllowedError"?(I.warning("detected video element autoplay failed",o),this.autoplayFailed=!0,this.handleAutoPlayFailed()):I.warning("[".concat(this.trackId,"] play warning: "),o)});const r=ii();if((r.name==="Safari"&&Number(r.version)===15||wh())&&i&&i.then){const o=()=>{this.config.mirror&&!this.config.noStyle&&(this.videoElement.style.transform="rotateY(180deg)")};i.then(o).catch(o)}}getCurrentFrame(){const t=document.createElement("canvas");t.width=this.videoElement.videoWidth,t.height=this.videoElement.videoHeight;const i=t.getContext("2d");if(!i)return I.error("create canvas context failed!"),new ImageData(2,2);i.drawImage(this.videoElement,0,0,t.width,t.height);const r=i.getImageData(0,0,t.width,t.height);return t.remove(),r}async getCurrentFrameToUint8Array(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const r=document.createElement("canvas");r.width=this.videoElement.videoWidth,r.height=this.videoElement.videoHeight;const o=r.getContext("2d");return o?(o.drawImage(this.videoElement,0,0,r.width,r.height),new Z((s,a)=>{r.toBlob(async c=>{if(r.remove(),c){const d=await oD(c);s({buffer:d,width:r.width,height:r.height})}else a(new oe(O.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},t,i<0?.1:i>1?1:i)})):await Kv(t)}destroy(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];this.isDestroyed=!0,Ei.off(zr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Ei.off(zr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),t?this.videoElement.pause():this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=Dc.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=Pr.INIT,!this.videoElementCheckInterval&&(pT.forEach(s=>{this.videoElement.addEventListener(s,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{this._isInPage=function(s){return s!==document.body&&document.body.contains(s)}(this.videoElement)},1e3),B("ENABLE_VIDEO_FRAME_CALLBACK"))){var t,i;let s;const a=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",a),this.videoElementFreezeTimeout=window.setTimeout(c,B("VIDEO_FREEZE_DURATION")))},c=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===Dc.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=Dc.VideoStateFrozen:document.addEventListener("visibilitychange",a))},d=(l,h)=>{if(this.videoElementStatus===Pr.PLAYING){if(s){const m=h.presentationTime-s.presentationTime,g=h.presentedFrames-s.presentedFrames;this._render_interframe_delays_sizes.push(g),this._render_interframe_delays.push(m);const S=Av(this._render_interframe_delays_sizes),T=S-this._render_interframe_delays_sizes[0];if(S>30&&T>5&&(this._render_interframe_delays_sizes.shift(),this._render_interframe_delays.shift()),this.videoState===Dc.VideoStateStarting&&(this.videoState=Dc.VideoStateDecoding),this.videoState===Dc.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(c,B("VIDEO_FREEZE_DURATION"))),m<B("VIDEO_FREEZE_DURATION")&&this.videoState===Dc.VideoStateFrozen&&(this.videoState=Dc.VideoStateDecoding),m>B("VIDEO_FREEZE_DURATION")&&ws.lastVisibleTime>=ws.lastHiddenTime&&s.timestamp>ws.lastVisibleTime&&s.timestamp>ws.lastHiddenTime){const C=Math.min(66,Yv(this._render_interframe_delays_sizes,this._render_interframe_delays)),b=Math.max(0,m-(g-1)*C);this.renderFreezeAccTime2+=b>C?b:0,this.renderFreezeAccTime+=m}}s=Mi(Mi({},h),{},{timestamp:l})}else this.isSkipCalcRenderFreezeTime()&&(s=Mi(Mi({},h),{},{timestamp:l}));var p,f;B("ENABLE_VIDEO_FRAME_CALLBACK")&&(this.cancelRVFId=(p=(f=this.videoElement).requestVideoFrameCallback)===null||p===void 0?void 0:p.call(f,d))};this.cancelRVFId=(t=(i=this.videoElement).requestVideoFrameCallback)===null||t===void 0?void 0:t.call(i,d)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),yu()&&!B("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");const r=ii();this.config.noStyle||(r.name==="Safari"&&Number(r.version)===15||wh()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover"),this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Ht()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Ht()&&this.videoElement.load());const o=this.videoElement.play();o!==void 0&&o.catch(s=>{I.debug("[".concat(this.trackId,"] playback interrupted"),s.toString())})}resetVideoElement(){var t,i;pT.forEach(r=>{this.videoElement&&this.videoElement.removeEventListener(r,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.cancelRVFId&&this.videoElement&&((t=(i=this.videoElement).cancelVideoFrameCallback)===null||t===void 0||t.call(i,this.cancelRVFId),this.cancelRVFId=void 0),this.videoElementStatus=Pr.NONE}isSkipCalcRenderFreezeTime(){return this.videoElementStatus===Pr.DESTROYED||this.internal}handleAutoPlayFailed(){const t=i=>{i.preventDefault(),this.videoElement.play().then(()=>{I.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(r=>{I.error(r)}),this.autoplayFailed=!1,at()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};at()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),QN()}}const pT=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class _T extends zv{constructor(t){let i=arguments.length>1&&arguments[1]!==void 0&&arguments[1];super(t),re(this,"container",void 0),re(this,"slot",void 0),this.slot=t.element,this.internal=i,this.updateConfig(t)}updateConfig(t){this.config=t,this.trackId=t.trackId;const i=t.element;var r;!this.internal||this.slot?(i!==this.slot&&(this.destroy(),this.slot=i),this.createElements()):(this.slot=i,i&&this.container?(this.internal=!1,this.container.id="agora-video-player-".concat(this.trackId),this.videoElement.id="video_".concat(this.trackId),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",(r=this.slot)===null||r===void 0||r.appendChild(this.container)):this.createElements())}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.createElements())}play(t){var i;(i=this.container)!==null&&i!==void 0&&i.contains(this.videoElement)&&super.play(t)}getCurrentFrame(){var t;return(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(t){var i;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(i=this.container)!==null&&i!==void 0&&i.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(t,r):await Kv(t)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{var t;this.container.remove(),(t=this.slot)===null||t===void 0||t.removeChild(this.container)}catch{}this.container=void 0}}createElements(){var t;this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",B("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),(t=this.slot)===null||t===void 0||t.appendChild(this.container)}mountedVideoElement(){var t;!this.container||(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var t;if((t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var t;(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var jD,GD,WD,HD,KD,YD,zD,qD,XD,JD,QD,ZD,$D,eP,tP,iP,rP,nP,oP,sP,aP,cP,dP,lP,uP,hP,pP,Ut,xt,_P,fP,mP,EP,gP,SP,TP,ea,Jt;let yi=(jD=_e({argsMap:(e,t,i)=>[e.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),GD=Tr(),WD=_e({argsMap:e=>[e.getTrackId()]}),HD=mr("LocalVideoTrack","_enabledMutex"),KD=_e({argsMap:(e,t)=>[e.getTrackId(),t]}),YD=Tr(),zD=mr("LocalVideoTrack","_enabledMutex"),qD=_e({argsMap:(e,t)=>[e.getTrackId(),t]}),XD=Tr(),JD=_e({argsMap:(e,t)=>[e.getTrackId(),t,e._saveEncodeBitrateRatio]}),QD=Tr(),ZD=_e({argsMap:(e,t)=>[e.getTrackId(),t]}),$D=Tr(),eP=Tr(),tP=_e({argsMap:(e,t,i)=>[e.getTrackId(),t,i]}),iP=Tr(),rP=Tr(),nP=Tr(),oP=_e({argsMap:e=>[e.getTrackId()]}),sP=Tr(),aP=Tr(),cP=Tr(),dP=Tr(),lP=Tr(),uP=_e({argsMap:(e,t)=>[e.getTrackId(),t.name]}),hP=_e({argsMap:e=>[e.getTrackId()]}),pP=_e({argsMap:e=>[e.getTrackId()]}),Ut=_e({argsMap:(e,t,i)=>[e.getTrackId(),t.label,i]}),xt=class SZ extends N_{get videoHeight(){if(pn()){const{height:t}=this._mediaStreamTrack.getSettings();return this._videoHeight=t,this._videoHeight}return this._videoHeight}get videoWidth(){if(pn()){const{width:t}=this._mediaStreamTrack.getSettings();return this._videoWidth=t,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Pr.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get __className__(){return"LocalVideoTrack"}constructor(t,i,r,o,s,a){if(super(t,s),re(this,"trackMediaType",No.VIDEO),re(this,"_player",void 0),re(this,"isUseScaleResolutionDownBy",!1),re(this,"_videoVisibleTimer",null),re(this,"_previousVideoVisibleStatus",void 0),re(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),re(this,"_encoderConfig",void 0),re(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),re(this,"_optimizationMode",void 0),re(this,"_saveEncodeBitrateRatio",1),re(this,"_videoHeight",void 0),re(this,"_videoWidth",void 0),re(this,"_forceBitrateLimit",void 0),re(this,"_enabled",!0),re(this,"_processorDestination",void 0),re(this,"_processorContext",void 0),pn()){const{width:c,height:d}=t.getSettings();this._videoWidth=c,this._videoHeight=d}else this.updateMediaStreamTrackResolution();if(this._scalabilityMode=r,this._optimizationMode=o,this._hints=a||[],i&&this._hints.indexOf(ui.CUSTOM_TRACK)!==-1?this._encoderConfig=wi(i):this._encoderConfig=i,this._hints.indexOf(ui.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(Tl(di.CHROME,115)&&eT().indexOf("Windows")!==-1){const c=function(d,l){if("VideoFrame"in window&&"TransformStream"in window&&Mt().supportWebRTCInsertableStream){const h=new MediaStreamTrackProcessor(d),p=new MediaStreamTrackGenerator({kind:"video"});let f,m,g=Date.now();const S=()=>{T&&(clearInterval(T),T=void 0),f&&(f.close(),f=void 0),d.stop(),m=void 0,p.removeEventListener("ended",S)};let T=window.setInterval(()=>{if(m&&f&&Date.now()-g>1e3)try{p.readyState==="live"?m.enqueue(f.clone()):S()}catch{S()}},1e3);const C=new TransformStream({transform:(b,D)=>{p.readyState==="live"?(m=D,g=Date.now(),f===void 0?(f=b,D.enqueue(b.clone())):(D.enqueue(f),f=b)):b.close()}});return p.addEventListener("ended",S),h.readable.pipeThrough(C).pipeTo(p.writable),p}}(t);c&&(I.info("local screen video track begin to inject frame"),this._mediaStreamTrack=c)}i&&this._hints.indexOf(ui.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(i),this._processorContext=new $N(this.getTrackId(),"local"),this._processorDestination=new ZN(this.processorContext),this.bindProcessorDestinationEvents()}play(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){const o=document.getElementById(t);o?t=o:(I.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}I.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(i));const r=Mi(Mi(Mi({},this._getDefaultPlayerConfig()),i),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(r):(t instanceof HTMLVideoElement?this._player=new zv(r):this._player=new _T(r),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const o=this.getVideoElementVisibleStatus();this.safeEmit(Wo.VIDEO_ELEMENT_VISIBLE_STATUS,o)}catch{}},B("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,I.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(t,i){if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(I.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){this._originMediaStreamTrack.enabled=!1;try{await Xt(this,Re.NEED_DISABLE_TRACK,this)}catch(r){throw I.error("[".concat(this.getTrackId(),"] setEnabled to false error"),r.toString()),r}return i||(this._enabled=!1),void I.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await Xt(this,Re.NEED_ENABLE_TRACK,this)}catch(r){throw I.error("[".concat(this.getTrackId(),"] setEnabled to true error"),r.toString()),r}I.info("[".concat(this.getTrackId(),"] setEnabled to true success")),i||(this._enabled=!0)}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,I.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await Xt(this,Re.NEED_MUTE_TRACK,this):await Xt(this,Re.NEED_UNMUTE_TRACK,this))}async setSaveEncodeBitrateRatio(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this._saveEncodeBitrateRatio;if(this._saveEncodeBitrateRatio!==1&&this._encoderConfig&&this._encoderConfig.bitrateMax&&this._encoderConfig.bitrateMin){this._encoderConfig.bitrateMin=Math.floor(this._encoderConfig.bitrateMin*t),this._encoderConfig.bitrateMax=Math.floor(this._encoderConfig.bitrateMax*t),I.debug("[".concat(this.getTrackId(),"] set save encode bitrate ratio, ").concat(t)),this._saveEncodeBitrateRatio=1;try{await Xt(this,Re.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(I)}}}async setEncoderConfiguration(t,i){if(!this._enabled)throw new oe(O.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(t=Ta(t),B("USE_STANDARD_BITRATE_DEFAULT")&&(delete t.bitrateMax,delete t.bitrateMin),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),t.width||t.height||t.frameRate){const r=uT({encoderConfig:t});(pn()||Dr()||rc())&&(r.deviceId=void 0),I.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(r));try{await this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution()}catch(o){const s=new oe(O.UNEXPECTED_ERROR,o.toString());throw I.error("[".concat(this.getTrackId(),"] applyConstraints error"),s.toString()),s}}this._encoderConfig=t,this._hints.indexOf(ui.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Xt(this,Re.NEED_UPDATE_VIDEO_ENCODER,this)}catch(r){return r.throw(I)}}getStats(){return pa(()=>{I.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),co(this,Re.GET_STATS)||Mi({},Mv)}async setBeautyEffect(t){I.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(t,i):await Kv(t)}async findClosestProfile(){const{width:t,height:i,frameRate:r}=this.getMediaStreamTrackSettings(),{width:o,height:s,frameRate:a}=this._encoderConfig||{},c=Dh(this._videoWidth||t||o||0),d=Dh(this._videoHeight||i||s||0),l=function(h,p,f){if(!Array.isArray(B("VIDEO_ENCODER_CONFIG_LIST"))||B("VIDEO_ENCODER_CONFIG_LIST").length===0)return!1;const m=Math.min(h,p);return!(m>=480)&&Mi(Mi({},B("VIDEO_ENCODER_CONFIG_LIST").find(g=>g.height>m)),{},{frameRate:f})}(c,d,Dh(r||a||15));if(l)return I.debug("[".concat(this.getTrackId(),"] find closest profile, ").concat(c,"x").concat(d," => ").concat(JSON.stringify(l))),this.setEncoderConfiguration(l)}async setBitrateLimit(t){I.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(t))),t&&(this._forceBitrateLimit=t,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<t.max_bitrate?this._encoderConfig.bitrateMax:t.max_bitrate:this._encoderConfig.bitrateMax=t.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=t.min_bitrate))}async setOptimizationMode(t){if(t!=="motion"&&t!=="detail"&&t!=="balanced")return void I.error(O.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const i=this._optimizationMode;try{this._optimizationMode=t,await Xt(this,Re.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(r){throw this._optimizationMode=i,I.error("[".concat(this.getTrackId(),"] set optimization mode failed"),r.toString()),r}I.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(t,")"))}setScalabiltyMode(t){if(t.numSpatialLayers===1&&t.numTemporalLayers!==1)return I.error(O.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=t,I.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(t,")"))}updateMediaStreamTrackResolution(){lT(this._originMediaStreamTrack).then(t=>{let[i,r]=t;this._videoHeight=r,this._videoWidth=i}).catch(Pf)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(t){if(!this._enabled)throw new oe(O.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");I.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(t)),t=Ta(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),this._encoderConfig=t,this._hints.indexOf(ui.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Xt(this,Re.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(I)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:t,height:i,frameRate:r}=this.getMediaStreamTrackSettings();if(!t||!i||!r)return;const{bitrateMax:o,bitrateMin:s}=this._encoderConfig;if(s==null||o==null){const{max:a,min:c}=function(d,l,h,p,f){const m=B("BITRATE_ADAPTER_TYPE");if(m==="DEFAULT_BITRATE")return{min:p,max:f};if(f===void 0){const g=Math.floor(200*Math.pow(h/15,.6)*Math.pow(d*l/640/360,.75));f=m==="STANDARD_BITRATE"?4*g:2*g,p=p??g}else p=p??Math.floor(f/10);return{min:p,max:f}}(t,i,r,s,o);if(this._encoderConfig.bitrateMin=c,this._encoderConfig.bitrateMax=a,B("VIDEO_STANDARD_BITRATE_VERSION")&&s==null&&o==null){const[d,l]=function(h,p,f){const m=4*Math.floor(2e5*Math.pow(f/15,.6)*Math.pow(h*p/230400,.75)),g=h*p,S=new Map([[19200,.9],[230400,.85],[518400,.75],[921600,.7],[2073600,.6],[3686400,.5]]),T=new Map([[230400,.95],[518400,.9],[921600,.85],[2073600,.8]]);let C=Vr(S).call(S).next().value,b=1;if(S.has(g))C=S.get(g);else{var D;const se=Ka(D=Array.from(S.entries())).call(D,(Ce,De)=>{let[Me]=Ce,[et]=De;return Me-et}),Ne=se.find(Ce=>{let[De]=Ce;return De>g});if(Ne){const Ce=se.indexOf(Ne);if(Ce>0){const De=se[Ce-1],Me=(g-De[0])/(Ne[0]-De[0]);C=De[1]+Me*(Ne[1]-De[1])}else C=Ne[1]}else C=se[se.length-1][1]}if(T.has(g))b=T.get(g);else{var x;const se=Ka(x=Array.from(T.entries())).call(x,(Ce,De)=>{let[Me]=Ce,[et]=De;return Me-et}),Ne=se.find(Ce=>{let[De]=Ce;return De>g});if(Ne){const Ce=se.indexOf(Ne);if(Ce>0){const De=se[Ce-1],Me=(g-De[0])/(Ne[0]-De[0]);b=De[1]+Me*(Ne[1]-De[1])}else b=Ne[1]}else b=se[se.length-1][1]}const k=B("VIDEO_NEW_BITRATE_RATIO");k&&k>0&&(C=k/100);const V=Math.floor(m*C),W=Math.floor(65e4*Math.pow(h*p/230400,.5)*Math.pow(f/15,.69));let K=V;const J=B("VIDEO_STANDARD_BITRATE_VERSION");return J&&J>0&&(J===1?K=m:J===2?K=V:J===3&&(K=W)),[Math.floor(K/1e3),b]}(t,i,r);this._encoderConfig.bitrateMax=d,this._encoderConfig.bitrateMin=c?Math.min(c,d):d,this._saveEncodeBitrateRatio=l,I.debug("[".concat(this.getTrackId(),"] update new bitrate from profile, [w: ").concat(t,", h: ").concat(i,", fps: ").concat(r,"] => [brMax: ").concat(this._encoderConfig.bitrateMax,", brMin: ").concat(this._encoderConfig.bitrateMin,", save_bitrate_ratio: ").concat(this._saveEncodeBitrateRatio,"]"))}else I.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(t,", h: ").concat(i,", fps: ").concat(r,"] => [brMax: ").concat(a,", brMin: ").concat(c,"]")),this._saveEncodeBitrateRatio=1}}getVideoElementVisibleStatus(){try{var t,i;const r=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),o={track:this,element:this==null||(i=this._player)===null||i===void 0?void 0:i.getVideoElement(),slot:r==null?void 0:r.parentElement},{element:s,slot:a}=o;if(this.isPlaying&&s instanceof HTMLVideoElement&&a instanceof HTMLElement){const c=Sv.checkOneElementVisible(s),d=Object.assign({},c);if(d.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=d.visible;const l=H.reportApiInvoke(null,{tag:bi.TRACER,name:ct.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});d.visible?l.onSuccess("Video is visible"):l.onSuccess("Invisible because of ".concat(d.reason))}return d}return}catch(r){throw new oe(O.GET_VIDEO_ELEMENT_VISIBLE_ERROR,r.message)}}async renewMediaStreamTrack(t){}pipe(t){if(this.processor===t)return t;if(t._source)throw new oe(O.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(t){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],r=this._encoderConfig;t&&(r=Mi(Mi({},r),Ta(t))),r=Nh(r);const o=li(8,"track-video-cloned-"),s=new SZ(i?this._mediaStreamTrack.clone():this._mediaStreamTrack,r,Nh(this._scalabilityMode),this._optimizationMode,o,Nh(this._hints));return t&&r&&s.setEncoderConfiguration(r),I.debug("clone video track from ".concat(this.getTrackId()," to ").concat(o,", clone ").concat(i)),s}async replaceTrack(t,i){if(!(t instanceof MediaStreamTrack))throw new oe(O.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(t.kind!=="video")throw new oe(O.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(t,i,!0),this.updateMediaStreamTrackResolution()}sendSeiData(t){if(pa(()=>{H.reportApiInvoke(null,{name:ct.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:bi.TRACER}).onSuccess("")},this._mediaStreamTrack.id||this.getTrackId()),!B("ENABLE_VIDEO_SEI")||!B("ENABLE_ENCODED_TRANSFORM"))return void I.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(t instanceof Uint8Array==0)return new oe(O.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const i=this.getRTCRtpTransceiver();if(!i)return void I.warning("Video track is not published, SEI can not be send");const r=i.sender.getParameters();if(r.codecs.length===0)return;const o=r.codecs[0].mimeType.toLocaleLowerCase();o==="video/h264"||o==="video/h265"?this.safeEmit("sei-to-send",t):I.warning("SEI is not supported by ".concat(o))}bindProcessorDestinationEvents(){this.processorDestination.on(wr.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(),await Xt(this,Re.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Xt(this,Re.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(wr.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Ko.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Ko.REQUEST_CONSTRAINTS)}},X(xt.prototype,"play",[jD,GD],Object.getOwnPropertyDescriptor(xt.prototype,"play"),xt.prototype),X(xt.prototype,"stop",[WD],Object.getOwnPropertyDescriptor(xt.prototype,"stop"),xt.prototype),X(xt.prototype,"setEnabled",[HD,KD,YD],Object.getOwnPropertyDescriptor(xt.prototype,"setEnabled"),xt.prototype),X(xt.prototype,"setMuted",[zD,qD,XD],Object.getOwnPropertyDescriptor(xt.prototype,"setMuted"),xt.prototype),X(xt.prototype,"setSaveEncodeBitrateRatio",[JD,QD],Object.getOwnPropertyDescriptor(xt.prototype,"setSaveEncodeBitrateRatio"),xt.prototype),X(xt.prototype,"setEncoderConfiguration",[ZD,$D],Object.getOwnPropertyDescriptor(xt.prototype,"setEncoderConfiguration"),xt.prototype),X(xt.prototype,"getStats",[eP],Object.getOwnPropertyDescriptor(xt.prototype,"getStats"),xt.prototype),X(xt.prototype,"setBeautyEffect",[tP,iP],Object.getOwnPropertyDescriptor(xt.prototype,"setBeautyEffect"),xt.prototype),X(xt.prototype,"getCurrentFrameData",[rP],Object.getOwnPropertyDescriptor(xt.prototype,"getCurrentFrameData"),xt.prototype),X(xt.prototype,"getCurrentFrameImage",[nP],Object.getOwnPropertyDescriptor(xt.prototype,"getCurrentFrameImage"),xt.prototype),X(xt.prototype,"findClosestProfile",[oP,sP],Object.getOwnPropertyDescriptor(xt.prototype,"findClosestProfile"),xt.prototype),X(xt.prototype,"setBitrateLimit",[aP],Object.getOwnPropertyDescriptor(xt.prototype,"setBitrateLimit"),xt.prototype),X(xt.prototype,"setOptimizationMode",[cP],Object.getOwnPropertyDescriptor(xt.prototype,"setOptimizationMode"),xt.prototype),X(xt.prototype,"setScalabiltyMode",[dP],Object.getOwnPropertyDescriptor(xt.prototype,"setScalabiltyMode"),xt.prototype),X(xt.prototype,"updateMediaStreamTrackResolution",[lP],Object.getOwnPropertyDescriptor(xt.prototype,"updateMediaStreamTrackResolution"),xt.prototype),X(xt.prototype,"pipe",[uP],Object.getOwnPropertyDescriptor(xt.prototype,"pipe"),xt.prototype),X(xt.prototype,"unpipe",[hP],Object.getOwnPropertyDescriptor(xt.prototype,"unpipe"),xt.prototype),X(xt.prototype,"close",[pP],Object.getOwnPropertyDescriptor(xt.prototype,"close"),xt.prototype),X(xt.prototype,"replaceTrack",[Ut],Object.getOwnPropertyDescriptor(xt.prototype,"replaceTrack"),xt.prototype),xt),fT=(_P=_e({argsMap:(e,t)=>[e.getTrackId(),t]}),fP=Tr(),mP=mr("CameraVideoTrack","_enabledMutex"),EP=_e({argsMap:(e,t)=>[e.getTrackId(),t]}),gP=Tr(),SP=_e({argsMap:(e,t)=>[e.getTrackId(),t]}),TP=Tr(),ea=_e({argsMap:e=>[e.getTrackId()]}),Jt=class TZ extends yi{get __className__(){return"CameraVideoTrack"}constructor(t,i,r,o,s,a){super(t,Ta(i.encoderConfig),o,s,a),re(this,"_config",void 0),re(this,"_originalConstraints",void 0),re(this,"_constraints",void 0),re(this,"_enabled",!0),re(this,"_deviceName","default"),re(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(wh()||Ev())&&!function(){const c=ii();if(c.os!==pt.IOS||!c.osVersion)return!1;const d=c.osVersion.split(".");return Number(d[0])===15&&Number(d[1])>=2}()&&ON()&&this._enabled&&!this._isClosed&&(I.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=i,this._originalConstraints=r,this._constraints=r,this._deviceName=t.label,this._encoderConfig=Ta(this._config.encoderConfig),Ei.on(zr.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Ei.on(zr.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(t){return typeof t=="string"?this._setDeviceById(t):t.deviceId?this._setDeviceById(t.deviceId):t.facingMode?this._setDeviceByFacingModel(t.facingMode):void 0}async _setDeviceById(t){if(I.info("[".concat(this.getTrackId(),"] set device to ").concat(t)),this._enabled)try{const i=await As.getDeviceById(t),r={};r.video=Mi({},this._constraints),r.video.deviceId={exact:t},r.video.facingMode=void 0,this._originMediaStreamTrack.stop();let o=null;try{o=await Ra(r,this.getTrackId())}catch(s){throw I.error("[".concat(this.getTrackId(),"] setDevice failed"),s.toString()),o=await Ra({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(o.getVideoTracks()[0],!1),s}await this._updateOriginMediaStreamTrack(o.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=i.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(i){throw I.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}else try{const i=await As.getDeviceById(t);this._deviceName=i.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(i){throw I.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}I.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(t){I.info("[".concat(this.getTrackId(),"] set facingMode ").concat(t));const i={video:Mi(Mi({},this._constraints),{},{deviceId:void 0,facingMode:{exact:t}})};if(this._enabled){this._originMediaStreamTrack.stop();let r=null;try{r=await Ra(i,this.getTrackId())}catch(o){throw I.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),o.toString()),r=await Ra({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),o}await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=t,this._config.cameraId=void 0,this._constraints=Mi({},i.video),I.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(t,i){if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(I.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const r=await Ra({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1)}await Xt(this,Re.NEED_ENABLE_TRACK,this)}catch(r){throw I.error("[".concat(this.getTrackId(),"] setEnabled true error"),r.toString()),r}this.updateMediaStreamTrackResolution(),I.info("[".concat(this.getTrackId(),"] setEnabled to true success")),i||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),i||(this._enabled=!1);try{await Xt(this,Re.NEED_DISABLE_TRACK,this)}catch(r){throw I.error("[".concat(this.getTrackId(),"] setEnabled to false error"),r.toString()),r}I.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(t,i){if(!this._enabled)throw new oe(O.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");t=Ta(t),B("USE_STANDARD_BITRATE_DEFAULT")&&(delete t.bitrateMax,delete t.bitrateMin),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate||t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate||t.bitrateMin);const r=wi(this._config);r.encoderConfig=t;const o=uT(r);(pn()||Dr()||rc())&&(o.deviceId=void 0),I.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(o));try{await this._originMediaStreamTrack.applyConstraints(o),this.updateMediaStreamTrackResolution()}catch(s){const a=new oe(O.UNEXPECTED_ERROR,s.toString());throw I.error("[".concat(this.getTrackId(),"] applyConstraints error"),a.toString()),a}this._config=r,this._constraints=o,this._originalConstraints=o,this._encoderConfig=t,this._hints.indexOf(ui.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Xt(this,Re.NEED_UPDATE_VIDEO_ENCODER,this)}catch(s){return s.throw(I)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((Dr()||rc())&&this._enabled&&!this._isClosed&&Ei.duringInterruption){const t=async()=>{Ei.off(zr.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(I.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Ei.on(zr.IOS_INTERRUPTION_END,t)}else I.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Wo.TRACK_ENDED)}async renewMediaStreamTrack(t){const i=t||this._constraints,r=As.searchDeviceIdByName(this._deviceName);if(r&&!i.deviceId&&(i.deviceId={exact:r}),this._enabled){const o=await Ra({video:i},this.getTrackId());this._constraints=i,await this._updateOriginMediaStreamTrack(o.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),Ei.off(zr.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Ei.off(zr.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(t){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],r=this._encoderConfig;t&&(r=Mi(Mi({},r),Ta(t))),r=Nh(r);const o=li(8,"track-cam-cloned-"),s=new TZ(i?this._mediaStreamTrack.clone():this._mediaStreamTrack,Nh(Mi(Mi({},this._config),{},{encoderConfig:r})),Nh(this._constraints),Nh(this._scalabilityMode),this._optimizationMode,o);return t&&r&&s.setEncoderConfiguration(r),I.debug("clone track from ".concat(this.getTrackId()," to ").concat(o,", clone ").concat(i)),s}bindProcessorContextEvents(){this.processorContext.on(Ko.REQUEST_UPDATE_CONSTRAINTS,async(t,i,r)=>{try{const o=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(o),i()}catch(o){r(o)}}),this.processorContext.on(Ko.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}},X(Jt.prototype,"setDevice",[_P,fP],Object.getOwnPropertyDescriptor(Jt.prototype,"setDevice"),Jt.prototype),X(Jt.prototype,"setEnabled",[mP,EP,gP],Object.getOwnPropertyDescriptor(Jt.prototype,"setEnabled"),Jt.prototype),X(Jt.prototype,"setEncoderConfiguration",[SP,TP],Object.getOwnPropertyDescriptor(Jt.prototype,"setEncoderConfiguration"),Jt.prototype),X(Jt.prototype,"close",[ea],Object.getOwnPropertyDescriptor(Jt.prototype,"close"),Jt.prototype),Jt);function qv(e){const t=li(8,"track-cus-"),i=H.reportApiInvoke(null,{id:t,tag:bi.TRACER,name:ct.CREATE_CUSTOM_AUDIO_TRACK,options:[e]}),r=new Zi(e.mediaStreamTrack,e.encoderConfig?Cl(e.encoderConfig):{},t,!1);return I.info("create custom audio track success with config",e,"trackId",r.getTrackId()),i.onSuccess(r.getTrackId()),r}function Xv(e,t,i,r){i.optimizationMode&&(r&&r.width&&r.height?(i.encoderConfig=Mi(Mi({},r),{},{bitrateMin:r.bitrateMin,bitrateMax:r.bitrateMax}),i.optimizationMode!=="motion"&&i.optimizationMode!=="detail"||(t.contentHint=i.optimizationMode,t.contentHint===i.optimizationMode?I.debug("[".concat(e,"] set content hint to"),i.optimizationMode):I.debug("[".concat(e,"] set content hint failed")))):I.warning("[".concat(e,"] can not apply optimization mode bitrate config, no encoderConfig")))}var RP,vP,CP,va,Ca,yP,IP,AP,wP,bP,OP,Wn,Hn;class D_ extends O_{getUserId(){return this._userId}constructor(t,i,r,o){super(t,"track-".concat(t.kind,"-").concat(i,"-").concat(o.clientId,"_").concat(li(5,""))),re(this,"_userId",void 0),re(this,"_uintId",void 0),re(this,"_isDestroyed",!1),re(this,"store",void 0),re(this,"processor",void 0),re(this,"processorContext",void 0),this._userId=i,this._uintId=r,this.store=o}_updateOriginMediaStreamTrack(t){this._originMediaStreamTrack=t,this._mediaStreamTrack=t,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,I.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let Wd=(RP=_e({argsMap:(e,t,i)=>[e.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),vP=_e({argsMap:e=>[e.getTrackId()]}),CP=_e({argsMap:(e,t)=>[e.getTrackId(),t.name]}),va=_e({argsMap:e=>[e.getTrackId()]}),X((Ca=class extends D_{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Pr.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(e,t,i,r,o){super(e,t,i,r),re(this,"_videoVisibleTimer",null),re(this,"_previousVideoVisibleStatus",void 0),re(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),re(this,"trackMediaType",No.VIDEO),re(this,"_videoWidth",void 0),re(this,"_videoHeight",void 0),re(this,"_player",void 0),re(this,"_prePlayer",void 0),re(this,"processorDestination",void 0),re(this,"processorContext",void 0),this._prePlayer=o,this.updateMediaStreamTrackResolution(),this.processorContext=new $N(this.getTrackId(),"remote"),this.processorDestination=new ZN(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return pa(()=>{I.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),co(this,Re.GET_STATS)||Mi({},Do)}play(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.safeEmit(Ho.PLAY_START),typeof e=="string"){const r=document.getElementById(e);r?e=r:(I.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}I.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));const i=Mi(Mi({fit:"cover"},t),{},{trackId:this.getTrackId(),element:e});if(this._player)this._player.updateConfig(i);else{let r=!1,o=!1;e instanceof HTMLVideoElement?(this._player=new zv(i),this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0,o=!0)):this._prePlayer&&!this._prePlayer.isDestroyed?(this._player=this._prePlayer,this._prePlayer=void 0,r=this._player.videoState>0,this._player.updateConfig(i)):this._player=new _T(i),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(Ho.FIRST_FRAME_DECODED),o&&this.safeEmit(Ho.FIRST_FRAME_RENDER)},this._player.onVideoStateChanged=s=>{this.safeEmit(Ho.VIDEO_STATE_CHANGED,s)},r&&(this._player.onFirstVideoFrameDecoded(),this._player.onVideoStateChanged(this._player.videoState))}this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const r=this.getVideoElementVisibleStatus();this.safeEmit(Ho.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}},B("CHECK_VIDEO_VISIBLE_INTERVAL")),this.safeEmit(Ho.PLAY_END)}stop(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(e),this._player=void 0,I.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){lT(this._originMediaStreamTrack).then(e=>{let[t,i]=e;this._videoHeight=i,this._videoWidth=t}).catch(Pf)}_updatePlayerSource(){I.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var e,t;const i=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),r={track:this,element:this==null||(t=this._player)===null||t===void 0?void 0:t.getVideoElement(),slot:i==null?void 0:i.parentElement},{element:o,slot:s}=r;if(this.isPlaying&&o instanceof HTMLVideoElement&&s instanceof HTMLElement){const a=Sv.checkOneElementVisible(o),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;const d=H.reportApiInvoke(null,{tag:bi.TRACER,name:ct.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(i){throw new oe(O.GET_VIDEO_ELEMENT_VISIBLE_ERROR,i.message)}}pipe(e){if(this.processor===e)return e;if(e._source)throw new oe(O.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(wr.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(wr.ON_TRACK)}_destroy(){this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0),super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(e){this.emit(Nc.SEI_RECEIVED,e)}}).prototype,"play",[RP],Object.getOwnPropertyDescriptor(Ca.prototype,"play"),Ca.prototype),X(Ca.prototype,"stop",[vP],Object.getOwnPropertyDescriptor(Ca.prototype,"stop"),Ca.prototype),X(Ca.prototype,"pipe",[CP],Object.getOwnPropertyDescriptor(Ca.prototype,"pipe"),Ca.prototype),X(Ca.prototype,"unpipe",[va],Object.getOwnPropertyDescriptor(Ca.prototype,"unpipe"),Ca.prototype),Ca),Eo=(yP=_e({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),IP=_e({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),AP=_e({argsMap:(e,t)=>[e.getTrackId(),t]}),wP=_e({argsMap:e=>[e.getTrackId()]}),bP=_e({argsMap:e=>[e.getTrackId()]}),OP=_e({argsMap:(e,t)=>[e.getTrackId(),t.name]}),Wn=_e({argsMap:e=>[e.getTrackId()]}),X((Hn=class extends D_{get isPlaying(){return this._useAudioElement?pi.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(e,t,i,r){super(e,t,i,r),re(this,"trackMediaType",No.AUDIO),re(this,"_source",void 0),re(this,"_useAudioElement",!0),re(this,"_volume",100),re(this,"processorContext",void 0),re(this,"processorDestination",void 0),re(this,"_played",!1),re(this,"_bypassWebAudio",!1),B("DISABLE_WEBAUDIO")?(this._source=new tD,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new Fv(e,!0),B("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(ys.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(Ho.FIRST_FRAME_DECODED)}),this.processorContext=new Wv(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new eD(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(ys.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(ys.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(ys.ON_AUDIO_BUFFER),this._source.on(ys.ON_AUDIO_BUFFER,i=>e(i))}setVolume(e){this._volume=e,this._useAudioElement?pi.setVolume(this.getTrackId(),e):this._source.setVolume(e/100)}setAmplifiedVolume(e){this._useAudioElement&&this._played&&(pi.stop(this.getTrackId()),this._source.play()),this._useAudioElement=!1,e=Math.min(e,B("MAX_WEBAUDIO_VOLUME")),this._volume=e,this._source.setVolume(e/100)}async setPlaybackDevice(e){if(!this._useAudioElement||!aT())throw new oe(O.NOT_SUPPORTED,"your browser does not support setting the audio output device");await pi.setSinkID(this.getTrackId(),e)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getVolume(){return this._useAudioElement?pi.getVolume(this.getTrackId()):this._source instanceof Fv?this._source.getAudioVolume():0}getStats(){return pa(()=>{I.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),co(this,Re.GET_STATS)||Mi({},NU)}play(){I.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(I.debug("[".concat(this.getTrackId(),"] use audio element to play")),pi.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):(I.debug("[".concat(this.getTrackId(),"] use audio context to play")),this._source.play())}stop(){I.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?pi.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];I.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&pi.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(e){if(this._bypassWebAudio)throw new oe(O.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===e)return e;if(e._source)throw new oe(O.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(this._bypassWebAudio)throw new oe(O.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const t=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(wr.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(wr.ON_NODE,e=>{this._source.processedNode=e;const t=!e;this._useAudioElement!==t&&(this._played?(this.stop(),this._useAudioElement=t,this.play()):this._useAudioElement=t)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(wr.ON_TRACK),this.processorDestination.removeAllListeners(wr.ON_NODE)}}).prototype,"setVolume",[yP],Object.getOwnPropertyDescriptor(Hn.prototype,"setVolume"),Hn.prototype),X(Hn.prototype,"setAmplifiedVolume",[IP],Object.getOwnPropertyDescriptor(Hn.prototype,"setAmplifiedVolume"),Hn.prototype),X(Hn.prototype,"setPlaybackDevice",[AP],Object.getOwnPropertyDescriptor(Hn.prototype,"setPlaybackDevice"),Hn.prototype),X(Hn.prototype,"play",[wP],Object.getOwnPropertyDescriptor(Hn.prototype,"play"),Hn.prototype),X(Hn.prototype,"stop",[bP],Object.getOwnPropertyDescriptor(Hn.prototype,"stop"),Hn.prototype),X(Hn.prototype,"pipe",[OP],Object.getOwnPropertyDescriptor(Hn.prototype,"pipe"),Hn.prototype),X(Hn.prototype,"unpipe",[Wn],Object.getOwnPropertyDescriptor(Hn.prototype,"unpipe"),Hn.prototype),Hn);const ws=new class extends Vi{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),re(this,"_lastHiddenTime",0),re(this,"_lastVisibleTime",0),re(this,"needUploadStats",[]),re(this,"isCollectingStats",!1),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),this.isCollectingStats&&this.needUploadStats.push(document.visibilityState==="visible"?1:0),I.debug("current web page is ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}startCollectStats(){this.isCollectingStats=!0,this.needUploadStats.push(this.visibility==="visible"?1:0)}stopCollectStats(){this.isCollectingStats=!1,this.needUploadStats.length=0}};class xU extends Vi{constructor(t,i){super(),re(this,"trackMediaType",No.DATA),re(this,"_version",1),re(this,"_type",3),re(this,"_config",void 0),re(this,"_originDataChannel",void 0),re(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),re(this,"_dataStreamPacketHandler",{serialize:r=>r,deserialize:r=>r}),re(this,"_datachannelEventMap",new Map),this._config=t,i&&(this._originDataChannel=i,this._bandDataChannelEvents(i)),this._initPacketHeader()}useDataStream(t){this._dataStreamPacketHandler=t}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return B("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var t,i;return(t=(i=this._originDataChannel)===null||i===void 0?void 0:i.readyState)!==null&&t!==void 0?t:"connecting"}get _originDataChannelId(){var t,i;return(t=(i=this._originDataChannel)===null||i===void 0?void 0:i.id)!==null&&t!==void 0?t:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new Z((t,i)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&t();const r=setTimeout(()=>{var o;i(new oe(O.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((o=this._originDataChannel)===null||o===void 0?void 0:o.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(r),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),t()},this._originDataChannel.onerror=()=>{throw clearTimeout(r),new oe(O.DATACHANNEL_CONNECTION_TIMEOUT)}}else i(new oe(O.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(t){this._originDataChannel=t,this._bandDataChannelEvents(t)}_initPacketHeader(){const t=new DataView(this._dataStreamPacketHeader);t.setUint16(0,this._version),t.setUint8(2,this._type),t.setUint8(3,this._config.id)}_bandDataChannelEvents(t){this._unbindDataChannelEvents(t),[Wt.OPEN,Wt.CLOSE,Wt.ERROR].forEach(i=>{const r=()=>{this.emit(i)};this._datachannelEventMap.set(i,r),t.addEventListener(i,r)})}_unbindDataChannelEvents(t){Array.from(this._datachannelEventMap.entries()).forEach(i=>{let[r,o]=i;t.removeEventListener(r,o)}),this._datachannelEventMap.clear()}}class KY extends xU{constructor(t){super(t),re(this,"_messageListener",void 0),this._messageListener=i=>{if(i.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const r=i.data.slice(0,this._dataStreamPacketHeader.byteLength),o=new DataView(r).getUint8(3);if(o!==this.id)return void(B("SHOW_DATASTREAM2_LOG")&&I.debug("invalid datachannel id: ".concat(o," !== ").concat(this.id)));let s=i.data.slice(this._dataStreamPacketHeader.byteLength);s=this._dataStreamPacketHandler.deserialize(s),this.emit(Wt.MESSAGE,s)}}_updateOriginDataChannel(t){super._updateOriginDataChannel(t),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class Jv extends xU{send(t){if(this._originDataChannel){let i=t;i=this._dataStreamPacketHandler.serialize(t);const r=new Uint8Array(this._dataStreamPacketHeader.byteLength+i.byteLength);r.set(new Uint8Array(this._dataStreamPacketHeader),0),r.set(new Uint8Array(i),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(r.buffer)}}}function mT(){const e=new Blob([atob("Y29uc3QgdD0idmlkZW8vaDI2NCIsZT0idmlkZW8vaDI2NSI7ZnVuY3Rpb24gbih0LGUsbil7bGV0IGE9bmV3IFVpbnQ4QXJyYXkodCxlLG4pLHI9W10sbz0wO2Zvcig7ci5sZW5ndGg8bjspbyszPG4mJjA9PT1hW29dJiYwPT09YVtvKzFdJiYzPT09YVtvKzJdJiYoMD09PWFbbyszXXx8MT09PWFbbyszXXx8Mj09PWFbbyszXXx8Mz09PWFbbyszXSk/KHIucHVzaChhW29dLGFbbysxXSxhW28rM10pLG8rPTQpOihyLnB1c2goYVtvXSksbysrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkocil9ZnVuY3Rpb24gYShhLHIpe3N3aXRjaChyKXtjYXNlIHQ6cmV0dXJuIGZ1bmN0aW9uKHQpe2NvbnN0IGU9bmV3IERhdGFWaWV3KHQuZGF0YSk7bGV0IGE9MDtmb3IoO2ErNDx0LmRhdGEuYnl0ZUxlbmd0aDspe2lmKDA9PT1lLmdldFVpbnQ4KGErMCkmJjA9PT1lLmdldFVpbnQ4KGErMSkmJjA9PT1lLmdldFVpbnQ4KGErMikmJjE9PT1lLmdldFVpbnQ4KGErMykmJjY9PT1lLmdldFVpbnQ4KGErNCkpe2xldCByPWErNixvPTAsaT0wO2Zvcig7MjU1PT09KGk9ZS5nZXRVaW50OChyKyspKTspbys9MjU1O28rPWk7Y29uc3Qgcz1uKHQuZGF0YSxyLG8pO3JldHVybiBuZXcgVWludDhBcnJheShzKX1hKyt9cmV0dXJuIG51bGx9KGEpO2Nhc2UgZTpyZXR1cm4gZnVuY3Rpb24odCl7Y29uc3QgZT1uZXcgRGF0YVZpZXcodC5kYXRhKTtsZXQgYT0wO2Zvcig7YSs1PHQuZGF0YS5ieXRlTGVuZ3RoOyl7aWYoMD09PWUuZ2V0VWludDgoYSswKSYmMD09PWUuZ2V0VWludDgoYSsxKSYmMD09PWUuZ2V0VWludDgoYSsyKSYmMT09PWUuZ2V0VWludDgoYSszKSYmNzg9PT1lLmdldFVpbnQ4KGErNCkmJjE9PT1lLmdldFVpbnQ4KGErNSkmJjEwMT09PWUuZ2V0VWludDgoYSs2KSl7bGV0IHI9YSs3LG89MCxpPTA7Zm9yKDsyNTU9PT0oaT1lLmdldFVpbnQ4KHIrKykpOylvKz0yNTU7bys9aTtjb25zdCBzPW4odC5kYXRhLHIsbyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KHMpfWErK31yZXR1cm4gbnVsbH0oYSk7ZGVmYXVsdDpyZXR1cm4gbnVsbH19ZnVuY3Rpb24gcih0KXtjb25zdCBlPXQubGVuZ3RoO2xldCBuPVtdLGE9MDtmb3IoO2E8ZTspYSsyPGUmJjA9PT10W2FdJiYwPT09dFthKzFdJiYoMD09PXRbYSsyXXx8MT09PXRbYSsyXXx8Mj09PXRbYSsyXXx8Mz09PXRbYSsyXSk/KG4ucHVzaCh0W2FdLHRbYSsxXSwzLHRbYSsyXSksYSs9Myk6KG4ucHVzaCh0W2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShuKX1mdW5jdGlvbiBvKG4sYSxvKXtzd2l0Y2gobyl7Y2FzZSB0OnJldHVybiBmdW5jdGlvbih0LGUpe2NvbnN0IG49cihlKSxhPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihhLzI1NSksaT1hJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK2ErdC5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNitmXT0yNTUsZisrO3JldHVybiBzWzYrZl09aSxmKysscy5zZXQobiw2K2YpLHMuc2V0KG5ldyBVaW50OEFycmF5KHQpLDYrZithKSxzLmJ1ZmZlcn0obixhKTtjYXNlIGU6cmV0dXJuIGZ1bmN0aW9uKHQsZSl7Y29uc3Qgbj1yKGUpLGE9bi5sZW5ndGgsbz1NYXRoLmZsb29yKGEvMjU1KSxpPWElMjU1LHM9bmV3IFVpbnQ4QXJyYXkoNytvKzErYSsxK3QuYnl0ZUxlbmd0aCk7c1swXT0wLHNbMV09MCxzWzJdPTAsc1szXT0xLHNbNF09Nzgsc1s1XT0xLHNbNl09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNytmXT0yNTUsZisrO3JldHVybiBzWzcrZl09aSxmKysscy5zZXQobiw3K2YpLGYrPWEsc1s3K2ZdPTEyOCxmKysscy5zZXQobmV3IFVpbnQ4QXJyYXkodCksNytmKSxzLmJ1ZmZlcn0obixhKTtkZWZhdWx0OnJldHVybiBudWxsfX1mdW5jdGlvbiBpKG4pe2lmKG4ubGVuZ3RoPDUpcmV0dXJuIiI7bGV0IGE9LTE7Zm9yKGxldCB0PTA7dDxuLmxlbmd0aC0zO3QrKyl7aWYoMD09PW5bdF0mJjA9PT1uW3QrMV0mJjE9PT1uW3QrMl0pe2E9dDticmVha31pZih0PG4ubGVuZ3RoLTQmJjA9PT1uW3RdJiYwPT09blt0KzFdJiYwPT09blt0KzJdJiYxPT09blt0KzNdKXthPXQ7YnJlYWt9fWlmKC0xPT09YSlyZXR1cm4iIjtjb25zdCByPWErKDA9PT1uW2ErMl0/NDozKTtpZihyPj1uLmxlbmd0aClyZXR1cm4iIjtjb25zdCBvPW5bcl07aWYoMTI4Jm8pcmV0dXJuIiI7aWYoKG8+PjEmNjMpPj0zMilyZXR1cm4gZTtpZihyKzE8bi5sZW5ndGgpe2lmKDA9PSgyNDgmbltyKzFdKSlyZXR1cm4gZX1yZXR1cm4oMzEmbyk8PTMxP3Q6IiJ9Y29uc3Qgcz03MSxmPTEsbD0yLHU9MSxnPTI7dmFyIGM7ZnVuY3Rpb24gZCh0LGU9ITEpe2NvbnN0IG49dC5nZXRVaW50OCgwKTtpZihuIT09cylyZXR1cm47Y29uc3QgYT10LmdldFVpbnQxNigxKSxyPWYrbCthLG89bmV3IFVpbnQ4QXJyYXkodC5ieXRlTGVuZ3RoLXIpO28uc2V0KG5ldyBVaW50OEFycmF5KHQuYnVmZmVyLHIsdC5ieXRlTGVuZ3RoLXIpKTtjb25zdCBpPXttOm4sdGx2TGVuOmEsdGx2OltdLGZyYW1lOm99O2xldCBkPWYrbDtmb3IoO2Q8cjspe2NvbnN0IG49dC5nZXRVaW50OChkKSxhPXQuZ2V0VWludDE2KGQrdSkscj11K2c7aWYobj09PWMuQVVESU9fTEVWRUwpe2xldCBvPXQuZ2V0VWludDgoZCtyKTtmb3IobGV0IGU9MTtlPGE7ZSsrKW89bzw8OHx0LmdldFVpbnQ4KGQrcitlKTtpLnRsdi5wdXNoKHt0YWc6bixsZW5ndGg6YSx2YWx1ZTplPzEyN15vPj4xOjEyNyZvfSl9ZWxzZSBpZihuPT09Yy5NRVRBREFUQXx8bj09PWMuQVVESU9fNjRfQklUX1BUUyl7Y29uc3QgZT1uZXcgVWludDhBcnJheShhKTtmb3IobGV0IG49MDtuPGE7bisrKWVbbl09dC5nZXRVaW50OChkK3Irbik7aS50bHYucHVzaCh7dGFnOm4sbGVuZ3RoOmEsdmFsdWU6ZX0pfWQrPXIrYX1yZXR1cm4gaX0hZnVuY3Rpb24odCl7dFt0LkFVRElPX0xFVkVMPTFdPSJBVURJT19MRVZFTCIsdFt0Lk1FVEFEQVRBPTJdPSJNRVRBREFUQSIsdFt0LkFVRElPXzY0X0JJVF9QVFM9M109IkFVRElPXzY0X0JJVF9QVFMifShjfHwoYz17fSkpLHNlbGYub25ydGN0cmFuc2Zvcm09dD0+e2NvbnN0IGU9dC50cmFuc2Zvcm1lcixuPVtdLHI9W107bGV0IGg9bnVsbDtlLm9wdGlvbnMucG9ydC5vbm1lc3NhZ2U9dD0+e3QuZGF0YS5zZWkmJm4ucHVzaCh0LmRhdGEuc2VpKSx0LmRhdGEubWV0YWRhdGEmJnIucHVzaCh0LmRhdGEubWV0YWRhdGEpfSxzZWxmLnBvc3RNZXNzYWdlKCJzdGFydGVkIik7Y29uc3QgcD1lLnJlYWRhYmxlLmdldFJlYWRlcigpLFU9ZS53cml0YWJsZS5nZXRXcml0ZXIoKTsic2VpLXJ4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1pKG5ldyBVaW50OEFycmF5KG4udmFsdWUuZGF0YSkpLHI9YShuLnZhbHVlLHQpO2lmKHImJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtzZWk6cn0pLCFoKXtjb25zdCB0PW4udmFsdWUuZ2V0TWV0YWRhdGEoKXx8e307aD17dHlwZTpuLnZhbHVlLnR5cGUscnRwVGltZXN0YW1wOm4udmFsdWUudGltZXN0YW1wLHBheWxvYWRUeXBlOnQucGF5bG9hZFR5cGV8fDAsc3NyYzp0LnN5bmNocm9uaXphdGlvblNvdXJjZXx8MCxsZW5ndGg6bi52YWx1ZS5kYXRhLmJ5dGVMZW5ndGgsLi4uIm1pbWVUeXBlImluIHQ/e21pbWVUeXBlOnQubWltZVR5cGV9Ont9fSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7Zmlyc3RGcmFtZUluZm86aH0pfX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToic2VpLXR4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigoYT0+e2lmKCFhLmRvbmUpe2lmKGEudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1pKG5ldyBVaW50OEFycmF5KGEudmFsdWUuZGF0YSkpLGU9bi5zaGlmdCgpO2lmKGUpe2NvbnN0IG49byhhLnZhbHVlLmRhdGEsZSx0KTtuJiYoYS52YWx1ZS5kYXRhPW4pfX1VLndyaXRlKGEudmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtcngiPT09ZS5vcHRpb25zLm5hbWU/ZnVuY3Rpb24gdChlKXtwLnJlYWQoKS50aGVuKChuPT57aWYoIW4uZG9uZSl7aWYobi52YWx1ZSBpbnN0YW5jZW9mIFJUQ0VuY29kZWRBdWRpb0ZyYW1lKXtjb25zdCB0PW5ldyBEYXRhVmlldyhuLnZhbHVlLmRhdGEpLGE9dC5nZXRVaW50OCgwKTtsZXQgcjtpZigwIT0oMTI4JmEpJiY3MSE9PWEpe2NvbnN0IGU9ZnVuY3Rpb24odCl7aWYodC5ieXRlTGVuZ3RoPD0wKXJldHVybltdO2NvbnN0IGU9W107bGV0IG49MDtmb3IoO248dC5ieXRlTGVuZ3RoOyl7Y29uc3QgYT0oMTI4JnQuZ2V0VWludDgobikpPj43LHI9MTI3JnQuZ2V0VWludDgobik7aWYoIShhJiZuKzQ8PXQuYnl0ZUxlbmd0aCkpe24rKzticmVha317Y29uc3QgYT10LmdldFVpbnQzMihuLCExKSxvPSgxNjc3NjE5MiZhKT4+MTAsaT0xMDIzJmE7ZS5wdXNoKHtwdDpyLHRzX29mZnNldDpvLGxlbmd0aDppLGRhdGE6bmV3IFVpbnQ4QXJyYXl9KSxuKz00fX1sZXQgYT10LmJ5dGVMZW5ndGgtbjtmb3IoY29uc3QgciBvZiBlKXtpZihyLmxlbmd0aD5hKXJldHVybiBjb25zb2xlLndhcm4oIkJyb2tlbiByZWQgcGF5bG9hZCIpLFtdO3IubGVuZ3RoPjAmJihyLmRhdGE9bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIsdC5ieXRlT2Zmc2V0K24sci5sZW5ndGgpLG4rPXIubGVuZ3RoLGEtPXIubGVuZ3RoKX1pZihhPjApe2NvbnN0IHI9e3B0OmUubGVuZ3RoPjA/ZVtlLmxlbmd0aC0xXS5wdDowLHRzX29mZnNldDowLGxlbmd0aDphLGRhdGE6bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIsdC5ieXRlT2Zmc2V0K24sYSl9O2UucHVzaChyKX1yZXR1cm4gZX0odCk7aWYoZS5sZW5ndGg+MCl7Y29uc3QgdD1mdW5jdGlvbih0KXtsZXQgZT0wO2ZvcihsZXQgbj0wO248dC5sZW5ndGg7bisrKWUrPW48dC5sZW5ndGgtMT80OjEsZSs9dFtuXS5sZW5ndGg7Y29uc3Qgbj1uZXcgVWludDhBcnJheShlKTtsZXQgYT0wO2ZvcihsZXQgZT0wO2U8dC5sZW5ndGg7ZSsrKWlmKGU8dC5sZW5ndGgtMSl7Y29uc3Qgcj0oMjE0NzQ4MzY0OHwoMTI3JnRbZV0ucHQpPDwyNHwoMjYyMTQzJnRbZV0udHNfb2Zmc2V0KTw8MTB8MTAyMyZ0W2VdLmxlbmd0aCk+Pj4wO25bYSsrXT1yPj4yNCYyNTUsblthKytdPXI+PjE2JjI1NSxuW2ErK109cj4+OCYyNTUsblthKytdPTI1NSZyfWVsc2UgblthKytdPTEyNyZ0W2VdLnB0O2Zvcihjb25zdCBlIG9mIHQpbi5zZXQoZS5kYXRhLGEpLGErPWUubGVuZ3RoO3JldHVybiBufShlLm1hcCgodD0+e2NvbnN0IGU9bmV3IFVpbnQ4QXJyYXkodC5sZW5ndGgpO2Uuc2V0KHQuZGF0YSk7Y29uc3Qgbj1kKG5ldyBEYXRhVmlldyhlLmJ1ZmZlcikpO3JldHVybiBuPy5mcmFtZSYmKHQuZGF0YT1uPy5mcmFtZSkscj1uLHR9KSkpO24udmFsdWUuZGF0YT10LmJ1ZmZlcn19ZWxzZSByPWQodCksciYmKG4udmFsdWUuZGF0YT1yLmZyYW1lLmJ1ZmZlcik7aWYocil7bGV0IHQ9ci50bHYuZmluZCgodD0+dC50YWc9PT1jLk1FVEFEQVRBKSk7aWYodCYmdC52YWx1ZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkmJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHttZXRhZGF0YTp0LnZhbHVlfSksdD1yLnRsdi5maW5kKCh0PT50LnRhZz09PWMuQVVESU9fNjRfQklUX1BUUykpLHQmJnQudmFsdWUgaW5zdGFuY2VvZiBVaW50OEFycmF5JiY4PT10LnZhbHVlLmxlbmd0aCl7Y29uc3Qgbj1uZXcgRGF0YVZpZXcodC52YWx1ZS5idWZmZXIpLmdldEJpZ1VpbnQ2NCgwLCEwKTt0JiZ0LnZhbHVlIGluc3RhbmNlb2YgVWludDhBcnJheSYmZS5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe3B0czpufSl9fX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtdHgiPT09ZS5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtnZXRNZXRhZGF0YTohMH0pLG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkQXVkaW9GcmFtZSl7Y29uc3QgdD1yLnNoaWZ0KCk7dCYmKG4udmFsdWUuZGF0YT1mdW5jdGlvbih0LGUsbil7Y29uc3QgYT1uLmJ5dGVMZW5ndGgscj1hK3UrZyxvPWYrbCtyLGk9bmV3IEFycmF5QnVmZmVyKHQuYnl0ZUxlbmd0aCtvKSxjPW5ldyBEYXRhVmlldyhpKTtjLnNldFVpbnQ4KDAscyksYy5zZXRVaW50MTYoMSxyKSxjLnNldFVpbnQ4KDMsZSksYy5zZXRVaW50MTYoNCxhKTtmb3IobGV0IHQ9MDt0PGE7dCsrKWMuc2V0VWludDgoNit0LG5bdF0pO2NvbnN0IGQ9bmV3IFVpbnQ4QXJyYXkoYy5idWZmZXIpO3JldHVybiBkLnNldChuZXcgVWludDhBcnJheSh0KSxvKSxkLmJ1ZmZlcn0obi52YWx1ZS5kYXRhLGMuQVVESU9fNjRfQklUX1BUUyx0KSl9VS53cml0ZShuLnZhbHVlKSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSx0KGUpfX0pKX0oZSl9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKTsK")],{type:"text/javascript"});return setTimeout(()=>i_.revokeObjectURL(e),0),new Worker(i_.createObjectURL(e))}const Qv=71,ET=1,gT=2,Zv=1,ku=2;var yl=function(e){return e[e.AUDIO_LEVEL=1]="AUDIO_LEVEL",e[e.METADATA=2]="METADATA",e[e.AUDIO_64_BIT_PTS=3]="AUDIO_64_BIT_PTS",e}(yl||{});function zf(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const i=e.getUint8(0);if(i!==Qv)return;const r=e.getUint16(1),o=ET+gT+r,s=new Uint8Array(e.byteLength-o);s.set(new Uint8Array(e.buffer,o,e.byteLength-o));const a={m:i,tlvLen:r,tlv:[],frame:s};let c=ET+gT;for(;c<o;){const d=e.getUint8(c),l=e.getUint16(c+Zv),h=Zv+ku;if(d===yl.AUDIO_LEVEL){let p=e.getUint8(c+h);for(let f=1;f<l;f++)p=p<<8|e.getUint8(c+h+f);a.tlv.push({tag:d,length:l,value:t?127^p>>1:127&p})}else if(d===yl.METADATA||d===yl.AUDIO_64_BIT_PTS){const p=new Uint8Array(l);for(let f=0;f<l;f++)p[f]=e.getUint8(c+h+f);a.tlv.push({tag:d,length:l,value:p})}c+=h+l}return a}const P_=new Map,Il=127,Mu=1e-10,qf=139/13,Xf=new Map;function $v(e,t,i){const r="".concat(e,"-").concat(t,"-").concat(i);let o=0;return Xf.has(r)?o=Xf.get(r):(o=Math.log(function(a,c){const d=a-c;c<d&&(c=d);let l=1;for(let h=a,p=1;h>c;h--,p++)l=l*h/p;return l}(t,e))+e*Math.log(.5)+(t-e)*Math.log(1-.5)-Math.log(i)+i*e,Xf.set(r,o)),o<Mu&&(o=Mu),o}function VU(e,t,i){const r=t.length,o=e.length/r;let s=!1;for(let a=0,c=0;a<r;a++){let d=0;for(let l=c+o;c<l;c++)e[c]>i&&d++;t[a]!==d&&(t[a]=d,s=!0)}return s}window.cache=Xf;let FU=0;class BU{constructor(t){re(this,"id",void 0),re(this,"immediates",[]),re(this,"lastNonSilence",-1),re(this,"immediateSpeechActivityScore",Mu),re(this,"lastLevelChangedTime",Date.now()),re(this,"levels",[]),re(this,"longs",[]),re(this,"longSpeechActivityScore",Mu),re(this,"mediums",[]),re(this,"mediumSpeechActivityScore",Mu),re(this,"minLevel",0),re(this,"nextMinLevel",0),re(this,"nextMinLevelWindowLength",0),re(this,"energyScore",0),this.id=t||"".concat(FU++),this.immediates.length=50,this.mediums.length=10,this.longs.length=1,this.levels.length=this.immediates.length}computeImmediates(){const t=this.immediates,i=this.levels,r=this.minLevel+qf;let o=!1;for(let s=0;s<t.length;++s){let a=i[s];a<r&&(a=0);const c=Math.floor(a/qf);t[s]!==c&&(t[s]=c,o=!0)}return o}computeLongs(){return VU(this.mediums,this.longs,4)}computeMediums(){return VU(this.immediates,this.mediums,7)}evaluateImmediateSpeechActivityScore(){this.immediateSpeechActivityScore=$v(this.immediates[0],13,.78)}evaluateLongSpeechActivityScore(t){this.longSpeechActivityScore=$v(this.longs[0],10,47),this.longSpeechActivityScore>Mu&&(this.lastNonSilence=t)}evaluateMediumSpeechActivityScore(){this.mediumSpeechActivityScore=$v(this.mediums[0],5,24)}evaluateSpeechActivityScores(t){this.computeImmediates()&&(this.evaluateImmediateSpeechActivityScore(),this.computeMediums()&&(this.evaluateMediumSpeechActivityScore(),this.computeLongs()&&this.evaluateLongSpeechActivityScore(t)))}getLastLevelChangedTime(){return this.lastLevelChangedTime}getLevels(){var t;return"[".concat(xI(t=[...this.levels]).call(t).join(),"]")}getSpeechActivityScore(t){switch(t){case 0:return this.immediateSpeechActivityScore;case 1:return this.mediumSpeechActivityScore;case 2:return this.longSpeechActivityScore;default:throw new Error("interval "+t)}}levelChanged(t,i){if(this.lastLevelChangedTime<=i){this.lastLevelChangedTime=i;let r=t;return t<0&&(r=0),t>Il&&(r=Il),this.levels.unshift(r),this.levels.length>this.immediates.length&&this.levels.pop(),this.updateMinLevel(r),r>=this.minLevel+qf?r:r/2}return-1}levelTimedOut(){this.levelChanged(0,this.lastLevelChangedTime)}updateMinLevel(t){if(t!==0){if(this.minLevel===0||this.minLevel>t)return this.minLevel=t,this.nextMinLevel=0,void(this.nextMinLevelWindowLength=0);if(this.nextMinLevel===0)return this.nextMinLevel=t,void(this.nextMinLevelWindowLength=1);if(this.nextMinLevel>t&&(this.nextMinLevel=t),this.nextMinLevelWindowLength++,this.nextMinLevelWindowLength>=750){let i=Math.sqrt(this.minLevel*this.nextMinLevel);i<0?i=0:i>Il&&(i=Il),this.minLevel=i,this.nextMinLevel=0,this.nextMinLevelWindowLength=0}}}}class NP{constructor(t){re(this,"algorithm",void 0),this.algorithm=t}execute(){let t=!this.algorithm;if(!t)try{const i=this.algorithm.runInDecisionMaker(this);i<=0?t=!0:setTimeout(this.execute.bind(this),i)}catch{t=!0}t&&this.algorithm&&this.algorithm.decisionMakerExited(this)}}class DP{constructor(t,i,r){re(this,"isDominant",void 0),re(this,"energyRanking",void 0),re(this,"energyScore",void 0),this.isDominant=t,this.energyRanking=i,this.energyScore=r}}class Jf extends Vi{constructor(t){super(),re(this,"dominantId",null),re(this,"lastDecisionTime",0),re(this,"lastLevelChangedTime",0),re(this,"lastLevelIdleTime",0),re(this,"relativeSpeechActivities",[]),re(this,"speakers",new Map),re(this,"enableSilence",!1),re(this,"timeoutToSilenceInterval",0),re(this,"decisionMaker",null),re(this,"loudest",[]),re(this,"numLoudestToTrack",3),re(this,"energyExpireTimeMs",250),re(this,"energyAlphaPct",50),this.timeoutToSilenceInterval=t,this.enableSilence=t>0,this.relativeSpeechActivities.length=3}setLoudestConfig(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:3,i=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0;this.numLoudestToTrack=t,i!=null&&(this.energyExpireTimeMs=i),r!=null&&(this.energyAlphaPct=r),this.loudest.length>t&&this.loudest.splice(t)}getDominantSpeaker(){return this.dominantId}isAmongLoudest(t){return this.loudest.some(i=>i.id===t)}levelChanged(t,i){const r=Date.now(),o=this.getOrCreateSpeaker(t);this.lastLevelChangedTime<r&&(this.lastLevelChangedTime=r,this.maybeStartDecisionMaker());const s=o.levelChanged(i,r);return this.updateLoudestList(o,s,r)}runInDecisionMaker(t){return this.decisionMaker!==t||this.lastDecisionTime>0&&this.lastDecisionTime-this.lastLevelChangedTime>=15e3?-1:this._runInDecisionMaker()}decisionMakerExited(t){this.decisionMaker===t&&(this.decisionMaker=null)}destroy(){this.decisionMaker=null,this.loudest.length=0,this.speakers.clear(),this.removeAllListeners()}addSpeakers(t){t.forEach(i=>{this.speakers.has(i.id)||this.speakers.set(i.id,i)})}removeSpeakers(t){t.forEach(i=>{this.speakers.delete(i.id)})}getOrCreateSpeaker(t){let i=this.speakers.get(t);return i||(i=new BU(t),this.speakers.set(t,i),this.maybeStartDecisionMaker()),i}updateLoudestList(t,i,r){const o=t.id===this.dominantId;if(i<0){let d=0;for(;d<this.loudest.length&&this.loudest[d]!==t;)++d;return new DP(o,d,t.energyScore)}if(t.energyScore=Math.floor((this.energyAlphaPct*i+(100-this.energyAlphaPct)*t.energyScore+50)/100),this.numLoudestToTrack===0)return new DP(o,0,t.energyScore);const s=r-this.energyExpireTimeMs;let a=0;for(;a<this.loudest.length;){const d=this.loudest[a];if(d.getLastLevelChangedTime()<s&&this.loudest.length>=this.numLoudestToTrack)this.loudest.splice(a,1);else if(d.id!==t.id)++a;else if(this.loudest.splice(a,1),this.loudest.length<this.numLoudestToTrack)break}let c=0;for(;c<this.loudest.length&&!(this.loudest[c].energyScore<t.energyScore);)++c;return c<this.numLoudestToTrack&&(this.loudest.splice(c,0,t),this.loudest.length>this.numLoudestToTrack&&this.loudest.splice(this.numLoudestToTrack,1)),new DP(o,c,t.energyScore)}maybeStartDecisionMaker(){!this.decisionMaker&&this.speakers.size>0&&(this.decisionMaker=new NP(this),this.decisionMaker.execute())}makeDecision(t){let i=null,r=null;const o=this.speakers.size;let s=null;if(o===0)s=null;else if(o===1){var a;const c=Vr(a=this.speakers).call(a).next().value;this.enableSilence&&c&&(s=c.id,c.evaluateSpeechActivityScores(t),t-c.lastNonSilence>this.timeoutToSilenceInterval&&(s=null))}else{let c=this.dominantId==null?null:this.speakers.get(this.dominantId);if(c==null){const h=this.speakers.entries().next();h.value&&(s=h.value[0],c=h.value[1])}else s=c.id;c!=null&&c.evaluateSpeechActivityScores(t);const d=this.relativeSpeechActivities;let l=2;for(const h of this.speakers.entries()){const[p,f]=h;if(f===c)continue;f.evaluateSpeechActivityScores(t);for(let T=0;T<d.length;++T){const C=c==null?Mu:c.getSpeechActivityScore(T);d[T]=Math.log(f.getSpeechActivityScore(T)/C)}const m=d[0],g=d[1],S=d[2];m>3&&g>2&&S>0&&g>l&&(l=g,s=p)}this.enableSilence&&c!=null&&s===c.id&&t-c.lastNonSilence>this.timeoutToSilenceInterval&&(s=null)}s==null&&!this.enableSilence||s===this.dominantId||(i=this.dominantId,this.dominantId=s,r=this.dominantId),r==null&&!this.enableSilence||r===i||this.emit("ActiveSpeakerChanged",r)}_runInDecisionMaker(){const t=Date.now(),i=300-(t-this.lastLevelIdleTime);let r=0;i<=0?(this.lastLevelIdleTime!==0&&this.timeoutIdleLevels(t),this.lastLevelIdleTime=t):r=i;let o=300-(t-this.lastDecisionTime);return o<=0&&(this.lastDecisionTime=t,this.makeDecision(t),o=300-(Date.now()-t)),o>0&&r>o&&(r=o),r}timeoutIdleLevels(t){const i=[];for(const o of Vr(r=this.speakers).call(r)){var r;const s=t-o.getLastLevelChangedTime();36e5<s&&(this.dominantId==null||o.id!==this.dominantId)?i.push(o.id):300<s&&o.levelTimedOut()}i.forEach(o=>this.speakers.delete(o))}}const bs=new Map;let ya=null,ST=null;const Uh=3;let ps=[];const Ia=new Map,eC=new Map;class tC{get samples(){return this.actives+this.inactives}get activeRate(){return this.actives/this.samples}constructor(t,i){re(this,"id",void 0),re(this,"track",void 0),re(this,"score",0),re(this,"active",!0),re(this,"muted",!1),re(this,"timer",0),re(this,"actives",0),re(this,"inactives",0),this.id=t,this.track=i,this.setActive(Ia.size<3)}autoCheckActive(){this.autoSetActive(),this.autoAdjustActive(),this.resetTimer(),this.actives=0,this.inactives=0}autoSetActive(){const t=this.active;this.active=this.activeRate>=.8;const{actives:i,inactives:r}=function(){const o=[],s=[];return Array.from(Vr(Ia).call(Ia)).forEach(a=>{a.active?o.push(a):s.push(a)}),{actives:o,inactives:s}}();if(i.length>3){let o;i.forEach(s=>{(!o||o.score>s.score)&&(o=s)}),o&&o.setActive(!1)}if(i.length<3&&r.length>0){let o;r.forEach(s=>{(!o||o.score<s.score)&&s.id!==this.id&&(o=s)}),o&&t&&!this.active&&(o.samples>40&&o.activeRate-this.activeRate>.4?o.setActive(!0):this.active=!0)}this.setMuted(!this.active)}setActive(t){this.active=t,this.resetTimer(),this.setMuted(!t)}autoAdjustActive(){this.active?this.autoSwitchToInactive():this.autoSwitchToActive()}autoSwitchToActive(){const t=function(i){let r;return Array.from(Vr(Ia).call(Ia)).forEach(o=>{!o.active||o.id===i||o.samples<40||(!r||o.score<r.score)&&(r=o)}),r}(this.id);t&&this.activeRate-t.activeRate>.4&&(t.setActive(!1),this.setActive(!0))}autoSwitchToInactive(){const t=function(i){let r;return Array.from(Vr(Ia).call(Ia)).forEach(o=>{o.active||o.id===i||o.samples<40||(!r||o.score>r.score)&&(r=o)}),r}(this.id);t&&t.activeRate-this.activeRate>.4&&(t.setActive(!0),this.setActive(!1))}addSample(t){t?this.actives+=1:this.inactives+=1,this.samples>66.66666666666667&&this.autoCheckActive()}setMuted(t){this.track&&(this.track.enabled=!t,this.muted=t)}resetTimer(){this.clearTimer(),this.timer=window.setTimeout(()=>{if(this.samples!==0)return this.samples<50?this.resetTimer():void this.autoCheckActive()},1e3)}clearTimer(){this.timer&&(clearTimeout(this.timer),this.timer=0)}}let TT;function RT(e){const t=Ia.get(e);t&&(Ia.delete(e),t.clearTimer())}const iC=new Map,PP=new Map,vT="video/h264",rC="video/h265";function LP(e,t,i){let r=new Uint8Array(e,t,i),o=[],s=0;for(;o.length<i;)s+3<i&&r[s]===0&&r[s+1]===0&&r[s+2]===3&&(r[s+3]===0||r[s+3]===1||r[s+3]===2||r[s+3]===3)?(o.push(r[s],r[s+1],r[s+3]),s+=4):(o.push(r[s]),s++);return new Uint8Array(o)}function kP(e){const t=e.length;let i=[],r=0;for(;r<t;)r+2<t&&e[r]===0&&e[r+1]===0&&(e[r+2]===0||e[r+2]===1||e[r+2]===2||e[r+2]===3)?(i.push(e[r],e[r+1],3,e[r+2]),r+=3):(i.push(e[r]),r++);return new Uint8Array(i)}function CT(e){if(e.length<5)return"";let t=-1;for(let o=0;o<e.length-3;o++){if(e[o]===0&&e[o+1]===0&&e[o+2]===1){t=o;break}if(o<e.length-4&&e[o]===0&&e[o+1]===0&&e[o+2]===0&&e[o+3]===1){t=o;break}}if(t===-1)return"";const i=t+(e[t+2]===0?4:3);if(i>=e.length)return"";const r=e[i];return 128&r?"":(r>>1&63)>=32||i+1<e.length&&!(248&e[i+1])?rC:(31&r)<=31?vT:""}const xh=new Map,yT=new Map;(function(){const e=ii();ot.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),ot.getStreamFromExtension=e.name===di.CHROME&&Number(e.version)>34,ot.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const t=new RTCPeerConnection;let i=!1;try{t.addTransceiver("audio"),i=!0}catch{}return t.close(),i}(),ot.supportMinBitrate=e.name===di.CHROME||e.name===di.EDGE,ot.supportSetRtpSenderParameters=function(){const t=ii();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!ha()||!(!pn()&&!wc())||t.name===di.FIREFOX&&Number(t.version)>=64)}(),e.name===di.SAFARI&&(Number(e.version)>=14?ot.supportDualStream=!0:ot.supportDualStream=!1),ot.webAudioMediaStreamDest=function(){const t=ii();return!(t.name===di.SAFARI&&Number(t.version)<12)}(),ot.supportReplaceTrack=!!window.RTCRtpSender&&typeof RTCRtpSender.prototype.replaceTrack=="function",ot.supportWebGL=typeof WebGLRenderingContext<"u",ot.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,ha()||(ot.webAudioWithAEC=!0),ot.supportShareAudio=function(){const t=ii();return(t.os===pt.WIN_10||t.os===pt.WIN_81||t.os===pt.WIN_7||t.os===pt.LINUX||t.os===pt.MAC_OS||t.os===pt.CHROMIUM_OS)&&t.name===di.CHROME&&Number(t.version)>=74}(),ot.supportDataChannel=!!(bc(76)||fv(68)||wN(14)),ot.supportPCSetConfiguration=function(){const t=window.RTCPeerConnection;return!Ht()&&!!t&&t.prototype.setConfiguration instanceof Function}(),ot.supportWebRTCEncodedTransform=bc(87)||AN()||fv(117),ot.supportWebRTCInsertableStream=function(){const t=ii();return(t.name===di.CHROME||t.name===di.EDGE)&&Number(t.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),ot.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,ot.supportWebCrypto=typeof window<"u"&&window.crypto!==void 0&&window.crypto.subtle!==void 0,ot.supportSuppressLocalAudioPlayback=zN(),ot.supportRestrictOwnAudio=In(),Li(()=>{ot.supportDualStreamEncoding=function(){const t=ii();return!!B("DISABLE_WEBAUDIO")||t.name==="Safari"&&Number(t.version)>=14||!!(t.name==="Chrome"&&/Windows/i.test(t.os||"")&&Number(t.version)>=100&&B("CHROME_DUAL_STREAM_USE_ENCODING"))}(),I.debug("browser ua: ",navigator.userAgent),I.info("browser info: ",e),I.info("browser compatibility: ",ot)})})();const jU=["CHINA","GLOBAL"],Vh=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Lc=[],kc=[];function Uu(e,t){return!!t&&Lc.some(i=>i.uid===e&&i.channelName===t)}function MP(){return kc.length>0}var GU=LS.forEach,WU=_p("forEach")?[].forEach:function(e){return GU(this,e,arguments.length>1?arguments[1]:void 0)};qe({target:"Array",proto:!0,forced:[].forEach!==WU},{forEach:WU});var YY=ln("Array","forEach"),zY=Gs,qY=Bi,XY=me,UP=YY,xP=Array.prototype,JY={DOMTokenList:!0,NodeList:!0},QY=function(e){var t=e.forEach;return e===xP||XY(xP,e)&&t===xP.forEach||qY(JY,zY(e))?UP:t},ZY=A(QY),HU=Co,KU=Tp;qe({target:"Object",stat:!0,forced:P(function(){KU(1)})},{keys:function(e){return KU(HU(e))}});var $Y=A(Qr.Object.keys),ez=A(kI),tz=A(UI),YU=qe,zU=eu,iz=kp,qU=ir,XU=vE,rz=js,nz=Fs,oz=jg,sz=qt,az=Hs,cz=S0("slice"),VP=sz("species"),FP=Array,dz=Math.max;YU({target:"Array",proto:!0,forced:!cz},{slice:function(e,t){var i,r,o,s=nz(this),a=rz(s),c=XU(e,a),d=XU(t===void 0?a:t,a);if(zU(s)&&(i=s.constructor,(iz(i)&&(i===FP||zU(i.prototype))||qU(i)&&(i=i[VP])===null)&&(i=void 0),i===FP||i===void 0))return az(s,c,d);for(r=new(i===void 0?FP:i)(dz(d-c,0)),o=0;c<d;c++,o++)c in s&&oz(r,o,s[c]);return r.length=o,r}});var lz=ln("Array","slice"),uz=me,BP=lz,jP=Array.prototype,hz=function(e){var t=e.slice;return e===jP||uz(jP,e)&&t===jP.slice?BP:t},Oe=A(hz);function Ae(e,t,i,r,o){var s,a,c,d={};return ZY(s=$Y(r)).call(s,function(l){d[l]=r[l]}),d.enumerable=!!d.enumerable,d.configurable=!!d.configurable,("value"in d||d.initializer)&&(d.writable=!0),d=ez(a=tz(c=Oe(i).call(i)).call(c)).call(a,function(l,h){return h(e,t,l)||l},d),o&&d.initializer!==void 0&&(d.value=d.initializer?d.initializer.call(o):void 0,d.initializer=void 0),d.initializer===void 0?(f0(e,t,d),null):d}let Qf=function(e){return e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",e}({}),ta=function(e){return e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR",e}({}),Lr=function(e){return e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",e[e.REQ_DOWNGRADE_FALLBACK=27]="REQ_DOWNGRADE_FALLBACK",e}({}),Fe=function(e){return e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",e}({}),ye=function(e){return e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.DATASTREAM2_NOT_AVAILABLE=27]="DATASTREAM2_NOT_AVAILABLE",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.K_VOS_FALLBACK=30]="K_VOS_FALLBACK",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",e}({}),Ee=function(e){return e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed",e}({}),le=function(e){return e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.PRE_CONNECT_PC="pre_connect_pc",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_CONNECTING="datachannel_connecting",e.DATACHANNEL_FAILBACK="datachannel_failback",e.P2P_CONNECTION="p2p_connection",e.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",e.P2P_SUBSCRIBE="p2p_subscribe",e.P2P_UNSUBSCRIBE="p2p_unsubscribe",e.P2P_EXCHANGE_SDP="p2p_exchange_sdp",e.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",e.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",e.RECOVER_NOTIFICATION="recover_notification",e.VOS_FALLBACK="vos_fallback",e.VOS_FALLBACK_PROMISE="vos_fallback_promise",e}({}),Be=function(e){return e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.PRE_SUBSCRIBE="pre_subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SET_DUAL_STREAM_MODE="set_dual_stream_mode",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.CONFIGURE="configure",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag",e.DOWNGRADE_CODEC="downgrade_codec",e}({}),it=function(e){return e.WRTC_STATS="wrtc_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats",e}({}),Ke=function(e){return e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list",e.ENABLE_MULTI_STREAM="enable_multi_stream",e}({}),Je=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({}),ht=function(e){return e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",e.ON_FALLBACK="websocket:on_fallback",e}({});function L_(e){if(typeof e!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(e))throw I.error("Invalid Channel Name ".concat(e)),new $(O.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function Mc(e){if(t=e,!(typeof t=="number"&&Math.floor(t)===t&&0<=t&&t<=4294967295||DN(e,1,255)))throw new $(O.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var t;typeof e=="string"&&I.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let xu=function(e){return e.TRANSCODE="mix_streaming",e.RAW="raw_streaming",e}({});const GP={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},IT={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function WP(e,t){Ar(e.url,"".concat(t,".url"),1,1e3,!1),_r(e.x)||Ai(e.x,"".concat(t,".x"),0,1e4),_r(e.y)||Ai(e.y,"".concat(t,".y"),0,1e4),_r(e.width)||Ai(e.width,"".concat(t,".width"),0,1e4),_r(e.height)||Ai(e.height,"".concat(t,".height"),0,1e4),_r(e.zOrder)||Ai(e.zOrder,"".concat(t,".zOrder"),0,255),_r(e.alpha)||Ai(e.alpha,"".concat(t,".alpha"),0,1,!1)}const Fh={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""};let Al=function(e){return e.WARNING="@live_uap-warning",e.ERROR="@line_uap-error",e.PUBLISH_STREAM_STATUS="@live_uap-publish-status",e.WORKER_STATUS="@live_uap-worker-status",e.REQUEST_NEW_ADDRESS="@live_uap-request-address",e}({}),Gr=function(e){return e.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",e}({}),qr=function(e){return e[e.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",e[e.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",e[e.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",e[e.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",e[e.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",e[e.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",e[e.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",e[e.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",e[e.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",e[e.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",e[e.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",e[e.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",e[e.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",e[e.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",e[e.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",e[e.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",e}({});function zo(e){if(!e.channelName)throw new $(O.INVALID_PARAMS,"invalid channelName in info");if(typeof e.uid!="number")throw new $(O.INVALID_PARAMS,"invalid uid in info, uid must be a number");return e.token&&Ar(e.token,"info.token",1,2047),Mc(e.uid),L_(e.channelName),!0}let gn=function(e){return e[e.SetSdkProfile=0]="SetSdkProfile",e[e.SetSourceChannel=1]="SetSourceChannel",e[e.SetSourceUserId=2]="SetSourceUserId",e[e.SetDestChannel=3]="SetDestChannel",e[e.StartPacketTransfer=4]="StartPacketTransfer",e[e.StopPacketTransfer=5]="StopPacketTransfer",e[e.UpdateDestChannel=6]="UpdateDestChannel",e[e.Reconnect=7]="Reconnect",e[e.SetVideoProfile=8]="SetVideoProfile",e}({}),An=function(e){return e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",e}({}),lo=function(e){return e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",e}({}),_i=function(e){return e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",e}({}),_t=function(e){return e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low",e}({}),Rr=function(e){return e.DISCONNECT="disconnect",e.CONNECTION_STATE_CHANGE="connection-state-change",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGE="stream-type-change",e.IS_P2P_DISCONNECTED="is-p2p-dis",e.DISCONNECT_P2P="dis-p2p",e.REQUEST_NEW_GATEWAY_LIST="req-gate-url",e.NEED_RENEW_SESSION="need-sid",e.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",e.JOIN_RESPONSE="join-response",e.RESET_CONNECTION_EVENTS="reset-connection-events",e.PRE_CONNECT_PC="pre-connect_pc",e.UPDATE_GATEWAY_CONFIG="update-gateway-config",e.VOS_FALLBACK="vos-fallback",e.VOS_FALLBACK_PROMISE="vos-fallback-promise",e.RESET_SIGNAL="reset-signal",e.DATACHANNEL_FAILBACK="datachannel-failback",e}({}),Xr=function(e){return e.P2P_DISCONNECTED="P2P_DISCONNECTED",e.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",e.TIMEOUT="TIMEOUT",e.UNKNOWN_REASON="UNKNOWN_REASON",e}({}),gt=function(e){return e[e.Nothing=0]="Nothing",e[e.Audio=1]="Audio",e[e.LwoVideo=2]="LwoVideo",e[e.Video=4]="Video",e[e.Data=8]="Data",e[e.DataStream0=256]="DataStream0",e[e.DataStream1=512]="DataStream1",e[e.DataStream2=1024]="DataStream2",e[e.DataStream3=2048]="DataStream3",e[e.DataStream4=4096]="DataStream4",e[e.DataStream5=8192]="DataStream5",e[e.DataStream6=16384]="DataStream6",e[e.DataStream7=32768]="DataStream7",e}({}),mi=function(e){return e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS",e}({});const Zn=[mi.AFRICA,mi.ASIA,mi.CHINA,mi.EUROPE,mi.GLOBAL,mi.INDIA,mi.JAPAN,mi.NORTH_AMERICA,mi.OCEANIA,mi.OVERSEA,mi.SOUTH_AMERICA];let wn=function(e){return e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL",e}({});const Aa={CHINA:{},ASIA:{CODE:wn.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:wn.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:wn.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:wn.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:wn.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:wn.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:wn.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:wn.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:wn.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:wn.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:wn.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:wn.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:wn.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};Nu&&(Aa.CHINA={CODE:wn.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let Uc=function(e){return e.UPDATE_BITRATE_LIMIT="update_bitrate_limit",e.UPDATE_CLIENT_ROLE_OPTIONS="update_client_role_options",e.UPDATE_REMOTE_VIDEO_STREAM_TYPE="update_remote_video_stream_type",e.FALLBACK_TO_HLS="fallback_to_hls",e.UPDATE_VOS_CONFIGURE="update_vos_configure",e}({});function HP(e){return!!e&&!(!e.uplink||!e.id)&&e.uplink.max_bitrate!==void 0&&e.uplink.min_bitrate!==void 0}class AT extends Vi{constructor(t,i){super(),M(this,"onICEConnectionStateChange",void 0),M(this,"onConnectionStateChange",void 0),M(this,"onDTLSTransportStateChange",void 0),M(this,"onDTLSTransportError",void 0),M(this,"onICETransportStateChange",void 0),M(this,"onFirstAudioReceived",void 0),M(this,"onFirstVideoReceived",void 0),M(this,"onFirstAudioDecoded",void 0),M(this,"onFirstVideoDecoded",void 0),M(this,"onFirstVideoRender",void 0),M(this,"onFirstVideoBufferReady",void 0),M(this,"onFirstVideoDecodedTimeout",void 0),M(this,"onSelectedLocalCandidateChanged",void 0),M(this,"onSelectedRemoteCandidateChanged",void 0),M(this,"onICECandidateError",void 0),M(this,"getLocalVideoStats",void 0)}}class ke extends AT{constructor(t,i){super(t,i),M(this,"establishPromise",void 0)}}let be=function(e){return e.VIDEO="video",e.AUDIO="audio",e}({}),Ir=function(e){return e.UDP_RELAY="udp_relay",e.UDP_TCP_RELAY="udp_tcp_relay",e.TCP_RELAY="tcp_relay",e.RELAY="relay",e}({}),wl=function(e){return e[e.FIRST_CONNECTION=0]="FIRST_CONNECTION",e[e.UDP_TCP_RESTART=1]="UDP_TCP_RESTART",e[e.RELAY_RESTART=2]="RELAY_RESTART",e[e.TCP_RESTART=3]="TCP_RESTART",e[e.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",e[e.OLD_RESTART=11]="OLD_RESTART",e[e.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",e}({});const Se=["disconnected","failed"];let ue=function(e){return e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack",e}({}),we=function(e){return e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected",e}({}),xe=function(e){return e.AudioMetadata="audioMetadata",e.AudioPts="audioPts",e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestRePublishDataChannel="requestRePublishDataChannel",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.RequestUpload="requestUpload",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState",e.LocalCandidate="LocalCandidate",e.RequestP2PMuteLocal="requestP2PMuteLocal",e.RequestP2PUnPublish="RequestP2PUnPublish",e.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",e.RequestP2PMuteRemote="RequestP2PMuteRemote",e.RequestP2PRestartICE="RequestP2PRestartICE",e.FirstVideoPreRender="FirstVideoPreRender",e.FirstVideoBufferReady="FirstVideoBufferReady",e}({}),Kn=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),sr=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({}),br=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),gr=function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e}({}),$i=function(e){return e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback",e.PRE_CONNECT_PC="transmitter:pre_connect_pc",e}({}),$n=function(e){return e.CAMERA_CHANGED="camera-changed",e.MICROPHONE_CHANGED="microphone-changed",e.PLAYBACK_DEVICE_CHANGED="playback-device-changed",e.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",e.AUTOPLAY_FAILED="autoplay-failed",e.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",e.SECURITY_POLICY_VIOLATION="security-policy-violation",e}({}),Yn=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),Os=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),ar=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({}),cr=function(e){return e.CALL="call",e.CANDIDATE="candidate",e.PUBLISH="publish",e.UNPUBLISH="unpublish",e.CONTROL="control",e.RESTART_ICE="restart_ice",e.ACK="ack",e.RESPONSE="response",e.JOIN="join",e.CHECK="check",e}({}),sc=function(e){return e.ABORT="abort",e}({}),Bh=function(e){return e.MUTE_LOCAL_AUDIO="mute_local_audio",e.MUTE_LOCAL_VIDEO="mute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video",e}({}),pz=function(e){return e.P2P_TOKEN_TIMEOUT="p2p_token_timeout",e.P2P_TOKEN_CHANGED="p2p_token_changed",e}({});const Zf={[Qf.ACCESS_POINT]:{[Fe.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[Fe.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[Fe.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[Fe.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[Fe.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[Fe.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[Fe.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[Fe.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[Fe.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[Fe.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[Fe.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[Fe.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[Fe.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[Fe.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[Fe.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[Fe.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[Fe.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[Fe.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[Qf.UNILBS]:{[Lr.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[Lr.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[Lr.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[Lr.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[Lr.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[Lr.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[Lr.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[Lr.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[Lr.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[Lr.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[Lr.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[Lr.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1},[Lr.REQ_DOWNGRADE_FALLBACK]:{desc:"request downgrade fallback",retry:!1}},[Qf.STRING_UID_ALLOCATOR]:{[ta.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[ta.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[ta.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function $f(e){const t=Zf[Math.floor(e/1e4)];if(!t)return{desc:"unknown error",retry:!1};const i=t[e%1e4];if(!i){if(Math.floor(e/1e4)===Qf.ACCESS_POINT){const r=e%1e4;if(r.toString()[0]==="1")return{desc:e.toString(),retry:!1};if(r.toString()[0]==="2")return{desc:e.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return i}const k_={[ye.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[ye.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[ye.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[ye.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[ye.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[ye.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[ye.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[ye.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[ye.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[ye.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[ye.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[ye.DATASTREAM2_NOT_AVAILABLE]:{desc:"DATASTREAM2_NOT_AVAILABLE",action:"quit"},[ye.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[ye.K_VOS_FALLBACK]:{desc:"K_VOS_FALLBACK",action:"tryNext"},[ye.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[ye.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[ye.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[ye.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[ye.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[ye.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[ye.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[ye.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[ye.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[ye.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[ye.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[ye.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[ye.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[ye.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[ye.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[ye.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[ye.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[ye.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[ye.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[ye.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[ye.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[ye.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[ye.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[ye.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[ye.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[ye.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[ye.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[ye.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[ye.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[ye.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[ye.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[ye.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[ye.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[ye.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[ye.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[ye.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[ye.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[ye.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[ye.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[ye.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[ye.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[ye.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[ye.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[ye.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[ye.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[ye.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[ye.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[ye.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[ye.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[ye.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[ye.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function jh(e){return k_[e]||{desc:"UNKNOWN_ERROR_".concat(e),action:"failed"}}function nC(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function wT(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?nC(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):nC(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}function KP(e,t){if(typeof e=="string")return e;const{proxy:i,host:r,port:o}=e;if(t){const s=B("JOIN_GATEWAY_FALLBACK_PORT")||443;return s===443?"wss://".concat(r,"/ws/?p=").concat(Number(o)+150):"wss://".concat(r,":").concat(s,"/ws/?p=").concat(Number(o)+150)}return i?"wss://".concat(i,"/ws/?h=").concat(r,"&p=").concat(o):"wss://".concat(r,":").concat(o)}const _z=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,fz=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,mz=/wss:\/\/(.+):([0-9]+)\/?/,Ez=/wss:\/\/(.[^\/]+)\/?/;let gz=0;class JU{constructor(t,i){M(this,"id",0),M(this,"store",void 0),M(this,"recordIndex",void 0),M(this,"websockets",[]),M(this,"try443PortDuration",2e3),M(this,"forceCloseWSDuration",5e3),M(this,"try443PortTimeout",null),M(this,"forceCloseTimeout",null),M(this,"isTry443PortFailed",!1),M(this,"isNormalPortFailed",!1),M(this,"useDoubleDomain",!1),M(this,"useProxy",!1),M(this,"startTime",Date.now()),this.id=++gz,this.try443PortDuration=B("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=t||5e3,this.store=i}closeAllWebsockets(){this.websockets.forEach(t=>{t.onopen=null,t.onclose=null,t.onmessage=null,t.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout),this.forceCloseTimeout=null,this.try443PortTimeout=null}logger(){var t;const i=Date.now()-this.startTime;for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];I.debug("[choose-best-ws ".concat((t=this.store)===null||t===void 0?void 0:t.clientId," ").concat(this.id,"] ").concat(i,"ms:"),...o)}createWebSocket(t,i,r){this.logger("createWebSocket:",t,{isTry443Port:i,hasTimeoutDetection:r});const o=B("GATEWAY_DOMAINS"),s=Date.now(),a=[],c=o.find(f=>{var m;return z(m=t.host).call(m,f)});c||(this.useDoubleDomain=!1);const d=[];if(this.useDoubleDomain)o.forEach(f=>{d.push(KP(wT(wT({},t),{},{host:t.host.replace(c,f)}),i))});else{const f=wT({},t);if(i&&c){const m=o.find(g=>g!==c);m&&(f.host=f.host.replace(c,m))}d.push(KP(f,i))}try{d.forEach(f=>{const m=new WebSocket(f);m.binaryType="arraybuffer",a.push(m),this.logger("ws is connecting:",m.url)})}catch(f){if(this.logger("ws create failed"),a.forEach(m=>m.close()),a.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(t,i,r);if(!i&&Number(t.port)!==443)return this.createWebSocket(t,!0,r);throw new $(O.WS_ERR,"init websocket failed! Error: ".concat(f.toString()))}const l=Ih();this.store&&this.store.recordJoinChannelService({urls:a.map(f=>f.url),service:"gateway"},this.recordIndex),a.forEach(f=>{f.onopen=()=>{this.logger("onopen: ws ".concat(f.url," open cost ").concat(Date.now()-s,"ms")),this.websockets.forEach(m=>{m!==f&&(m.onopen=null,m.onclose=null,m.onmessage=null,m.close(),this.logger("close backup websocket: ".concat(m.url)))}),this.websockets.length=0,l.resolve(f)},f.onclose=m=>{this.logger("onclose: ws ".concat(f.url," closed cost ").concat(Date.now()-s,"ms state: ").concat(f.readyState));const g=a.every(S=>S.readyState===WebSocket.CLOSED||S.readyState===WebSocket.CLOSING);this.logger("".concat(i?"443":"47xx"," websocket closed, all failed: ").concat(g)),g&&(i||this.isTry443PortFailed||this.useProxy)?(this.logger("onclose: all websocket is closed, ".concat(m.reason)),l.reject({code:m.code,reason:Xr.A_ROUND_WS_FAILED})):!i&&g&&!this.isNormalPortFailed&&this.try443PortTimeout&&(this.logger("all 47xx websocket is closed, try 443 port"),this.clearTimeout(),p()),i?this.isTry443PortFailed=g:this.isNormalPortFailed=g},f.onmessage=m=>this.logger("".concat(f.url," onmessage: ").concat(m.data))}),this.websockets.push(...a);const h=()=>{this.websockets.forEach(f=>f.readyState!==WebSocket.OPEN&&f.close())},p=()=>{if(l.isResolved)return h();ii().os===pt.MAC_OS&&Ht()&&h(),this.createWebSocket(t,!0,!0).then(f=>{l.resolve(f)}).catch(f=>{this.isNormalPortFailed&&l.reject(f),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",l.isResolved),this.forceCloseTimeout=null,h()},this.forceCloseWSDuration)};return r||(()=>{if(i||this.useProxy)return this.logger("add 5s timeout at ".concat(i?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(()=>{this.forceCloseTimeout=null,h()},this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{this.logger("2s timeout, isWebsocket created: ",l.isResolved),this.try443PortTimeout=null,p()},this.try443PortDuration)})(),l.promise}chooseBestWebsocket(t,i,r,o){return this.useDoubleDomain=!!i,typeof t=="string"&&(t=function(s){let a,c,d;return[,a,c,d]=s.match(_z)||[],a||([,c,d]=s.match(fz)||[]),c&&d||([,c,d]=s.match(mz)||[]),c&&d||([,c]=s.match(Ez)||[]),c||I.warning("un-destructible url: ",s),{proxy:a,host:c,port:d||"443"}}(t)),this.recordIndex=o,this.useProxy=!!t.proxy,r&&this.useProxy&&(I.warn("cannot use 443 only when use proxy"),r=!1),this.createWebSocket(t,!!r,!1).finally(()=>this.clearTimeout())}}function YP(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}class oC extends Vi{get url(){return this.websocket&&this.websocket.url||this._websocketUrl}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var i;z(i=["tryNext","recover"]).call(i,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(ht.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(ht.CONNECTED):this._state==="closed"?this.emit(ht.CLOSED):this._state==="failed"&&this.emit(ht.FAILED))}resetReconnectCount(t){I.debug("websocket reset reconnect count, reason: "+t),this.reconnectCount=0}constructor(t,i){let r=arguments.length>2&&arguments[2]!==void 0&&arguments[2],o=arguments.length>3&&arguments[3]!==void 0&&arguments[3],s=arguments.length>4&&arguments[4]!==void 0&&arguments[4],a=arguments.length>5?arguments[5]:void 0;super(),M(this,"_websocketUrl",null),M(this,"connectionID",0),M(this,"currentURLIndex",0),M(this,"urls",[]),M(this,"_reconnectMode","tryNext"),M(this,"reconnectReason",void 0),M(this,"_initMutex",void 0),M(this,"name",void 0),M(this,"_state","closed"),M(this,"reconnectInterrupter",void 0),M(this,"websocket",void 0),M(this,"retryConfig",void 0),M(this,"reconnectCount",0),M(this,"forceCloseTimeout",5e3),M(this,"onlineReconnectListener",void 0),M(this,"useCompress",void 0),M(this,"tryDoubleDomain",!1),M(this,"use443PortOnly",!1),M(this,"wsInflateLength",0),M(this,"wsDeflateLength",0),M(this,"closeEstablishingWs",()=>{}),M(this,"store",void 0),M(this,"joinGatewayRecordIndex",void 0),this.store=a,this.name=t,this.retryConfig=function(p){for(var f=1;f<arguments.length;f++){var m=arguments[f]!=null?arguments[f]:{};f%2?YP(Object(m),!0).forEach(function(g){M(p,g,m[g])}):Object.getOwnPropertyDescriptors?Object.defineProperties(p,Object.getOwnPropertyDescriptors(m)):YP(Object(m)).forEach(function(g){Object.defineProperty(p,g,Object.getOwnPropertyDescriptor(m,g))})}return p}({},i),this.useCompress=r,this.tryDoubleDomain=o,this.use443PortOnly=s,this._initMutex=new jr("websocket",a?a.clientId:void 0);const{timeout:c,timeoutFactor:d}=i,l=Math.max(300,Math.floor(3*c/5)),h=Math.max(1.2,Math.floor(8*d)/10);yn.ONLINE&&(this.retryConfig.timeout=l,this.retryConfig.timeoutFactor=h),fi.on(fr.NETWORK_STATE_CHANGE,(p,f)=>{p!==f&&(this.resetReconnectCount("network state change: ".concat(f," -> ").concat(p)),p===yn.ONLINE?(this.retryConfig.timeout=l,this.retryConfig.timeoutFactor=h):(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d))})}getConnection(){return this.websocket||void 0}async init(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const r=await this._initMutex.lock();this._reconnectMode="tryNext",this.forceCloseTimeout=i,this.urls=t,this.state="connecting";try{var o;const s=Ih(),a=this.urls[this.currentURLIndex];(o=this.store)===null||o===void 0||o.beforeConnect(),function(c){return!(kh()||B("USE_NEW_TOKEN")||!B("ENABLE_PREALLOC_PC")&&(c==null||!c.autoSubscribe||B("FORCE_DISABLE_AUTO_SUB")))}(this.store)&&this.emit($i.PRE_CONNECT_PC),this.createWebSocketConnection(a).then(s.resolve).catch(s.reject),this.once(ht.CLOSED,()=>{s.reject(new oe(O.WS_DISCONNECT))}),this.once(ht.CONNECTED,s.resolve),await s.promise}catch{}finally{r()}}close(t,i){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const r=this.websocket;i?setTimeout(()=>r.close(),500):r.close(),this.websocket=void 0,this._websocketUrl=null}this.state=t?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(t,i){if(!this.websocket)return void I.warning("[".concat(this.name,"] can not reconnect, no websocket"));t!==void 0&&(this.reconnectMode=t),I.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(i)]},this.joinGatewayRecordIndex);const r=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),r&&r.bind(this.websocket)({code:9999,reason:i})}sendMessage(t){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new oe(O.WS_ABORT,"websocket is not ready");try{i||(t=JSON.stringify(t)),this.websocket.send(t)}catch(r){throw new oe(O.WS_ERR,"send websocket message error"+r.toString())}}setWsInflateData(t){this.wsDeflateLength=this.wsDeflateLength+t.originLength,this.wsInflateLength=this.wsInflateLength+t.compressedLength}getWsInflateData(){const t=this.wsInflateLength,i=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:t,wsDeflateLength:i}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(t){var i;const r=Ih();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const o=h=>{var p;(p=this.store)===null||p===void 0||p.signalChannelOpen(),I.debug("[".concat(this.name,"] websocket opened:"),h),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),r.resolve()},s=async h=>{var p;if(I.debug("[".concat(this.name,"] websocket close ").concat((p=this.websocket)===null||p===void 0?void 0:p.url,", code: ").concat(h.code,", reason: ").concat(h.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)r.reject(new oe(O.WS_DISCONNECT,"websocket close: ".concat(h.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=h.reason,this.state="reconnecting");const f=co(this,ht.WILL_RECONNECT,this.reconnectMode,h.reason)||this.reconnectMode,m=await this.reconnectWithAction(f);if(this.state==="closed")return void I.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!m)return r.reject(new oe(O.WS_DISCONNECT,"websocket reconnect failed: ".concat(h.code))),this.close(!0);r.resolve()}},a=h=>{this.emit(ht.ON_MESSAGE,h)},c=h=>{I.warn("[".concat(this.connectionID,"] ws open error ").concat(h))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),B("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(t=B("GATEWAY_WSS_ADDRESS")),I.debug("[".concat(this.name,"] start connect, url:"),t);const d=(i=this.store)===null||i===void 0?void 0:i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var l;this._websocketUrl=KP(t);const h=await this.chooseBestWebsocketConnection(t);this.websocket=h,o&&o(this.websocket.url),this.websocket.onclose=s,this.websocket.onmessage=a,this.websocket.onerror=c,(l=this.store)===null||l===void 0||l.recordJoinChannelService({endTs:Date.now(),status:"success"},d),this.joinGatewayRecordIndex=d}catch(h){const p=this.state==="closed",f=h instanceof oe,m=f&&h.code===O.WS_ABORT,g=f&&h.code===O.WS_ERR,S=f?h.message:h&&(h.reason||h.toString());I.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(S)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:m?"aborted":"error",errors:[h]},d),p||g?(r.reject(p?new oe(O.WS_DISCONNECT,"websocket is closed: ".concat(S)):new oe(O.WS_ERR,"init websocket failed: ".concat(S))),g&&I.error("[".concat(this.name,"] init websocket failed: ").concat(S))):s&&s(h)}return r.promise}async reconnectWithAction(t){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;I.warning("[choose-best-ws] action: =>",t),this.onlineReconnectListener||fi.isOnline||!fi.onlineWaiter||(this.onlineReconnectListener=fi.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let r=!0;if(this.reconnectInterrupter=()=>r=!1,i){const a=fa(this.reconnectCount,this.retryConfig);I.debug("[".concat(this.name,"] wait ").concat(a,"ms to reconnect websocket, mode: ").concat(t)),await Z.race([vt(a),this.onlineReconnectListener||new Z(()=>{})])}if(this._state==="closed"||!r)return!1;this.reconnectCount+=1;const o=async(a,c)=>{this.emit(ht.RECONNECT_CREATE_CONNECTION,c),await this.createWebSocketConnection(a)};try{if(t==="retry")await o(this.urls[this.currentURLIndex],t);else if(t==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);I.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),await o(this.urls[this.currentURLIndex],t)}else t==="recover"&&(I.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.urls=await yt(this,ht.REQUEST_NEW_URLS),this.currentURLIndex=0,await o(this.urls[this.currentURLIndex],t))}catch(a){var s;I.error("[".concat(this.name,"] reconnect failed ").concat(a&&a.toString()));const c=a==null||(s=a.data)===null||s===void 0?void 0:s.desc;if(Array.isArray(c)){if(z(c).call(c,"dynamic key expired"))return this.emit(ht.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1;if(z(c).call(c,"request downgrade fallback"))return this.emit(ht.ON_FALLBACK),!1}return this.reconnectWithAction(t,i)}return!0}}class M_ extends oC{constructor(t,i){super(t,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,i){const r=Ih(),o=function(a,c){return new JU(a,c)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{I.debug("[choose-best-ws] close establishing websockets"),o.closeAllWebsockets(),r.reject(new oe(O.WS_ABORT,"choose best websocket aborted"))};const s=B("GATEWAY_DOMAINS");return I.debug("[choose-best-ws] currentDomain: ",t,", domains: ",s,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),o.chooseBestWebsocket(t,this.tryDoubleDomain,this.use443PortOnly,i).then(r.resolve).catch(r.reject),r.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class em extends oC{constructor(t,i){super(t,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,i){return new Z((r,o)=>{let s=!1;const a=[];this.closeEstablishingWs=()=>{I.debug("[choose-best-ws] close establishing websockets"),a.forEach(g=>{g.onclose=null,g.onopen=null,g.onmessage=null,g.close()}),o(new oe(O.WS_ABORT,"choose best websocket aborted"))};const c=B("GATEWAY_DOMAINS");let d;const l=t.indexOf("?h="),h=c.find(g=>l!==-1?z(t).call(t,g,l):z(t).call(t,g));I.debug("[choose-best-ws] currentDomain: ",h,", domains: ",c);let p=!this.tryDoubleDomain||!h;if(!p&&h){var f;const g=Date.now();try{c.forEach(S=>{const T=l===-1?t.replace(h,S):t.substr(0,l)+t.substr(l).replace(h,S),C=new WebSocket(T);C.binaryType="arraybuffer",a.push(C),I.debug("[choose-best-ws] ws is connecting:",C.url)})}catch{for(I.debug("[choose-best-ws] ws create failed, fallback to single url"),a.forEach(T=>T.close());a.length;)a.pop();p=!0}(f=this.store)===null||f===void 0||f.recordJoinChannelService({urls:a.map(S=>S.url),service:"gateway"},i),a.forEach(S=>{S.onopen=()=>{if(s)return;const T=Date.now()-g;I.debug("[choose-best-ws] ws open cost ".concat(T,"ms")),a.filter(C=>C!==S).forEach(C=>{I.debug("[choose-best-ws]close backup websocket: ".concat(C.url)),C.close()}),s=!0,r(S)},S.onclose=T=>{d=T,!s&&(a.find(C=>!(C.readyState===WebSocket.CLOSED||C.readyState===WebSocket.CLOSING))||(I.debug("[choose-best-ws] all websocket is closed"),s=!0,o(d)))},S.onmessage=T=>{I.debug("[choose-best-ws]".concat(S.url," onmessage: ").concat(T.data))}}),vt(this.forceCloseTimeout).then(()=>{a.forEach(S=>{S.readyState!==WebSocket.OPEN&&S.close()})})}if(p){var m;let g;I.debug("[choose-best-ws] use single url: ",t),(m=this.store)===null||m===void 0||m.recordJoinChannelService({urls:[t],service:"gateway"},i);try{g=new WebSocket(t),a.push(g),g.binaryType="arraybuffer"}catch(S){const T=new oe(O.WS_ERR,"init websocket failed! Error: ".concat(S.toString()));return I.error("[".concat(this.name,"]").concat(T)),void o(T)}g.onopen=()=>{r(g)},g.onclose=S=>{o(S)},g.onmessage=S=>{I.debug("[choose-best-ws]".concat(g.url," onmessage: ").concat(S.data))},vt(this.forceCloseTimeout).then(()=>{g&&g.readyState!==WebSocket.OPEN&&g.close()})}}).then(r=>(this.closeEstablishingWs=void 0,r)).catch(r=>{throw this.closeEstablishingWs=void 0,r})}}class QU extends Vi{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===Ee.CONNECTED?this.emit(le.WS_CONNECTED):t===Ee.RECONNECTING?this.emit(le.WS_RECONNECTING,this._websocketReconnectReason):t===Ee.CLOSED&&this.emit(le.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,i){super(),M(this,"__name__","AgoraRTCSignal"),M(this,"_disconnectedReason",void 0),M(this,"_websocketReconnectReason",void 0),M(this,"_connectionState",Ee.CLOSED),M(this,"reconnectToken",void 0),M(this,"websocket",void 0),M(this,"openConnectionTime",void 0),M(this,"clientId",void 0),M(this,"lastMsgTime",Date.now()),M(this,"uploadCache",[]),M(this,"uploadCacheInterval",void 0),M(this,"rttRolling",new kf(5)),M(this,"pingpongTimer",void 0),M(this,"wsInflateDataTimer",void 0),M(this,"pingpongTimeoutCount",0),M(this,"ortc",void 0),M(this,"joinResponse",void 0),M(this,"multiIpOption",void 0),M(this,"initError",void 0),M(this,"spec",void 0),M(this,"store",void 0),M(this,"onWebsocketMessage",r=>{if(r.data instanceof ArrayBuffer)return void this.emit(le.ON_BINARY_DATA,r.data);const o=JSON.parse(r.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(o,"_id")){const s="res-@".concat(o._id);this.emit(s,o._result,o._message)}else if(Object.prototype.hasOwnProperty.call(o,"_type")){if(this.emit(o._type,o._message),o._type===Ke.ON_NOTIFICATION&&this.handleNotification(o._message),o._type===Ke.ON_USER_BANNED)switch(o._message.error_code){case 14:this.close(bt.UID_BANNED);break;case 15:this.close(bt.IP_BANNED);break;case 16:this.close(bt.CHANNEL_BANNED)}if(o._type===Ke.ON_USER_LICENSE_BANNED)switch(o._message.error_code){case ye.ERR_LICENSE_MISSING:this.close(bt.LICENSE_MISSING);break;case ye.ERR_LICENSE_EXPIRED:this.close(bt.LICENSE_EXPIRED);break;case ye.ERR_LICENSE_MINUTES_EXCEEDED:this.close(bt.LICENSE_MINUTES_EXCEEDED);break;case ye.ERR_LICENSE_PERIOD_INVALID:this.close(bt.LICENSE_PERIOD_INVALID);break;case ye.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(bt.LICENSE_MULTIPLE_SDK_SERVICE);break;case ye.ERR_LICENSE_ILLEGAL:this.close(bt.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=t.clientId,this.spec=t,this.store=i,this.websocket=new M_("gateway-".concat(this.clientId),this.spec.retryConfig,!0,B("JOIN_GATEWAY_USE_DUAL_DOMAIN"),B("JOIN_GATEWAY_USE_443PORT_ONLY"),i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Ee.CONNECTED&&this.reconnect("retry",Gi.OFFLINE)})}async request(t,i,r,o){const s=li(6,""),a={_id:s,_type:t,_message:i},c=this.websocket.connectionID,d=()=>new Z((g,S)=>{if(this.connectionState===Ee.CONNECTED)return g();const T=()=>{this.off(le.WS_CLOSED,C),g()},C=()=>{this.off(le.WS_CONNECTED,T),S(new $(O.WS_ABORT))};this.once(le.WS_CONNECTED,T),this.once(le.WS_CLOSED,C),t!==Be.PUBLISH&&t!==Be.PUBLISH_DATASTREAM&&t!==Be.SUBSCRIBE&&t!==Be.SUBSCRIBE_DATASTREAM&&t!==Be.UNSUBSCRIBE&&t!==Be.UNSUBSCRIBE_DATASTREAM&&t!==Be.UNPUBLISH&&t!==Be.UNPUBLISH_DATASTREAM&&t!==Be.CONTROL&&t!==Be.RESTART_ICE||this.once(le.DISCONNECT_P2P,()=>{S(new $(O.DISCONNECT_P2P))}),t!==Be.PUBLISH&&t!==Be.RESTART_ICE||this.once(le.ABORT_P2P_EXECUTION,()=>{S(new $(O.DISCONNECT_P2P))})});if(this.connectionState!==Ee.CONNECTING&&this.connectionState!==Ee.RECONNECTING||t===Be.JOIN||t===Be.REJOIN||await d(),this.websocket.sendMessage(a,!0),o)return;const l=new Z((g,S)=>{let T=!1;const C=(D,x)=>{T=!0,g({isSuccess:D==="success",message:x||{}}),this.off(le.WS_CLOSED,b),this.off(le.WS_RECONNECTING,b),this.emit(le.REQUEST_SUCCESS,t,i)};this.once("res-@".concat(s),C);const b=()=>{S(new $(O.WS_ABORT,"type: ".concat(t))),this.off(le.WS_CLOSED,b),this.off(le.WS_RECONNECTING,b),this.off("res-@".concat(s),C)};this.once(le.WS_CLOSED,b),this.once(le.WS_RECONNECTING,b),vt(B("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==c||T||(I.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(le.REQUEST_TIMEOUT,t,i))})});let h=null;try{h=await l}catch(g){if(this.connectionState===Ee.CLOSED||t===Be.LEAVE)throw new $(O.WS_ABORT);return!this.spec.forceWaitGatewayResponse||r?g.throw():t===Be.JOIN||t===Be.REJOIN?null:(await d(),await this.request(t,i))}if(h.isSuccess)return h.message;const p=Number(h.message.error_code||h.message.code),f=jh(p),m=new $(O.UNEXPECTED_RESPONSE,"".concat(f.desc,": ").concat(h.message.error_str),{code:p,data:h.message,desc:f.desc});return f.action==="success"?h.message:(I.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(p,", message: ").concat(f.desc,", action: ").concat(f.action)),p===ye.ERR_TOO_MANY_BROADCASTERS?((t===Be.JOIN||t===Be.REJOIN)&&(this.initError=m,this.close()),m.throw()):f.action==="failed"?m.throw():f.action==="quit"?(this.initError=m,this.close(),m.throw()):(p===ye.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=h.message.option,I.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Gi.MULTI_IP)):this.reconnect(f.action,Gi.SERVER_ERROR),t===Be.JOIN||t===Be.REJOIN?null:await this.request(t,i)))}waitMessage(t,i){return new Z(r=>{const o=s=>{(!i||i(s))&&(this.off(t,o),r(s))};this.on(t,o)})}uploadWRTCStats(t){if(!this.store.sessionId)return void I.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(it.WRTC_STATS,i)}upload(t,i){const r={_type:t,_message:i};try{this.websocket.sendMessage(r)}catch{const s=B("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(r),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Ee.CONNECTED)return;const a=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(a._type,a._message)},B("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,i){const r={_type:t,_message:i};this.websocket.sendMessage(r)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Z((i,r)=>{this.once(le.WS_CONNECTED,()=>i(this.joinResponse)),this.once(le.WS_CLOSED,o=>r(this.initError||new $(O.WS_ABORT,o))),this.connectionState=Ee.CONNECTING,this.websocket.init(t).catch(r),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||bt.LEAVE,this.connectionState=Ee.CLOSED,I.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close()}async join(){if(!this.joinResponse){this.emit(le.ABORT_P2P_EXECUTION),this.store.signalConnected();const t=await yt(this,le.REQUEST_JOIN_INFO);this.store.joinReq();const i=await this.request(Be.JOIN,t);if(this.ortc=t==null?void 0:t.ortc,this.store.joinRep(),!i)return this.emit(le.REPORT_JOIN_GATEWAY,Xr.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(le.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Ee.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new $(O.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=Wi(this,le.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const i=await this.request(Be.REJOIN,t);return!!i&&(this.connectionState=Ee.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),i.peers&&i.peers.forEach(r=>{this.emit(Ke.ON_USER_ONLINE,{uid:r.uid}),r.audio&&this.emit(Ke.ON_ADD_AUDIO_STREAM,{uid:r.uid,uint_id:r.uint_id,audio:!0,ssrcId:r.audio_ssrc}),r.video&&this.emit(Ke.ON_ADD_VIDEO_STREAM,{uid:r.uid,uint_id:r.uint_id,video:!0,ssrcId:r.video_ssrc}),r.audio_mute?this.emit(Ke.MUTE_AUDIO,{uid:r.uid}):this.emit(Ke.UNMUTE_AUDIO,{uid:r.uid}),r.video_mute?this.emit(Ke.MUTE_VIDEO,{uid:r.uid}):this.emit(Ke.UNMUTE_VIDEO,{uid:r.uid}),r.audio_enable_local?this.emit(Ke.ENABLE_LOCAL_AUDIO,{uid:r.uid}):this.emit(Ke.DISABLE_LOCAL_AUDIO,{uid:r.uid}),r.video_enable_local?this.emit(Ke.ENABLE_LOCAL_VIDEO,{uid:r.uid}):this.emit(Ke.DISABLE_LOCAL_VIDEO,{uid:r.uid}),r.audio||r.video||this.emit(Ke.ON_REMOVE_STREAM,{uid:r.uid,uint_id:r.uint_id})}),!0)}reconnect(t,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,i)}async downgradeCodec(t){if(!this.ortc)return!1;const i={downgrade_codec:t,ortc:this.ortc};return!!await this.request(Be.DOWNGRADE_CODEC,i)}handleNotification(t){I.debug("[".concat(this.clientId,"] receive notification: "),t);const i=jh(t.code);if(t.code===28&&"detail"in t&&(I.info("[".concat(this.clientId,"] receive recover notification: "),t.detail),this.emit(le.RECOVER_NOTIFICATION,t.detail)),i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?t.code===ye.ERR_REPEAT_JOIN_CHANNEL&&B("IGNORE_UID_CHECK")?void this.close(bt.UID_CONFLICT):(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(bt.UID_BANNED),void this.close()):t.code===ye.K_VOS_FALLBACK&&"detail"in t?(I.info("[".concat(this.clientId,"] receive vos fallback notification: "),t.detail),t.detail==="FALLBACKCN"&&B("ENABLE_QUALITY_FALLBACK")?void yt(this,le.VOS_FALLBACK_PROMISE,t.detail).then(()=>{this.reconnect("recover",i.desc)}).catch(r=>{I.debug("[".concat(this.clientId,"] cancel vos fallback cn, error: "),r)}):t.detail==="fallback_hls"&&B("ENABLE_FALLBACK_TO_HLS")?(this.emit(le.VOS_FALLBACK,t.detail),void this.close(bt.FALLBACK_TO_HLS)):this.reconnect(i.action,i.desc)):void this.reconnect(i.action,Gi.SERVER_ERROR);I.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=B("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=t&&(I.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>B("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Gi.TIMEOUT):this.request(Be.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const r=Date.now()-i;this.rttRolling.add(r),B("REPORT_STATS")&&this.send(Be.PING_BACK,{pingpongElapse:r})}).catch(r=>{})}handleWsInflateData(){const{wsInflateLength:t,wsDeflateLength:i}=this.websocket.getWsInflateData();t!==0&&i!==0&&this.upload(it.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:i,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(ht.RECONNECT_CREATE_CONNECTION,t=>{this.emit(le.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(ht.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(ht.CLOSED,()=>{this.connectionState=Ee.CLOSED}),this.websocket.on(ht.FAILED,()=>{this._disconnectedReason=bt.NETWORK_ERROR,this.connectionState=Ee.CLOSED}),this.websocket.on(ht.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===Ee.CONNECTED?this.connectionState=Ee.RECONNECTING:this.connectionState=Ee.CONNECTING}),this.websocket.on(ht.WILL_RECONNECT,(t,i,r)=>{const o=Wi(this,le.IS_P2P_DISCONNECTED),s=o||t!=="retry";o&&t==="retry"&&(I.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),t="tryNext",i=Xr.P2P_DISCONNECTED),s&&(I.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(t)),this.emit(le.REPORT_JOIN_GATEWAY,i||Xr.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(le.DISCONNECT_P2P)),r(t)}),this.websocket.on(ht.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(t=>{I.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",Gi.SERVER_ERROR)}):this.join().catch(t=>{if(this.emit(le.REPORT_JOIN_GATEWAY,t,this.url||""),t instanceof $){if(t.code===O.UNEXPECTED_RESPONSE&&t.data.code===ye.ERR_NO_AUTHORIZED)return this.initError=new $(O.TOKEN_EXPIRE,"dynamic key expired"),void this.close(bt.TOKEN_EXPIRE);I.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Gi.SERVER_ERROR):(this.initError=t,this.close())}})}),this.websocket.on(ht.REQUEST_NEW_URLS,(t,i)=>{yt(this,le.REQUEST_RECOVER,this.multiIpOption).then(t).catch(i)}),this.websocket.on(ht.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Ke.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on($i.PRE_CONNECT_PC,()=>{this.emit(le.PRE_CONNECT_PC)}),this.websocket.on(ht.ON_FALLBACK,()=>{B("ENABLE_FALLBACK_TO_HLS")&&this.emit(le.VOS_FALLBACK,"fallback_hls")})}}let Wr=function(e){return e.NATIVE_RTC="native_rtc",e.NATIVE_RTM="native_rtm",e.WEB_RTC="web_rtc",e.WEB_RTM="web_rtm",e}({}),kr=function(e){return e[e.CHOOSE_SERVER=11]="CHOOSE_SERVER",e[e.CLOUD_PROXY=18]="CLOUD_PROXY",e[e.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",e[e.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",e}({});function bT(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function tm(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?bT(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):bT(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let wa=0;function ia(e){const t=B("TURN_DOMAINS");wa=(wa+1)%t.length;const i=t[wa]||"edge.agora.io";return e.match(/^[\.\:\d]+$/)?"".concat(e.replace(/[^\d]/g,"-"),".").concat(i):(I.debug("Cannot recognized as ip address: ".concat(e,", use as host2")),e)}function im(e){try{const t=B("TURN_DOMAINS"),i=B("GATEWAY_DOMAINS").concat(t).find(r=>z(e).call(e,r));return i?e.split(".".concat(i))[0].replace(/-/g,"."):e}catch{return I.debug("serverUrlToIp error, fallback to url",e),e}}function Mo(e,t){e.addresses||(e.addresses=[]);const i=function(c,d){if(B("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return c.map(p=>{let{ip:f,port:m}=p;return{address:"".concat(f,":").concat(m)}});const l=B("GATEWAY_DOMAINS");let h=l[1]&&z(d).call(d,l[1])?1:0;return c.map(p=>{let{domain_prefix:f,port:m,ip:g}=p;if(f)return{address:"".concat(f,".").concat(l[h++%l.length],":").concat(m)};const S=/^[\.\:\d]+$/.test(g),T=S?"".concat(g.replace(/[^\d]/g,"-"),".").concat(l[h++%l.length],":").concat(m):"".concat(g,":").concat(m);return S||I.debug("Cannot recognized as ip address: ".concat(g,", use as host3")),{ip:g,port:m,address:T}})}(e.addresses,t),r=Array.isArray(e.detail)&&e.detail[18];if(r&&typeof r=="string"){const c=r.split(";");for(let d=0;d<c.length;d++){var o;const l=rr(o=c[d]).call(o);i[d]&&l&&(i[d].ip6=l)}}const s=e.detail&&e.detail.candidate;let a;if(s){const[c,d]=s.split(":");c&&d&&(a={port:Number(d),ip:c,address:"".concat(c,":").concat(d)})}return{gatewayAddrs:i,apGatewayAddress:a,uid:e.uid,cid:e.cid,cert:e.cert,vid:e.detail&&e.detail[8],uni_lbs_ip:e.detail&&e.detail[1],res:e,csIp:e.detail&&e.detail[502]}}function qo(e){return typeof e=="number"?e:e.exact||e.ideal||e.max||e.min||0}function OT(e){const t=e._encoderConfig;if(!t)return{};const i={resolution:t.width&&t.height?"".concat(qo(t.width),"x").concat(qo(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return typeof t.frameRate=="number"?(i.maxFrameRate=t.frameRate,i.minFrameRate=t.frameRate):t.frameRate&&(i.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,i.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),i}function Gh(e){return e>=0&&e<.17?1:e>=.17&&e<.36?2:e>=.36&&e<.59?3:e>=.59&&e<=1?4:e>1?5:0}function rm(e,t){let i,r,o;switch(t){case kr.CHOOSE_SERVER:r=4096,o="choose server";break;case kr.CLOUD_PROXY:r=1048576,o="proxy";break;case kr.CLOUD_PROXY_5:r=4194304,o="proxy5";break;case kr.CLOUD_PROXY_FALLBACK:r=4194310,o="proxy fallback";break;default:throw new $(O.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:e.detail&&e.detail[502],retry:!1})}if(e.response_body.forEach(s=>{s.buffer&&s.buffer.flag===r&&(i={code:s.buffer.code,addresses:(s.buffer.edges_services||[]).map(a=>tm(tm({},a),{},{ticket:s.buffer.cert})),server_ts:e.enter_ts,uid:s.buffer.uid,cid:s.buffer.cid,cname:s.buffer.cname,detail:tm(tm({},s.buffer.detail),e.detail),flag:s.buffer.flag,opid:e.opid,cert:s.buffer.cert})}),!i)throw new $(O.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(o," from multi unilbs response"),{csIp:e.detail&&e.detail[502]});return i}async function sC(e,t){return await Z.all(e.addresses.map(async i=>({address:ia(i.ip),tcpport:i.port,udpport:i.port,username:t&&B("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():En.username,password:t&&B("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await Ki(t.toString()):En.password})))}function bl(e,t){const i=t.getMediaStreamTrack(!0).getSettings(),r=t.videoHeight||i.height,o=t.videoWidth||i.width;return r&&o?Math.max(Math.min(r,o)/Math.min(qo(e.height),qo(e.width)),1):(I.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function _s(e){let{candidateType:t,relayProtocol:i,type:r,address:o,port:s,protocol:a}=e;const c={candidateType:t,relayProtocol:i,protocol:a};if(r!=="local-candidate"){const d=o.split(".");d.length>=4&&(d[1]="*",d[2]="*"),c.address=d.join("."),c.port=s}return c}function Hd(e){const t=e.split(":"),i=e.split(/[-.]/),r=z(e).call(e,"-")?"-":".";let o=e;return t.length>1?i.length>1?(i[1]="**",o=i[0]+r+"**:"+t[t.length-1]):o=t.length>2?t[0]+r+"**:"+t[t.length-1]:"**:"+t[t.length-1]:i.length>1&&(o=i[0]+r+"**"),o}function nm(e,t){return e.getTransceivers().find(i=>i.sender.track===t||i.receiver.track===t)}function om(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:B("SVC_MODE");if(B("ENABLE_SVC"))return function(t){return t in Vf}(e)?e:Vf.L1T3}const zP={[be.VIDEO]:[{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"},{key:"video-orientation",extensionName:"urn:3gpp:video-orientation"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"playout-delay",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"},{key:"video-content-type",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"},{key:"color-space",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/color-space"},{key:"video-timing",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"}],[be.AUDIO]:[{key:"ssrc-audio-level",extensionName:"urn:ietf:params:rtp-hdrext:ssrc-audio-level"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}]};function qP(e){e.send&&(U_(be.VIDEO,e.send.videoExtensions),U_(be.AUDIO,e.send.audioExtensions)),e.recv&&(U_(be.VIDEO,e.recv.videoExtensions),U_(be.AUDIO,e.recv.audioExtensions)),e.sendrecv&&(U_(be.VIDEO,e.sendrecv.videoExtensions),U_(be.AUDIO,e.sendrecv.audioExtensions))}function NT(e,t){e.send&&(Vu(be.VIDEO,e.send.videoExtensions,t.send.videoExtensions),Vu(be.AUDIO,e.send.audioExtensions,t.send.audioExtensions)),e.recv&&(Vu(be.VIDEO,e.recv.videoExtensions,t.recv.videoExtensions),Vu(be.AUDIO,e.recv.audioExtensions,t.recv.audioExtensions))}function Vu(e,t,i){t.forEach(r=>{var o;const s=zP[e].find(c=>{var d;let{key:l}=c;return z(d=r.extensionName).call(d,l)});if(!s)return;const a=i.find(c=>{let{extensionName:d}=c;return z(d).call(d,s.key)});a&&z(o=a.extensionName).call(o,"gdpr_forbidden")&&(r.extensionName=a.extensionName)})}function U_(e,t){t.forEach(i=>{var r;const o=zP[e].find(s=>{var a;let{key:c}=s;return z(a=i.extensionName).call(a,c)});z(r=i.extensionName).call(r,"gdpr_forbidden")&&o&&(i.extensionName=o.extensionName)})}function DT(e){return e==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"||z(e).call(e,"abs-send-time")}function PT(e){return e==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"||z(e).call(e,"draft-holmer-rmcat-transport-wide-cc-extensions-01")}function XP(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function sm(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?XP(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):XP(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}function ba(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},r=arguments.length>3?arguments[3]:void 0;const{filterRTX:o,filterVideoFec:s,filterAudioFec:a,filterAudioCodec:c,filterVideoCodec:d,unsupportedVideoUplinkCodec:l,unsupportedVideoDownlinkCodec:h}=t,{useXR:p}=i;let f=[],m=[],g=[],S=[],T=!1,C=!1;if(sn(e).mediaDescriptions.forEach(D=>{r&&r!==D.attributes.direction||(D.media.mediaType!=="video"||T||(m=D.attributes.payloads,S=D.attributes.extmaps,T=!0),D.media.mediaType!=="audio"||C||(f=D.attributes.payloads,g=D.attributes.extmaps,C=!0))}),!S||m.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!g||f.length===0)throw new Error("Cannot get audio capabilities from SDP.");if(m.forEach(D=>{var x;(x=D.rtpMap)!==null&&x!==void 0&&x.clockRate&&(D.rtpMap.clockRate=parseInt(D.rtpMap.clockRate)),p&&D.rtcpFeedbacks.push({type:"rrtr"})}),f.forEach(D=>{var x;(x=D.rtpMap)!==null&&x!==void 0&&x.clockRate&&(D.rtpMap.clockRate=parseInt(D.rtpMap.clockRate)),p&&D.rtcpFeedbacks.push({type:"rrtr"})}),o&&(f=f.filter(D=>{var x;return((x=D.rtpMap)===null||x===void 0?void 0:x.encodingName.toLowerCase())!=="rtx"}),m=m.filter(D=>{var x;return((x=D.rtpMap)===null||x===void 0?void 0:x.encodingName.toLowerCase())!=="rtx"})),s){const D=m.filter(V=>{var W;return/(red)|(ulpfec)|(flexfec)/i.test(((W=V.rtpMap)===null||W===void 0?void 0:W.encodingName)||"")}),x=zn(D,m).map(V=>V.payloadType),k=[...D.map(V=>V.payloadType),...x];m=m.filter(V=>!z(k).call(k,V.payloadType))}if(a&&(f=f.filter(D=>{var x;return!/(red)|(ulpfec)|(flexfec)/i.test(((x=D.rtpMap)===null||x===void 0?void 0:x.encodingName)||"")})),c&&(c==null?void 0:c.length)>0&&(f=f.filter(D=>{var x;return z(c).call(c,((x=D.rtpMap)===null||x===void 0?void 0:x.encodingName.toLowerCase())||"")})),d&&(d==null?void 0:d.length)>0){const D=m.filter(x=>{var k;return z(d).call(d,((k=x.rtpMap)===null||k===void 0?void 0:k.encodingName.toLowerCase())||"")});m=D.concat(o?[]:zn(D,m))}const b=B("UNSUPPORTED_VIDEO_CODEC");if(b&&b.length>0){const D=m.filter(V=>V.rtpMap&&z(b).call(b,V.rtpMap.encodingName.toLowerCase())),x=zn(D,m),k=D.concat(x).map(V=>V.payloadType);m=m.filter(V=>!z(k).call(k,V.payloadType)),I.debug("unsupportedVideoCodec: ".concat(b,", toBeRemoved: ").concat(k))}if(l&&l.length>0&&r==="sendonly"){const D=m.filter(V=>V.rtpMap&&z(l).call(l,V.rtpMap.encodingName.toLowerCase())),x=zn(D,m),k=D.concat(x).map(V=>V.payloadType);m=m.filter(V=>!z(k).call(k,V.payloadType)),I.debug("unsupportedVideoUplinkCodec: ".concat(l,", toBeRemoved: ").concat(k))}if(h&&h.length>0&&r==="recvonly"){const D=m.filter(V=>V.rtpMap&&z(h).call(h,V.rtpMap.encodingName.toLowerCase())),x=zn(D,m),k=D.concat(x).map(V=>V.payloadType);m=m.filter(V=>!z(k).call(k,V.payloadType)),I.debug("unsupportedVideoDownlinkCodec: ".concat(h,", toBeRemoved: ").concat(k))}return{audioCodecs:f,videoCodecs:m,audioExtensions:g,videoExtensions:S}}function xc(e){const t=sn(e);let i,r;for(const o of t.mediaDescriptions){if(!i){const s=o.attributes.iceUfrag,a=o.attributes.icePwd;if(!s||!a)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:s,icePwd:a}}if(!r){const s=o.attributes.fingerprints;s.length>0&&(r={fingerprints:s})}}if(!r&&t.attributes.fingerprints.length>0&&(r={fingerprints:t.attributes.fingerprints}),!r||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:r}}function aC(e,t){const i=[],r=e.attributes.ssrcGroups.filter(a=>a.semantic==="FID"),o=e.attributes.ssrcGroups.find(a=>a.semantic==="SIM"),s=e.attributes.ssrcs;if(o)o.ssrcIds.forEach(a=>{var c;const d=(c=r.find(l=>l.ssrcIds[0]===a))===null||c===void 0?void 0:c.ssrcIds[1];i.push({ssrcId:a,rtx:t?d:void 0})});else if(r.length>0){const a=r[0].ssrcIds[0],c=r[0].ssrcIds[1];i.push({ssrcId:a,rtx:t?c:void 0})}else{if(s.length===0)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:s[0].ssrcId})}return i}function JP(e,t,i){const{cname:r}=e;let o=[];t&&(o=am(t)),o.length===0&&(o=e.iceParameters.candidates.map(h=>({foundation:h.foundation,componentId:"1",transport:h.protocol,priority:h.priority.toString(),connectionAddress:h.ip,port:h.port.toString(),type:h.type,extension:{}})),I.debug("Using candidates from gateway."));const s={fingerprints:e.dtlsParameters.fingerprints.map(h=>({hashFunction:h.algorithm,fingerprint:h.fingerprint}))},a={iceUfrag:e.iceParameters.iceUfrag,icePwd:e.iceParameters.icePwd};let c;switch(e.dtlsParameters.role){case"server":c="passive";break;case"client":c="active";break;case"auto":c="actpass"}const d=Ol(e.rtpCapabilities),l=[];return Array.isArray(i)&&i.length>0&&i.forEach(h=>{l.push({kind:be.VIDEO,ssrcMsg:[{ssrcId:h.v,rtx:h.v_rtx}],mslabel:"".concat(h.v,"_").concat(h.a)},{kind:be.AUDIO,ssrcMsg:[{ssrcId:h.a}],mslabel:"".concat(h.v,"_").concat(h.a)})}),{dtlsParameters:s,iceParameters:a,candidates:o,rtpCapabilities:d,setup:c,cname:r,preSSRCs:l}}function am(e){let t=[];return e.ip&&typeof e.port=="number"&&(t=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],I.debug("Using remote candidate from AP ".concat(Hd(e.ip),":").concat(e.port)),e.ip6&&(t.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip6,port:e.port.toString(),type:"host",extension:{}}),I.debug("Using IPV6 remote candidate from AP ".concat(Hd(e.ip6),":").concat(e.port)))),t}function Kd(e,t,i){const r=[],o=[];return e.forEach(s=>{let{ssrcId:a,rtx:c}=s;const d=li(8,"track-"),l={ssrcId:a,attributes:sm({label:d,mslabel:i=i||li(10,""),msid:"".concat(i," ").concat(d)},t&&{cname:t})};if(r.push(l),c!==void 0){const h={ssrcId:c,attributes:sm({label:d,mslabel:i,msid:"".concat(i," ").concat(d)},t&&{cname:t})};r.push(h),o.push({semantic:"FID",ssrcIds:[a,c]})}}),e.length>1&&o.push({semantic:"SIM",ssrcIds:e.map(s=>{let{ssrcId:a}=s;return a})}),{ssrcs:r,ssrcGroups:o}}function Fu(e,t){t instanceof Zi&&e.attributes.payloads.forEach(i=>{var r;const o=(r=i.rtpMap)===null||r===void 0?void 0:r.encodingName.toLowerCase();if(!o||["opus","pcmu","pcma","g722"].indexOf(o)===-1)return;i.fmtp||(i.fmtp={parameters:{}}),o==="opus"&&typeof B("OPUS_PTIME")=="number"?i.fmtp.parameters.ptime=B("OPUS_PTIME"):i.fmtp.parameters.minptime="10",i.fmtp.parameters.useinbandfec="1";const s=t._encoderConfig;s&&(o!=="pcmu"&&o!=="pcma"&&o!=="g722"&&(s.bitrate&&!Ht()&&(i.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*s.bitrate))),s.sampleRate&&(i.fmtp.parameters.maxplaybackrate="".concat(s.sampleRate),i.fmtp.parameters["sprop-maxcapturerate"]="".concat(s.sampleRate)),s.stereo&&(i.fmtp.parameters.stereo="1",i.fmtp.parameters["sprop-stereo"]="1")),t instanceof hT&&o==="opus"&&t._config.DTX&&(i.fmtp.parameters.usedtx="1"))})}function LT(e){const t=e.attributes.unrecognized.findIndex(i=>i.attField==="x-google-flag"&&i.attValue==="conference");t!==-1&&e.attributes.unrecognized.splice(t,1)}function cC(e,t){var i;if(e.attributes.payloads.forEach(o=>{var s;((s=o.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())==="h264"&&o.fmtp&&o.fmtp.parameters&&B("ENABLE_UP_SPS_PPS")&&(o.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")}),!(t instanceof yi&&t._encoderConfig&&t._hints.indexOf(ui.SCREEN_TRACK)===-1))return;const r=t._encoderConfig;Mt().supportMinBitrate&&r.bitrateMin&&e.attributes.payloads.forEach(o=>{var s,a;z(s=["h264","h265","vp8","vp9","av1"]).call(s,((a=o.rtpMap)===null||a===void 0?void 0:a.encodingName.toLowerCase())||"")&&(o.fmtp||(o.fmtp={parameters:{}}),o.fmtp.parameters["x-google-min-bitrate"]="".concat(r.bitrateMin))}),Mt().supportMinBitrate&&!z(i=t._hints).call(i,ui.LOW_STREAM)&&r.bitrateMax&&e.attributes.payloads.forEach(o=>{var s,a;z(s=["h264","h265","vp8","vp9","av1"]).call(s,((a=o.rtpMap)===null||a===void 0?void 0:a.encodingName.toLowerCase())||"")&&(o.fmtp||(o.fmtp={parameters:{}}),o.fmtp.parameters["x-google-start-bitrate"]="".concat(B("X_GOOGLE_START_BITRATE")||Math.floor(r.bitrateMax)))})}function kT(e){if(e.media.mediaType!=="video")return;const t=ii();if(t.name!==di.SAFARI&&t.os!==pt.IOS)return;const i=e.attributes.extmaps.findIndex(r=>/video-orientation/g.test(r.extensionName));i!==-1&&e.attributes.extmaps.splice(i,1)}function cm(e,t,i){if(!t)return;let r,o;if(e.media.mediaType==="video"?(r=i.videoExtensions,o=i.videoCodecs):(r=i.audioExtensions,o=i.audioCodecs),t.twcc===!0){const s=r.find(a=>PT(a.extensionName));if(s){const a=s.extensionName;e.attributes.extmaps.find(d=>PT(d.extensionName))||e.attributes.extmaps.push({entry:s.entry,extensionName:a}),function(d,l){return l.filter(h=>!!d.find(p=>p.payloadType===h.payloadType&&!!p.rtcpFeedbacks.find(f=>f.type==="transport-cc")))}(o,e.attributes.payloads).forEach(d=>{d.rtcpFeedbacks.find(l=>l.type==="transport-cc")||d.rtcpFeedbacks.push({type:"transport-cc"})})}}else if(t.twcc===!1){const s=e.attributes.extmaps.findIndex(a=>PT(a.extensionName));s!==-1&&e.attributes.extmaps.splice(s,1),e.attributes.payloads.forEach(a=>{const c=a.rtcpFeedbacks.findIndex(d=>d.type==="transport-cc");c!==-1&&a.rtcpFeedbacks.splice(c,1)})}if(t.remb===!0){const s=r.find(a=>DT(a.extensionName));if(s){const a=s.extensionName;e.attributes.extmaps.find(d=>d.extensionName===a)||e.attributes.extmaps.push({entry:s.entry,extensionName:a}),function(d,l){return l.filter(h=>!!d.find(p=>p.payloadType===h.payloadType&&!!p.rtcpFeedbacks.find(f=>f.type==="goog-remb")))}(o,e.attributes.payloads).forEach(d=>{d.rtcpFeedbacks.find(l=>l.type==="goog-remb")||d.rtcpFeedbacks.push({type:"goog-remb"})})}}else if(t.remb===!1){const s=e.attributes.extmaps.findIndex(a=>DT(a.extensionName));s!==-1&&e.attributes.extmaps.splice(s,1),e.attributes.payloads.forEach(a=>{const c=a.rtcpFeedbacks.findIndex(d=>d.type==="goog-remb");c!==-1&&a.rtcpFeedbacks.splice(c,1)})}}function dC(e,t,i){if(Ht()||e.media.mediaType!=="video"||!(t instanceof yi)||i!=="vp9"&&i!=="vp8"||i==="vp8"&&!B("SIMULCAST")||i==="vp9"&&B("ENABLE_SVC")||t._scalabilityMode===void 0||t._scalabilityMode.numSpatialLayers<=1)return;const r=i==="vp8"?2:t._scalabilityMode.numSpatialLayers,o=e.attributes.ssrcs[0],s=e.attributes.ssrcGroups.find(c=>c.semantic==="FID"&&c.ssrcIds[0]===o.ssrcId),a={semantic:"SIM",ssrcIds:[o.ssrcId]};for(let c=1;c<r;c++)e.attributes.ssrcs.push({ssrcId:o.ssrcId+c,attributes:wi(o.attributes)}),a.ssrcIds.push(o.ssrcId+c),s&&(e.attributes.ssrcs.push({ssrcId:s.ssrcIds[1]+c,attributes:wi(o.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[o.ssrcId+c,s.ssrcIds[1]+c]}));e.attributes.ssrcGroups.unshift(a)}async function lC(){try{const e=new RTCPeerConnection;e.addTransceiver("video",{direction:"sendonly",sendEncodings:[{scalabilityMode:Vf.L1T3}]});const t=await e.createOffer();if(!t.sdp)return void e.close();const i=sn(t.sdp).mediaDescriptions[0];if(!i)return;const r=i.attributes.extmaps.find(o=>o.extensionName==="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension");return e.close(),r}catch{return}}async function uC(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const i=new RTCPeerConnection;i.addTransceiver("video",{direction:"sendonly"}),i.addTransceiver("audio",{direction:"sendonly"}),i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"});const r=(await i.createOffer()).sdp,{send:o,recv:s,sendrecv:a}=function(){let c=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},d=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},l=arguments.length>2?arguments[2]:void 0;const h=ba(l,c,d,"sendonly"),p=ba(l,c,d,"recvonly"),f={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},m={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},g={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Ns(h,p,"videoExtensions",f,m,g),Ns(h,p,"videoCodecs",f,m,g),Ns(h,p,"audioExtensions",f,m,g),Ns(h,p,"audioCodecs",f,m,g),B("RAISE_H264_BASELINE_PRIORITY")){const S=[],T=[];if(g.videoCodecs.forEach((C,b)=>{var D;if(((D=C.rtpMap)===null||D===void 0?void 0:D.encodingName.toLocaleLowerCase())==="h264"){var x,k;const V=g.videoCodecs[b+1],W=V&&ZP(C,V),K=(x=C.fmtp)===null||x===void 0?void 0:x.parameters["profile-level-id"],J=(k=C.fmtp)===null||k===void 0?void 0:k.parameters["packetization-mode"];!K||K!==B("FIRST_H264_PROFILE_LEVEL_ID")||B("FIRST_PACKETIZATION_MODE")&&J!==B("FIRST_PACKETIZATION_MODE")?W?T.push([C,V]):T.push([C]):W?S.push([C,V]):S.push([C])}}),S.length>0&&T.length>0){I.debug("raising H264 baseline profile priority"),g.videoCodecs.forEach((b,D)=>{var x;if(((x=b.rtpMap)===null||x===void 0?void 0:x.encodingName.toLocaleLowerCase())==="h264"){const k=ZP(b,g.videoCodecs[D+1]),V=S.shift()||T.shift()||[];V.length>0&&(k?g.videoCodecs.splice(D,2,...V):g.videoCodecs.splice(D,1,...V))}});const C=m.videoCodecs.filter(b=>{var D,x;return((D=b.rtpMap)===null||D===void 0?void 0:D.encodingName.toLocaleLowerCase())==="h264"&&((x=b.fmtp)===null||x===void 0?void 0:x.parameters["profile-level-id"])!==B("FIRST_H264_PROFILE_LEVEL_ID")});if(C.length>0){const b=zn(C,m.videoCodecs).map(x=>x.payloadType),D=[...C.map(x=>x.payloadType),...b];m.videoCodecs=m.videoCodecs.filter(x=>!z(D).call(D,x.payloadType))}B("FILTER_SEND_H264_BASELINE")&&(f.videoCodecs=f.videoCodecs.filter(b=>{var D,x;return!(((D=b.rtpMap)===null||D===void 0?void 0:D.encodingName.toLocaleLowerCase())==="h264"&&((x=b.fmtp)===null||x===void 0?void 0:x.parameters["profile-level-id"])!==B("FIRST_H264_PROFILE_LEVEL_ID"))}))}return{send:f,recv:m,sendrecv:g}}return{send:f,recv:m,sendrecv:g}}(e,t,r);try{i.close()}catch{}return{send:o,recv:s,sendrecv:a}}function ac(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=ba(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Ns(e,t,"videoExtensions",i,r,o),Ns(e,t,"videoCodecs",i,r,o),Ns(e,t,"audioExtensions",i,r,o),Ns(e,t,"audioCodecs",i,r,o),B("RAISE_H264_BASELINE_PRIORITY")){const s=o.videoCodecs.findIndex(a=>a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&a.fmtp&&a.fmtp.parameters["profile-level-id"]==="42001f");if(s!==-1){const a=o.videoCodecs.findIndex(c=>c.rtpMap&&c.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(a<s){I.debug("raising H264 baseline profile priority");const c=o.videoCodecs[s];o.videoCodecs.splice(s,1),o.videoCodecs.splice(a,0,c)}a!==-1&&(r.videoCodecs=r.videoCodecs.filter(c=>!(c.rtpMap&&c.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&c.fmtp&&c.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:i,recv:r,sendrecv:o}}function Ns(e,t,i,r,o,s){if(i==="videoExtensions"||i==="audioExtensions"){const a=[];return e[i].forEach(c=>{t[i].some((d,l)=>{if(c.entry===d.entry&&c.extensionName===d.extensionName)return a.push(l),!0})?s[i].push(c):r[i].push(c)}),void t[i].forEach((c,d)=>{a.indexOf(d)===-1&&o[i].push(c)})}if(i==="videoCodecs"||i==="audioCodecs"){const a=[];return e[i].forEach(c=>{t[i].some((d,l)=>{if(c.payloadType===d.payloadType&&JSON.stringify(c)===JSON.stringify(d))return a.push(l),!0})?s[i].push(c):r[i].push(c)}),void t[i].forEach((c,d)=>{a.indexOf(d)===-1&&o[i].push(c)})}}function Ol(e){const{send:t,recv:i,sendrecv:r}=e;if(!r){if(!t||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:i}}let o,s;return t?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...t.audioCodecs,...r.audioCodecs],o.videoCodecs=[...t.videoCodecs,...r.videoCodecs],o.audioExtensions=[...t.audioExtensions,...r.audioExtensions],o.videoExtensions=[...t.videoExtensions,...r.videoExtensions]):o=wi(r),i?(s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s.audioCodecs=[...i.audioCodecs,...r.audioCodecs],s.videoCodecs=[...i.videoCodecs,...r.videoCodecs],s.audioExtensions=[...i.audioExtensions,...r.audioExtensions],s.videoExtensions=[...i.videoExtensions,...r.videoExtensions]):s=wi(r),{send:o,recv:s}}function Nl(e){e.media.mediaType==="audio"&&e.attributes.payloads.filter(t=>{var i;return((i=t.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase())==="opus"}).forEach(t=>{t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters.stereo="1",t.fmtp.parameters["sprop-stereo"]="1"})}function Vc(e,t,i,r){let o=[];if(e===be.VIDEO){if(B("H264_PROFILE_LEVEL_ID")&&r==="h264"&&(o=t.videoCodecs.filter(s=>{var a;return z(a=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(a,r)&&s&&s.fmtp&&s.fmtp.parameters["profile-level-id"]===B("H264_PROFILE_LEVEL_ID")})),!Array.isArray(o)||o.length===0){let s=[];const a=[],c=[],d=[];if(i.videoCodecs.forEach(l=>{const h=l.rtpMap&&l.rtpMap.encodingName.toLowerCase()||"";z(h).call(h,r)?s.push(l):z(h).call(h,"vp9")?a.push(l):z(h).call(h,"vp8")?c.push(l):z(h).call(h,"h264")&&d.push(l)}),s.length===0){let l="";a.length!==0?(s=a,l="vp9"):c.length!==0?(s=c,l="vp8"):d.length!==0&&(s=d,l="h264"),I.warning("codec ".concat(r," not included in rtpCapabilities, fallback to default payloads: ").concat(l))}s.length!==0&&(o=t.videoCodecs.filter(l=>s.some(h=>h.payloadType===l.payloadType)))}if(o.length===0&&(I.warning("codec ".concat(r," not included in rtpCapabilities, fallback to default payloads: ").concat(t.videoCodecs[0].rtpMap&&t.videoCodecs[0].rtpMap.encodingName)),o=t.videoCodecs),B("USE_PUB_RTX")||B("USE_SUB_RTX")){const s=zn(o,t.videoCodecs);o=[...o,...s]}}else{o=t.audioCodecs.filter(a=>{var c;return z(c=a.rtpMap&&a.rtpMap.encodingName.toLowerCase()||"").call(c,r)});const s=t.audioCodecs.filter(a=>{var c;return z(c=a.rtpMap&&a.rtpMap.encodingName.toLowerCase()||"").call(c,"red")});o.length===0&&(I.warning("codec ".concat(r," not included in rtpCapabilities, fallback to opus")),o=t.audioCodecs.filter(a=>{var c;return z(c=a.rtpMap&&a.rtpMap.encodingName.toLowerCase()||"").call(c,"opus")})),B("ENABLE_AUDIO_RED")&&s.length!==0&&(o=[...s,...o])}return o}function zn(e,t){const i=e.map(r=>r.payloadType.toString());return t.filter(r=>r.rtpMap&&r.rtpMap.encodingName==="rtx"&&r.fmtp&&r.fmtp.parameters.apt&&z(i).call(i,r.fmtp&&r.fmtp.parameters.apt))}async function Xo(e,t,i){const r=t.toString(),o=QP(r,"offer","remote","exchangeSDP");await e.setRemoteDescription({type:"offer",sdp:r});const s=await e.createAnswer();if(!s.sdp)throw new Error("cannot get answer sdp");let a=s.sdp;a=hC(a,i||{}),o==null||o(a||""),await e.setLocalDescription({type:"answer",sdp:a})}function hC(e,t,i){if(B("FORBID_MODIFY_LOCAL_OFFER_SDP"))return e;const r=sn(e),{useXR:o}=t;return r.mediaDescriptions.forEach(s=>{var a;s.attributes.mid&&(Array.isArray(i)&&!z(i).call(i,s.attributes.mid)||(s.media.mediaType==="audio"&&Nl(s),s.media.mediaType==="video"&&function(c){c.media.mediaType==="video"&&B("ENABLE_DOWN_SPS_PPS")&&c.attributes.payloads.filter(d=>{var l;return((l=d.rtpMap)===null||l===void 0?void 0:l.encodingName.toLowerCase())==="h264"}).forEach(d=>{d.fmtp||(d.fmtp={parameters:{}}),d.fmtp.parameters["sps-pps-idr-in-keyframe"]="1"})}(s),o&&z(a=["audio","video"]).call(a,s.media.mediaType)&&s.attributes.payloads.forEach(c=>{c.rtcpFeedbacks.findIndex(d=>d.type==="rrtr")===-1&&c.rtcpFeedbacks.push({type:"rrtr"})})))}),Du(r)}function QP(e,t,i,r){if(B("SDP_LOGGING"))return I.upload("exchanging ".concat(i," ").concat(t," SDP during P2PConnection.").concat(r,`
`),e),t==="offer"?o=>{QP(o,"answer",i==="local"?"remote":"local",r)}:void 0}async function MT(e,t,i){try{var r;if(!Mt().supportSetRtpSenderParameters||!function(d){return d==="vp9"||d==="av1"}(e)||!B("ENABLE_SVC"))return;const o={},s={},a=t.getParameters(),c=(r=a.encodings)===null||r===void 0?void 0:r[0];s.scalabilityMode=om(i),c&&Object.assign(c,s),Object.assign(a,o),await t.setParameters(a),I.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(a.encodings)))}catch(o){I.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",o)}}function UT(e){const t=B("COMPATIBLE_SDP_EXTENSION");return!!(Array.isArray(t)&&t.length>0)&&t.some(i=>z(e).call(e,i))}function ZP(e,t){try{var i;return((i=e.fmtp)===null||i===void 0?void 0:i.parameters.apt)===t.payloadType.toString()}catch{return!1}}function Ds(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function ra(e,t){return typeof B(e)===t?B(e):void 0}function ZU(){try{const e=B("EXPERIMENTS")||{};return typeof e=="string"||Array.isArray(e)?{}:function(t){for(var i=1;i<arguments.length;i++){var r=arguments[i]!=null?arguments[i]:{};i%2?Ds(Object(r),!0).forEach(function(o){M(t,o,r[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Ds(Object(r)).forEach(function(o){Object.defineProperty(t,o,Object.getOwnPropertyDescriptor(r,o))})}return t}({},e)}catch(e){return I.debug("handle gateway attributes failed: ",e),{}}}const Yd={};function go(e){(!(arguments.length>1&&arguments[1]!==void 0)||arguments[1])&&I.debug("install service ".concat(e.name)),Yd[e.name]=e}function Fc(e){const t=Yd[e];if(!t)throw new oe(O.INVALID_OPERATION,"".concat(e," not found, please use AgoraRTC.use(").concat(e,"Service) to load it first"));return t}function xT(e,t){return Fc("DataStream").create(e,t)}function VT(){return Fc("InterceptFrame").create()}function Sn(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function an(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Sn(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Sn(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}const $P=new Map;class pC extends Vi{get state(){return this._state}set state(t){if(t===this._state)return;const i=this._state;this._state=t,t==="DISCONNECTED"&&this._disconnectedReason?this.emit(Rr.CONNECTION_STATE_CHANGE,t,i,this._disconnectedReason):this.emit(Rr.CONNECTION_STATE_CHANGE,t,i)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(t){I.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(t)),this._joinGatewayStartTime=t}constructor(t,i){var r,o,s;super(),M(this,"store",void 0),M(this,"joinInfo",void 0),M(this,"key",void 0),M(this,"ntpOffset",0),M(this,"usingProxy",!1),M(this,"signal",void 0),M(this,"role",void 0),M(this,"isPreallocation",void 0),M(this,"isPreSub",void 0),M(this,"inChannelInfo",{joinAt:null,duration:0}),M(this,"spec",void 0),M(this,"_state","DISCONNECTED"),M(this,"_statsCollector",void 0),M(this,"_disconnectedReason",void 0),M(this,"isSignalRecover",!1),M(this,"hasChangeBGPAddress",!1),M(this,"trafficStatsInterval",void 0),M(this,"networkQualityInterval",void 0),M(this,"_joinGatewayStartTime",0),M(this,"_signalTimeout",!1),M(this,"_clientRoleOptions",void 0),M(this,"_isProactiveJoin",!1),this.store=t,this.spec=i,this.signal=this.store.useP2P?(r={spec:an(an({},i),{},{retryConfig:i.websocketRetryConfig}),store:t},(o=(s=Fc("P2PChannel")).createSubmodule)===null||o===void 0?void 0:o.call(s,r)):this.store.useDcSignal?function(a){return Fc("DataChannelSignal").create(a)}({spec:an(an({},i),{},{retryConfig:i.websocketRetryConfig}),store:t}):new QU(an(an({},i),{},{retryConfig:i.websocketRetryConfig}),t),this._statsCollector=i.statsCollector,this.role=i.role||"audience",this._clientRoleOptions=i.clientRoleOptions,this.handleSignalEvents()}setUsingProxy(t){this.usingProxy=t}async join(t,i,r){if(this.store.useDcSignal){let h=!1;t.cloudProxyServer!=="disabled"?(I.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(t.cloudProxyServer,")")),h=!0):"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length>255||"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length<22?(I.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),h=!0):t.apResponse.addresses.some(p=>p.fingerprint)||B("FINGERPRINT")||(I.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),h=!0),h&&this.resetSignal()}this.store.joinGatewayStart(),t.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);const o=Date.now();let s=$P.get(t.cname);if(s||(s=new Map,$P.set(t.cname,s)),this._isProactiveJoin=!0,s.has(t.uid)){const h=new $(O.UID_CONFLICT);throw H.joinGateway(t.sid,{lts:o,succ:!1,ec:h.code,addr:null,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,isProxy:!!t.proxyServer||this.usingProxy,signalChannel:this.store.useDcSignal?"1":"0",preload:t.preload}),h}s.set(t.uid,!0),this.joinInfo=t,this.key=i;let a=0;this.joinGatewayStartTime=o;const c=t.proxyServer,d=this.store.useDcSignal?"datachannel":"websocket";try{I.debug("[".concat(this.store.clientId,"] use ").concat(d," join uid ").concat(a));const h=t.gatewayAddrs.map(f=>{let{address:m}=f;const[g,S]=m.split(":"),T={host:g,port:S};return t.proxyServer&&(T.proxy=t.proxyServer),T});let p;p=this.store.useDcSignal?await this.signal.init(t.apResponse.addresses):await this.signal.init(h),a=p.uid,I.debug("[".concat(this.store.clientId,"] ").concat(d," join uid ").concat(a," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(h){var l;throw h.code===O.INIT_DATACHANNEL_TIMEOUT&&this.signal.__name__==="AgoraRTCSignal"||H.joinGateway(t.sid,{lts:o,succ:!1,ec:((l=h.data)===null||l===void 0?void 0:l.desc)||h.code,errorMsg:h.message,addr:this.signal.url,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,isProxy:!!c||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:t.preload}),h&&h.code===O.INIT_DATACHANNEL_TIMEOUT?(I.warning("[".concat(this.store.clientId,"] User join datachannel failed"),h.toString()),this.resetSignal(),h):(I.error("[".concat(this.store.clientId,"] User join failed"),h.toString()),s.delete(t.uid),this.signal.close(),h)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),I.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(h=>{I.warning("[".concat(this.store.clientId,"] get traffic stats error"),h.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(Rr.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(Rr.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(Rr.NETWORK_QUALITY,{uplinkNetworkQuality:Gh(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:Gh(this._statsCollector.trafficStats.B_dnq)}):this.emit(Rr.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),a}async leave(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],i=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){i!==bt.FALLBACK&&(this.state="DISCONNECTING");try{t||this.signal.connectionState!==Ee.CONNECTED||await function(r,o){return o===1/0?r:Z.race([r,fn(o)])}(this.signal.request(Be.LEAVE,void 0,!0),3e3)}catch(r){I.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),r)}this.signal.close(i),i!==bt.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(t,i,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const o={state:"offer",p2p_id:this.store.p2pId,ortc:i,mode:this.spec.mode,extend:B("PUB_EXTEND"),twcc:!!B("PUBLISH_TWCC"),rtx:!!B("USE_PUB_RTX")};try{return(await this.signal.request(Be.PUBLISH,o,!0))._message}catch(s){if(r&&s.data&&s.data.code===ye.ERR_PUBLISH_REQUEST_INVALID)return I.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),s.toString()),await this.tryUnpubBeforeRepub(t,i),this.publish(t,i,!1);throw s}}async publishDataChannel(t,i,r){var o;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const s={stream_id:i.streamId,ordered:i.ordered?1:0,max_retrans_times:(o=i.maxRetransmits)!==null&&o!==void 0?o:10,channel_id:i.channelId,metadata:i.metadata};try{await this.signal.request(Be.PUBLISH_DATASTREAM,s,!0)}catch(a){if(r&&a.data&&a.data.code===ye.ERR_PUBLISH_REQUEST_INVALID)return I.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),a.toString()),await this.tryUnpubDataChannelBeforeRepub(t,i),this.publishDataChannel(t,i,!1);throw a}}async unpublish(t,i){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(Be.UNPUBLISH,{stream_id:i,ortc:t},!0)}catch(r){I.warning("[".concat(this.store.clientId,"] unpublish warning: "),r)}}async unpublishDataChannel(t){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Z.all(t.map(i=>this.signal.request(Be.UNPUBLISH_DATASTREAM,{channel_id:i},!0)))}catch(i){I.warning("unpublish datachannels warning: ",i)}}async presubscribe(t,i,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const o={stream_id:t,stream_type:i,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!B("SUBSCRIBE_TWCC"),rtx:!!B("USE_SUB_RTX")||void 0,extend:B("SUB_EXTEND"),svc:Array.isArray(B("SVC"))&&B("SVC").length!==0?B("SVC"):void 0};try{return await this.signal.request(Be.PRE_SUBSCRIBE,o,!0)}catch(s){if(r&&s.data&&s.data.code===ye.ERR_SUBSCRIBE_REQUEST_INVALID)return I.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),s.toString()),this.presubscribe(t,i,!1);throw s}}async subscribe(t,i,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const o={stream_id:t,stream_type:i.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!B("SUBSCRIBE_TWCC"),rtx:!!B("USE_SUB_RTX"),extend:B("SUB_EXTEND"),ssrcId:i.ssrcId,svc:Array.isArray(B("SVC"))&&B("SVC").length!==0?B("SVC"):void 0};try{return(await this.signal.request(Be.SUBSCRIBE,o,!0))._message}catch(s){if(r&&s.data&&s.data.code===ye.ERR_SUBSCRIBE_REQUEST_INVALID)return I.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),s.toString()),await this.tryUnsubBeforeResub(t,i),await this.subscribe(t,i,!1);throw s}}async subscribeDataChannel(t,i,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const o={uid:t,stream_id:i.id,channel_id:i.datachannelId};try{return void await this.signal.request(Be.SUBSCRIBE_DATASTREAM,o,!0)}catch(s){if(r&&s.data&&s.data.code===ye.ERR_SUBSCRIBE_REQUEST_INVALID)return I.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),s.toString()),await this.tryUnsubDataChannelBeforeResub(t,i),await this.subscribeDataChannel(t,i,!1);throw s}}async subscribeAll(t,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const r={p2p_id:this.store.p2pId,users:t,dtx:!1,rtx:!!B("USE_SUB_RTX"),twcc:!!B("SUBSCRIBE_TWCC"),svc:Array.isArray(B("SVC"))&&B("SVC").length!==0?B("SVC"):void 0};try{return await this.signal.request(Be.SUBSCRIBE_STREAMS,r,!0)}catch(o){if(i&&o.data&&o.data.code===ye.ERR_SUBSCRIBE_REQUEST_INVALID)return I.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),o.toString()),await this.tryMassUnsubBeforeResub(t),await this.subscribeAll(t,!1);throw o}}async setVideoProfile(t){const i=function(r){if(!(r.bitrateMax&&r.bitrateMin&&r.frameRate&&r.height&&r.width))return;let o=r.frameRate,s=r.width,a=r.height,c=!0;return typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,o||(c=!1)),typeof s!="number"&&(s=s.exact||s.ideal||s.max||s.min||0,s||(c=!1)),typeof a!="number"&&(a=a.exact||a.ideal||a.max||a.min||0,o||(c=!1)),c?{stream_type:0,width:s,height:a,fps:o,start_bps:1e3*r.bitrateMax,min_bps:1e3*r.bitrateMin,target_bps:1e3*r.bitrateMax}:void 0}(t);if(i)return this.signal.request(Be.SET_VIDEO_PROFILE,i);I.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(t,i){try{await this.signal.request(Be.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:t,stream_id:i},!0)}catch(r){I.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),r)}}async unsubscribeDataChannel(t,i){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Z.all(t.map(r=>this.signal.request(Be.UNSUBSCRIBE_DATASTREAM,{stream_id:r,uid:i},!0)))}catch(r){I.warning("unsubscribeDataChannel warning: ",r)}}async massUnsubscribe(t){try{await this.signal.request(Be.UNSUBSCRIBE_STREAMS,t,!0)}catch(i){I.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),i)}}async reconnectPC(t){const{iceParameters:i,dtlsParameters:r,rtpCapabilities:o}=t;return{gatewayEstablishParams:await this.signal.request(Be.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:i,dtlsParameters:r,rtpCapabilities:o}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(Be.GATEWAY_INFO)}async renewToken(t){await this.signal.request(Be.RENEW_TOKEN,t),this.key=t.token}updateClientRole(t,i){i&&(this._clientRoleOptions=Object.assign({},i)),B("CLIENT_ROLE_OPTIONS")&&(I.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(B("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," ")),this._clientRoleOptions=Object.assign({},B("CLIENT_ROLE_OPTIONS"))),this.role=t}async setClientRole(t,i){if(i&&(this._clientRoleOptions=Object.assign({},i)),B("CLIENT_ROLE_OPTIONS")&&(this._clientRoleOptions=Object.assign({},B("CLIENT_ROLE_OPTIONS")),I.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(B("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," "))),this.state!=="CONNECTED")return void(this.role=t);let r,o=0;t==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(r=this._clientRoleOptions.delay,o=1):o=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:o=0;const s=Object.assign({},i);delete s.delay,delete s.level,await this.signal.request(Be.SET_CLIENT_ROLE,an(an({role:t,level:o,delay:r},s),{},{client_ts:Date.now()})),this.role=t}async setDualStreamMode(t,i,r){await this.signal.request(Be.SET_DUAL_STREAM_MODE,{mode:t},r,i)}async setRemoteVideoStreamType(t,i){await this.signal.request(Be.SWITCH_VIDEO_STREAM,{stream_id:t,stream_type:i})}async setDefaultRemoteVideoStreamType(t){await this.signal.request(Be.DEFAULT_VIDEO_STREAM,{stream_type:t})}async setStreamFallbackOption(t,i){await this.signal.request(Be.SET_FALLBACK_OPTION,{stream_id:t,fallback_type:i})}async pickSVCLayer(t,i){await this.signal.request(Be.PICK_SVC_LAYER,{stream_id:t,spatial_layer:i.spatialLayer,temporal_layer:i.temporalLayer})}async setRTM2Flag(t){await this.signal.request(Be.SET_RTM2_FLAG,{rtm2_flag:t})}async sendExtensionMessage(t,i,r){if(this.store.useP2P)return this.signal.sendExtensionMessage(t,i,r)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),an({},this.inChannelInfo)}async setConfigure(t){if(t&&Array.isArray(t)&&t.length!==0)return this.signal.request(Be.CONFIGURE,t)}async getGatewayVersion(){return(await this.signal.request(Be.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const t=$P.get(this.joinInfo.cname);t&&t.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0),this.usingProxy=!1}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const t=function(i){let r;return r=i.startsWith("dc")?i.match(/(dc\:\/\/)?([^:]+):(\d+)/):i.match(/(wss\:\/\/)?([^:]+):(\d+)/),r?{username:En.username,password:En.password,turnServerURL:r[2],tcpport:parseInt(r[3])+30,udpport:parseInt(r[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],t&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(an(an({},En),{},{turnServerURL:t.turnServerURL,tcpport:t.tcpport,udpport:t.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;const t=await this.signal.request(Be.TRAFFIC_STATS,void 0,!0);t.timestamp=Date.now(),t.ntp_offset!=null&&(this.ntpOffset=t.ntp_offset),t.peer_delay.forEach(i=>{const r=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(o=>o.peer_uid===i.peer_uid);r&&r.B_st!==i.B_st&&Li(()=>{this.emit(Rr.STREAM_TYPE_CHANGE,i.peer_uid,i.B_st)})}),this._statsCollector.updateTrafficStats(t)}getJoinMessage(t){var i,r,o,s;if(!this.joinInfo||!this.key)throw new $(O.UNEXPECTED_ERROR,"can not generate join message, no join info");const a=Object.assign({},this.joinInfo.apResponse);let c=B("REPORT_APP_SCENARIO");if(typeof c!="string")try{c=JSON.stringify(c)}catch{c=void 0}var d;c&&c.length>128&&(c=void 0),this.store.hasStartJoinChannel=!0,this.store.isABTestSuccess||this.emit(Rr.UPDATE_GATEWAY_CONFIG),d=this.store.clientId,z(kc).call(kc,d)||kc.push(d);const l=Wf(this.store),h=!((i=this.isPreallocation)===null||i===void 0||!i.call(this)),p=KN(this.store),f=ZU(),m=bc(87)||AN()||fv(117),g=(function(){const b=ii();if(b.name!==di.SAFARI||!b.browserVersion)return!1;const D=b.browserVersion.split(".");return Number(D[0])>18||Number(D[0])===18&&Number(D[1])>=4}()||bN(18,4,!1))&&Cu(18,6,!0)&&this.spec.codec==="h264"&&B("ENABLE_ABSSENDTIME_AS_SENTTS"),S=!(((r=a.detail)===null||r===void 0?void 0:r[3])!=="CN"||!B("ENABLE_QUALITY_FALLBACK"))&&B("ENABLE_QUALITY_FALLBACK"),T=!!B("ENABLE_AP_MULTI_IP")&&((o=a.detail)===null||o===void 0?void 0:o[5])==="multi-ip",C=an({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:Qs,browser:navigator.userAgent,process_id:B("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:T||this.hasChangeBGPAddress,ap_response:a,extend:B("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:c,attributes:{userAttributes:an(an({enableEncodedTransform:(!!B("ENABLE_AUDIO_METADATA")||!!B("ENABLE_AUDIO_PTS"))&&m||!!B("ENABLE_AUDIO_TOPN")&&Tl(di.CHROME,87,116)||void 0,enableAudioMetadata:!!B("ENABLE_AUDIO_METADATA")&&m,enableAudioPts:!!B("ENABLE_AUDIO_PTS")&&m,topnSmoothLevel:B("TOPN_SMOOTH_LEVEL"),topnNewSpeakerDelay:B("TOPN_NEW_SPEAKER_DELAY"),topnSwitchHoldMs:B("TOPN_SWITCH_HOLD_MS"),topnAudioGain:B("TOPN_AUDIO_GAIN"),enableNetworkQualityProbe:this.store.networkQualityProbe,enablePublishedUserList:B("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:B("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:ra("SUBSCRIBE_AUDIO_FILTER_TOPN","number"),enablePublishAudioFilter:ra("ENABLE_PUBLISH_AUDIO_FILTER","boolean"),enableUserLicenseCheck:ra("ENABLE_USER_LICENSE_CHECK","boolean"),enableRTX:B("USE_PUB_RTX")===!0||B("USE_SUB_RTX")===!0||void 0,disableFEC:B("DISABLE_FEC"),enableNTPReport:!!B("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:p,enableFulllinkAvSync:!!B("ENABLE_FULL_LINK_AV_SYNC")||void 0,enableDataStream2:ra("ENABLE_DATASTREAM_2","boolean"),enableAutFeedback:!!B("FORCE_ENABLE_AUT_CC")||!kh()&&(!!B("ENABLE_AUT_FEEDBACK")||void 0),rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!B("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:ra("USE_XR","boolean"),enableLossbasedBwe:ra("ENABLE_LOSSBASED_BWE","boolean"),enableAutCC:!!B("FORCE_ENABLE_AUT_CC")||!kh()&&(!!B("ENABLE_AUT_CC")||void 0),enableCCFallback:ra("ENABLE_CC_FALLBACK","boolean"),enablePreallocPC:h,preSubNum:l?ra("PRE_SUB_NUM","number"):void 0,enablePubTWCC:ra("PUBLISH_TWCC","boolean"),enableSubTWCC:ra("SUBSCRIBE_TWCC","boolean"),enablePubRTX:ra("USE_PUB_RTX","boolean"),enableSubRTX:ra("USE_SUB_RTX","boolean"),enableSubSVC:B("ENABLE_SVC")?B("ENABLE_SVC_DEFAULT_CODECS"):Array.isArray(B("SVC"))&&B("SVC").length!==0?B("SVC"):void 0,enableSvcExtended:B("ENABLE_SVC")&&Array.isArray(B("SVC_EXTENDED"))&&B("SVC_EXTENDED").length!==0?B("SVC_EXTENDED"):void 0,enableVosFallback:B("ENABLE_VOS_FALLBACK"),enableQualityFallback:S},f),{},{audioDuplicate:ra("ENABLE_AUDIO_RED","boolean")?(s=ra("AUDIO_DUPLICATE_NUM","number"))!==null&&s!==void 0?s:2:void 0,senttsUsesAbsSendTime:!!g||void 0,enableDualStreamFlag:ra("ENABLE_DUAL_STREAM_FLAG","boolean")})},join_ts:this.joinGatewayStartTime},t);return this.joinInfo.stringUid&&(C.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(C.aes_mode=this.joinInfo.aesmode,B("ENCRYPT_AES")?(C.aes_secret=this.joinInfo.aespassword,C.aes_encrypt=!0):C.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(C.aes_salt=this.joinInfo.aessalt)),a.addresses[this.signal.websocket.currentURLIndex]&&(C.ap_response.ticket=a.addresses[this.signal.websocket.currentURLIndex].ticket,delete a.addresses),this.joinInfo.defaultVideoStream!==void 0&&(C.default_video_stream=this.joinInfo.defaultVideoStream),C}getRejoinMessage(){if(!this.joinInfo)throw new $(O.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(le.WS_RECONNECT_CREATE_CONNECTION,t=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(le.WS_RECONNECTING,t=>{this.joinInfo&&H.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t||Gi.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",H.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(le.WS_CLOSED,t=>{let i;switch(t){case bt.LEAVE:i=Gi.LEAVE;break;case bt.UID_BANNED:case bt.IP_BANNED:case bt.CHANNEL_BANNED:case bt.SERVER_ERROR:i=Gi.SERVER_ERROR;break;case bt.FALLBACK:i=Gi.FALLBACK;break;case bt.LICENSE_MISSING:case bt.LICENSE_EXPIRED:case bt.LICENSE_MINUTES_EXCEEDED:case bt.LICENSE_PERIOD_INVALID:case bt.LICENSE_MULTIPLE_SDK_SERVICE:case bt.LICENSE_ILLEGAL:case bt.TOKEN_EXPIRE:i=t;break;default:i=Gi.NETWORK_ERROR}I.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(i||"undefined -> "+Gi.NETWORK_ERROR)),this.joinInfo&&H.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:t===bt.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:i}),this._disconnectedReason=t,t!==bt.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(le.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo){if(this.role==="audience"){const t=B("CLIENT_ROLE_OPTIONS")||this._clientRoleOptions;t&&(t.level||t.delay)&&(I.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(t.level,", delay: ").concat(t.delay)),this.setClientRole(this.role,t))}if(H.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:this.joinInfo.preload,isABTestSuccess:this.store.isABTestSuccess}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1){const t=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!t)return void I.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(t));F("EVENT_REPORT_DOMAIN",t[1]),F("EVENT_REPORT_BACKUP_DOMAIN",t[1]),F("LOG_UPLOAD_SERVER","".concat(t[1],":6444"))}}}),this.signal.on(Ke.ON_UPLINK_STATS,t=>{this._statsCollector.updateUplinkStats(t)}),this.signal.on(le.REQUEST_RECOVER,(t,i,r)=>{if(!this.joinInfo)return r(new $(O.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));t&&(this.joinInfo.multiIP=t,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,yt(this,Rr.REQUEST_NEW_GATEWAY_LIST).then(i).catch(r)}),this.signal.on(le.REQUEST_JOIN_INFO,async(t,i,r)=>{var o,s,a;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void t(this.getJoinMessage({ortc:{}}));const c=wi((o=this.joinInfo)===null||o===void 0?void 0:o.turnServer);if(B("NEW_TURN_MODE")&&c&&((s=this.joinInfo)===null||s===void 0?void 0:s.cloudProxyServer)==="disabled"){var d;let f=c.servers.map(S=>"turnServerURL"in S&&B("USE_TURN_IP")?an(an({},S),{},{turnServerURL:im(S.turnServerURL)}):S),m=(d=c.serversFromGateway)===null||d===void 0?void 0:d.map(S=>B("USE_TURN_IP")?an(an({},S),{},{turnServerURL:im(S.turnServerURL)}):S);const g=this.signal.currentURLIndex;f.length>0&&(f=[f[g%f.length]],c.servers=f),Array.isArray(m)&&m.length>0&&(m=[m[0]],c.serversFromGateway=m),I.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(g))}const{iceParameters:l,dtlsParameters:h,rtpCapabilities:p}=await yt(this,Rr.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:c,cloudProxyServer:(a=this.joinInfo)===null||a===void 0?void 0:a.cloudProxyServer});try{t(this.getJoinMessage({ortc:{iceParameters:l,dtlsParameters:h,rtpCapabilities:p,version:"2"}}))}catch(f){i(f)}}),this.signal.on(le.REQUEST_REJOIN_INFO,t=>{t(this.getRejoinMessage())}),this.signal.on(le.REPORT_JOIN_GATEWAY,(t,i)=>{if(!this.joinInfo)return;let r,o="";var s;t instanceof $?(r=((s=t.data)===null||s===void 0?void 0:s.desc)||t.code,o=t.message):r=t,H.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:r,errorMsg:o,addr:i,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:this.joinInfo.preload})}),this.signal.on(le.IS_P2P_DISCONNECTED,t=>{t(Wi(this,Rr.IS_P2P_DISCONNECTED))}),this.signal.on(le.DISCONNECT_P2P,()=>{this.emit(Rr.DISCONNECT_P2P)}),this.signal.on(le.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(le.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(le.JOIN_RESPONSE,t=>{const i=this.getCurrentGatewayAddress();this.emit(Rr.JOIN_RESPONSE,t,i)}),this.signal.on(le.PRE_CONNECT_PC,async(t,i)=>{if(this.joinInfo){var r,o;this.updateTurnConfigFromSignal();const a=this.getCurrentGatewayAddress(),c=wi((r=this.joinInfo)===null||r===void 0?void 0:r.turnServer);if(B("NEW_TURN_MODE")&&c&&((o=this.joinInfo)===null||o===void 0?void 0:o.cloudProxyServer)==="disabled"){var s;let l=c.servers.map(f=>"turnServerURL"in f&&B("USE_TURN_IP")?an(an({},f),{},{turnServerURL:im(f.turnServerURL)}):f),h=(s=c.serversFromGateway)===null||s===void 0?void 0:s.map(f=>B("USE_TURN_IP")?an(an({},f),{},{turnServerURL:im(f.turnServerURL)}):f);const p=this.signal.currentURLIndex;l.length>0&&(l=[l[p%l.length]],c.servers=l),Array.isArray(h)&&h.length>0&&(h=[h[0]],c.serversFromGateway=h),I.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(p,",in pre pc"))}const d=B("FINGERPRINT")||this.joinInfo.apResponse.addresses[this.signal.currentURLIndex].fingerprint;if(a&&d){const l=am(a);yt(this,Rr.PRE_CONNECT_PC,{candidates:l,fingerprint:d,turnServer:c}).then(h=>{t==null||t(h)}).catch(i||(()=>{}))}}}),this.signal.on(le.RECOVER_NOTIFICATION,t=>{this.joinInfo&&typeof B("AP_REQUEST_DETAIL")=="string"&&(this.joinInfo.apRequestDetail="".concat(B("AP_REQUEST_DETAIL"),";").concat(t))}),this.signal.on(le.VOS_FALLBACK,t=>{this.emit(Rr.VOS_FALLBACK,t)}),this.signal.on(le.DATACHANNEL_FAILBACK,t=>{I.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(Rr.DATACHANNEL_FAILBACK)})}async tryUnsubBeforeResub(t,i){try{await this.signal.request(Be.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:t,ortc:[i]},!0)}catch(r){throw I.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),r),r}}async tryUnsubDataChannelBeforeResub(t,i){try{await this.signal.request(Be.UNSUBSCRIBE,{stream_id:i.id},!0)}catch(r){throw I.warning("unsubscribe datachannel warning",r),r}}async tryUnpubBeforeRepub(t,i){try{await this.signal.request(Be.UNPUBLISH,{stream_id:t,ortc:i},!0)}catch(r){throw I.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),r),r}}async tryUnpubDataChannelBeforeRepub(t,i){try{await this.signal.request(Be.UNPUBLISH_DATASTREAM,{channnel_id:i.channelId},!0)}catch(r){throw I.warning("unpublish datastream warning: ",r),r}}async tryMassUnsubBeforeResub(t){const i={users:t.map(r=>({stream_id:r.stream_id,stream_type:r.stream_type}))};try{await this.signal.request(Be.UNSUBSCRIBE_STREAMS,i,!0)}catch(r){throw I.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),r),r}}async muteLocal(t,i){const r={action:t.find(o=>o.stream_type===_t.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:i};try{await this.signal.request(Be.CONTROL,r,!0,!0)}catch(o){throw I.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),o),o}}async unmuteLocal(t,i){const r={action:t.find(o=>o.stream_type===_t.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:i};try{await this.signal.request(Be.CONTROL,r,!0,!0)}catch(o){throw I.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),o),o}}async muteRemote(t,i){const r={action:t===be.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(Be.CONTROL,r,!0,!0)}catch(o){throw I.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),o),o}}async unmuteRemote(t,i){const r={action:t===be.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(Be.CONTROL,r,!0,!0)}catch(o){throw I.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),o),o}}uploadWRTCStats(t){this.signal.uploadWRTCStats(t)}upload(t,i){this.signal.upload(t,i)}getSignalRTT(){return this.signal.rtt}async restartICE(t){const i={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:t};try{return await this.signal.request(Be.RESTART_ICE,i,!0)}catch(r){throw I.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),r),r}}reconnect(t,i){this.state==="CONNECTED"&&this.signal.reconnect(t||void 0,i||Gi.P2P_FAILED)}getCurrentGatewayAddress(){var t,i;if(!B("GATEWAY_WSS_ADDRESS"))return B("USE_CANDIDATE_FROM_AP_DETAIL")&&(t=this.joinInfo)!==null&&t!==void 0&&t.apGatewayAddress?(I.debug("[".concat(this.store.clientId,"] use candidate from ap detail, ").concat(JSON.stringify(this.joinInfo.apGatewayAddress))),this.joinInfo.apGatewayAddress):(i=this.joinInfo)!==null&&i!==void 0&&i.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(t){await this.signal.request(Be.SET_PARAMETER,{enablePublishAudioFilter:t})}downgradeCodec(t){this.signal.downgradeCodec(t)}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(bt.FALLBACK)),this.store.useDcSignal=!1,this.signal=new QU(an(an({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(Rr.RESET_SIGNAL)}}let dm=0,cc=0;function na(e,t,i,r){return new Z((o,s)=>{t.timeout=t.timeout||B("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!i?(t.data=JSON.stringify(t.data),dm+=Vd(t.data)):i&&(t.data.size?dm+=t.data.size:t.data instanceof FormData?dm+=TU(t.data):dm+=Vd(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,hs.request(t).then(a=>{typeof a.data=="string"?cc+=Vd(a.data):a.data instanceof ArrayBuffer||a.data instanceof Uint8Array?cc+=a.data.byteLength:cc+=Vd(JSON.stringify(a.data)),r&&o({data:a.data,headers:a.headers}),o(a.data)}).catch(a=>{hs.isCancel(a)?s(new $(O.OPERATION_ABORTED,"cancel token canceled")):a.code==="ECONNABORTED"?s(new $(O.NETWORK_TIMEOUT,a.message)):a.response?s(new $(O.NETWORK_RESPONSE_ERROR,a.response.status)):s(new $(O.NETWORK_ERROR,a.message))})})}/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */(function(){var e;function t(Y){var ie=0;return function(){return ie<Y.length?{done:!1,value:Y[ie++]}:{done:!0}}}var i=typeof Object.defineProperties=="function"?Object.defineProperty:function(Y,ie,Q){return Y==Array.prototype||Y==Object.prototype||(Y[ie]=Q.value),Y},r,o=function(Y){Y=[typeof globalThis=="object"&&globalThis,Y,typeof window=="object"&&window,typeof self=="object"&&self,typeof R=="object"&&R];for(var ie=0;ie<Y.length;++ie){var Q=Y[ie];if(Q&&Q.Math==Math)return Q}throw Error("Cannot find global object")}(this);function s(Y,ie){if(ie)e:{var Q=o;Y=Y.split(".");for(var w=0;w<Y.length-1;w++){var v=Y[w];if(!(v in Q))break e;Q=Q[v]}(ie=ie(w=Q[Y=Y[Y.length-1]]))!=w&&ie!=null&&i(Q,Y,{configurable:!0,writable:!0,value:ie})}}function a(Y){return(Y={next:Y})[Symbol.iterator]=function(){return this},Y}function c(Y){var ie=typeof Symbol<"u"&&Symbol.iterator&&Y[Symbol.iterator];return ie?ie.call(Y):{next:t(Y)}}if(s("Symbol",function(Y){function ie(v,N){this.A=v,i(this,"description",{configurable:!0,writable:!0,value:N})}if(Y)return Y;ie.prototype.toString=function(){return this.A};var Q="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",w=0;return function v(N){if(this instanceof v)throw new TypeError("Symbol is not a constructor");return new ie(Q+(N||"")+"_"+w++,N)}}),s("Symbol.iterator",function(Y){if(Y)return Y;Y=Symbol("Symbol.iterator");for(var ie="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),Q=0;Q<ie.length;Q++){var w=o[ie[Q]];typeof w=="function"&&typeof w.prototype[Y]!="function"&&i(w.prototype,Y,{configurable:!0,writable:!0,value:function(){return a(t(this))}})}return Y}),typeof Object.setPrototypeOf=="function")r=Object.setPrototypeOf;else{var d;e:{var l={};try{l.__proto__={a:!0},d=l.a;break e}catch{}d=!1}r=d?function(Y,ie){if(Y.__proto__=ie,Y.__proto__!==ie)throw new TypeError(Y+" is not extensible");return Y}:null}var h=r;function p(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function f(Y){if(Y.m)throw new TypeError("Generator is already running");Y.m=!0}function m(Y,ie){return Y.h=3,{value:ie}}function g(Y){this.g=new p,this.G=Y}function S(Y,ie,Q,w){try{var v=ie.call(Y.g.j,Q);if(!(v instanceof Object))throw new TypeError("Iterator result "+v+" is not an object");if(!v.done)return Y.g.m=!1,v;var N=v.value}catch(j){return Y.g.j=null,Y.g.s(j),T(Y)}return Y.g.j=null,w.call(Y.g,N),T(Y)}function T(Y){for(;Y.g.h;)try{var ie=Y.G(Y.g);if(ie)return Y.g.m=!1,{value:ie.value,done:!1}}catch(Q){Y.g.v=void 0,Y.g.s(Q)}if(Y.g.m=!1,Y.g.l){if(ie=Y.g.l,Y.g.l=null,ie.F)throw ie.D;return{value:ie.return,done:!0}}return{value:void 0,done:!0}}function C(Y){this.next=function(ie){return Y.o(ie)},this.throw=function(ie){return Y.s(ie)},this.return=function(ie){return function(Q,w){f(Q.g);var v=Q.g.j;return v?S(Q,"return"in v?v.return:function(N){return{value:N,done:!0}},w,Q.g.return):(Q.g.return(w),T(Q))}(Y,ie)},this[Symbol.iterator]=function(){return this}}function b(Y,ie){return ie=new C(new g(ie)),h&&Y.prototype&&h(ie,Y.prototype),ie}if(p.prototype.o=function(Y){this.v=Y},p.prototype.s=function(Y){this.l={D:Y,F:!0},this.h=this.C||this.u},p.prototype.return=function(Y){this.l={return:Y},this.h=this.u},g.prototype.o=function(Y){return f(this.g),this.g.j?S(this,this.g.j.next,Y,this.g.o):(this.g.o(Y),T(this))},g.prototype.s=function(Y){return f(this.g),this.g.j?S(this,this.g.j.throw,Y,this.g.o):(this.g.s(Y),T(this))},s("Array.prototype.entries",function(Y){return Y||function(){return function(ie,Q){ie instanceof String&&(ie+="");var w=0,v=!1,N={next:function(){if(!v&&w<ie.length){var j=w++;return{value:Q(j,ie[j]),done:!1}}return v=!0,{done:!0,value:void 0}}};return N[Symbol.iterator]=function(){return N},N}(this,function(ie,Q){return[ie,Q]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var D=function(Y,ie){for(var Q=0;Q<Y.length;Q++)ie(Y[Q])},x=function(Y){return Y.replace(/\r?\n|\r/g,`\r
`)},k=function(Y,ie,Q){return ie instanceof Blob?(Q=Q!==void 0?Q+"":typeof ie.name=="string"?ie.name:"blob",ie.name===Q&&Object.prototype.toString.call(ie)!=="[object Blob]"||(ie=new File([ie],Q)),[String(Y),ie]):[String(Y),String(ie)]},V=function(Y,ie){if(Y.length<ie)throw new TypeError(ie+" argument required, but only "+Y.length+" present.")},W=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,K=W.FormData,J=W.XMLHttpRequest&&W.XMLHttpRequest.prototype.send,se=W.Request&&W.fetch,Ne=W.navigator&&W.navigator.sendBeacon,Ce=W.Element&&W.Element.prototype,De=W.Symbol&&Symbol.toStringTag;De&&(Blob.prototype[De]||(Blob.prototype[De]="Blob"),"File"in W&&!File.prototype[De]&&(File.prototype[De]="File"));try{new File([],"")}catch{W.File=function(ie,Q,w){return ie=new Blob(ie,w||{}),Object.defineProperties(ie,{name:{value:Q},lastModified:{value:+(w&&w.lastModified!==void 0?new Date(w.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),De&&Object.defineProperty(ie,De,{value:"File"}),ie}}var Me=function(Y){return Y.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},et=function(Y){this.i=[];var ie=this;Y&&D(Y.elements,function(Q){if(Q.name&&!Q.disabled&&Q.type!=="submit"&&Q.type!=="button"&&!Q.matches("form fieldset[disabled] *"))if(Q.type==="file"){var w=Q.files&&Q.files.length?Q.files:[new File([],"",{type:"application/octet-stream"})];D(w,function(v){ie.append(Q.name,v)})}else Q.type==="select-multiple"||Q.type==="select-one"?D(Q.options,function(v){!v.disabled&&v.selected&&ie.append(Q.name,v.value)}):Q.type==="checkbox"||Q.type==="radio"?Q.checked&&ie.append(Q.name,Q.value):(w=Q.type==="textarea"?x(Q.value):Q.value,ie.append(Q.name,w))})};if((e=et.prototype).append=function(Y,ie,Q){V(arguments,2),this.i.push(k(Y,ie,Q))},e.delete=function(Y){V(arguments,1);var ie=[];Y=String(Y),D(this.i,function(Q){Q[0]!==Y&&ie.push(Q)}),this.i=ie},e.entries=function Y(){var ie,Q=this;return b(Y,function(w){if(w.h==1&&(ie=0),w.h!=3)return ie<Q.i.length?w=m(w,Q.i[ie]):(w.h=0,w=void 0),w;ie++,w.h=2})},e.forEach=function(Y,ie){V(arguments,1);for(var Q=c(this),w=Q.next();!w.done;w=Q.next()){var v=c(w.value);w=v.next().value,v=v.next().value,Y.call(ie,v,w,this)}},e.get=function(Y){V(arguments,1);var ie=this.i;Y=String(Y);for(var Q=0;Q<ie.length;Q++)if(ie[Q][0]===Y)return ie[Q][1];return null},e.getAll=function(Y){V(arguments,1);var ie=[];return Y=String(Y),D(this.i,function(Q){Q[0]===Y&&ie.push(Q[1])}),ie},e.has=function(Y){V(arguments,1),Y=String(Y);for(var ie=0;ie<this.i.length;ie++)if(this.i[ie][0]===Y)return!0;return!1},e.keys=function Y(){var ie,Q,w,v,N=this;return b(Y,function(j){if(j.h==1&&(ie=c(N),Q=ie.next()),j.h!=3)return Q.done?void(j.h=0):(w=Q.value,v=c(w),m(j,v.next().value));Q=ie.next(),j.h=2})},e.set=function(Y,ie,Q){V(arguments,2),Y=String(Y);var w=[],v=k(Y,ie,Q),N=!0;D(this.i,function(j){j[0]===Y?N&&(N=!w.push(v)):w.push(j)}),N&&w.push(v),this.i=w},e.values=function Y(){var ie,Q,w,v,N=this;return b(Y,function(j){if(j.h==1&&(ie=c(N),Q=ie.next()),j.h!=3)return Q.done?void(j.h=0):(w=Q.value,(v=c(w)).next(),m(j,v.next().value));Q=ie.next(),j.h=2})},et.prototype._asNative=function(){for(var Y=new K,ie=c(this),Q=ie.next();!Q.done;Q=ie.next()){var w=c(Q.value);Q=w.next().value,w=w.next().value,Y.append(Q,w)}return Y},et.prototype._blob=function(){var Y="----formdata-polyfill-"+Math.random(),ie=[],Q="--"+Y+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(w,v){return typeof w=="string"?ie.push(Q+Me(x(v))+`"\r
\r
`+x(w)+`\r
`):ie.push(Q+Me(x(v))+'"; filename="'+Me(w.name)+`"\r
Content-Type: `+(w.type||"application/octet-stream")+`\r
\r
`,w,`\r
`)}),ie.push("--"+Y+"--"),new Blob(ie,{type:"multipart/form-data; boundary="+Y})},et.prototype[Symbol.iterator]=function(){return this.entries()},et.prototype.toString=function(){return"[object FormData]"},Ce&&!Ce.matches&&(Ce.matches=Ce.matchesSelector||Ce.mozMatchesSelector||Ce.msMatchesSelector||Ce.oMatchesSelector||Ce.webkitMatchesSelector||function(Y){for(var ie=(Y=(this.document||this.ownerDocument).querySelectorAll(Y)).length;0<=--ie&&Y.item(ie)!==this;);return-1<ie}),De&&(et.prototype[De]="FormData"),J){var ae=W.XMLHttpRequest.prototype.setRequestHeader;W.XMLHttpRequest.prototype.setRequestHeader=function(Y,ie){ae.call(this,Y,ie),Y.toLowerCase()==="content-type"&&(this.B=!0)},W.XMLHttpRequest.prototype.send=function(Y){Y instanceof et?(Y=Y._blob(),this.B||this.setRequestHeader("Content-Type",Y.type),J.call(this,Y)):J.call(this,Y)}}se&&(W.fetch=function(Y,ie){return ie&&ie.body&&ie.body instanceof et&&(ie.body=ie.body._blob()),se.call(this,Y,ie)}),Ne&&(W.navigator.sendBeacon=function(Y,ie){return ie instanceof et&&(ie=ie._asNative()),Ne.call(this,Y,ie)}),W.FormData=et}})();const lm=()=>{const e=B("AREAS");return e.length===0&&e.push(mi.GLOBAL),un(e).call(e,(t,i,r)=>{const o=$U(i);return o?r===0?o:"".concat(t,",").concat(o):t},"")},$U=e=>e===mi.OVERSEA?"".concat(wn.ASIA,",").concat(wn.EUROPE,",").concat(wn.AFRICA,",").concat(wn.NORTH_AMERICA,",").concat(wn.SOUTH_AMERICA,",").concat(wn.OCEANIA):wn[e],_C=e=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return e.map(i=>{const r=Aa[i],o=Object.keys(r);o&&o.map(s=>{s!=="CODE"&&(t[s]=t[s].concat(r[s]))})}),t},x_={GLOBAL:{ASIA:[mi.CHINA,mi.JAPAN,mi.INDIA,mi.KOREA,mi.HKMC],EUROPE:[],NORTH_AMERICA:[mi.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},um=Object.keys(x_[mi.GLOBAL]),eL=[mi.CHINA,mi.NORTH_AMERICA,mi.EUROPE,mi.ASIA,mi.JAPAN,mi.INDIA,mi.OCEANIA,mi.SOUTH_AMERICA,mi.AFRICA,mi.KOREA,mi.HKMC,mi.US],e2=function(e,t){let i=[];if(z(e).call(e,mi.GLOBAL)){const s=[mi.GLOBAL,mi.OVERSEA],a=Object.keys(Aa);if(t===mi.GLOBAL)throw new $(O.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===mi.CHINA)i=[mi.OVERSEA];else if(o=t,z(um).call(um,o)){const c=(r=t,x_[mi.GLOBAL][r]||[]),d=[...s,t,...c];i=a.filter(l=>!z(d).call(d,l))}else if(function(c){let d=!1;return um.forEach(l=>{var h;z(h=x_[mi.GLOBAL][l]).call(h,c)&&(d=!0)}),d}(t)){const c=function(l){let h;return um.forEach(p=>{var f;z(f=x_[mi.GLOBAL][p]).call(f,l)&&(h=p)}),h}(t),d=[...s,c,t];i=a.filter(l=>!z(d).call(d,l))}else i=e;i=function(c){const d=[];return eL.forEach(l=>{z(c).call(c,l)&&d.push(l)}),d.concat(c.filter(l=>!z(eL).call(eL,l)))}(i)}else i=e;var r,o;return i};function fC(e){var t,i;if(!e&&z(t=B("AREAS")).call(t,mi.EXTENSIONS))return I.debug("update area from ap : reset"),void mC(jU,!0);if(!z(i=B("AREAS")).call(i,mi.GLOBAL)||!e)return;let r=Aa.EXTENSIONS;r&&(r={CODE:$U(mi.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(e,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(e,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(e,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(e,".agora.io"),"cds-ap-web-2-".concat(e,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(e,".agora.io"),"sua-ap-web-2-".concat(e,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(e,".agora.io"),"uap-ap-web-2-".concat(e,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(e,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(e,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(e,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(e,".agora.io")]},I.debug("update area from ap success: ".concat(e,",config is "),r),F("AREAS",[mi.EXTENSIONS],!0),Object.keys(r).map(o=>{o==="LOG_UPLOAD_SERVER"||o==="EVENT_REPORT_DOMAIN"||o==="EVENT_REPORT_BACKUP_DOMAIN"||o==="PROXY_SERVER_TYPE3"?F(o,r[o][0]):F(o,r[o])}))}function mC(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const i=H.reportApiInvoke(null,{name:ct.SET_AREA,options:e,tag:bi.TRACER});try{let r=[];if(typeof e=="string"&&(r=[e]),Array.isArray(e)&&(e.forEach(s=>{if(!z(Zn).call(Zn,s))throw new $(O.INVALID_PARAMS,"invalid area code")}),r=e),Object.prototype.toString.call(e)==="[object Object]"){const{areaCode:s,excludedArea:a}=e;if(!s)throw new $(O.INVALID_PARAMS,"area code is needed");let c=s;typeof s=="string"&&(c=[s]),r=a?e2(c,a):c}if(!t){if(Ye.AREAS){const s=new $(O.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return i.onError(s),void I.warning("setArea is prohibited because of config-distribute")}if(z(r).call(r,mi.GLOBAL)&&B("AREAS")===mi.EXTENSIONS){const s=new $(O.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return i.onError(s),void I.warning("setArea is prohibited because of ap extensions")}}F("AREAS",r,t);const o=_C(r);Object.keys(o).map(s=>{s==="LOG_UPLOAD_SERVER"||s==="EVENT_REPORT_DOMAIN"||s==="EVENT_REPORT_BACKUP_DOMAIN"||s==="PROXY_SERVER_TYPE3"?F(s,o[s][0]):F(s,o[s])}),I.debug("set area success:",r.join(","))}catch(r){throw i.onError(r),r}i.onSuccess()}function zd(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function Bc(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?zd(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):zd(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let tL=1;function iL(e,t,i,r,o){tL+=1;const s={sid:i.sid,command:"convergeAllocateEdge",uid:"666",appId:i.appId,ts:Math.floor(Date.now()/1e3),seq:tL,requestId:tL,version:Qs,cname:i.cname},a={service_name:t,json_body:JSON.stringify(s)};let c,d,l=e[0];return ma(async()=>{c=Date.now();const h=await na(l,{data:a,cancelToken:r,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(d=Date.now()-c,h.code!==0){const m=new $(O.UNEXPECTED_RESPONSE,"live streaming ap error, code"+h.code,{retry:!0,responseTime:d});throw I.error(m.toString()),m}const p=JSON.parse(h.json_body);if(p.code!==200){const m=new $(O.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(p.code,", reason: ").concat(p.reason),{code:p.code,responseTime:d});throw I.error(m.toString()),m}if(!p.servers||p.servers.length===0){const m=new $(O.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:p.code,responseTime:d});throw I.error(m.toString()),m}const f=function(m,g){return{addressList:m.servers.map(S=>"wss://".concat(S.address.replace(/\./g,"-"),".").concat(B("WORKER_DOMAIN"),":").concat(S.wss,"?serviceName=").concat(encodeURIComponent(g))),workerToken:m.workerToken,vid:m.vid}}(p,t);return B("LIVE_STREAMING_ADDRESS")&&(f.addressList=B("LIVE_STREAMING_ADDRESS")instanceof Array?B("LIVE_STREAMING_ADDRESS"):[B("LIVE_STREAMING_ADDRESS")]),Bc(Bc({},f),{},{responseTime:d})},(h,p)=>(H.apworkerEvent(i.sid,{success:!0,sc:200,serviceName:t,responseDetail:JSON.stringify(h.addressList),firstSuccess:p===0,responseTime:d,serverIp:e[p%e.length]}),!1),(h,p)=>(H.apworkerEvent(i.sid,{success:!1,sc:h.data&&h.data.code||200,serviceName:t,responseTime:d,serverIp:e[p%e.length]}),!!(h.code!==O.OPERATION_ABORTED&&h.code!==O.UNEXPECTED_RESPONSE||h.data&&h.data.retry)&&(l=e[(p+1)%e.length],!0)),o)}let EC=1;function rL(e,t,i,r){let{url:o,areaCode:s}=e;const{clientId:a,sid:c}=t,d=Date.now();let l;const h=t.role,[p,f]=aL(t,s,[kr.CHOOSE_SERVER]);let m=fi.networkState;return ma(async()=>{m&&fi.networkState===yn.OFFLINE&&fi.onlineWaiter&&await Z.race([fi.onlineWaiter,vt(r&&r.maxRetryTimeout||yr.maxRetryTimeout)]),m=fi.networkState;const{data:g,headers:S}=await na(o,{data:p,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);l=S.http3==="1"?1:-1,H.reportResourceTiming(o,c),gC(g,o,t,d,[kr.CHOOSE_SERVER],l);const T=rm(g,kr.CHOOSE_SERVER);return oL(T),Mo(T,o)},g=>(g&&H.joinChooseServer(c,{role:h,lts:d,succ:!0,csAddr:o,opid:f,serverList:g.gatewayAddrs.map(S=>S.address),ec:null,cid:g.cid.toString(),uid:g.uid.toString(),csIp:g.csIp,unilbsServerIds:[kr.CHOOSE_SERVER].toString(),isHttp3:l,corssRegionTagReq:t.apRequestDetail,corssRegionTagRes:g.res.detail&&g.res.detail[38],vid:g.vid}),!1),g=>g.code!==O.OPERATION_ABORTED&&(g.code===O.CAN_NOT_GET_GATEWAY_SERVER?g.data.retry:(H.joinChooseServer(c,{role:h,lts:d,succ:!1,csAddr:o,serverList:null,opid:f,ec:g.code,csIp:g.data&&g.data.csIp,unilbsServerIds:[kr.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:m}),isHttp3:l,corssRegionTagReq:t.apRequestDetail}),I.warning("[".concat(a||"sid-".concat(c.slice(0,6)),"] Choose server network error, retry"),g),!0)),r)}function nL(e,t,i,r){let o,{url:s,areaCode:a,serviceIds:c}=e;const d=Date.now(),l=t.role,[h,p]=aL(t,a,c);let f;return ma(async()=>{f&&fi.networkState===yn.OFFLINE&&fi.onlineWaiter&&await Z.race([fi.onlineWaiter,vt(r&&r.maxRetryTimeout||yr.maxRetryTimeout)]),f=fi.networkState;const{data:m,headers:g}=await na(s,{data:h,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);o=g.http3==="1"?1:-1,H.reportResourceTiming(s,t.sid),gC(m,s,t,d,c,o);const S=rm(m,kr.CHOOSE_SERVER),T=rm(m,t.cloudProxyServer==="proxy5"?kr.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?kr.CLOUD_PROXY:kr.CLOUD_PROXY_FALLBACK),C=performance.getEntriesByName(s),b=C[C.length-1];let D;return b&&(D={name:b.name,protocol:"nextHopProtocol"in b?b.nextHopProtocol:"",dnscost:"domainLookupEnd"in b&&"domainLookupStart"in b&&typeof b.domainLookupEnd=="number"&&typeof b.domainLookupStart=="number"?b.domainLookupEnd-b.domainLookupStart:-1,tcpTlsCost:"connectEnd"in b&&"connectStart"in b&&typeof b.connectEnd=="number"&&typeof b.connectStart=="number"?b.connectEnd-b.connectStart:-1,reqCost:"requestStart"in b&&typeof b.requestStart=="number"&&"responseEnd"in b&&typeof b.responseEnd=="number"?b.responseEnd-b.requestStart:-1,handleCost:"leave_ts"in m&&"enter_ts"in m&&typeof m.leave_ts=="number"&&typeof m.enter_ts=="number"?m.leave_ts-m.enter_ts:-1}),oL(S),{gatewayInfo:Mo(S,s),proxyInfo:T,url:s,resourceTimingInfo:D}},m=>{var g;return m.gatewayInfo&&H.joinChooseServer(t.sid,{role:l,lts:d,succ:!0,csAddr:s,serverList:m.gatewayInfo.gatewayAddrs.map(S=>S.address),ec:null,opid:p,cid:m.gatewayInfo.cid.toString(),uid:m.gatewayInfo.uid.toString(),csIp:m.gatewayInfo.csIp,unilbsServerIds:c.toString(),isHttp3:o,corssRegionTagReq:t.apRequestDetail,corssRegionTagRes:m.gatewayInfo.res.detail&&m.gatewayInfo.res.detail[38],vid:(g=m.gatewayInfo)===null||g===void 0?void 0:g.vid,resourceTimingInfo:m.resourceTimingInfo?JSON.stringify(m.resourceTimingInfo):void 0}),m.proxyInfo&&H.joinWebProxyAP(t.sid,{lts:d,sucess:1,apServerAddr:s,turnServerAddrList:m.proxyInfo.addresses.map(S=>S.ip).join(","),errorCode:null,eventType:t.cloudProxyServer,unilbsServerIds:c.toString()}),!1},m=>m.code!==O.OPERATION_ABORTED&&(m.code===O.CAN_NOT_GET_GATEWAY_SERVER?m.data.retry:(H.joinWebProxyAP(t.sid,{lts:d,sucess:0,apServerAddr:s,turnServerAddrList:null,errorCode:m.code,eventType:t.cloudProxyServer,unilbsServerIds:c.toString(),extend:JSON.stringify({networkState:f})}),I.warning("[".concat(t.clientId,"] multi unilbs network error, retry"),m),!0)),r)}const gC=(e,t,i,r,o,s)=>{const{sid:a,clientId:c,cloudProxyServer:d}=i,l=[],h=p=>{p.flag===4096?H.joinChooseServer(a,{role:i.role,lts:r,succ:!1,csAddr:t,opid:e.opid,serverList:null,ec:p.error.message,csIp:p.error.data&&p.error.data.csIp,unilbsServerIds:o.toString(),isHttp3:s,corssRegionTagReq:i.apRequestDetail}):p.flag!==1048576&&p.flag!==4194304&&p.flag!==4194310||H.joinWebProxyAP(a,{lts:r,sucess:0,apServerAddr:t,turnServerAddrList:null,errorCode:p.error.code,eventType:d,unilbsServerIds:o.toString()})};if(e.response_body.forEach(p=>{const f=p.buffer.code;if(p.uri===23&&f===0&&!p.buffer.edges_services)if(p.buffer.flag===4194310)I.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),p.buffer.edges_services=[];else{const m={error:new $(O.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:B("NO_EDGES_RETRY"),csIp:e.detail[502]}),flag:p.buffer.flag};l.push(m),h(m)}if(f!==0){const m=$f(f),g={error:new $(O.CAN_NOT_GET_GATEWAY_SERVER,m.desc,{desc:m.desc,retry:m.retry,csIp:e.detail[502]}),flag:p.buffer.flag};p.buffer.flag===4194310?I.warning(g.error.toString()):l.push(g),h(g)}}),l.length)throw I.warning("[".concat(c||"sid-".concat(a.slice(0,6)),"] multi unilbs ").concat(t," failed, ").concat(l.map(p=>"flag: ".concat(p.flag,", message: ").concat(p.error.message,", retry: ").concat(p.error.data.retry)).join(" | "))),new $(O.CAN_NOT_GET_GATEWAY_SERVER,l.map(p=>"flag: ".concat(p.flag,", message: ").concat(p.error.message)).join(" | "),{retry:!!l.find(p=>p.error.data.retry),csIp:e.detail[502],desc:[...new Set(l.map(p=>{var f;return p==null||(f=p.error)===null||f===void 0||(f=f.data)===null||f===void 0?void 0:f.desc}).filter(p=>!!p))]})},oL=e=>{var t,i,r,o;if(e.addresses&&e.addresses.length===0&&e.code===0)throw new $(O.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:e.detail&&e.detail[502]});if(B("AP_AREA")&&((r=e.detail)!==null&&r!==void 0&&r[23]&&typeof((o=e.detail)===null||o===void 0?void 0:o[23])=="string"?fC(e.detail[23].toLowerCase()):fC()),(t=e.detail)!==null&&t!==void 0&&t[19]&&typeof((i=e.detail)===null||i===void 0?void 0:i[19])=="string"){const a=e.detail[19],c=a==null?void 0:a.split(";");for(let d=0;d<c.length;d++){var s;const l=rr(s=c[d]).call(s);e.addresses[d]&&c&&(e.addresses[d].fingerprint=l)}}if(B("GATEWAY_ADDRESS")&&B("GATEWAY_ADDRESS").length>0){I.debug("assign gateway address to",B("GATEWAY_ADDRESS"));const a=B("GATEWAY_ADDRESS").map(c=>{var d,l;const h=(d=(l=e.addresses.find(p=>p.ip===c.ip&&p.port===c.port))===null||l===void 0?void 0:l.fingerprint)!==null&&d!==void 0?d:"";return{ip:c.ip,port:c.port,ticket:e.addresses[0]&&e.addresses[0].ticket,fingerprint:c.fingerprint||h}});e.addresses=a}},sL=(e,t)=>{if(e.response_body&&e.response_body.length){const i=e.response_body[0];if(i.buffer.code!==0){const r=$f(i.buffer.code);throw new $(O.UPDATE_TICKET_FAILED,"[".concat(i.buffer.code,"]: ").concat(r.desc),{retry:r.retry})}return i.buffer.ticket}throw I.debug("update ticket request received ap response without response body:",t),new $(O.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},aL=(e,t,i)=>{const r=Math.floor(Math.random()*1e12),o=e.role==="host"?"1":e.role==="audience"?"2":void 0,s={appid:e.appId,client_ts:Date.now(),opid:r,sid:e.sid,request_bodies:[{uri:22,buffer:{cname:e.cname,detail:Bc(Bc(Bc({6:e.stringUid,11:t,12:B("USE_NEW_TOKEN")?"1":void 0},o?{17:o}:{}),{},{22:t},e.apRequestDetail?{33:e.apRequestDetail}:{}),e.apRTM?{26:"RTM2"}:{}),key:e.token,service_ids:i,uid:e.uid||0}}]};s.request_bodies.forEach(c=>{e.multiIP&&e.multiIP.gateway_ip&&(c.buffer.detail[5]=JSON.stringify({vocs_ip:[e.multiIP.uni_lbs_ip],vos_ip:[e.multiIP.gateway_ip]}))});const a=new FormData;return a.append("request",JSON.stringify(s)),[a,r]},hm=(e,t)=>{const i=Math.floor(Math.random()*1e12),r={appid:e.appId,client_ts:Date.now(),opid:i,sid:e.sid,request_bodies:[{uri:28,buffer:{cname:e.cname,detail:{1:"",6:e.stringUid,12:"1"},token:e.token,service_ids:t,uid:e.uid||0,edges_services:e.apResponse.addresses.map(s=>({ip:s.ip,port:s.port}))}}]},o=new FormData;return o.append("request",JSON.stringify(r)),[o,i]};let qd=0;function Dl(e){return Z.all(e.map(t=>t.then(i=>{throw i},i=>i))).then(t=>{throw t},t=>t)}const pm=async e=>{let{fragementLength:t,referenceList:i,asyncMapHandler:r,allFailedhandler:o,promisesCollector:s}=e,a=0;const c=t;let d,l=0;const h=async()=>{const p=(()=>{const f=a*c,m=f+c;return i.slice(f,m).map(r)})();s&&s.push(...p);try{d=await Dl(p)}catch(f){if(l+=c,a++,!(l>=i.length))return void await h();o(f)}p.forEach(f=>f.cancel())};return await h(),d},t2=async e=>{let{referenceList:t,asyncMapHandler:i,closeFn:r}=e;const o=t.length;let s=0;const a=async()=>{const c=i(t.shift());try{return await c}catch(d){if(s++,s>=o||r!=null&&r(d))throw d;return a()}};return a()};async function SC(){if(typeof VideoDecoder>"u")return!0;let e;const t=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,85,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,149,160,133,4,144,43,122,168,159,120,159,205,39,82,131,57,52,87,187,68,23,248,134,204,226,97,17,49,183,55,236,219,249,221,98,208,215,190,59,179,167,213,47,1,246,150,14,194,245,159,83,35,64,103,218,38,21,82,3,135,21,185,84,248,134],i=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,148,62,134,140,92,172,141,77,35,94,181,164,65,169,65,156,154,43,221,162,11,252,67,102,113,48,136,137,219,62,43,113,239,23,126,250,186,252,10,138,218,25,193,244,74,68,194,209,107,23,52,206,199,78,72,98,103,151,71,96,62,51,210,158,72,231,158],r=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,143,233,163,51,196,98,95,151,224,22,134,33,240,150,248,67,18,34,196,142,81,238,173,140,80,205,232,132,144,67,12,131,157,4,171,243,86,122,35,6,166,184,243,85,126,13,206,103,152,62,168,160,187,2,241,138,52,211,72,121,128,151,63,147,128,19,42],o=[18,0,50,138,1,48,192,64,253,248,65,17,67,192,32,0,16,0,0,0,0,0,0,0,195,12,48,144,64,32,0,209,75,61,9,204,25,115,79,226,115,63,63,208,70,210,220,153,126,241,237,37,107,195,153,1,99,112,230,189,209,169,130,10,11,22,167,215,159,205,197,7,183,162,26,48,254,141,134,103,32,16,235,45,1,15,18,119,169,110,206,251,51,115,202,60,148,1,46,39,109,25,28,86,168,15,77,211,239,2,58,43,146,26,230,184,81,48,140,226,226,250,222,146,171,133,164,13,188,180,64,122,142,146,32,208,238,170,193,35,53,44,225],s=[18,0,50,107,48,0,133,125,248,65,26,195,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,204,24,122,65,56,165,18,52,206,218,4,187,51,97,9,29,191,90,253,106,185,31,197,155,52,205,245,185,203,131,20,226,25,124,95,113,220,113,141,15,15,104,211,144,152,237,150,157,127,51,143,24,231,218,171,255,176,241,128,229,149,150,148,66,245,228,91,27,182,228,136,61,182,237,133,45,220,24,103,214,152],a=[18,0,50,122,48,1,9,253,248,65,26,67,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,198,182,231,242,220,235,163,140,12,36,36,166,46,132,210,4,71,23,218,132,27,30,17,45,244,79,31,243,195,136,100,169,76,88,142,85,204,217,121,168,29,163,198,17,251,223,73,12,212,244,139,123,151,179,75,216,96,208,136,40,229,42,59,149,10,116,228,85,99,93,221,108,255,140,248,20,30,167,122,109,206,164,108,197,110,251,23,243,133,160,63,13,207,177,12,128];return await new Z((d,l)=>{let h;(async function(){e&&e.state!=="closed"||await async function(){e=new VideoDecoder({output:f=>{f.close(),clearTimeout(h),d(!0)},error:f=>{clearTimeout(h),d(!1)}}),await e.configure({codec:"av01.0.05M.08",width:160,height:90})}();const p=[t,i,r,o,s,a];for(let f=0;f<p.length;f++){const m=new EncodedVideoChunk({type:f==0?"key":"delta",timestamp:33333*f,duration:33333,data:new Uint8Array(p[f])});try{await e.decode(m)}catch{return void d(!1)}}})(),h=setTimeout(()=>{d(!1)},5e3)})}async function FT(e,t,i,r){return{gatewayInfo:await async function(s,a,c,d){let l=null;const h=[],p=async()=>{const m=B("WEBCS_DOMAIN").slice(0,B("AJAX_REQUEST_CONCURRENT")).map(T=>({url:s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(T+"/api/v2/transpond/webrtc?v=2"):"https://".concat(T,"/api/v2/transpond/webrtc?v=2"),areaCode:lm()})),g=d.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:m.map(T=>T.url)}),S=await pm({fragementLength:B("FRAGEMENT_LENGTH"),referenceList:m,asyncMapHandler:T=>(I.debug("[".concat(s.clientId,"] Connect to choose_server:"),T.url),rL(T,s,a,c)),allFailedhandler:T=>{throw d.recordJoinChannelService({endTs:Date.now(),status:"error",errors:T},g),T[0]},promisesCollector:h});return d.recordJoinChannelService({endTs:Date.now(),status:"success"},g),S},f=async()=>{if(await vt(1e3),l!==null)return l;const m=B("WEBCS_DOMAIN_BACKUP_LIST").map(T=>({url:s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(T+"/api/v2/transpond/webrtc?v=2"):"https://".concat(T,"/api/v2/transpond/webrtc?v=2"),areaCode:lm()})),g=d.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:m.map(T=>T.url)}),S=await pm({fragementLength:B("FRAGEMENT_LENGTH"),referenceList:m,asyncMapHandler:T=>(I.debug("[".concat(s.clientId,"] Connect to backup choose_server:"),T.url),rL(T,s,a,c)),allFailedhandler:T=>{throw d.recordJoinChannelService({endTs:Date.now(),status:"error",errors:T},g),T[0]},promisesCollector:h});return d.recordJoinChannelService({endTs:Date.now(),status:"success"},g),S};try{return l=await Dl([p(),f()]),h.length&&h.forEach(m=>m.cancel&&typeof m.cancel=="function"&&m.cancel()),l}catch(m){throw m[0]}}(e,t,i,r)}}async function cL(e,t,i,r,o){const s=e.cloudProxyServer;if(s==="disabled"){if(e.useLocalAccessPoint)return await FT(e,t,i,o);if(B("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:f,proxyInfo:m}=await n2(e,t,i,o);if(e.turnServer&&e.turnServer.mode!=="auto")return{gatewayInfo:f};const g=m.map(S=>({turnServerURL:S.address,tcpport:S.tcpport||En.tcpport,udpport:S.udpport||En.udpport,username:S.username||En.username,password:S.password||En.password,forceturn:!1,security:!0}));if(o.useP2P){var a;const S=(a=e.uid)!==null&&a!==void 0?a:f.uid,T="glb:".concat(S.toString()),C=await Ki(T),b=m.map(D=>({turnServerURL:D.address,tcpport:D.tcpport||En.tcpport,udpport:D.udpport||En.udpport,username:T,password:C,forceturn:!1,security:!0}));g.push(...b)}return e.turnServer={mode:"manual",servers:g},{gatewayInfo:f}}return await FT(e,t,i,o)}const{proxyInfo:c,gatewayInfo:d}=await n2(e,t,i,o),l={gatewayInfo:d},h=c.map(f=>({turnServerURL:f.address,tcpport:s==="proxy3"?void 0:f.tcpport?f.tcpport:En.tcpport,udpport:s==="proxy4"?void 0:f.udpport?f.udpport:En.udpport,username:f.username||En.username,password:f.password||En.password,forceturn:s!=="proxy4",security:s==="proxy5"}));if(o.useP2P){var p;const f=(p=e.uid)!==null&&p!==void 0?p:d.uid,m="glb:".concat(f.toString()),g=await Ki(m),S=c.map(T=>({turnServerURL:T.address,tcpport:s==="proxy3"?void 0:T.tcpport||En.tcpport,udpport:s==="proxy4"?void 0:T.udpport||En.udpport,username:m,password:g,forceturn:s!=="proxy4",security:s==="proxy5"}));h.push(...S)}return e.turnServer={mode:"manual",servers:h},I.debug("[".concat(e.clientId,"] set proxy server: ").concat(e.proxyServer,", mode: ").concat(s)),l}async function i2(e,t,i,r,o){const s=B("ACCOUNT_REGISTER").slice(0,B("AJAX_REQUEST_CONCURRENT"));let a=[];a=t.proxyServer?s.map(d=>"https://".concat(t.proxyServer,"/ap/?url=").concat(d+"/api/v1")):s.map(d=>"https://".concat(d,"/api/v1"));const c=o==null?void 0:o.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:a});try{const d=await async function(l,h,p,f,m){const g=Date.now(),S={sid:p.sid,opid:10,appid:p.appId,string_uid:h};let T=l[0];const C=await ma(()=>na(T+"".concat(T.indexOf("?")===-1?"?":"&","action=stringuid"),{data:S,cancelToken:f,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(b,D)=>{if(b.code===0){if(b.uid<=0||b.uid>=Math.pow(2,32))throw I.error("Invalid Uint Uid ".concat(h," => ").concat(b.uid),b),H.reqUserAccount(S.sid,{lts:g,success:!1,serverAddr:T,stringUid:S.string_uid,uid:b.uid,errorCode:O.INVALID_UINT_UID_FROM_STRING_UID,extend:S}),new $(O.INVALID_UINT_UID_FROM_STRING_UID);return H.reqUserAccount(S.sid,{lts:g,success:!0,serverAddr:T,stringUid:S.string_uid,uid:b.uid,errorCode:null,extend:S}),!1}const x=$f(b.code);return x.retry&&(T=l[(D+1)%l.length]),H.reqUserAccount(S.sid,{lts:g,success:!1,serverAddr:T,stringUid:S.string_uid,uid:b.uid,errorCode:x.desc,extend:S}),x.retry},(b,D)=>b.code!==O.OPERATION_ABORTED&&(H.reqUserAccount(S.sid,{lts:g,success:!1,serverAddr:T,stringUid:S.string_uid,uid:null,errorCode:b.code,extend:S}),T=l[(D+1)%l.length],!0),m);if(C.code!==0){const b=$f(C.code);throw new $(O.UNEXPECTED_RESPONSE,b.desc)}return C}(a,e,t,i,r);return o==null||o.recordJoinChannelService({status:"success",endTs:Date.now()},c),d.uid}catch(d){throw o==null||o.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[d]},c),d}}async function Sz(e,t,i){const r=B("ACCOUNT_REGISTER");let o=[];o=t.proxyServer?r.map(s=>"https://".concat(t.proxyServer,"/ap/?url=").concat(s+"/api/v1")):r.map(s=>"https://".concat(s,"/api/v1"));try{return await t2({referenceList:o,asyncMapHandler:a=>async function(c,d,l,h){const p=Date.now(),f={sid:l.sid,opid:10,appid:l.appId,string_uid:d};try{const m=await na(c+"".concat(c.indexOf("?")===-1?"?":"&","action=stringuid"),{data:f,cancelToken:h,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(m.code!==0){const g=$f(m.code);throw new $(O.UNEXPECTED_RESPONSE,"preload sua error:".concat(g.desc),g)}if(m.uid<=0||m.uid>=Math.pow(2,32))throw new $(O.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:p,url:c,req:f,uid:m.uid,elapse:Date.now()-p}}catch(m){throw m}}(a,e,t,i),closeFn:a=>a.code===O.OPERATION_ABORTED||a.code===O.UNEXPECTED_RESPONSE&&!a.data.retry})}catch(s){throw s}}async function r2(e,t,i){const r=B("CDS_AP").slice(0,B("AJAX_REQUEST_CONCURRENT")).map(d=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(d+"/api/v1"):"https://".concat(d,"/api/v1?action=config")),o=r.map(d=>function(l,h,p,f){const m=ii(),g={flag:64,cipher_method:0,features:Bc(Bc(Bc(Bc(Bc({install_id:Js(),device:m.name,system:m.os,system_general:navigator.userAgent,vendor:h.appId,version:Qs,cname:h.cname,session_id:h.sid,proxyServer:h.proxyServer,sdk_type:Wr.WEB_RTC,browser_name:m.name,browser_version:m.version,user_agent:navigator.userAgent,channel_name:h.cname},h.stringUid&&{string_uid:h.stringUid}),h.uid&&{uid:h.uid+""}),m.os&&{os_name:m.os}),m.osVersion&&{os_version:m.osVersion}),{},{detail:""})};return ma(()=>na(l,{data:g,timeout:1e3,cancelToken:p,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,S=>S.code!==O.OPERATION_ABORTED,f)}(d,e,t,i));let s=null,a=null,c={};try{s=await Dl(o)}catch(d){if(d.code===O.OPERATION_ABORTED)throw d;a=d}if(o.forEach(d=>d.cancel()),H.reportApiInvoke(e.sid,{name:ct.REQUEST_CONFIG_DISTRIBUTE,options:{error:a,res:s}}).onSuccess(),s&&s.test_tags)try{c=function(d){if(!d.test_tags)return{};const l=d.test_tags,h=Object.keys(l),p={};return h.forEach(f=>{var m;const g=rr(m=f.slice(4)).call(m),S=JSON.parse(l[f]),T=S[1];p[g]={tag:S[0]||"",value:T}}),p}(s)}catch{}return c}async function dL(e,t){const i=B("WEBCS_DOMAIN").concat(B("WEBCS_DOMAIN_BACKUP_LIST")).map(r=>({url:"https://".concat(r,"/api/v2/transpond/webrtc?v=2"),areaCode:lm(),serviceIds:[kr.CHOOSE_SERVER,kr.CLOUD_PROXY_FALLBACK]}));try{return await t2({referenceList:i,asyncMapHandler:o=>async function(s,a,c){let d,{url:l,areaCode:h,serviceIds:p}=s;const f=Date.now(),[m,g]=aL(a,h,p);let S=fi.networkState;try{S&&fi.networkState===yn.OFFLINE&&fi.onlineWaiter&&await Z.race([fi.onlineWaiter,vt(yr.maxRetryTimeout)]),S=fi.networkState;const{data:T,headers:C}=await na(l,{data:m,cancelToken:c,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);d=C.http3==="1"?1:-1,(k=>{const V=[];if(k.response_body.forEach(W=>{const K=W.buffer.code;if(W.uri===23&&K===0&&!W.buffer.edges_services)if(W.buffer.flag===4194310)W.buffer.edges_services=[];else{const J={error:new $(O.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:B("NO_EDGES_RETRY"),csIp:k.detail[502]}),flag:W.buffer.flag};V.push(J)}if(K!==0){const J=$f(K),se={error:new $(O.CAN_NOT_GET_GATEWAY_SERVER,J.desc,{desc:J.desc,retry:J.retry,csIp:k.detail[502]}),flag:W.buffer.flag};W.buffer.flag===4194310?I.warning(se.error.toString()):V.push(se)}}),V.length)throw new $(O.CAN_NOT_GET_GATEWAY_SERVER,V.map(W=>"flag: ".concat(W.flag,", message: ").concat(W.error.message)).join(" | "),{retry:!!V.find(W=>W.error.data.retry),csIp:k.detail[502],desc:[...new Set(V.map(W=>{var K;return W==null||(K=W.error)===null||K===void 0||(K=K.data)===null||K===void 0?void 0:K.desc}).filter(W=>!!W))]})})(T);const D=rm(T,kr.CHOOSE_SERVER),x=rm(T,kr.CLOUD_PROXY_FALLBACK);return oL(D),{gatewayInfo:Mo(D,l),proxyInfo:x,opid:g,requestTime:f,url:l,isHttp3:d,elapse:Date.now()-f}}catch(T){throw T}}(o,e,t),closeFn:o=>o.code===O.OPERATION_ABORTED||o.code===O.CAN_NOT_GET_GATEWAY_SERVER&&!o.data.retry})}catch(r){throw r}}async function n2(e,t,i,r){const o=B("PROXY_SERVER_TYPE3"),s=(m,g,S)=>{let T=S||o;return Array.isArray(T)&&(T=g%2==0&&o[1]||o[0]),"https://".concat(T,"/ap/?url=").concat(m)};let a=null;const c=[],d=async()=>{const m=B("WEBCS_DOMAIN").slice(0,B("AJAX_REQUEST_CONCURRENT")).map((T,C)=>{let b;return b=e.cloudProxyServer==="disabled"&&e.proxyServer?s("".concat(T,"/api/v2/transpond/webrtc?v=2"),C,e.proxyServer):e.cloudProxyServer==="disabled"||e.cloudProxyServer==="fallback"?"https://".concat(T,"/api/v2/transpond/webrtc?v=2"):s("".concat(T,"/api/v2/transpond/webrtc?v=2"),C),{url:b,areaCode:lm(),serviceIds:[kr.CHOOSE_SERVER,e.cloudProxyServer==="proxy5"?kr.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?kr.CLOUD_PROXY:kr.CLOUD_PROXY_FALLBACK]}}),g=r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:m.map(T=>T.url)}),S=await pm({fragementLength:B("FRAGEMENT_LENGTH"),referenceList:m,asyncMapHandler:T=>(I.debug("[".concat(e.clientId,"] Connect to choose_server:"),T.url),nL(T,e,t,i)),allFailedhandler:T=>{throw r.recordJoinChannelService({endTs:Date.now(),status:"error",errors:T},g),T[0]},promisesCollector:c});return r.recordJoinChannelService({endTs:Date.now(),status:"success"},g),S},l=async()=>{if(await vt(1e3),a!==null)return a;const m=B("WEBCS_DOMAIN_BACKUP_LIST").map((T,C)=>{let b;return b=e.cloudProxyServer==="disabled"&&e.proxyServer?s("".concat(T,"/api/v2/transpond/webrtc?v=2"),C,e.proxyServer):e.cloudProxyServer==="disabled"||e.cloudProxyServer==="fallback"?"https://".concat(T,"/api/v2/transpond/webrtc?v=2"):s("".concat(T,"/api/v2/transpond/webrtc?v=2"),C),{url:b,areaCode:lm(),serviceIds:[kr.CHOOSE_SERVER,e.cloudProxyServer==="proxy5"?kr.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?kr.CLOUD_PROXY:kr.CLOUD_PROXY_FALLBACK]}}),g=r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:m.map(T=>T.url)}),S=await pm({fragementLength:B("FRAGEMENT_LENGTH"),referenceList:m,asyncMapHandler:T=>(I.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),T.url),nL(T,e,t,i)),allFailedhandler:T=>{throw r.recordJoinChannelService({endTs:Date.now(),status:"error",errors:T},g),T[0]},promisesCollector:c});return r.recordJoinChannelService({endTs:Date.now(),status:"success"},g),S};let h,p,f;try{({gatewayInfo:h,proxyInfo:p,url:f}=await Dl([d(),l()]))}catch(m){throw m[0]}if(c.length&&c.forEach(m=>m.cancel&&typeof m.cancel=="function"&&m.cancel()),!h||!p)throw new $(O.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(e.apUrl=f,e.cloudProxyServer!=="disabled"&&Array.isArray(o)&&f){const m=/^https?:\/\/(.+?)(\/.*)?$/.exec(f)[1];z(o).call(o,m)&&(e.proxyServer=m,I.setProxyServer(m),H.setProxyServer(m))}return a={gatewayInfo:h,proxyInfo:await sC(p,h.uid)},a}async function Tz(e,t,i){const r=B("UAP_AP").slice(0,B("AJAX_REQUEST_CONCURRENT")).map(s=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(s+"/api/v1?action=uap"):"https://".concat(s,"/api/v1?action=uap")),o=r.map(s=>function(a,c,d,l){const h={command:"convergeAllocateEdge",sid:c.sid,appId:c.appId,token:c.token,ts:Date.now(),version:Qs,cname:c.cname,uid:c.uid.toString(),requestId:EC,seq:EC};EC+=1;const p={service_name:"tele_channel",json_body:JSON.stringify(h)};return ma(async()=>{const f=await na(a,{data:p,cancelToken:d,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(f.code!==0){const g=new $(O.UNEXPECTED_RESPONSE,"cross channel ap error, code"+f.code,{retry:!0});throw I.error(g.toString()),g}const m=JSON.parse(f.json_body);if(m.code!==200){const g=new $(O.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(m.code,", reason: ").concat(m.reason));throw I.error(g.toString()),g}if(!m.servers||m.servers.length===0){const g=new $(O.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw I.error(g.toString()),g}return{vid:m.vid,workerToken:m.workerToken,addressList:(B("CHANNEL_MEDIA_RELAY_SERVERS")||m.servers).map(g=>"wss://".concat(g.address.replace(/\./g,"-"),".").concat(B("WORKER_DOMAIN"),":").concat(g.wss))}},void 0,f=>!!(f.code!==O.OPERATION_ABORTED&&f.code!==O.UNEXPECTED_RESPONSE||f.data&&f.data.retry),l)}(s,e,t,i));try{const s=await Dl(o);return o.forEach(a=>a.cancel()),s}catch(s){throw s[0]}}async function o2(e,t,i){let r=null;const o=[],s=async a=>{const c=B(a?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(d=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(d+"/api/v2/transpond/webrtc?v=2"):"https://".concat(d,"/api/v2/transpond/webrtc?v=2"));return a&&(await vt(1e3),r!==null)?r:await pm({fragementLength:B("FRAGEMENT_LENGTH"),referenceList:c,asyncMapHandler:d=>(I.debug("[".concat(e.clientId,"] update ticket, Connect to ").concat(a?"backup":""," choose_server:"),d),function(l,h,p,f){const[m]=hm(h,[kr.CHOOSE_SERVER]);let g=fi.networkState;return ma(async()=>{g&&fi.networkState===yn.OFFLINE&&fi.onlineWaiter&&await Z.race([fi.onlineWaiter,vt(f&&f.maxRetryTimeout||yr.maxRetryTimeout)]),g=fi.networkState;const S=await na(l,{data:m,cancelToken:p,headers:{"Content-Type":"multipart/form-data;"}},!0);return sL(S,l)},()=>!1,S=>S.code!==O.OPERATION_ABORTED&&(S.code===O.UPDATE_TICKET_FAILED?S.data.retry:(I.warning("[".concat(h.clientId,"] update ticket network error, retry"),S),!0)),f)}(d,e,t,i)),allFailedhandler:d=>{throw d[0]},promisesCollector:o})};try{return r=await Dl([s(!1),s(!0)]),o.length&&o.forEach(a=>a.cancel&&typeof a.cancel=="function"&&a.cancel()),r}catch(a){throw a[0]}}function TC(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function lL(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?TC(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):TC(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}class Rz extends Vi{get isSuccess(){return!!this.configs}constructor(t,i){super(),M(this,"configs",void 0),M(this,"store",void 0),M(this,"joinInfo",void 0),M(this,"cancelToken",void 0),M(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),M(this,"interval",void 0),M(this,"mutex",void 0),M(this,"mutableParamsRead",!1),M(this,"configCache",{}),M(this,"limit_bitrate",void 0),this.mutex=new jr("config-distribute",t),this.store=i}startGetConfigDistribute(t,i){this.joinInfo=t,this.cancelToken=i,this.interval&&this.stopGetConfigDistribute(),B("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},B("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.configs=void 0,this.limit_bitrate=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,H.reportApiInvoke(null,{options:void 0,name:ct.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:bi.TRACER}).onSuccess(JSON.stringify(Ye))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void I.debug("[config-distribute] get config distribute interrupted have no joininfo");let t;const i=await this.mutex.lock();try{t=await r2(this.joinInfo,this.cancelToken,this.retryConfig),I.debug("[config-distribute] get config distribute",JSON.stringify(t));const r=function(o){var s;const a=Ka(s=Object.keys(o).filter(l=>/^webrtc_ng_global_parameter/.test(l))).call(s);for(let l=0;l<a.length;l++)for(let h=a.length-1;h>l;h--){const p=a[h],f=o[p].value;if(typeof f.__priority=="number"){const m=f.__priority,g=a[h-1],S=o[g].value;if(typeof S.__priority=="number"){if(!(m>S.__priority))continue;{const T=p;a[h]=a[h-1],a[h-1]=T}}else{const T=p;a[h]=a[h-1],a[h-1]=T}}}const c=Date.now(),d={};return a.forEach(l=>{const h=o[l].value.__expires;h&&h<=c||(d[l]=o[l])}),d}(t);this.cacheGlobalParameterConfig(r),this.store.hasStartJoinChannel||(this.store.isABTestSuccess=!0),this.configs=r}catch(r){const o=new $(O.NETWORK_RESPONSE_ERROR,r);I.warning("[config-distribute] ".concat(o.toString()))}finally{i()}}getBitrateLimit(){return this.limit_bitrate||void 0}handleBitrateLimit(t){HP(t)&&(this.limit_bitrate?this.limit_bitrate&&this.limit_bitrate.id!==t.id&&this.emit(Uc.UPDATE_BITRATE_LIMIT,t):this.emit(Uc.UPDATE_BITRATE_LIMIT,t))}getLowStreamConfigDistribute(){return this.limit_bitrate&&lL({},this.limit_bitrate.low_stream_uplink)}handleABTestConfigDistribute(t){try{const i={},r=Object.keys(t),o=[];r.forEach(s=>{const a=t[s].value;i[s]=a;const c=a.__id;if(c&&this.configCache[s]&&this.configCache[s].__id===c)return;const d=a.__type,l=t[s].value,h=t[s].tag;let p=0;d?d===Zs.REALTIME&&(p=1):Object.keys(l).some(f=>Object.prototype.hasOwnProperty.call(Si,f)||!MP()&&Object.prototype.hasOwnProperty.call(Bf,f)?(p=1,!0):void 0),o.push({tag:h,isApplied:p,feature:s,params:JSON.stringify(a)})}),o.forEach(s=>{let{tag:a,feature:c,params:d,isApplied:l}=s;this.store.sessionId&&H.abTest(this.store.sessionId,{intSucc:1,isApplied:l,tag:a,feature:c,params:d,cid:this.store.cid,uid:this.store.intUid})}),this.configCache=i}catch(i){I.debug("handleABTestConfigDistribute error",i)}}cacheGlobalParameterConfig(t){const i=function(o){const s={};return Object.keys(o).forEach(a=>{const c=o[a].value,d=c.__expires,l=c.__type;Object.keys(c).forEach(h=>{h==="__id"||h==="__type"||h==="__priority"||h==="__expires"||Object.prototype.hasOwnProperty.call(s,h)||(s[h]=lL(lL({value:c[h]},d&&{expires:d}),l&&{type:l}))})}),s}(t);try{var r;const o=(r=i.LIMIT_BITRATE)===null||r===void 0?void 0:r.value;delete i.LIMIT_BITRATE,o&&HP(o)&&this.handleBitrateLimit(o),this.limit_bitrate=o,this.handleGlobalParameterConfig(i),this.handleABTestConfigDistribute(t),function(c){try{const d=Date.now();Object.keys(c).forEach(l=>{const{value:h,type:p,expires:f}=c[l];f&&f<=d||((p===Zs.REALTIME||Object.prototype.hasOwnProperty.call(Si,l))&&(Ye[l]=h,$e[l]=h,I.debug("Update realtime parameters from config distribute",l,h)),p||MP()||!Object.prototype.hasOwnProperty.call(Bf,l)||(Ye[l]=h,$e[l]=h,I.debug("Update gateway parameters from config distribute",l,h)))})}catch(d){I.error("Error update config immediately: ".concat(c),d.message)}}(i);const s=JSON.stringify(i),a=window.btoa(s);window.localStorage.setItem("websdk_ng_global_parameter",a),I.debug("Caching global parameters ".concat(s))}catch(o){I.error("Error caching global parameters:",o.message)}}handleGlobalParameterConfig(t){try{const i=Date.now();Object.keys(t).forEach(r=>{switch(r){case"CLIENT_ROLE_OPTIONS":if(Object.prototype.hasOwnProperty.call($e,r)){const{value:s,expires:a}=t[r];if(a&&a<=i)return;iT($e[r],s)||(Ye[r]=s,$e[r]=s,this.emit(Uc.UPDATE_CLIENT_ROLE_OPTIONS,s),I.debug("Updating client role options: ".concat(JSON.stringify(s))))}break;case"REMOTE_VIDEO_STREAM_TYPE":if(Object.prototype.hasOwnProperty.call($e,r)){var o;const{value:s,expires:a}=t[r];if(a&&a<=i)return;typeof s=="number"&&z(o=[0,1,4,5,6,7,8,9]).call(o,s)&&(Ye[r]={value:s},$e[r]=s,this.emit(Uc.UPDATE_REMOTE_VIDEO_STREAM_TYPE,s),I.debug("Updating client remote stream type: ".concat(JSON.stringify(s))))}break;case"ENABLE_FORCE_HLS":if(Object.prototype.hasOwnProperty.call($e,r)){const{value:s,expires:a}=t[r];if(a&&a<=i)return;iT($e[r],s)||(Ye[r]=s,$e[r]=s,this.emit(Uc.FALLBACK_TO_HLS,s),I.debug("Updating enable force hls: ".concat(JSON.stringify(s))))}break;case"VOS_CONFIGURE":if(Object.prototype.hasOwnProperty.call($e,r)){const{value:s,expires:a}=t[r];if(a&&a<=i)return;iT($e[r],s)||(Ye[r]=s,$e[r]=s,this.emit(Uc.UPDATE_VOS_CONFIGURE,s),I.debug("Updating vos configure: ".concat(JSON.stringify(s))))}}})}catch(i){I.error("Error handling global parameter config:",i.message)}}}class uL extends Vi{constructor(){super(...arguments),M(this,"resultStorage",new Map)}setLocalAudioStats(t,i,r){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",t,this.checkAudioInputLevel(r,i)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",t,this.checkSendAudioBitrate(r,i))}setLocalVideoStats(t,i,r){this.record("SEND_VIDEO_BITRATE_TOO_LOW",t,this.checkSendVideoBitrate(r,i)),this.record("FRAMERATE_INPUT_TOO_LOW",t,this.checkFramerateInput(r,i)),this.record("FRAMERATE_SENT_TOO_LOW",t,this.checkFramerateSent(r)),!i.muted&&this.record("VIDEO_ENCODE_FAILED",t,this.checResolutionSent(r))}setRemoteAudioStats(t,i){const r=t.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",r,this.checkAudioOutputLevel(i))}setRemoteVideoStats(t,i){const r=t.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",r,this.checkVideoDecode(i))}record(t,i,r){if(B("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(t)||this.resultStorage.set(t,{result:[],isPrevNormal:!0});const o=this.resultStorage.get(t);if(!o)return;o.result.push(r);const s=t==="VIDEO_ENCODE_FAILED"?B("ENCODE_EXCEPTION_TIMES"):5;if(o.result.length>=s){var a;const c=z(a=o.result).call(a,!0);o.isPrevNormal&&!c&&this.emit("exception",qn[t],t,i),!o.isPrevNormal&&c&&this.emit("exception",qn[t]+2e3,t+"_RECOVER",i),o.isPrevNormal=c,o.result=[]}}checkAudioOutputLevel(t){return!(t.receiveBitrate>0&&t.receiveLevel===0)}checkAudioInputLevel(t,i){return i instanceof nn&&!i.isActive||!!i.muted||t.sendVolumeLevel!==0}checkFramerateInput(t,i){let r=null;i._encoderConfig&&i._encoderConfig.frameRate&&(r=qo(i._encoderConfig.frameRate));const o=t.captureFrameRate;return!r||!o||!(r>10&&o<5||r<10&&r>=5&&o<=1)}checkFramerateSent(t){return!(t.captureFrameRate&&t.sendFrameRate&&t.captureFrameRate>5&&t.sendFrameRate<=1)}checResolutionSent(t){var i;return!(!t.codecType||z(i=B("ENCODE_EXCEPTION_VALIDATE_CODEC")).call(i,t.codecType.toLocaleLowerCase()))||!t.captureFrameRate||t.sendFrameRate!==0||t.sendResolutionWidth!==0||t.sendResolutionHeight!==0}checkSendVideoBitrate(t,i){return!!i.muted||t.sendBitrate!==0}checkSendAudioBitrate(t,i){return i instanceof nn&&!i.isActive||!!i.muted||t.sendBitrate!==0}checkVideoDecode(t){return t.receiveBitrate===0||t.decodeFrameRate!==0}}const qn={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003,VIDEO_ENCODE_FAILED:2004},eo=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(i.length>0){const r=i[i.length-1];return Math.round(performance.now()-r.startTime)}return 0}measureFromPublishStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(i.length>0){const r=i[i.length-1];return Math.round(performance.now()-r.startTime)}return 0}};function Wh(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function Xd(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Wh(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Wh(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}class _m{constructor(t){M(this,"store",void 0),M(this,"onStatsException",void 0),M(this,"onUploadPublishDuration",void 0),M(this,"onStatsChanged",void 0),M(this,"onVideoCodecChanged",void 0),M(this,"localStats",new Map),M(this,"remoteStats",new Map),M(this,"updateStatsInterval",void 0),M(this,"trafficStats",void 0),M(this,"trafficStatsPeerList",[]),M(this,"uplinkStats",void 0),M(this,"exceptionMonitor",void 0),M(this,"p2pChannel",void 0),M(this,"scalabilityMode",Vf.L1T1),M(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=t,this.exceptionMonitor=new uL,this.exceptionMonitor.on("exception",(i,r,o)=>{this.onStatsException&&this.onStatsException(i,r,o)})}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(ue.LocalAudioTrack)||Xd({},cT)}getLocalVideoTrackStats(){return this.localStats.get(ue.LocalVideoTrack)||Xd({},Mv)}getRemoteAudioTrackStats(t){const i=(s,a)=>{if(!this.trafficStats)return a;const c=this.trafficStats.peer_delay.find(d=>d.peer_uid===s);return c&&(a.publishDuration=c.B_ppad+(Date.now()-this.trafficStats.timestamp)),a},r={};if(t){var o;const s=(o=this.remoteStats.get(t))===null||o===void 0?void 0:o.audioStats;s&&(r[t]=i(t,s))}else Array.from(this.remoteStats.entries()).forEach(s=>{let[a,{audioStats:c}]=s;c&&(r[a]=i(a,c))});return r}getRemoteNetworkQualityStats(t){const i={};if(t){var r;const o=(r=this.remoteStats.get(t))===null||r===void 0?void 0:r.networkStats;o&&(i[t]=o)}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{networkStats:a}]=o;a&&(i[s]=a)});return i}getNetworkQuality(){let t=0,i=0;return this.trafficStats&&(t=Gh(this.trafficStats.B_unq),i=Gh(this.trafficStats.B_dnq)),{uplinkNetworkQuality:t,downlinkNetworkQuality:i}}getRemoteVideoTrackStats(t){const i=(s,a)=>{if(!this.trafficStats)return a;const c=this.trafficStats.peer_delay.find(d=>d.peer_uid===s);return c&&(a.publishDuration=c.B_ppvd+(Date.now()-this.trafficStats.timestamp)),a},r={};if(t){var o;const s=(o=this.remoteStats.get(t))===null||o===void 0?void 0:o.videoStats;s&&(r[t]=i(t,s))}else Array.from(this.remoteStats.entries()).forEach(s=>{let[a,{videoStats:c}]=s;c&&(r[a]=i(a,c))});return r}getRTCStats(){let t=0,i=0,r=0,o=0;const s=this.localStats.get(ue.LocalAudioTrack);s&&(t+=s.sendBytes,i+=s.sendBitrate);const a=this.localStats.get(ue.LocalVideoTrack);a&&(t+=a.sendBytes,i+=a.sendBitrate);const c=this.localStats.get(ue.LocalVideoLowTrack);c&&(t+=c.sendBytes,i+=c.sendBitrate),this.remoteStats.forEach(l=>{let{audioStats:h,videoStats:p}=l;h&&(r+=h.receiveBytes,o+=h.receiveBitrate),p&&(r+=p.receiveBytes,o+=p.receiveBitrate)});let d=1;return this.trafficStats&&(d+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:d,SendBitrate:i,SendBytes:t,RecvBytes:r,RecvBitrate:o,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(t){this.localStats.set(t,void 0)}removeLocalStats(t){t?this.localStats.delete(t):this.localStats.clear()}addRemoteStats(t){this.remoteStats.set(t,{})}removeRemoteStats(t){t?this.remoteStats.delete(t):this.remoteStats.clear()}addP2PChannel(t){this.p2pChannel=t}updateTrafficStats(t){t.peer_delay=t.peer_delay.filter(i=>i.B_ppad!==void 0||i.B_ppvd!==void 0),t.peer_delay.filter(i=>this.trafficStatsPeerList.indexOf(i.peer_uid)===-1).forEach(i=>{var r;const o=(r=this.p2pChannel)===null||r===void 0?void 0:r.getRemoteMedia(i.peer_uid),s=o!=null&&o.videoSSRC?eo.measureFromSubscribeStart(this.store.clientId,o.videoSSRC):0,a=o!=null&&o.audioSSRC?eo.measureFromSubscribeStart(this.store.clientId,o.audioSSRC):0;i.B_ppad!==void 0&&i.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(i.peer_uid,i.B_ppad,i.B_ppvd,s>a?s:a),this.trafficStatsPeerList.push(i.peer_uid))}),this.trafficStats=t}updateUplinkStats(t){this.uplinkStats&&this.uplinkStats.B_fir!==t.B_fir&&I.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(t.B_fir)),this.uplinkStats=t}static isRemoteVideoFreeze(t,i,r){if(!t)return!1;const o=!!r&&i.framesDecodeFreezeTime>r.framesDecodeFreezeTime,s=!r||i.framesDecodeCount>r.framesDecodeCount;return o||!s}static isRemoteAudioFreeze(t){return!!t&&t._isFreeze()}isLocalVideoFreeze(t){return!(!t.inputFrame||!t.sentFrame)&&t.inputFrame.frameRate>5&&t.sentFrame.frameRate<3}updateLocalStats(t){Array.from(this.localStats.entries()).forEach(i=>{let[r,o]=i;switch(r){case ue.LocalVideoTrack:case ue.LocalVideoLowTrack:{const c=o,d=Xd({},Mv),l=t.getStats(),h=t.getLocalMedia(r);if(l){const p=l.videoSend.find(f=>f.ssrc===(h==null?void 0:h.ssrcs[0].ssrcId));if(p){const f=t.getLocalVideoSize(),m=t.getEncoderConfig(ue.LocalVideoTrack);var s;(p.codec==="H264"||p.codec==="H265"||p.codec==="VP8"||p.codec==="VP9"||p.codec==="AV1X"||p.codec==="AV1")&&(d.codecType=p.codec,(c==null?void 0:c.codecType)!==p.codec&&((s=this.onVideoCodecChanged)===null||s===void 0||s.call(this,p.codec.toLocaleLowerCase()))),d.sendBytes=p.bytes,d.sendBitrate=c?8*Math.max(0,d.sendBytes-c.sendBytes):0,p.inputFrame?(d.captureFrameRate=p.inputFrame.frameRate,d.captureResolutionHeight=p.inputFrame.height,d.captureResolutionWidth=p.inputFrame.width):f&&(d.captureResolutionWidth=f.width,d.captureResolutionHeight=f.height),p.sentFrame?(d.sendFrameRate=p.sentFrame.frameRate,d.sendResolutionHeight=p.sentFrame.height,d.sendResolutionWidth=p.sentFrame.width):f&&(d.sendResolutionWidth=f.width,d.sendResolutionHeight=f.height),p.avgEncodeMs&&(d.encodeDelay=p.avgEncodeMs),m&&m.bitrateMax?d.targetSendBitrate=1e3*m.bitrateMax:p.targetBitrate&&(d.targetSendBitrate=p.targetBitrate),d.sendPackets=p.packets,d.sendPacketsLost=p.packetsLost,d.sendJitterMs=p.jitterMs,d.sendRttMs=p.rttMs,d.totalDuration=c?c.totalDuration+1:1,d.totalFreezeTime=c?c.totalFreezeTime:0,this.isLocalVideoFreeze(p)&&(d.totalFreezeTime+=1),p.scalabilityMode&&this.scalabilityMode!==p.scalabilityMode&&(I.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(p.scalabilityMode)),this.scalabilityMode=p.scalabilityMode)}this.trafficStats&&(d.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var a;this.localStats.set(r,d),((c==null?void 0:c.sendResolutionWidth)!==d.sendResolutionWidth||(c==null?void 0:c.sendResolutionHeight)!==d.sendResolutionHeight)&&((a=this.onStatsChanged)===null||a===void 0||a.call(this,"resolution",{width:d.sendResolutionWidth,height:d.sendResolutionHeight})),d&&h&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,h.track,d);break}case ue.LocalAudioTrack:{const c=o,d=Xd({},cT),l=t.getStats(),h=t.getLocalMedia(r);if(l){const p=l.audioSend.find(f=>f.ssrc===(h==null?void 0:h.ssrcs[0].ssrcId));if(p){if(p.codec!=="opus"&&p.codec!=="aac"&&p.codec!=="PCMU"&&p.codec!=="PCMA"&&p.codec!=="G722"||(d.codecType=p.codec),p.inputLevel)d.sendVolumeLevel=Math.round(32767*p.inputLevel);else{const f=t.getLocalAudioVolume();f&&(d.sendVolumeLevel=Math.round(32767*f))}d.sendBytes=p.bytes,d.sendPackets=p.packets,d.sendPacketsLost=p.packetsLost,d.sendJitterMs=p.jitterMs,d.sendRttMs=p.rttMs,d.sendBitrate=c?8*Math.max(0,d.sendBytes-c.sendBytes):0}}this.trafficStats&&(d.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(ue.LocalAudioTrack,d),d&&h&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,h.track,d);break}}})}updateRemoteStats(t){Array.from(this.remoteStats.entries()).forEach(i=>{var r,o;let[s,{videoStats:a,audioStats:c,videoPcStats:d}]=i;const l=c,h=a,p=d,f=Xd({},NU),m=Xd({},Do),g=Xd({},DU),{audioTrack:S,videoTrack:T,audioSSRC:C,videoSSRC:b}=t.getRemoteMedia(s);let D;D=this.store.useP2P?t.getStats(!0):t.getStats();const x=(r=D)===null||r===void 0?void 0:r.audioRecv.find(K=>K.ssrc===C),k=(o=D)===null||o===void 0?void 0:o.videoRecv.find(K=>K.ssrc===b),V=this.trafficStats&&this.trafficStats.peer_delay.find(K=>K.peer_uid===s);if(x&&(x.codec!=="opus"&&x.codec!=="aac"&&x.codec!=="PCMU"&&x.codec!=="PCMA"&&x.codec!=="G722"||(f.codecType=x.codec),x.outputLevel?f.receiveLevel=Math.round(32767*x.outputLevel):S&&(f.receiveLevel=Math.round(32767*S.getVolumeLevel())),f.receiveBytes=x.bytes,f.receivePackets=x.packets,f.receivePacketsLost=x.packetsLost,f.receivePacketsDiscarded=x.packetsDiscarded,f.packetLossRate=f.receivePacketsLost/(f.receivePackets+f.receivePacketsLost),f.receiveBitrate=l?8*Math.max(0,f.receiveBytes-l.receiveBytes):0,f.totalDuration=l?l.totalDuration+1:1,f.totalFreezeTime=l?l.totalFreezeTime:0,f.freezeRate=f.totalFreezeTime/f.totalDuration,f.receiveDelay=x.jitterBufferMs,f.totalDuration>10&&_m.isRemoteAudioFreeze(S)&&(f.totalFreezeTime+=1)),k){var W;k.codec!=="H264"&&k.codec!=="H265"&&k.codec!=="VP8"&&k.codec!=="VP9"&&k.codec!=="AV1X"&&k.codec!=="AV1"||(m.codecType=k.codec),m.receiveBytes=k.bytes,m.receiveBitrate=h?8*Math.max(0,m.receiveBytes-h.receiveBytes):0,m.decodeFrameRate=k.decodeFrameRate<0?0:k.decodeFrameRate,m.renderFrameRate=k.decodeFrameRate<0?0:k.decodeFrameRate,k.outputFrame&&(m.renderFrameRate=k.outputFrame.frameRate),k.receivedFrame?(m.receiveFrameRate=k.receivedFrame.frameRate,m.receiveResolutionHeight=k.receivedFrame.height,m.receiveResolutionWidth=k.receivedFrame.width):T&&(m.receiveResolutionHeight=T._videoHeight||0,m.receiveResolutionWidth=T._videoWidth||0),k.framesRateFirefox!==void 0&&(m.receiveFrameRate=Math.round(k.framesRateFirefox)),m.receivePackets=k.packets,m.receivePacketsLost=k.packetsLost,m.packetLossRate=m.receivePacketsLost/(m.receivePackets+m.receivePacketsLost);const K=h?h.totalFreezeTime:0,J=h?h.totalDuration:0;m.totalDuration=h?h.totalDuration+1:1,m.totalFreezeTime=(W=k.totalFreezesDuration)!==null&&W!==void 0?W:K||0,m.receiveDelay=k.jitterBufferMs||0;const se=!!b&&t.getRemoteVideoIsReady(b);k.totalFreezesDuration===void 0&&T&&se&&_m.isRemoteVideoFreeze(T,k,p)&&(m.totalFreezeTime+=1),m.freezeRate=Math.max(0,Math.min((m.totalFreezeTime-K)/(m.totalDuration-J),1))}V&&(f.end2EndDelay=V.B_ad,m.end2EndDelay=V.B_vd,f.transportDelay=V.B_ed,m.transportDelay=V.B_ed,f.currentPacketLossRate=V.B_ealr4/100,m.currentPacketLossRate=V.B_evlr4/100,g.uplinkNetworkQuality=V.B_punq?V.B_punq:0,g.downlinkNetworkQuality=V.B_pdnq?V.B_pdnq:0),this.remoteStats.set(s,{audioStats:f,videoStats:m,videoPcStats:k,networkStats:g}),S&&this.exceptionMonitor.setRemoteAudioStats(S,f),T&&this.exceptionMonitor.setRemoteVideoStats(T,m)})}}class hL{constructor(){M(this,"destChannelMediaInfos",new Map),M(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(t){zo(t),this.srcChannelMediaInfo=t}addDestChannelInfo(t){zo(t),this.destChannelMediaInfos.set(t.channelName,t)}removeDestChannelInfo(t){L_(t),this.destChannelMediaInfos.delete(t)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function Bu(e){if(!(e instanceof hL))return new $(O.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const t=e.getSrcChannelMediaInfo(),i=e.getDestChannelMediaInfo();if(!t)return new $(O.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(i.size===0)return new $(O.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class ju{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(t,i){M(this,"uid",void 0),M(this,"_uintid",void 0),M(this,"_trust_in_room_",!0),M(this,"_trust_audio_enabled_state_",!0),M(this,"_trust_video_enabled_state_",!0),M(this,"_trust_audio_mute_state_",!0),M(this,"_trust_video_mute_state_",!0),M(this,"_audio_muted_",!1),M(this,"_video_muted_",!1),M(this,"_audio_enabled_",!0),M(this,"_video_enabled_",!0),M(this,"_audio_added_",!1),M(this,"_video_added_",!1),M(this,"_is_pre_created",!1),M(this,"_video_pre_subscribed",!1),M(this,"_audio_pre_subscribed",!1),M(this,"_trust_video_stream_added_state_",!0),M(this,"_trust_audio_stream_added_state_",!0),M(this,"_audioTrack",void 0),M(this,"_videoTrack",void 0),M(this,"_dataChannels",[]),M(this,"_audioSSRC",void 0),M(this,"_videoSSRC",void 0),M(this,"_audioOrtc",void 0),M(this,"_videoOrtc",void 0),M(this,"_cname",void 0),M(this,"_rtxSsrcId",void 0),M(this,"_videoMid",void 0),M(this,"_audioMid",void 0),this.uid=t,this._uintid=i}}function RC(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function pL(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?RC(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):RC(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}const vC=e=>`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1 2
a=msid-semantic: WMS
a=ice-lite`.concat(e?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:2
`),fm="9",mm=2e4,BT=4e4;let _L=class{get localCapabilities(){return wi(this._localCapabilities)}get rtpCapabilities(){return wi(this._rtpCapabilities)}get candidates(){return wi(this._candidates)}get iceParameters(){return wi(this._iceParameters)}get dtlsParameters(){return wi(this._dtlsParameters)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1],i=arguments.length>2&&arguments[2]!==void 0&&arguments[2],r=arguments.length>3&&arguments[3]!==void 0&&arguments[3];M(this,"sessionDesc",void 0),M(this,"_localCapabilities",void 0),M(this,"_rtpCapabilities",void 0),M(this,"_candidates",void 0),M(this,"_originCandidates",void 0),M(this,"_iceParameters",void 0),M(this,"_isUseExtmapAllowMixed",void 0),M(this,"_isUseLocalCodecs",void 0),M(this,"_isUseDataChannel",void 0),M(this,"_dtlsParameters",void 0),M(this,"setup",void 0),M(this,"currentMidIndex",void 0),M(this,"cname",void 0),M(this,"useLocalCodecsMids",[]),M(this,"preloadSsrcs",[]),M(this,"firefoxSsrcMidMap",new Map),this._isUseExtmapAllowMixed=t,this._isUseLocalCodecs=i,this._isUseDataChannel=r,e=wi(e);const{iceParameters:o,dtlsParameters:s,candidates:a,rtpCapabilities:c,setup:d,localCapabilities:l,cname:h}=e;this._rtpCapabilities=c,this._candidates=a,this._originCandidates=wi(a),this._iceParameters=o,this._dtlsParameters=s,this._localCapabilities=l,this.setup=d,this.cname=h,[this.sessionDesc]=this.updateRemoteRTPCapabilities(c),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}checkPreloadSsrcs(e){return e.length===this.preloadSsrcs.length&&e.every(t=>{var i;return z(i=this.preloadSsrcs).call(i,t)})}preloadRemoteMedia(e){let t=0;const i=[],r=[];for(;e>0;){const o=[pL({ssrcId:BT+t},B("USE_SUB_RTX")?{rtx:BT+t+1}:{})],s="".concat(BT+t,"_").concat(mm+t),{ssrcs:a,ssrcGroups:c}=Kd(o,this.cname,B("SYNC_GROUP")?s:void 0),d=this.preCreateOrRecycleSendMedia("video",a,c,void 0),l=[{ssrcId:mm+t}],h="".concat(BT+t,"_").concat(mm+t),{ssrcs:p,ssrcGroups:f}=Kd(l,this.cname,B("SYNC_GROUP")?h:void 0),m=this.preCreateOrRecycleSendMedia("audio",p,f,void 0);e--,t+=2,i.push(d,m),r.push(a[0].ssrcId,p[0].ssrcId)}return this.useLocalCodecsMids.push(...i),this.preloadSsrcs=r,{mids:i,preSSRCs:r,isAvailable:!0}}preCreateOrRecycleSendMedia(e,t,i,r){const o=this.rtpCapabilities.send.videoCodecs,s=this._isUseLocalCodecs||o.length===0?this.localCapabilities.recv:this.rtpCapabilities.send;I.debug("create or recycle send media without remote rtp capabilities, ssrcs ",t[0].ssrcId);const a=e===be.VIDEO?s.videoCodecs:s.audioCodecs,c=e===be.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;const d="".concat(this.currentMidIndex);let l={media:{mediaType:e,port:fm,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(h=>h.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};return l=this.mungSendMediaDesc(l,r),this.sessionDesc.mediaDescriptions.push(l),this.updateBundleMids(),d}toString(){return Du(this.sessionDesc)}send(e,t,i,r){const{ssrcs:o,ssrcGroups:s}=Kd(t,this.cname,B("SYNC_GROUP")?i:void 0),a=this.findPreloadMediaDesc(o);if(a){if(Ht()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(e,o);let d;return c===-1||c===1&&(pn()||function(){const l=ii();return!(l.name!==di.CHROME||!l.osVersion)&&Number(l.version)<=90}()||bc(143)||Rl(143)||B("RESERVE_MID_1_MLINE")||B("ENABLE_ENCODED_TRANSFORM")&&Cr())||c===0&&!function(l){const h=ii();return!(h.name!==di.FIREFOX||!h.osVersion)&&Number(h.version)===l}(138)&&B("USE_SUB_RTX")||C_()?(d=this.createOrRecycleSendMedia(e,o,s,"sendonly",r),this.updateBundleMids()):(d=wi(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=o,d.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),Ht()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,d.attributes.mid),{mid:d.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:e,needExchangeSDP:t}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:e.attributes.mid,needExchangeSDP:t}}batchSend(e){const t=e.map(o=>{let{kind:s,ssrcMsg:a,mslabel:c}=o;return this.send(s,a,c)}),i=[];let r=!1;return t.forEach(o=>{let{mid:s,needExchangeSDP:a}=o;a&&(r=!0),i.push(s)}),{mids:i,needExchangeSDP:r}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter(i=>i.attributes.mid&&e.indexOf(i.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach(i=>{i.attributes.mid==="0"||Ht()||C_()?i.attributes.ssrcs=[]:(i.attributes.ssrcs=[],i.attributes.direction="inactive",i.media.port="0")}),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===e);if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===e);if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter(i=>z(e).call(e,i.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(i=>{i.attributes.direction="inactive"})}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter(i=>z(e).call(e,i.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(i=>{i.attributes.direction="recvonly"})}receive(e,t,i,r){e.forEach((o,s)=>{this.createOrRecycleRecvMedia(o,[],"recvonly",t,i,r[s])}),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter(i=>e.indexOf(i.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach(i=>{i.media.port="0",i.attributes.direction="inactive"}),this.updateBundleMids()}updateRemoteRTPCapabilities(e){const t=this.sessionDesc||sn((i=this._isUseExtmapAllowMixed,this._isUseDataChannel?vC(i):`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite`.concat(i?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`)));var i;this._rtpCapabilities=e;let r=!1;const o=this.rtpCapabilities.send,s=this.localCapabilities.send,a=this.localCapabilities.recv,c=a.videoCodecs,d=a.audioCodecs,l=a.videoExtensions,h=a.audioExtensions;for(const g of t.mediaDescriptions){var p;if(g.attributes.direction!=="sendonly"||typeof g.attributes.mid!="string"||!z(p=this.useLocalCodecsMids).call(p,g.attributes.mid)){if(r=!0,g.attributes.iceUfrag=this._iceParameters.iceUfrag,g.attributes.icePwd=this._iceParameters.icePwd,g.attributes.fingerprints=this._dtlsParameters.fingerprints,g.attributes.candidates=this._candidates,g.attributes.setup=this.setup,g.media.mediaType==="application"&&(g.attributes.sctpPort="5000"),g.media.mediaType==="video")if(this._isUseLocalCodecs&&g.attributes.direction==="sendonly"){var f;g.media.fmts=c.map(T=>T.payloadType.toString(10)),g.attributes.payloads=c,g.attributes.extmaps=l;const S=g.attributes.mid;typeof S!="string"||z(f=this.useLocalCodecsMids).call(f,S)||this.useLocalCodecsMids.push(S)}else if(o.videoCodecs.length===0){const S=s.videoCodecs.filter(T=>{var C,b;return(C=T.rtpMap)===null||C===void 0?void 0:z(b=C.encodingName.toLowerCase()).call(b,"vp8")});S.length===0&&S.push(s.videoCodecs[0]),g.media.fmts=S.map(T=>T.payloadType.toString(10)),g.attributes.payloads=S,g.attributes.extmaps=[]}else g.media.fmts=o.videoCodecs.map(S=>S.payloadType.toString(10)),g.attributes.payloads=o.videoCodecs,g.attributes.extmaps=o.videoExtensions;if(g.media.mediaType==="audio")if(this._isUseLocalCodecs&&g.attributes.direction==="sendonly"){var m;g.media.fmts=d.map(T=>T.payloadType.toString(10)),g.attributes.payloads=d,g.attributes.extmaps=h;const S=g.attributes.mid;typeof S!="string"||z(m=this.useLocalCodecsMids).call(m,S)||this.useLocalCodecsMids.push(S)}else if(o.audioCodecs.length===0){const S=s.audioCodecs.filter(T=>{var C,b;return(C=T.rtpMap)===null||C===void 0?void 0:z(b=C.encodingName.toLowerCase()).call(b,"opus")})||[s.audioCodecs[0]];g.media.fmts=S.map(T=>T.payloadType.toString(10)),g.attributes.payloads=S,g.attributes.extmaps=[]}else g.media.fmts=o.audioCodecs.map(S=>S.payloadType.toString(10)),g.attributes.payloads=o.audioCodecs,g.attributes.extmaps=o.audioExtensions,Nl(g)}}return this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1,[this.sessionDesc,r]}updateCandidates(e){const t=this._originCandidates.filter(r=>r.transport==="udp"),i=[];if(t.forEach(r=>{i.push(pL(pL({},r),{},{foundation:"tcpcandidate",priority:Number(r.priority)-1+"",transport:"tcp",port:Number(r.port)+90+""}))}),t.length!==0){switch(e){case Ir.TCP_RELAY:this._candidates=i;break;case Ir.UDP_TCP_RELAY:case Ir.RELAY:this._candidates=[...t,...i];break;default:this._candidates=t}for(const r of this.sessionDesc.mediaDescriptions)r.attributes.candidates=this.candidates}}restartICE(e){e=wi(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd})}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex(i=>{const r=i.media.mediaType===e&&i.media.port!=="0"&&(i.attributes.direction==="sendonly"||i.attributes.direction==="sendrecv")&&i.attributes.ssrcs.length===0;if(Ht()){if(r){const o=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(o||i.attributes.mid!=="0"&&i.attributes.mid!=="1")||!(!o||o!==i.attributes.mid)}return!1}return r})}createOrRecycleDataChannel(){for(const i of this.sessionDesc.mediaDescriptions)if(i.media.mediaType==="application")return{mediaDesc:i,needExchangeSDP:!1};this.currentMidIndex+=1;const e="".concat(this.currentMidIndex),t={media:{mediaType:"application",port:fm,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(e),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(t),{mediaDesc:t,needExchangeSDP:!0}}createOrRecycleRecvMedia(e,t,i,r,o,s){const a=e._mediaStreamTrack.kind,c=this.rtpCapabilities.recv,d=Vc(a,c,this.localCapabilities.send,a===be.VIDEO?r:o),l=a===be.VIDEO?c.videoExtensions:c.audioExtensions;this.currentMidIndex+=1;const h="".concat(this.currentMidIndex);let p={media:{mediaType:a,port:fm,protos:["UDP","TLS","RTP","SAVPF"],fmts:d.map(m=>m.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:l,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:d,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(h)}};p=this.mungRecvMediaDsec(p,e,s);const f=this.findFirstClosedMedia(a);if(f){const m=this.sessionDesc.mediaDescriptions.indexOf(f);this.sessionDesc.mediaDescriptions[m]=p}else this.sessionDesc.mediaDescriptions.push(p);return p}updateRemoteDtlsParameters(e){const t=new Set(this._dtlsParameters.fingerprints.map(o=>o.fingerprint)),i=new Set(e.map(o=>o.fingerprint));let r=!1;t.size!==i.size&&(r=!0);for(const o of t)i.has(o)||(r=!0);return r}updateRemoteCodec(e,t,i){const r=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(p=>p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||"").filter(p=>{var f;return z(f=Object.keys(Ph)).call(f,p)}))],o=new Set(t);if(r.every(p=>o.has(p)))return I.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(t)),!1;const s=this._rtpCapabilities.recv.videoCodecs.filter(p=>t.some(f=>{var m;return z(m=p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||"").call(m,f)}));if(s.length===0)return I.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(r," codecs: ").concat(t)),!1;const a=[...new Set(s.map(p=>p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||""))];let c;if(I.debug("updateRemoteCodec, from ".concat(r," to ").concat(a)),e.length===0)c=this.sessionDesc.mediaDescriptions.filter(p=>p.media.mediaType==="video"&&p.attributes.direction==="recvonly");else if(c=this.sessionDesc.mediaDescriptions.filter(p=>p.attributes.mid&&p.media.mediaType==="video"&&z(e).call(e,p.attributes.mid)&&p.attributes.direction==="recvonly"),c.length!==e.length)return I.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(t)),!1;if(B("USE_PUB_RTX")||B("USE_SUB_RTX")){const p=zn(s,this.rtpCapabilities.recv.videoCodecs);s.push(...p)}this._rtpCapabilities.recv.videoCodecs=s;const d=this.localCapabilities.send,l=this.rtpCapabilities.recv,h=Vc(be.VIDEO,l,d,i);return c.forEach(p=>{const f=h.map(m=>m.payloadType.toString(10));I.debug("updateRemoteCodec mid: ".concat(p.attributes.mid,", from"),p.attributes.payloads,"to",h),p.attributes.payloads=h,p.media.fmts=f}),I.debug("updateRemoteCodec success, mids: ".concat(e,", codecs: ").concat(t,", remote recv: ").concat(this._rtpCapabilities.recv.videoCodecs.length,", remote send: ").concat(this._rtpCapabilities.send.videoCodecs.length)),!0}createOrRecycleSendMedia(e,t,i,r,o){const s=this.rtpCapabilities.send.videoCodecs,a=this._isUseLocalCodecs||s.length===0?this.localCapabilities.recv:this.rtpCapabilities.send,c=e===be.VIDEO?a.videoCodecs:a.audioCodecs,d=e===be.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let h={media:{mediaType:e,port:fm,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map(f=>f.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};h=this.mungSendMediaDesc(h,o);const p=this.findFirstClosedMedia(e);if(p){const f=this.sessionDesc.mediaDescriptions.indexOf(p);this.sessionDesc.mediaDescriptions[f]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(e=>e.media.port!=="0").map(e=>e.attributes.mid)}mungRecvMediaDsec(e,t,i){const r=wi(e);return LT(r),Fu(r,t),cC(r,t),kT(r),cm(r,i,this.localCapabilities.send),r}mungSendMediaDesc(e,t){const i=wi(e);return i.attributes&&i.attributes.payloads&&Array.isArray(i.attributes.payloads)&&i.attributes.payloads.length>0&&i.attributes.payloads.forEach(r=>{r.rtpMap&&r.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&B("ENABLE_DOWN_SPS_PPS")&&(r.fmtp&&r.fmtp.parameters||(r.fmtp={parameters:{}}),r.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")}),cm(i,t,this.localCapabilities.recv),Nl(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===e);if(i!==-1){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=r}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find(t=>Ht()?t.media.port==="0"&&t.media.mediaType===e:t.media.port==="0")}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find(t=>{var i;return((i=t.attributes)===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId)===e[0].ssrcId})}getSSRC(e){var t;return(t=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===e))===null||t===void 0?void 0:t.attributes.ssrcs}};function Pl(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function Oa(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Pl(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Pl(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}var Gu=function(e){return e[e.DOWN=0]="DOWN",e[e.UP=1]="UP",e}(Gu||{});const jT=new Map;function fL(e,t,i,r){let{scale:o}=e;if(o===0&&r===Gu.UP||o>=t.length-1&&r===Gu.DOWN)return e;let s=Oa(Oa({},e),{},{scale:r===Gu.DOWN?++o:--o});switch(i){case"maintain-framerate":s=Oa(Oa({},s),t[o].motion);break;case"maintain-resolution":s=Oa(Oa({},s),t[o].detail);break;case"balanced":s=Oa(Oa({},s),t[o].balanced)}return s}function mL(e,t){if(t){const i={overUse:0,underUse:0,adaptationList:s2(t)};jT.set(e,i)}else jT.delete(e)}function s2(e){const t=Oa({},e),{bitrateMax:i,frameRate:r,scaleResolutionDownBy:o,bitrateMin:s}=t,{MIN_FRAME_RATE:a,MAX_THRESHOLD_FRAMERATE:c,MAX_SCALE:d,BITRATE_MIN_THRESHOLD:l,BITRATE_MAX_THRESHOLD:h,BWE_SCALE_UP_THRESHOLD:p,BWE_SCALE_DOWN_THRESHOLD:f,PERF_SCALE_DOWN_THRESHOLD:m,PERF_SCALE_UP_THRESHOLD:g,BALANCE_BITRATE_FACTOR:S,BALANCE_FRAMERATE_FACTOR:T,BALANCE_RESOLUTION_FACTOR:C,MOTION_RESOLUTION_FACTOR:b,MOTION_BITRATE_FACTOR:D,DETAIL_FRAMERATE_FACTOR:x,DETAIL_BITRATE_FACTOR:k}=oT,V=Math.min(t.frameRate,c),W=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(f,1)*i),bwe_up:i,fps_down:Math.round(Math.pow(m,1)*V),fps_up:r},balanced:{scaleResolutionDownBy:1,frameRate:r,bitrateMax:i,bitrateMin:s},motion:{scaleResolutionDownBy:1,frameRate:r,bitrateMax:i,bitrateMin:s},detail:{scaleResolutionDownBy:1,frameRate:r,bitrateMax:i,bitrateMin:s}}];for(let K=1;K<=d;K++){const J={bwe_up:Math.round(Math.pow(p,K)*i),bwe_down:Math.round(Math.pow(f,K+1)*i),fps_up:Math.round(Math.pow(g,K)*V),fps_down:Math.round(Math.pow(m,K+1)*V)},se={scaleResolutionDownBy:o/Math.pow(C,K),frameRate:Math.max(Math.round(Math.pow(T,K)*r),a),bitrateMax:Math.max(Math.round(Math.pow(S,K)*i),h),bitrateMin:Math.max(Math.round(Math.pow(S,K)*s),l)},Ne={scaleResolutionDownBy:o/Math.pow(b,K),frameRate:r,bitrateMax:Math.max(Math.round(Math.pow(D,K)*i),h),bitrateMin:Math.max(Math.round(Math.pow(D,K)*s),l)},Ce={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(x,K)*r),a),bitrateMax:Math.max(Math.round(Math.pow(k,K)*i),h),bitrateMin:Math.max(Math.round(Math.pow(k,K)*s),l)};W.push({scale:K,threshold:J,balanced:se,motion:Ne,detail:Ce})}return W}function a2(e,t,i,r,o,s){const a=jT.get(e)||{overUse:0,underUse:0,adaptationList:s2(o)},{adaptationList:c}=a;jT.set(e,a);const{OVERUSE_TIMES_THRESHOLD:d,UNDERUSE_TIMES_THRESHOLD:l}=oT,{scale:h}=r;let p,f;return typeof t=="number"&&t>0&&function(m,g,S,T){if(g>=S.length)return!1;let{threshold:{fps_down:C}}=S[g];return B("FORCE_AG_HIGH_FRAMERATE")&&T==="maintain-framerate"&&(C=S[0].threshold.fps_down),m<C}(t,h,c,s)&&(a.overUse++,f=Ou.CPU,a.overUse>d)||typeof i=="number"&&i>0&&function(m,g,S){if(g>=S.length)return!1;const{threshold:{bwe_down:T}}=S[g];return m<T}(i,h,c)&&(a.overUse++,f=Ou.BANDWIDTH,a.overUse>d)?(a.overUse=0,a.underUse=0,p=fL(r,c,s,Gu.DOWN),[p,f]):(typeof t=="number"&&t>0&&typeof i=="number"&&i>0&&function(m,g,S,T){if(g===0)return;let{threshold:{fps_up:C}}=S[g];return B("FORCE_AG_HIGH_FRAMERATE")&&T==="maintain-framerate"&&(C=S[1].threshold.fps_up),m>C}(t,h,c,s)&&function(m,g,S){if(g===0)return;const{threshold:{bwe_up:T}}=S[g];return m>T}(i,h,c)&&(a.underUse++,a.underUse>l&&(a.overUse=0,a.underUse=0,p=fL(r,c,s,Gu.UP),p.scale===0&&(f=Ou.NONE))),[p,f])}function CC(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function yC(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?CC(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):CC(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}function GT(e){var t;return!!B("ENABLE_AG_ADAPTATION")&&!!(e instanceof fT||z(t=e._hints).call(t,ui.CUSTOM_TRACK))&&(!!B("FORCE_SUPPORT_AG_ADAPTATION")||!!(bN(14,0,!1)&&mv(17,4,!0)||wN(14)&&Cu(17,4,!0)))}const WT=new Map;function V_(e,t,i,r,o,s){if(Em(e,i),o(t),r!=="balanced"&&r!=="maintain-framerate"&&r!=="maintain-resolution")return;let a=-1;mL(e,t);const c=window.setInterval(()=>{const l=WT.get(e);if(!B("ENABLE_AG_ADAPTATION")||!l)return Em(e,i),void o(t);const h=s();if(h.sendPackets>0&&h.OutgoingAvailableBandwidth>0){if(a===-1)return void(a=Date.now());if(Date.now()-a<1e3)return;const p=h.sendFrameRate,f=h.OutgoingAvailableBandwidth,[m,g]=a2(e,p,f,l.adaptationConfig,t,r);g&&(i.qualityLimitationReason=g),m&&l.adaptationConfig.scale!==m.scale&&(I.debug("[".concat(e,"] applyAdaptation: ").concat(i.qualityLimitationReason,`
           sendFps `).concat(p,", bwe ").concat(f,", switch from ").concat(l.adaptationConfig.scale," to ").concat(m.scale," ")),l.adaptationConfig=yC(yC({},l.adaptationConfig),m),o(m))}},B("CHECK_LOCAL_STATS_INTERVAL")),d=yC({},t);WT.set(e,{timer:c,adaptationConfig:d,originConfig:t,adaptationFunc:o}),I.debug("[".concat(e,"] start adaptation, originConfig: ").concat(JSON.stringify(t),", degradationPreference: ").concat(r))}function Em(e,t){const i=WT.get(e);if(i){const{timer:r}=i;window.clearTimeout(r),WT.delete(e)}t.qualityLimitationReason=Ou.NONE,mL(e)}function EL(e,t){var i;let r;switch(t){case ue.LocalAudioTrack:r=_t.Audio;break;case ue.LocalVideoTrack:r=z(i=e._hints).call(i,ui.SCREEN_TRACK)?_t.Screen:_t.High;break;case ue.LocalVideoLowTrack:r=_t.Low}return r}function HT(e){const t=Mt();if(e.some(i=>i._bypassWebAudio))throw new oe(O.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!t.webAudioMediaStreamDest)throw new oe(O.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function gL(e,t){HT(e);const i=new nn;return e.forEach(r=>i.addAudioTrack(r)),i}const KT=!Mt().supportUnifiedPlan||B("CHROME_FORCE_PLAN_B")&&ha();function F_(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(e.useDcSignal)return i={spec:t,store:e},Fc("DataChannelConnection").create(i);var i;return KT?function(o){return Fc("PlanBConnection").create(o)}({spec:t,store:e}):new Mr(t,e)}function YT(e){return e&&(e.iceConnectionState==="disconnected"||e.iceConnectionState==="checking"||e.iceConnectionState==="failed")}function Qt(e){try{if(e.iceServers)return!1;if(e.turnServer&&e.turnServer.mode!=="off"){if(bh(e.turnServer.servers))return!1;if(B("FORCE_TURN_TCP")||e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).some(t=>t.forceturn))return!0}return!1}catch{return!1}}var $t;function jc(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function bn(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?jc(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):jc(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let Mr=($t=class OR extends ke{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,i;return(t=(i=this.peerConnection.getReceivers()[0])===null||i===void 0||(i=i.transport)===null||i===void 0?void 0:i.state)!==null&&t!==void 0?t:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var i;return z(i=Object.keys(Ph)).call(i,t)}))]}constructor(t,i){super(t,i),M(this,"id",li(5,"connection-")),M(this,"store",void 0),M(this,"peerConnection",void 0),M(this,"forceTurn",!1),M(this,"remoteSDP",void 0),M(this,"initialOffer",void 0),M(this,"transportEventReceiver",void 0),M(this,"statsFilter",void 0),M(this,"extension",{useXR:B("USE_XR")}),M(this,"localCapabilities",void 0),M(this,"remoteCodecs",void 0),M(this,"localCandidateCount",0),M(this,"allCandidatesReceived",!1),M(this,"isPreallocation",!1),M(this,"isPreRender",!1),M(this,"preMediaMap",new Map),M(this,"dataStreamChannelMap",new Map),M(this,"establishPromise",void 0),M(this,"recoveredDataChannelIds",[]),M(this,"currentDataChannelId",1),M(this,"supportAV1RtpSpec",!1),M(this,"mutex",void 0),M(this,"qualityLimitationReason",Ou.NONE),M(this,"isFirstConnected",!1),this.store=i,this.forceTurn=Qt(t),this.mutex=new jr("P2PConnection-mutex",i.clientId),this.peerConnection=new RTCPeerConnection(OR.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.isFirstConnected=!1,this.statsFilter=nT(this.peerConnection,B("STATS_UPDATE_INTERVAL"),void 0,Ht()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,t.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(t){return this.preMediaMap.get(t)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(t,i){if(this.remoteCodecs=i,!this.remoteSDP)return void I.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(i));if(this.remoteSDP.updateRemoteCodec(t,i,this.store.codec)){const r=await this.peerConnection.createOffer(),o=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r);const s=this.remoteSDP.toString();o==null||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}else I.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const i=await this.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const r=xc(i.sdp),o=await uC({filterRTX:!B("USE_PUB_RTX")&&!B("USE_SUB_RTX"),filterVideoFec:B("FILTER_VIDEO_FEC"),filterAudioFec:B("FILTER_AUDIO_FEC"),filterVideoCodec:B("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:B("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:B("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=Ol(o),this.initialOffer=i,B("ENABLE_SVC")&&this.store.codec=="av1"){const a=await lC();var t;a&&(this.supportAV1RtpSpec=!0,(t=o.send)===null||t===void 0||t.videoExtensions.push(a))}let s;return i.sdp&&UT(i.sdp)&&(s=wi(o),qP(s)),bn(bn({},r),{},{rtpCapabilities:s||o,offerSDP:i.sdp})}catch(i){throw new oe(O.GET_LOCAL_CONNECTION_PARAMS_FAILED,i.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.initialOffer.sdp&&UT(this.initialOffer.sdp)&&NT(t.rtpCapabilities,this.localCapabilities),this.remoteSDP=new _L(bn(bn({},t),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!B("ENABLE_PRE_SUB_WITH_PRE_PC")||!B("PRE_USE_LOCAL_CODECS"))&&Wf(this.store)),t.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const i=this.remoteSDP.toString(),r=hC(this.initialOffer.sdp,this.extension),o=this.logSDPExchange(r||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o==null||o(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i});const s=this.peerConnection.getTransceivers()[0];if(s!=null&&s.receiver&&this.tryBindTransportEvents(s.receiver),Wf(this.store))if(t.preallocation&&B("ENABLE_PRE_SUB_WITH_PRE_PC")){const a=B("PRE_SUB_NUM"),{mids:c,preSSRCs:d}=this.remoteSDP.preloadRemoteMedia(a);await Xo(this.peerConnection,this.remoteSDP,this.extension),I.debug("[".concat(this.store.clientId,"] [P2PConnection] preload media, in pre pc,add preload ssrcs ").concat(d)),this.presetMedia(c,d)}else{const{preSSRCs:a=[]}=t,c=a.map(l=>l.ssrcMsg[0].ssrcId);if(a.length===0)return;const{mids:d}=this.remoteSDP.batchSend(a.map(l=>Object.assign({},l)));await Xo(this.peerConnection,this.remoteSDP,this.extension),I.debug("[P2PConnection.connect] preload media, after join, add preload ssrcs ".concat(c)),this.presetMedia(d,c)}}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(i.toString()))}}presetMedia(t,i){t.forEach((r,o)=>{this.peerConnection.getTransceivers().forEach(s=>{if(s.mid!=null&&r===s.mid&&s.receiver.track){const a=s.receiver.track;let c;a.kind==="video"&&B("ENABLE_PRE_RENDER")&&(c=new _T({trackId:"track-".concat(a.kind,"-unknown-").concat(this.store.clientId,"_").concat(li(5,""))},!0),c.updateVideoTrack(a),c.onFirstVideoFrameRender=()=>{var d;const l=this.preMediaMap.get(i[o]);l&&(l.firstVideoRender=Date.now()),(d=this.onFirstVideoRender)===null||d===void 0||d.call(this,i[o])},c.onVideoBufferReady=()=>{var d;(d=this.onFirstVideoBufferReady)===null||d===void 0||d.call(this,i[o])},c.play(this.store.sessionId||void 0),this.isPreRender=!0),this.preMediaMap.set(i[o],{mid:r,track:a,player:c,transceiver:s})}}),this.store.peerReceiver()})}checkDtlsParameters(t){return!!this.remoteSDP&&t.length>0&&this.remoteSDP.updateRemoteDtlsParameters(t)}async updateRemoteConnect(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");let i=!1;const{rtpCapabilities:r}=t;if([,i]=this.remoteSDP.updateRemoteRTPCapabilities(r),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){const a=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);i=i||a}const{preSSRCs:o=[]}=t,s=o.map(a=>a.ssrcMsg[0].ssrcId);if(!this.remoteSDP.checkPreloadSsrcs(s)){const a=[],c=[];if(Array.from(this.preMediaMap.entries()).every(d=>{let[l,{mid:h,player:p,track:f}]=d;return a.push(h),c.push(l),this.preMediaMap.delete(l),p&&p.destroy(),!0}),a.length>0&&(this.remoteSDP.stopSending(a),await Xo(this.peerConnection,this.remoteSDP,this.extension),I.warn("[P2PConnection.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(c)),H.reportApiInvoke(this.store.sessionId,{name:ct.PRELOAD_MEDIA_FAILED,options:[o,c],tag:bi.TRACER}).onSuccess()),o.length>0){const{mids:d}=this.remoteSDP.batchSend(o.map(l=>Object.assign({},l)));await Xo(this.peerConnection,this.remoteSDP,this.extension),I.debug("[P2PConnection.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(s)),this.presetMedia(d,s)}}i?(await Xo(this.peerConnection,this.remoteSDP,this.extension),I.debug("[P2PConnection] updateRemoteConnect by exchanging SDP.")):I.debug("[P2PConnection] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(i.toString()))}}send(t,i,r){var o=this;return ao(function*(){const s=yield Et(o.mutex.lock("From P2PConnection.send"));try{if(!o.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const a=[],c=om();t.forEach(T=>{const C=o.peerConnection.addTransceiver(T._mediaStreamTrack,bn({direction:"sendonly"},T.trackMediaType==="video"&&o.supportAV1RtpSpec&&c?{sendEncodings:[{scalabilityMode:c}]}:{}));a.push(C),T._updateRtpTransceiver(C)}),Ht()&&B("SIMULCAST")===!0&&(yield Et(o.applySimulcastForFirefox(a,t)));const d=yield Et(o.peerConnection.createOffer()),l=o.remoteSDP.predictReceivingMids(t.length),h=o.mungSendOfferSDP(d.sdp,t,l),p=sn(h),f=l.map(T=>{const C=p.mediaDescriptions.find(b=>b.attributes.mid===T);if(!C)throw new Error("Cannot extract ssrc from mediaDescription.");return aC(C,B("USE_PUB_RTX"))});let m;try{m=yield f}catch(T){m=[],o.remoteSDP.receive(t,i,r,m);const C=o.remoteSDP.toString();throw yield Et(o.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield Et(o.peerConnection.setRemoteDescription({type:"answer",sdp:C})),yield Et(o.stopSending(l,!0)),T}o.remoteSDP.receive(t,i,r,m);const g=o.remoteSDP.toString(),S=o.logSDPExchange(h,"offer","local","send");return yield Et(o.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield Et(o.applySimulcastEncodings(a,t)),yield Et(o.applySendEncodings(a,t)),S==null||S(g),yield Et(o.peerConnection.setRemoteDescription({type:"answer",sdp:g})),a.map((T,C)=>{const b=l[C];return{localSSRC:f[C],id:b,transceiver:T}})}catch(a){throw a instanceof oe?a:new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(a.toString()))}finally{s()}})()}async createDataChannels(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let r=this.dataStreamChannelMap.get(t);if(r&&r.readyState==="open")I.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const s=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof s!="number")throw new Error("create DataChannel error, because cannot get dc id");r=this.peerConnection.createDataChannel("datastream-channel",{id:s,negotiated:!0,ordered:!1,maxRetransmits:B("DATASTREAM_MAX_RETRANSMITS")}),r.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,r)}i.forEach(s=>{s._updateOriginDataChannel(r)});const{needExchangeSDP:o}=this.remoteSDP.sendDataChannel();if(o){const s=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a),I.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else I.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(r){throw r instanceof oe?r:new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(r.toString()))}}async stopDataChannels(t){try{const i=this.dataStreamChannelMap.get(t);return i&&(i.id&&this.recoveredDataChannelIds.push(i.id),i.close()),void this.dataStreamChannelMap.delete(t)}catch(i){throw i instanceof oe?i:new oe(O.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(i.toString()))}}async stopSending(t,i){const r=i?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const o=this.peerConnection.getTransceivers().filter(d=>t.indexOf(d.mid)!==-1);if(o.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");o.map(d=>{var l;Em(this.id+d.mid,this),d.direction="inactive",(l=d.stop)===null||l===void 0||l.call(d)});const s=await this.peerConnection.createOffer(),a=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(t);const c=this.remoteSDP.toString();a==null||a(c),await this.peerConnection.setRemoteDescription({type:"answer",sdp:c})}catch(o){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(o.toString()))}finally{r&&r()}}async receive(t,i,r,o){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:a}=this.remoteSDP.send(t,i,r,o);a&&(await Xo(this.peerConnection,this.remoteSDP,this.extension),I.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP.")));const c=this.peerConnection.getTransceivers().find(d=>d.mid===s);if(!c)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:c.receiver.track,id:s,transceiver:c}}catch(s){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:i,needExchangeSDP:r}=this.remoteSDP.batchSend(t);return r&&(await Xo(this.peerConnection,this.remoteSDP,this.extension),I.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),i.map(o=>{const s=this.peerConnection.getTransceivers().find(a=>a.mid===o);if(!s)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,id:o,transceiver:s}})}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");t.forEach(s=>{Array.from(this.preMediaMap.entries()).some(a=>{let[c,{mid:d,player:l}]=a;if(d===s)return this.preMediaMap.delete(c),l&&l.destroy(),!0})}),this.remoteSDP.stopSending(t);const i=this.remoteSDP.toString(),r=this.logSDPExchange(i,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const o=await this.peerConnection.createAnswer();r==null||r(o.sdp||""),await this.peerConnection.setLocalDescription(o)}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const i=this.remoteSDP.toString(),r=this.logSDPExchange(i,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const o=await this.peerConnection.createAnswer();r==null||r(o.sdp||""),await this.peerConnection.setLocalDescription(o)}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(i.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const i=this.remoteSDP.toString(),r=this.logSDPExchange(i,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const o=await this.peerConnection.createAnswer();r==null||r(o.sdp||""),await this.peerConnection.setLocalDescription(o)}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(i.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(a=>a.mid&&t.indexOf(a.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(a=>{a.direction="inactive"});const r=await this.peerConnection.createOffer(),o=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.muteRemote(t);const s=this.remoteSDP.toString();o==null||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(a=>a.mid&&t.indexOf(a.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(async(a,c)=>{a.direction="sendonly"});const r=await this.peerConnection.createOffer(),o=this.logSDPExchange(r.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.unmuteRemote(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(t,this.remoteCodecs,this.store.codec);const s=this.remoteSDP.toString();o==null||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}restartICE(t){var i=this;return ao(function*(){const r=yield Et(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const o=Mt().supportPCSetConfiguration,s=B("FORCE_TURN_TCP")||i.forceTurn;if(t===Ir.RELAY&&!o)return;if(o&&!s){const p=t===Ir.RELAY?"relay":"all",f=i.peerConnection.getConfiguration();f.iceTransportPolicy!==p&&(I.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(f.iceTransportPolicy,"] to [").concat(p,"]")),f.iceTransportPolicy=p,i.peerConnection.setConfiguration(f))}i.remoteSDP.updateCandidates(t);const a=yield Et(i.peerConnection.createOffer({iceRestart:!0}));if(!a.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const c=xc(a.sdp),{remoteIceParameters:d}=yield c.iceParameters;i.remoteSDP.restartICE(d);const l=i.remoteSDP.toString(),h=i.logSDPExchange(a.sdp||"","offer","local","restartICE");i.store.descriptionStart(),yield Et(i.peerConnection.setLocalDescription(a)),h==null||h(l),yield Et(i.peerConnection.setRemoteDescription({type:"answer",sdp:l}))}catch(o){I.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),o)}finally{r()}})()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;const t=await this.mutex.lock("From P2PConnection.extendCandidate");try{this.remoteSDP.updateCandidates(Ir.TCP_RELAY),await Xo(this.peerConnection,this.remoteSDP,this.extension)}catch(i){I.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),i)}finally{t()}}close(){var t;this.peerConnection.getTransceivers().forEach(i=>{Em(this.id+i.mid,this)}),this.preMediaMap.forEach(i=>{let{player:r}=i;r&&r.destroy()}),this.preMediaMap.clear(),this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return bn(bn({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const r=await this.peerConnection.createOffer(),o=this.mungSendOfferSDP(r.sdp,[i],[t]);this.remoteSDP.updateRecvMedia(t,i);const s=this.remoteSDP.toString(),a=this.logSDPExchange(o,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:o}),a==null||a(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(r){throw new oe(O.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(t,i){const r=this.peerConnection.getTransceivers().filter(o=>o.mid===t);r.length===1&&(this.isVP8Simulcast(i)?Ht()||await this.applySimulcastEncodings(r,[i]):await this.applySendEncodings(r,[i]))}setStatsRemoteVideoIsReady(t,i){this.statsFilter.setVideoIsReady2(t,i)}async replaceTrack(t,i){const r=this.peerConnection.getTransceivers().find(o=>o.mid===i);r&&await r.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const i=t[0].transport.iceTransport,{local:r,remote:o}=i.getSelectedCandidatePair();return{local:bn(bn({},Rs),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port}),remote:bn(bn({},Rs),{},{candidateType:o.type,protocol:o.protocol,address:o.address,port:o.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=t=>{if(t&&(t.errorCode||t.errorText)){var i;const r="code: ".concat(t.errorCode,", message: ").concat(t.errorText),o=t.port?"local: ".concat(t.port):"",s=Hd(t.url||"");I.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICECandidateError(").concat(r,"), url: ").concat(s||"",", host_candidate:").concat(o)),(i=this.onICECandidateError)===null||i===void 0||i.call(this,r)}},this.peerConnection.onicegatheringstatechange=t=>{t&&t.target&&"iceGatheringState"in t.target&&I.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(t.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,I.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,I.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},B("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const i={iceServers:[]},r=t.cloudProxyServer||"disabled";return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&(bh(t.turnServer.servers)?i.iceServers=t.turnServer.servers:B("NEW_TURN_MODE")&&i.iceServers&&r==="disabled"?(B("USE_TURN_SERVER_OF_GATEWAY")?t.turnServer.serversFromGateway&&i.iceServers.push(...OR.newTurnServerConfigToIceServers(t.turnServer.serversFromGateway)):i.iceServers.push(...OR.newTurnServerConfigToIceServers(t.turnServer.servers)),B("NEW_FORCE_TURN")&&(i.iceTransportPolicy="relay")):t.turnServer.mode!=="off"&&(i.iceServers&&i.iceServers.push(...OR.turnServerConfigToIceServers(t.turnServer.servers)),B("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...OR.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),B("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(o=>{o.forceturn&&(i.iceTransportPolicy="relay")}))),B("ENABLE_ENCODED_TRANSFORM")&&Mt().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),i}static turnServerConfigToIceServers(t){const i=[];return t.forEach(r=>{r.security?r.tcpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ia(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&!B("FORCE_TURN_TCP")&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),i}static newTurnServerConfigToIceServers(t){const i=[];return t.forEach(r=>{const o=B("NEW_TURN_MODE");o===1?i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=udp")}):o===2?i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=tcp")}):o===3?i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ia(r.turnServerURL),":443?transport=tcp")}):o===4&&(i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=udp")}),i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=tcp")}),i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ia(r.turnServerURL),":443?transport=tcp")}))}),i}tryBindTransportEvents(t){const i=t.transport;if(i){this.transportEventReceiver=t,i.onstatechange=()=>{var o;i!=null&&i.state&&((o=this.onDTLSTransportStateChange)===null||o===void 0||o.call(this,i.state))},i.onerror=o=>{var s;(s=this.onDTLSTransportError)===null||s===void 0||s.call(this,"error"in o?o.error:o)};const r=i.iceTransport;r&&(r.onstatechange=()=>{const o=i==null?void 0:i.iceTransport.state;var s;o&&((s=this.onICETransportStateChange)===null||s===void 0||s.call(this,o))},r.getSelectedCandidatePair&&(r.onselectedcandidatepairchange=()=>{if(r.getSelectedCandidatePair()){const{local:o,remote:s}=r.getSelectedCandidatePair()||{};if(o&&s){const a=o.address+":"+o.port,c=s.address+":"+s.port;I.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(Hd(a)),", remote ").concat(JSON.stringify(Hd(c))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,i){var r,o;if(i||(i=this.peerConnection.getSenders().find(T=>T.track===t._mediaStreamTrack)),!i)return I.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return I.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Mt().supportSetRtpSenderParameters)return I.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},a={};switch(t._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;case"balanced":s.degradationPreference="balanced"}const c=nm(this.peerConnection,t._mediaStreamTrack),d=nD(t);if(GT(t)&&c&&i&&d&&this.getLocalVideoStats&&z(r=["vp8","vp9"]).call(r,this.store.codec)){var l;const S=s.degradationPreference||(z(l=t._hints).call(l,ui.CUSTOM_TRACK)?B("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");V_(this.id+c.mid,d,this,S,T=>{i&&this.updateAdaptation(i,T)},this.getLocalVideoStats.bind(this))}if(t._encoderConfig){var h;const{bitrateMax:S,frameRate:T,scaleResolutionDownBy:C}=t._encoderConfig;S&&(a.maxBitrate=1e3*S),(z(h=t._hints).call(h,ui.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(T&&(a.maxFramerate=qo(T)),C&&C>=1&&(a.scaleResolutionDownBy=C))}const{maxFramerate:p}=B("ENCODER_CONFIG_LIMIT");if(p&&typeof p=="number"&&(a.maxFramerate=a.maxFramerate?Math.min(a.maxFramerate,p):p),B("DSCP_TYPE")&&ha()){var f;const S=B("DSCP_TYPE");z(f=["very-low","low","medium","high"]).call(f,S)&&(a.networkPriority=S)}const m=i.getParameters(),g=(o=m.encodings)===null||o===void 0?void 0:o[0];Ht()&&!g&&(s.encodings=[a]),g&&Object.assign(g,a),Object.assign(m,s),I.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(m.encodings))),await i.setParameters(m),await MT(this.store.codec,i,B("SVC_MODE"))}async updateAdaptation(t,i){var r,o;if(!t)return I.debug("[updateAdaptation] no rtpSender found");if(!Mt().supportSetRtpSenderParameters)return I.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const s={},{bitrateMax:a,frameRate:c,scaleResolutionDownBy:d}=i;a&&(s.maxBitrate=1e3*a),c&&(s.maxFramerate=qo(c)),d&&d>=1&&z(r=["vp8","vp9"]).call(r,this.store.codec)&&(s.scaleResolutionDownBy=d);const l=t.getParameters(),h=(o=l.encodings)===null||o===void 0?void 0:o[0];h&&Object.assign(h,s),Object.assign(l,{});try{await t.setParameters(l),I.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(l.encodings)))}catch(p){!("transport"in t)||t.transport&&t.transport.state==="connected"?this.peerConnectionState!=="connected"?I.debug("[updateAdaptation] peerConnection not connected}"):I.debug("[updateAdaptation] updateRtpSenderEncodings failed",p):I.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(t,i){try{if(!Mt().supportSetRtpSenderParameters||t.length!==i.length)return;for(let r=0;r<t.length;r++){const o=t[r],s=i[r];s instanceof yi&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,o.sender)}}catch{I.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,i,r){if(B("FORBID_MODIFY_LOCAL_OFFER_SDP"))return t;const o=sn(t);return i.forEach((s,a)=>{const c=r[a],d=o.mediaDescriptions.find(l=>l.attributes.mid===c);d&&(Fu(d,s),dC(d,s,this.store.codec))}),Du(o)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,i,r)=>{var o;(o=this.onFirstVideoDecoded)===null||o===void 0||o.call(this,t,i,r)},this.statsFilter.onSelectedLocalCandidateChanged=(t,i)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,t,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,i)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,t,i)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,i){if(t.length===i.length)for(let d=0;d<t.length;d++){var r,o,s,a,c;const l=t[d],h=i[d];if(h instanceof yi&&!z(r=h._hints).call(r,ui.LOW_STREAM)&&(o=h._encoderConfig)!==null&&o!==void 0&&o.bitrateMax&&((s=h._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(a=h._scalabilityMode)!==null&&a!==void 0&&a.numSpatialLayers&&((c=h._scalabilityMode)===null||c===void 0?void 0:c.numSpatialLayers)>1&&this.store.codec==="vp8"){const p={},f={high:1e3*(h._encoderConfig.bitrateMax-50),medium:5e4};p.encodings=[{rid:"m",active:!0,maxBitrate:f.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:f.high}];const m=l.sender.getParameters();await l.sender.setParameters(Object.assign(m,p))}}}async applySimulcastEncodings(t,i){if(!Ht()&&t.length===i.length)for(let r=0;r<t.length;r++){const o=i[r];if(o instanceof yi&&this.isVP8Simulcast(o)){const s=t[r],a={},c={high:1e3*(o._encoderConfig.bitrateMax-50),medium:5e4};a.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:c.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:c.medium,scaleResolutionDownBy:4}];const d=s.sender.getParameters();await s.sender.setParameters(Object.assign(d,a))}}}isVP8Simulcast(t){var i,r,o,s,a;return!!(t instanceof yi&&B("SIMULCAST")&&this.store.codec==="vp8"&&!z(i=t._hints).call(i,ui.LOW_STREAM)&&(r=t._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=t._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=t._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=t._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1)}logSDPExchange(t,i,r,o){if(B("SDP_LOGGING"))return I.upload("[".concat(this.store.clientId,"] exchanging ").concat(r," ").concat(i," SDP during P2PConnection.").concat(o,`
`),t),i==="offer"?s=>{this.logSDPExchange(s,"answer",r==="local"?"remote":"local",o)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const i=this.remoteSDP.getSSRC(t);return i&&i.length!==0?i[0].ssrcId:void 0}setConfiguration(t){if(Mt().supportPCSetConfiguration){const i=OR.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}t.isPreallocation&&(this.isPreallocation=!0)}},Ae($t.prototype,"updateRemoteRTPCapabilities",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"updateRemoteRTPCapabilities"),$t.prototype),Ae($t.prototype,"connect",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"connect"),$t.prototype),Ae($t.prototype,"updateRemoteConnect",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"updateRemoteConnect"),$t.prototype),Ae($t.prototype,"createDataChannels",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"createDataChannels"),$t.prototype),Ae($t.prototype,"receive",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"receive"),$t.prototype),Ae($t.prototype,"batchReceive",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"batchReceive"),$t.prototype),Ae($t.prototype,"stopReceiving",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"stopReceiving"),$t.prototype),Ae($t.prototype,"muteRemote",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"muteRemote"),$t.prototype),Ae($t.prototype,"unmuteRemote",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"unmuteRemote"),$t.prototype),Ae($t.prototype,"muteLocal",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"muteLocal"),$t.prototype),Ae($t.prototype,"unmuteLocal",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"unmuteLocal"),$t.prototype),Ae($t.prototype,"close",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"close"),$t.prototype),Ae($t.prototype,"updateEncoderConfig",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"updateEncoderConfig"),$t.prototype),Ae($t.prototype,"updateSendParameters",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"updateSendParameters"),$t.prototype),Ae($t.prototype,"replaceTrack",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"replaceTrack"),$t.prototype),Ae($t.prototype,"updateAdaptation",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"updateAdaptation"),$t.prototype),Ae($t.prototype,"getRemoteSSRC",[Uo],Object.getOwnPropertyDescriptor($t.prototype,"getRemoteSSRC"),$t.prototype),$t);function Uo(e,t,i){const r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const o=this.mutex,s=await o.lock("From P2PConnection.".concat(t));try{for(var a=arguments.length,c=new Array(a),d=0;d<a;d++)c[d]=arguments[d];return await r.apply(this,c)}finally{s()}},i}function IC(e,t){let i=document.createElement("video"),r=document.createElement("canvas");i.setAttribute("style","display:none"),r.setAttribute("style","display:none"),i.setAttribute("muted",""),i.muted=!0,i.setAttribute("autoplay",""),i.autoplay=!0,i.setAttribute("playsinline",""),r.width=qo(t.width),r.height=qo(t.height);const o=qo(t.framerate||15);document.body.append(i),document.body.append(r);let s=e._mediaStreamTrack;i.srcObject=new MediaStream([s]),i.play().catch(Pf);const a=r.getContext("2d");if(!a)throw new $(O.UNEXPECTED_ERROR,"can not get canvas context");const c=Mt(),d=r.captureStream(c.supportRequestFrame?0:o).getVideoTracks()[0];d.canvas||(d.canvas=r),r.startCapture=()=>{if(!i)return r.stopCapture&&r.stopCapture();if(i.paused&&i.play(),i.videoHeight>2&&i.videoWidth>2){const h=i.videoWidth,p=i.videoHeight/h,f=r.width*p;Math.abs(f-r.height)>=2&&(I.debug("adjust low stream resolution","".concat(r.width,"x").concat(r.height," -> ").concat(r.width,"x").concat(f)),r.height=f)}a.drawImage(i,0,0,r.width,r.height),d.requestFrame&&d.requestFrame(),s!==e._mediaStreamTrack&&(s=e._mediaStreamTrack,i.srcObject=new MediaStream([s]))},r.stopCapture=xv(()=>r.startCapture&&r.startCapture(),o);const l=d.stop;return d.stop=()=>{l.call(d),i&&(i.remove(),i.srcObject=null,i=null),r&&(r.width=0,r.remove(),r.stopCapture&&r.stopCapture(),r.startCapture=void 0,r.stopCapture=void 0,r=null),I.debug("clean low stream renderer")},d}var Gc=function(e){return e[e.Video_Send_Type=190]="Video_Send_Type",e}(Gc||{}),rt=function(e){return e[e.Video_Send_Qp_Sum=2143]="Video_Send_Qp_Sum",e[e.Video_Send_Freeze=2082]="Video_Send_Freeze",e[e.Video_Recv_Qp_Sum=2144]="Video_Recv_Qp_Sum",e[e.Video_Recv_Freeze=2084]="Video_Recv_Freeze",e[e.Video_Render_Freeze_Time=2109]="Video_Render_Freeze_Time",e[e.Video_Render_Freeze_Time_Render=2147]="Video_Render_Freeze_Time_Render",e[e.Video_Render_Freeze_Time_Render2=2223]="Video_Render_Freeze_Time_Render2",e[e.Audio_Recv_Freeze=2083]="Audio_Recv_Freeze",e}(rt||{}),He=function(e){return e[e.Video_Send_Retransmit=2062]="Video_Send_Retransmit",e[e.Video_Send_Target_Encoded=2064]="Video_Send_Target_Encoded",e[e.Video_Send_Actual_Encoded=2060]="Video_Send_Actual_Encoded",e[e.Video_Send_Transmit=2066]="Video_Send_Transmit",e[e.Video_Send_Bandwidth=2061]="Video_Send_Bandwidth",e[e.Video_Capture_Height=2033]="Video_Capture_Height",e[e.Video_Capture_Width=2035]="Video_Capture_Width",e[e.Video_Capture_Frame_Rate=2034]="Video_Capture_Frame_Rate",e[e.Video_Send_Low_Height=2073]="Video_Send_Low_Height",e[e.Video_Send_Low_Frame_Rate=2075]="Video_Send_Low_Frame_Rate",e[e.Video_Send_Low_Width=2077]="Video_Send_Low_Width",e[e.Video_Send_Low_Bitrate=2069]="Video_Send_Low_Bitrate",e[e.Video_Send_Low_Package_Lost=2070]="Video_Send_Low_Package_Lost",e[e.Video_Send_Low_Package_Rate=2071]="Video_Send_Low_Package_Rate",e[e.Video_Send_Frame_Rate=2002]="Video_Send_Frame_Rate",e[e.Video_Send_Width=2003]="Video_Send_Width",e[e.Video_Send_Height=2004]="Video_Send_Height",e[e.Video_Send_Disabled=2095]="Video_Send_Disabled",e[e.Video_Send_Adaptation=2032]="Video_Send_Adaptation",e[e.Video_Send_Player_Status=2128]="Video_Send_Player_Status",e[e.Video_Send_Nacks=2009]="Video_Send_Nacks",e[e.Video_Send_Plis=2010]="Video_Send_Plis",e[e.Video_Send_Firs=2011]="Video_Send_Firs",e[e.Video_Send_Avg_Encode=2007]="Video_Send_Avg_Encode",e[e.Video_Send_Huge_Frame_Sent=2174]="Video_Send_Huge_Frame_Sent",e[e.Video_Send_Bytes_Retransmit=2173]="Video_Send_Bytes_Retransmit",e[e.Video_Send_Packages_Retransmit=2172]="Video_Send_Packages_Retransmit",e[e.Video_Send_Key_Frames_Encoded=2207]="Video_Send_Key_Frames_Encoded",e[e.Video_Send_Bitrate=2012]="Video_Send_Bitrate",e[e.Video_Send_Package_Rate=2031]="Video_Send_Package_Rate",e[e.Video_Send_Package_Lost=2005]="Video_Send_Package_Lost",e[e.Audio_Capture_PCM_Level=2104]="Audio_Capture_PCM_Level",e[e.Audio_Send_Level=2038]="Audio_Send_Level",e[e.Audio_Send_Bitrate=2039]="Audio_Send_Bitrate",e[e.Audio_Send_Package_Rate=2040]="Audio_Send_Package_Rate",e[e.Audio_Send_AEC_Return_Loss=2041]="Audio_Send_AEC_Return_Loss",e[e.Audio_Send_AEC_Return_Loss_Enhancement=2042]="Audio_Send_AEC_Return_Loss_Enhancement",e[e.Audio_Send_Freeze=2081]="Audio_Send_Freeze",e[e.Audio_Send_Disabled=2096]="Audio_Send_Disabled",e[e.Audio_Send_Bytes_Retransmit=2179]="Audio_Send_Bytes_Retransmit",e[e.Audio_Send_Packages_Retransmit=2180]="Audio_Send_Packages_Retransmit",e[e.Video_Recv_Height=2019]="Video_Recv_Height",e[e.Video_Recv_Width=2018]="Video_Recv_Width",e[e.Video_Recv_Frame_Rate_Output=2155]="Video_Recv_Frame_Rate_Output",e[e.Video_Recv_Jitter_Buffer=2023]="Video_Recv_Jitter_Buffer",e[e.Video_Recv_Current_Delay=2024]="Video_Recv_Current_Delay",e[e.Video_Recv_Nacks=2026]="Video_Recv_Nacks",e[e.Video_Recv_Plis=2027]="Video_Recv_Plis",e[e.Video_Recv_Firs=2028]="Video_Recv_Firs",e[e.Video_Recv_Disabled=2101]="Video_Recv_Disabled",e[e.Video_Recv_Player_Status=2129]="Video_Recv_Player_Status",e[e.Video_Recv_I_Frame_Delay=2149]="Video_Recv_I_Frame_Delay",e[e.Video_Render_Frame_Rate_Render=2022]="Video_Render_Frame_Rate_Render",e[e.Video_Render_Freeze_Duration=2156]="Video_Render_Freeze_Duration",e[e.Audio_Render_Level=2043]="Audio_Render_Level",e[e.Audio_Render_Freeze_Time_80ms=2226]="Audio_Render_Freeze_Time_80ms",e[e.Audio_Render_Freeze_Time_200ms=2227]="Audio_Render_Freeze_Time_200ms",e[e.Audio_Render_Freeze_Samples_80ms=2228]="Audio_Render_Freeze_Samples_80ms",e[e.Audio_Render_Freeze_Samples_200ms=2229]="Audio_Render_Freeze_Samples_200ms",e[e.Audio_Recv_PCM_Level=2105]="Audio_Recv_PCM_Level",e[e.Audio_Recv_Disabled=2102]="Audio_Recv_Disabled",e[e.Audio_Recv_Jitter_Buffer=2054]="Audio_Recv_Jitter_Buffer",e[e.Audio_Recv_Current_Delay=2047]="Audio_Recv_Current_Delay",e[e.Audio_Recv_Player_Status=2130]="Audio_Recv_Player_Status",e[e.Audio_Recv_Bitrate=2044]="Audio_Recv_Bitrate",e[e.Audio_Recv_Concealed_Samples=2148]="Audio_Recv_Concealed_Samples",e[e.Audio_Recv_Total_Samples_Received=2224]="Audio_Recv_Total_Samples_Received",e}(He||{}),Ti=function(e){return e[e.Video_Render_Frame_Rate_Decode=2021]="Video_Render_Frame_Rate_Decode",e[e.Video_Recv_Frame_Rate=2020]="Video_Recv_Frame_Rate",e[e.Video_Recv_Frame_Dropped=2181]="Video_Recv_Frame_Dropped",e[e.Video_Recv_Bytes_Retransmit=2175]="Video_Recv_Bytes_Retransmit",e[e.Video_Recv_Packages_Retransmit=2176]="Video_Recv_Packages_Retransmit",e[e.Video_Recv_Packages_Discarded=2198]="Video_Recv_Packages_Discarded",e[e.Video_Recv_Avg_Decode=2200]="Video_Recv_Avg_Decode",e[e.Video_Recv_Avg_Processing_Delay=2202]="Video_Recv_Avg_Processing_Delay",e[e.Video_Recv_Avg_Assembly_Time=2203]="Video_Recv_Avg_Assembly_Time",e[e.Video_Recv_Avg_Inter_Frame_Delay=2204]="Video_Recv_Avg_Inter_Frame_Delay",e[e.Video_Recv_Key_Frames_Decoded=2206]="Video_Recv_Key_Frames_Decoded",e[e.Video_Recv_Package_Lost=2014]="Video_Recv_Package_Lost",e[e.Video_Recv_Bitrate=2029]="Video_Recv_Bitrate",e[e.Video_Recv_Package_Rate=2078]="Video_Recv_Package_Rate",e[e.Audio_Recv_Jitter=2055]="Audio_Recv_Jitter",e[e.Audio_Recv_Bytes_Retransmit=2178]="Audio_Recv_Bytes_Retransmit",e[e.Audio_Recv_Packages_Retransmit=2177]="Audio_Recv_Packages_Retransmit",e[e.Audio_Recv_Packages_Discarded=2199]="Audio_Recv_Packages_Discarded",e[e.Audio_Recv_Avg_Processing_Delay=2201]="Audio_Recv_Avg_Processing_Delay",e[e.Audio_Recv_Package_Rate=2046]="Audio_Recv_Package_Rate",e[e.Audio_Recv_Package_Lost=2045]="Audio_Recv_Package_Lost",e[e.Audio_Recv_AV_Sync_TIME=2237]="Audio_Recv_AV_Sync_TIME",e}(Ti||{}),Jr=function(e){return e[e.RTT=2006]="RTT",e[e.CONN_TYPE=801]="CONN_TYPE",e[e.STATS_UPDATE_INTERVAL=2205]="STATS_UPDATE_INTERVAL",e}(Jr||{}),Hh=function(e){return e[e.RTC_PEER_CONNECTION_STATE=2219]="RTC_PEER_CONNECTION_STATE",e[e.PAGE_VISIBILITY=2233]="PAGE_VISIBILITY",e}(Hh||{}),Wu=function(e){return e[e.Transport_Send_Bitrate=2234]="Transport_Send_Bitrate",e[e.Transport_Recv_Bitrate=2235]="Transport_Recv_Bitrate",e}(Wu||{});const Ll=1e3,Kh=6,zT=3,Ze=Math.max(Kh,zT,60);function Qe(e,t,i){i!=null&&Number.isFinite(i)&&(e[t]=Math.round(Math.max(0,i)))}function SL(e){const t={[Jr.CONN_TYPE]:0,[Jr.RTT]:e.rtt,[Jr.STATS_UPDATE_INTERVAL]:e.updateInterval?Math.round(Math.max(0,e.updateInterval)):void 0};switch(e.selectedCandidatePair.localCandidate.candidateType){case"relay":{const i=e.selectedCandidatePair.localCandidate.relayProtocol;i==="udp"&&(t[Jr.CONN_TYPE]=1),i==="tcp"&&(t[Jr.CONN_TYPE]=3),i==="tls"&&(t[Jr.CONN_TYPE]=4);break}case"srflx":t[Jr.CONN_TYPE]=2;break;case"unknown":t[Jr.CONN_TYPE]=5;break;default:t[Jr.CONN_TYPE]=0}return t}function TL(e){let t=0;switch(e){case"none":t=0;break;case"cpu":t=1;break;case"bandwidth":t=2;break;case"other":t=3}return t}class c2 extends Vi{constructor(t){super(),M(this,"store",void 0),M(this,"uploadWRTCStatsTimer",void 0),M(this,"uploadOutboundDenoiserStatsTimer",void 0),M(this,"uploadExtStatsTimer",void 0),M(this,"uploadExtUsageStatsTimer",void 0),M(this,"uploadInboundExtStatsTimer",void 0),M(this,"requestStats",void 0),M(this,"requestTransportStats",void 0),M(this,"requestLocalMedia",void 0),M(this,"requestRemoteMedia",void 0),M(this,"requestAllTracks",void 0),M(this,"requestVideoIsReady",void 0),M(this,"requestUploadStats",void 0),M(this,"requestUpload",void 0),M(this,"uploadOutboundStarted",!1),M(this,"uploadInboundStarted",!1),M(this,"uploadTransportStarted",!1),M(this,"uploadBaseStatsStarted",!1),M(this,"uploadExtensionUsageStarted",!1),M(this,"lastRecvStats",void 0),M(this,"lastSendStats",void 0),M(this,"lastRefRecvStats",void 0),M(this,"lastRefSendStats",void 0),M(this,"lastNormalRecvStats",void 0),M(this,"lastNormalSendStats",void 0),M(this,"lastExtendStats",{}),M(this,"needUploadStats",{}),M(this,"needUploadRenderFreezeTime",!0),M(this,"lastUploadCompensateTime",-1),M(this,"uploadCompensateDeltaTime",0),this.store=t}uploadWRTCStats(t){if(!this.requestStats||!this.requestUploadStats)return;const i=t%zT==0,r=t%Kh==0,o=t%60==0;let s,a;if(this.uploadTransportStarted&&(s=this.requestStats(),this.store.useP2P&&(a=this.requestStats(!0))),!s&&this.uploadOutboundStarted&&(s=this.requestStats()),!a&&this.uploadInboundStarted&&(a=this.requestStats(!0)),s||a){var c;const d={};if(this.uploadTransportStarted&&s){const h=this.getTransportStats(s,i?this.lastRefSendStats:void 0,a,i);h&&(d.misc=[h])}if(this.uploadOutboundStarted&&s){const h=this.getOutboundStats(s,r?this.lastNormalSendStats:void 0,i?this.lastRefSendStats:void 0,this.lastSendStats,o);h&&(d.outbound=[h])}if(this.uploadInboundStarted&&a){this.uploadCompensateStats(t);const h=this.getInboundStats(a,r?this.lastNormalRecvStats:void 0,i?this.lastRefRecvStats:void 0,this.lastRecvStats);h&&(d.inbound=h)}const l=(c=this.requestTransportStats)===null||c===void 0?void 0:c.call(this).connectState;if(l&&(Array.isArray(d.misc)?d.misc[0]&&d.misc[0].addition&&(d.misc[0].addition[Hh.RTC_PEER_CONNECTION_STATE]=vs[l]):d.misc=[{addition:{[Hh.RTC_PEER_CONNECTION_STATE]:vs[l]}}]),ws.needUploadStats.length>0||r){const h=ws.needUploadStats.shift()||(ws.visibility==="visible"?1:0);Array.isArray(d.misc)?d.misc[0]&&d.misc[0].addition&&(d.misc[0].addition[Hh.PAGE_VISIBILITY]=h):d.misc=[{addition:{[Hh.PAGE_VISIBILITY]:h}}]}this.needUploadStats.sendType&&(Array.isArray(d.outbound)&&d.outbound[0]&&d.outbound[0].high&&(d.outbound[0].high[Gc.Video_Send_Type]=this.needUploadStats.sendType),this.needUploadStats.sendType=void 0),this.requestUploadStats(d)}this.lastRecvStats=a,this.lastSendStats=s,r&&(this.lastNormalRecvStats=a,this.lastNormalSendStats=s),i&&(this.lastRefRecvStats=a,this.lastRefSendStats=s)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;this.uploadBaseStatsStarted=!0,ws.startCollectStats();let t=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted){if(this.uploadBaseStatsStarted){var i,r;const o=(i=this.requestTransportStats)===null||i===void 0?void 0:i.call(this);return void(o&&((r=this.requestUploadStats)===null||r===void 0||r.call(this,{misc:[{addition:{[Hh.RTC_PEER_CONNECTION_STATE]:vs[o.connectState]}}]})))}return this.stopUploadWRTCStats()}this.uploadWRTCStats(t),++t===Ze+1&&(t=1)},Ll)}uploadCompensateStats(t){if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;const i=t%zT==0&&this.needUploadRenderFreezeTime;if(!this.uploadInboundStarted||!i)return;if(this.lastUploadCompensateTime===-1)return void(this.lastUploadCompensateTime=Date.now());const r=Math.max(-6e3,Date.now()-this.lastUploadCompensateTime-6e3);if(this.uploadCompensateDeltaTime+=r,this.lastUploadCompensateTime=Date.now(),this.uploadCompensateDeltaTime<6e3)return;const o=Math.min(Math.floor(this.uploadCompensateDeltaTime/6e3),10);this.uploadCompensateDeltaTime-=6e3*o;const s=this.requestStats(!0);new Array(o).fill(0).forEach(()=>{if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;const a={};if(this.uploadInboundStarted&&s){const c=this.requestRemoteMedia()||[],d=[];c.forEach(l=>{let[h,p]=l;const f={peer:h.uid};if(h._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(h._videoSSRC)&&p.has(be.VIDEO)&&h.videoTrack){const m=function(g,S,T){if(!S.videoRecv.find(b=>b.ssrc===g))return;const C={};if(T&&T._player){const b=T._player,{renderFreezeAccTime2:D,videoElementStatus:x}=b;if(ws.visibility==="visible"&&x===Pr.PLAYING&&Mt().supportRequestVideoFrameCallback){const k=Math.min(6e3,D);b.renderFreezeAccTime2=Math.max(0,D-k),Qe(C,rt.Video_Render_Freeze_Time_Render2,k),B("USE_NEW_RENDER_FREEZE_TIME")&&Qe(C,rt.Video_Render_Freeze_Time_Render,k)}}return C}(h._videoSSRC,s,h.videoTrack);m&&(f.video=m)}f.video&&d.push(f)}),d.length>0&&(a.inbound=d,this.requestUploadStats(a))}})}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0}getTransportStats(t,i,r,o){if(!this.requestStats)return;if(!o)return t.rtt==null?void 0:{addition:{[Jr.RTT]:t.rtt,[Jr.CONN_TYPE]:void 0,[Jr.STATS_UPDATE_INTERVAL]:t.updateInterval||void 0}};const s=SL(t);if(this.store.useP2P){if(r){const a=SL(r);s[Jr.CONN_TYPE]&&a[Jr.CONN_TYPE]&&(s[Jr.CONN_TYPE]+=a[Jr.CONN_TYPE]<<3)}s[Jr.CONN_TYPE]?s[Jr.CONN_TYPE]+=110:s[Jr.CONN_TYPE]=110}else{s[Jr.CONN_TYPE]?s[Jr.CONN_TYPE]+=100:s[Jr.CONN_TYPE]=100;const a=function(c,d){return d?[Math.ceil(8*(c.transport.bytesSent-d.transport.bytesSent)/(c.timestamp-d.timestamp)),Math.ceil(8*(c.transport.bytesReceived-d.transport.bytesReceived)/(c.timestamp-d.timestamp))]:[0,0]}(t,i);s[Wu.Transport_Send_Bitrate]=a[0],s[Wu.Transport_Recv_Bitrate]=a[1]}return{addition:s}}getOutboundStats(t,i,r,o,s){if(!this.requestUploadStats||!this.requestLocalMedia)return;const a=this.requestLocalMedia();if(!a||a.length===0)return;let c,d,l;return a.forEach(h=>{let[p,{track:f,ssrcs:m}]=h;switch(p){case ue.LocalVideoLowTrack:case ue.LocalVideoTrack:if(p===ue.LocalVideoTrack){var g;const S=function(D,x,k,V,W,K){const J=x.videoSend.find(De=>De.ssrc===D);if(!J)return;const se={},{sentFrame:Ne,inputFrame:Ce}=J;if(V&&(Qe(se,rt.Video_Send_Qp_Sum,J.qpSumPerFrame),Ce&&Ne)){const De=Ce.frameRate,Me=Ne.frameRate;se[rt.Video_Send_Freeze]=function(et,ae){let Y=!0;return Y=!(et<=5)&&(et<=10?ae<3:et<=20?ae<4:ae<5),Y}(De,Me)?1:0}if(W){switch(Ne&&(Qe(se,He.Video_Send_Height,Ne.height),Qe(se,He.Video_Send_Width,Ne.width),Qe(se,He.Video_Send_Frame_Rate,Ne.frameRate)),se[He.Video_Send_Disabled]=k._originMediaStreamTrack&&!k._originMediaStreamTrack.enabled||k._mediaStreamTrack&&!k._mediaStreamTrack.enabled?1:0,J.adaptionChangeReason){case"none":se[He.Video_Send_Adaptation]=0;break;case"cpu":se[He.Video_Send_Adaptation]=1;break;case"bandwidth":se[He.Video_Send_Adaptation]=2;break;case"other":se[He.Video_Send_Adaptation]=3}let De=0;J.adaptionChangeReason&&(De+=TL(J.adaptionChangeReason)),x.qualityLimitationReason&&(De+=TL(x.qualityLimitationReason)<<3),se[He.Video_Send_Adaptation]=De,se[He.Video_Send_Player_Status]=Yf[k._player?k._player.videoElementStatus:"uninit"],Qe(se,He.Video_Send_Nacks,J.nacksCount),Qe(se,He.Video_Send_Plis,J.plisCount),Qe(se,He.Video_Send_Firs,J.firsCount),Qe(se,He.Video_Send_Avg_Encode,J.avgEncodeMs),Qe(se,He.Video_Send_Huge_Frame_Sent,J.hugeFramesSent),Qe(se,He.Video_Send_Bytes_Retransmit,J.retransmittedBytesSent),Qe(se,He.Video_Send_Packages_Retransmit,J.retransmittedPacketsSent),Qe(se,He.Video_Send_Key_Frames_Encoded,J.keyFramesEncoded);const Me=W.videoSend.find(et=>et.ssrc===D);if(Me){let et=Ll*zT;Me.timestamp&&J.timestamp&&(et=J.timestamp-Me.timestamp),Me.packets!=null&&J.packets!=null&&Qe(se,He.Video_Send_Package_Rate,1e3*(J.packets-Me.packets)/et),J.packetsLost!=null&&Me.packetsLost!=null&&Qe(se,He.Video_Send_Package_Lost,J.packetsLost-Me.packetsLost),Me.bytes!=null&&J.bytes!=null&&Qe(se,He.Video_Send_Bitrate,8*(J.bytes-Me.bytes)/et)}}return se}(m[0].ssrcId,t,f,i,r),T=f.__className__==="CameraVideoTrack"?3:z(g=f._hints).call(g,ui.SCREEN_TRACK)?7:10;(this.lastExtendStats.sendType!==T||s)&&(this.needUploadStats={sendType:T},this.lastExtendStats.sendType=T);const C=f&&function(D,x,k,V){const W=x.videoSend.find(J=>J.ssrc===D);if(!W)return null;const K={};if(V){const J=W.inputFrame,se=J&&J.height||k.videoHeight||0,Ne=J&&J.width||k.videoWidth||0,Ce=J&&J.frameRate||0;Qe(K,He.Video_Capture_Height,se),Qe(K,He.Video_Capture_Width,Ne),Qe(K,He.Video_Capture_Frame_Rate,Ce)}return K}(m[0].ssrcId,t,f,!!r),b=function(D,x){const k={};return x&&(Qe(k,He.Video_Send_Retransmit,D.bitrate.retransmit),Qe(k,He.Video_Send_Target_Encoded,D.bitrate.targetEncoded),Qe(k,He.Video_Send_Actual_Encoded,D.bitrate.actualEncoded),Qe(k,He.Video_Send_Transmit,D.bitrate.transmit),Qe(k,He.Video_Send_Bandwidth,D.sendBandwidth)),k}(t,!!r);d=Object.assign({},S,C,b)}else l=function(S,T,C,b,D){const x=T.videoSend.find(V=>V.ssrc===S);if(!x)return;const k={};if(b){const V=x.sentFrame;V&&(Qe(k,He.Video_Send_Low_Height,V.height),Qe(k,He.Video_Send_Low_Width,V.width),Qe(k,He.Video_Send_Low_Frame_Rate,V.frameRate));const W=b.videoSend.find(K=>K.ssrc===S);if(W){let K=Ll*Kh;W.timestamp&&x.timestamp&&(K=x.timestamp-W.timestamp),W.packets!=null&&x.packets!=null&&Qe(k,He.Video_Send_Low_Package_Rate,1e3*(x.packets-W.packets)/K),x.packetsLost!=null&&W.packetsLost!=null&&Qe(k,He.Video_Send_Low_Package_Lost,x.packetsLost-W.packetsLost),W.bytes!=null&&x.bytes!=null&&Qe(k,He.Video_Send_Low_Bitrate,8*(x.bytes-W.bytes)/K)}}return k}(m[0].ssrcId,t,0,r);break;case ue.LocalAudioTrack:c=f&&function(S,T,C,b,D,x){const k=T.audioSend.find(W=>W.ssrc===S);if(!k)return;const V={};if(D){V[He.Audio_Send_Disabled]=C._originMediaStreamTrack&&!C._originMediaStreamTrack.enabled||C._mediaStreamTrack&&!C._mediaStreamTrack.enabled?1:0;const W=100*C._source.getAccurateVolumeLevel(),K=k.inputLevel;if(K!=null){const se=Math.ceil(50*Math.log10(100*K+1));Qe(V,He.Audio_Send_Level,se)}Qe(V,He.Audio_Capture_PCM_Level,W),Qe(V,He.Audio_Send_AEC_Return_Loss,k.aecReturnLoss),Qe(V,He.Audio_Send_AEC_Return_Loss_Enhancement,k.aecReturnLossEnhancement),Qe(V,He.Audio_Send_Bytes_Retransmit,k.retransmittedBytesSent),Qe(V,He.Audio_Send_Packages_Retransmit,k.retransmittedPacketsSent),V[He.Audio_Send_Freeze]=0;const J=D.audioSend.find(se=>se.ssrc===S);if(J){let se=Ll*Kh;J.timestamp&&k.timestamp&&(se=k.timestamp-J.timestamp),J.bytes!=null&&k.bytes!=null&&Qe(V,He.Audio_Send_Bitrate,8*(k.bytes-J.bytes)/se),J.packets!=null&&k.packets!=null&&Qe(V,He.Audio_Send_Package_Rate,1e3*(k.packets-J.packets)/se)}}return V}(m[0].ssrcId,t,f,0,r)}}),{high:d,low:l,audio:c}}getInboundStats(t,i,r,o){if(!this.requestRemoteMedia)return;const s=this.requestRemoteMedia()||[],a=[];return s.forEach(c=>{let[d,l]=c;const h={peer:d.uid};let p;if(l.has(be.VIDEO)&&d.videoTrack){const f=d._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(d._videoSSRC)||!1,m=d.videoTrack?function(g,S,T,C,b,D,x,k){const V=S.videoRecv.find(Me=>Me.ssrc===g);if(!V)return;const W={},{receivedFrame:K,outputFrame:J,decodeFrameRate:se}=V;Qe(W,Ti.Video_Render_Frame_Rate_Decode,se),V.framesRateFirefox&&Qe(W,Ti.Video_Recv_Frame_Rate,V.framesRateFirefox),K&&Qe(W,Ti.Video_Recv_Frame_Rate,K.frameRate),Qe(W,Ti.Video_Recv_Frame_Dropped,V.framesDroppedCount),Qe(W,Ti.Video_Recv_Bytes_Retransmit,V.retransmittedBytesReceived),Qe(W,Ti.Video_Recv_Packages_Retransmit,V.retransmittedPacketsReceived),Qe(W,Ti.Video_Recv_Packages_Discarded,V.packetsDiscarded),Qe(W,Ti.Video_Recv_Avg_Decode,V.avgDecodeMs),Qe(W,Ti.Video_Recv_Avg_Processing_Delay,V.avgProcessingDelayMs),Qe(W,Ti.Video_Recv_Avg_Assembly_Time,V.avgFramesAssembledFromMultiplePacketsMs),Qe(W,Ti.Video_Recv_Avg_Inter_Frame_Delay,V.avgInterFrameDelayMs),Qe(W,Ti.Video_Recv_Key_Frames_Decoded,V.keyFramesDecoded);const Ne=k&&k.videoRecv.find(Me=>Me.ssrc===g);if(Ne){const Me=S.timestamp-k.timestamp||Ll;V.packetsLost!=null&&Ne.packetsLost!=null&&Qe(W,Ti.Video_Recv_Package_Lost,V.packetsLost-Ne.packetsLost),Ne.bytes!=null&&V.bytes!=null&&Qe(W,Ti.Video_Recv_Bitrate,8*(V.bytes-Ne.bytes)/Me),Ne.packets!=null&&V.packets!=null&&Qe(W,Ti.Video_Recv_Package_Rate,1e3*(V.packets-Ne.packets)/Me)}const Ce=D&&D.videoRecv.find(Me=>Me.ssrc===g);if(Ce&&(Qe(W,rt.Video_Recv_Qp_Sum,V.qpSumPerFrame),W[rt.Video_Recv_Freeze]=C&&_m.isRemoteVideoFreeze(T,V,Ce)?1:0),x){var De;const Me=x.videoRecv.find(ae=>ae.ssrc===g);K?(Qe(W,He.Video_Recv_Height,K.height),Qe(W,He.Video_Recv_Width,K.width)):T&&(Qe(W,He.Video_Recv_Height,T._videoHeight||0),Qe(W,He.Video_Recv_Width,T._videoWidth||0)),J&&Qe(W,He.Video_Recv_Frame_Rate_Output,J.frameRate);const et=(De=T._player)===null||De===void 0?void 0:De.rendFrameRate.toFixed(0);if(et&&Qe(W,He.Video_Render_Frame_Rate_Render,+et),Qe(W,He.Video_Recv_Jitter_Buffer,V.jitterBufferMs),Qe(W,He.Video_Recv_Current_Delay,V.currentDelayMs),Qe(W,He.Video_Recv_Firs,V.firsCount),Qe(W,He.Video_Recv_Nacks,V.nacksCount),Qe(W,He.Video_Recv_Plis,V.plisCount),T){W[He.Video_Recv_Disabled]=T._originMediaStreamTrack.enabled&&T._mediaStreamTrack.enabled?0:1;const ae=T._player;if(ae){const{freezeTimeCounterList:Y,renderFreezeAccTime:ie,renderFreezeAccTime2:Q,videoElementStatus:w}=ae;if(Y&&Y.length>0&&Qe(W,rt.Video_Render_Freeze_Time,Y.splice(0,1)[0]),b&&ws.visibility==="visible"&&w===Pr.PLAYING&&Mt().supportRequestVideoFrameCallback){const v=Math.min(6e3,Q);ae.renderFreezeAccTime2=Math.max(0,Q-v),Qe(W,rt.Video_Render_Freeze_Time_Render2,v);const N=Math.min(6e3,ie);ae.renderFreezeAccTime=Math.max(0,ie-N),Qe(W,rt.Video_Render_Freeze_Time_Render,B("USE_NEW_RENDER_FREEZE_TIME")?v:N)}if(typeof V.totalFreezesDuration=="number"){const v=Me&&Me.totalFreezesDuration?V.totalFreezesDuration-Me.totalFreezesDuration:V.totalFreezesDuration;Qe(W,He.Video_Render_Freeze_Duration,1e3*v)}}}if(W[He.Video_Recv_Player_Status]=Yf[T._player?T._player.videoElementStatus:"uninit"],Me&&V.totalInterFrameDelay!==void 0&&V.totalSquaredInterFrameDelay!==void 0&&Me.totalInterFrameDelay!==void 0&&Me.totalSquaredInterFrameDelay!==void 0){const ae=V.totalInterFrameDelay-Me.totalInterFrameDelay,Y=V.totalSquaredInterFrameDelay-Me.totalSquaredInterFrameDelay,ie=V.framesDecodeCount-Me.framesDecodeCount,Q=ae/ie*1e3,w=Math.round(1e3*Math.sqrt((Y-Math.pow(ae,2)/ie)/ie));!isNaN(w)&&Q+w>Math.max(3*Q,Q+150)&&(W[He.Video_Recv_I_Frame_Delay]=w)}}return W}(d._videoSSRC,t,d.videoTrack,f===!0,this.needUploadRenderFreezeTime,i,r,o):void 0;if(m&&(h.video=m),d.videoTrack){const g=t.videoRecv.find(S=>S.ssrc===d._videoSSRC);g&&g.estimatedPlayoutTimestamp&&(p=g.estimatedPlayoutTimestamp)}}if(l.has(be.AUDIO)&&d.audioTrack){const f=d.audioTrack?function(m,g,S,T,C,b){const D=g.audioRecv.find(W=>W.ssrc===m);if(!D)return;const x={};Qe(x,Ti.Audio_Recv_Jitter,D.jitterMs),Qe(x,Ti.Audio_Recv_Bytes_Retransmit,D.retransmittedBytesReceived),Qe(x,Ti.Audio_Recv_Packages_Retransmit,D.retransmittedPacketsReceived),Qe(x,Ti.Audio_Recv_Packages_Discarded,D.packetsDiscarded),Qe(x,Ti.Audio_Recv_Avg_Processing_Delay,D.avgProcessingDelayMs);const k=b&&b.audioRecv.find(W=>W.ssrc===m);if(k){const W=Ll;D.packets!=null&&k.packets!=null&&Qe(x,Ti.Audio_Recv_Package_Rate,1e3*(D.packets-k.packets)/W),D.packetsLost!=null&&k.packetsLost!=null&&Qe(x,Ti.Audio_Recv_Package_Lost,D.packetsLost-k.packetsLost)}if(T){const{receivedFrames:W,droppedFrames:K}=D;W!=null&&K!=null&&(x[rt.Audio_Recv_Freeze]=(V=W)===0||100*K/V>20?1:0)}var V;if(C){const W=100*S._source.getAccurateVolumeLevel(),K=D.outputLevel;if(K!=null){const se=Math.ceil(50*Math.log10(100*K+1));Qe(x,He.Audio_Render_Level,se)}Qe(x,He.Audio_Recv_PCM_Level,W),S&&(x[He.Audio_Recv_Disabled]=S._originMediaStreamTrack.enabled&&S._mediaStreamTrack.enabled?0:1),Qe(x,He.Audio_Recv_Jitter_Buffer,D.jitterBufferMs),Qe(x,He.Audio_Recv_Current_Delay,D.jitterBufferMs),x[He.Audio_Recv_Player_Status]=Yf[pi.getPlayerState(S.getTrackId())];const J=C.audioRecv.find(se=>se.ssrc===m);if(J){J.bytes!=null&&D.bytes!=null&&Qe(x,He.Audio_Recv_Bitrate,8*(D.bytes-J.bytes)/(Ll*zT));const se=D.concealedSamples-J.concealedSamples;se>0&&Qe(x,He.Audio_Recv_Concealed_Samples,se);const Ne=D.totalSamplesReceived-J.totalSamplesReceived;Ne>0&&Qe(x,He.Audio_Recv_Total_Samples_Received,Ne);const Ce=D.freezeSamples80-J.freezeSamples80;Ce>0&&Qe(x,He.Audio_Render_Freeze_Samples_80ms,Ce);const De=D.freezeSamples200-J.freezeSamples200;De>0&&Qe(x,He.Audio_Render_Freeze_Samples_200ms,De);const Me=D.freezeMs80-J.freezeMs80;Qe(x,He.Audio_Render_Freeze_Time_80ms,Me<0?0:Me);const et=D.freezeMs200-J.freezeMs200;Qe(x,He.Audio_Render_Freeze_Time_200ms,et<0?0:et)}}return x}(d._audioSSRC,t,d.audioTrack,i,r,o):void 0;if(f&&(h.audio=f),d.audioTrack&&p){const m=t.audioRecv.find(g=>g.ssrc===d._audioSSRC);if(m&&m.estimatedPlayoutTimestamp){const g=m.estimatedPlayoutTimestamp-p;h.audio?h.audio[Ti.Audio_Recv_AV_Sync_TIME]=g:h.audio={[Ti.Audio_Recv_AV_Sync_TIME]:g}}}}(h.video||h.audio)&&a.push(h)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,a}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;const t=(this.requestAllTracks()||[]).find(i=>i instanceof hT);if(t&&t._external.getDenoiserStats){const i=t._external.getDenoiserStats();i&&this.requestUpload(it.DENOISER_STATS,i)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(t=>{t.getProcessorStats().forEach(i=>{this.requestUpload&&this.requestUpload(i.type,i.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0,this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(t=>{let[i,r]=t;r.has(be.VIDEO)&&i.videoTrack&&i.videoTrack.getProcessorStats().forEach(o=>{this.requestUpload&&this.requestUpload(o.type,o.stats)}),r.has(be.AUDIO)&&i.audioTrack&&i.audioTrack.getProcessorStats().forEach(o=>{this.requestUpload&&this.requestUpload(o.type,o.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0,this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=void 0)}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const t=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{const i=Date.now(),r={connectionInterval:B("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:i};let o=[];const s=this.requestAllTracks&&this.requestAllTracks()||[];for(const l of s)!l.muted&&l.enabled&&(o=o.concat(await l.getProcessorUsage()));const a=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[l,h]of a)h.has(be.VIDEO)&&l.videoTrack&&(o=o.concat(await l.videoTrack.getProcessorUsage())),h.has(be.AUDIO)&&l.audioTrack&&(o=o.concat(await l.audioTrack.getProcessorUsage()));if(o.length===0)return;r.details=function(l,h){const p={};for(const{id:S,value:T,level:C,direction:b}of l){var f;const D=(f=h.get(S))!==null&&f!==void 0?f:0,x=T===2?D+B("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:D;var m,g;h.set(S,x),p[S]?(T===2&&(p[S].value=T),C>p[S].level&&(p[S].level=C),b==="remote"&&(p[S].remoteUidCount+=1),p[S].totalTs=(m=h.get(S))!==null&&m!==void 0?m:0):p[S]={value:T,level:C,remoteUidCount:b==="local"?0:1,totalTs:(g=h.get(S))!==null&&g!==void 0?g:0}}return Object.keys(p).map(S=>{const{level:T,value:C,totalTs:b}=p[S];return{id:S,level:T,value:C,totalTs:b}})}(o,t);const c=Date.now(),d=c>i?c:i+1;this.requestUpload&&this.requestUpload(it.EXTENSION_USAGE_STATS,{usageStats:r,sendTs:d})},B("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}stopUploadBaseStats(){this.uploadBaseStatsStarted=!1,ws.stopCollectStats()}}const AC=B("ICE_RESTART_INTERVAL");let Hu=new Map,dc=new Map,kl=[Ir.UDP_TCP_RELAY,Ir.TCP_RELAY,Ir.RELAY],wC=B("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Mt().supportPCSetConfiguration;function RL(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const i=Hu.get(e.id);i&&(window.clearTimeout(i),Hu.delete(e.id));const r=dc.get(e.id);t&&r&&r.index===kl.length-1&&(I.debug("[".concat(e.id,"] reset ICE restart policy")),dc.delete(e.id))}function Vt(e,t,i){if(Hu.size===0&&dc.size===0&&(Array.isArray(B("RESTART_SEQUENCE"))&&B("RESTART_SEQUENCE").length>0&&!function(c,d){if(c.length!==d.length)return!1;for(let l=0;l<c.length;l+=1){const h=c[l];if(c.filter(p=>p===h).length!==d.filter(p=>p===h).length)return!1}return!0}(kl,B("RESTART_SEQUENCE"))&&(kl=B("RESTART_SEQUENCE").filter(c=>{var d;if(z(d=Object.values(Ir)).call(d,c))return!0}),I.debug("use reconnection policy from config distribution, queues: ".concat(kl.join(" => ")))),wC=B("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Mt().supportPCSetConfiguration),kl.length===0)return void i();let r,{index:o=0,type:s}=dc.get(e.id)||{};if(wC&&s===Ir.RELAY)return void i();let a=s&&o>=kl.length-1;if(wC)s=Ir.RELAY;else{if(a)return void i();s?(o++,s=kl[o]):(s=kl[0],o=0)}I.debug("[".concat(e.id,"] choose ICE restart policy: ").concat(s,", index: ").concat(o)),t(s),dc.set(e.id,{index:o,type:s}),r=window.setTimeout(()=>Vt(e,t,i),AC),Hu.set(e.id,r)}var Ft;function Jd(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function Qd(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Jd(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Jd(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}function qT(e){var t,i,r,o=2;for(typeof Symbol<"u"&&(i=wf,r=Symbol.iterator);o--;){if(i&&(t=e[i])!=null)return t.call(e);if(r&&(t=e[r])!=null)return new Ml(t.call(e));i="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function Ml(e){function t(i){if(Object(i)!==i)return Z.reject(new TypeError(i+" is not an object."));var r=i.done;return Z.resolve(i.value).then(function(o){return{value:o,done:r}})}return Ml=function(i){this.s=i,this.n=i.next},Ml.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(i){var r=this.s.return;return r===void 0?Z.resolve({value:i,done:!0}):t(r.apply(this.s,arguments))},throw:function(i){var r=this.s.return;return r===void 0?Z.reject(i):t(r.apply(this.s,arguments))}},new Ml(e)}let Tn=(Ft=class extends Vi{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(xe.StateChange,t,this._state)}constructor(e,t){super(),M(this,"isPlanB",void 0),M(this,"store",void 0),M(this,"statsUploader",void 0),M(this,"connection",void 0),M(this,"localTrackMap",new Map),M(this,"remoteUserMap",new Map),M(this,"localDataChannels",[]),M(this,"remoteDataChannelMap",new Map),M(this,"pendingLocalTracks",[]),M(this,"pendingRemoteTracks",[]),M(this,"pendingLocalDataChannels",[]),M(this,"pendingRemoteDataChannels",[]),M(this,"statsCollector",void 0),M(this,"shouldForwardP2PCreation",void 0),M(this,"iceFailedCount",0),M(this,"dtlsFailedCount",0),M(this,"mutex",void 0),M(this,"_state",we.Disconnected),M(this,"_pcStatsUploadType",B("NEW_ICE_RESTART")?wl.FIRST_CONNECTION:wl.OLD_FIRST_CONNECTION),M(this,"_isStartRestartIce",!1),M(this,"_restartTimer",void 0),M(this,"_isTryConnecting",!1),M(this,"_iceError",null),M(this,"_forceTurn",!1),M(this,"_isWaitPcToRePub",!1),M(this,"handleMuteLocalTrack",async(i,r,o)=>{const s=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==we.Connected)return void o(new oe(O.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const a=this.filterTobeMutedTracks(i);if(a.length===0)return void r();const c=a.find(l=>l[0]==="videoLowTrack");if(c){const l=c[1];this.store.enableInstantMuteRestore?(l.track._originMediaStreamTrack.enabled=!1,I.info("[".concat(this.store.clientId,"] P2PChannel muteLocalLowTrack without close sender because enableInstantMuteRestore is true"))):l.track._originMediaStreamTrack.stop()}this.store.enableInstantMuteRestore?I.info("[".concat(this.store.clientId,"] P2PChannel muteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.muteLocal(a.map(l=>{let[,{id:h}]=l;return h}));const d=this.createMuteMessage(a);await Xt(this,xe.RequestMuteLocal,d),r()}catch(a){o(a)}finally{s()}}),M(this,"handleUnmuteLocalTrack",async(i,r,o)=>{const s=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==we.Connected)return void o(new oe(O.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const a=this.filterTobeUnmutedTracks(i);if(a.length===0)return void r();const c=a.find(l=>l[0]==="videoLowTrack");if(c){const l=c[1];if(this.store.enableInstantMuteRestore)l.track._originMediaStreamTrack.enabled=!0,I.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalLowTrack without close sender because enableInstantMuteRestore is true"));else{if(l.track._originMediaStreamTrack.stop(),!B("DISABLE_DUAL_STREAM_USE_ENCODING")&&Mt().supportDualStreamEncoding){const h=i._mediaStreamTrack.clone();l.track._mediaStreamTrack=h,l.track._originMediaStreamTrack=h}else{const h=IC(i,Wi(this,xe.RequestLowStreamParameter));l.track._mediaStreamTrack=h,l.track._originMediaStreamTrack=h}await new Z((h,p)=>{this.handleReplaceTrack(l.track,h,p,!0)})}}this.store.enableInstantMuteRestore?I.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.unmuteLocal(a.map(l=>{let[,{id:h}]=l;return h}));const d=this.createUnmuteMessage(a);await Xt(this,xe.RequestUnmuteLocal,d),r()}catch(a){o(a)}finally{s()}}),M(this,"handleUpdateVideoEncoder",async(i,r,o,s)=>{let a;s||(a=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoEncoder"));try{const d=this.localTrackMap.get(ue.LocalVideoTrack);if(!this.connection||!d||d.track!==i||this.state!==we.Connected)return void r();const{id:l,track:h}=d;await this.connection.updateSendParameters(l,h),await this.connection.updateEncoderConfig(l,h),this.emit(xe.UpdateVideoEncoder,h),r()}catch(d){o(d)}finally{var c;(c=a)===null||c===void 0||c()}}),M(this,"handleUpdateVideoSendParameters",async(i,r,o)=>{const s=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{const a=this.localTrackMap.get(ue.LocalVideoTrack);if(!this.connection||!a||a.track!==i||this.state!==we.Connected)return void r();const{id:c,track:d}=a;await this.connection.updateSendParameters(c,d),r()}catch(a){o(a)}finally{s()}}),M(this,"handleReplaceMixingTrack",async(i,r,o,s)=>{if(!this.connection||this.state!==we.Connected)return void r();const a=gL([i]);let c;I.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(a.getTrackId(),"]")),typeof s=="boolean"&&s||(c=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(i,a),r()}catch(l){o(l)}finally{var d;(d=c)===null||d===void 0||d()}}),M(this,"handleReplaceTrack",async(i,r,o,s)=>{let a;I.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(i.getTrackId(),"]")),typeof s=="boolean"&&s||(a=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var c;const l=Array.from(this.localTrackMap.entries()).find(h=>{let[,{track:p}]=h;return i===p});if(!this.connection||!l||this.state!==we.Connected)return void r();if(await((c=this.connection)===null||c===void 0?void 0:c.replaceTrack(i,l[1].id)),this.isPlanB){const h=l[1];h.id=i._mediaStreamTrack.id,this.localTrackMap.set(l[0],h)}if(l[0]===ue.LocalVideoTrack&&!B("DISABLE_DUAL_STREAM_USE_ENCODING")&&Mt().supportDualStreamEncoding){const h=this.localTrackMap.get(ue.LocalVideoLowTrack);if(h){const p=i._mediaStreamTrack.clone();h.track._originMediaStreamTrack.stop(),h.track._mediaStreamTrack=p,h.track._originMediaStreamTrack=p,await new Z((f,m)=>{this.handleReplaceTrack(h.track,f,m,!0)})}}r()}catch(l){o(l)}finally{var d;(d=a)===null||d===void 0||d()}}),M(this,"handleGetRTCStats",i=>{i(this.statsCollector.getRTCStats())}),M(this,"handleGetLocalVideoStats",i=>{i(this.statsCollector.getLocalVideoTrackStats())}),M(this,"handleGetLocalAudioStats",i=>{i(this.statsCollector.getLocalAudioTrackStats())}),M(this,"handleGetRemoteVideoStats",i=>this.statsCollector.getRemoteVideoTrackStats(i.uid)[i.uid]),M(this,"handleGetRemoteAudioStats",i=>this.statsCollector.getRemoteAudioTrackStats(i.uid)[i.uid]),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new c2(this.store),this.bindStatsUploaderEvents(),this.mutex=new jr("P2PChannel-mutex",this.store.clientId),this.isPlanB=!Mt().supportUnifiedPlan||B("CHROME_FORCE_PLAN_B")&&ha(),this.shouldForwardP2PCreation=B("FORWARD_P2P_CREATION")&&Mt().supportPCSetConfiguration&&Ud(),this.shouldForwardP2PCreation&&(this.connection=F_(this.store),this.emit(xe.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,t){var i;this.state=we.New,this._forceTurn=Qt(e),I.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] forceTurn: ").concat(this._forceTurn));const r=this.shouldForwardP2PCreation&&((i=this.connection)===null||i===void 0?void 0:i.peerConnectionState)==="closed";if((!this.shouldForwardP2PCreation||r||t)&&((r||t)&&this.connection&&(I.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.resetConnection(this.connection)),this.connection=F_(this.store,e),this.emit(xe.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),!this.connection)throw new oe(O.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=B("NEW_ICE_RESTART")?wl.FIRST_CONNECTION:wl.OLD_FIRST_CONNECTION,this._isTryConnecting=!0,this._isStartRestartIce=!1,this._iceError=null,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e){if(!this.connection)throw new oe(O.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");if(!this.isPreallocation()||this.state!==we.Connected){this.store.peerConnectionStart();const t=await this.connection.connect(e);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=we.Connected,t}if(this.connection instanceof Mr&&this.connection.checkDtlsParameters(e.dtlsParameters.fingerprints))return I.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] dtls parameters mismatch, try next.")),H.reportApiInvoke(this.store.sessionId,{name:ct.MISMATCH_DTLS_PARAMETERS,options:[e.dtlsParameters.fingerprints],tag:bi.TRACER}).onSuccess(),void setTimeout(()=>{this.emit(xe.RequestReconnect)});await this.connection.updateRemoteConnect(e)}updateRemoteRTPCapabilities(e){const t=Array.from(this.localTrackMap.entries()).filter(o=>{var s;let[a]=o;return z(s=[ue.LocalVideoLowTrack,ue.LocalVideoTrack]).call(s,a)}),i=t.map(o=>{let[,{id:s}]=o;return s}),r=t.map(o=>{let[s]=o;return s});if(this.connection instanceof Mr||this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"){if(H.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(r),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(e)}),!z(e).call(e,this.store.codec)){const o=["vp9","vp8","h264"].find(s=>z(e).call(e,s));o&&(this.store.codec=o,I.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(o,".")))}this.connection.updateRemoteRTPCapabilities(i,e)}}async getEstablishParams(){var e;return this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"&&this.connection.peerConnectionState!=="closed"||this.connection instanceof Mr&&this.connection.peerConnectionState!=="closed"&&z(e=[we.New,we.Connected]).call(e,this.state)?this.connection.establishPromise:void 0}async publishDataChannel(e){if(!this.connection||this.state!==we.Connected){if(this.state===we.Disconnected)throw new oe(O.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return e.forEach(i=>{var r;z(r=this.pendingLocalDataChannels).call(r,i)||this.pendingLocalDataChannels.push(i)}),[]}const t=this.filterTobePublishedDataChannels(e);return t.length===0?[]:(t.forEach(i=>{const r=Date.now();this.store.publish(i.id.toString(),"datachannel",r)}),await this.connection.createDataChannels(this.store.uid,t),t.forEach(i=>{this.localDataChannels.push(i);const r=Date.now();this.store.publish(i.id+"","datachannel",void 0,r)}),e.map(i=>({streamId:i.id,ordered:i.ordered,maxRetransmits:i.maxRetransmits,metadata:i.metadata,channelId:i._originDataChannelId})))}publish(e,t,i){var r=this;return ao(function*(){const o=yield Et(r.mutex.lock("From P2PChannel.publish"));try{var s;const a=r.connection&&z(s=["disconnected","failed"]).call(s,r.connection.peerConnectionState);if(!r.connection||r.state!==we.Connected||a){if(r.state===we.Disconnected)throw new oe(O.UNEXPECTED_ERROR,"PeerConnection already disconnected.");r.throwIfTrackTypeNotMatch(e);const d=e.filter(l=>r.pendingLocalTracks.indexOf(l)===-1);return r.pendingLocalTracks=r.pendingLocalTracks.concat(d),void(a&&(r._isWaitPcToRePub=!0))}r.store.pubId=r.store.pubId+1,eo.markPublishStart(r.store.clientId,r.store.pubId);const c=r.filterTobePublishedTracks(e,t,i);if(c.length===0)return void(yield Et(r.tryToUnmuteAudio(e)));yield*vu(qT(r.doPublish(r.connection,c)))}finally{o()}})()}doPublish(e,t){var i=this;return ao(function*(){t.forEach(f=>{let{track:m,type:g}=f;const S=Date.now();i.store.publish(m.getTrackId(),g===ue.LocalAudioTrack?"audio":"video",S)}),i.bindLocalTrackEvents(t);const r=t.map(f=>{let{track:m}=f;return m}),o=yield Et(e.send(r,i.store.codec,i.store.audioCodec)),s=(yield Et(o.next())).value,a=i.createGatewayPublishMessage(t,s);let c;try{c=yield a}catch(f){throw o.throw(f),(f==null?void 0:f.code)===O.WS_ABORT&&t.forEach(m=>{let{track:g}=m;i.pendingLocalTracks.indexOf(g)===-1&&i.pendingLocalTracks.push(g)}),i.unbindLocalTrackEvents(t),f}const d=i.mapPubResToRemoteConfig(a,c,r),l=(yield Et(o.next(d))).value;if(i.state===we.Disconnected)throw new oe(O.UNEXPECTED_ERROR,"PeerConnection already disconnected.");B("ENABLE_VIDEO_SEI");const h=B("ENABLE_ENCODED_TRANSFORM"),p=B("ENABLE_AUDIO_METADATA");r.forEach(async f=>{const m=f.getRTCRtpTransceiver();if(!m||!h)return;const{interceptLocalVideoFrame:g,interceptLocalAudioFrame:S}=VT();f.trackMediaType===be.VIDEO?await g(m.sender,f):f.trackMediaType===be.AUDIO&&await S(m.sender,{metadata:p?()=>{const T=f.metadata.shift();return T&&T.value}:void 0})}),t.forEach(f=>{let{type:m}=f;i.statsCollector.addLocalStats(m)}),i.assignLocalTracks(t,l),i.statsUploader.startUploadOutboundStats(),t.forEach(f=>{let{track:m,type:g}=f;const S=Date.now();i.store.publish(m.getTrackId(),g===ue.LocalAudioTrack?"audio":"video",void 0,S)})})()}async updateVideoStreamParameter(e,t){const i=this.localTrackMap.get(t);if(!i||!this.connection)return;if(!(i.track instanceof yi))return I.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");const{track:r}=i,o=function(s,a){const c={};return s.height&&s.width&&(c.scaleResolutionDownBy=bl(s,a)),c.maxFramerate=s.framerate?qo(s.framerate):void 0,c.maxBitrate=s.bitrate?1e3*s.bitrate:void 0,c}(e,r);if(r._encoderConfig||(r._encoderConfig={}),t!==ue.LocalVideoLowTrack||!B("DISABLE_DUAL_STREAM_USE_ENCODING")&&Mt().supportDualStreamEncoding)o.scaleResolutionDownBy!=null&&(r._encoderConfig.scaleResolutionDownBy=o.scaleResolutionDownBy);else{const s=r._originMediaStreamTrack;if(!s.canvas)return I.warn("[".concat(r.getTrackId(),"] no canvas on track"));(function(a,c){const d=a.canvas;c.width&&(d.width=qo(c.width)),c.height&&(d.height=qo(c.height)),c.framerate&&(d.stopCapture&&d.stopCapture(),d.stopCapture=xv(()=>{!d.startCapture&&d.stopCapture&&d.stopCapture(),d.startCapture&&d.startCapture()},qo(c.framerate)))})(s,e)}o.maxBitrate!=null&&(r._encoderConfig.bitrateMax=o.maxBitrate/1e3),o.maxFramerate!=null&&(r._encoderConfig.frameRate&&typeof r._encoderConfig.frameRate=="object"?r._encoderConfig.frameRate.max=o.maxFramerate:r._encoderConfig.frameRate={max:o.maxFramerate}),I.debug("[".concat(r.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(r._encoderConfig))),await this.connection.updateRtpSenderEncodings(r)}publishLowStream(e){var t=this;return ao(function*(){if(!t.connection||t.state!==we.Connected)return;const i=yield Et(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const o=t.localTrackMap.get(ue.LocalVideoTrack);if(!o)throw new oe(O.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has(ue.LocalVideoLowTrack))throw new oe(O.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));const s=[{track:t.getLowVideoTrack(o.track,e),type:ue.LocalVideoLowTrack}];if(yield*vu(qT(t.doPublish(t.connection,s))),o.track.muted||!o.track.enabled){var r;const a=(r=t.localTrackMap.get(ue.LocalVideoLowTrack))===null||r===void 0?void 0:r.id;a!==void 0&&(yield Et(t.connection.muteLocal([a])))}}finally{i()}})()}async republish(){this.pendingLocalTracks.length>0&&(I.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await yt(this,xe.RequestRePublish,this.pendingLocalTracks),this.emit(xe.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(I.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await yt(this,xe.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[]),this._isWaitPcToRePub=!1}async reSubscribe(e){for(let t=this.pendingRemoteTracks.length-1;t>=0;t--){const{user:i,kind:r}=this.pendingRemoteTracks[t];(r!==be.AUDIO||i._audio_added_&&i._audioSSRC)&&(r!==be.VIDEO||i._video_added_&&i._videoSSRC)||this.pendingRemoteTracks.splice(t,1)}if(e)await yt(this,xe.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:t,kind:i}of this.pendingRemoteTracks)await this.subscribe(t,i,i===be.VIDEO?t._videoSSRC:t._audioSSRC);this.pendingRemoteTracks.forEach(t=>{let{user:i}=t;this.emit(xe.MediaReconnectEnd,i.uid)}),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==we.Connected)return void e.forEach(r=>{const o=this.pendingLocalTracks.indexOf(r);o!==-1&&this.pendingLocalTracks.splice(o,1)});const t=this.filterTobeUnpublishedTracks(e);if(t.length===0)return;const i=t.find(r=>r[0]==="videoLowTrack");return i&&i[1].track.close(),this.doUnpublish(this.connection,t)}async unpublishDataChannel(e){if(!this.connection||this.state!==we.Connected)return void e.forEach(i=>{const r=this.pendingLocalDataChannels.indexOf(i);r!==-1&&this.pendingLocalDataChannels.splice(r,1)});const t=this.filterTobeUnpublishedDataChannels(e);return t.length!==0?(t.forEach(i=>{const r=this.localDataChannels.indexOf(i);r!==-1&&this.localDataChannels.splice(r,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),t.map(i=>i.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==we.Connected)return;const e=this.localTrackMap.get(ue.LocalVideoLowTrack);if(!e)return;e.track.close();const t=[[ue.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){const i=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map(r=>{let[,{id:o}]=r;return o})),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map(r=>{let[o,{track:s}]=r;return{type:o,track:s}})),t.forEach(r=>{let[o]=r;this.statsCollector.removeLocalStats(o)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),i}async subscribeDataChannel(e,t){if(!this.connection||this.state!==we.Connected)throw new oe(O.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const i=t.filter(r=>{var o;return!((o=this.remoteDataChannelMap.get(e))!==null&&o!==void 0&&o.get(r.id))});if(i.length!==0)return await this.connection.createDataChannels(e.uid,i),i.forEach(r=>{var o;this.remoteDataChannelMap.has(e)?(o=this.remoteDataChannelMap.get(e))===null||o===void 0||o.set(r.id,r):this.remoteDataChannelMap.set(e,new Map([[r.id,r]]));const s=this.pendingRemoteDataChannels.findIndex(a=>{let{user:c,id:d}=a;return c.uid===e.uid&&d===r.id});s!==-1&&this.pendingRemoteDataChannels.splice(s,1)}),i.map(r=>r.id)}async subscribe(e,t,i,r,o){var s;if(!this.connection||this.state!==we.Connected)throw new oe(O.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((s=this.remoteUserMap.get(e))!==null&&s!==void 0&&s.has(t))return;let a,c,d,l;const h=this.connection.getPreMedia(i);if(h)I.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] preSSRCMap has ssrcId: ").concat(i,", no need to send sub to gateway.")),d=h.transceiver,a=h.track,c=h.mid,l=h.player,h.firstVideoRender&&this.store.firstVideoFrameDecoded(e.uid,{firstPreRender:h.firstVideoRender});else if(o){const m=o.find(S=>{let{stream_type:T}=S;return T===t});if(!m)throw new oe(O.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(t," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(t,"."));const g=await this.connection.receive(t,m.ssrcs,String(e._uintid),m.attributes);(this.connection instanceof Mr||"name"in this.connection&&this.connection.name==="DataChannelConnection")&&(d=g.transceiver),a=g.track,c=g.id}else{const m=await this.connection.receive(t,[{ssrcId:i,rtx:r}],String(e._uintid),void 0);(this.connection instanceof Mr||"name"in this.connection&&this.connection.name==="DataChannelConnection")&&(d=m.transceiver),a=m.track,c=m.id}if(t===be.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(a):(e._audioTrack=new Eo(a,e.uid,e._uintid,this.store),I.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),d&&e._audioTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(a):(e._videoTrack=new Wd(a,e.uid,e._uintid,this.store,l),I.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId())),e._videoTrack.once(Ho.PLAY_START,()=>{this.store.firstVideoFrameDecoded(e.uid,{playStart:Date.now()})}),e._videoTrack.once(Ho.PLAY_END,()=>{this.store.firstVideoFrameDecoded(e.uid,{playEnd:Date.now()}),this.reportVideoFirstFrameRender(e)}),l?e._videoTrack.once(Ho.FIRST_FRAME_RENDER,()=>{this.store.firstVideoFrameDecoded(e.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(e)}):e._videoTrack.once(Ho.FIRST_FRAME_DECODED,()=>{this.store.firstVideoFrameDecoded(e.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(e)})),d&&e._videoTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(e,e._videoTrack)),d&&B("ENABLE_ENCODED_TRANSFORM")){const{interceptRemoteVideoFrame:m,interceptRemoteAudioFrame:g}=VT();t==be.VIDEO?await m(d.receiver,{onSei:B("ENABLE_VIDEO_SEI")&&(S=>{var T;return(T=e._videoTrack)===null||T===void 0?void 0:T._onSei(S)}),onFirstFrame:S=>{var T;const C=Array.from(ai(T=this.remoteUserMap).call(T)).find(b=>b._videoSSRC===S.ssrc);C&&this.store.firstVideoFrameDecoded(C.uid,{firstReceivedEncodedFrame:Date.now(),frameType:S.type,rtpTimestamp:S.rtpTimestamp,framePayloadType:S.payloadType,frameDataLength:S.length,mimeType:S.mimeType})}}):t==be.AUDIO&&await g(d.receiver,{enableTopn:!!B("ENABLE_AUDIO_TOPN"),enableMetadata:!!B("ENABLE_AUDIO_METADATA"),enablePts:!!B("ENABLE_AUDIO_PTS"),onMetadata:S=>{this.safeEmit(xe.AudioMetadata,S)},onPts:S=>{this.safeEmit(xe.AudioPts,S)}})}const p=this.remoteUserMap.get(e);p?p.set(t,c):this.remoteUserMap.set(e,new Map([[t,c]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats();const f=this.pendingRemoteTracks.findIndex(m=>{let{user:g,kind:S}=m;return g.uid===e.uid&&t===S});f!==-1&&(this.pendingRemoteTracks.splice(f,1),this.emit(xe.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==we.Connected)throw new oe(O.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter(o=>{var s;let{user:a,mediaType:c}=o;return!((s=this.remoteUserMap.get(a))!==null&&s!==void 0&&s.has(c))});const t=[],i=new Map;e.forEach(o=>{if(!this.connection)return;const s=this.connection.getPreMedia(o.ssrcId);if(s){const{track:a,mid:c,transceiver:d,player:l}=s;i.set(o.ssrcId,{track:a,id:c,transceiver:d,player:l})}else t.push(o)});const r=await this.connection.batchReceive(t.map(o=>{let{user:s,mediaType:a,ssrcId:c,rtxSsrcId:d}=o;return{kind:a,ssrcMsg:[{ssrcId:c,rtx:d}],mslabel:String(s._uintid)}}));t.forEach((o,s)=>{i.set(o.ssrcId,r[s])});for(const{user:o,mediaType:s,ssrcId:a}of e){const c=i.get(a);if(!c)return void I.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] cannot find ").concat(o.uid," subscribe data,").concat(s,", ").concat(a));const{track:d,id:l,transceiver:h,player:p}=c;if(h&&B("ENABLE_ENCODED_TRANSFORM")){const{interceptRemoteVideoFrame:g,interceptRemoteAudioFrame:S}=VT();s==be.VIDEO?await g(h.receiver,{onSei:B("ENABLE_VIDEO_SEI")&&(T=>{var C;return(C=o._videoTrack)===null||C===void 0?void 0:C._onSei(T)}),onFirstFrame:T=>{var C;const b=Array.from(ai(C=this.remoteUserMap).call(C)).find(D=>D._videoSSRC===T.ssrc);b&&this.store.firstVideoFrameDecoded(b.uid,{firstReceivedEncodedFrame:Date.now(),frameType:T.type,rtpTimestamp:T.rtpTimestamp,framePayloadType:T.payloadType,frameDataLength:T.length,mimeType:T.mimeType})}}):s==be.AUDIO&&await S(h.receiver,{enableTopn:!!B("ENABLE_AUDIO_TOPN"),enableMetadata:!!B("ENABLE_AUDIO_METADATA"),enablePts:!!B("ENABLE_AUDIO_PTS"),onMetadata:T=>{this.safeEmit(xe.AudioMetadata,T)},onPts:T=>{this.safeEmit(xe.AudioPts,T)}})}if(s===be.AUDIO?(o._audioTrack?o._audioTrack._updateOriginMediaStreamTrack(d):(o._audioTrack=new Eo(d,o.uid,o._uintid,this.store),I.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(o._audioTrack.getTrackId()))),h&&o._audioTrack._updateRtpTransceiver(h),this.bindRemoteTrackEvents(o,o._audioTrack)):(o._videoTrack?o._videoTrack._updateOriginMediaStreamTrack(d):(o._videoTrack=new Wd(d,o.uid,o._uintid,this.store,p),I.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(o._videoTrack.getTrackId()))),h&&o._videoTrack._updateRtpTransceiver(h),this.bindRemoteTrackEvents(o,o._videoTrack)),B("ENABLE_VIDEO_SEI")&&h){const{interceptRemoteVideoFrame:g,interceptRemoteAudioFrame:S}=VT();s==be.VIDEO?await g(h.receiver,{onSei:T=>{var C;(C=o._videoTrack)===null||C===void 0||C._onSei(T)},onFirstFrame:T=>{var C;const b=Array.from(ai(C=this.remoteUserMap).call(C)).find(D=>D._videoSSRC===T.ssrc);b&&this.store.firstVideoFrameDecoded(b.uid,{firstReceivedEncodedFrame:Date.now(),frameType:T.type,rtpTimestamp:T.rtpTimestamp,framePayloadType:T.payloadType,frameDataLength:T.length,mimeType:T.mimeType})}}):s==be.AUDIO&&await S(h.receiver)}const f=this.remoteUserMap.get(o);f?f.set(s,l):this.remoteUserMap.set(o,new Map([[s,l]])),this.statsCollector.addRemoteStats(o.uid),this.statsUploader.startUploadInboundStats();const m=this.pendingRemoteTracks.findIndex(g=>{let{user:S,kind:T}=g;return S.uid===o.uid&&s===T});m!==-1&&(this.pendingRemoteTracks.splice(m,1),this.emit(xe.MediaReconnectEnd,o.uid))}}async unsubscribe(e,t,i){const r=this.pendingRemoteTracks.filter(a=>{let{user:c,kind:d}=a;return t!==void 0?c.uid===e.uid&&t===d:c.uid===e.uid});if(r.forEach(a=>{const c=this.pendingRemoteTracks.indexOf(a);this.pendingRemoteTracks.splice(c,1)}),this.connection&&this.state===we.Connected||i||r.forEach(a=>{let{kind:c}=a;var d;if(c===be.AUDIO)(d=e._audioTrack)===null||d===void 0||d._destroy(),e._audioTrack=void 0;else if(c===be.VIDEO){var l;(l=e._videoTrack)===null||l===void 0||l._destroy(),e._videoTrack=void 0}}),!this.connection||this.state!==we.Connected)return;const o=this.filterTobeUnSubscribedTracks(e,t);if(o.length===0)return;await this.connection.stopReceiving(o.map(a=>{let[,{id:c}]=a;return c}));const s=this.createUnsubscribeMessage(o);return this.withdrawRemoteTracks(o),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),o.forEach(a=>{let[c,{kind:d}]=a;var l,h;if(d===be.VIDEO&&c._videoSSRC&&((l=this.connection)===null||l===void 0||l.setStatsRemoteVideoIsReady(c._videoSSRC,!1)),d===be.VIDEO)this.unbindRemoteTrackEvents(c._videoTrack),i||((h=c._videoTrack)===null||h===void 0||h._destroy(),c._videoTrack=void 0);else if(d===be.AUDIO){var p;this.unbindRemoteTrackEvents(c._audioTrack),!i&&((p=c._audioTrack)===null||p===void 0||p._destroy(),c._audioTrack=void 0)}}),s}async unsubscribeDataChannel(e,t){if(t.forEach(o=>{const s=this.pendingRemoteDataChannels.findIndex(a=>a.id===o.id);s!==-1&&this.pendingRemoteDataChannels.splice(s,1)}),!this.connection)return;const i=this.filterTobeUnSubscribedDataChannels(e,t);if(i.length===0)return;t.forEach(o=>{o._close()});const r=this.remoteDataChannelMap.get(e);return i.forEach(o=>{r&&r.delete(o.id)}),r&&r.size===0&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),i.map(o=>o.id)}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(const{user:o,mediaType:s}of e){const a=this.pendingRemoteTracks.filter(c=>{let{user:d,kind:l}=c;return s!==void 0?d.uid===o.uid&&s===l:d.uid===o.uid});a.forEach(c=>{const d=this.pendingRemoteTracks.indexOf(c);this.pendingRemoteTracks.splice(d,1)}),t=t.concat(a)}if(!this.connection||this.state!==we.Connected)return void t.forEach(o=>{let{user:s,kind:a}=o;var c;if(a===be.AUDIO)(c=s._audioTrack)===null||c===void 0||c._destroy(),s._audioTrack=void 0;else if(a===be.VIDEO){var d;(d=s._videoTrack)===null||d===void 0||d._destroy(),s._videoTrack=void 0}});const i=un(e).call(e,(o,s)=>{let{user:a,mediaType:c}=s;const d=this.filterTobeUnSubscribedTracks(a,c);return o.concat(d)},[]);if(i.length===0)return;await this.connection.stopReceiving(i.map(o=>{let[,{id:s}]=o;return s}));const r=this.createUnsubscribeAllMessage(i);return this.withdrawRemoteTracks(i),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),i.forEach(o=>{let[s,{kind:a}]=o;var c,d;if(a===be.VIDEO&&s._videoSSRC&&((c=this.connection)===null||c===void 0||c.setStatsRemoteVideoIsReady(s._videoSSRC,!1)),a===be.VIDEO)this.unbindRemoteTrackEvents(s._videoTrack),(d=s._videoTrack)===null||d===void 0||d._destroy(),s._videoTrack=void 0;else if(a===be.AUDIO){var l;this.unbindRemoteTrackEvents(s._audioTrack),(l=s._audioTrack)===null||l===void 0||l._destroy(),s._audioTrack=void 0}}),r}isPreSubScribe(e){return!this.connection||this.state!==we.Connected?!1:!!this.connection.getPreMedia(e)}async muteRemote(e,t){if(!this.connection)return;const i=this.remoteUserMap.get(e);if(!i)return void I.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!i.get(t))return void I.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const r=t===be.VIDEO?e._videoSSRC:e._audioSSRC;r!==void 0&&this.connection.setStatsRemoteVideoIsReady(r,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.connection)return;const i=this.remoteUserMap.get(e);if(!i)return void I.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."));i.get(t)||I.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}addAudioMetadata(e){const t=this.localTrackMap.get(ue.LocalAudioTrack),i=t&&t.track;i&&i.metadata.push(e)}getAllTracks(e){const t=this.localTrackMap.get(ue.LocalAudioTrack);if((t==null?void 0:t.track)instanceof nn){const i=t.track;return Array.from(this.localTrackMap.entries()).filter(r=>{let[o]=r;return o!==ue.LocalAudioTrack}).filter(r=>{let[o]=r;return!(e&&o===ue.LocalVideoLowTrack)}).map(r=>{let[,{track:o}]=r;return o}).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter(i=>{let[r]=i;return!(e&&r===ue.LocalVideoLowTrack)}).map(i=>{let[,{track:r}]=i;return r})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,t,i,r,o){if(e){const a=this.localTrackMap.get(ue.LocalAudioTrack),c=r?this.localTrackMap.get(ue.LocalVideoLowTrack):this.localTrackMap.get(ue.LocalVideoTrack);H.publish(this.store.sessionId,{eventElapse:eo.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:a==null?void 0:a.track.getTrackLabel(),videoName:c==null?void 0:c.track.getTrackLabel(),screenshare:(c==null?void 0:c.track._hints.indexOf(ui.SCREEN_TRACK))!==-1,audio:!!a,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}else{var s;i||(i=[]);const a=i.find(d=>d instanceof Zi),c=r?(s=this.localTrackMap.get(ue.LocalVideoTrack))===null||s===void 0?void 0:s.track:i.find(d=>d instanceof yi);H.publish(this.store.sessionId,{eventElapse:eo.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:a==null?void 0:a.getTrackLabel(),videoName:c==null?void 0:c.getTrackLabel(),screenshare:(c==null?void 0:c._hints.indexOf(ui.SCREEN_TRACK))!==-1,audio:!!a,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}}reportSubscribeEvent(e,t,i,r){const o=r===be.VIDEO?i._videoSSRC:i._audioSSRC;o&&H.subscribe(this.store.sessionId,{succ:e,ec:t,video:r===be.VIDEO,audio:r===be.AUDIO,peerid:i.uid,subscribeRequestid:o,p2pid:this.store.p2pId,eventElapse:eo.measureFromSubscribeStart(this.store.clientId,o),preSsrc:this.isPreSubScribe(o)})}reset(){I.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new jr("P2PChannel-mutex",this.store.clientId),this.connection&&(this.resetConnection(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=F_(this.store),this.emit(xe.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.statsUploader.stopUploadBaseStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(ue.LocalAudioTrack);if((e==null?void 0:e.track)instanceof nn){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach(i=>{t.removeAudioTrack(i)})}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=we.Disconnected}getStats(){var e;return(e=this.connection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return((t=this.connection)===null||t===void 0?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(ue.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(ue.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof yi||t&&t.track instanceof Zi?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){var t;const i=Array.from(ai(t=this.remoteUserMap).call(t)).find(r=>r.uid===e);return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map(i=>{let[r]=i;return{uid:r.uid,level:r.audioTrack?100*r.audioTrack._source.getAccurateVolumeLevel():0}});const t=this.localTrackMap.get(ue.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=Ka(e).call(e,(i,r)=>i.level-r.level),e}async disconnectForReconnect(){this.connection&&(I.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=we.Reconnecting,B("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t]=e;var i;t._videoTrack&&t._videoTrack._player&&((i=t._videoTrack._player.getVideoElement())===null||i===void 0||i.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())}),this.resetConnection(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=F_(this.store),this.emit(xe.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(e=>{var t;let[i,{track:r}]=e;switch(i){case ue.LocalVideoTrack:z(t=r._hints).call(t,ui.LOW_STREAM)?r.close():this.pendingLocalTracks.push(r);break;case ue.LocalAudioTrack:r instanceof nn?this.pendingLocalTracks=this.pendingLocalTracks.concat(r.trackList):this.pendingLocalTracks.push(r);case ue.LocalVideoLowTrack:}}),this.emit(xe.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,i]=e;Array.from(ai(i).call(i)).forEach(r=>{this.setPendingRemoteMedia(t,r)}),this.emit(xe.MediaReconnectStart,t.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(e=>{this.pendingLocalDataChannels.push(e)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(e=>{let[t,i]=e;Array.from(ai(i).call(i)).forEach(r=>{this.setPendingRemoteDataChannel(t,r)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),I.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,t){for(const i of this.pendingRemoteDataChannels){const{user:r,id:o}=i;if((e instanceof ju?e.uid:e)===r.uid&&o===t)return!0}return!1}setPendingRemoteDataChannel(e,t){this.hasPendingRemoteDataChannel(e,t)||this.pendingRemoteDataChannels.push({user:e,id:t})}hasPendingRemoteMedia(e,t){for(const i of this.pendingRemoteTracks){const{user:r,kind:o}=i;if((e instanceof ju?e.uid:e)===r.uid&&t===o)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(e){var t=this;return ao(function*(){if(!t.connection||t.state!==we.Connected)return;const i=yield Et(t.mutex.lock("From P2PChannel.restartICE"));let r;try{r=yield Et(t.connection.restartICE(e));const s=yield Et(r.next());if(s.done)return;const a=s.value,c=yield a;switch(YT(t.connection)&&t.reportPCStats(Date.now(),!1,t._pcStatsUploadType),e){case Ir.UDP_TCP_RELAY:t._pcStatsUploadType=wl.UDP_TCP_RESTART;break;case Ir.TCP_RELAY:t._pcStatsUploadType=wl.TCP_RESTART;break;case Ir.RELAY:t._pcStatsUploadType=wl.RELAY_RESTART;break;default:t._pcStatsUploadType=wl.OLD_RESTART}t._isTryConnecting=!0,r.next(c)}catch(s){var o;(o=r)===null||o===void 0||o.throw(s)}finally{i()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),t=this.localTrackMap.get(ue.LocalVideoTrack),i=this.localTrackMap.get(ue.LocalAudioTrack),r=e.videoSend.find(m=>m.ssrc===(t==null?void 0:t.ssrcs[0].ssrcId)),o=e.audioSend.find(m=>m.ssrc===(i==null?void 0:i.ssrcs[0].ssrcId));if(!r||!o)return 1;const s=co(this,xe.NeedSignalRTT),a=r?r.rttMs:void 0,c=o?o.rttMs:void 0,d=a&&c?(a+c)/2:a||c,l=(d&&s?(d+s)/2:d||s)||0,h=100*e.sendPacketLossRate*.7/50+.3*l/1500,p=h<.17?1:h<.36?2:h<.59?3:h<.1?4:5,f=t==null?void 0:t.track;if(f&&f._encoderConfig&&f._hints.indexOf(ui.SCREEN_TRACK)===-1){const m=f._encoderConfig.bitrateMax,g=e.bitrate.actualEncoded;if(m&&g){const S=(1e3*m-g)/(1e3*m);return Vh[S<.15?0:S<.3?1:S<.45?2:S<.6?3:4][p]}}return p}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach(i=>{let[r]=i;const o=r._audioSSRC,s=r._videoSSRC,a=e.audioRecv.find(g=>g.ssrc===o),c=e.videoRecv.find(g=>g.ssrc===s);if(!a&&!c)return void(t+=1);const d=co(this,xe.NeedSignalRTT),l=e.rtt,h=(l&&d?(l+d)/2:l||d)||0,p=a?a.jitterMs:void 0,f=e.recvPacketLossRate;let m=.7*f*100/50+.3*h/1500;p&&(m=.6*f*100/50+.2*h/1500+.2*p/400),t+=m<.1?1:m<.17?2:m<.36?3:m<.59?4:5}),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new Z((t,i)=>{this.handleMuteLocalTrack(e,t,i)})}async replaceTrack(e,t){var i;if(I.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(e.getTrackId(),"] to [").concat(t.getTrackId(),"]")),!this.connection||this.state!==we.Connected)return;const r=Array.from(this.localTrackMap.entries()).find(s=>{let[,{track:a}]=s;return e===a});if(!r)return;const o=r[0];if(e!==t&&(this.unbindLocalTrackEvents([{track:e,type:o}]),this.bindLocalTrackEvents([{track:t,type:o}]),r[1].track=t),await((i=this.connection)===null||i===void 0?void 0:i.replaceTrack(t,r[1].id)),this.isPlanB){const s=r[1];s.id=t._mediaStreamTrack.id,this.localTrackMap.set(o,s)}if(o===ue.LocalVideoTrack&&!B("DISABLE_DUAL_STREAM_USE_ENCODING")&&Mt().supportDualStreamEncoding){const s=this.localTrackMap.get(ue.LocalVideoLowTrack);if(s){const a=e._mediaStreamTrack.clone();s.track._originMediaStreamTrack.stop(),s.track._mediaStreamTrack=a,s.track._originMediaStreamTrack=a,await new Z((c,d)=>{this.handleReplaceTrack(s.track,c,d,!0)})}}}filterTobePublishedTracks(e,t,i){const r=[],o=this.getAllTracks();e=Au(e=e.filter(d=>o.indexOf(d)===-1));let s,a=!1;const c=this.localTrackMap.get(ue.LocalAudioTrack);for(const d of e){if(d instanceof yi&&(this.localTrackMap.has(ue.LocalVideoTrack)||a?new oe(O.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(r.push({track:d,type:ue.LocalVideoTrack}),a=!0),t)){const l=this.getLowVideoTrack(d,i);r.push({track:l,type:ue.LocalVideoLowTrack})}if(d instanceof Zi)if(c){const l=c.track;if(l instanceof nn)HT([d]),l.addAudioTrack(d),this.bindLocalAudioTrackEvents(d,!0);else{const h=gL([l,d]);I.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(h.getTrackId(),"]")),this.replaceTrack(l,h)}}else s instanceof nn?(HT([d]),s.addAudioTrack(d)):s||!d._useAudioElement&&Mt().webAudioMediaStreamDest&&!d._bypassWebAudio?s=gL(s?[d,s]:[d]):s=d}return s&&(I.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(s.getTrackId(),"]")),r.push({track:s,type:ue.LocalAudioTrack})),r}filterTobeUnpublishedTracks(e){const t=[],i=this.getAllTracks();e=Au(e=e.filter(r=>i.indexOf(r)!==-1));for(const r of e){if(r instanceof Zi){const o=this.localTrackMap.get(ue.LocalAudioTrack);if(!o)continue;o.track instanceof nn?(o.track.removeAudioTrack(r),this.unbindLocalAudioTrackEvents(r),o.track.trackList.length===0&&(t.push([ue.LocalAudioTrack,o]),o.track.close())):t.push([ue.LocalAudioTrack,o])}if(r instanceof yi){const o=this.localTrackMap.get(ue.LocalVideoTrack);if(!o)continue;t.push([ue.LocalVideoTrack,o]);const s=this.localTrackMap.get(ue.LocalVideoLowTrack);s&&t.push([ue.LocalVideoLowTrack,s])}}return t}filterTobePublishedDataChannels(e){return e=(e=Au(e)).filter(t=>this.localDataChannels.findIndex(i=>i.id===t.id)===-1)}filterTobeUnpublishedDataChannels(e){return e=(e=(e=Au(e)).filter(t=>this.localDataChannels.indexOf(t)!==-1)).filter(t=>t._originDataChannel)}bindLocalTrackEvents(e){e.forEach(t=>{let{track:i,type:r}=t;switch(r){case ue.LocalVideoTrack:i.addListener(Re.GET_STATS,this.handleGetLocalVideoStats),i.addListener(Re.GET_RTC_STATS,this.handleGetRTCStats),i.addListener(Re.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(Re.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(Re.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.addListener(Re.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),i.addListener(Re.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.addListener(Re.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(Re.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case ue.LocalAudioTrack:this.bindLocalAudioTrackEvents(i);case ue.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(e,t){e instanceof nn?e.trackList.forEach(i=>{i.addListener(Re.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(Re.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(Re.GET_STATS,this.handleGetLocalAudioStats),i.addListener(Re.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(Re.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.addListener(Re.GET_STATS,this.handleGetLocalAudioStats),e.addListener(Re.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(Re.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(Re.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(Re.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||(e.addListener(Re.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.addListener(Re.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map(t=>{let[i,{track:r}]=t;return{track:r,type:i}})),e.forEach(t=>{let{track:i,type:r}=t;switch(r){case ue.LocalVideoTrack:i.off(Re.GET_STATS,this.handleGetLocalVideoStats),i.off(Re.GET_RTC_STATS,this.handleGetRTCStats),i.off(Re.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.off(Re.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.off(Re.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.off(Re.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),i.off(Re.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.off(Re.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.off(Re.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case ue.LocalAudioTrack:this.unbindLocalAudioTrackEvents(i);case ue.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(e){e instanceof nn?e.trackList.forEach(t=>{t.off(Re.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Re.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Re.GET_STATS,this.handleGetLocalAudioStats),t.off(Re.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Re.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.off(Re.GET_STATS,this.handleGetLocalAudioStats),e.off(Re.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Re.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Re.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(Re.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),e.off(Re.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Re.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof Wd&&t.addListener(Re.GET_STATS,i=>{i(this.handleGetRemoteVideoStats(e))}),t instanceof Eo&&t.addListener(Re.GET_STATS,i=>{i(this.handleGetRemoteAudioStats(e))})}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(Re.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,i]=e;i.has(be.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(be.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)})}createGatewayPublishMessage(e,t){return e.map((i,r)=>{var o;let s,a,{track:c,type:d}=i;switch(d){case ue.LocalAudioTrack:s=_t.Audio,a={dtx:c instanceof hT&&c._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case ue.LocalVideoTrack:s=z(o=c._hints).call(o,ui.SCREEN_TRACK)?_t.Screen:_t.High,a=Qd(Qd({},OT(c)),{},{codec:this.store.codec,svc_mode:om()});break;case ue.LocalVideoLowTrack:s=_t.Low,a=Qd(Qd({},OT(c)),{},{codec:this.store.codec,svc_mode:om()})}return{stream_type:s,attributes:a,ssrcs:t[r]}})}createGatewayUnpublishMessage(e){return e.map(t=>{var i;let r,[o,{track:s,ssrcs:a,id:c}]=t;switch(o){case ue.LocalVideoTrack:r=z(i=s._hints).call(i,ui.SCREEN_TRACK)?_t.Screen:_t.High;break;case ue.LocalAudioTrack:r=_t.Audio;break;case ue.LocalVideoLowTrack:r=_t.Low}return{stream_type:r,ssrcs:a,mid:c}})}assignLocalTracks(e,t){e.forEach((i,r)=>{let{track:o,type:s}=i;this.localTrackMap.set(s,{track:o,id:t[r].id,ssrcs:t[r].localSSRC})})}withdrawLocalTracks(e){e.forEach(t=>{let[i]=t;this.localTrackMap.delete(i)})}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{if(I.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(t,")")),this.emit(xe.PeerConnectionStateChange,t),t==="connecting"&&e instanceof Mr&&!Ht()&&B("FIRST_TCP_CANDIDATE")&&window.setTimeout(()=>{t==="connecting"&&e.extendCandidate()},B("FIRST_TCP_CANDIDATE_INTERVAL")),t!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),t==="connected"&&(this._restartTimer&&(window.clearTimeout(this._restartTimer),this._restartTimer=void 0),e instanceof Mr&&RL(e,!0),this._isTryConnecting&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isTryConnecting=!1,this._isStartRestartIce=!1,this._pcStatsUploadType=wl.DISCONNECTED_OR_FAILED,co(this,xe.QueryClientConnectionState)==="CONNECTED"&&this._isWaitPcToRePub)){const i=this.pendingLocalTracks.map(o=>o.getTrackId()),r=this.pendingLocalDataChannels.map(o=>"dc_".concat(o.id));H.reportApiInvoke(this.store.sessionId,{name:ct.REPUB_AFTER_PC_CONNECTED,options:i.concat(r),tag:bi.TRACER}).onSuccess(),this.republish()}if(B("NEW_ICE_RESTART")&&e instanceof Mr&&!Ht()&&!this._forceTurn&&!this.store.useDcSignal){if(z(Se).call(Se,t)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const i=o=>{YT(e)&&(I.debug("[".concat(this.store.clientId,"] [P2PChannel] try to restartICE, type is ").concat(o)),co(this,xe.QueryClientConnectionState)==="CONNECTED"&&this.emit(xe.RequestRestartICE,o))},r=()=>{YT(e)&&(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),I.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(xe.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())};return void(this._restartTimer=window.setTimeout(()=>{Vt(e,i,r)},800))}}else{if(t==="disconnected"&&e.iceConnectionState==="disconnected")return setTimeout(()=>{e.iceConnectionState==="disconnected"&&B("ICE_RESTART")&&co(this,xe.QueryClientConnectionState)==="CONNECTED"&&this.emit(xe.RequestRestartICE)},800),void setTimeout(()=>{e.peerConnectionState==="disconnected"&&(I.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isTryConnecting=!1,setTimeout(()=>this.emit(xe.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);t==="failed"&&(I.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),setTimeout(()=>this.emit(xe.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=t=>{t!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),I.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),H.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:bi.TRACER}).onSuccess(),this.emit(xe.IceConnectionStateChange,t)},e.onICETransportStateChange=t=>{I.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},e.onDTLSTransportStateChange=t=>{I.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},e.onDTLSTransportError=t=>{I.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},e.onFirstAudioDecoded=t=>{var i;const r=Array.from(ai(i=this.remoteUserMap).call(i)).find(s=>s._audioSSRC===t);var o;r&&(this.store.subscribe(r.uid,"audio",void 0,void 0,void 0,Date.now()),(o=r.audioTrack)===null||o===void 0||o.emit(Ho.FIRST_FRAME_DECODED),H.firstRemoteFrame(this.store.sessionId,Dt.FIRST_AUDIO_DECODE,Xi.FIRST_AUDIO_DECODE,{peer:r._uintid,subscribeElapse:eo.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=t=>{var i;const r=Array.from(ai(i=this.remoteUserMap).call(i)).find(o=>o._audioSSRC===t);r&&H.firstRemoteFrame(this.store.sessionId,Dt.FIRST_AUDIO_RECEIVED,Xi.FIRST_AUDIO_RECEIVED,{peer:r._uintid,subscribeElapse:eo.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(t,i,r)=>{var o;const s=Array.from(ai(o=this.remoteUserMap).call(o)).find(a=>a._videoSSRC===t);s&&this.store.firstVideoFrameDecoded(s.uid,{firstDecoded:Date.now()}),this.reportVideoFirstFrameDecoded(t,i,r)},e.onFirstVideoRender=t=>{var i;const r=Array.from(ai(i=this.remoteUserMap).call(i)).find(o=>o._videoSSRC===t);r&&(this.store.firstVideoFrameDecoded(r.uid,{firstPreRender:Date.now()}),this.reportVideoFirstFrameRender(r),this.emit(xe.FirstVideoPreRender,r.uid,t))},e.onFirstVideoReceived=t=>{var i;const r=Array.from(ai(i=this.remoteUserMap).call(i)).find(o=>o._videoSSRC===t);r&&(this.store.firstVideoFrameDecoded(r.uid,{firstReceived:Date.now()}),H.firstRemoteFrame(this.store.sessionId,Dt.FIRST_VIDEO_RECEIVED,Xi.FIRST_VIDEO_RECEIVED,{peer:r._uintid,subscribeElapse:eo.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstVideoBufferReady=t=>{var i;const r=Array.from(ai(i=this.remoteUserMap).call(i)).find(o=>o._videoSSRC===t);r&&this.emit(xe.FirstVideoBufferReady,r.uid,t)},e.onSelectedLocalCandidateChanged=(t,i)=>{const r=t.candidateType==="relay",o=i.candidateType==="relay";i.candidateType!=="unknown"&&r===o||this.emit(xe.ConnectionTypeChange,r),I.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(_s(i))," -> ").concat(JSON.stringify(_s(t)),")"))},e.onSelectedRemoteCandidateChanged=(t,i)=>{I.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(_s(i))," -> ").concat(JSON.stringify(_s(t)),")"))},e.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)},e.getLocalVideoStats=()=>{const t=this.statsCollector.getLocalVideoTrackStats(),i=this.statsCollector.getRTCStats();return Qd(Qd({},t),i)},e.onICECandidateError=t=>{this._iceError=t}}fallbackConnection(){I.debug("[".concat(this.store.clientId,"] [P2PChannel] try to fallback connection")),this.state===we.Connected?(I.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&this.resetConnection(this.connection),this.shouldForwardP2PCreation&&(this.connection=F_(this.store),this.emit(xe.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)))}resetConnection(e){e instanceof Mr&&function(t){dc.delete(t.id),RL(t)}(e),e.close(),this.emit(xe.PeerConnectionStateChange,"closed"),function(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.getLocalVideoStats=void 0}(e),this._isWaitPcToRePub=!1}filterTobeMutedTracks(e){const t=[];if(this.getAllTracks().indexOf(e)===-1)return t;const i=this.localTrackMap.get(ue.LocalAudioTrack);if(e instanceof Zi&&(i==null?void 0:i.track)instanceof nn)return i.track.isActive||t.push([ue.LocalAudioTrack,i]),t;const r=Array.from(this.localTrackMap.entries()).find(o=>{let[,{track:s}]=o;return e===s});if(r&&(t.push(r),r[0]===ue.LocalVideoTrack)){const o=this.localTrackMap.get(ue.LocalVideoLowTrack);o&&t.push([ue.LocalVideoLowTrack,o])}return t}filterTobeUnmutedTracks(e){const t=[],i=this.localTrackMap.get(ue.LocalAudioTrack);if(e instanceof Zi&&(i==null?void 0:i.track)instanceof nn)return i.track.isActive&&t.push([ue.LocalAudioTrack,i]),t;const r=Array.from(this.localTrackMap.entries()).find(o=>{let[,{track:s}]=o;return e===s});if(r)if(r[0]===ue.LocalVideoTrack){t.push(r);const o=this.localTrackMap.get(ue.LocalVideoLowTrack);o&&t.push([ue.LocalVideoLowTrack,o])}else t.push(r);return t}createMuteMessage(e){return e.map(t=>{var i;let r,[o,{track:s,ssrcs:a,id:c}]=t;switch(o){case ue.LocalAudioTrack:r=_t.Audio;break;case ue.LocalVideoTrack:r=z(i=s._hints).call(i,ui.SCREEN_TRACK)?_t.Screen:_t.High;break;case ue.LocalVideoLowTrack:r=_t.Low}return{stream_type:r,ssrcs:a,mid:c}})}createUnmuteMessage(e){return e.map(t=>{var i;let r,[o,{track:s,ssrcs:a,id:c}]=t;switch(o){case ue.LocalAudioTrack:r=_t.Audio;break;case ue.LocalVideoTrack:r=z(i=s._hints).call(i,ui.SCREEN_TRACK)?_t.Screen:_t.High;break;case ue.LocalVideoLowTrack:r=_t.Low}return{stream_type:r,ssrcs:a,mid:c}})}filterTobeUnSubscribedTracks(e,t){const i=[],r=this.remoteUserMap.get(e);if(!r)return i;if(t){const o=r.get(t);if(!o)return i;i.push([e,{kind:t,id:o}])}else Array.from(r.entries()).forEach(o=>{let[s,a]=o;i.push([e,{kind:s,id:a}])});return i}filterTobeUnSubscribedDataChannels(e,t){const i=[];return t.forEach(r=>{var o;(o=this.remoteDataChannelMap.get(e))!==null&&o!==void 0&&o.has(r.id)&&i.push(r)}),i}createUnsubscribeMessage(e){const t=[];return e.forEach(i=>{let[r,{kind:o,id:s}]=i;switch(o){case be.VIDEO:return void(r._videoSSRC&&t.push({stream_type:be.VIDEO,ssrcId:r._videoSSRC}));case be.AUDIO:return void(r._audioSSRC&&t.push({stream_type:be.AUDIO,ssrcId:r._audioSSRC}))}}),t}createUnsubscribeAllMessage(e){const t=new Map;return e.forEach(i=>{let[r,{kind:o}]=i;if(t.has(r)){let s=t.get(r);o===be.VIDEO?s|=gt.Video:s|=gt.Audio,t.set(r,s)}else o===be.VIDEO?t.set(r,gt.Video):t.set(r,gt.Audio)}),{users:Array.from(t.entries()).map(i=>{let[r,o]=i;return{stream_id:r.uid,stream_type:o}})}}withdrawRemoteTracks(e){e.forEach(t=>{let[i,{kind:r}]=t;const o=this.remoteUserMap.get(i);o&&(o.delete(r),Array.from(o.entries()).length===0&&this.remoteUserMap.delete(i))})}async updateBitrateLimit(e){const t=this.localTrackMap.get(ue.LocalVideoTrack),i=this.localTrackMap.get(ue.LocalVideoLowTrack);t&&(await t.track.setBitrateLimit(e.uplink),await new Z((r,o)=>{this.handleUpdateVideoEncoder(t.track,r,o,!0)})),i&&e.low_stream_uplink&&(await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0}),await new Z((r,o)=>{this.handleUpdateVideoEncoder(i.track,r,o,!0)}))}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}isPreallocation(){return!(!this.connection||!("name"in this.connection)||this.connection.name!=="DataChannelConnection"||this.connection.peerConnectionState==="closed")||this.connection instanceof Mr&&this.connection.isPreallocation}isPreSub(){return(this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"&&this.connection.peerConnectionState!=="closed"||this.connection instanceof Mr)&&this.connection.isPreSub()}isPreRender(){return this.connection instanceof Mr&&this.connection.isPreRender}mapPubResToRemoteConfig(e,t,i){return e.map((r,o)=>{var s;let{stream_type:a}=r;const c=(s=t.find(d=>{let{stream_type:l}=d;return a===l}))===null||s===void 0?void 0:s.attributes;if(c&&B("DISABLE_SCREEN_SHARE_REMB")){const d=i[o]._hints;(z(d).call(d,ui.SCREEN_TRACK)||z(d).call(d,ui.SCREEN_LOW_TRACK))&&(c.remb=!1,I.debug("disable remb for screen share, hints:",d))}return c})}async tryToUnmuteAudio(e){for(let i=0;i<e.length;i++)if(e[i]instanceof Zi){var t;const r=this.filterTobeUnmutedTracks(e[i]);if(r.length===0)continue;await((t=this.connection)===null||t===void 0?void 0:t.unmuteLocal(r.map(s=>{let[,{id:a}]=s;return a})));const o=this.createUnmuteMessage(r);return void await Xt(this,xe.RequestUnmuteLocal,o)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!((t=this.connection)===null||t===void 0||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(xe.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(xe.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks(),this.statsUploader.requestTransportStats=()=>{var e;return{connectState:((e=this.connection)===null||e===void 0?void 0:e.peerConnectionState)||"closed"}}}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await vt(fa(this.dtlsFailedCount,yr)),this.emit(xe.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await yt(this,xe.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(xe.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(ue.LocalVideoTrack)||this.pendingLocalTracks.some(e=>e instanceof yi)}throwIfTrackTypeNotMatch(e){if(e.filter(t=>t instanceof yi).length>1)throw new oe(O.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter(t=>t instanceof Zi).length>1&&(e.some(t=>t instanceof Zi&&t._bypassWebAudio)||!Mt().webAudioMediaStreamDest))throw new oe(O.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof yi&&this.pendingLocalTracks.some(i=>i instanceof yi))throw new oe(O.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Zi&&this.pendingLocalTracks.some(i=>i instanceof Zi)&&(!Mt().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some(i=>i instanceof Zi&&i._bypassWebAudio)))throw new oe(O.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){var i;const r=!B("DISABLE_DUAL_STREAM_USE_ENCODING")&&Mt().supportDualStreamEncoding,o=Qd(Qd({},{width:160,height:120,framerate:15,bitrate:50}),t);let s;s=r?e._mediaStreamTrack.clone():IC(e,o);const a=li(8,"track-low-"),c=new yi(s,Qd(Qd({},r&&{scaleResolutionDownBy:bl(o,e)}),{},{frameRate:o.framerate,bitrateMax:o.bitrate,bitrateMin:o.bitrate}),void 0,void 0,a);return c.on(Nc.TRANSCEIVER_UPDATED,d=>{e._updateRtpTransceiver(d,Kf.LOW_STREAM)}),c._hints.push(ui.LOW_STREAM),z(i=e._hints).call(i,ui.SCREEN_TRACK)&&c._hints.push(ui.SCREEN_LOW_TRACK),e.on("sei-to-send",d=>{c.emit("sei-to-send",d)}),e.addListener(Re.NEED_CLOSE,()=>{c.close()}),c}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,t,i){let r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof Mr){var o,s,a,c;const d=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:l,dtlsTransportState:h,peerConnectionState:p}=this.connection,{local:f,remote:m}=await this.connection.getSelectedCandidatePair();H.pcStats(this.store.sessionId,{startTime:d,eventElapse:e-d||0,iceconnectionsate:l,dtlsstate:h,connectionstate:p,intSucc:t?1:2,error:this._iceError||r||"",selectedLocalCandidateProtocol:(o=f==null?void 0:f.protocol)!==null&&o!==void 0?o:"",selectedLocalCandidateType:(s=f.candidateType)!==null&&s!==void 0?s:"",selectedLocalCandidateAddress:"".concat(f.address,":").concat(f.port),selectedRemoteCandidateProtocol:(a=m.protocol)!==null&&a!==void 0?a:"",selectedRemoteCandidateType:(c=m.candidateType)!==null&&c!==void 0?c:"",selectedRemoteCandidateAddress:"".concat(m.address,":").concat(m.port),restartCnt:i,preallocation:this.connection.isPreallocation}),this._iceError=null}}reportVideoFirstFrameRender(e){const t=this.store.keyMetrics,i=t.firstVideoFrameDecoded.find(h=>h.userId===e.uid);if(!i)return;const{isInternalUpload:r,isExternalUpload:o}=i;if(r&&o)return;const{subscribeEnd:s,firstPreRender:a,peerPublishDuration:c,peerPubStatusMs:d}=i;let{firstRender:l=0}=i;if(s&&(l||a)&&c&&d){i.isInternalUpload=!0;const{playEnd:h}=i;h&&(i.isExternalUpload=!0);const{firstPreRender:p=0}=i;l=p||l;const f=e.videoTrack,m={peer:e._uintid,width:(f==null?void 0:f._videoWidth)||0,height:(f==null?void 0:f._videoHeight)||0,ssrc:e._videoSSRC||0,p2pid:this.store.p2pId,peerPublishDuration:c,peerPubStatusMs:d,joinChannelStart:t.joinStart||0,preloadStart:t.preloadStart||0,preloadEnd:t.preloadEnd||0,apStart:t.requestAPStart||0,apEnd:t.requestAPEnd||0,suaEnd:t.requestSUAEnd||0,beforeConnect:t.beforeConnect||0,peerReceiver:t.peerReceiver||0,ice:t.iceConnectionEnd||0,pc:t.peerConnectionEnd||0,signalConnected:t.signalConnected||0,joinReq:t.joinReq||0,joinRes:t.joinRep||0,userJoinNotify:i.userJoinNotify||0,videoAddNotify:i.videoAddNotify||0,subscribeStart:i.subscribeStart||0,subscribeEnd:i.subscribeEnd||0,firstReceived:i.firstReceived||0,firstDecoded:i.firstDecoded||0,firstPreRender:p||0,firstRender:h?Math.max(l,h):Math.max(l,s),playStart:i.playStart||0,playEnd:i.playEnd||0,isPreSub:!(!e._videoSSRC||!this.isPreSubScribe(e._videoSSRC)),isPrePc:this.isPreallocation(),isPreInstantVideo:KN(this.store),firstReceivedEncodedFrame:i.firstReceivedEncodedFrame||0,frameType:i.frameType||"",rtpTimestamp:i.rtpTimestamp||0,framePayloadType:i.framePayloadType||0,frameDataLength:i.frameDataLength||0,mimeType:i.mimeType||""};H.firstXLAPeerFirstVideoFrame(this.store.sessionId,m)}}reportVideoFirstFrameDecoded(e,t,i,r){var o;const s=Array.from(ai(o=this.remoteUserMap).call(o)).find(a=>a._videoSSRC===e);if(s){r||this.store.subscribe(s.uid,"video",void 0,void 0,void 0,void 0,Date.now());const a=this.store.keyMetrics,c=a.subscribe.find(d=>d.userId===s.uid&&d.type==="video");H.firstRemoteVideoDecode(this.store.sessionId,Dt.FIRST_VIDEO_DECODE,Xi.FIRST_VIDEO_DECODE,{peer:s._uintid,videowidth:t,videoheight:i,subscribeElapse:eo.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:a.requestAPEnd||0,apStart:a.requestAPStart||0,joinGwEnd:a.joinGatewayEnd||0,joinGwStart:a.joinGatewayStart||0,pcEnd:a.peerConnectionEnd||0,pcStart:a.peerConnectionStart||0,subscriberEnd:(c==null?void 0:c.subscribeEnd)||0,subscriberStart:(c==null?void 0:c.subscribeStart)||0,videoAddNotify:(c==null?void 0:c.streamAdded)||0,state:r?1:0,firstFrame:(c==null?void 0:c.firstFrame)||0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.connection)return!1;const r=this.remoteUserMap.get(e);if(!r)return!1;const o=r.get(t);if(!o)return!1;const s=await this.connection.getRemoteSSRC(o);return s!==void 0&&s!==i}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(e=>{let[t,{track:i}]=e;t===ue.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,Kf.LOW_STREAM):i._updateRtpTransceiver(void 0)})}},Ae(Ft.prototype,"startP2PConnection",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"startP2PConnection"),Ft.prototype),Ae(Ft.prototype,"connect",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"connect"),Ft.prototype),Ae(Ft.prototype,"updateRemoteRTPCapabilities",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"updateRemoteRTPCapabilities"),Ft.prototype),Ae(Ft.prototype,"publishDataChannel",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"publishDataChannel"),Ft.prototype),Ae(Ft.prototype,"unpublish",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"unpublish"),Ft.prototype),Ae(Ft.prototype,"unpublishDataChannel",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"unpublishDataChannel"),Ft.prototype),Ae(Ft.prototype,"unpublishLowStream",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"unpublishLowStream"),Ft.prototype),Ae(Ft.prototype,"subscribeDataChannel",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"subscribeDataChannel"),Ft.prototype),Ae(Ft.prototype,"subscribe",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"subscribe"),Ft.prototype),Ae(Ft.prototype,"massSubscribe",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"massSubscribe"),Ft.prototype),Ae(Ft.prototype,"unsubscribe",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"unsubscribe"),Ft.prototype),Ae(Ft.prototype,"unsubscribeDataChannel",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"unsubscribeDataChannel"),Ft.prototype),Ae(Ft.prototype,"massUnsubscribe",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"massUnsubscribe"),Ft.prototype),Ae(Ft.prototype,"muteRemote",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"muteRemote"),Ft.prototype),Ae(Ft.prototype,"unmuteRemote",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"unmuteRemote"),Ft.prototype),Ae(Ft.prototype,"hasRemoteMediaWithLock",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"hasRemoteMediaWithLock"),Ft.prototype),Ae(Ft.prototype,"disconnectForReconnect",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"disconnectForReconnect"),Ft.prototype),Ae(Ft.prototype,"updateBitrateLimit",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"updateBitrateLimit"),Ft.prototype),Ae(Ft.prototype,"remoteMediaSsrcChanged",[So],Object.getOwnPropertyDescriptor(Ft.prototype,"remoteMediaSsrcChanged"),Ft.prototype),Ft);function So(e,t,i){const r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const o=this.mutex,s=await o.lock("From P2PChannel.".concat(t));try{for(var a=arguments.length,c=new Array(a),d=0;d<a;d++)c[d]=arguments[d];return await r.apply(this,c)}finally{s()}},i}function vL(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function d2(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?vL(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):vL(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}const vz=Date.now(),CL=20,gm=new Map,XT=new Map;async function yL(e){const t=gm.get(e),i=Array.isArray(t)&&t[t.length-1],r=XT.get(e);if(!i)return void(r.isSyncing=!1);const o={uid:i.uid,payload:i.payload};r.firstRecvTs===0&&(r.firstRecvTs=i.recvTs,r.firstSendTs=i.sendTs);const s=i.sendTs-r.firstSendTs,a=s-(Date.now()-r.firstRecvTs);a>0&&(r.firstRecvTs=Date.now()-s);let c=i.mediaDelay+a;c<=0?(t.pop(),l2(i.context,o),c=0):c=Math.min(c,CL),setTimeout(()=>t.length&&yL(e),c)}function l2(e,t){e.safeEmit(At.STREAM_MESSAGE,t.uid,t.payload),e.onStreamMessage&&e.onStreamMessage(t)}function Cz(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;if(!e.syncWithAudio)return l2(i,{uid:e.uid,payload:e.payload});const r="".concat(i.id,"-").concat(e.uid),o=gm.get(r)||[],s=o.findIndex(l=>e.sendTs>=l.sendTs),a=d2(d2({},e),{},{context:i,mediaDelay:t,recvTs:Date.now()});s===-1?o.push(a):o.splice(s,0,a),gm.set(r,o);let c=!1;var d;XT.has(r)?c=!((d=XT.get(r))===null||d===void 0||!d.isSyncing):XT.set(r,{isSyncing:c,firstRecvTs:0,firstSendTs:0}),c||yL(r)}const u2=ii().name;function IL(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function B_(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?IL(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):IL(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}const Sm="websdk_ng_cache_parameter",yz=B("MAX_PRELOAD_ASYNC_LENGTH"),j_=1e4,lc=new Map,Ku=[];let JT=null,QT=0,Tm=0;const ZT=new Map,h2=new Uint8Array([241,141,127,212,103,139,200,225,251,157,127,139,143,2,22,163]),AL=function(e,t){const i=[];let r=0;const o=async()=>{const s=i.shift();s&&await s(),i.length>0&&r<t?o():r--};return async function(){for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return new Z(async(d,l)=>{i.push(async()=>{try{const h=await e(...a);d(h)}catch(h){l(h)}}),r<t&&(r++,o())})}}($T,yz),wL=hs.CancelToken.source();class bL{constructor(){M(this,"_audioContext",null)}createMuteAudioTrack(){this._audioContext=new AudioContext;const t=this._audioContext.sampleRate,i=10*t,r=this._audioContext.createBuffer(2,i,t),o=this._audioContext.createBufferSource();o.buffer=r;const s=this._audioContext.createMediaStreamDestination();return o.connect(s),o.start(),s.stream.getAudioTracks()[0]}close(){this._audioContext&&(this._audioContext.close(),this._audioContext=null)}}async function $T(e,t,i,r,o,s,a){try{if(!B("ENABLE_PRELOAD"))return;if(!Mt().supportWebCrypto)return void pa(()=>{I.warn("Your browser does not support preloading, this feature  be run in a secure environment")},"preload_webcrypto_not_supported");if(!i&&i!==null)throw new oe(O.INVALID_PARAMS,"Invalid token: ".concat(i,". If you don not use token, set it to null"));i&&Ar(i,"token",1,2047),Ar(e,"appid",1,2047),L_(t),r&&Mc(r);const c=Fd();I.debug("preload channel ".concat(t,", uid is ").concat(r));const d={appId:e,cname:t,token:i||e,uid:typeof r!="string"?r:null,sid:c,proxyServer:o,role:a};let l,h;typeof r=="string"?(d.stringUid=r,[h,l]=await Z.all([Sz(r,{sid:c,appId:e},wL.token),dL(B_(B_({},d),{},{token:i||e,uid:0}),wL.token)]),d.uid=h.uid,l.gatewayInfo.uid=d.uid,l.gatewayInfo.res.uid=d.uid):(s&&(d.stringUid=s),l=await dL(d,wL.token));const p={sid:c,appId:e,cname:t,token:i||e,uid:d.stringUid||r,intUid:d.uid||l.gatewayInfo.uid,stringUid:d.stringUid,ts:Date.now(),sua:h,ap:l};await eR(p),QT++}catch(c){throw Tm++,function(d){JT||(JT=window.setTimeout(()=>{let h="";ZT.forEach((p,f)=>{h+="".concat(f,": ").concat(p," ;")}),H.reportApiInvoke(null,{name:ct.PRELOAD,options:{success:QT,failed:Tm,err:h}}).onError(d),QT=0,Tm=0,ZT.clear(),JT=null},j_));const l=ZT.get(d.code)||0;ZT.set(d.code,l+1)}(c),c}}async function bC(e){try{if(B("AP_REQUEST_DETAIL")||B("ENABLE_ROLE_SELECT_EDGE"))return;const t=OC(e);if(!t||e.cloudProxyServer!=="disabled")return;const i=await async function(r,o){try{const s=await window.crypto.subtle.importKey("raw",kN(o),"AES-GCM",!1,["decrypt"]),a=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:h2},s,_a(r));return JSON.parse(window.atob(bu(new Uint8Array(a))))}catch{return}}(t,e.token||e.appId);if(!i||!function(r,o){return r.cname===o.cname&&r.appId===o.appId&&r.token===o.token?o.stringUid?r.stringUid===o.stringUid:typeof o.uid=="number"?r.uid===o.uid:r.uid==o.uid:!1}(i,e))return;if(i&&Date.now()-i.ts<B("AP_CACHE_LIFETIME"))return i}catch(t){I.warn("Error get preloadInfo",t.message)}}function OC(e){let t;try{if(t=tR(Sm),!t)return;const i=JSON.parse(t),r=p2(e),o=function(a,c){for(let d=a.length-1;d>=0;d--)if(c(a[d]))return d;return-1}(i,a=>r in a);if(o===-1)return;const s=i.splice(o,1)[0];return iR(Sm,JSON.stringify(i)),s[r]}catch(i){I.warn("Error delete preload info: ".concat(t),i.message),iR(Sm,"")}}async function eR(e){let t;try{e.uid&&OC({appId:e.appId,cname:e.cname,token:e.token,uid:e.uid,stringUid:e.stringUid});const i=p2(e),r=await async function(s,a){try{const c=await window.crypto.subtle.importKey("raw",kN(a),"AES-GCM",!1,["encrypt"]),d=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:h2},c,_a(window.btoa(JSON.stringify(s))));return bu(new Uint8Array(d))}catch{return}}(e,e.token||e.appId);if(!r)return;t=tR(Sm);const o=t?JSON.parse(t):[];o.push({[i]:r}),o.length>B("AP_CACHE_NUM")&&o.shift(),iR(Sm,JSON.stringify(o))}catch(i){I.warn("Error caching server parameters:",i.message),iR(Sm,"")}}function NC(e){if(e){let t=lc.get(e);t&&(window.clearTimeout(t),t=null,lc.delete(e)),z(Ku).call(Ku,e)||e.cloudProxyServer!=="disabled"||Ku.push(e)}if(lc.size<B("AP_CACHE_NUM")&&Ku.length>0){const t=Ku.shift();lc.set(t,window.setTimeout(async()=>{const{appId:i,cname:r,token:o,stringUid:s,uid:a,proxyServer:c,role:d}=t;try{await AL(i,r,o,a,c,s,d),lc.has(t)&&NC(t)}catch(l){I.warn("update preload failed",l.message),OL(t)}},B("AP_UPDATE_INTERVAL")))}}function OL(e){const t=Ku.indexOf(e);t!==-1&&Ku.splice(t,1);let i=lc.get(e);i&&(window.clearTimeout(i),i=null,lc.delete(e),NC())}function NL(e,t){const i=e.sua,r=e.ap;t&&i&&H.reqUserAccount(e.sid,{lts:i.requestTime,elapse:i.elapse,success:!0,serverAddr:i.url,stringUid:t,uid:e.intUid,errorCode:null,extend:i.req}),H.reportResourceTiming(e.ap.url,e.sid),H.joinWebProxyAP(e.sid,{lts:r.requestTime,elapse:r.elapse,sucess:1,apServerAddr:r.url,turnServerAddrList:r.proxyInfo.addresses.map(o=>o.ip).join(","),eventType:"disabled",unilbsServerIds:[kr.CHOOSE_SERVER,kr.CLOUD_PROXY_FALLBACK].toString()}),H.joinChooseServer(e.sid,{lts:r.requestTime,elapse:r.elapse,succ:!0,csAddr:r.url,opid:r.opid,serverList:r.gatewayInfo.gatewayAddrs.map(o=>o.address),ec:null,cid:r.gatewayInfo.cid.toString(),uid:r.gatewayInfo.uid.toString(),csIp:r.gatewayInfo.csIp,unilbsServerIds:[kr.CHOOSE_SERVER].toString(),isHttp3:r.isHttp3})}function tR(e){return window.atob(window.localStorage.getItem(e)||"")}function iR(e,t){window.localStorage.setItem(e,window.btoa(t))}function p2(e){let t="".concat(e.appId,"_").concat(e.cname);return typeof e.uid=="string"&&(t+="_s_".concat(e.uid)),typeof e.uid=="number"&&(t+="_".concat(e.uid)),e.token&&(t+="_".concat(e.token)),RU(t)}function Iz(e){let t=function(){const i=DL.pop();return i?(i.offset=i.limit=0,i):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(i,r){let o=i.appId;o!==void 0&&(Hr(r,10),xo(r,o));let s=i.cid;s!==void 0&&(Hr(r,16),Hr(r,s));let a=i.cname;a!==void 0&&(Hr(r,26),xo(r,a));let c=i.deviceId;c!==void 0&&(Hr(r,34),xo(r,c));let d=i.elapse;d!==void 0&&(Hr(r,40),zu(r,d));let l=i.fileSize;l!==void 0&&(Hr(r,48),zu(r,vm(l)));let h=i.height;h!==void 0&&(Hr(r,56),zu(r,vm(h)));let p=i.jpg;p!==void 0&&(Hr(r,66),Hr(r,p.length),kL(r,p));let f=i.networkType;f!==void 0&&(Hr(r,72),zu(r,vm(f)));let m=i.osType;m!==void 0&&(Hr(r,80),zu(r,vm(m)));let g=i.requestId;g!==void 0&&(Hr(r,90),xo(r,g));let S=i.sdkVersion;S!==void 0&&(Hr(r,98),xo(r,S));let T=i.sequence;T!==void 0&&(Hr(r,104),zu(r,vm(T)));let C=i.sid;C!==void 0&&(Hr(r,114),xo(r,C));let b=i.timestamp;b!==void 0&&(Hr(r,120),zu(r,b));let D=i.uid;D!==void 0&&(Hr(r,128),Hr(r,D));let x=i.vid;x!==void 0&&(Hr(r,136),Hr(r,x));let k=i.width;k!==void 0&&(Hr(r,144),zu(r,vm(k)));let V=i.service;V!==void 0&&(Hr(r,152),Hr(r,V));let W=i.callbackData;W!==void 0&&(Hr(r,162),Hr(r,W.length),kL(r,W));let K=i.ticket;K!==void 0&&(Hr(r,170),xo(r,K));let J=i.vendorConfigs;J!==void 0&&(Hr(r,178),xo(r,J))}(e,t),function(i){let r=i.bytes,o=i.limit;return r.length===o?r:r.subarray(0,o)}(t)}function Az(e){return function(i){let r={};e:for(;!DC(i);){let o=vr(i);switch(o>>>3){case 0:break e;case 1:r.code=vr(i);break;case 2:r.msg=Yu(i,vr(i));break;case 3:r.requestId=Yu(i,vr(i));break;case 4:r.timestamp=Yh(i,!1);break;default:Rm(i,7&o)}}return r}({bytes:t=e,offset:0,limit:t.length});var t}function Rm(e,t){switch(t){case 0:for(;128&uc(e););break;case 2:PL(e,vr(e));break;case 5:PL(e,4);break;case 1:PL(e,8);break;default:throw new Error("Unimplemented type: "+t)}}function vm(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let DL=[];function PL(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function DC(e){return e.offset>=e.limit}function rR(e,t){let i=e.bytes,r=e.offset,o=e.limit,s=r+t;if(s>i.length){let a=new Uint8Array(2*s);a.set(i),e.bytes=a}return e.offset=s,s>o&&(e.limit=s),r}function LL(e,t){let i=e.offset;if(i+t>e.limit)throw new Error("Read past limit");return e.offset+=t,i}function kL(e,t){let i=rR(e,t.length);e.bytes.set(t,i)}function Yu(e,t){let i=LL(e,t),r=String.fromCharCode,o=e.bytes,s="",a="";for(let c=0;c<t;c++){let d,l,h,p,f=o[c+i];128&f?(224&f)==192?c+1>=t?a+=s:(d=o[c+i+1],(192&d)!=128?a+=s:(p=(31&f)<<6|63&d,p<128?a+=s:(a+=r(p),c++))):(240&f)==224?c+2>=t?a+=s:(d=o[c+i+1],l=o[c+i+2],(49344&(d|l<<8))!=32896?a+=s:(p=(15&f)<<12|(63&d)<<6|63&l,p<2048||p>=55296&&p<=57343?a+=s:(a+=r(p),c+=2))):(248&f)==240?c+3>=t?a+=s:(d=o[c+i+1],l=o[c+i+2],h=o[c+i+3],(12632256&(d|l<<8|h<<16))!=8421504?a+=s:(p=(7&f)<<18|(63&d)<<12|(63&l)<<6|63&h,p<65536||p>1114111?a+=s:(p-=65536,a+=r(55296+(p>>10),56320+(1023&p)),c+=3))):a+=s:a+=r(f)}return a}function xo(e,t){let i=t.length,r=0;for(let a=0;a<i;a++){let c=t.charCodeAt(a);c>=55296&&c<=56319&&a+1<i&&(c=(c<<10)+t.charCodeAt(++a)-56613888),r+=c<128?1:c<2048?2:c<65536?3:4}Hr(e,r);let o=rR(e,r),s=e.bytes;for(let a=0;a<i;a++){let c=t.charCodeAt(a);c>=55296&&c<=56319&&a+1<i&&(c=(c<<10)+t.charCodeAt(++a)-56613888),c<128?s[o++]=c:(c<2048?s[o++]=c>>6&31|192:(c<65536?s[o++]=c>>12&15|224:(s[o++]=c>>18&7|240,s[o++]=c>>12&63|128),s[o++]=c>>6&63|128),s[o++]=63&c|128)}}function uc(e){return e.bytes[LL(e,1)]}function Cm(e,t){let i=rR(e,1);e.bytes[i]=t}function vr(e){let t,i=0,r=0;do t=uc(e),i<32&&(r|=(127&t)<<i),i+=7;while(128&t);return r}function Hr(e,t){for(t>>>=0;t>=128;)Cm(e,127&t|128),t>>>=7;Cm(e,t)}function Yh(e,t){let i,r=0,o=0,s=0;return i=uc(e),r=127&i,128&i&&(i=uc(e),r|=(127&i)<<7,128&i&&(i=uc(e),r|=(127&i)<<14,128&i&&(i=uc(e),r|=(127&i)<<21,128&i&&(i=uc(e),o=127&i,128&i&&(i=uc(e),o|=(127&i)<<7,128&i&&(i=uc(e),o|=(127&i)<<14,128&i&&(i=uc(e),o|=(127&i)<<21,128&i&&(i=uc(e),s=127&i,128&i&&(i=uc(e),s|=(127&i)<<7))))))))),{low:r|o<<28,high:o>>>4|s<<24,unsigned:t}}function zu(e,t){let i=t.low>>>0,r=(t.low>>>28|t.high<<4)>>>0,o=t.high>>>24,s=o===0?r===0?i<16384?i<128?1:2:i<1<<21?3:4:r<16384?r<128?5:6:r<1<<21?7:8:o<128?9:10,a=rR(e,s),c=e.bytes;switch(s){case 10:c[a+9]=o>>>7&1;case 9:c[a+8]=s!==9?128|o:127&o;case 8:c[a+7]=s!==8?r>>>21|128:r>>>21&127;case 7:c[a+6]=s!==7?r>>>14|128:r>>>14&127;case 6:c[a+5]=s!==6?r>>>7|128:r>>>7&127;case 5:c[a+4]=s!==5?128|r:127&r;case 4:c[a+3]=s!==4?i>>>21|128:i>>>21&127;case 3:c[a+2]=s!==3?i>>>14|128:i>>>14&127;case 2:c[a+1]=s!==2?i>>>7|128:i>>>7&127;case 1:c[a]=s!==1?128|i:127&i}}const ML={},nR={},PC=4294967296,wz=PC*PC,UL=wz/2;ym(0,!0);const _2=ym(0),bz=Im(0,-2147483648,!1),f2=Im(-1,2147483647,!1);function ym(e,t){let i,r,o;return t?(o=0<=(e>>>=0)&&e<256)&&(r=nR[e],r)?r:(i=Im(e,0,!0),o&&(nR[e]=i),i):(o=-128<=(e|=0)&&e<128)&&(r=ML[e],r)?r:(i=Im(e,e<0?-1:0,!1),o&&(ML[e]=i),i)}function Im(e,t,i){return{low:0|e,high:0|t,unsigned:!!i}}function xL(e,t){if(isNaN(e))return _2;{if(e<=-UL)return bz;if(e+1>=UL)return f2}return e<0?_2:Im(e%PC|0,e/PC|0,t)}function LC(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}class kC extends Vi{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const i=this._connectionState;this._connectionState=t,this.emit(Os.CONNECTION_STATE_CHANGE,t,i)}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(t){var i;super(),M(this,"name","AgoraRTCImageModeration"),M(this,"_connectionState",Yn.CONNECTING),M(this,"_sequence",0),M(this,"_moderationStartTime",void 0),M(this,"_workerConnection",void 0),M(this,"_workerMessageLengthLimit",void 0),M(this,"_qualityRatio",void 0),M(this,"_connectInfo",void 0),M(this,"_cancelTokenSource",hs.CancelToken.source()),M(this,"_retryConfig",void 0),M(this,"_moderationInterval",void 0),M(this,"_moderationTimer",null),M(this,"_moderationMode",1),M(this,"_quality",1),M(this,"_qualityTimer",null),M(this,"_ticket",void 0),M(this,"_moderationIntervalMinimum",void 0),M(this,"_uploadFailedNum",0),M(this,"_uploadNum",0),M(this,"_uploadTimer",null),M(this,"_extraInfo",void 0),M(this,"_vendor",""),M(this,"_encoder",new TextEncoder),M(this,"_moderationId",void 0),M(this,"inspectImage",()=>{if(this.connectionState!==Yn.CONNECTED)throw new $(O.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===Yn.CONNECTED?this.requestToInspectImage():I.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=li(5,"image-moderation-"),this._workerMessageLengthLimit=B("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=B("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(i=t.interval)!==null&&i!==void 0?i:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),this._qualityRatio=B("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new em("worker-"+this._moderationId,yr),this.on(Os.STATE_CHANGE,(r,o)=>{I.debug("[".concat(this._moderationId,"] Moderation operation :").concat(ar[r]," ").concat(o||""))}),this.handleWorkerEvents()}async init(t,i){this.emit(Os.STATE_CHANGE,ar.CONNECT_AP),this._connectInfo=t;const r=this._cancelTokenSource.token;return this._retryConfig=i,new Z((o,s)=>{this.on(Os.CONNECTION_STATE_CHANGE,(a,c)=>{a===Yn.CONNECTED&&o()}),this.requestAP(t,r,i).then(a=>{this.connectWorker(a)}).catch(a=>{s(a)})})}updateConfig(t){var i;this._moderationInterval=(i=t.interval)!==null&&i!==void 0?i:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),I.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(t))),this.connectionState===Yn.CONNECTED&&this.inspectImage()}async requestAP(t,i,r){const o=B("WEBCS_DOMAIN").map(d=>"https://".concat(d,"/api/v1")),s=await function(d,l,h,p){let{appId:f,areaCode:m,cname:g,sid:S,token:T,uid:C}=l;qd++;const b="moderation_plugin",D={service_name:b,json_body:JSON.stringify({appId:f,areaCode:m,cname:g,command:"allocateEdge",requestId:qd,seq:qd,sid:S,appToken:T,ts:Date.now(),uid:C+""})};let x,k,V=d[0];return ma(async()=>{x=Date.now();const W=await na(V,{data:D,cancelToken:h,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(k=Date.now()-x,W.code!==0){const Ce=new $(O.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+W.code,{retry:!0,responseTime:k});throw I.error(Ce.toString()),Ce}const K=JSON.parse(W.json_body);if(K.code!==200){const Ce=new $(O.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(K.code,", reason: ").concat(K.reason),{code:K.code,responseTime:k});throw I.error(Ce.toString()),Ce}if(!K.servers||!Array.isArray(K.servers)||K.servers.length===0){const Ce=new $(O.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:K.code,responseTime:k});throw I.error(Ce.toString()),Ce}if(!K.servers.some(Ce=>!!Ce.wss)){const Ce=new $(O.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:K.code,responseTime:k});throw I.error(Ce.toString()),Ce}const J=B("IMAGE_MODERATION_WORKER_WSS");if(J)return{addressList:[J],workerToken:K.workerToken,vid:K.vid,responseTime:k};const se=B("IMAGE_MODERATION_WORKER_HOST");return{addressList:K.servers.map(Ce=>{let{address:De,wss:Me}=Ce;if(De&&Me)return"wss://".concat(De.replace(/\./g,"-"),".").concat(se,":").concat(Me,"/moderation")}).filter(Ce=>!!Ce),workerToken:K.workerToken,vid:K.vid,ticket:K.appTicket,responseTime:k}},(W,K)=>(H.apworkerEvent(S,{success:!0,sc:200,serviceName:b,responseDetail:JSON.stringify(W.addressList),firstSuccess:K===0,responseTime:k,serverIp:d[K%d.length]}),!1),(W,K)=>(H.apworkerEvent(S,{success:!1,sc:W.data&&W.data.code||200,serviceName:b,responseTime:k,serverIp:d[K%d.length]}),!!(W.code!==O.OPERATION_ABORTED&&W.code!==O.UNEXPECTED_RESPONSE||W.data&&W.data.retry)&&(V=d[(K+1)%d.length],!0)),p)}(o,t,i,r);this.emit(Os.STATE_CHANGE,ar.AP_CONNECTED);const{addressList:a,ticket:c}=s;return this._ticket=c,a}async connectWorker(t){this.emit(Os.STATE_CHANGE,ar.CONNECT_WORKER),await this._workerConnection.init(t,1e4)}handleWorkerEvents(){this._workerConnection.on(ht.CONNECTED,async()=>{this.emit(Os.STATE_CHANGE,ar.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=Yn.CONNECTED}),this._workerConnection.on(ht.CLOSED,()=>{this.connectionState=Yn.CLOSED}),this._workerConnection.on(ht.FAILED,()=>{this.connectionState=Yn.CLOSED}),this._workerConnection.on(ht.RECONNECTING,()=>{this.connectionState=this.connectionState===Yn.CONNECTED?Yn.RECONNECTING:Yn.CONNECTING}),this._workerConnection.on(ht.ON_MESSAGE,async t=>{if(t.data instanceof ArrayBuffer){const i=Az(new Uint8Array(t.data));B("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&I.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(i)),this._uploadNum++,i.code===void 0||i.code===0||(this._uploadFailedNum++,I.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(i.code,", msg is ").concat(i.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{H.reportApiInvoke(this._connectInfo.sid||null,{name:ct.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,i.code],tag:bi.TRACER}).onError(new $(O.IMAGE_MODERATION_UPLOAD_FAILED,i.msg)),this._uploadTimer=null},B("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else I.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(ht.WILL_RECONNECT,(t,i,r)=>{t==="recover"&&r(t),r("tryNext")}),this._workerConnection.on(ht.REQUEST_NEW_URLS,(t,i)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(i)})}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){const t=co(this,Os.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void(B("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&I.debug("Only the track being played can be inspected"));this._sequence++;const r=await this.generateRequestData(t,i);this._workerConnection.sendMessage(r,!0,!0)}else B("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&I.debug("Only the track being published can be inspected")}async generateRequestData(t,i){let{appId:r,cname:o,cid:s,vid:a,sid:c,uid:d}=i;const l=Date.now(),h=await t.getCurrentFrameImage("image/jpeg",this.quality),p=await Hv(h,r,o),f=this._sequence+"-"+s+"-"+d+"-"+l+"-"+li(12,""),m={appId:r,cid:s,cname:o,deviceId:"",elapse:kC.intToLong(Number(l-this._moderationStartTime)),fileSize:h.buffer.byteLength,height:h.height,width:h.width,jpg:p,networkType:6,osType:7,requestId:f,sdkVersion:"4.24.2",sequence:this._sequence,sid:c,timestamp:xL(l),uid:d,vid:a,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete m.callbackData;const g=Iz(m);if(g.byteLength<this._workerMessageLengthLimit){if(B("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const S=function(T){for(var C=1;C<arguments.length;C++){var b=arguments[C]!=null?arguments[C]:{};C%2?LC(Object(b),!0).forEach(function(D){M(T,D,b[D])}):Object.getOwnPropertyDescriptors?Object.defineProperties(T,Object.getOwnPropertyDescriptors(b)):LC(Object(b)).forEach(function(D){Object.defineProperty(T,D,Object.getOwnPropertyDescriptor(b,D))})}return T}({},m);delete S.jpg,I.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(S))}return g}{const S=this.quality*this._qualityRatio;return this.quality=S,await this.generateRequestData(t,{appId:r,cname:o,cid:s,vid:a,sid:c,uid:d})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=hs.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=Yn.CLOSED,this.emit(Os.STATE_CHANGE,ar.CLOSED)}}function m2(e){if(Ai(e.interval,"interval",1e3,1/0),e&&e.extraInfo&&e.extraInfo.length>1024)throw new $(O.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(e&&e.vendor&&e.vendor.length>1024)throw new $(O.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}const E2={name:"ImageModeration",create:function(e){let{config:t}=e;return m2(t),new kC(t)}};var VL,FL,BL,jL,GL,WL,HL,KL,YL,zL,qL,XL,JL,QL,ZL,$L,ek,tk,ik,rk,nk,ok,sk,ak,ck,dk,lk,uk,hk,pk,_k,fk,mk,Ek,gk,Sk,Tk,Rk,vk,Ck,yk,Pe,Le;function hc(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function Wc(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?hc(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):hc(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}jr.setLogger(I);let g2=(VL=_e(),FL=_e({argsMap:(e,t)=>{if(!Array.isArray(t)){if(!(t instanceof N_))return[t];t=[t]}return t.map(i=>i?Object(i).toString():"null")}}),BL=_e({argsMap:(e,t)=>(t||(t=[]),Array.isArray(t)||t.trackMediaType!==No.DATA?(Array.isArray(t)||(t=[t]),t.map(i=>i.getTrackId())):[t.getChannelId()])}),jL=_e({argsMap:(e,t,i,r)=>[typeof t=="object"?t.uid:t,i,r]}),GL=_e({argsMap:(e,t,i)=>[t,i]}),WL=_e({argsMap:(e,t)=>t.map(i=>{let{user:r,mediaType:o}=i;return[r==null?void 0:r.uid,o]})}),HL=_e({argsMap:(e,t,i,r)=>[typeof t=="object"?t.uid:t,i,r]}),KL=_e({argsMap:(e,t)=>t.map(i=>{let{user:r,mediaType:o}=i;return{uid:r==null?void 0:r.uid,mediaType:o}})}),YL=_e(),zL=_e(),qL=_e(),XL=_e(),JL=_e(),QL=_e(),ZL=_e(),$L=_e(),ek=_e(),tk=_e(),ik=_e(),rk=_e(),nk=_e(),ok=_e(),sk=_e(),ak=_e(),ck=_e({argsMap:(e,t)=>[t]}),dk=_e(),lk=_e(),uk=_e(),hk=_e(),pk=_e(),_k=_e(),fk=_e(),mk=_e(),Ek=_e({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),gk=_e(),Sk=_e(),Tk=_e(),Rk=_e(),vk=_e(),Ck=_e(),yk=_e({reportResult:!0}),Pe=_e(),Le=class extends Vi{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return((e=this._config)===null||e===void 0?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e,t){let i;if(super(),M(this,"store",void 0),M(this,"_uid",void 0),M(this,"_channelName",void 0),M(this,"_uintUid",void 0),M(this,"_users",[]),M(this,"_config",void 0),M(this,"_clientId",void 0),M(this,"_appId",void 0),M(this,"_sessionId",null),M(this,"_key",void 0),M(this,"_rtmConfig",{}),M(this,"_joinInfo",void 0),M(this,"_gateway",void 0),M(this,"_statsCollector",void 0),M(this,"_configDistribute",void 0),M(this,"_leaveMutex",void 0),M(this,"_publishMutex",void 0),M(this,"_renewTokenMutex",void 0),M(this,"_subscribeMutex",void 0),M(this,"_encryptionMode","none"),M(this,"_encryptionSecret",null),M(this,"_encryptionSalt",null),M(this,"_encryptDataStream",!1),M(this,"_encryptDataStreamKey",null),M(this,"_encryptDataStreamIv",null),M(this,"_proxyServer",void 0),M(this,"_turnServer",{servers:[],mode:"auto"}),M(this,"_cloudProxyServerMode","disabled"),M(this,"_isDualStreamEnabled",!1),M(this,"_defaultStreamFallbackType",void 0),M(this,"_lowStreamParameter",void 0),M(this,"_streamFallbackTypeCacheMap",new Map),M(this,"_remoteStreamTypeCacheMap",new Map),M(this,"_axiosCancelSource",hs.CancelToken.source()),M(this,"_audioVolumeIndicationInterval",void 0),M(this,"_networkQualityInterval",void 0),M(this,"_userOfflineTimeout",void 0),M(this,"_streamRemovedTimeout",void 0),M(this,"_rteDetailInterval",void 0),M(this,"_liveTranscodeStreamingClient",void 0),M(this,"_liveRawStreamingClient",void 0),M(this,"_channelMediaRelayClient",void 0),M(this,"_networkQualitySensitivity","normal"),M(this,"_p2pChannel",void 0),M(this,"_useLocalAccessPoint",!1),M(this,"_setLocalAPVersion",void 0),M(this,"_joinAndNotLeaveYet",!1),M(this,"_numberOfJoinCount",0),M(this,"_joinResponse",null),M(this,"_remoteDefaultVideoStreamType",void 0),M(this,"_inspect",void 0),M(this,"_moderation",void 0),M(this,"_license",void 0),M(this,"_pendingPublishedUsers",[]),M(this,"ntpAlignErrorCount",0),M(this,"remoteInboundOffset",0),M(this,"_peerConnectionState",void 0),M(this,"_pendingRtpCapabilityChange",void 0),M(this,"_fallbackServerInfo",void 0),M(this,"_dualStreamMode",void 0),M(this,"_handleLocalTrackEnable",(o,s,a)=>{this.publish(o,!1).then(s).catch(a)}),M(this,"_handleLocalTrackDisable",(o,s,a)=>{this.unpublish(o).then(s).catch(a)}),M(this,"_handleUserOnline",o=>{if(B("BLOCK_LOCAL_CLIENT")&&Uu(o.uid,this.channelName))return void I.debug("[".concat(o.uid,"] will be ignored in local"));this.isStringUID&&typeof o.uid!="string"&&I.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const s=this._users.find(a=>a.uid===o.uid);if(s)s._trust_in_room_=!0,s._is_pre_created&&(s._is_pre_created=!1,this.safeEmit(At.USER_JOINED,s));else{const a=new ju(o.uid,o.uint_id||o.uid);this._users.push(a),I.debug("[".concat(this._clientId,"] user online"),o.uid),this.store.firstVideoFrameDecoded(a.uid,{userJoinNotify:Date.now()}),this.safeEmit(At.USER_JOINED,a)}}),M(this,"_handleUserOffline",o=>{if(B("BLOCK_LOCAL_CLIENT")&&Uu(o.uid,this.channelName))return;const s=this._users.find(a=>a.uid===o.uid);s&&(this._handleRemoveStream(o),this._handleRemoveDataChannels(o),s._audio_pre_subscribed||s._video_pre_subscribed?s._is_pre_created=!0:Iu(this._users,s),this._remoteStreamTypeCacheMap.delete(s.uid),this._streamFallbackTypeCacheMap.delete(s.uid),I.debug("[".concat(this._clientId,"] user offline"),o.uid,"reason:",o.reason),this.safeEmit(At.USER_LEAVED,s,o.reason))}),M(this,"_handleAddAudioOrVideoStream",(o,s,a,c,d,l,h,p)=>{if(B("BLOCK_LOCAL_CLIENT")&&Uu(s,this.channelName))return;const f=this._users.find(S=>S.uid===s);if(!f)return void I.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));I.debug("[".concat(this._clientId,"] stream added with uid ").concat(s,", type ").concat(o)),this.store.subscribe(f.uid,o,void 0,void 0,void 0,Date.now()),o==="video"&&this.store.firstVideoFrameDecoded(f.uid,{videoAddNotify:Date.now()});const m=o==="audio"?f.hasAudio:f.hasVideo;f._uintid||(f._uintid=l||s),o==="audio"?f._trust_audio_stream_added_state_=!0:f._trust_video_stream_added_state_=!0,o==="audio"?(f._audio_added_=!0,a!==void 0&&(f._audioSSRC=a),c!==void 0&&(f._cname=c),h&&(f._audioOrtc=h)):(f._video_added_=!0,a!==void 0&&(f._videoSSRC=a),c!==void 0&&(f._cname=c),p!==void 0&&(f._rtxSsrcId=p),h&&(f._videoOrtc=h)),(o==="audio"?f.hasAudio:f.hasVideo)&&!m&&(I.info("[".concat(this._clientId,"] remote user ").concat(f.uid," published ").concat(o)),this.safeEmit(At.USER_PUBLISHED,f,o)),o==="video"?H.onGatewayStream(this._sessionId,Dt.ON_ADD_VIDEO_STREAM,Xi.ON_ADD_VIDEO_STREAM,{peer:l||s,ssrc:f._videoSSRC}):H.onGatewayStream(this._sessionId,Dt.ON_ADD_AUDIO_STREAM,Xi.ON_ADD_AUDIO_STREAM,{peer:l||s,ssrc:f._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(f,o,a).then(S=>{if(S&&(I.debug("[".concat(this._clientId,"] resubscribe ").concat(o," for user ").concat(f.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Tn))return this._p2pChannel.unsubscribe(f,o,!0).then(()=>this._subscribe(f,o,!0).catch(T=>{I.error("[".concat(this._clientId,"] resubscribe error"),T.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(f,o)&&(I.debug("[".concat(this._clientId,"] resubscribe ").concat(o," for user ").concat(f.uid," after reconnect.")),this._subscribe(f,o,!0).catch(S=>{I.error("[".concat(this._clientId,"] resubscribe error"),S.toString())}));const g=this._getEncodingName(d);o==="video"&&(g==="unknown"?this.safeEmit(At.AV1_DECODABLE_RESULT,!1):pn()||Dr()||(g==null?void 0:g.toLocaleLowerCase())!==Ph.av1||SC().then(S=>{B("FLS_ENABLE_AV1_DECODE_DETECT")&&this.safeEmit(At.AV1_DECODABLE_RESULT,S),S||this._gateway.downgradeCodec(g)}))}),M(this,"_handleRemoveStream",o=>{if(B("BLOCK_LOCAL_CLIENT")&&Uu(o.uid,this.channelName))return;const s=this._users.find(c=>c.uid===o.uid);if(!s)return void I.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));I.debug("[".concat(this._clientId,"] stream removed with uid ").concat(o.uid));let a=()=>{};s.hasAudio&&s.hasVideo?a=()=>{I.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished audio track")),this.safeEmit(At.USER_UNPUBLISHED,s,"audio"),I.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished video track")),this.safeEmit(At.USER_UNPUBLISHED,s,"video")}:s.hasVideo?a=()=>{I.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished video track")),this.safeEmit(At.USER_UNPUBLISHED,s,"video")}:s.hasAudio&&(a=()=>{I.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished audio track")),this.safeEmit(At.USER_UNPUBLISHED,s,"audio")}),s._video_pre_subscribed||s._audio_pre_subscribed||(s._trust_audio_stream_added_state_=!0,s._trust_video_stream_added_state_=!0,s._audio_added_=!1,s._video_added_=!1,this._p2pChannel instanceof Tn&&this._p2pChannel.unsubscribe(s).then(c=>{if(c)return this._gateway.unsubscribe(c,s.uid)}),s._audioSSRC=void 0,s._videoSSRC=void 0,s._audioOrtc=void 0,s._videoOrtc=void 0,s._rtxSsrcId=void 0),H.onGatewayStream(this._sessionId,Dt.ON_REMOVE_STREAM,Xi.ON_REMOVE_STREAM,{peer:o.uint_id||o.uid}),a()}),M(this,"_handleSetStreamLocalEnable",(o,s,a)=>{if(B("BLOCK_LOCAL_CLIENT")&&Uu(s,this.channelName))return;const c=this._users.find(h=>h.uid===s);if(!c)return void I.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));I.debug("[".concat(this._clientId,"] local ").concat(o," ").concat(a?"enabled":"disabled"," with uid ").concat(s));const d=o==="audio"?c.hasAudio:c.hasVideo;if(o==="audio"){c._trust_audio_enabled_state_=!0;const h=c._audio_enabled_;if(c._audio_enabled_=a,c._audio_enabled_===h)return;{const p=c._audio_enabled_?"enable-local-audio":"disable-local-audio";I.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(s,", msg: ").concat(p)),this.safeEmit(At.USER_INFO_UPDATED,s,p)}}else{c._trust_video_enabled_state_=!0;const h=c._video_enabled_;if(c._video_enabled_=a,c._video_enabled_===h)return;{const p=c._video_enabled_?"enable-local-video":"disable-local-video";I.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(s,", msg: ").concat(p)),this.safeEmit(At.USER_INFO_UPDATED,s,p)}}const l=o==="audio"?c.hasAudio:c.hasVideo;return d!==l?!d&&l?(I.info("[".concat(this._clientId,"] remote user ").concat(s," published ").concat(o)),void this.safeEmit(At.USER_PUBLISHED,c,o)):(o==="video"&&c._videoTrack&&c._videoTrack._destroy(),o==="audio"&&c._audioTrack,this._p2pChannel.muteRemote(c,o),I.info("[".concat(this._clientId,"] remote user ").concat(s," unpublished ").concat(o)),void this.safeEmit(At.USER_UNPUBLISHED,c,o)):void 0}),M(this,"_handleMuteStream",(o,s,a)=>{if(B("BLOCK_LOCAL_CLIENT")&&Uu(o,this.channelName))return;I.debug("[".concat(this._clientId,"] receive mute message"),o,s,a);const c=this._users.find(h=>h.uid===o);if(!c)return void I.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(o));const d=s==="audio"?c.hasAudio:c.hasVideo;if(s==="audio"){c._trust_audio_mute_state_=!0;const h=c._audio_muted_;if(c._audio_muted_=a,c._audio_muted_===h)return;{const p=c._audio_muted_?"mute-audio":"unmute-audio";I.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(o,", msg: ").concat(p)),this.safeEmit(At.USER_INFO_UPDATED,o,p)}}else{c._trust_video_mute_state_=!0;const h=c._video_muted_;if(c._video_muted_=a,c._video_muted_===h)return;{const p=c._video_muted_?"mute-video":"unmute-video";I.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(o,", msg: ").concat(p)),this.safeEmit(At.USER_INFO_UPDATED,o,p)}}const l=s==="audio"?c.hasAudio:c.hasVideo;if(d!==l){if(!d&&l)return(s==="audio"?c._audioSSRC:c._videoSSRC)?(I.info("[".concat(this._clientId,"] remote user ").concat(o," published ").concat(s)),void this.safeEmit(At.USER_PUBLISHED,c,s)):void I.warning("[".concat(this._clientId,"] remote user ").concat(o," receive ").concat(s," unmute message  before add stream message, ").concat(s," SSRC doesn't exist yet."));s==="video"&&c._videoTrack&&!c._video_pre_subscribed&&c._videoTrack._destroy(),s==="audio"&&c._audioTrack,this._p2pChannel.muteRemote(c,s),I.info("[".concat(this._clientId,"] remote user ").concat(o," unpublished ").concat(s)),this.safeEmit(At.USER_UNPUBLISHED,c,s)}}),M(this,"_handleP2PLost",async o=>{I.debug("[".concat(this._clientId,"] receive p2p lost"),o),parseInt(o.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():I.warning("[".concat(this._clientId,"] P2PLost stream not found"),o)}),M(this,"_handleTokenWillExpire",()=>{I.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(At.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),M(this,"_handleBeforeUnload",o=>{o.type==="beforeunload"&&o.returnValue!==void 0&&o.returnValue!==""||(this.leave(),I.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),M(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(At.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const o={downlinkNetworkQuality:0,uplinkNetworkQuality:0};o.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),o.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(At.NETWORK_QUALITY,o)}),M(this,"_handleP2PAddAudioOrVideoStream",(o,s,a,c)=>{const d=this._users.find(h=>h.uid===s);if(!d)return void I.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));I.debug("[".concat(this._clientId,"] stream added with uid ").concat(s,", type ").concat(o)),this.store.subscribe(d.uid,o,void 0,void 0,void 0,Date.now());const l=o==="audio"?d.hasAudio:d.hasVideo;o==="audio"?d._trust_audio_stream_added_state_=!0:d._trust_video_stream_added_state_=!0,o==="audio"?(d._audio_added_=!0,a!==void 0&&(d._audioSSRC=a),c!==void 0&&(d._audioMid=c)):(d._video_added_=!0,a!==void 0&&(d._videoSSRC=a),c!==void 0&&(d._videoMid=c)),(o==="audio"?d.hasAudio:d.hasVideo)&&!l&&(I.info("[".concat(this._clientId,"] remote user ").concat(d.uid," published ").concat(o)),this.safeEmit(At.USER_PUBLISHED,d,o)),this._p2pChannel.hasPendingRemoteMedia(d,o)&&(I.debug("[".concat(this._clientId,"] resubscribe ").concat(o," for user ").concat(d.uid," after reconnect.")),this._subscribe(d,o,!0).catch(h=>{I.error("[".concat(this._clientId,"] resubscribe error"),h.toString())}))}),this._config=e,this._clientId=t||li(5,"client-"),this.store=new class{constructor(o,s,a,c,d){ut(this,"state",void 0),this.state={codec:o,audioCodec:s,mode:a,clientId:c,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,keyMetrics:{publish:[],subscribe:[],firstVideoFrameDecoded:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useP2P:!1,p2pTransport:Yr.Default,hasStartJoinChannel:!1,isABTestSuccess:!1,rteUrl:void 0,rteSid:void 0,autoSubscribe:!1,enableInstantMuteRestore:!1,networkQualityProbe:!1,useDcSignal:!!d}}dispatch(o){this.state=function(s,a){switch(a.type){case tt.SET_SESSION_ID:return L(L({},s),{},{sessionId:a.sessionId});case tt.SET_P2P_ID:return L(L({},s),{},{p2pId:a.p2pId});case tt.SET_UID:return L(L({},s),{},{uid:a.uid});case tt.SET_INT_UID:return L(L({},s),{},{intUid:a.intUid});case tt.SET_PUB_ID:return L(L({},s),{},{pubId:a.pubId});case tt.KEY_METRIC_CLIENT_CREATED:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{clientCreated:a.metric})});case tt.KEY_METRIC_JOIN_START:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{joinStart:a.metric})});case tt.KEY_METRIC_PRELOAD_START:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{preloadStart:a.metric})});case tt.KEY_METRIC_PRELOAD_END:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{preloadEnd:a.metric})});case tt.KEY_METRIC_JOIN_END:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{joinEnd:a.metric})});case tt.KEY_METRIC_REQUEST_AP_START:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{requestAPStart:a.metric})});case tt.KEY_METRIC_REQUEST_AP_END:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{requestAPEnd:a.metric})});case tt.KEY_METRIC_REQUEST_SUA_END:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{requestSUAEnd:a.metric})});case tt.KEY_METRIC_BEFORE_CONNECT:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{beforeConnect:a.metric})});case tt.KEY_METRIC_PEER_RECEIVER:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{peerReceiver:a.metric})});case tt.KEY_METRIC_SIGNAL_CONNECTED:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{signalConnected:a.metric})});case tt.KEY_METRIC_JOIN_REQ:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{joinReq:a.metric})});case tt.KEY_METRIC_JOIN_REP:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{joinRep:a.metric})});case tt.KEY_METRIC_JOIN_GATEWAY_START:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{joinGatewayStart:a.metric})});case tt.KEY_METRIC_JOIN_GATEWAY_END:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{joinGatewayEnd:a.metric})});case tt.KEY_METRIC_PEER_CONNECTION_START:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{peerConnectionStart:a.metric})});case tt.KEY_METRIC_PEER_CONNECTION_END:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{peerConnectionEnd:a.metric})});case tt.KEY_METRIC_DESCRIPTION_START:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{descriptionStart:a.metric})});case tt.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{signalChannelOpen:a.metric})});case tt.KEY_METRIC_ICE_CONNECTION_END:return L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{iceConnectionEnd:a.metric})});case tt.KEY_METRIC_PUBLISH:{const c=s.keyMetrics.publish,d=c.findIndex(l=>l.trackId===a.metric.trackId);return d!==-1?(c[d]=L(L({},c[d]),a.metric),L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{publish:[...c]})})):L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{publish:[...s.keyMetrics.publish,a.metric]})})}case tt.KEY_METRIC_SUBSCRIBE:{const c=s.keyMetrics.subscribe,d=c.findIndex(l=>l.userId===a.metric.userId&&l.type===a.metric.type);return d!==-1?(c[d]=L(L({},c[d]),a.metric),L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{subscribe:[...c]})})):L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{subscribe:[...s.keyMetrics.subscribe,a.metric]})})}case tt.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED:{const c=s.keyMetrics.firstVideoFrameDecoded,d=c.findIndex(l=>l.userId===a.metric.userId);return d!==-1?(c[d]=L(L({},c[d]),a.metric),L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{firstVideoFrameDecoded:[...c]})})):L(L({},s),{},{keyMetrics:L(L({},s.keyMetrics),{},{firstVideoFrameDecoded:[...s.keyMetrics.firstVideoFrameDecoded,a.metric]})})}case tt.RESET_FIRST_VIDEO_FRAME_DECODED:return s.keyMetrics.firstVideoFrameDecoded=[],s;case tt.SET_CLOUD_PROXY_SERVER_MODE:return s.cloudProxyServerMode=a.mode,s;case tt.RECORD_JOIN_CHANNEL_SERVICE:return typeof a.index!="number"?s.joinChannelServiceRecords=[...s.joinChannelServiceRecords,a.record]:(s.joinChannelServiceRecords[a.index]=L(L({},s.joinChannelServiceRecords[a.index]),a.record),s.joinChannelServiceRecords=[...s.joinChannelServiceRecords]),s;case tt.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return s.joinChannelServiceRecords=[],s;case tt.RESET_KEY_METRICS:return s.keyMetrics={publish:[],subscribe:[],firstVideoFrameDecoded:[]},s;case tt.SET_USE_P2P:return L(L({},s),{},{useP2P:a.val});case tt.SET_TRANSPORT_TYPE:return L(L({},s),{},{p2pTransport:a.val});case tt.SET_RTE_URL:return L(L({},s),{},{rteUrl:a.rteUrl});case tt.SET_RTE_SID:return L(L({},s),{},{rteSid:a.rteSid});default:return s}}(this.state,o)}get useDcSignal(){return this.state.useDcSignal}set useDcSignal(o){this.state.useDcSignal=o}set autoSubscribe(o){this.state.autoSubscribe=o}get autoSubscribe(){return this.state.autoSubscribe}set enableInstantMuteRestore(o){this.state.enableInstantMuteRestore=o}get enableInstantMuteRestore(){return this.state.enableInstantMuteRestore}set networkQualityProbe(o){this.state.networkQualityProbe=o}get networkQualityProbe(){return this.state.networkQualityProbe}set sessionId(o){this.dispatch({type:tt.SET_SESSION_ID,sessionId:o})}get sessionId(){return this.state.sessionId}set rteUrl(o){this.dispatch({type:tt.SET_RTE_URL,rteUrl:o})}get rteUrl(){return this.state.rteUrl}set rteSid(o){this.dispatch({type:tt.SET_RTE_SID,rteSid:o})}get rteSid(){return this.state.rteSid}set cid(o){this.state.cid=o}get cid(){return this.state.cid}set codec(o){this.state.codec=o}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(o){this.dispatch({type:tt.SET_P2P_ID,p2pId:o})}get p2pId(){return this.state.p2pId}set dcId(o){this.dispatch({type:tt.SET_DC_ID,dcId:o})}get dcId(){return this.state.dcId}set uid(o){this.dispatch({type:tt.SET_UID,uid:o})}get uid(){return this.state.uid}set intUid(o){this.dispatch({type:tt.SET_INT_UID,intUid:o})}get intUid(){return this.state.intUid}set pubId(o){this.dispatch({type:tt.SET_PUB_ID,pubId:o})}get pubId(){return this.state.pubId}set cloudProxyServerMode(o){this.dispatch({type:tt.SET_CLOUD_PROXY_SERVER_MODE,mode:o})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useP2P(o){this.dispatch({type:tt.SET_USE_P2P,val:o})}get useP2P(){return this.state.useP2P}set p2pTransport(o){this.dispatch({type:tt.SET_TRANSPORT_TYPE,val:o})}get p2pTransport(){return this.state.p2pTransport}set hasStartJoinChannel(o){this.state.hasStartJoinChannel=o}get hasStartJoinChannel(){return this.state.hasStartJoinChannel}set isABTestSuccess(o){this.state.isABTestSuccess=o}get isABTestSuccess(){return this.state.isABTestSuccess}clientCreated(){this.dispatch({type:tt.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:tt.KEY_METRIC_JOIN_START,metric:Date.now()})}preloadStart(){this.dispatch({type:tt.KEY_METRIC_PRELOAD_START,metric:Date.now()})}preloadEnd(){this.dispatch({type:tt.KEY_METRIC_PRELOAD_END,metric:Date.now()})}joinEnd(){this.dispatch({type:tt.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:tt.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:tt.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}requestSUAEnd(){this.dispatch({type:tt.KEY_METRIC_REQUEST_SUA_END,metric:Date.now()})}beforeConnect(){this.dispatch({type:tt.KEY_METRIC_BEFORE_CONNECT,metric:Date.now()})}peerReceiver(){this.dispatch({type:tt.KEY_METRIC_PEER_RECEIVER,metric:Date.now()})}signalConnected(){this.dispatch({type:tt.KEY_METRIC_SIGNAL_CONNECTED,metric:Date.now()})}joinReq(){this.dispatch({type:tt.KEY_METRIC_JOIN_REQ,metric:Date.now()})}joinRep(){this.dispatch({type:tt.KEY_METRIC_JOIN_REP,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:tt.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:tt.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:tt.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:tt.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}firstVideoFrameDecoded(o,s){this.dispatch({type:tt.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED,metric:L({userId:o},s)})}descriptionStart(){this.dispatch({type:tt.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:tt.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:tt.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(o,s,a,c){this.dispatch({type:tt.KEY_METRIC_PUBLISH,metric:L(L({trackId:o,type:s},a&&{publishStart:a}),c&&{publishEnd:c})})}subscribe(o,s,a,c,d,l,h){this.dispatch({type:tt.KEY_METRIC_SUBSCRIBE,metric:L(L(L(L(L({userId:o,type:s},a&&{subscribeStart:a}),c&&{subscribeEnd:c}),d&&{firstFrame:d}),l&&{streamAdded:l}),h&&{firstDecoded:h})})}massSubscribe(o,s,a,c){o.forEach(d=>{this.dispatch({type:tt.KEY_METRIC_SUBSCRIBE,metric:L(L(L({userId:d.userId,type:d.type},s&&{subscribeStart:s}),a&&{subscribeEnd:a}),c&&{firstFrame:c})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(o,s){o.service==="gateway"&&Array.isArray(o.urls)&&(o.urls=o.urls.map(a=>a.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof s!="number"?(this.dispatch({type:tt.RECORD_JOIN_CHANNEL_SERVICE,record:L(L({},o),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(s<0||s>=this.state.joinChannelServiceRecords.length||this.dispatch({type:tt.RECORD_JOIN_CHANNEL_SERVICE,record:o,index:s}),s)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:tt.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:tt.RESET_KEY_METRICS})}resetFirstVideoFrameDecoded(){this.dispatch({type:tt.RESET_FIRST_VIDEO_FRAME_DECODED})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}}(e.codec,e.audioCodec,e.mode,this._clientId,B("SIGNAL_CHANNEL")===1),this._leaveMutex=new jr("client-leave",this._clientId),this._publishMutex=new jr("client-publish",this._clientId),this._renewTokenMutex=new jr("client-renewtoken",this._clientId),this._subscribeMutex=new jr("client-subscribe",this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),I.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(Qs," build: ").concat(sT,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{It(e.clientRoleOptions),i=Object.assign({},e.clientRoleOptions)}catch(o){I.warning("[".concat(this._clientId,"] ").concat(o.toString()))}var r;this._statsCollector=new _m(this.store),this._statsCollector.onStatsException=(o,s,a)=>{I.warn("[".concat(this._clientId,"] receive exception msg, code: ").concat(o,", msg: ").concat(s,", uid: ").concat(a)),o===qn.VIDEO_ENCODE_FAILED&&this.localTracks.forEach(c=>{c instanceof fT&&B("ENABLE_ENCODE_EXCEPTION")&&c.findClosestProfile()}),this.safeEmit(At.EXCEPTION,{code:o,msg:s,uid:a})},this._statsCollector.onUploadPublishDuration=(o,s,a,c)=>{const d=this._users.find(l=>l.uid===o);d&&(this.store.keyMetrics&&(this.store.firstVideoFrameDecoded(d.uid,{peerPublishDuration:a,peerPubStatusMs:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(d)),H.peerPublishStatus(this._sessionId,{subscribeElapse:c,audioPublishDuration:s,videoPublishDuration:a,peer:d._uintid}))},this._statsCollector.onVideoCodecChanged=o=>{if(B("VIDEO_STANDARD_BITRATE_VERSION")&&(o==="av1"||o==="h265"||o==="h264")){const s=this.localTracks.find(a=>a instanceof yi);s&&s._saveEncodeBitrateRatio!==1&&s.setSaveEncodeBitrateRatio(o==="h264"?B("BASELINE_MORE_H264_BITRATE_RATIO"):void 0)}},this.store.useP2P=e.mode==="p2p",this._gateway=new pC(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||yr,httpRetryConfig:e.httpRetryConfig||yr,forceWaitGatewayResponse:e.forceWaitGatewayResponse===void 0||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:i}),this._configDistribute=new Rz(this._clientId,this.store),this.store.useP2P?(this._p2pChannel=(r={store:this.store,statsCollector:this._statsCollector},Fc("P2PChannel").create(r)),this._handleP2PEvents()):this._p2pChannel=new Tn(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,t,i,r,o){let s=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],a=arguments.length>6&&arguments[6]!==void 0&&arguments[6];F("JOIN_GATEWAY_USE_443PORT_ONLY",s),F("JOIN_GATEWAY_USE_DUAL_DOMAIN",a);const c=this._gateway.signal.websocket;return c instanceof M_&&(c.use443PortOnly=s,c.tryDoubleDomain=a),async function(d,l,h){v_.get(d)||v_.set(d,[]),ec.get(d)||ec.set(d,l),pr.get(d)||pr.set(d,0);const p=v_.get(d),f=ec.get(d);if(!p||!f)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(pr.get(d)===f){const C=Ih();p.push(C),await C.promise}pr.set(d,pr.get(d)+1);for(var m=arguments.length,g=new Array(m>3?m-3:0),S=3;S<m;S++)g[S-3]=arguments[S];const T=await h(...g);return pr.set(d,pr.get(d)-1),pr.get(d)===f-1&&p.length>0&&(p[0].resolve(),p.shift()),pr.get(d)===0&&(v_.set(d,[]),ec.set(d,0),pr.set(d,0)),T}("client.join",B("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,t,i,r,o)}async join(e,t,i,r,o){const s=++this._numberOfJoinCount;this.store.joinStart(),r&&(this.store.uid=r);const a=(Lf||Lf||(Lf=(window.location.protocol.split(":")[0]||"").toUpperCase(),Lf))==="HTTPS",c=nc()?window.isSecureContext:"Browser Not Support";(!nc()&&!a||!window.isSecureContext)&&I.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser");let d;H.setAppId(e);try{if(!i&&i!==null)throw new $(O.INVALID_PARAMS,"Invalid token: ".concat(i,". If you don not use token, set it to null"));if(i&&Ar(i,"token",1,2047),Ar(e,"appid",1,2047),L_(t),r&&Mc(r),o)if(typeof o=="string")Ar(o,"optionalInfo",1,256),d=o;else{if(typeof o!="object")throw new $(O.INVALID_PARAMS,"Invalid options: options is not a string or object");{const{autoSubscribe:T,enableInstantMuteRestore:C,networkQualityProbe:b}=o;T&&(xi(T,"autoSubscribe"),I.info("[".concat(this._clientId,"] join: autoSubscribe: ").concat(T)),this.store.autoSubscribe=T),C&&(xi(C,"enableInstantMuteRestore"),I.info("[".concat(this._clientId,"] join: enableInstantMuteRestore: ").concat(C)),this.store.enableInstantMuteRestore=C),b&&(xi(b,"networkQualityProbe"),I.info("[".concat(this._clientId,"] join: networkQualityProbe: ").concat(b)),this.store.networkQualityProbe=b)}}}catch(T){throw H.reportApiInvoke(Fd(),{name:ct.JOIN,options:[e,t,i,r],states:{isHttps:a,isSecureContext:c},tag:bi.TRACER}).onError(T),T}if(this._leaveMutex.isLocked&&(I.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),I.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){const T=new $(O.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw H.reportApiInvoke(Fd(),{name:ct.JOIN,options:[e,t,i,r],states:{isHttps:a,isSecureContext:c},tag:bi.TRACER}).onError(T),T}this._gateway.state="CONNECTING",this.store.preloadStart();const l=await bC({appId:e,cname:t,uid:r,stringUid:typeof r=="string"?r:void 0,token:i||e,cloudProxyServer:this._cloudProxyServerMode});if(this.store.preloadEnd(),!this._joinAndNotLeaveYet)throw new $(O.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));const h=(l==null?void 0:l.sid)||Fd();I.info("[".concat(this._clientId,"] start join channel ").concat(t,", join number: ").concat(s)),this._sessionId||(this._sessionId=h,this.store.sessionId=this._sessionId);const p=H.reportApiInvoke(this._sessionId,{id:this._clientId,name:ct.JOIN,options:[e,t,i,r],states:{isHttps:a,isSecureContext:c},tag:bi.TRACER}),f=Wc(Wc(Wc({},this._rtmConfig),{},{role:this.role,clientId:this._clientId,appId:e,sid:this._sessionId,cname:t,uid:typeof r!="string"?r:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:i||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:d,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!l},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType}),{},{apRequestDetail:B("AP_REQUEST_DETAIL")||void 0});if(this._useLocalAccessPoint&&(f.setLocalAPVersion=this._setLocalAPVersion),typeof r=="string"&&(f.stringUid=r,this._uintUid?(f.uid=this._uintUid,this._uintUid=void 0):f.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(f.aesmode=this._encryptionMode,f.aespassword=await(async T=>{const C=function(k){const V=window.atob(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),W=new Uint8Array(new ArrayBuffer(V.length));for(let K=0;K<V.length;K+=1)W[K]=V.charCodeAt(K);return W}(),b=await window.crypto.subtle.importKey("spki",C,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),D=Tv(T),x=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},b,D);return function(k){let V="";for(let W=0;W<k.length;W+=1)V+=String.fromCharCode(k[W]);return window.btoa(V)}(new Uint8Array(x))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new $(O.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(f.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const T=new TextEncoder,C=B("USE_PURE_ENCRYPTION_MASTER_KEY")?T.encode(f.appId+this._encryptionSecret+this._encryptionSecret):T.encode(f.appId+f.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(b,D,x){const k=await window.crypto.subtle.importKey("raw",D,"PBKDF2",!1,["deriveBits","deriveKey"]),V=b==="aes-128-gcm2"?128:256,W=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:w_,hash:"SHA-256",salt:x},k,V+AU);return new Uint8Array(W).subarray(V/8)}(this._encryptionMode,C,_a(this._encryptionSalt)),this._encryptDataStreamKey=await async function(b,D,x){const k=await window.crypto.subtle.importKey("raw",D,"PBKDF2",!1,["deriveBits","deriveKey"]),V=b==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:w_,hash:"SHA-256",salt:x},k,{name:"AES-GCM",length:V},!0,["encrypt","decrypt"])}(this._encryptionMode,C,_a(this._encryptionSalt))}else c?I.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):I.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,I.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:t,appId:e,stringUid:f.stringUid});const m=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&m===this._sessionId&&H.joinChannelTimeout(this._sessionId,5)},5e3);try{var g;let T;const C=f.cloudProxyServer;if(z(g=["proxy3","proxy4","proxy5"]).call(g,C)){const V=B("PROXY_SERVER_TYPE3");Array.isArray(V)?f.proxyServer=V[0]:f.proxyServer=V}if(H.setProxyServer(f.proxyServer),I.setProxyServer(f.proxyServer),this.store.requestAPStart(),l){if(I.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(f.stringUid?", ".concat(f.stringUid," => ").concat(l.intUid):""," ")),f.stringUid&&!f.uid&&(f.uid=l.intUid),T={gatewayInfo:l.ap.gatewayInfo},B("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&f.turnServer.mode==="auto")if(l.ap.proxyInfo.addresses.length===0)I.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{const V=(await sC(l.ap.proxyInfo,l.ap.gatewayInfo.uid)).map(W=>({turnServerURL:W.address,tcpport:W.tcpport||En.tcpport,udpport:W.udpport||En.udpport,username:W.username||En.username,password:W.password||En.password,forceturn:!1,security:!0}));f.turnServer={mode:"manual",servers:V}}NL(l,f.stringUid)}else{if(f.stringUid&&!f.uid){let V;[V,T]=await Z.all([i2(f.stringUid,f,this._axiosCancelSource.token,this._config.httpRetryConfig||yr,this.store).finally(()=>{this.store.requestSUAEnd()}),cL(f,this._axiosCancelSource.token,this._config.httpRetryConfig||yr,!0,this.store).finally(()=>{this.store.requestAPEnd()})]),I.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(f.stringUid," => ").concat(V)),f.uid=V,T.gatewayInfo.uid=V,T.gatewayInfo.res.uid=V}else T=await cL(f,this._axiosCancelSource.token,this._config.httpRetryConfig||yr,!0,this.store);if(!this._joinAndNotLeaveYet)throw new $(O.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(f,this._axiosCancelSource.token),this._configDistribute.on(Uc.UPDATE_BITRATE_LIMIT,V=>{this._p2pChannel.updateBitrateLimit(V)}),this._configDistribute.on(Uc.UPDATE_CLIENT_ROLE_OPTIONS,V=>{this._setClientRoleOptions(V)}),this._configDistribute.on(Uc.UPDATE_REMOTE_VIDEO_STREAM_TYPE,V=>{var W;z(W=[0,1,4,5,6,7,8,9]).call(W,V)&&(this.remoteUsers.forEach(K=>{this._remoteStreamTypeCacheMap.get(K.uid)!==V&&this.setRemoteVideoStreamType(K.uid,V)}),this.setRemoteDefaultVideoStreamType(V))}),this._configDistribute.on(Uc.FALLBACK_TO_HLS,V=>{V&&this.safeEmit(At.FALLBACK_TO_HLS,Cn.CONFIG)}),this._configDistribute.on(Uc.UPDATE_VOS_CONFIGURE,V=>{this._gateway.setConfigure(V).catch(W=>{I.debug("[".concat(this._clientId,"] auto set vos config failed"),W)})})},0),this._key=i||e;const b=T.gatewayInfo,D=f.uid?f.uid:b.uid;this._joinInfo=Wc(Wc({},f),{},{cid:b.cid,uid:D,vid:b.vid,apResponse:b.res,apGatewayAddress:b.apGatewayAddress,uni_lbs_ip:b.uni_lbs_ip,gatewayAddrs:b.gatewayAddrs}),this.store.intUid=D,this.store.cid=b.cid;const x=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new $(O.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));p.onSuccess(x),this._appId=e,this._channelName=f.cname,this._uid=x,this.store.uid=x,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),!pn()&&this.store.useDcSignal?(window.addEventListener("beforeunload",this._handleBeforeUnload),window.addEventListener("pagehide",this._handleBeforeUnload)):window.addEventListener(pn()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()},0);const k=f.stringUid?"string uid: ".concat(f.stringUid,",uid: ").concat(f.uid):"uid: ".concat(this._uid);return I.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(t,",").concat(k)),setTimeout(()=>{I.startUpload()},5e3),this.store.joinEnd(),S=this,z(Lc).call(Lc,S)||Lc.push(S),this._cloudProxyServerMode==="disabled"&&Mt().supportWebCrypto&&B("ENABLE_PRELOAD")&&NC(this._joinInfo),this._rteDetailInterval&&(window.clearInterval(this._rteDetailInterval),this._rteDetailInterval=void 0),this._sessionId&&H.reportRteDetail(this._sessionId),this._rteDetailInterval=window.setInterval(()=>{this._sessionId&&H.reportRteDetail(this._sessionId)},B("RTE_DETAIL_REPORT_INTERVAL")||6e4),x}catch(T){const C=Array.isArray(T)?T[0]:T;throw C&&C.code===O.OPERATION_ABORTED?I.warning("[".concat(this._clientId,"] join number: ").concat(s,", Joining channel failed, rollback"),C):I.error("[".concat(this._clientId,"] join number: ").concat(s,", Joining channel failed, rollback"),C),C.code!==O.OPERATION_ABORTED&&this._numberOfJoinCount===s&&(this._gateway.state="DISCONNECTED",this._reset()),p.onError(C),C}var S}async _joinGateway(){if(!this._joinInfo||!this._key)throw new $(O.INVALID_OPERATION);try{return await this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!B("JOIN_WITH_FALLBACK_SIGNAL_PROXY")))}catch(e){if(e.code===O.INIT_DATACHANNEL_TIMEOUT){if(this._gateway.leave(!0,bt.FALLBACK),I.debug("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new $(O.INVALID_OPERATION);return H.reportApiInvoke(this._sessionId,{name:ct.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:bi.TRACER}).onSuccess(),await this._joinGateway()}throw e}}async leave(){I.info("[".concat(this._clientId,"] Leaving channel"));const e=()=>{!pn()&&this.store.useDcSignal?(window.addEventListener("beforeunload",this._handleBeforeUnload),window.addEventListener("pagehide",this._handleBeforeUnload)):window.addEventListener(pn()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(i){const r=Lc.indexOf(i);r!==-1&&Lc.splice(r,1)}(this),this._statsCollector.stopUpdateStats()};this.store.useDcSignal||e();const t=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return I.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave(this.connectionState!=="CONNECTED",bt.LEAVE),I.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t(),this.store.useDcSignal&&e()}async publish(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(e)){if(!(e instanceof N_))return this._publishDataChannel(e);e=[e]}if(e.length===0)throw new $(O.INVALID_PARAMS,"param list is empty");const i=e;if(this._gateway.role==="audience")throw new $(O.INVALID_OPERATION,"audience can not publish stream");for(const o of i){if(!(o instanceof N_))throw new $(O.INVALID_PARAMS,"parameter is not local track");if(!o._enabled&&t)throw new $(O.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(o.getTrackId()))}I.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(i.map(o=>"".concat(o.getTrackId()," "))));const r=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),t&&i.forEach(o=>{const s=this._configDistribute.getBitrateLimit();o instanceof yi&&s&&o.setBitrateLimit(s.uplink)});try{await this._publishHighStream(i),I.info("[".concat(this._clientId,"] Publish success, id ").concat(i.map(o=>"".concat(o.getTrackId()," "))))}catch(o){throw I.error("[".concat(this._clientId,"] publish error"),o.toString()),o}finally{r()}}async _publishDataChannel(e){if(e==null)throw new $(O.INVALID_PARAMS,"parameter is not local track or datachannel config, config is ".concat(JSON.stringify(e)));Ai(e.id,"id",0,65535,!0),xi(e.ordered,"ordered"),Ar(e.metadata,"metadata",0,512),I.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));const t=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(o=>o.id===e.id)!==-1)throw new $(O.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new $(O.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&B("FORCE_TURN")&&!B("TURN_ENABLE_TCP")&&!B("TURN_ENABLE_UDP"))throw new $(O.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const i=function(o){return xT(o,!1)}(e),r=await this._p2pChannel.publishDataChannel([i]);if(r.length>0){if(typeof i._originDataChannelId!="number")throw I.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new $(O.CREATE_DATACHANNEL_ERROR);try{await Z.all(r.map(o=>this._uid&&this._gateway.publishDataChannel(this._uid,o,!0))),await i._waitTillOpen()}catch(o){if(o.code!==O.DISCONNECT_P2P)throw o}}return I.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(i.id)),i}catch(i){throw I.error("[".concat(this._clientId,"] publish datachannels error"),i.toString()),i}finally{t()}}async unpublish(e){if(!this._joinInfo||this._uid===void 0)throw new $(O.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let t=[];if(e)if(Array.isArray(e))t=e;else{if(!(e instanceof N_))return this._unpublishDataChannel([e]);t=[e]}else this.store.useP2P||await this._unpublishDataChannel(),t=this._p2pChannel.getAllTracks(!0);I.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(t.map(r=>"".concat(r.getTrackId()," "))," "));const i=await this._publishMutex.lock();try{if(this.store.useP2P){const r=await this._p2pChannel.unpublish(t);r&&await this._gateway.sendExtensionMessage(cr.UNPUBLISH,{unpubMsg:r},!0)}else{const r=await this._p2pChannel.unpublish(t);r&&await this._gateway.unpublish(r,this._uid),I.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(t.map(o=>"".concat(o.getTrackId()))))}}catch(r){throw I.error("[".concat(this._clientId,"] unpublish error"),r.toString()),r}finally{i&&i()}}async _unpublishDataChannel(e){e!==void 0&&e.length!==0||(e=this._p2pChannel.getAllDataChannels()),I.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map(i=>"".concat(i.id," "))," "));const t=await this._publishMutex.lock();try{const i=await this._p2pChannel.unpublishDataChannel(e);i&&await this._gateway.unpublishDataChannel(i),I.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map(r=>"".concat(r.id))))}catch(i){throw I.error("[".concat(this._clientId,"] unpublish dataChannel error"),i.toString()),i}finally{t&&t()}}async subscribe(e,t,i){if(!(e instanceof ju)){const r=this.remoteUsers.find(o=>o.uid===e);if(!r)throw new $(O.INVALID_REMOTE_USER,"user is not in the channel");e=r}return t==="datachannel"?this._subscribeDataChannel(e,i):this._subscribe(e,t)}async presubscribe(e,t){if(Rt(t,"mediaType",["audio","video"]),this.store.useP2P)throw new $(O.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new $(O.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const i=t===be.AUDIO,r=t===be.VIDEO,o=await this._subscribeMutex.lock();try{const{ssrcId:s,ortc:a,rtxSsrcId:c,cname:d,uint_id:l}=await this._gateway.presubscribe(e,t,!0);if(s==null)throw new $(O.UNEXPECTED_RESPONSE,"no ssrc id");let h=this._users.find(f=>f.uid===e);h||(h=new ju(e,l||e),h._is_pre_created=!0,this._users.push(h)),d&&(h._cname=d),h._uintid||(h._uintid=l||e),i&&(h._audioSSRC=s,h._audio_pre_subscribed=!0,a&&(h._audioOrtc=a)),r&&(h._videoSSRC=s,h._video_pre_subscribed=!0,a&&(h._videoOrtc=a),c!=null&&(h._rtxSsrcId=c)),I.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(s)),await this._p2pChannel.subscribe(h,t,s,c,a);const p=i?h._audioTrack:h._videoTrack;if(!p)throw new $(O.UNEXPECTED_ERROR,"can not find remote track in user");return i&&(h._trust_audio_stream_added_state_=!0,h._audio_added_=!0),r&&(h._trust_video_stream_added_state_=!0,h._video_added_=!0),p}catch(s){throw I.error("[".concat(this._clientId,"] presub user ").concat(e," error"),s),s}finally{o()}}async _subscribeDataChannel(e,t){var i;if(Ai(t,"channelId",0,65535,!0),!this._joinInfo)throw new $(O.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(c=>c===e))throw I.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new $(O.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&e._dataChannels.length===0)throw I.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new $(O.INVALID_REMOTE_USER,"user is not published");const o=(i=e._dataChannels)===null||i===void 0?void 0:i.find(c=>c.id===t);if(!o)throw I.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new $(O.REMOTE_USER_IS_NOT_PUBLISHED);const s=await this._subscribeMutex.lock();I.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{const c=await this._p2pChannel.subscribeDataChannel(e,[o]);if(c&&z(c).call(c,o.id))try{var a;if(typeof o._originDataChannelId!="number")throw I.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new $(O.CREATE_DATACHANNEL_ERROR);const d={id:o.id,datachannelId:o._originDataChannelId,ordered:o.ordered,maxRetransmits:o.maxRetransmits,metadata:(a=o.metadata)!==null&&a!==void 0?a:""};await this._gateway.subscribeDataChannel(e.uid,d,!0),await o._waitTillOpen()}catch(d){if((d==null?void 0:d.code)!==O.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[o]),d;await this._p2pChannel.unsubscribeDataChannel(e,[o]),this._p2pChannel.setPendingRemoteDataChannel(e,o.id)}return I.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),o}finally{s()}}async _p2pSubscribe(e,t,i){if(Rt(t,"mediaType",["audio","video"]),!this._joinInfo)throw new $(O.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(s=>s===e)){const s=new $(O.INVALID_REMOTE_USER,"user is not in the channel");throw I.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),s}if(!e.hasAudio&&!e.hasVideo){const s=new $(O.INVALID_REMOTE_USER,"user is not published");throw I.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),s}if(!i&&(t==="audio"&&!e.hasAudio||t==="video"&&!e.hasVideo)){const s=new $(O.REMOTE_USER_IS_NOT_PUBLISHED);throw I.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),s}const o=await this._subscribeMutex.lock();I.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const a=t==="audio"?e._audioSSRC:e._videoSSRC,c=t==="audio"?e._audioMid:e._videoMid;this.store.subscribe(e.uid,t,Date.now()),this.store.useP2P&&await this._p2pChannel.subscribe(e,t,a,c)}catch(a){throw a}I.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType!==void 0&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch(a=>{I.warning("[".concat(this._clientId,"] auto set fallback failed"),a)});const s=t==="audio"?e._audioTrack:e._videoTrack;if(!s)throw new $(O.UNEXPECTED_ERROR,"can not find remote track in user object");return s}catch(s){throw I.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),s),s}finally{o()}}async _subscribe(e,t,i){if(this.store.useP2P)return this._p2pSubscribe(e,t);if(Rt(t,"mediaType",["audio","video"]),!this._joinInfo)throw new $(O.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(l=>l===e)){const l=new $(O.INVALID_REMOTE_USER,"user is not in the channel");throw I.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),l}if(!e.hasAudio&&!e.hasVideo){const l=new $(O.INVALID_REMOTE_USER,"user is not published");throw I.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),l}if(!(i||(t!=="audio"||e.hasAudio&&e._audioSSRC!==void 0)&&(t!=="video"||e.hasVideo&&e._videoSSRC!==void 0))){const l=new $(O.REMOTE_USER_IS_NOT_PUBLISHED);throw I.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),l}let o=t==="audio"?e._audioSSRC:e._videoSSRC,s=t==="audio"?e._audioOrtc:e._videoOrtc,a=t==="video"?e._rtxSsrcId:void 0,c={stream_type:t==="audio"?be.AUDIO:be.VIDEO,ssrcId:o};t==="video"&&this.store.firstVideoFrameDecoded(e.uid,{subscribeStart:Date.now()});const d=await this._subscribeMutex.lock();I.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const h=t==="audio"?e._audioSSRC:e._videoSSRC;h!==void 0&&h!==o&&(o=h,s=t==="audio"?e._audioOrtc:e._videoOrtc,a=t==="video"?e._rtxSsrcId:void 0,c={stream_type:t==="audio"?be.AUDIO:be.VIDEO,ssrcId:o}),eo.markSubscribeStart(this.store.clientId,o),this.store.subscribe(e.uid,t,Date.now()),await this._p2pChannel.subscribe(e,t,o,a,s);try{this._p2pChannel.isPreSubScribe(o)||await this._gateway.subscribe(e.uid,c,!0)}catch(p){if((p==null?void 0:p.code)!==O.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,t),p;await this._p2pChannel.unsubscribe(e,t,!0),this._p2pChannel.setPendingRemoteMedia(e,t)}this.store.subscribe(e.uid,t,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,t)}catch(h){throw this._p2pChannel.reportSubscribeEvent(!1,h==null?void 0:h.code,e,t),h}I.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType!==void 0&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch(h=>{I.warning("[".concat(this._clientId,"] auto set fallback failed"),h)});const l=t==="audio"?e._audioTrack:e._videoTrack;if(!l)throw new $(O.UNEXPECTED_ERROR,"can not find remote track in user object");return t==="video"&&(this.store.firstVideoFrameDecoded(e.uid,{subscribeEnd:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(e)),l}catch(l){throw I.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),l),l}finally{d()}}async massSubscribe(e){if(Pi(e,"subscribeList"),!this._joinInfo)throw new $(O.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const t=Date.now(),i=new Map,r=await this._subscribeMutex.lock();I.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map(c=>{let{user:d,mediaType:l}=c;return"user: ".concat(d==null?void 0:d.uid,", mediaType: ").concat(l)}).join("; ")));const o=(e=[...e]).map(c=>{let{user:d,mediaType:l}=c;return{user:d,mediaType:l}}),s=await this._p2pChannel.globalLock();try{var a;for(let d=e.length-1;d>=0;d--){const l=e[d],{user:h,mediaType:p}=l;if(Rt(p,"mediaType",["audio","video"]),!h){const S=new $(O.INVALID_PARAMS,"user property does not exist in subscribeList item");throw I.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),S}if(!this._users.find(S=>S===h)){const S=new $(O.INVALID_REMOTE_USER,"user is not in the channel");I.error("[".concat(this._clientId,"] can not massSubscribe ").concat(h.uid,", this user is not in the channel")),o[d].error=S,e.splice(d,1);continue}if(p==="audio"&&(!h.hasAudio||h._audioSSRC===void 0)||p==="video"&&(!h.hasVideo||h._videoSSRC===void 0)){const S=new $(O.REMOTE_USER_IS_NOT_PUBLISHED);I.error("[".concat(this._clientId,"] can not subscribe ").concat(h.uid," with mediaType ").concat(p,", remote user is not published")),o[d].error=S,e.splice(d,1);continue}const m=gt.Video|gt.LwoVideo,g=i.get(h);if(g){if(p==="video"?g&m:g&gt.Audio){e.splice(d,1),I.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(h.uid,", mediaType:").concat(p," twice"));continue}i.set(h,g|(p==="video"?m:gt.Audio))}else i.set(h,p==="video"?m:gt.Audio)}for(let d=e.length-1;d>=0;d--){const l=e[d],{user:h,mediaType:p}=l,f=gt.Video|gt.LwoVideo;if(this._p2pChannel.hasRemoteMedia(h,p)){await this._p2pChannel.unmuteRemoteNoLock(h,p);const m=i.get(h);i.set(h,p==="video"?m^f:m^gt.Audio),e.splice(d,1)}}this.store.massSubscribe(e.map(d=>({userId:d.user.uid,type:d.mediaType})),t);let c=un(a=Array.from(i.entries())).call(a,(d,l)=>{let[h,p]=l;if(p===0)return d;const f={stream_id:h.uid,stream_type:p};return p&gt.Audio&&(f.audio_ssrc=h._audioSSRC),p&gt.Video&&(f.video_ssrc=h._videoSSRC),d.push(f),d},[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map(l=>{let{user:h,mediaType:p}=l;return{user:h,mediaType:p,ssrcId:p===be.VIDEO?h._videoSSRC:h._audioSSRC,rtxSsrcId:p===be.VIDEO?h._rtxSsrcId:void 0}}));const d=new Map;if(c=c.filter(l=>l.video_ssrc&&!this._p2pChannel.isPreSubScribe(l.video_ssrc)||l.audio_ssrc&&!this._p2pChannel.isPreSubScribe(l.audio_ssrc)||!l.video_ssrc&&!l.audio_ssrc),c.length>0){const l=await this._gateway.subscribeAll(c,!0);((l==null?void 0:l.users)||[]).forEach(h=>{let{stream_id:p,video_error_code:f,audio_error_code:m,error_code:g}=h;(f||m||g)&&d.set(p,{video_error_code:f,audio_error_code:m,error_code:g})})}if(Array.from(d.entries()).length>0){const l=[];Array.from(d.entries()).forEach(h=>{let[p,f]=h;const m=this.remoteUsers.find(g=>g.uid===p);if(m){let g;f.error_code||f.video_error_code&&f.audio_error_code?g=void 0:f.video_error_code?g=be.VIDEO:f.audio_error_code&&(g=be.AUDIO),l.push({user:m,mediaType:g})}}),l.length>0&&await this._p2pChannel.massUnsubscribeNoLock(l)}for(const l of o){const h=d.get(l.user.uid);if(h){const p=h.error_code||l.mediaType==="audio"&&h.audio_error_code||l.mediaType==="video"&&h.video_error_code;if(p){const f=jh(p);I.error("user:".concat(l.user.uid," mediaType:").concat(l.mediaType," has massSubscribe error ").concat(f.desc)),l.error=new $(O.SUBSCRIBE_FAILED,"code ".concat(p,": ").concat(f.desc))}}l.error||(l.mediaType==="video"?l.track=l.user.videoTrack:l.track=l.user.audioTrack)}return this.store.massSubscribe(o.filter(l=>!l.error).map(l=>({userId:l.user.uid,type:l.mediaType})),void 0,Date.now()),o.forEach(l=>{var h;H.subscribe(this.store.sessionId,{succ:!!l.error,ec:((h=l.error)===null||h===void 0?void 0:h.code)||null,video:l.mediaType===be.VIDEO,audio:l.mediaType===be.AUDIO,peerid:l.user.uid,subscribeRequestid:l.mediaType===be.VIDEO?l.user._videoSSRC:l.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-t),preSsrc:this._p2pChannel.isPreSubScribe(l.user._videoSSRC)},!0)}),I.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map(l=>{let{user:h,mediaType:p}=l;return"user: ".concat(h==null?void 0:h.uid,", mediaType: ").concat(p)}).join("; "))),o}catch(d){throw await this._p2pChannel.massUnsubscribeNoLock(e),d}}finally{s(),r()}}async unsubscribe(e,t,i){if(!(e instanceof ju)){const s=this.remoteUsers.find(a=>a.uid===e);if(!s)throw new $(O.INVALID_REMOTE_USER,"user is not in the channel");e=s}if(t||this.store.useP2P){if(t==="datachannel")return this._unsubscribeDataChannel(e,i)}else await this._unsubscribeDataChannel(e,i);if(t&&Rt(t,"mediaType",["audio","video"]),!this._joinInfo)throw new $(O.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(s=>s===e)){const s=new $(O.INVALID_REMOTE_USER,"user is not in the channel");throw I.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),s}I.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(t));const o=await this._subscribeMutex.lock();try{if(this.store.useP2P)await this._p2pChannel.unsubscribe(e,t);else{const s=await this._p2pChannel.unsubscribe(e,t);s&&await this._gateway.unsubscribe(s,e.uid),t&&t!=="audio"||(e._audio_pre_subscribed=!1),t&&t!=="video"||(e._video_pre_subscribed=!1),e._is_pre_created&&Iu(this._users,e),I.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(t))}}catch(s){if(s.code===O.DISCONNECT_P2P)return void I.warning("disconnecting p2p, abort unsubscribe request.");throw I.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),s.toString()),s}finally{o()}}async _unsubscribeDataChannel(e,t){if(t&&Ai(t,"id",0,65535,!0),!this._joinInfo)throw new $(O.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(o=>o===e)){const o=new $(O.INVALID_REMOTE_USER,"user is not in the channel");throw I.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),o}let r;if(typeof t=="number"){const o=e._dataChannels.find(s=>s.id===t);o&&(r=[o])}else r=e._dataChannels;if(r===void 0){const o=new $(O.REMOTE_USER_IS_NOT_PUBLISHED);throw I.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(t,", remote datachannel is not published")),o}I.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(r.map(o=>o.id)));try{const o=await this._p2pChannel.unsubscribeDataChannel(e,r);o&&await this._gateway.unsubscribeDataChannel(o,e.uid),I.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(o))}catch(o){if(o.code===O.DISCONNECT_P2P)return void I.warning("disconnecting p2p, abort unsubscribe request.");throw I.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),o.toString()),o}}async massUnsubscribe(e){if(Pi(e,"unsubscribeList"),!this._joinInfo)throw new $(O.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");I.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map(i=>{let{user:r,mediaType:o}=i;return"user: ".concat(r==null?void 0:r.uid,", mediaType: ").concat(o,";")}).join())),e=[...e];const t=new Map;for(let i=e.length-1;i>=0;i--){const{user:r,mediaType:o}=e[i];if(!r){const c=new $(O.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw I.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),c}if(Rt(o,"mediaType",["video","audio",void 0]),!this._users.find(c=>c===r)){I.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(r.uid,", user is not in the channel")),e.splice(i,1);continue}const a=gt.Video|gt.LwoVideo;if(t.has(r)){const c=t.get(r);let d;switch(o){case"video":d=c&a;break;case"audio":d=c&gt.Audio;break;default:d=c&(gt.Audio|a)}if(d){I.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(r.uid,",mediaType:").concat(o," twice.")),e.splice(i,1);continue}o?o==="audio"?t.set(r,c|gt.Audio):o==="video"&&t.set(r,c|a):t.set(r,c|gt.Audio|a)}else o?o==="audio"?t.set(r,gt.Audio):o==="video"&&t.set(r,a):t.set(r,gt.Audio|a)}try{const i=await this._p2pChannel.massUnsubscribe(e);i&&await this._gateway.massUnsubscribe(i),I.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map(r=>{let{user:o,mediaType:s}=r;return"user: ".concat(o==null?void 0:o.uid,", mediaType: ").concat(s,";")}).join()))}catch(i){if(i.code===O.DISCONNECT_P2P)return void I.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw I.error("[".concat(this._clientId,"] massUnsubscribe error"),i.toString()),i}}async setLowStreamParameter(e){(function(i){if(!i)throw new oe(O.INVALID_PARAMS);_r(i.width)||_n(i.width,"streamParameter.width"),_r(i.height)||_n(i.height,"streamParameter.height"),_r(i.framerate)||_n(i.framerate,"streamParameter.framerate"),_r(i.bitrate)||Ai(i.bitrate,"streamParameter.bitrate")})(e),(!e.width&&e.height||e.width&&!e.height)&&I.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),I.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));const t=this._configDistribute.getLowStreamConfigDistribute();if(t&&t.bitrate&&e.bitrate&&t.bitrate<e.bitrate&&(e.bitrate=t.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,ue.LocalVideoLowTrack)}async setDualStreamMode(e,t){Rt(e,"mode",[0,1,-1]);try{switch(t&&await this.setLowStreamParameter(t),this._dualStreamMode=e,this._joinInfo?this._gateway.setDualStreamMode(e).catch(i=>{I.warning("[".concat(this._clientId,"] set dual stream mode failed"),i.toString())}):I.debug("[".concat(this._clientId,"] haven't joined yet, cache dual stream mode ").concat(e)),e){case Oh.AUTO_SIMULCAST_STREAM:I.info("[".concat(this._clientId,"] set dual stream mode to ").concat(e));break;case Oh.DISABLE_SIMULCAST_STREM:return this.disableDualStream();case Oh.ENABLE_SIMULCAST_STREAM:return this.enableDualStream()}}catch(i){throw I.error("[".concat(this._clientId,"] set dual stream mode error"),i.toString()),i}}async enableDualStream(){if(!Mt().supportDualStream)throw H.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new $(O.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new $(O.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw H.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,this._dualStreamMode=Oh.ENABLE_SIMULCAST_STREAM,this._joinInfo&&this._gateway.setDualStreamMode(this._dualStreamMode,!0,!0).catch(e=>{I.debug("[".concat(this._clientId,"] try to inform gateway to set dual stream mode to ").concat(this._dualStreamMode," ,but failed"),e.toString())}),H.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),I.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)return this._isDualStreamEnabled=!1,void I.info("[".concat(this._clientId,"] disable dual stream before join"));if(this._p2pChannel.getLocalMedia(ue.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw H.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,this._dualStreamMode=Oh.DISABLE_SIMULCAST_STREM,this._joinInfo&&this._gateway.setDualStreamMode(this._dualStreamMode,!0,!0).catch(e=>{I.debug("[".concat(this._clientId,"] try to inform gateway to set dual stream mode to ").concat(this._dualStreamMode," ,but failed"),e.toString())}),H.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),I.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,t){if(function(r){Rt(r,"role",["audience","host"])}(e),t&&It(t),this.mode==="rtc"||this.mode==="p2p")throw I.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new $(O.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(t&&t.level&&e==="host")throw new $(O.INVALID_OPERATION,"host mode can not set audience latency level");if(e==="audience"&&this._p2pChannel.hasLocalMedia())throw new $(O.INVALID_OPERATION,"can not set client role to audience when publishing stream");const i=this._config.role;if(this._joinInfo&&(this._joinInfo.role=e),e!==i&&B("ENABLE_ROLE_SELECT_EDGE")?(this._gateway.updateClientRole(e,t),this._config.role=e,this._gateway.reconnect("recover",Gi.REGIONAL_DISTRIBUTION)):(await this._gateway.setClientRole(e,t),this._config.role=e),I.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(t&&t.level)),i==="audience"&&e!=="audience"&&this._pendingRtpCapabilityChange&&this._p2pChannel instanceof Tn){const{video_codec:r}=this._pendingRtpCapabilityChange;this._p2pChannel.updateRemoteRTPCapabilities(r.map(o=>o.toLowerCase()).filter(o=>{var s;return z(s=Object.keys(Ph)).call(s,o)}))}}async _setClientRoleOptions(e){if(this.mode==="rtc"||this.mode==="p2p"||this._config.role!=="audience"||this._p2pChannel.hasLocalMedia())return;let t=!1;try{e&&It(e),await this._gateway.setClientRole(this._config.role,e),t=!0}catch{}finally{I.info("[".concat(this._clientId,"] set client role options ").concat(t?"succeed":"failed",", options is ").concat(e))}}getRemoteInboundOffset(){var e;const t=(e=this._p2pChannel.getStats())===null||e===void 0?void 0:e.audioSend[0];if(!t||!t.timestamp)return 0;const i=t.timestamp-Date.now();return Math.abs(i)>1e3+t.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?i:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,t){if(Ar(e,"proxyServer"),!t){if(this.connectionState!=="DISCONNECTED")throw new $(O.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new $(O.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,H.setProxyServer(this._proxyServer),I.setProxyServer(this._proxyServer),I.info("[".concat(this._clientId,"] Set proxy server ").concat(t?"by initialize call":""," success."))}setTurnServer(e,t){if(Array.isArray(e)||(e=[e]),!t){if(this.connectionState!=="DISCONNECTED")throw new $(O.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new $(O.INVALID_OPERATION,"You have already set the proxy")}if(bh(e))return this._turnServer={servers:e,mode:"original-manual"},void I.info("[".concat(this._clientId,"] Set original turnserver ").concat(t?"by initialize call":""," success: ").concat(e.map(i=>i.urls).join(","),"."));e.forEach(i=>I_(i)),this._turnServer={servers:e,mode:"manual"},I.info("[".concat(this._clientId,"] Set turnserver ").concat(t?"by initialize call":""," success."))}setLicense(e){if(this.connectionState!=="DISCONNECTED")throw new $(O.INVALID_OPERATION,"you should set license before join channel");if(Ar(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new $(O.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,I.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if(this.connectionState!=="DISCONNECTED")throw new $(O.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new $(O.INVALID_OPERATION,"You have already set the proxy");const t=[3,4,5];let i;switch(e===void 0&&(e=3),e){case 1:case 2:throw new $(O.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:i="proxy3";break;case 4:i="proxy4";break;case 5:i="proxy5";break;default:throw new $(O.INVALID_PARAMS,"proxy server mode must be ".concat(t.join("|")))}this._cloudProxyServerMode=i,this.store.cloudProxyServerMode=i,I.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new $(O.INVALID_OPERATION,"Stop proxy server after leave channel");H.setProxyServer(),I.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",I.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new $(O.INVALID_PARAMS,"accessPoints is required.");Pi(e.accessPoints.serverList,"accessPoints.serverList"),Ar(e.accessPoints.domain,"accessPoints.domain");const t=(f,m)=>{Ai(f,m,0,65535,!0)};let i=443;if(e.accessPoints.port&&(t(e.accessPoints.port,"accessPoints.port"),i=e.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new $(O.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");B("CLOSE_AFB_FOR_LOCAL_AP")&&(F("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),F("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const r=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,o=e.accessPoints.domain,s=e.accessPoints.serverList.map(f=>r.test(f)?"".concat(f.replace(/\./g,"-"),".").concat(o):f),a=s.map(f=>"".concat(f,":").concat(i));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,F("WEBCS_DOMAIN",a),F("WEBCS_DOMAIN_BACKUP_LIST",a),F("GATEWAY_DOMAINS",[o]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(Pi(e.report.hostname,"report.hostname"),F("EVENT_REPORT_DOMAIN",e.report.hostname[0]),F("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(F("EVENT_REPORT_DOMAIN",s[0]),F("EVENT_REPORT_BACKUP_DOMAIN",s[1]||s[0]));let c=6443;e.report&&e.report.port&&(t(e.report.port,"report.port"),c=e.report.port),F("STATS_COLLECTOR_PORT",c),e.report?F("ENABLE_EVENT_REPORT",!0):F("ENABLE_EVENT_REPORT",!1);let d="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(Pi(e.log.hostname,"log.hostname"),d=e.log.hostname[0]):d=s[0];let l=6444;e.log&&e.log.port&&(t(e.log.port,"log.port"),l=e.log.port),F("LOG_UPLOAD_SERVER","".concat(d,":").concat(l));let h=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(Pi(e.cds.hostname,"cds.hostname"),h=e.cds.hostname):h=s;let p=443;e.cds&&e.cds.port&&(t(e.cds.port,"cds.port"),p=e.cds.port),F("CDS_AP",h.map(f=>"".concat(f,":").concat(p))),e.cds?F("ENABLE_CONFIG_DISTRIBUTE",!0):F("ENABLE_CONFIG_DISTRIBUTE",!1),I.info("set local access point v2 success")}setLocalAccessPoints(e,t){if(Pi(e,"serverList"),Ar(t,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new $(O.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const i=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map(r=>i.test(r)?"".concat(r.replace(/\./g,"-"),".").concat(t):r),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,F("WEBCS_DOMAIN",e),F("WEBCS_DOMAIN_BACKUP_LIST",e),F("GATEWAY_DOMAINS",[t]),F("EVENT_REPORT_DOMAIN",e[0]),F("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),F("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),I.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(Rt(e,"streamType",[0,1,4,5,6,7,8,9]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(t){throw I.error("[".concat(this._clientId,"] set default remote video stream type error"),t.toString()),t}else I.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,t){Rt(t,"streamType",[0,1,4,5,6,7,8,9]);try{await this._gateway.setRemoteVideoStreamType(e,t),setTimeout(()=>{const i=this._users.find(r=>r.uid===e);i&&i.videoTrack&&i.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(i){throw I.error("[".concat(this._clientId,"] set remote video stream type error"),i.toString()),i}I.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(t)),this._remoteStreamTypeCacheMap.set(e,t)}async setStreamFallbackOption(e,t){Rt(t,"fallbackType",[0,1,2,3,4,5,6,7,8]);try{await this._gateway.setStreamFallbackOption(e,t)}catch(i){throw I.error("[".concat(this._clientId,"] set stream fallback option"),i.toString()),i}I.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(t)),this._streamFallbackTypeCacheMap.set(e,t)}setEncryptionConfig(e,t,i,r){(function(s){Rt(s,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(e),Ar(t,"secret");const o=["aes-128-gcm2","aes-256-gcm2"];if(z(o).call(o,e)){if(!i||!(i instanceof Uint8Array&&i.length===32))throw new $(O.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(i)throw new $(O.INVALID_PARAMS,"current encrypt mode does not need salt");if(r){if(xi(r,"encryptDataStream"),!z(o).call(o,e))throw new $(O.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(t)||I.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=e,this._encryptionSecret=t,i&&(this._encryptionSalt=bu(i))}async renewToken(e){if(Ar(e,"token",1,2047),!this._key||!this._joinInfo)throw new $(O.INVALID_OPERATION,"renewToken should not be called before user join");const t=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);const i=await this._renewTokenMutex.lock();try{if(B("USE_NEW_TOKEN")){I.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const r=await o2(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||yr);I.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:r})}else I.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});I.debug("[".concat(this._clientId,"] renewToken success"))}catch(r){throw this._key=t,this._joinInfo.token=t,I.error("[".concat(this._clientId,"] renewToken failed"),r.toString()),r}finally{i()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?I.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{const e=this._p2pChannel.getAudioLevels();this.safeEmit(At.VOLUME_INDICATOR,e)},B("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if(this.codec!=="h264")throw new $(O.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new $(O.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new $(O.LIVE_STREAMING_TASK_CONFLICT);const i=t?xu.TRANSCODE:xu.RAW;return this._createLiveStreamingClient(i).startLiveStreamingTask(e,i)}setLiveTranscoding(e){return this._createLiveStreamingClient(xu.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(i=>i&&i.hasUrl(e));if(!t.length)throw new $(O.INVALID_PARAMS,"can not find live streaming url to stop");await Z.all(t.map(i=>i&&i.stopLiveStreamingTask(e)))}async startChannelMediaRelay(e){Bu(e),await this._createChannelMediaRelayClient().startChannelMediaRelay(e)}async updateChannelMediaRelay(e){Bu(e),await this._createChannelMediaRelayClient().updateChannelMediaRelay(e)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendAudioMetadata(e){this._p2pChannel instanceof Tn&&this._p2pChannel.addAudioMetadata(e)}async sendStreamMessage(e){var t;let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new $(O.INVALID_OPERATION,"can not send data stream, not joined");if((typeof e=="string"||e instanceof Uint8Array)&&(e={payload:e}),typeof e.payload=="string"){const o=new TextEncoder;e.payload=o.encode(e.payload)}let r=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&z(t=["aes-128-gcm2","aes-256-gcm2"]).call(t,this._encryptionMode)&&(r=!0,e.payload=await async function(o,s,a){var c;const d=un(c=Array.from(a)).call(c,(S,T)=>S+T,0),l={serverTs:0,seq:wU++,length:a.length,checkSum:d},h=new Uint8Array(A_(d,2)),p=new ArrayBuffer(jf),f=new DataView(p);f.setUint32(0,l.serverTs),f.setUint16(4,l.seq),f.setUint16(6,l.length),f.setUint16(8,l.checkSum);const m=16-a.length%16;a=xd(a,new Uint8Array(m));const g=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:o,tagLength:IU,additionalData:h},s,a);return xd(new Uint8Array(p),new Uint8Array(g))}(this._encryptDataStreamIv,this._encryptDataStreamKey,e.payload)),new Blob([e.payload]).size>1024)throw new $(O.INVALID_PARAMS,r?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(Be.DATA_STREAM,{payload:bu(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-vz},!i)}sendMetadata(e){if(!this._joinInfo)throw new $(O.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new $(O.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(Be.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:bu(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(jY),!this._joinInfo)throw new $(O.INVALID_OPERATION,"can not send custom report, not joined");await H.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){const e=this._statsCollector.getRemoteNetworkQualityStats();if(B("DELETE_NEQ_AFTER_USER_LEAVE")){const t=this._users.map(i=>i.uid+"");Object.keys(e).forEach(i=>{z(t).call(t,i)||delete e[i]})}return e}getNetworkQuality(){return this._statsCollector.getNetworkQuality()}async pickSVCLayer(e,t){Rt(t.spatialLayer,"spatialLayer",[0,1,2,3]),Rt(t.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,t)}catch(i){throw I.error("[".concat(this._clientId,"] pick SVC layer failed"),i.toString()),i}}async setRTMConfig(e){const{apRTM:t=!1,rtmFlag:i}=e;if(xi(t,"apRTM"),Ai(i,"rtmFlag",0),this._rtmConfig.apRTM=t,this._rtmConfig.rtmFlag=i,I.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(e)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=t,this._joinInfo.rtmFlag=i,this._gateway.setRTM2Flag(i)}_reset(){if(I.debug("[".concat(this._clientId,"] reset client")),function(e){const t=kc.indexOf(e);t!==-1&&kc.splice(t,1)}(this._clientId),this.store.hasStartJoinChannel=!1,this.store.isABTestSuccess=!1,this.store.autoSubscribe=!1,this._pendingRtpCapabilityChange=void 0,this._axiosCancelSource.cancel(),this._axiosCancelSource=hs.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&OL(this._joinInfo),this._rteDetailInterval&&(window.clearInterval(this._rteDetailInterval),this._rteDetailInterval=void 0,this._sessionId&&H.reportRteDetail(this._sessionId)),this._fallbackServerInfo=void 0,this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId&&H.removeSid(this._sessionId),this._sessionId=null,this.store.sessionId=null,this.store.resetFirstVideoFrameDecoded(),this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach(t=>t._close()),e._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new jr("client-publish",this._clientId),this._subscribeMutex=new jr("client-subscribe",this._clientId),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(e,t){var i;const r=e||Fd();e?I.debug("[".concat(this._clientId,"] new Session ").concat(r)):I.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(r));const o=e?"":this._sessionId||"";this._sessionId=r,this.store.sessionId=r,H.addSid(r);const s={lts:new Date().getTime(),mode:this.mode,buildFormat:1,stringUid:(t==null?void 0:t.stringUid)||((i=this._joinInfo)===null||i===void 0?void 0:i.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:o,clientRole:this.role==="audience"?2:1,rteUrl:this.store.rteUrl,rteSid:this.store.rteSid};H.sessionInit(this._sessionId,Wc({cname:t.channel,appid:t.appId},s)),this._joinInfo&&(this._joinInfo.sid=r),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=r)}async _publishHighStream(e){if(!this._joinInfo||this._uid===void 0)throw new $(O.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&B("FORCE_TURN")&&!B("TURN_ENABLE_TCP")&&!B("TURN_ENABLE_UDP"))throw new $(O.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");I.debug("[".concat(this._clientId,"] publish high stream"));try{const i=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(this.store.useP2P){const r=(await i.next()).value;if(r){try{await this._gateway.sendExtensionMessage(cr.PUBLISH,r,!0)}catch(o){throw i.throw(o),o}await i.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const r=(await i.next()).value;if(r){var t;let o;try{o=await this._gateway.publish(this._uid,r,!0)}catch(s){if(s.code!==O.DISCONNECT_P2P)throw i.throw(s),s}await i.next(((t=o)===null||t===void 0?void 0:t.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const o of e)o instanceof yi&&o._encoderConfig&&this._gateway.setVideoProfile(o._encoderConfig).catch(s=>{I.debug("[".concat(this._clientId,"] stop setVideoProfile, because websocket is closed"))}),!o.muted&&o.enabled||await this._p2pChannel.muteLocalTrack(o)}}catch(i){if(this._p2pChannel.reportPublishEvent(!1,i==null?void 0:i.code,e),(i==null?void 0:i.code)===O.WS_ABORT)return;throw i}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new $(O.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new $(O.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));I.debug("[".concat(this._clientId,"] publish low stream"));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{const i=await this._p2pChannel.publishLowStream(this._lowStreamParameter),r=(await i.next()).value;if(r){var t;let o;try{o=await this._gateway.publish(this._uid,r,!0)}catch(s){if(s.code!==O.DISCONNECT_P2P)throw i.throw(s),s}i.next(((t=o)===null||t===void 0?void 0:t.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(i){if(this._p2pChannel.reportPublishEvent(!1,i==null?void 0:i.code,void 0,!0),(i==null?void 0:i.code)===O.WS_ABORT)return;throw i}}_createLiveStreamingClient(e){const t=()=>{if(!this._joinInfo||!this._appId)return new $(O.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const i=(r={joinInfo:this._joinInfo,appId:this._appId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig},Fc("LiveStreaming").create(r));var r;return i.onLiveStreamError=(o,s)=>{H.reportApiInvoke(this._sessionId,{name:ct.ON_LIVE_STREAM_ERROR,options:[o,s],tag:bi.TRACER}).onSuccess(),this.safeEmit(At.LIVE_STREAMING_ERROR,o,s)},i.onLiveStreamWarning=(o,s)=>{H.reportApiInvoke(this._sessionId,{name:ct.ON_LIVE_STREAM_WARNING,options:[o,s],tag:bi.TRACER}).onSuccess(),this.safeEmit(At.LIVE_STREAMING_WARNING,o,s)},i.on(Gr.REQUEST_WORKER_MANAGER_LIST,(o,s,a)=>{if(!this._joinInfo)return a(new $(O.INVALID_OPERATION,"can not find join info to get worker manager"));(async function(c,d,l,h){const p=B("UAP_AP").slice(0,B("AJAX_REQUEST_CONCURRENT")).map(f=>d.proxyServer?"https://".concat(d.proxyServer,"/ap/?url=").concat(f+"/api/v1?action=uap"):"https://".concat(f,"/api/v1?action=uap"));return await iL(p,c,d,l,h)})(o,this._joinInfo,this._axiosCancelSource.token,yr).then(s).catch(a)}),i};return e===xu.RAW?(this._liveRawStreamingClient=this._liveRawStreamingClient||t(),this._liveRawStreamingClient):(this._liveTranscodeStreamingClient=this._liveTranscodeStreamingClient||t(),this._liveTranscodeStreamingClient)}_createChannelMediaRelayClient(){if(!this._joinInfo)return new $(O.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:t,sendResolutionHeight:i}=this.getLocalVideoStats(),r=(e={joinInfo:this._joinInfo,clientId:this._clientId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig,resolution:{width:t,height:i}},Fc("ChannelMediaRelay").create(e));r.on("state",o=>{o===lo.RELAY_STATE_FAILURE&&r&&r.dispose(),this.safeEmit(At.CHANNEL_MEDIA_RELAY_STATE,o)}),r.on("event",o=>{this.safeEmit(At.CHANNEL_MEDIA_RELAY_EVENT,o)}),this._channelMediaRelayClient=r,this._statsCollector.onStatsChanged=(o,s)=>{var a;o==="resolution"&&((a=this._channelMediaRelayClient)===null||a===void 0||a.setVideoProfile(s))}}var e;return this._channelMediaRelayClient}_handleUpdateDataChannel(e,t){const{added:i,deleted:r}=e,o=[];if(t){const s=[];this._users.forEach(a=>{a._dataChannels.forEach(c=>{i.every(d=>d.uid!==a._uintid||d.stream_id!==c.id)&&s.push({uid:a._uintid,stream_id:c.id,ordered:c.ordered,max_retrans_times:c.maxRetransmits,metadata:c.metadata})})}),s.length>0&&this._handleUpdateDataChannel({added:[],deleted:s})}Array.isArray(i)&&i.length>0&&i.forEach(s=>{const{uid:a,stream_id:c,ordered:d,max_retrans_times:l,metadata:h}=s,p=this._users.find(f=>f._uintid===a);if(!p)return void I.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(I.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(a)),z(o).call(o,p)||o.push(p),p._uintid||(p._uintid=a),p._dataChannels.findIndex(f=>f.id===s.stream_id)===-1){const f={id:c,ordered:!!d,maxRetransmits:l,metadata:h},m=function(g){return xT(g,!0)}(f);p._dataChannels.push(m),I.info("[".concat(this._clientId,"] remote user ").concat(p.uid," published datachannel")),t||this.safeEmit(At.USER_PUBLISHED,p,"datachannel",f)}this._p2pChannel.hasPendingRemoteDataChannel(p,s.stream_id)&&(I.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(p.uid," after reconnect.")),this._subscribeDataChannel(p,s.stream_id).catch(f=>{I.error("[".concat(this._clientId,"] resubscribe datachannel error"),f.toString())}))}),t&&(this.safeEmit(At.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(r)&&r.length>0&&r.forEach(s=>{const{uid:a,stream_id:c}=s,d=this._users.find(h=>h._uintid===a);if(!d)return void I.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const l=d._dataChannels.find(h=>h.id===s.stream_id);l&&(I.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(a)),this._p2pChannel.unsubscribeDataChannel(d,[l]).then(h=>{if(d._dataChannels=d._dataChannels.filter(p=>p!==l),h)return this._gateway.unsubscribeDataChannel(h,d.uid)}),I.info("[".concat(this._clientId,"] remote user ").concat(a," unpublished datachannel ,id:").concat(l.id)),this.safeEmit(At.USER_UNPUBLISHED,d,"datachannel",l._config))})}_getEncodingName(e){var t,i;if(!this._joinResponse)return;const r=(t=this._joinResponse.ortc.rtpCapabilities.sendrecv)===null||t===void 0?void 0:t.videoCodecs;if(!r)return;for(const c of r){var o;if(c.payloadType===e)return c==null||(o=c.rtpMap)===null||o===void 0?void 0:o.encodingName}const s=(i=this._joinResponse.ortc.rtpCapabilities.recv)===null||i===void 0?void 0:i.videoCodecs;if(s)for(const c of s){var a;if(c.payloadType===e)return c==null||(a=c.rtpMap)===null||a===void 0?void 0:a.encodingName}return e===0?"unknown":void 0}_handleRemoveDataChannels(e){const t=this._users.find(i=>i.uid===e.uid);if(t){if(t._dataChannels!==void 0&&t._dataChannels.length>0){I.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));const i=()=>{I.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished datachannel")),t._dataChannels.forEach(r=>{this.safeEmit(At.USER_UNPUBLISHED,t,"datachannel",r._config)})};this._p2pChannel.unsubscribeDataChannel(t,t._dataChannels).then(r=>{if(r)return this._gateway.unsubscribeDataChannel(r,t.uid)}),i()}}else I.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(Rr.UPDATE_GATEWAY_CONFIG,()=>{(function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void I.error("Error loading sdk config",t.message)}if(e)try{const t=JSON.parse(window.atob(e)),i=Date.now();Object.keys(t).forEach(r=>{const{value:o,type:s,expires:a}=t[r];a&&a<=i||s||MP()||!Object.prototype.hasOwnProperty.call(Bf,r)||(Ye[r]=o,$e[r]=o,I.debug("Update gateway parameters from config distribute",r,o))})}catch(t){I.error("Error update config from local cache",t.message)}})()}),this._gateway.on(Rr.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(Rr.CONNECTION_STATE_CHANGE,(e,t,i)=>{var r;if(i===bt.FALLBACK)return;const o=()=>{this.safeEmit(At.CONNECTION_STATE_CHANGE,e,t,i)};if(H.reportApiInvoke(this._sessionId||((r=this._gateway.joinInfo)===null||r===void 0?void 0:r.sid)||null,{name:ct.CONNECTION_STATE_CHANGE,options:[e,t,i],tag:bi.TRACER}).onSuccess(JSON.stringify({cur:e,prev:t,reason:i})),I.info("[".concat(this._clientId,"] signal connection state change: ").concat(t," -> ").concat(e)),e==="DISCONNECTED")return this._reset(),void o();if(e==="RECONNECTING")this._users.forEach(a=>{a._trust_in_room_=!1,a._trust_audio_enabled_state_=!1,a._trust_video_enabled_state_=!1,a._trust_audio_mute_state_=!1,a._trust_video_mute_state_=!1,a._trust_audio_stream_added_state_=!1,a._trust_video_stream_added_state_=!1,a._is_pre_created||(a._audio_pre_subscribed||(a._audioSSRC=void 0,a._audioOrtc=void 0),a._video_pre_subscribed||(a._videoSSRC=void 0,a._videoOrtc=void 0,a._rtxSsrcId=void 0),a._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(e==="CONNECTED"){var s;this._streamFallbackTypeCacheMap.forEach((a,c)=>{this._gateway.setStreamFallbackOption(c,a).catch(d=>{I.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),d)})}),this._remoteStreamTypeCacheMap.forEach((a,c)=>{this._gateway.setRemoteVideoStreamType(c,a).catch(d=>{I.warning("[".concat(this._clientId,"] auto set remote stream type failed"),d)})}),B("VOS_CONFIGURE")&&Array.isArray(B("VOS_CONFIGURE"))&&B("VOS_CONFIGURE").length>0&&(this._gateway.setConfigure(B("VOS_CONFIGURE")).catch(a=>{I.debug("[".concat(this._clientId,"] auto set vos config failed"),a)}),I.debug("[".concat(this._clientId,"] ws connected auto set vos config"))),this._remoteDefaultVideoStreamType!==void 0&&((s=this._joinInfo)===null||s===void 0?void 0:s.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{I.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(a=>{I.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(a))}),this._dualStreamMode&&this._gateway.setDualStreamMode(this._dualStreamMode).catch(a=>{I.warning("[".concat(this._clientId,"] auto set dual stream mode failed"),a)}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(a=>!a._trust_in_room_).forEach(a=>{I.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(a.uid)),this._handleUserOffline({uid:a.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(a=>{a._trust_audio_mute_state_||(I.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(a.uid)),this._handleMuteStream(a.uid,be.AUDIO,!1)),a._trust_video_mute_state_||(I.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(a.uid)),this._handleMuteStream(a.uid,be.VIDEO,!1)),a._trust_audio_enabled_state_||(I.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(a.uid)),this._handleSetStreamLocalEnable("audio",a.uid,!0)),a._trust_video_enabled_state_||(I.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(a.uid)),this._handleSetStreamLocalEnable("video",a.uid,!0)),a._trust_video_stream_added_state_||(I.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(a.uid)),this._handleResetAddStream(a,"video")),a._trust_audio_stream_added_state_||(I.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(a.uid)),this._handleResetAddStream(a,"audio")),a._video_added_||a._audio_added_||(I.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(a.uid)),this._handleRemoveStream({uid:a.uid,uint_id:a._uintid}))}))},1e3))}o()}),this._gateway.on(Rr.REQUEST_NEW_GATEWAY_LIST,async(e,t)=>{if(!this._joinInfo)return t(new $(O.UNEXPECTED_ERROR,"can not recover, no join info"));try{let i;if(this._fallbackServerInfo)i=this._fallbackServerInfo,this._fallbackServerInfo=void 0,this._joinInfo.preload=!1,H.reportApiInvoke(this._sessionId,{name:ct.VOS_FALLBACK_CN,options:{cur:i.gatewayInfo.gatewayAddrs,prev:this._joinInfo.gatewayAddrs,is_done:!0},tag:bi.TRACER}).onSuccess(),I.info("[".concat(this._clientId,"] use fallback cn server info"));else{const o=await bC(Wc(Wc({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));o?(i=o.ap,NL(o),this._joinInfo.preload=!0):(i=await FT(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||yr,this.store),this._joinInfo.preload=!1)}this._joinInfo&&(this._joinInfo.apResponse=i.gatewayInfo.res,this._joinInfo.gatewayAddrs=i.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=i.gatewayInfo.uni_lbs_ip);const r=[];i.gatewayInfo.gatewayAddrs.forEach(o=>{let{address:s}=o;const[a,c]=s.split(":");this._joinInfo&&this._joinInfo.proxyServer?r.push({proxy:this._joinInfo.proxyServer,host:a,port:c}):r.push({host:a,port:c})}),e(r)}catch(i){t(i)}}),this._gateway.on(Rr.NETWORK_QUALITY,e=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(At.NETWORK_QUALITY,e)}),this._gateway.on(Rr.STREAM_TYPE_CHANGE,(e,t)=>{this.safeEmit(At.STREAM_TYPE_CHANGED,e,t),H.reportApiInvoke(this._sessionId,{name:ct.STREAM_TYPE_CHANGE,options:[e,t],tag:bi.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))}),this._gateway.isPreSub=()=>"isPreSub"in this._p2pChannel&&this._p2pChannel.isPreSub(),this._gateway.isPreallocation=()=>"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation(),this._gateway.on(Rr.IS_P2P_DISCONNECTED,e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)}),this._gateway.on(Rr.REQUEST_P2P_CONNECTION_PARAMS,async(e,t,i)=>{try{let r=await this._p2pChannel.getEstablishParams();r&&"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation()||(r=await this._p2pChannel.startP2PConnection(e)),t(r)}catch(r){i(r)}}),this._gateway.on(Rr.JOIN_RESPONSE,(e,t)=>{if(this.store.useP2P)return;let i;this._joinResponse=e,e.attributes?i=e.attributes.userAttributes.preSubSsrcs:I.debug("no attributes in joinResponse");const r=JP(e.ortc,t,i);this._p2pChannel.connect(r)}),this._gateway.on(Rr.PRE_CONNECT_PC,async(e,t,i)=>{const{candidates:r,fingerprint:o,turnServer:s}=e;if(this._joinInfo&&r.length>0&&!this._p2pChannel.isPlanB){const{cert:c,cid:d}=this._joinInfo.apResponse,l="".concat(d,"_").concat(c);if(l.length<4||l.length>256)return void I.debug("[".concat(this._clientId,"] ufrag length is not valid, length: ").concat(l.length));await this._p2pChannel.startP2PConnection({turnServer:s,cloudProxyServer:this._joinInfo.cloudProxyServer,isPreallocation:!0});try{var a;t(await this._p2pChannel.connect({iceParameters:{iceUfrag:"".concat(d,"_").concat(c),icePwd:"".concat(d,"_").concat(c)},dtlsParameters:{fingerprints:[{hashFunction:"sha-256",fingerprint:(a=B("FINGERPRINT"))!==null&&a!==void 0?a:o}]},candidates:r,rtpCapabilities:{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},setup:"active",cname:"o/i14u9pJrxRKAsu",preallocation:!0}))}catch(h){h.code&&h.code===O.EXCHANGE_SDP_FAILED&&await this._p2pChannel.startP2PConnection({turnServer:s,cloudProxyServer:this._joinInfo.cloudProxyServer},!0),i(h)}}}),this._gateway.on(Rr.VOS_FALLBACK,e=>{e==="fallback_hls"&&this.safeEmit(At.FALLBACK_TO_HLS,Cn.VOSERROR)}),this._gateway.on(Rr.RESET_SIGNAL,()=>{this._p2pChannel instanceof Tn&&this._p2pChannel.fallbackConnection(),this._handleGatewaySignalEvents()}),this._gateway.on(Rr.DATACHANNEL_FAILBACK,()=>{H.reportApiInvoke(this._sessionId,{name:ct.DATACHANNEL_FAILBACK,options:{},tag:bi.TRACER}).onSuccess(),this._joinGateway()})}_handleGatewaySignalEvents(){this._gateway.signal.on(Ke.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Ke.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Ke.ON_ADD_AUDIO_STREAM,e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.pt,e.uint_id,e.ortc)),this._gateway.signal.on(Ke.ON_ADD_VIDEO_STREAM,e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.pt,e.uint_id,e.ortc,e.rtxSsrcId)),this._gateway.signal.on(Ke.ON_REMOTE_DATASTREAM_UPDATE,e=>{this._handleUpdateDataChannel(e)}),this._gateway.signal.on(Ke.ON_REMOTE_FULL_DATASTREAM_INFO,e=>{this._handleUpdateDataChannel({added:e.datastreams||[],deleted:[]},!0)}),this._gateway.signal.on(Ke.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Ke.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Ke.MUTE_AUDIO,e=>this._handleMuteStream(e.uid,be.AUDIO,!0)),this._gateway.signal.on(Ke.UNMUTE_AUDIO,e=>this._handleMuteStream(e.uid,be.AUDIO,!1)),this._gateway.signal.on(Ke.MUTE_VIDEO,e=>this._handleMuteStream(e.uid,be.VIDEO,!0)),this._gateway.signal.on(Ke.UNMUTE_VIDEO,e=>this._handleMuteStream(e.uid,be.VIDEO,!1)),this._gateway.signal.on(Ke.RECEIVE_METADATA,e=>{const t=_a(e.metadata);this.safeEmit(At.RECEIVE_METADATA,e.uid,t)}),this._gateway.signal.on(Ke.ON_DATA_STREAM,async e=>{var t;if(!e)return;let i=_a(e.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&z(t=["aes-128-gcm2","aes-256-gcm2"]).call(t,this._encryptionMode)){if(e.payload.length<jf)throw new $(O.UNEXPECTED_RESPONSE,"payload length ".concat(e.payload.length," is less than header length ").concat(jf));i=await async function(s,a,c){const d=c.subarray(0,jf),l=d.slice(8,jf),h=(l[0]<<8)+l[1],p=(d[6]<<8)+d[7],f=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:s,tagLength:IU,additionalData:new Uint8Array(A_(h,2))},a,c.subarray(jf));return new Uint8Array(f).subarray(0,p)}(this._encryptDataStreamIv,this._encryptDataStreamKey,i)}let r=0;if(e.ordered||e.syncWithAudio){const o=this._p2pChannel.getStats(),s=this.remoteUsers.find(c=>c.uid===e.uid),a=o==null?void 0:o.audioRecv.find(c=>c.ssrc===(s==null?void 0:s._audioSSRC));r=a==null?void 0:a.jitterBufferMs}(r==null||Number.isNaN(r))&&(r=0),Cz(Wc(Wc({},e),{},{payload:i}),r,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(Ke.ON_CRYPT_ERROR,()=>{pa(()=>{I.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(At.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(Ke.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Ke.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{I.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,bt.TOKEN_EXPIRE),this.safeEmit(At.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(Ke.ON_STREAM_FALLBACK_UPDATE,e=>{I.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(At.STREAM_FALLBACK,e.stream_id,e.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(Ke.ENABLE_MULTI_STREAM,e=>{this._dualStreamMode===Oh.AUTO_SIMULCAST_STREAM&&this.enableDualStream().catch(t=>{I.debug("[".concat(this._clientId,"] set dual stream mode error"),t.toString())})}),this._gateway.signal.on(Ke.ON_PUBLISH_STREAM,e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),I.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))}),this._gateway.signal.on(Ke.ENABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)}),this._gateway.signal.on(Ke.DISABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)}),this._gateway.signal.on(le.REQUEST_TIMEOUT,(e,t)=>{if(this._joinInfo)switch(e){case Be.PUBLISH:{if(!t)return;const o=t.ortc;if(o){var i,r;const s=o.some(d=>{let{stream_type:l}=d;return l===_t.Audio}),a=o.some(d=>{let{stream_type:l}=d;return l!==_t.Audio}),c=o.some(d=>{let{stream_type:l}=d;return l===_t.Screen||l===_t.ScreenLow});t.state==="offer"&&H.publish(this._joinInfo.sid,{eventElapse:eo.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:O.TIMEOUT,audio:s,video:a,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:c,audioName:s?(i=o.find(d=>{let{stream_type:l}=d;return l===_t.Audio}))===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId.toString():void 0,videoName:a?(r=o.find(d=>{let{stream_type:l}=d;return l!==_t.Audio}))===null||r===void 0||(r=r.ssrcs[0])===null||r===void 0?void 0:r.ssrcId.toString():void 0})}break}case Be.SUBSCRIBE:t&&H.subscribe(this._joinInfo.sid,{succ:!1,ec:O.TIMEOUT,audio:t.stream_type===be.AUDIO,video:t.stream_type===be.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:eo.measureFromSubscribeStart(this.store.clientId,t.ssrcId),preSsrc:this._p2pChannel.isPreSubScribe(t.ssrcId)})}}),this._gateway.signal.on(Ke.ON_P2P_OK,e=>{this.uid,this._uid}),this._gateway.signal.on(Ke.ON_PUBLISHED_USER_LIST,e=>{if(e==null||!e.users)return;B("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter(r=>!Uu(r.string_id||r.stream_id,this.channelName)));const t=[],i=[];for(const r of e.users){let o=this._users.find(h=>h._uintid===r.stream_id);o?o._trust_in_room_=!0:(o=new ju(r.string_id||r.stream_id,r.stream_id),this._users.push(o),this.store.firstVideoFrameDecoded(o.uid,{userJoinNotify:Date.now()}),this.getListeners(At.PUBLISHED_USER_LIST).length===0&&(I.debug("[".concat(this._clientId,"] user online"),r.stream_id),this.safeEmit(At.USER_JOINED,o)));const s=gt.Audio&r.stream_type,a=(gt.Video|gt.LwoVideo)&r.stream_type,c=(65280&r.stream_type)!=0,d=s&&o.hasAudio,l=a&&o.hasVideo;a&&(o._trust_video_stream_added_state_=!0,o._video_added_=!0,o._videoSSRC=r.video_ssrc,o._rtxSsrcId=r.video_rtx),s&&(o._trust_audio_stream_added_state_=!0,o._audio_added_=!0,o._audioSSRC=r.audio_ssrc),s&&!d&&this.getListeners(At.PUBLISHED_USER_LIST).length===0&&(I.info("[".concat(this._clientId,"] remote user ").concat(o.uid," published audio")),this.safeEmit(At.USER_PUBLISHED,o,"audio")),a&&!l&&this.getListeners(At.PUBLISHED_USER_LIST).length===0&&(I.info("[".concat(this._clientId,"] remote user ").concat(o.uid," published video")),this.safeEmit(At.USER_PUBLISHED,o,"video")),(s&&!d||a&&!l||c)&&t.push(o),a&&this._p2pChannel.hasPendingRemoteMedia(o,"video")&&i.push({user:o,mediaType:"video"}),s&&this._p2pChannel.hasPendingRemoteMedia(o,"audio")&&i.push({user:o,mediaType:"audio"})}i.length>0&&(I.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(i.map(r=>"user: ".concat(r.user.uid,", mediaType: ").concat(r.mediaType)).join("; ")," ")),this.massSubscribe(i).catch(r=>{I.error("[".concat(this._clientId,"] mass resubscribe error"),r.toString())})),this.getListeners(At.PUBLISHED_USER_LIST).length>0?B("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=t:(I.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(t.map(r=>r.uid).join(", "))),this.safeEmit(At.PUBLISHED_USER_LIST,t)):I.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(t.map(r=>r.uid).join(", ")))}),this._gateway.signal.on(Ke.ON_RTP_CAPABILITY_CHANGE,e=>{const{video_codec:t}=e;if(this._p2pChannel instanceof Tn){if(this.role==="audience"&&B("UPDATE_RTP_CAP_IN_HOST"))return this._pendingRtpCapabilityChange=e,void I.debug("[".concat(this._clientId,"] no need to change rtp capability because of audience, params: ").concat(JSON.stringify(e)));this._p2pChannel.updateRemoteRTPCapabilities(t.map(i=>i.toLowerCase()).filter(i=>{var r;return z(r=Object.keys(Ph)).call(r,i)}))}}),this._gateway.signal.on(le.VOS_FALLBACK_PROMISE,async(e,t,i)=>{if(e==="FALLBACKCN"&&B("ENABLE_QUALITY_FALLBACK")){if(!this._joinInfo)return i(new $(O.UNEXPECTED_ERROR,"can not recover, no join info"));I.info("[".concat(this._clientId,"] try fallback to cn, start request new server info"));const o=this._joinInfo.apRequestDetail;try{this._joinInfo.apRequestDetail=e;const s=await FT(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||yr,this.store);if(B("QUALITY_FALLBACK_REHEARSAL"))return H.reportApiInvoke(this._sessionId,{name:ct.VOS_FALLBACK_CN,options:{cur:s.gatewayInfo.gatewayAddrs,prev:this._joinInfo.gatewayAddrs,is_done:!1},tag:bi.TRACER}).onSuccess(),this._joinInfo.apRequestDetail=o,void i();this._fallbackServerInfo=s,t()}catch(s){var r;const a=s==null||(r=s.data)===null||r===void 0?void 0:r.desc;B("QUALITY_FALLBACK_REHEARSAL")?(H.reportApiInvoke(this._sessionId,{name:ct.VOS_FALLBACK_CN,options:{cur:"failed, errorReason: "+a||"unknown",prev:this._joinInfo.gatewayAddrs,is_done:!1},tag:bi.TRACER}).onSuccess(),this._joinInfo.apRequestDetail=o):Array.isArray(a)&&z(a).call(a,"request downgrade fallback")&&this.safeEmit(At.FALLBACK_TO_HLS,Cn.AP_ERROR),i(s)}}else i()})}_handleP2PEvents(){this._gateway.signal.on(Ke.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(cr.PUBLISH,(e,t,i)=>{const{uid:r}=e;e.forEach(o=>{const{kind:s,ssrcs:a,mid:c,isMuted:d}=o;this._handleP2PAddAudioOrVideoStream(s,r,a[0].ssrcId,c);const l=this._users.find(h=>h.uid===r);return l&&this.store.useP2P?this._p2pChannel.mockSubscribe(l,s,a[0].ssrcId,c).then(()=>{t()}).catch(i):t(),this._handleMuteStream(r,s,!!d)})}),this._gateway.signal.on(cr.CALL,async(e,t,i)=>{if(this.store.useP2P)try{var r;t(await this._p2pChannel.startP2P({turnServer:(r=this._joinInfo)===null||r===void 0?void 0:r.turnServer},e))}catch(o){i(o)}}),this._gateway.signal.on(le.P2P_CONNECTION,async e=>{this.store.useP2P&&(await this._p2pChannel).p2pConnect(e)}),this._gateway.signal.on(cr.UNPUBLISH,async(e,t,i)=>{if(this.store.useP2P){const{unpubMsg:r,uid:o}=e,s=this._users.find(a=>a.uid===o);if(!s)return I.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(o)),void t();try{r.forEach(async a=>{let{stream_type:c}=a;const d=c===_t.Audio?be.AUDIO:be.VIDEO;await this._p2pChannel.unsubscribe(s,d),this._handleMuteStream(o,d,!0)}),t()}catch(a){i(a)}}}),this._gateway.signal.on(cr.CONTROL,async(e,t)=>{const{action:i}=e;switch(i){case Bh.MUTE_LOCAL_VIDEO:this._handleMuteStream(t,be.VIDEO,!0);break;case Bh.MUTE_LOCAL_AUDIO:this._handleMuteStream(t,be.AUDIO,!0);break;case Bh.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",t),this._handleMuteStream(t,be.VIDEO,!1);break;case Bh.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",t),this._handleMuteStream(t,be.AUDIO,!1)}}),this._gateway.signal.on(cr.RESTART_ICE,async(e,t,i)=>{if(this.store.useP2P)try{const{direction:r,iceParameter:o}=e;r!==Je.SEND_ONLY||o?t(await this._p2pChannel.restartICE(r,o)):(this._p2pChannel.handleDisconnect(r),t())}catch(r){i(r)}}),this._gateway.signal.on(cr.CANDIDATE,e=>{if(this.store.useP2P){const{candidate:t,direction:i}=e;this._p2pChannel.addRemoteCandidate(t,i)}}),this._p2pChannel.on(xe.RequestP2PRestartICE,async(e,t,i)=>{try{const{direction:r}=e;t(await this._gateway.sendExtensionMessage(cr.RESTART_ICE,e,r===Je.SEND_ONLY))}catch(r){i(r)}}),this._p2pChannel.on(xe.LocalCandidate,e=>{this._gateway.sendExtensionMessage(cr.CANDIDATE,JSON.stringify(e),!0)}),this._p2pChannel.on(xe.RequestP2PMuteLocal,async(e,t,i)=>{try{await this._gateway.sendExtensionMessage(cr.CONTROL,e,!0),t()}catch(r){i(r)}}),this._p2pChannel.on(xe.RequestP2PUnmuteRemote,async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(r){r.code===O.DISCONNECT_P2P?t():i(r)}else t()}),this._p2pChannel.on(xe.RequestP2PMuteRemote,async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(r){r.code===O.DISCONNECT_P2P?t():i(r)}else t()}),this._p2pChannel.on(xe.StateChange,(e,t)=>{t===we.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(xe.PeerConnectionStateChange,e=>{const t=this._peerConnectionState;e!==t&&(this.safeEmit(At.PEERCONNECTION_STATE_CHANGE,e,t),this._peerConnectionState=e)}),this._p2pChannel.on(xe.RequestMuteLocal,async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(r){r.code===O.DISCONNECT_P2P?t():i(r)}else t()}),this._p2pChannel.on(xe.RequestUnmuteLocal,async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(r){r.code===O.DISCONNECT_P2P?t():i(r)}else t()}),this._p2pChannel.on(xe.RequestRePublish,(e,t,i)=>{this.publish(e,!1).then(t).catch(i)}),this._p2pChannel.on(xe.RequestRePublishDataChannel,(e,t,i)=>{Z.all(e.map(async r=>{const o=await this._p2pChannel.publishDataChannel([r]);try{o.forEach(s=>{this._uid&&this._gateway.publishDataChannel(this._uid,s,!0)})}catch(s){if(s.code!==O.DISCONNECT_P2P)throw s}})).then(t).catch(i)}),this._p2pChannel.on(xe.RequestReSubscribe,async(e,t,i)=>{try{for(const{user:r,kind:o}of e)o===be.VIDEO?await this.subscribe(r,"video"):await this.subscribe(r,"audio");t()}catch(r){i(r)}}),this._p2pChannel.on(xe.RequestUpload,(e,t)=>{this._gateway.upload(e,t)}),this._p2pChannel.on(xe.RequestUploadStats,e=>{this._gateway.uploadWRTCStats(e)}),this._p2pChannel.on(xe.MediaReconnectStart,e=>{this.safeEmit(At.MEDIA_RECONNECT_START,e)}),this._p2pChannel.on(xe.MediaReconnectEnd,e=>{this.safeEmit(At.MEDIA_RECONNECT_END,e)}),this._p2pChannel.on(xe.NeedSignalRTT,e=>{e(this._gateway.getSignalRTT())}),this._p2pChannel.on(xe.RequestRestartICE,async e=>{if(this.store.useP2P)return;const t=await this._p2pChannel.restartICE(e),i=await t.next();if(i.done)return;const r=i.value;let o;try{o=await this._gateway.restartICE({iceParameters:r})}catch(a){return void t.throw(a)}const{iceParameters:s}=function(a){const c=a.iceParameters;return{iceParameters:{iceUfrag:c.iceUfrag,icePwd:c.icePwd}}}(o);await t.next({remoteIceParameters:s})}),this._p2pChannel.on(xe.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(xe.RequestReconnectPC,async()=>{var e;const{iceParameters:t,dtlsParameters:i,rtpCapabilities:r}=await this._p2pChannel.startP2PConnection({turnServer:(e=this._joinInfo)===null||e===void 0?void 0:e.turnServer}),{gatewayEstablishParams:o,gatewayAddress:s}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:i,rtpCapabilities:r}),a=JP(o,s);await this._p2pChannel.connect(a),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(xe.RequestUnpublishForReconnectPC,async(e,t,i)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(e,this._uid),t()):i()}),this._p2pChannel.on(xe.P2PLost,()=>{this.safeEmit(At.P2P_LOST,this.store.uid)}),this._p2pChannel.on(xe.UpdateVideoEncoder,e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)}),this._p2pChannel.on(xe.ConnectionTypeChange,e=>{this.safeEmit(At.IS_USING_CLOUD_PROXY,e),this._gateway.setUsingProxy(e)}),this._p2pChannel.on(xe.FirstVideoBufferReady,(e,t)=>{this.safeEmit(At.FIRST_VIDEO_BUFFER_READY,e,t)}),this._p2pChannel.on(xe.FirstVideoPreRender,(e,t)=>{this.safeEmit(At.FIRST_VIDEO_PRE_RENDER,e,t)}),this._p2pChannel.on(xe.RequestLowStreamParameter,e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(xe.QueryClientConnectionState,e=>{e(this.connectionState)}),this._p2pChannel.on(xe.AudioMetadata,e=>{this.safeEmit(At.AUDIO_METADATA,e)}),this._p2pChannel.on(xe.AudioPts,e=>{this.safeEmit(At.AUDIO_PTS,Number(e))})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if(!this._joinInfo||this.connectionState!=="CONNECTED")throw new $(O.INVALID_OPERATION,"[".concat(this._clientId,"] can not create content inspect, please join channel first"));if(this._inspect)throw new $(O.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));try{const i=(t={config:e},Fc("ContentInspect").create(t));this._inspect=i,this.handleVideoInspectEvents(i);const{appId:r,cname:o,sid:s,token:a,uid:c,cid:d,vid:l}=this._joinInfo;await i.init({appId:r,areaCode:"",cname:o,sid:s,token:a,uid:c,cid:d,vid:l?Number(l):0},yr)}catch(i){throw Array.isArray(i)?i[0]:i}var t}handleVideoInspectEvents(e){e.on(br.CONNECTION_STATE_CHANGE,(t,i)=>{if(this.safeEmit(At.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,t,i),i===Kn.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(At.CONTENT_INSPECT_ERROR,new $(O.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}}),e.on(br.INSPECT_RESULT,(t,i)=>{var r;if((i==null?void 0:i.code)===O.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return I.debug("Stop inspect content because that has left channel"),this==null||(r=this._inspect)===null||r===void 0||r.close(),void(this._inspect=void 0);this.safeEmit(At.CONTENT_INSPECT_RESULT,t,i)}),e.on(br.CLIENT_LOCAL_VIDEO_TRACK,t=>{t(this.localTracks.filter(i=>i.trackMediaType==="video")[0])})}async disableContentInspect(){if(!this._inspect)throw new $(O.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,t){if(xi(e,"enabled"),e){if(!t)throw new $(O.INVALID_PARAMS,"config is required");if(m2(t),!this._joinInfo)throw new $(O.INVALID_OPERATION,"can not create image moderation, please join channel first");try{if(this._moderation)this._moderation.updateConfig(t);else{const r=(i={config:t},Fc("ImageModeration").create(i));this._moderation=r,this.handleImageModerationEvents(r);const{appId:o,cname:s,sid:a,token:c,uid:d,cid:l,vid:h}=this._joinInfo;await r.init({appId:o,areaCode:"",cname:s,sid:a,token:c,uid:d,cid:l,vid:h?Number(h):0},yr)}}catch(r){throw Array.isArray(r)?r[0]:r}}else{var i;if(!this._moderation)throw new $(O.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(r){throw Array.isArray(r)?r[0]:r}}}handleImageModerationEvents(e){e.on(Os.CONNECTION_STATE_CHANGE,(t,i)=>{if(this.safeEmit(At.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,t,i),t===Yn.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new $(O.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}}),e.on(Os.CLIENT_LOCAL_VIDEO_TRACK,t=>{t(this.localTracks.filter(i=>i.trackMediaType==="video")[0])})}setP2PTransport(e){if(function(t){Rt(t,"transport",["default","auto","relay","sd-rtn"])}(e),this.mode!=="p2p")throw new $(O.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=e,I.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(e))}getJoinChannelServiceRecords(){return I.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){xi(e,"enabled"),F("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_setRteInfo(e,t){this.store.rteUrl=e,this.store.rteSid=t}_isPreRender(){return"isPreRender"in this._p2pChannel&&this._p2pChannel.isPreRender()}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}},Ae(Le.prototype,"leave",[VL],Object.getOwnPropertyDescriptor(Le.prototype,"leave"),Le.prototype),Ae(Le.prototype,"publish",[FL],Object.getOwnPropertyDescriptor(Le.prototype,"publish"),Le.prototype),Ae(Le.prototype,"unpublish",[BL],Object.getOwnPropertyDescriptor(Le.prototype,"unpublish"),Le.prototype),Ae(Le.prototype,"subscribe",[jL],Object.getOwnPropertyDescriptor(Le.prototype,"subscribe"),Le.prototype),Ae(Le.prototype,"presubscribe",[GL],Object.getOwnPropertyDescriptor(Le.prototype,"presubscribe"),Le.prototype),Ae(Le.prototype,"massSubscribe",[WL],Object.getOwnPropertyDescriptor(Le.prototype,"massSubscribe"),Le.prototype),Ae(Le.prototype,"unsubscribe",[HL],Object.getOwnPropertyDescriptor(Le.prototype,"unsubscribe"),Le.prototype),Ae(Le.prototype,"massUnsubscribe",[KL],Object.getOwnPropertyDescriptor(Le.prototype,"massUnsubscribe"),Le.prototype),Ae(Le.prototype,"setLowStreamParameter",[YL],Object.getOwnPropertyDescriptor(Le.prototype,"setLowStreamParameter"),Le.prototype),Ae(Le.prototype,"setDualStreamMode",[zL],Object.getOwnPropertyDescriptor(Le.prototype,"setDualStreamMode"),Le.prototype),Ae(Le.prototype,"enableDualStream",[qL],Object.getOwnPropertyDescriptor(Le.prototype,"enableDualStream"),Le.prototype),Ae(Le.prototype,"disableDualStream",[XL],Object.getOwnPropertyDescriptor(Le.prototype,"disableDualStream"),Le.prototype),Ae(Le.prototype,"setClientRole",[JL],Object.getOwnPropertyDescriptor(Le.prototype,"setClientRole"),Le.prototype),Ae(Le.prototype,"_setClientRoleOptions",[QL],Object.getOwnPropertyDescriptor(Le.prototype,"_setClientRoleOptions"),Le.prototype),Ae(Le.prototype,"setProxyServer",[ZL],Object.getOwnPropertyDescriptor(Le.prototype,"setProxyServer"),Le.prototype),Ae(Le.prototype,"setTurnServer",[$L],Object.getOwnPropertyDescriptor(Le.prototype,"setTurnServer"),Le.prototype),Ae(Le.prototype,"setLicense",[ek],Object.getOwnPropertyDescriptor(Le.prototype,"setLicense"),Le.prototype),Ae(Le.prototype,"startProxyServer",[tk],Object.getOwnPropertyDescriptor(Le.prototype,"startProxyServer"),Le.prototype),Ae(Le.prototype,"stopProxyServer",[ik],Object.getOwnPropertyDescriptor(Le.prototype,"stopProxyServer"),Le.prototype),Ae(Le.prototype,"setLocalAccessPointsV2",[rk],Object.getOwnPropertyDescriptor(Le.prototype,"setLocalAccessPointsV2"),Le.prototype),Ae(Le.prototype,"setLocalAccessPoints",[nk],Object.getOwnPropertyDescriptor(Le.prototype,"setLocalAccessPoints"),Le.prototype),Ae(Le.prototype,"setRemoteDefaultVideoStreamType",[ok],Object.getOwnPropertyDescriptor(Le.prototype,"setRemoteDefaultVideoStreamType"),Le.prototype),Ae(Le.prototype,"setRemoteVideoStreamType",[sk],Object.getOwnPropertyDescriptor(Le.prototype,"setRemoteVideoStreamType"),Le.prototype),Ae(Le.prototype,"setStreamFallbackOption",[ak],Object.getOwnPropertyDescriptor(Le.prototype,"setStreamFallbackOption"),Le.prototype),Ae(Le.prototype,"setEncryptionConfig",[ck],Object.getOwnPropertyDescriptor(Le.prototype,"setEncryptionConfig"),Le.prototype),Ae(Le.prototype,"renewToken",[dk],Object.getOwnPropertyDescriptor(Le.prototype,"renewToken"),Le.prototype),Ae(Le.prototype,"enableAudioVolumeIndicator",[lk],Object.getOwnPropertyDescriptor(Le.prototype,"enableAudioVolumeIndicator"),Le.prototype),Ae(Le.prototype,"startLiveStreaming",[uk],Object.getOwnPropertyDescriptor(Le.prototype,"startLiveStreaming"),Le.prototype),Ae(Le.prototype,"setLiveTranscoding",[hk],Object.getOwnPropertyDescriptor(Le.prototype,"setLiveTranscoding"),Le.prototype),Ae(Le.prototype,"stopLiveStreaming",[pk],Object.getOwnPropertyDescriptor(Le.prototype,"stopLiveStreaming"),Le.prototype),Ae(Le.prototype,"startChannelMediaRelay",[_k],Object.getOwnPropertyDescriptor(Le.prototype,"startChannelMediaRelay"),Le.prototype),Ae(Le.prototype,"updateChannelMediaRelay",[fk],Object.getOwnPropertyDescriptor(Le.prototype,"updateChannelMediaRelay"),Le.prototype),Ae(Le.prototype,"stopChannelMediaRelay",[mk],Object.getOwnPropertyDescriptor(Le.prototype,"stopChannelMediaRelay"),Le.prototype),Ae(Le.prototype,"sendCustomReportMessage",[Ek],Object.getOwnPropertyDescriptor(Le.prototype,"sendCustomReportMessage"),Le.prototype),Ae(Le.prototype,"pickSVCLayer",[gk],Object.getOwnPropertyDescriptor(Le.prototype,"pickSVCLayer"),Le.prototype),Ae(Le.prototype,"setRTMConfig",[Sk],Object.getOwnPropertyDescriptor(Le.prototype,"setRTMConfig"),Le.prototype),Ae(Le.prototype,"enableContentInspect",[Tk],Object.getOwnPropertyDescriptor(Le.prototype,"enableContentInspect"),Le.prototype),Ae(Le.prototype,"disableContentInspect",[Rk],Object.getOwnPropertyDescriptor(Le.prototype,"disableContentInspect"),Le.prototype),Ae(Le.prototype,"setImageModeration",[vk],Object.getOwnPropertyDescriptor(Le.prototype,"setImageModeration"),Le.prototype),Ae(Le.prototype,"setP2PTransport",[Ck],Object.getOwnPropertyDescriptor(Le.prototype,"setP2PTransport"),Le.prototype),Ae(Le.prototype,"getJoinChannelServiceRecords",[yk],Object.getOwnPropertyDescriptor(Le.prototype,"getJoinChannelServiceRecords"),Le.prototype),Ae(Le.prototype,"setPublishAudioFilterEnabled",[Pe],Object.getOwnPropertyDescriptor(Le.prototype,"setPublishAudioFilterEnabled"),Le.prototype),Le);function S2(){var e;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const i=li(5,"client-"),r=H.reportApiInvoke(null,{id:i,name:ct.CREATE_CLIENT,options:[t],tag:bi.TRACER});try{(function(o){Rt(o.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),Rt(o.mode,"config.mode",["rtc","live","p2p"]),o.audioCodec!==void 0&&Rt(o.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),o.proxyServer!==void 0&&Ar(o.proxyServer,"config.proxyServer",1,1e4),o.turnServer!==void 0&&I_(o.turnServer),o.httpRetryConfig!==void 0&&SU(o.httpRetryConfig),o.websocketRetryConfig!==void 0&&SU(o.websocketRetryConfig)})(t)}catch(o){throw r.onError(o),o}return(mv(16,0,!0)||Cu(16,0,!0))&&(t.codec==="vp9"&&(t.codec="vp8",I.debug("browser not support vp9, force use vp8")),F("UNSUPPORTED_VIDEO_CODEC",["vp9"])),t.audioCodec===void 0&&(t.audioCodec="opus"),r.onSuccess(),new g2(Wc(Wc({forceWaitGatewayResponse:!0},t),{},{role:z(e=["rtc","p2p"]).call(e,t.mode)?"host":t.role||"audience"}),i)}function oR(){let e=!1;const t=ii();return(t.name===di.CHROME&&Number(t.version)>=58&&(tc.engine.name!=="WebKit"||function(){const i=ii();if(wc()){if(i.os===pt.MAC_OS)return!0;if(i.os===pt.IOS){const r=tc.os.version&&tc.os.version.split(".");if(r&&Number(r[0])===14&&r[1]&&Number(r[1])>=3||r&&Number(r[0])>14)return!0}}return!1}())||t.name===di.FIREFOX&&Number(t.version)>=56||t.name===di.OPERA&&Number(t.version)>=45||t.name===di.SAFARI&&Number(t.version)>=11||t.name==="WebKit"&&(Dr()||rc())&&t.osVersion&&Number(t.osVersion.split(".")[0])>=11||ON()||ii().name===di.QQ)&&(e=!0),e}class Am{constructor(t,i){M(this,"id",0),M(this,"element",void 0),M(this,"peerPair",void 0),M(this,"context",void 0),M(this,"audioPlayerElement",void 0),M(this,"audioTrack",void 0),Am.count+=1,this.id=Am.count,this.element=t,this.context=i}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=t=>{const i=document.createElement("audio");i.srcObject=new MediaStream([t.track]),i.play(),this.audioPlayerElement=i}}async switchSdp(){if(!this.peerPair)return;const t=async(r,o)=>{const s=o==="offer"?await r.createOffer():await r.createAnswer();return await r.setLocalDescription(s),r.iceGatheringState==="complete"?r.localDescription:new Z(a=>{r.onicegatheringstatechange=()=>{r.iceGatheringState==="complete"&&a(r.localDescription)}})},i=async(r,o)=>await r.setRemoteDescription(o);try{const r=await t(this.peerPair[0],"offer");await i(this.peerPair[1],r);const o=await t(this.peerPair[1],"answer");await i(this.peerPair[0],o)}catch(r){throw new $(O.LOCAL_AEC_ERROR,r.toString()).print()}}async getTracksFromMediaElement(t){if(this.audioTrack)return this.audioTrack;let i;try{t instanceof HTMLVideoElement&&(t.captureStream?t.captureStream():t.mozCaptureStream()),i=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(t).connect(i)}catch(o){throw new $(O.LOCAL_AEC_ERROR,o.toString()).print()}if(!i)throw new $(O.LOCAL_AEC_ERROR,"no dest node when local aec").print();const r=i.stream.getAudioTracks()[0];return this.audioTrack=r,r}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const t=this.element,i=await this.getTracksFromMediaElement(t);this.peerPair&&this.peerPair[0].addTrack(i),await this.switchSdp()}close(){I.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(t=>{t.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}var sR,MC;M(Am,"count",0);const Oz=window.AudioContext||window.webkitAudioContext,T2=new(sR=_e({report:H}),Ae((MC=class{constructor(){M(this,"units",[]),M(this,"context",void 0)}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return I.debug("the system does not need to process local aec"),-1;this.context||(this.context=new Oz);let t=this.units.find(i=>i&&i.getElement()===e);return t||(t=new Am(e,this.context),this.units.push(t)),t.startEchoCancellation(),I.debug("start processing local audio echo cancellation, id is",t.id),t.id}_doesEnvironmentNeedAEC(){return ii().name!==di.SAFARI}}).prototype,"processExternalMediaAEC",[sR],Object.getOwnPropertyDescriptor(MC.prototype,"processExternalMediaAEC"),MC.prototype),MC);function Ik(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function UC(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Ik(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ik(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}const xC=window||document;function R2(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!xC)return;const i=n._cspEventHandlerPointer;if(i&&t)return void console.error(i,t);const r=o=>{if(!(o&&o.blockedURI&&(n.onSecurityPolicyViolation||n.getListeners($n.SECURITY_POLICY_VIOLATION).length>0)))return;const s=o.blockedURI;B("CSP_DETECTED_HOSTNAME_LIST").some(a=>z(s).call(s,a))&&(n.onSecurityPolicyViolation&&typeof n.onSecurityPolicyViolation=="function"&&n.onSecurityPolicyViolation(o),n.getListeners($n.SECURITY_POLICY_VIOLATION).length>0&&n.safeEmit($n.SECURITY_POLICY_VIOLATION,o))};i&&xC.removeEventListener("securitypolicyviolation",i),(t||e&&typeof e=="function"||n.getListeners($n.SECURITY_POLICY_VIOLATION).length>0)&&xC.addEventListener("securitypolicyviolation",r),n._cspEventHandlerPointer=r}var Nz=me,v2=gS,C2=RegExp.prototype,Vo=function(e){return e===C2||Nz(C2,e)?v2(e):e.flags},On=A(Vo);function zh(e){let t=e.length;for(;--t>=0;)e[t]=0}const VC=256,wm=286,qu=30,G_=15,bm=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),FC=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),y2=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),Ul=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),pc=new Array(576);zh(pc);const Xu=new Array(60);zh(Xu);const Ju=new Array(512);zh(Ju);const W_=new Array(256);zh(W_);const Om=new Array(29);zh(Om);const Nm=new Array(qu);function BC(e,t,i,r,o){this.static_tree=e,this.extra_bits=t,this.extra_base=i,this.elems=r,this.max_length=o,this.has_stree=e&&e.length}let Ak,wk,jC;function GC(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}zh(Nm);const Dm=e=>e<256?Ju[e]:Ju[256+(e>>>7)],Jo=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},Xn=(e,t,i)=>{e.bi_valid>16-i?(e.bi_buf|=t<<e.bi_valid&65535,Jo(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=i-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=i)},Zd=(e,t,i)=>{Xn(e,i[2*t],i[2*t+1])},bk=(e,t)=>{let i=0;do i|=1&e,e>>>=1,i<<=1;while(--t>0);return i>>>1},Ok=(e,t,i)=>{const r=new Array(16);let o,s,a=0;for(o=1;o<=G_;o++)a=a+i[o-1]<<1,r[o]=a;for(s=0;s<=t;s++){let c=e[2*s+1];c!==0&&(e[2*s]=bk(r[c]++,c))}},Nk=e=>{let t;for(t=0;t<wm;t++)e.dyn_ltree[2*t]=0;for(t=0;t<qu;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},Dk=e=>{e.bi_valid>8?Jo(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},WC=(e,t,i,r)=>{const o=2*t,s=2*i;return e[o]<e[s]||e[o]===e[s]&&r[t]<=r[i]},HC=(e,t,i)=>{const r=e.heap[i];let o=i<<1;for(;o<=e.heap_len&&(o<e.heap_len&&WC(t,e.heap[o+1],e.heap[o],e.depth)&&o++,!WC(t,r,e.heap[o],e.depth));)e.heap[i]=e.heap[o],i=o,o<<=1;e.heap[i]=r},KC=(e,t,i)=>{let r,o,s,a,c=0;if(e.sym_next!==0)do r=255&e.pending_buf[e.sym_buf+c++],r+=(255&e.pending_buf[e.sym_buf+c++])<<8,o=e.pending_buf[e.sym_buf+c++],r===0?Zd(e,o,t):(s=W_[o],Zd(e,s+VC+1,t),a=bm[s],a!==0&&(o-=Om[s],Xn(e,o,a)),r--,s=Dm(r),Zd(e,s,i),a=FC[s],a!==0&&(r-=Nm[s],Xn(e,r,a)));while(c<e.sym_next);Zd(e,256,t)},YC=(e,t)=>{const i=t.dyn_tree,r=t.stat_desc.static_tree,o=t.stat_desc.has_stree,s=t.stat_desc.elems;let a,c,d,l=-1;for(e.heap_len=0,e.heap_max=573,a=0;a<s;a++)i[2*a]!==0?(e.heap[++e.heap_len]=l=a,e.depth[a]=0):i[2*a+1]=0;for(;e.heap_len<2;)d=e.heap[++e.heap_len]=l<2?++l:0,i[2*d]=1,e.depth[d]=0,e.opt_len--,o&&(e.static_len-=r[2*d+1]);for(t.max_code=l,a=e.heap_len>>1;a>=1;a--)HC(e,i,a);d=s;do a=e.heap[1],e.heap[1]=e.heap[e.heap_len--],HC(e,i,1),c=e.heap[1],e.heap[--e.heap_max]=a,e.heap[--e.heap_max]=c,i[2*d]=i[2*a]+i[2*c],e.depth[d]=(e.depth[a]>=e.depth[c]?e.depth[a]:e.depth[c])+1,i[2*a+1]=i[2*c+1]=d,e.heap[1]=d++,HC(e,i,1);while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((h,p)=>{const f=p.dyn_tree,m=p.max_code,g=p.stat_desc.static_tree,S=p.stat_desc.has_stree,T=p.stat_desc.extra_bits,C=p.stat_desc.extra_base,b=p.stat_desc.max_length;let D,x,k,V,W,K,J=0;for(V=0;V<=G_;V++)h.bl_count[V]=0;for(f[2*h.heap[h.heap_max]+1]=0,D=h.heap_max+1;D<573;D++)x=h.heap[D],V=f[2*f[2*x+1]+1]+1,V>b&&(V=b,J++),f[2*x+1]=V,x>m||(h.bl_count[V]++,W=0,x>=C&&(W=T[x-C]),K=f[2*x],h.opt_len+=K*(V+W),S&&(h.static_len+=K*(g[2*x+1]+W)));if(J!==0){do{for(V=b-1;h.bl_count[V]===0;)V--;h.bl_count[V]--,h.bl_count[V+1]+=2,h.bl_count[b]--,J-=2}while(J>0);for(V=b;V!==0;V--)for(x=h.bl_count[V];x!==0;)k=h.heap[--D],k>m||(f[2*k+1]!==V&&(h.opt_len+=(V-f[2*k+1])*f[2*k],f[2*k+1]=V),x--)}})(e,t),Ok(i,l,e.bl_count)},Pk=(e,t,i)=>{let r,o,s=-1,a=t[1],c=0,d=7,l=4;for(a===0&&(d=138,l=3),t[2*(i+1)+1]=65535,r=0;r<=i;r++)o=a,a=t[2*(r+1)+1],++c<d&&o===a||(c<l?e.bl_tree[2*o]+=c:o!==0?(o!==s&&e.bl_tree[2*o]++,e.bl_tree[32]++):c<=10?e.bl_tree[34]++:e.bl_tree[36]++,c=0,s=o,a===0?(d=138,l=3):o===a?(d=6,l=3):(d=7,l=4))},Lk=(e,t,i)=>{let r,o,s=-1,a=t[1],c=0,d=7,l=4;for(a===0&&(d=138,l=3),r=0;r<=i;r++)if(o=a,a=t[2*(r+1)+1],!(++c<d&&o===a)){if(c<l)do Zd(e,o,e.bl_tree);while(--c!=0);else o!==0?(o!==s&&(Zd(e,o,e.bl_tree),c--),Zd(e,16,e.bl_tree),Xn(e,c-3,2)):c<=10?(Zd(e,17,e.bl_tree),Xn(e,c-3,3)):(Zd(e,18,e.bl_tree),Xn(e,c-11,7));c=0,s=o,a===0?(d=138,l=3):o===a?(d=6,l=3):(d=7,l=4)}};let kk=!1;const I2=(e,t,i,r)=>{Xn(e,0+(r?1:0),3),Dk(e),Jo(e,i),Jo(e,~i),i&&e.pending_buf.set(e.window.subarray(t,t+i),e.pending),e.pending+=i};var Dz=e=>{kk||((()=>{let t,i,r,o,s;const a=new Array(16);for(r=0,o=0;o<28;o++)for(Om[o]=r,t=0;t<1<<bm[o];t++)W_[r++]=o;for(W_[r-1]=o,s=0,o=0;o<16;o++)for(Nm[o]=s,t=0;t<1<<FC[o];t++)Ju[s++]=o;for(s>>=7;o<qu;o++)for(Nm[o]=s<<7,t=0;t<1<<FC[o]-7;t++)Ju[256+s++]=o;for(i=0;i<=G_;i++)a[i]=0;for(t=0;t<=143;)pc[2*t+1]=8,t++,a[8]++;for(;t<=255;)pc[2*t+1]=9,t++,a[9]++;for(;t<=279;)pc[2*t+1]=7,t++,a[7]++;for(;t<=287;)pc[2*t+1]=8,t++,a[8]++;for(Ok(pc,287,a),t=0;t<qu;t++)Xu[2*t+1]=5,Xu[2*t]=bk(t,5);Ak=new BC(pc,bm,257,wm,G_),wk=new BC(Xu,FC,0,qu,G_),jC=new BC(new Array(0),y2,0,19,7)})(),kk=!0),e.l_desc=new GC(e.dyn_ltree,Ak),e.d_desc=new GC(e.dyn_dtree,wk),e.bl_desc=new GC(e.bl_tree,jC),e.bi_buf=0,e.bi_valid=0,Nk(e)},Pz=(e,t,i,r)=>{let o,s,a=0;e.level>0?(e.strm.data_type===2&&(e.strm.data_type=(c=>{let d,l=4093624447;for(d=0;d<=31;d++,l>>>=1)if(1&l&&c.dyn_ltree[2*d]!==0)return 0;if(c.dyn_ltree[18]!==0||c.dyn_ltree[20]!==0||c.dyn_ltree[26]!==0)return 1;for(d=32;d<VC;d++)if(c.dyn_ltree[2*d]!==0)return 1;return 0})(e)),YC(e,e.l_desc),YC(e,e.d_desc),a=(c=>{let d;for(Pk(c,c.dyn_ltree,c.l_desc.max_code),Pk(c,c.dyn_dtree,c.d_desc.max_code),YC(c,c.bl_desc),d=18;d>=3&&c.bl_tree[2*Ul[d]+1]===0;d--);return c.opt_len+=3*(d+1)+5+5+4,d})(e),o=e.opt_len+3+7>>>3,s=e.static_len+3+7>>>3,s<=o&&(o=s)):o=s=i+5,i+4<=o&&t!==-1?I2(e,t,i,r):e.strategy===4||s===o?(Xn(e,2+(r?1:0),3),KC(e,pc,Xu)):(Xn(e,4+(r?1:0),3),((c,d,l,h)=>{let p;for(Xn(c,d-257,5),Xn(c,l-1,5),Xn(c,h-4,4),p=0;p<h;p++)Xn(c,c.bl_tree[2*Ul[p]+1],3);Lk(c,c.dyn_ltree,d-1),Lk(c,c.dyn_dtree,l-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,a+1),KC(e,e.dyn_ltree,e.dyn_dtree)),Nk(e),r&&Dk(e)},Lz=(e,t,i)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=i,t===0?e.dyn_ltree[2*i]++:(e.matches++,t--,e.dyn_ltree[2*(W_[i]+VC+1)]++,e.dyn_dtree[2*Dm(t)]++),e.sym_next===e.sym_end),kz=e=>{Xn(e,2,3),Zd(e,256,pc),(t=>{t.bi_valid===16?(Jo(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)})(e)},aR={_tr_init:Dz,_tr_stored_block:I2,_tr_flush_block:Pz,_tr_tally:Lz,_tr_align:kz},cR=(e,t,i,r)=>{let o=65535&e|0,s=e>>>16&65535|0,a=0;for(;i!==0;){a=i>2e3?2e3:i,i-=a;do o=o+t[r++]|0,s=s+o|0;while(--a);o%=65521,s%=65521}return o|s<<16|0};const Qo=new Uint32Array((()=>{let e,t=[];for(var i=0;i<256;i++){e=i;for(var r=0;r<8;r++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t})());var Nn=(e,t,i,r)=>{const o=Qo,s=r+i;e^=-1;for(let a=r;a<s;a++)e=e>>>8^o[255&(e^t[a])];return-1^e},xl={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},zC={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:Mk,_tr_stored_block:Uk,_tr_flush_block:qh,_tr_tally:Xh,_tr_align:Jh}=aR,{Z_NO_FLUSH:Qh,Z_PARTIAL_FLUSH:Mz,Z_FULL_FLUSH:Hc,Z_FINISH:_c,Z_BLOCK:Zo,Z_OK:$o,Z_STREAM_END:$d,Z_STREAM_ERROR:Vl,Z_DATA_ERROR:xk,Z_BUF_ERROR:Vk,Z_DEFAULT_COMPRESSION:Uz,Z_FILTERED:qC,Z_HUFFMAN_ONLY:XC,Z_RLE:xz,Z_FIXED:Vz,Z_DEFAULT_STRATEGY:Fz,Z_UNKNOWN:JC,Z_DEFLATED:Pm}=zC,Fk=286,Bz=30,jz=19,Gz=2*Fk+1,H_=15,Ps=258,oa=262,Kc=42,el=113,tl=666,Zh=(e,t)=>(e.msg=xl[t],t),Qu=e=>2*e-(e>4?9:0),$h=e=>{let t=e.length;for(;--t>=0;)e[t]=0},ep=e=>{let t,i,r,o=e.w_size;t=e.hash_size,r=t;do i=e.head[--r],e.head[r]=i>=o?i-o:0;while(--t);t=o,r=t;do i=e.prev[--r],e.prev[r]=i>=o?i-o:0;while(--t)};let To=(e,t,i)=>(t<<e.hash_shift^i)&e.hash_mask;const Rn=e=>{const t=e.state;let i=t.pending;i>e.avail_out&&(i=e.avail_out),i!==0&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+i),e.next_out),e.next_out+=i,t.pending_out+=i,e.total_out+=i,e.avail_out-=i,t.pending-=i,t.pending===0&&(t.pending_out=0))},Oi=(e,t)=>{qh(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,Rn(e.strm)},dr=(e,t)=>{e.pending_buf[e.pending++]=t},K_=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},QC=(e,t,i,r)=>{let o=e.avail_in;return o>r&&(o=r),o===0?0:(e.avail_in-=o,t.set(e.input.subarray(e.next_in,e.next_in+o),i),e.state.wrap===1?e.adler=cR(e.adler,t,o,i):e.state.wrap===2&&(e.adler=Nn(e.adler,t,o,i)),e.next_in+=o,e.total_in+=o,o)},Y_=(e,t)=>{let i,r,o=e.max_chain_length,s=e.strstart,a=e.prev_length,c=e.nice_match;const d=e.strstart>e.w_size-oa?e.strstart-(e.w_size-oa):0,l=e.window,h=e.w_mask,p=e.prev,f=e.strstart+Ps;let m=l[s+a-1],g=l[s+a];e.prev_length>=e.good_match&&(o>>=2),c>e.lookahead&&(c=e.lookahead);do if(i=t,l[i+a]===g&&l[i+a-1]===m&&l[i]===l[s]&&l[++i]===l[s+1]){s+=2,i++;do;while(l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&s<f);if(r=Ps-(f-s),s=f-Ps,r>a){if(e.match_start=t,a=r,r>=c)break;m=l[s+a-1],g=l[s+a]}}while((t=p[t&h])>d&&--o!=0);return a<=e.lookahead?a:e.lookahead},z_=e=>{const t=e.w_size;let i,r,o;do{if(r=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-oa)&&(e.window.set(e.window.subarray(t,t+t-r),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),ep(e),r+=t),e.strm.avail_in===0)break;if(i=QC(e.strm,e.window,e.strstart+e.lookahead,r),e.lookahead+=i,e.lookahead+e.insert>=3)for(o=e.strstart-e.insert,e.ins_h=e.window[o],e.ins_h=To(e,e.ins_h,e.window[o+1]);e.insert&&(e.ins_h=To(e,e.ins_h,e.window[o+3-1]),e.prev[o&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=o,o++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<oa&&e.strm.avail_in!==0)},ZC=(e,t)=>{let i,r,o,s=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,a=0,c=e.strm.avail_in;do{if(i=65535,o=e.bi_valid+42>>3,e.strm.avail_out<o||(o=e.strm.avail_out-o,r=e.strstart-e.block_start,i>r+e.strm.avail_in&&(i=r+e.strm.avail_in),i>o&&(i=o),i<s&&(i===0&&t!==_c||t===Qh||i!==r+e.strm.avail_in)))break;a=t===_c&&i===r+e.strm.avail_in?1:0,Uk(e,0,0,a),e.pending_buf[e.pending-4]=i,e.pending_buf[e.pending-3]=i>>8,e.pending_buf[e.pending-2]=~i,e.pending_buf[e.pending-1]=~i>>8,Rn(e.strm),r&&(r>i&&(r=i),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+r),e.strm.next_out),e.strm.next_out+=r,e.strm.avail_out-=r,e.strm.total_out+=r,e.block_start+=r,i-=r),i&&(QC(e.strm,e.strm.output,e.strm.next_out,i),e.strm.next_out+=i,e.strm.avail_out-=i,e.strm.total_out+=i)}while(a===0);return c-=e.strm.avail_in,c&&(c>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=c&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-c,e.strm.next_in),e.strstart),e.strstart+=c,e.insert+=c>e.w_size-e.insert?e.w_size-e.insert:c),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),a?4:t!==Qh&&t!==_c&&e.strm.avail_in===0&&e.strstart===e.block_start?2:(o=e.window_size-e.strstart,e.strm.avail_in>o&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,o+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),o>e.strm.avail_in&&(o=e.strm.avail_in),o&&(QC(e.strm,e.window,e.strstart,o),e.strstart+=o,e.insert+=o>e.w_size-e.insert?e.w_size-e.insert:o),e.high_water<e.strstart&&(e.high_water=e.strstart),o=e.bi_valid+42>>3,o=e.pending_buf_size-o>65535?65535:e.pending_buf_size-o,s=o>e.w_size?e.w_size:o,r=e.strstart-e.block_start,(r>=s||(r||t===_c)&&t!==Qh&&e.strm.avail_in===0&&r<=o)&&(i=r>o?o:r,a=t===_c&&e.strm.avail_in===0&&i===r?1:0,Uk(e,e.block_start,i,a),e.block_start+=i,Rn(e.strm)),a?3:1)},tp=(e,t)=>{let i,r;for(;;){if(e.lookahead<oa){if(z_(e),e.lookahead<oa&&t===Qh)return 1;if(e.lookahead===0)break}if(i=0,e.lookahead>=3&&(e.ins_h=To(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),i!==0&&e.strstart-i<=e.w_size-oa&&(e.match_length=Y_(e,i)),e.match_length>=3)if(r=Xh(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do e.strstart++,e.ins_h=To(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(--e.match_length!=0);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=To(e,e.ins_h,e.window[e.strstart+1]);else r=Xh(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(r&&(Oi(e,!1),e.strm.avail_out===0))return 1}return e.insert=e.strstart<2?e.strstart:2,t===_c?(Oi(e,!0),e.strm.avail_out===0?3:4):e.sym_next&&(Oi(e,!1),e.strm.avail_out===0)?1:2},sa=(e,t)=>{let i,r,o;for(;;){if(e.lookahead<oa){if(z_(e),e.lookahead<oa&&t===Qh)return 1;if(e.lookahead===0)break}if(i=0,e.lookahead>=3&&(e.ins_h=To(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,i!==0&&e.prev_length<e.max_lazy_match&&e.strstart-i<=e.w_size-oa&&(e.match_length=Y_(e,i),e.match_length<=5&&(e.strategy===qC||e.match_length===3&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){o=e.strstart+e.lookahead-3,r=Xh(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=o&&(e.ins_h=To(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(--e.prev_length!=0);if(e.match_available=0,e.match_length=2,e.strstart++,r&&(Oi(e,!1),e.strm.avail_out===0))return 1}else if(e.match_available){if(r=Xh(e,0,e.window[e.strstart-1]),r&&Oi(e,!1),e.strstart++,e.lookahead--,e.strm.avail_out===0)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(r=Xh(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===_c?(Oi(e,!0),e.strm.avail_out===0?3:4):e.sym_next&&(Oi(e,!1),e.strm.avail_out===0)?1:2};function Na(e,t,i,r,o){this.good_length=e,this.max_lazy=t,this.nice_length=i,this.max_chain=r,this.func=o}const dR=[new Na(0,0,0,0,ZC),new Na(4,4,8,4,tp),new Na(4,5,16,8,tp),new Na(4,6,32,32,tp),new Na(4,4,16,16,sa),new Na(8,16,32,32,sa),new Na(8,16,128,128,sa),new Na(8,32,128,256,sa),new Na(32,128,258,1024,sa),new Na(32,258,258,4096,sa)];function lR(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Pm,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*Gz),this.dyn_dtree=new Uint16Array(2*(2*Bz+1)),this.bl_tree=new Uint16Array(2*(2*jz+1)),$h(this.dyn_ltree),$h(this.dyn_dtree),$h(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(H_+1),this.heap=new Uint16Array(2*Fk+1),$h(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*Fk+1),$h(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Lm=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.status!==Kc&&t.status!==57&&t.status!==69&&t.status!==73&&t.status!==91&&t.status!==103&&t.status!==el&&t.status!==tl?1:0},Bk=e=>{if(Lm(e))return Zh(e,Vl);e.total_in=e.total_out=0,e.data_type=JC;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap===2?57:t.wrap?Kc:el,e.adler=t.wrap===2?0:1,t.last_flush=-2,Mk(t),$o},jk=e=>{const t=Bk(e);return t===$o&&(i=>{i.window_size=2*i.w_size,$h(i.head),i.max_lazy_match=dR[i.level].max_lazy,i.good_match=dR[i.level].good_length,i.nice_match=dR[i.level].nice_length,i.max_chain_length=dR[i.level].max_chain,i.strstart=0,i.block_start=0,i.lookahead=0,i.insert=0,i.match_length=i.prev_length=2,i.match_available=0,i.ins_h=0})(e.state),t},A2=(e,t,i,r,o,s)=>{if(!e)return Vl;let a=1;if(t===Uz&&(t=6),r<0?(a=0,r=-r):r>15&&(a=2,r-=16),o<1||o>9||i!==Pm||r<8||r>15||t<0||t>9||s<0||s>Vz||r===8&&a!==1)return Zh(e,Vl);r===8&&(r=9);const c=new lR;return e.state=c,c.strm=e,c.status=Kc,c.wrap=a,c.gzhead=null,c.w_bits=r,c.w_size=1<<c.w_bits,c.w_mask=c.w_size-1,c.hash_bits=o+7,c.hash_size=1<<c.hash_bits,c.hash_mask=c.hash_size-1,c.hash_shift=~~((c.hash_bits+3-1)/3),c.window=new Uint8Array(2*c.w_size),c.head=new Uint16Array(c.hash_size),c.prev=new Uint16Array(c.w_size),c.lit_bufsize=1<<o+6,c.pending_buf_size=4*c.lit_bufsize,c.pending_buf=new Uint8Array(c.pending_buf_size),c.sym_buf=c.lit_bufsize,c.sym_end=3*(c.lit_bufsize-1),c.level=t,c.strategy=s,c.method=i,jk(e)};var Wz=(e,t)=>{if(Lm(e)||t>Zo||t<0)return e?Zh(e,Vl):Vl;const i=e.state;if(!e.output||e.avail_in!==0&&!e.input||i.status===tl&&t!==_c)return Zh(e,e.avail_out===0?Vk:Vl);const r=i.last_flush;if(i.last_flush=t,i.pending!==0){if(Rn(e),e.avail_out===0)return i.last_flush=-1,$o}else if(e.avail_in===0&&Qu(t)<=Qu(r)&&t!==_c)return Zh(e,Vk);if(i.status===tl&&e.avail_in!==0)return Zh(e,Vk);if(i.status===Kc&&i.wrap===0&&(i.status=el),i.status===Kc){let o=Pm+(i.w_bits-8<<4)<<8,s=-1;if(s=i.strategy>=XC||i.level<2?0:i.level<6?1:i.level===6?2:3,o|=s<<6,i.strstart!==0&&(o|=32),o+=31-o%31,K_(i,o),i.strstart!==0&&(K_(i,e.adler>>>16),K_(i,65535&e.adler)),e.adler=1,i.status=el,Rn(e),i.pending!==0)return i.last_flush=-1,$o}if(i.status===57){if(e.adler=0,dr(i,31),dr(i,139),dr(i,8),i.gzhead)dr(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),dr(i,255&i.gzhead.time),dr(i,i.gzhead.time>>8&255),dr(i,i.gzhead.time>>16&255),dr(i,i.gzhead.time>>24&255),dr(i,i.level===9?2:i.strategy>=XC||i.level<2?4:0),dr(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(dr(i,255&i.gzhead.extra.length),dr(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(e.adler=Nn(e.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69;else if(dr(i,0),dr(i,0),dr(i,0),dr(i,0),dr(i,0),dr(i,i.level===9?2:i.strategy>=XC||i.level<2?4:0),dr(i,3),i.status=el,Rn(e),i.pending!==0)return i.last_flush=-1,$o}if(i.status===69){if(i.gzhead.extra){let o=i.pending,s=(65535&i.gzhead.extra.length)-i.gzindex;for(;i.pending+s>i.pending_buf_size;){let c=i.pending_buf_size-i.pending;if(i.pending_buf.set(i.gzhead.extra.subarray(i.gzindex,i.gzindex+c),i.pending),i.pending=i.pending_buf_size,i.gzhead.hcrc&&i.pending>o&&(e.adler=Nn(e.adler,i.pending_buf,i.pending-o,o)),i.gzindex+=c,Rn(e),i.pending!==0)return i.last_flush=-1,$o;o=0,s-=c}let a=new Uint8Array(i.gzhead.extra);i.pending_buf.set(a.subarray(i.gzindex,i.gzindex+s),i.pending),i.pending+=s,i.gzhead.hcrc&&i.pending>o&&(e.adler=Nn(e.adler,i.pending_buf,i.pending-o,o)),i.gzindex=0}i.status=73}if(i.status===73){if(i.gzhead.name){let o,s=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>s&&(e.adler=Nn(e.adler,i.pending_buf,i.pending-s,s)),Rn(e),i.pending!==0)return i.last_flush=-1,$o;s=0}o=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,dr(i,o)}while(o!==0);i.gzhead.hcrc&&i.pending>s&&(e.adler=Nn(e.adler,i.pending_buf,i.pending-s,s)),i.gzindex=0}i.status=91}if(i.status===91){if(i.gzhead.comment){let o,s=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>s&&(e.adler=Nn(e.adler,i.pending_buf,i.pending-s,s)),Rn(e),i.pending!==0)return i.last_flush=-1,$o;s=0}o=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,dr(i,o)}while(o!==0);i.gzhead.hcrc&&i.pending>s&&(e.adler=Nn(e.adler,i.pending_buf,i.pending-s,s))}i.status=103}if(i.status===103){if(i.gzhead.hcrc){if(i.pending+2>i.pending_buf_size&&(Rn(e),i.pending!==0))return i.last_flush=-1,$o;dr(i,255&e.adler),dr(i,e.adler>>8&255),e.adler=0}if(i.status=el,Rn(e),i.pending!==0)return i.last_flush=-1,$o}if(e.avail_in!==0||i.lookahead!==0||t!==Qh&&i.status!==tl){let o=i.level===0?ZC(i,t):i.strategy===XC?((s,a)=>{let c;for(;;){if(s.lookahead===0&&(z_(s),s.lookahead===0)){if(a===Qh)return 1;break}if(s.match_length=0,c=Xh(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++,c&&(Oi(s,!1),s.strm.avail_out===0))return 1}return s.insert=0,a===_c?(Oi(s,!0),s.strm.avail_out===0?3:4):s.sym_next&&(Oi(s,!1),s.strm.avail_out===0)?1:2})(i,t):i.strategy===xz?((s,a)=>{let c,d,l,h;const p=s.window;for(;;){if(s.lookahead<=Ps){if(z_(s),s.lookahead<=Ps&&a===Qh)return 1;if(s.lookahead===0)break}if(s.match_length=0,s.lookahead>=3&&s.strstart>0&&(l=s.strstart-1,d=p[l],d===p[++l]&&d===p[++l]&&d===p[++l])){h=s.strstart+Ps;do;while(d===p[++l]&&d===p[++l]&&d===p[++l]&&d===p[++l]&&d===p[++l]&&d===p[++l]&&d===p[++l]&&d===p[++l]&&l<h);s.match_length=Ps-(h-l),s.match_length>s.lookahead&&(s.match_length=s.lookahead)}if(s.match_length>=3?(c=Xh(s,1,s.match_length-3),s.lookahead-=s.match_length,s.strstart+=s.match_length,s.match_length=0):(c=Xh(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++),c&&(Oi(s,!1),s.strm.avail_out===0))return 1}return s.insert=0,a===_c?(Oi(s,!0),s.strm.avail_out===0?3:4):s.sym_next&&(Oi(s,!1),s.strm.avail_out===0)?1:2})(i,t):dR[i.level].func(i,t);if(o!==3&&o!==4||(i.status=tl),o===1||o===3)return e.avail_out===0&&(i.last_flush=-1),$o;if(o===2&&(t===Mz?Jh(i):t!==Zo&&(Uk(i,0,0,!1),t===Hc&&($h(i.head),i.lookahead===0&&(i.strstart=0,i.block_start=0,i.insert=0))),Rn(e),e.avail_out===0))return i.last_flush=-1,$o}return t!==_c?$o:i.wrap<=0?$d:(i.wrap===2?(dr(i,255&e.adler),dr(i,e.adler>>8&255),dr(i,e.adler>>16&255),dr(i,e.adler>>24&255),dr(i,255&e.total_in),dr(i,e.total_in>>8&255),dr(i,e.total_in>>16&255),dr(i,e.total_in>>24&255)):(K_(i,e.adler>>>16),K_(i,65535&e.adler)),Rn(e),i.wrap>0&&(i.wrap=-i.wrap),i.pending!==0?$o:$d)},uR=(e,t)=>{let i=t.length;if(Lm(e))return Vl;const r=e.state,o=r.wrap;if(o===2||o===1&&r.status!==Kc||r.lookahead)return Vl;if(o===1&&(e.adler=cR(e.adler,t,i,0)),r.wrap=0,i>=r.w_size){o===0&&($h(r.head),r.strstart=0,r.block_start=0,r.insert=0);let d=new Uint8Array(r.w_size);d.set(t.subarray(i-r.w_size,i),0),t=d,i=r.w_size}const s=e.avail_in,a=e.next_in,c=e.input;for(e.avail_in=i,e.next_in=0,e.input=t,z_(r);r.lookahead>=3;){let d=r.strstart,l=r.lookahead-2;do r.ins_h=To(r,r.ins_h,r.window[d+3-1]),r.prev[d&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=d,d++;while(--l);r.strstart=d,r.lookahead=2,z_(r)}return r.strstart+=r.lookahead,r.block_start=r.strstart,r.insert=r.lookahead,r.lookahead=0,r.match_length=r.prev_length=2,r.match_available=0,e.next_in=a,e.input=c,e.avail_in=s,r.wrap=o,$o},hR={deflateInit:(e,t)=>A2(e,t,Pm,15,8,Fz),deflateInit2:A2,deflateReset:jk,deflateResetKeep:Bk,deflateSetHeader:(e,t)=>Lm(e)||e.state.wrap!==2?Vl:(e.state.gzhead=t,$o),deflate:Wz,deflateEnd:e=>{if(Lm(e))return Vl;const t=e.state.status;return e.state=null,t===el?Zh(e,xk):$o},deflateSetDictionary:uR,deflateInfo:"pako deflate (from Nodeca project)"};const $C=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var pR={assign:function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const i=t.shift();if(i){if(typeof i!="object")throw new TypeError(i+"must be non-object");for(const r in i)$C(i,r)&&(e[r]=i[r])}}return e},flattenChunks:e=>{let t=0;for(let r=0,o=e.length;r<o;r++)t+=e[r].length;const i=new Uint8Array(t);for(let r=0,o=0,s=e.length;r<s;r++){let a=e[r];i.set(a,o),o+=a.length}return i}};let km=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{km=!1}const Zu=new Uint8Array(256);for(let e=0;e<256;e++)Zu[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;Zu[254]=Zu[254]=1;var Mm={string2buf:e=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(e);let t,i,r,o,s,a=e.length,c=0;for(o=0;o<a;o++)i=e.charCodeAt(o),(64512&i)==55296&&o+1<a&&(r=e.charCodeAt(o+1),(64512&r)==56320&&(i=65536+(i-55296<<10)+(r-56320),o++)),c+=i<128?1:i<2048?2:i<65536?3:4;for(t=new Uint8Array(c),s=0,o=0;s<c;o++)i=e.charCodeAt(o),(64512&i)==55296&&o+1<a&&(r=e.charCodeAt(o+1),(64512&r)==56320&&(i=65536+(i-55296<<10)+(r-56320),o++)),i<128?t[s++]=i:i<2048?(t[s++]=192|i>>>6,t[s++]=128|63&i):i<65536?(t[s++]=224|i>>>12,t[s++]=128|i>>>6&63,t[s++]=128|63&i):(t[s++]=240|i>>>18,t[s++]=128|i>>>12&63,t[s++]=128|i>>>6&63,t[s++]=128|63&i);return t},buf2string:(e,t)=>{const i=t||e.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(e.subarray(0,t));let r,o;const s=new Array(2*i);for(o=0,r=0;r<i;){let a=e[r++];if(a<128){s[o++]=a;continue}let c=Zu[a];if(c>4)s[o++]=65533,r+=c-1;else{for(a&=c===2?31:c===3?15:7;c>1&&r<i;)a=a<<6|63&e[r++],c--;c>1?s[o++]=65533:a<65536?s[o++]=a:(a-=65536,s[o++]=55296|a>>10&1023,s[o++]=56320|1023&a)}}return((a,c)=>{if(c<65534&&a.subarray&&km)return String.fromCharCode.apply(null,a.length===c?a:a.subarray(0,c));let d="";for(let l=0;l<c;l++)d+=String.fromCharCode(a[l]);return d})(s,o)},utf8border:(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let i=t-1;for(;i>=0&&(192&e[i])==128;)i--;return i<0||i===0?t:i+Zu[e[i]]>t?i:t}},Gk=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const w2=Object.prototype.toString,{Z_NO_FLUSH:Hz,Z_SYNC_FLUSH:Kz,Z_FULL_FLUSH:Yz,Z_FINISH:ey,Z_OK:ty,Z_STREAM_END:zz,Z_DEFAULT_COMPRESSION:qz,Z_DEFAULT_STRATEGY:Xz,Z_DEFLATED:iy}=zC;function _R(e){this.options=pR.assign({level:qz,method:iy,chunkSize:16384,windowBits:15,memLevel:8,strategy:Xz},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Gk,this.strm.avail_out=0;let i=hR.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(i!==ty)throw new Error(xl[i]);if(t.header&&hR.deflateSetHeader(this.strm,t.header),t.dictionary){let r;if(r=typeof t.dictionary=="string"?Mm.string2buf(t.dictionary):w2.call(t.dictionary)==="[object ArrayBuffer]"?new Uint8Array(t.dictionary):t.dictionary,i=hR.deflateSetDictionary(this.strm,r),i!==ty)throw new Error(xl[i]);this._dict_set=!0}}function b2(e,t){const i=new _R(t);if(i.push(e,!0),i.err)throw i.msg||xl[i.err];return i.result}_R.prototype.push=function(e,t){const i=this.strm,r=this.options.chunkSize;let o,s;if(this.ended)return!1;for(s=t===~~t?t:t===!0?ey:Hz,typeof e=="string"?i.input=Mm.string2buf(e):w2.call(e)==="[object ArrayBuffer]"?i.input=new Uint8Array(e):i.input=e,i.next_in=0,i.avail_in=i.input.length;;)if(i.avail_out===0&&(i.output=new Uint8Array(r),i.next_out=0,i.avail_out=r),(s===Kz||s===Yz)&&i.avail_out<=6)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else{if(o=hR.deflate(i,s),o===zz)return i.next_out>0&&this.onData(i.output.subarray(0,i.next_out)),o=hR.deflateEnd(this.strm),this.onEnd(o),this.ended=!0,o===ty;if(i.avail_out!==0){if(s>0&&i.next_out>0)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else if(i.avail_in===0)break}else this.onData(i.output)}return!0},_R.prototype.onData=function(e){this.chunks.push(e)},_R.prototype.onEnd=function(e){e===ty&&(this.result=pR.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var ry={deflate:b2,deflateRaw:function(e,t){return(t=t||{}).raw=!0,b2(e,t)}};const ny=16209;var oy=function(e,t){let i,r,o,s,a,c,d,l,h,p,f,m,g,S,T,C,b,D,x,k,V,W,K,J;const se=e.state;i=e.next_in,K=e.input,r=i+(e.avail_in-5),o=e.next_out,J=e.output,s=o-(t-e.avail_out),a=o+(e.avail_out-257),c=se.dmax,d=se.wsize,l=se.whave,h=se.wnext,p=se.window,f=se.hold,m=se.bits,g=se.lencode,S=se.distcode,T=(1<<se.lenbits)-1,C=(1<<se.distbits)-1;e:do{m<15&&(f+=K[i++]<<m,m+=8,f+=K[i++]<<m,m+=8),b=g[f&T];t:for(;;){if(D=b>>>24,f>>>=D,m-=D,D=b>>>16&255,D===0)J[o++]=65535&b;else{if(!(16&D)){if(!(64&D)){b=g[(65535&b)+(f&(1<<D)-1)];continue t}if(32&D){se.mode=16191;break e}e.msg="invalid literal/length code",se.mode=ny;break e}x=65535&b,D&=15,D&&(m<D&&(f+=K[i++]<<m,m+=8),x+=f&(1<<D)-1,f>>>=D,m-=D),m<15&&(f+=K[i++]<<m,m+=8,f+=K[i++]<<m,m+=8),b=S[f&C];i:for(;;){if(D=b>>>24,f>>>=D,m-=D,D=b>>>16&255,!(16&D)){if(!(64&D)){b=S[(65535&b)+(f&(1<<D)-1)];continue i}e.msg="invalid distance code",se.mode=ny;break e}if(k=65535&b,D&=15,m<D&&(f+=K[i++]<<m,m+=8,m<D&&(f+=K[i++]<<m,m+=8)),k+=f&(1<<D)-1,k>c){e.msg="invalid distance too far back",se.mode=ny;break e}if(f>>>=D,m-=D,D=o-s,k>D){if(D=k-D,D>l&&se.sane){e.msg="invalid distance too far back",se.mode=ny;break e}if(V=0,W=p,h===0){if(V+=d-D,D<x){x-=D;do J[o++]=p[V++];while(--D);V=o-k,W=J}}else if(h<D){if(V+=d+h-D,D-=h,D<x){x-=D;do J[o++]=p[V++];while(--D);if(V=0,h<x){D=h,x-=D;do J[o++]=p[V++];while(--D);V=o-k,W=J}}}else if(V+=h-D,D<x){x-=D;do J[o++]=p[V++];while(--D);V=o-k,W=J}for(;x>2;)J[o++]=W[V++],J[o++]=W[V++],J[o++]=W[V++],x-=3;x&&(J[o++]=W[V++],x>1&&(J[o++]=W[V++]))}else{V=o-k;do J[o++]=J[V++],J[o++]=J[V++],J[o++]=J[V++],x-=3;while(x>2);x&&(J[o++]=J[V++],x>1&&(J[o++]=J[V++]))}break}}break}}while(i<r&&o<a);x=m>>3,i-=x,m-=x<<3,f&=(1<<m)-1,e.next_in=i,e.next_out=o,e.avail_in=i<r?r-i+5:5-(i-r),e.avail_out=o<a?a-o+257:257-(o-a),se.hold=f,se.bits=m};const sy=15,Jz=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),Qz=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),Zz=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),fR=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Um=(e,t,i,r,o,s,a,c)=>{const d=c.bits;let l,h,p,f,m,g,S=0,T=0,C=0,b=0,D=0,x=0,k=0,V=0,W=0,K=0,J=null;const se=new Uint16Array(16),Ne=new Uint16Array(16);let Ce,De,Me,et=null;for(S=0;S<=sy;S++)se[S]=0;for(T=0;T<r;T++)se[t[i+T]]++;for(D=d,b=sy;b>=1&&se[b]===0;b--);if(D>b&&(D=b),b===0)return o[s++]=20971520,o[s++]=20971520,c.bits=1,0;for(C=1;C<b&&se[C]===0;C++);for(D<C&&(D=C),V=1,S=1;S<=sy;S++)if(V<<=1,V-=se[S],V<0)return-1;if(V>0&&(e===0||b!==1))return-1;for(Ne[1]=0,S=1;S<sy;S++)Ne[S+1]=Ne[S]+se[S];for(T=0;T<r;T++)t[i+T]!==0&&(a[Ne[t[i+T]]++]=T);if(e===0?(J=et=a,g=20):e===1?(J=Jz,et=Qz,g=257):(J=Zz,et=fR,g=0),K=0,T=0,S=C,m=s,x=D,k=0,p=-1,W=1<<D,f=W-1,e===1&&W>852||e===2&&W>592)return 1;for(;;){Ce=S-k,a[T]+1<g?(De=0,Me=a[T]):a[T]>=g?(De=et[a[T]-g],Me=J[a[T]-g]):(De=96,Me=0),l=1<<S-k,h=1<<x,C=h;do h-=l,o[m+(K>>k)+h]=Ce<<24|De<<16|Me|0;while(h!==0);for(l=1<<S-1;K&l;)l>>=1;if(l!==0?(K&=l-1,K+=l):K=0,T++,--se[S]==0){if(S===b)break;S=t[i+a[T]]}if(S>D&&(K&f)!==p){for(k===0&&(k=D),m+=C,x=S-k,V=1<<x;x+k<b&&(V-=se[x+k],!(V<=0));)x++,V<<=1;if(W+=1<<x,e===1&&W>852||e===2&&W>592)return 1;p=K&f,o[p]=D<<24|x<<16|m-s|0}}return K!==0&&(o[m+K]=S-k<<24|64<<16|0),c.bits=D,0};const{Z_FINISH:O2,Z_BLOCK:ay,Z_TREES:Fl,Z_OK:q_,Z_STREAM_END:$z,Z_NEED_DICT:Yc,Z_STREAM_ERROR:fc,Z_DATA_ERROR:Wk,Z_MEM_ERROR:N2,Z_BUF_ERROR:D2,Z_DEFLATED:mR}=zC,X_=16180,zc=16190,il=16191,ER=16192,xm=16194,J_=16199,Vm=16200,cn=16206,vn=16209,P2=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function Q_(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const ip=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.mode<X_||t.mode>16211?1:0},Hk=e=>{if(ip(e))return fc;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=X_,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,q_},Kk=e=>{if(ip(e))return fc;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,Hk(e)},Yk=(e,t)=>{let i;if(ip(e))return fc;const r=e.state;return t<0?(i=0,t=-t):(i=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?fc:(r.window!==null&&r.wbits!==t&&(r.window=null),r.wrap=i,r.wbits=t,Kk(e))},cy=(e,t)=>{if(!e)return fc;const i=new Q_;e.state=i,i.strm=e,i.window=null,i.mode=X_;const r=Yk(e,t);return r!==q_&&(e.state=null),r};let gR,dy,L2=!0;const k2=e=>{if(L2){gR=new Int32Array(512),dy=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(Um(1,e.lens,0,288,gR,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;Um(2,e.lens,0,32,dy,0,e.work,{bits:5}),L2=!1}e.lencode=gR,e.lenbits=9,e.distcode=dy,e.distbits=5},M2=(e,t,i,r)=>{let o;const s=e.state;return s.window===null&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new Uint8Array(s.wsize)),r>=s.wsize?(s.window.set(t.subarray(i-s.wsize,i),0),s.wnext=0,s.whave=s.wsize):(o=s.wsize-s.wnext,o>r&&(o=r),s.window.set(t.subarray(i-r,i-r+o),s.wnext),(r-=o)?(s.window.set(t.subarray(i-r,i),0),s.wnext=r,s.whave=s.wsize):(s.wnext+=o,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=o))),0};var $u=(e,t)=>{let i,r,o,s,a,c,d,l,h,p,f,m,g,S,T,C,b,D,x,k,V,W,K=0;const J=new Uint8Array(4);let se,Ne;const Ce=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(ip(e)||!e.output||!e.input&&e.avail_in!==0)return fc;i=e.state,i.mode===il&&(i.mode=ER),a=e.next_out,o=e.output,d=e.avail_out,s=e.next_in,r=e.input,c=e.avail_in,l=i.hold,h=i.bits,p=c,f=d,W=q_;e:for(;;)switch(i.mode){case X_:if(i.wrap===0){i.mode=ER;break}for(;h<16;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}if(2&i.wrap&&l===35615){i.wbits===0&&(i.wbits=15),i.check=0,J[0]=255&l,J[1]=l>>>8&255,i.check=Nn(i.check,J,2,0),l=0,h=0,i.mode=16181;break}if(i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&l)<<8)+(l>>8))%31){e.msg="incorrect header check",i.mode=vn;break}if((15&l)!==mR){e.msg="unknown compression method",i.mode=vn;break}if(l>>>=4,h-=4,V=8+(15&l),i.wbits===0&&(i.wbits=V),V>15||V>i.wbits){e.msg="invalid window size",i.mode=vn;break}i.dmax=1<<i.wbits,i.flags=0,e.adler=i.check=1,i.mode=512&l?16189:il,l=0,h=0;break;case 16181:for(;h<16;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}if(i.flags=l,(255&On(i))!==mR){e.msg="unknown compression method",i.mode=vn;break}if(57344&On(i)){e.msg="unknown header flags set",i.mode=vn;break}i.head&&(i.head.text=l>>8&1),512&On(i)&&4&i.wrap&&(J[0]=255&l,J[1]=l>>>8&255,i.check=Nn(i.check,J,2,0)),l=0,h=0,i.mode=16182;case 16182:for(;h<32;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}i.head&&(i.head.time=l),512&On(i)&&4&i.wrap&&(J[0]=255&l,J[1]=l>>>8&255,J[2]=l>>>16&255,J[3]=l>>>24&255,i.check=Nn(i.check,J,4,0)),l=0,h=0,i.mode=16183;case 16183:for(;h<16;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}i.head&&(i.head.xflags=255&l,i.head.os=l>>8),512&On(i)&&4&i.wrap&&(J[0]=255&l,J[1]=l>>>8&255,i.check=Nn(i.check,J,2,0)),l=0,h=0,i.mode=16184;case 16184:if(1024&On(i)){for(;h<16;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}i.length=l,i.head&&(i.head.extra_len=l),512&On(i)&&4&i.wrap&&(J[0]=255&l,J[1]=l>>>8&255,i.check=Nn(i.check,J,2,0)),l=0,h=0}else i.head&&(i.head.extra=null);i.mode=16185;case 16185:if(1024&On(i)&&(m=i.length,m>c&&(m=c),m&&(i.head&&(V=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Uint8Array(i.head.extra_len)),i.head.extra.set(r.subarray(s,s+m),V)),512&On(i)&&4&i.wrap&&(i.check=Nn(i.check,r,m,s)),c-=m,s+=m,i.length-=m),i.length))break e;i.length=0,i.mode=16186;case 16186:if(2048&On(i)){if(c===0)break e;m=0;do V=r[s+m++],i.head&&V&&i.length<65536&&(i.head.name+=String.fromCharCode(V));while(V&&m<c);if(512&On(i)&&4&i.wrap&&(i.check=Nn(i.check,r,m,s)),c-=m,s+=m,V)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=16187;case 16187:if(4096&On(i)){if(c===0)break e;m=0;do V=r[s+m++],i.head&&V&&i.length<65536&&(i.head.comment+=String.fromCharCode(V));while(V&&m<c);if(512&On(i)&&4&i.wrap&&(i.check=Nn(i.check,r,m,s)),c-=m,s+=m,V)break e}else i.head&&(i.head.comment=null);i.mode=16188;case 16188:if(512&On(i)){for(;h<16;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}if(4&i.wrap&&l!==(65535&i.check)){e.msg="header crc mismatch",i.mode=vn;break}l=0,h=0}i.head&&(i.head.hcrc=On(i)>>9&1,i.head.done=!0),e.adler=i.check=0,i.mode=il;break;case 16189:for(;h<32;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}e.adler=i.check=P2(l),l=0,h=0,i.mode=zc;case zc:if(i.havedict===0)return e.next_out=a,e.avail_out=d,e.next_in=s,e.avail_in=c,i.hold=l,i.bits=h,Yc;e.adler=i.check=1,i.mode=il;case il:if(t===ay||t===Fl)break e;case ER:if(i.last){l>>>=7&h,h-=7&h,i.mode=cn;break}for(;h<3;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}switch(i.last=1&l,l>>>=1,h-=1,3&l){case 0:i.mode=16193;break;case 1:if(k2(i),i.mode=J_,t===Fl){l>>>=2,h-=2;break e}break;case 2:i.mode=16196;break;case 3:e.msg="invalid block type",i.mode=vn}l>>>=2,h-=2;break;case 16193:for(l>>>=7&h,h-=7&h;h<32;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}if((65535&l)!=(l>>>16^65535)){e.msg="invalid stored block lengths",i.mode=vn;break}if(i.length=65535&l,l=0,h=0,i.mode=xm,t===Fl)break e;case xm:i.mode=16195;case 16195:if(m=i.length,m){if(m>c&&(m=c),m>d&&(m=d),m===0)break e;o.set(r.subarray(s,s+m),a),c-=m,s+=m,d-=m,a+=m,i.length-=m;break}i.mode=il;break;case 16196:for(;h<14;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}if(i.nlen=257+(31&l),l>>>=5,h-=5,i.ndist=1+(31&l),l>>>=5,h-=5,i.ncode=4+(15&l),l>>>=4,h-=4,i.nlen>286||i.ndist>30){e.msg="too many length or distance symbols",i.mode=vn;break}i.have=0,i.mode=16197;case 16197:for(;i.have<i.ncode;){for(;h<3;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}i.lens[Ce[i.have++]]=7&l,l>>>=3,h-=3}for(;i.have<19;)i.lens[Ce[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,se={bits:i.lenbits},W=Um(0,i.lens,0,19,i.lencode,0,i.work,se),i.lenbits=se.bits,W){e.msg="invalid code lengths set",i.mode=vn;break}i.have=0,i.mode=16198;case 16198:for(;i.have<i.nlen+i.ndist;){for(;K=i.lencode[l&(1<<i.lenbits)-1],T=K>>>24,C=K>>>16&255,b=65535&K,!(T<=h);){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}if(b<16)l>>>=T,h-=T,i.lens[i.have++]=b;else{if(b===16){for(Ne=T+2;h<Ne;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}if(l>>>=T,h-=T,i.have===0){e.msg="invalid bit length repeat",i.mode=vn;break}V=i.lens[i.have-1],m=3+(3&l),l>>>=2,h-=2}else if(b===17){for(Ne=T+3;h<Ne;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}l>>>=T,h-=T,V=0,m=3+(7&l),l>>>=3,h-=3}else{for(Ne=T+7;h<Ne;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}l>>>=T,h-=T,V=0,m=11+(127&l),l>>>=7,h-=7}if(i.have+m>i.nlen+i.ndist){e.msg="invalid bit length repeat",i.mode=vn;break}for(;m--;)i.lens[i.have++]=V}}if(i.mode===vn)break;if(i.lens[256]===0){e.msg="invalid code -- missing end-of-block",i.mode=vn;break}if(i.lenbits=9,se={bits:i.lenbits},W=Um(1,i.lens,0,i.nlen,i.lencode,0,i.work,se),i.lenbits=se.bits,W){e.msg="invalid literal/lengths set",i.mode=vn;break}if(i.distbits=6,i.distcode=i.distdyn,se={bits:i.distbits},W=Um(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,se),i.distbits=se.bits,W){e.msg="invalid distances set",i.mode=vn;break}if(i.mode=J_,t===Fl)break e;case J_:i.mode=Vm;case Vm:if(c>=6&&d>=258){e.next_out=a,e.avail_out=d,e.next_in=s,e.avail_in=c,i.hold=l,i.bits=h,oy(e,f),a=e.next_out,o=e.output,d=e.avail_out,s=e.next_in,r=e.input,c=e.avail_in,l=i.hold,h=i.bits,i.mode===il&&(i.back=-1);break}for(i.back=0;K=i.lencode[l&(1<<i.lenbits)-1],T=K>>>24,C=K>>>16&255,b=65535&K,!(T<=h);){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}if(C&&!(240&C)){for(D=T,x=C,k=b;K=i.lencode[k+((l&(1<<D+x)-1)>>D)],T=K>>>24,C=K>>>16&255,b=65535&K,!(D+T<=h);){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}l>>>=D,h-=D,i.back+=D}if(l>>>=T,h-=T,i.back+=T,i.length=b,C===0){i.mode=16205;break}if(32&C){i.back=-1,i.mode=il;break}if(64&C){e.msg="invalid literal/length code",i.mode=vn;break}i.extra=15&C,i.mode=16201;case 16201:if(i.extra){for(Ne=i.extra;h<Ne;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}i.length+=l&(1<<i.extra)-1,l>>>=i.extra,h-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=16202;case 16202:for(;K=i.distcode[l&(1<<i.distbits)-1],T=K>>>24,C=K>>>16&255,b=65535&K,!(T<=h);){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}if(!(240&C)){for(D=T,x=C,k=b;K=i.distcode[k+((l&(1<<D+x)-1)>>D)],T=K>>>24,C=K>>>16&255,b=65535&K,!(D+T<=h);){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}l>>>=D,h-=D,i.back+=D}if(l>>>=T,h-=T,i.back+=T,64&C){e.msg="invalid distance code",i.mode=vn;break}i.offset=b,i.extra=15&C,i.mode=16203;case 16203:if(i.extra){for(Ne=i.extra;h<Ne;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}i.offset+=l&(1<<i.extra)-1,l>>>=i.extra,h-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back",i.mode=vn;break}i.mode=16204;case 16204:if(d===0)break e;if(m=f-d,i.offset>m){if(m=i.offset-m,m>i.whave&&i.sane){e.msg="invalid distance too far back",i.mode=vn;break}m>i.wnext?(m-=i.wnext,g=i.wsize-m):g=i.wnext-m,m>i.length&&(m=i.length),S=i.window}else S=o,g=a-i.offset,m=i.length;m>d&&(m=d),d-=m,i.length-=m;do o[a++]=S[g++];while(--m);i.length===0&&(i.mode=Vm);break;case 16205:if(d===0)break e;o[a++]=i.length,d--,i.mode=Vm;break;case cn:if(i.wrap){for(;h<32;){if(c===0)break e;c--,l|=r[s++]<<h,h+=8}if(f-=d,e.total_out+=f,i.total+=f,4&i.wrap&&f&&(e.adler=i.check=On(i)?Nn(i.check,o,f,a-f):cR(i.check,o,f,a-f)),f=d,4&i.wrap&&(On(i)?l:P2(l))!==i.check){e.msg="incorrect data check",i.mode=vn;break}l=0,h=0}i.mode=16207;case 16207:if(i.wrap&&On(i)){for(;h<32;){if(c===0)break e;c--,l+=r[s++]<<h,h+=8}if(4&i.wrap&&l!==(4294967295&i.total)){e.msg="incorrect length check",i.mode=vn;break}l=0,h=0}i.mode=16208;case 16208:W=$z;break e;case vn:W=Wk;break e;case 16210:return N2;default:return fc}return e.next_out=a,e.avail_out=d,e.next_in=s,e.avail_in=c,i.hold=l,i.bits=h,(i.wsize||f!==e.avail_out&&i.mode<vn&&(i.mode<cn||t!==O2))&&M2(e,e.output,e.next_out,f-e.avail_out),p-=e.avail_in,f-=e.avail_out,e.total_in+=p,e.total_out+=f,i.total+=f,4&i.wrap&&f&&(e.adler=i.check=On(i)?Nn(i.check,o,f,e.next_out-f):cR(i.check,o,f,e.next_out-f)),e.data_type=i.bits+(i.last?64:0)+(i.mode===il?128:0)+(i.mode===J_||i.mode===xm?256:0),(p===0&&f===0||t===O2)&&W===q_&&(W=D2),W},eh={inflateReset:Kk,inflateReset2:Yk,inflateResetKeep:Hk,inflateInit:e=>cy(e,15),inflateInit2:cy,inflate:$u,inflateEnd:e=>{if(ip(e))return fc;let t=e.state;return t.window&&(t.window=null),e.state=null,q_},inflateGetHeader:(e,t)=>{if(ip(e))return fc;const i=e.state;return 2&i.wrap?(i.head=t,t.done=!1,q_):fc},inflateSetDictionary:(e,t)=>{const i=t.length;let r,o,s;return ip(e)?fc:(r=e.state,r.wrap!==0&&r.mode!==zc?fc:r.mode===zc&&(o=1,o=cR(o,t,i,0),o!==r.check)?Wk:(s=M2(e,t,i,i),s?(r.mode=16210,N2):(r.havedict=1,q_)))},inflateInfo:"pako inflate (from Nodeca project)"},U2=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const x2=Object.prototype.toString,{Z_NO_FLUSH:e9,Z_FINISH:SR,Z_OK:Z_,Z_STREAM_END:TR,Z_NEED_DICT:zk,Z_STREAM_ERROR:V2,Z_DATA_ERROR:F2,Z_MEM_ERROR:ly}=zC;function RR(e){this.options=pR.assign({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,t.windowBits===0&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&!(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Gk,this.strm.avail_out=0;let i=eh.inflateInit2(this.strm,t.windowBits);if(i!==Z_)throw new Error(xl[i]);if(this.header=new U2,eh.inflateGetHeader(this.strm,this.header),t.dictionary&&(typeof t.dictionary=="string"?t.dictionary=Mm.string2buf(t.dictionary):x2.call(t.dictionary)==="[object ArrayBuffer]"&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(i=eh.inflateSetDictionary(this.strm,t.dictionary),i!==Z_)))throw new Error(xl[i])}function B2(e,t){const i=new RR(t);if(i.push(e),i.err)throw i.msg||xl[i.err];return i.result}RR.prototype.push=function(e,t){const i=this.strm,r=this.options.chunkSize,o=this.options.dictionary;let s,a,c;if(this.ended)return!1;for(a=t===~~t?t:t===!0?SR:e9,x2.call(e)==="[object ArrayBuffer]"?i.input=new Uint8Array(e):i.input=e,i.next_in=0,i.avail_in=i.input.length;;){for(i.avail_out===0&&(i.output=new Uint8Array(r),i.next_out=0,i.avail_out=r),s=eh.inflate(i,a),s===zk&&o&&(s=eh.inflateSetDictionary(i,o),s===Z_?s=eh.inflate(i,a):s===F2&&(s=zk));i.avail_in>0&&s===TR&&i.state.wrap>0&&e[i.next_in]!==0;)eh.inflateReset(i),s=eh.inflate(i,a);switch(s){case V2:case F2:case zk:case ly:return this.onEnd(s),this.ended=!0,!1}if(c=i.avail_out,i.next_out&&(i.avail_out===0||s===TR))if(this.options.to==="string"){let d=Mm.utf8border(i.output,i.next_out),l=i.next_out-d,h=Mm.buf2string(i.output,d);i.next_out=l,i.avail_out=r-l,l&&i.output.set(i.output.subarray(d,d+l),0),this.onData(h)}else this.onData(i.output.length===i.next_out?i.output:i.output.subarray(0,i.next_out));if(s!==Z_||c!==0){if(s===TR)return s=eh.inflateEnd(this.strm),this.onEnd(s),this.ended=!0,!0;if(i.avail_in===0)break}}return!0},RR.prototype.onData=function(e){this.chunks.push(e)},RR.prototype.onEnd=function(e){e===Z_&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=pR.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var t9={inflate:B2,inflateRaw:function(e,t){return(t=t||{}).raw=!0,B2(e,t)}};const{deflate:i9,deflateRaw:r9}=ry,{inflate:n9,inflateRaw:o9}=t9;var s9=i9,a9=r9,c9=n9,j2=o9,G2=function(e){return e[e.ONE_BYTE=0]="ONE_BYTE",e[e.TWO_BYTE=1]="TWO_BYTE",e}(G2||{});class d9{constructor(){M(this,"_sequence",0),M(this,"_startTime",Date.now()),M(this,"isUseOneByte",!0)}get startTime(){const t=Date.now()-this._startTime;return t<Math.pow(2,16)?t:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(t){const i={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:t};if(t.byteLength>128){const c=new Uint8Array(4);c.set([1,0,0,0]);const d={id:0,length:4,data:c.buffer},l={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[d]};i.commonPacketHeader.extension=1,i.extension=l,i.payload=this.compress(t),i.commonPacketHeader.length=8+(i.extension.length+2)+i.payload.byteLength}else i.commonPacketHeader.length=8+i.payload.byteLength;B("SHOW_DATASTREAM2_LOG")&&I.debug("send data header: ".concat(JSON.stringify(i.commonPacketHeader)));const r=new ArrayBuffer(i.commonPacketHeader.length),o=new Uint8Array(r),s=new DataView(r);let a=0;if(s.setUint16(a,i.commonPacketHeader.extension<<15|i.commonPacketHeader.reserved<<14|i.commonPacketHeader.length,!0),a+=2,s.setUint32(a,i.commonPacketHeader.sequence,!0),a+=4,s.setUint16(a,i.commonStreamHeader,!0),a+=2,i.extension){const c=this.serializeExtension(i.extension);o.set(new Uint8Array(c),a),a+=c.byteLength}if(o.set(new Uint8Array(i.payload),a),a+=i.payload.byteLength,a!==i.commonPacketHeader.length)throw Error("serialize error!");return r}deserialize(t){if(t.byteLength<4)return new ArrayBuffer(0);const i=new DataView(t);let r=0;const o=i.getUint16(r,!0);r+=2;const s={length:16383&o,reserved:(16384&o)>>14,extension:(32768&o)>>15,sequence:i.getUint16(r+2,!0)<<16|i.getUint16(r,!0)};let a,c;if(r+=4,B("SHOW_DATASTREAM2_LOG")&&I.debug("receive data header: ".concat(JSON.stringify(s))),i.getUint16(r,!0),r+=2,s.extension){c=this.deserializeExtension(t.slice(r)),r+=2+c.length,a=t.slice(r);let d=!1;if(c.datas.length>0){const l=c.datas.find(h=>h.id===0);l&&(d=(1&new DataView(l.data).getUint32(0,!0))==1)}a=d?this.decompress(a):a}else a=t.slice(8);return a}serializeExtension(t){const{profile:i,length:r,datas:o}=t,s=new ArrayBuffer(r+2),a=new Uint8Array(s),c=new DataView(s);let d=0;if(c.setUint8(d++,i),c.setUint8(d++,r),o.forEach(l=>{i?(c.setUint8(d++,l.id),c.setUint8(d++,l.length),a.set(new Uint8Array(l.data),d),d+=l.data.byteLength):(c.setUint8(d++,l.id|l.length<<4),a.set(new Uint8Array(l.data),d),d+=l.data.byteLength)}),d!==r+2)throw Error("serialize extension error, is ".concat(d,"!==").concat(r+2));return s}deserializeExtension(t){const i=new DataView(t);let r=0;const o=i.getUint8(r);r++;const s=i.getUint8(r);r++;const a=o===G2.TWO_BYTE,c=[],d=new DataView(t,2);let l=0;for(;l<s;){let h=0,p=0,f=new ArrayBuffer(0);a?(h=d.getUint8(l),l++,p=d.getUint8(l),l++):(h=15&d.getUint8(l),p=d.getUint8(l)>>4,l++),p>0&&(f=d.buffer.slice(l+2,l+2+p),l+=f.byteLength),c.push({id:h,length:p,data:f})}if(l!==s)throw Error("parse error");return{profile:o,length:s,datas:c}}decompress(t){return c9(new Uint8Array(t))}compress(t){return s9(new Uint8Array(t))}}const l9={name:"DataStream",create:(e,t)=>{const i=t?new KY(e):new Jv(e);return i.useDataStream(new d9),i}};class u9 extends Vi{constructor(t,i,r){super(),M(this,"ws",void 0),M(this,"requestId",1),M(this,"heartBeatTimer",void 0),M(this,"joinInfo",void 0),M(this,"clientId",void 0),M(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),M(this,"onClose",o=>{this.emit("close"),this.dispose()}),M(this,"onMessage",o=>{const s=JSON.parse(o.data);if(!s||s.command!=="serverResponse"||!s.requestId)return s&&s.command==="serverStatus"&&s.serverStatus&&s.serverStatus.command?(this.emit("status",s.serverStatus),void this.emit(s.serverStatus.command,s.serverStatus)):void 0;this.emit("req_".concat(s.requestId),s)}),this.joinInfo=t,this.clientId=i,this.ws=new em("cross-channel-".concat(this.clientId),r),this.ws.on(ht.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(ht.CONNECTED,this.onOpen),this.ws.on(ht.ON_MESSAGE,this.onMessage),this.ws.on(ht.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(t){const i=this.requestId++;return t.requestId=i,t.seq=i,this.ws.sendMessage(t),i}waitStatus(t){return new Z((i,r)=>{const o=window.setTimeout(()=>{r(new $(O.TIMEOUT,"wait status timeout, status: ".concat(t)))},5e3);this.once(t,s=>{window.clearTimeout(o),s.state&&s.state!==0?r(new $(O.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(t))):i(void 0)}),this.once("dispose",()=>{window.clearTimeout(o),r(new $(O.WS_ABORT))})})}async request(t){if(this.ws.state==="closed")throw new $(O.WS_DISCONNECT);const i=()=>new Z((a,c)=>{this.ws.once(ht.CLOSED,()=>c(new $(O.WS_ABORT))),this.ws.once(ht.CONNECTED,a)});this.ws.state!=="connected"&&await i();const r=this.sendMessage(t),o=new Z((a,c)=>{const d=()=>{c(new $(O.WS_ABORT))};this.ws.once(ht.RECONNECTING,d),this.ws.once(ht.CLOSED,d),this.once("req_".concat(r),a),vt(3e3).then(()=>{this.removeAllListeners("req_".concat(r)),this.ws.off(ht.RECONNECTING,d),this.ws.off(ht.CLOSED,d),c(new $(O.TIMEOUT,"cross channel ws request timeout"))})}),s=await o;if(!s||s.code!==200)throw new $(O.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(s)));return s}async connect(t){this.ws.removeAllListeners(ht.REQUEST_NEW_URLS),this.ws.on(ht.REQUEST_NEW_URLS,i=>{i(t)}),await this.ws.init(t)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(t){const i=this.requestId++;return t.requestId=i,this.ws.sendMessage(t),i}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class h9 extends Vi{set state(t){t!==this._state&&(t!==lo.RELAY_STATE_FAILURE&&(this.errorCode=_i.RELAY_OK),this.emit("state",t,this.errorCode),this._state=t)}get state(){return this._state}constructor(t,i,r,o,s){super(),M(this,"joinInfo",void 0),M(this,"sid",void 0),M(this,"clientId",void 0),M(this,"cancelToken",hs.CancelToken.source()),M(this,"workerToken",void 0),M(this,"requestId",0),M(this,"signal",void 0),M(this,"prevChannelMediaConfig",void 0),M(this,"httpRetryConfig",void 0),M(this,"_resolution",void 0),M(this,"_state",lo.RELAY_STATE_IDLE),M(this,"errorCode",_i.RELAY_OK),M(this,"onStatus",a=>{I.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(a))),a&&a.command&&(a.command==="onAudioPacketReceived"&&this.emit("event",An.PACKET_RECEIVED_AUDIO_FROM_SRC),a.command==="onVideoPacketReceived"&&this.emit("event",An.PACKET_RECEIVED_VIDEO_FROM_SRC),a.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=_i.SRC_TOKEN_EXPIRED,this.state=lo.RELAY_STATE_FAILURE),a.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=_i.DEST_TOKEN_EXPIRED,this.state=lo.RELAY_STATE_FAILURE))}),M(this,"onReconnect",async()=>{I.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",An.NETWORK_DISCONNECTED),this.state=lo.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(a=>{this.state!==lo.RELAY_STATE_IDLE&&(I.error("auto restart channel media relay failed",a.toString()),this.errorCode=_i.SERVER_CONNECTION_LOST,this.state=lo.RELAY_STATE_FAILURE)})}),this.joinInfo=t,this.clientId=i,this.sid=Fd(),this.signal=new u9(this.joinInfo,this.clientId,r),this.httpRetryConfig=o,this._resolution=s}async startChannelMediaRelay(t){if(this.state!==lo.RELAY_STATE_IDLE)throw new $(O.INVALID_OPERATION);this.state=lo.RELAY_STATE_CONNECTING,await this.connect(),I.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(t)}catch(i){throw i.data&&i.data.serverResponse&&i.data.serverResponse.command==="SetSourceChannel"?new $(O.CROSS_CHANNEL_FAILED_JOIN_SRC):i.data&&i.data.serverResponse&&i.serverResponse.command==="SetDestChannelStatus"?new $(O.CROSS_CHANNEL_FAILED_JOIN_DEST):i.data&&i.data.serverResponse&&i.serverResponse.command==="StartPacketTransfer"?new $(O.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):i}this.prevChannelMediaConfig=t}async updateChannelMediaRelay(t){if(this.state!==lo.RELAY_STATE_RUNNING)throw new $(O.INVALID_OPERATION);await this.sendUpdateMessage(t),this.prevChannelMediaConfig=t}async setVideoProfile(t){if(this._resolution=t,this.state!==lo.RELAY_STATE_RUNNING)throw new $(O.INVALID_OPERATION);const i=this.genMessage(gn.SetVideoProfile);await this.signal.request(i),I.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),I.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=lo.RELAY_STATE_IDLE,this.dispose()}dispose(){I.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=hs.CancelToken.source(),this.state=lo.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const t=await Tz(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=t.workerToken,await this.signal.connect(t.addressList),this.emit("event",An.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(t){const i=this.genMessage(gn.SetSdkProfile,t);await this.signal.request(i),I.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const r=this.genMessage(gn.SetSourceChannel,t);await this.signal.request(r),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",An.PACKET_JOINED_SRC_CHANNEL),I.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const o=this.genMessage(gn.SetSourceUserId,t);await this.signal.request(o),I.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const s=this.genMessage(gn.SetDestChannel,t);await this.signal.request(s),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",An.PACKET_JOINED_DEST_CHANNEL),I.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const a=this.genMessage(gn.StartPacketTransfer,t);await this.signal.request(a),this.emit("event",An.PACKET_SENT_TO_DEST_CHANNEL),this.state=lo.RELAY_STATE_RUNNING,I.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(t){const i=this.genMessage(gn.UpdateDestChannel,t);await this.signal.request(i),this.emit("event",An.PACKET_UPDATE_DEST_CHANNEL),I.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const t=this.genMessage(gn.StopPacketTransfer);await this.signal.request(t),I.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(t,i){const r=[],o=[],s=[];this.requestId+=1;const a={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:Qs,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};a.sdkVersion==="4.24.2"&&(a.sdkVersion="0.0.1");let c=null,d=null;switch(t){case gn.SetSdkProfile:return a.clientRequest={command:"SetSdkProfile",type:"multi_channel"},a;case gn.SetSourceChannel:if(d=i&&i.getSrcChannelMediaInfo(),!d)throw new $(O.UNEXPECTED_ERROR,"can not find source config");return a.clientRequest={command:"SetSourceChannel",uid:"0",channelName:d.channelName,token:d.token||this.joinInfo.appId},a;case gn.SetSourceUserId:if(d=i&&i.getSrcChannelMediaInfo(),!d)throw new $(O.UNEXPECTED_ERROR,"can not find source config");return a.clientRequest={command:"SetSourceUserId",uid:d.uid+""},a;case gn.SetDestChannel:if(c=i&&i.getDestChannelMediaInfo(),!c)throw new $(O.UNEXPECTED_ERROR,"can not find dest config");return c.forEach(l=>{r.push(l.channelName),o.push(l.uid+""),s.push(l.token||this.joinInfo.appId)}),a.clientRequest={command:"SetDestChannel",channelName:r,uid:o,token:s},a;case gn.StartPacketTransfer:return a.clientRequest={command:"StartPacketTransfer"},a;case gn.Reconnect:return a.clientRequest={command:"Reconnect"},a;case gn.StopPacketTransfer:return a.clientRequest={command:"StopPacketTransfer"},a;case gn.UpdateDestChannel:if(c=i&&i.getDestChannelMediaInfo(),!c)throw new $(O.UNEXPECTED_ERROR,"can not find dest config");return c.forEach(l=>{r.push(l.channelName),o.push(l.uid+""),s.push(l.token||this.joinInfo.appId)}),a.clientRequest={command:"UpdateDestChannel",channelName:r,uid:o,token:s},a;case gn.SetVideoProfile:a.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return a}}const W2={name:"ChannelMediaRelay",create:function(e){return new h9(e.joinInfo,e.clientId,e.websocketRetryConfig||yr,e.httpRetryConfig||yr,e.resolution)}};function Fm(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function vR(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Fm(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Fm(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}class H2 extends Vi{constructor(t,i,r,o){super(),M(this,"spec",void 0),M(this,"token",void 0),M(this,"websocket",void 0),M(this,"pingpongTimer",void 0),M(this,"reconnectMode","retry"),M(this,"serviceMode",void 0),M(this,"reqId",0),M(this,"commandReqId",0),M(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),M(this,"handleWebSocketMessage",s=>{if(!s.data)return;const a=JSON.parse(s.data);a.requestId?this.emit("@".concat(a.requestId,"-").concat(a.sid),a):(H.workerEvent(this.spec.sid,{actionType:"status",serverCode:a.code,workerType:this.serviceMode===xu.TRANSCODE?1:2}),this.emit(Al.PUBLISH_STREAM_STATUS,a))}),this.spec=i,this.token=t,this.serviceMode=o,this.websocket=new em("live-streaming",r),this.websocket.on(ht.CONNECTED,this.handleWebSocketOpen),this.websocket.on(ht.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(ht.REQUEST_NEW_URLS,(s,a)=>{yt(this,Al.REQUEST_NEW_ADDRESS).then(s).catch(a)}),this.websocket.on(ht.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(t){return this.websocket.init(t)}async request(t,i,r,o){this.reqId+=1,t==="request"&&(this.commandReqId+=1);const s=this.commandReqId,a=this.reqId;if(!a||!this.websocket)throw new $(O.UNEXPECTED_ERROR);const c=vR({command:t,sdkVersion:Qs==="4.24.2"?"0.0.1":Qs,seq:a,requestId:a,allocate:r,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},i);if(this.websocket.state==="closed")throw new $(O.WS_DISCONNECT);const d=()=>new Z((f,m)=>{this.websocket.once(ht.CLOSED,()=>m(new $(O.WS_ABORT))),this.websocket.once(ht.CONNECTED,f)});this.websocket.state!=="connected"&&await d(),c.clientRequest&&(c.clientRequest.workerToken=this.token);const l=new Z((f,m)=>{const g=()=>{m(new $(O.WS_ABORT))};this.websocket.once(ht.RECONNECTING,g),this.websocket.once(ht.CLOSED,g),this.once("@".concat(a,"-").concat(this.spec.sid),S=>{f(S)})});o&&H.workerEvent(this.spec.sid,vR(vR({},o),{},{requestId:s,actionType:"request",payload:JSON.stringify(i.clientRequest),serverCode:0,code:0}));const h=Date.now();this.websocket.sendMessage(c);let p=null;try{p=await l}catch(f){if(this.websocket.state==="closed")throw f;return await d(),await this.request(t,i,r)}return o&&H.workerEvent(this.spec.sid,vR(vR({},o),{},{requestId:s,actionType:"response",payload:JSON.stringify(p.serverResponse),serverCode:p.code,success:p.code===200,responseTime:Date.now()-h})),p.code!==200&&this.handleResponseError(p),p}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const t=Qs==="4.24.2"?"0.0.1":Qs;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:t,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(t){switch(t.code){case qr.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void I.warning("live stream response already exists stream");case qr.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case qr.LIVE_STREAM_RESPONSE_BAD_STREAM:case qr.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new $(O.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:t.code}).throw();case qr.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(t.serverResponse.command==="UnpublishStream")return;throw new $(O.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case qr.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new $(O.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:t.code}).throw();case qr.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const i=new $(O.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(Al.WARNING,i,t.serverResponse.url)}case qr.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const i=new $(O.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(Al.WARNING,i,t.serverResponse.url)}case qr.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new $(O.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case qr.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new $(O.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:t.code}).throw();case qr.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const i=new $(O.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(Al.WARNING,i,t.serverResponse.url)}case qr.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new $(O.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code}).throw();case qr.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new $(O.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case qr.LIVE_STREAM_RESPONSE_WORKER_LOST:case qr.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(t.serverResponse.command==="UnpublishStream")return;throw new $(O.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case qr.ERROR_FAIL_SEND_MESSAGE:if(t.serverResponse.command==="UnpublishStream")return;if(t.serverResponse.command==="UpdateTranscoding"||t.serverResponse.command==="ControlStream")return new $(O.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:t.code}).throw();throw new $(O.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case qr.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case qr.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case qr.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case qr.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new $(O.LIVE_STREAMING_CDN_ERROR,"",{code:t.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(Pf)},6e3)}}function fs(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function Ls(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?fs(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):fs(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}class p9 extends Vi{constructor(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:yr,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:yr;super(),M(this,"onLiveStreamWarning",void 0),M(this,"onLiveStreamError",void 0),M(this,"spec",void 0),M(this,"retryTimeout",1e4),M(this,"connection",void 0),M(this,"httpRetryConfig",void 0),M(this,"wsRetryConfig",void 0),M(this,"streamingTasks",new Map),M(this,"isStartingStreamingTask",!1),M(this,"taskMutex",new jr("live-streaming")),M(this,"cancelToken",hs.CancelToken.source()),M(this,"transcodingConfig",void 0),M(this,"uapResponse",void 0),M(this,"lastTaskId",1),M(this,"statusError",new Map),this.spec=t,this.httpRetryConfig=r,this.wsRetryConfig=i}async setTranscodingConfig(t){const i=Ls(Ls({},Fh),t);i.videoCodecProfile!==66&&i.videoCodecProfile!==77&&i.videoCodecProfile!==100&&(I.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(i.videoCodecProfile," -> 100")),i.videoCodecProfile=100),i.transcodingUsers||(i.transcodingUsers=i.userConfigs),i.transcodingUsers&&(i.transcodingUsers=i.transcodingUsers.map(a=>Ls(Ls(Ls({},GP),a),{},{zOrder:a.zOrder?a.zOrder+1:1}))),function(a){_r(a.width)||Ai(a.width,"config.width",0,1e4),_r(a.height)||Ai(a.height,"config.height",0,1e4),_r(a.videoBitrate)||Ai(a.videoBitrate,"config.videoBitrate",1,1e6),_r(a.videoFrameRate)||Ai(a.videoFrameRate,"config.videoFrameRate"),_r(a.lowLatency)||xi(a.lowLatency,"config.lowLatency"),_r(a.audioSampleRate)||Rt(a.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),_r(a.audioBitrate)||Ai(a.audioBitrate,"config.audioBitrate",1,128),_r(a.audioChannels)||Rt(a.audioChannels,"config.audioChannels",[1,2,3,4,5]),_r(a.videoGop)||Ai(a.videoGop,"config.videoGop"),_r(a.videoCodecProfile)||Rt(a.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),_r(a.userCount)||Ai(a.userCount,"config.userCount",0,17),_r(a.backgroundColor)||Ai(a.backgroundColor,"config.backgroundColor",0,16777215),_r(a.userConfigExtraInfo)||Ar(a.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),a.transcodingUsers&&!_r(a.transcodingUsers)&&(Pi(a.transcodingUsers,"config.transcodingUsers"),a.transcodingUsers.forEach((c,d)=>{Mc(c.uid),_r(c.x)||Ai(c.x,"transcodingUser[".concat(d,"].x"),0,1e4),_r(c.y)||Ai(c.y,"transcodingUser[".concat(d,"].y"),0,1e4),_r(c.width)||Ai(c.width,"transcodingUser[".concat(d,"].width"),0,1e4),_r(c.height)||Ai(c.height,"transcodingUser[".concat(d,"].height"),0,1e4),_r(c.zOrder)||Ai(c.zOrder-1,"transcodingUser[".concat(d,"].zOrder"),0,100),_r(c.alpha)||Ai(c.alpha,"transcodingUser[".concat(d,"].alpha"),0,1,!1)})),_r(a.watermark)||WP(a.watermark,"watermark"),_r(a.backgroundImage)||WP(a.backgroundImage,"backgroundImage"),a.images&&!_r(a.images)&&(Pi(a.images,"config.images"),a.images.forEach((c,d)=>{WP(c,"images[".concat(d,"]"))}))}(i);const r=[];i.images&&r.push(...i.images.map(a=>Ls(Ls(Ls({},IT),a),{},{zOrder:255}))),i.backgroundImage&&(r.push(Ls(Ls(Ls({},IT),i.backgroundImage),{},{zOrder:0})),delete i.backgroundImage),i.watermark&&(r.push(Ls(Ls(Ls({},IT),i.watermark),{},{zOrder:255})),delete i.watermark),i.images=r,i.transcodingUsers&&(i.userConfigs=i.transcodingUsers.map(a=>Ls({},a)),i.userCount=i.transcodingUsers.length,delete i.transcodingUsers);const o=(i.userConfigs||[]).map(a=>typeof a.uid=="number"?Z.resolve(a.uid):i2(a.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await Z.all(o)).forEach((a,c)=>{i.userConfigs&&i.userConfigs[c]&&(i.userConfigs[c].uid=a)}),this.transcodingConfig=i,this.connection)try{var s;const a=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(Vr(s=this.streamingTasks).call(s)).map(c=>c.taskId).join("#")});I.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(a.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(a){if(!a.data||!a.data.retry)throw a;a.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(c=>{I.warning("[".concat(this.spec.clientId,"] live streaming receive error"),a.toString(),"try to republish",c.url),this.startLiveStreamingTask(c.url,c.mode,a).then(()=>{I.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(c.url," success"))}).catch(d=>{I.error("[".concat(this.spec.clientId,"] live streaming republish failed"),c.url,d.toString()),this.onLiveStreamError&&this.onLiveStreamError(c.url,d)})})}}async startLiveStreamingTask(t,i,r){if(!this.transcodingConfig&&i===xu.TRANSCODE)throw new $(O.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");const o={command:"PublishStream",ts:Date.now(),url:t,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};I.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(t,", mode: ").concat(i));const s=await this.taskMutex.lock();if(!this.connection&&r)return void s();if(this.streamingTasks.get(t)&&!r)return s(),new $(O.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(i))}catch(c){throw s(),c}switch(i){case xu.TRANSCODE:o.transcodingConfig=Ls({},this.transcodingConfig)}this.uapResponse&&this.uapResponse.vid&&(o.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const a=this.lastTaskId++;try{const c=new Z((l,h)=>{vt(this.retryTimeout).then(()=>{if(r)return h(r);const p=this.statusError.get(t);return p?(this.statusError.delete(t),h(p)):void 0})}),d=await Z.race([this.connection.request("request",{clientRequest:o},!0,{url:t,command:"PublishStream",workerType:i===xu.TRANSCODE?1:2,requestByUser:!r,tid:a.toString()}),c]);this.isStartingStreamingTask=!1,I.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(d.code)),this.streamingTasks.set(t,{clientRequest:o,mode:i,url:t,taskId:a}),s()}catch(c){if(s(),this.isStartingStreamingTask=!1,!c.data||!c.data.retry||r)throw c;return c.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(t,i,c)):await this.startLiveStreamingTask(t,i,c)}}stopLiveStreamingTask(t){return new Z((i,r)=>{const o=this.streamingTasks.get(t);if(!o||!this.connection)return new $(O.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const s=o.mode;o.abortTask=()=>{I.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(t),i()},this.connection.request("request",{clientRequest:{command:"UnpublishStream",url:o.url}},!1,{url:t,command:"UnPublishStream",workerType:s===xu.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(a=>{I.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(a.code)),this.streamingTasks.delete(t),this.streamingTasks.size===0&&(this.connection&&this.connection.close(),this.connection=void 0),i()}).catch(r)})}resetAllTask(){var t;const i=Array.from(Vr(t=this.streamingTasks).call(t));this.terminate();for(const r of i)this.startLiveStreamingTask(r.url,r.mode).catch(o=>{this.onLiveStreamError&&this.onLiveStreamError(r.url,o)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=hs.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(t){if(this.connection)throw new $(O.UNEXPECTED_ERROR,"live streaming connection has already connected");const i=await yt(this,Gr.REQUEST_WORKER_MANAGER_LIST,t);return this.uapResponse=i,this.connection=new H2(i.workerToken,this.spec,this.wsRetryConfig,t),this.connection.on(Al.WARNING,(r,o)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(o,r)),this.connection.on(Al.PUBLISH_STREAM_STATUS,r=>this.handlePublishStreamServer(r)),this.connection.on(Al.REQUEST_NEW_ADDRESS,(r,o)=>{if(!this.connection)return o(new $(O.UNEXPECTED_ERROR,"can not get new live streaming address list"));yt(this,Gr.REQUEST_WORKER_MANAGER_LIST,t).then(s=>{this.uapResponse=s,r(s.addressList)}).catch(o)}),await this.connection.init(i.addressList),this.connection}handlePublishStreamServer(t){const i=t.serverStatus&&t.serverStatus.url||"empty_url",r=this.streamingTasks.get(i),o=t.reason;switch(t.code){case qr.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case qr.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case qr.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case qr.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const a=new $(O.LIVE_STREAMING_CDN_ERROR,"",{code:t.code});if(r)return I.error(a.toString()),this.onLiveStreamError&&this.onLiveStreamError(i,a);if(!this.isStartingStreamingTask)return;this.statusError.set(i,a)}case qr.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const a=new $(O.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,o);return this.onLiveStreamWarning&&this.onLiveStreamWarning(i,a)}case qr.LIVE_STREAM_RESPONSE_WORKER_LOST:case qr.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var s;if(!this.connection)return;this.connection.tryNextAddress();const a=Array.from(Vr(s=this.streamingTasks).call(s));for(const c of a)c.abortTask?c.abortTask():(I.warning("[".concat(this.spec.clientId,"] publish stream status code"),t.code,"try to republish",c.url),this.startLiveStreamingTask(c.url,c.mode,new $(O.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code})).then(()=>{I.debug("[".concat(this.spec.clientId,"] republish live stream success"),c.url)}).catch(d=>{I.error(d.toString()),this.onLiveStreamError&&this.onLiveStreamError(c.url,d)}));return}}}hasUrl(t){return this.streamingTasks.has(t)}}const _9={name:"LiveStreaming",create:function(e){return new p9(e.joinInfo,e.websocketRetryConfig||yr,e.httpRetryConfig||yr)}};function f9(e){let t=z2();return function(i,r){let o=i.appId;o!==void 0&&(hi(r,10),Bl(r,o));let s=i.cid;s!==void 0&&(hi(r,16),hi(r,s));let a=i.cname;a!==void 0&&(hi(r,26),Bl(r,a));let c=i.deviceId;c!==void 0&&(hi(r,34),Bl(r,c));let d=i.elapse;d!==void 0&&(hi(r,40),th(r,d));let l=i.fileSize;l!==void 0&&(hi(r,48),th(r,$_(l)));let h=i.height;h!==void 0&&(hi(r,56),th(r,$_(h)));let p=i.jpg;p!==void 0&&(hi(r,66),hi(r,p.length),function(ae,Y){let ie=rp(ae,Y.length);ae.bytes.set(Y,ie)}(r,p));let f=i.networkType;f!==void 0&&(hi(r,72),th(r,$_(f)));let m=i.osType;m!==void 0&&(hi(r,80),th(r,$_(m)));let g=i.requestId;g!==void 0&&(hi(r,90),Bl(r,g));let S=i.sdkVersion;S!==void 0&&(hi(r,98),Bl(r,S));let T=i.sequence;T!==void 0&&(hi(r,104),th(r,$_(T)));let C=i.sid;C!==void 0&&(hi(r,114),Bl(r,C));let b=i.timestamp;b!==void 0&&(hi(r,120),th(r,b));let D=i.uid;D!==void 0&&(hi(r,128),hi(r,D));let x=i.vid;x!==void 0&&(hi(r,136),hi(r,x));let k=i.width;k!==void 0&&(hi(r,144),th(r,$_(k)));let V=i.service;V!==void 0&&(hi(r,152),hi(r,V));let W=i.callbackData;W!==void 0&&(hi(r,162),Bl(r,W));let K=i.jpgEncryption;K!==void 0&&(hi(r,168),hi(r,K));let J=i.requestType;J!==void 0&&(hi(r,176),hi(r,J));let se=i.scorePorn;se!==void 0&&(hi(r,185),qc(r,se));let Ne=i.scoreSexy;Ne!==void 0&&(hi(r,193),qc(r,Ne));let Ce=i.scoreNeutral;Ce!==void 0&&(hi(r,201),qc(r,Ce));let De=i.scene;De!==void 0&&(hi(r,208),hi(r,De));let Me=i.ossFilePrefix;Me!==void 0&&(hi(r,218),Bl(r,Me));let et=i.serviceVendor;if(et!==void 0)for(let ae of et){hi(r,226);let Y=z2();g9(ae,Y),hi(r,Y.limit),q2(r,Y),Jk(Y)}}(e,t),function(i){let r=i.bytes,o=i.limit;return r.length===o?r:r.subarray(0,o)}(t)}function m9(e){return function(i){let r={};e:for(;!ef(i);){let o=ni(i);switch(o>>>3){case 0:break e;case 1:r.code=ni(i);break;case 2:r.msg=rl(i,ni(i));break;case 3:{let s=K2(i);r.data=E9(i),i.limit=s;break}default:Y2(i,7&o)}}return r}({bytes:t=e,offset:0,limit:t.length});var t}function E9(e){let t={};e:for(;!ef(e);){let i=ni(e);switch(i>>>3){case 0:break e;case 1:t.requestId=rl(e,ni(e));break;case 2:t.requestType=ni(e)>>>0;break;case 3:t.scorePorn=CR(e);break;case 4:t.scoreSexy=CR(e);break;case 5:t.scoreNeutral=CR(e);break;case 6:t.requestScene=ni(e)>>>0;break;case 7:t.scene=ni(e)>>>0;break;default:Y2(e,7&i)}}return t}function g9(e,t){let i=e.service;i!==void 0&&(hi(t,8),hi(t,i));let r=e.vendor;r!==void 0&&(hi(t,16),hi(t,r));let o=e.token;o!==void 0&&(hi(t,26),Bl(t,o));let s=e.callbackUrl;s!==void 0&&(hi(t,34),Bl(t,s))}function K2(e){let t=ni(e),i=e.limit;return e.limit=e.offset+t,i}function Y2(e,t){switch(t){case 0:for(;128&Qk(e););break;case 2:uy(e,ni(e));break;case 5:uy(e,4);break;case 1:uy(e,8);break;default:throw new Error("Unimplemented type: "+t)}}let qk=new Float32Array(1);new Uint8Array(qk.buffer);let es=new Float64Array(1),uo=new Uint8Array(es.buffer);function $_(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let Xk=[];function z2(){const e=Xk.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}function Jk(e){Xk.push(e)}function uy(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function ef(e){return e.offset>=e.limit}function rp(e,t){let i=e.bytes,r=e.offset,o=e.limit,s=r+t;if(s>i.length){let a=new Uint8Array(2*s);a.set(i),e.bytes=a}return e.offset=s,s>o&&(e.limit=s),r}function hy(e,t){let i=e.offset;if(i+t>e.limit)throw new Error("Read past limit");return e.offset+=t,i}function rl(e,t){let i=hy(e,t),r=String.fromCharCode,o=e.bytes,s="",a="";for(let c=0;c<t;c++){let d,l,h,p,f=o[c+i];128&f?(224&f)==192?c+1>=t?a+=s:(d=o[c+i+1],(192&d)!=128?a+=s:(p=(31&f)<<6|63&d,p<128?a+=s:(a+=r(p),c++))):(240&f)==224?c+2>=t?a+=s:(d=o[c+i+1],l=o[c+i+2],(49344&(d|l<<8))!=32896?a+=s:(p=(15&f)<<12|(63&d)<<6|63&l,p<2048||p>=55296&&p<=57343?a+=s:(a+=r(p),c+=2))):(248&f)==240?c+3>=t?a+=s:(d=o[c+i+1],l=o[c+i+2],h=o[c+i+3],(12632256&(d|l<<8|h<<16))!=8421504?a+=s:(p=(7&f)<<18|(63&d)<<12|(63&l)<<6|63&h,p<65536||p>1114111?a+=s:(p-=65536,a+=r(55296+(p>>10),56320+(1023&p)),c+=3))):a+=s:a+=r(f)}return a}function Bl(e,t){let i=t.length,r=0;for(let a=0;a<i;a++){let c=t.charCodeAt(a);c>=55296&&c<=56319&&a+1<i&&(c=(c<<10)+t.charCodeAt(++a)-56613888),r+=c<128?1:c<2048?2:c<65536?3:4}hi(e,r);let o=rp(e,r),s=e.bytes;for(let a=0;a<i;a++){let c=t.charCodeAt(a);c>=55296&&c<=56319&&a+1<i&&(c=(c<<10)+t.charCodeAt(++a)-56613888),c<128?s[o++]=c:(c<2048?s[o++]=c>>6&31|192:(c<65536?s[o++]=c>>12&15|224:(s[o++]=c>>18&7|240,s[o++]=c>>12&63|128),s[o++]=c>>6&63|128),s[o++]=63&c|128)}}function q2(e,t){let i=rp(e,t.limit),r=e.bytes,o=t.bytes;for(let s=0,a=t.limit;s<a;s++)r[s+i]=o[s]}function Qk(e){return e.bytes[hy(e,1)]}function py(e,t){let i=rp(e,1);e.bytes[i]=t}function CR(e){let t=hy(e,8),i=e.bytes;return uo[0]=i[t++],uo[1]=i[t++],uo[2]=i[t++],uo[3]=i[t++],uo[4]=i[t++],uo[5]=i[t++],uo[6]=i[t++],uo[7]=i[t++],es[0]}function qc(e,t){let i=rp(e,8),r=e.bytes;es[0]=t,r[i++]=uo[0],r[i++]=uo[1],r[i++]=uo[2],r[i++]=uo[3],r[i++]=uo[4],r[i++]=uo[5],r[i++]=uo[6],r[i++]=uo[7]}function ni(e){let t,i=0,r=0;do t=Qk(e),i<32&&(r|=(127&t)<<i),i+=7;while(128&t);return r}function hi(e,t){for(t>>>=0;t>=128;)py(e,127&t|128),t>>>=7;py(e,t)}function th(e,t){let i=t.low>>>0,r=(t.low>>>28|t.high<<4)>>>0,o=t.high>>>24,s=o===0?r===0?i<16384?i<128?1:2:i<1<<21?3:4:r<16384?r<128?5:6:r<1<<21?7:8:o<128?9:10,a=rp(e,s),c=e.bytes;switch(s){case 10:c[a+9]=o>>>7&1;case 9:c[a+8]=s!==9?128|o:127&o;case 8:c[a+7]=s!==8?r>>>21|128:r>>>21&127;case 7:c[a+6]=s!==7?r>>>14|128:r>>>14&127;case 6:c[a+5]=s!==6?r>>>7|128:r>>>7&127;case 5:c[a+4]=s!==5?128|r:127&r;case 4:c[a+3]=s!==4?i>>>21|128:i>>>21&127;case 3:c[a+2]=s!==3?i>>>14|128:i>>>14&127;case 2:c[a+1]=s!==2?i>>>7|128:i>>>7&127;case 1:c[a]=s!==1?128|i:127&i}}function X2(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}const S9=new Map([["moderation",1],["supervise",2]]);class T9 extends Vi{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const i=this._connectionState;this._connectionState=t,this.emit(br.CONNECTION_STATE_CHANGE,i,t)}get inspectType(){return this._inspectType}set inspectType(t){var i;this._inspectMode=un(i=t.map(r=>S9.get(r)||0)).call(i,(r,o)=>r+o),this._inspectType=t}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(t){super(),M(this,"name","AgoraRTCVideoContentInspect"),M(this,"_connectionState",Kn.CONNECTING),M(this,"_innerConnectionState",void 0),M(this,"sequence",0),M(this,"inspectStartTime",void 0),M(this,"workerManagerConnection",void 0),M(this,"workerConnection",void 0),M(this,"workerMessageLengthLimit",void 0),M(this,"inspectIntervalMinimum",void 0),M(this,"qualityRatio",void 0),M(this,"_connectInfo",void 0),M(this,"_cancelTokenSource",hs.CancelToken.source()),M(this,"_retryConfig",void 0),M(this,"wmSequence",0),M(this,"inspectInterval",void 0),M(this,"inspectTimer",null),M(this,"ossFilePrefix",void 0),M(this,"extraInfo",void 0),M(this,"_inspectType",void 0),M(this,"_inspectMode",void 0),M(this,"_quality",1),M(this,"qualityTimer",null),M(this,"_inspectId",void 0),M(this,"_needWorkUrlOnly",!1),M(this,"inspectImage",()=>{if(this.connectionState!==Kn.CONNECTED)throw new $(O.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===Kn.CONNECTED?this.requestToInspectImage():I.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=li(5,"inspect-"),this.workerMessageLengthLimit=B("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=B("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=B("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=t.interval,this.ossFilePrefix=t.ossFilePrefix,this.extraInfo=t.extraInfo,this.inspectType=t.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new em("worker-manager-"+this._inspectId,yr),this.on(br.STATE_CHANGE,(i,r)=>{this._innerConnectionState=i,I.debug("[".concat(this._inspectId,"] Inspect operation :").concat(sr[i]," ").concat(r||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new em("worker-"+this._inspectId,yr),this.handleWorkerEvents()}async init(t,i){this.emit(br.STATE_CHANGE,sr.CONNECT_AP),this._connectInfo=t;const r=this._cancelTokenSource.token;return this._retryConfig=i,new Z((o,s)=>{this.on(br.CONNECTION_STATE_CHANGE,(a,c)=>{c===Kn.CONNECTED&&o()}),this.requestAP(t,r,i).then(a=>{this.connectWorkerManager(a)}).catch(a=>{s(a)})})}async requestAP(t,i,r){const o=B("WEBCS_DOMAIN").map(c=>"https://".concat(c,"/api/v1")),s=await function(c,d,l,h){let{appId:p,areaCode:f,cname:m,sid:g,token:S,uid:T}=d;qd++;const C="image_moderation_api",b={service_name:C,json_body:JSON.stringify({appId:p,areaCode:f,cname:m,command:"allocateEdge",requestId:qd,seq:qd,sid:g,token:S,ts:Date.now(),uid:T+""})};let D,x,k=c[0];return ma(async()=>{D=Date.now();const V=await na(k,{data:b,cancelToken:l,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(x=Date.now()-D,V.code!==0){const Ce=new $(O.UNEXPECTED_RESPONSE,"image inspect ap error, code"+V.code,{retry:!0,responseTime:x});throw I.error(Ce.toString()),Ce}const W=JSON.parse(V.json_body);if(W.code!==200){const Ce=new $(O.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(W.code,", reason: ").concat(W.reason),{code:W.code,responseTime:x});throw I.error(Ce.toString()),Ce}if(!W.servers||!Array.isArray(W.servers)||W.servers.length===0){const Ce=new $(O.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:W.code,responseTime:x});throw I.error(Ce.toString()),Ce}const K=B("VIDEO_INSPECT_WORKER_MANAGER_WSS");if(K)return{addressList:[K],workerToken:W.workerToken,vid:W.vid,responseTime:x};const J=B("VIDEO_INSPECT_WORKER_MANAGER_HOST"),se=B("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:W.servers.map(Ce=>{let{address:De,wss:Me}=Ce;if(De&&Me)return"wss://".concat(De.replace(/\./g,"-"),".").concat(J,":").concat(se||Me)}).filter(Ce=>!!Ce),workerToken:W.workerToken,vid:W.vid,responseTime:x}},(V,W)=>(H.apworkerEvent(g,{success:!0,sc:200,serviceName:C,responseDetail:JSON.stringify(V.addressList),firstSuccess:W===0,responseTime:x,serverIp:c[W%c.length]}),!1),(V,W)=>(H.apworkerEvent(g,{success:!1,sc:V.data&&V.data.code||200,serviceName:C,responseTime:x,serverIp:c[W%c.length]}),!!(V.code!==O.OPERATION_ABORTED&&V.code!==O.UNEXPECTED_RESPONSE||V.data&&V.data.retry)&&(k=c[(W+1)%c.length],!0)),h)}(o,t,i,r);this.emit(br.STATE_CHANGE,sr.AP_CONNECTED);const{addressList:a}=s;return this.wmSequence++,a}async connectWorkerManager(t){let i=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=i,this.emit(br.STATE_CHANGE,sr.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(t,1e4)}async connectWorker(t){await this.workerConnection.init([t])}handleWorkerManagerEvents(){this.workerManagerConnection.on(ht.CONNECTED,async()=>{this.emit(br.STATE_CHANGE,sr.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.24.2",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(ht.CLOSED,()=>{this._innerConnectionState<sr.GET_WORKER_MANAGER_RESPONSE&&I.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(ht.FAILED,()=>{this._innerConnectionState<sr.GET_WORKER_MANAGER_RESPONSE&&I.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(ht.RECONNECTING,()=>{this._innerConnectionState<sr.GET_WORKER_MANAGER_RESPONSE&&I.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(ht.ON_MESSAGE,async t=>{this.emit(br.STATE_CHANGE,sr.GET_WORKER_MANAGER_RESPONSE);const i=this.workerManagerConnection.url;this.workerManagerConnection.close();const r=JSON.parse(t.data);if(r.code!==200)throw I.error("[".concat(this._inspectId,"] Unexpected code ").concat(r.code," from worker manager")),new $(O.UNEXPECTED_RESPONSE,"response code of worker is unexpected",r);if(!(r.serverResponse&&r.serverResponse.portWss&&i))throw I.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(r))),new $(O.UNEXPECTED_RESPONSE,"response content of worker is unexpected",r);{const o=B("VIDEO_INSPECT_WORKER_PORT")||r.serverResponse.portWss,s=i.replace(/:\d+\/?$/,":".concat(o));this.emit(br.STATE_CHANGE,sr.CONNECT_WORKER,s),this._needWorkUrlOnly?this.emit(br.REQUEST_NEW_WORKER_URL,s):await this.connectWorker(s)}}),this.workerManagerConnection.on(ht.WILL_RECONNECT,(t,i,r)=>{r(t)}),this.workerManagerConnection.on(ht.REQUEST_NEW_URLS,(t,i)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(i)})}handleWorkerEvents(){this.workerConnection.on(ht.CONNECTED,async()=>{this.emit(br.STATE_CHANGE,sr.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=Kn.CONNECTED}),this.workerConnection.on(ht.ON_MESSAGE,async t=>{if(t.data instanceof ArrayBuffer){const r=m9(new Uint8Array(t.data));if(B("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&I.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(r)),r.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(br.INSPECT_RESULT,void 0,void 0);if(r.data&&r.data.scorePorn&&r.data.scoreSexy&&r.data.scoreNeutral){var i;const o={porn:r.data.scorePorn,sexy:r.data.scoreSexy,neutral:r.data.scoreNeutral},s=un(i=Object.keys(o)).call(i,(c,d)=>o[c]>o[d]?c:d,"porn"),a=Object.keys(o).find(c=>c===s);this.emit(br.INSPECT_RESULT,a)}else this.emit(br.INSPECT_RESULT,void 0,new $(O.UNEXPECTED_RESPONSE,r.code+"","There is an unexpected data on message"))}else this.emit(br.INSPECT_RESULT,void 0,new $(O.UNEXPECTED_RESPONSE,r.code+"",r.msg))}else I.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(br.INSPECT_RESULT,void 0,new $(O.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(ht.CLOSED,()=>{this.connectionState=Kn.CLOSED}),this.workerConnection.on(ht.FAILED,()=>{this.connectionState=Kn.CLOSED}),this.workerConnection.on(ht.RECONNECTING,()=>{this.connectionState=this.connectionState===Kn.CONNECTED?Kn.RECONNECTING:Kn.CONNECTING}),this.workerConnection.on(ht.WILL_RECONNECT,(t,i,r)=>{t==="recover"&&r(t),r("tryNext")}),this.workerConnection.on(ht.REQUEST_NEW_URLS,(t,i)=>{this.workerManagerConnection.close(),this.once(br.REQUEST_NEW_WORKER_URL,r=>{t([r])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(r=>{this.connectWorkerManager(r,!0)}).catch(r=>{i(r)})})}async requestToInspectImage(){this.sequence++;const t=co(this,br.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void this.emit(br.INSPECT_RESULT,void 0,new $(O.INVALID_OPERATION,"Only the track being played can be inspected"));const r=await this.generateRequestData(t,i);this.workerConnection.sendMessage(r,!0,!0)}else this.emit(br.INSPECT_RESULT,void 0,new $(O.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(t,i){let{appId:r,cname:o,cid:s,vid:a,sid:c,uid:d}=i;const l=Date.now(),h=await t.getCurrentFrameImage("image/jpeg",this.quality),p=await Hv(h,r,o),f=this.sequence+"-"+s+"-"+d+"-"+l+"-"+li(12,""),m={appId:r,cid:s,cname:o,deviceId:"",elapse:(g=Number(l-this.inspectStartTime),{low:g|=0,high:g>>31,unsigned:g>=0}),fileSize:p.byteLength,jpgEncryption:2,height:h.height,width:h.width,jpg:p,networkType:6,osType:7,requestId:f,sdkVersion:"4.24.2",sequence:this.sequence,sid:c,timestamp:xL(l),uid:d,vid:a,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};var g;this.extraInfo===void 0&&delete m.callbackData,this.ossFilePrefix===void 0&&delete m.ossFilePrefix;const S=f9(m);if(S.byteLength<this.workerMessageLengthLimit){if(B("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const T=function(C){for(var b=1;b<arguments.length;b++){var D=arguments[b]!=null?arguments[b]:{};b%2?X2(Object(D),!0).forEach(function(x){M(C,x,D[x])}):Object.getOwnPropertyDescriptors?Object.defineProperties(C,Object.getOwnPropertyDescriptors(D)):X2(Object(D)).forEach(function(x){Object.defineProperty(C,x,Object.getOwnPropertyDescriptor(D,x))})}return C}({},m);delete T.jpg,I.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(T))}return S}{const T=this.quality*this.qualityRatio;return this.quality=T,await this.generateRequestData(t,{appId:r,cname:o,cid:s,vid:a,sid:c,uid:d})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=hs.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=Kn.CLOSED,this.emit(br.STATE_CHANGE,sr.CLOSED)}}const J2={name:"ContentInspect",create:function(e){let{config:t}=e;return function(i){if(!i)throw new $(O.INVALID_PARAMS,"inspectConfig is necessary.");if(!i.inspectType||!Array.isArray(i.inspectType))throw new $(O.INVALID_PARAMS,"inspectConfig.inspectType is necessary and is an instance of Array.");{const r=[...new Set(i.inspectType)];r.forEach(o=>{var s;if(!z(s=["supervise","moderation"]).call(s,o))throw new $(O.INVALID_PARAMS,"".concat(o," is not a valid inspect type."))}),i.inspectType=r}if(i&&i.extraInfo&&i.extraInfo.length>1024)throw new $(O.INVALID_PARAMS,"inspectConfig.extraInfo length cannot exceed 1024 bytes")}(t),new T9(t)}};var Q2=A(Qr.Object.getOwnPropertySymbols),R9=qe,v9=CE.indexOf,Zk=_p,_y=Ri([].indexOf),Z2=!!_y&&1/_y([1],1,-0)<0;R9({target:"Array",proto:!0,forced:Z2||!Zk("indexOf")},{indexOf:function(e){var t=arguments.length>1?arguments[1]:void 0;return Z2?_y(this,e,t)||0:v9(this,e,t)}});var C9=ln("Array","indexOf"),y9=me,$k=C9,e1=Array.prototype,$2=function(e){var t=e.indexOf;return e===e1||y9(e1,e)&&t===e1.indexOf?$k:t},ex=A($2);function tx(e,t){if(e==null)return{};var i,r,o=function(a,c){if(a==null)return{};var d={};for(var l in a)if({}.hasOwnProperty.call(a,l)){if(ex(c).call(c,l)!==-1)continue;d[l]=a[l]}return d}(e,t);if(Q2){var s=Q2(e);for(r=0;r<s.length;r++)i=s[r],ex(t).call(t,i)===-1&&{}.propertyIsEnumerable.call(e,i)&&(o[i]=e[i])}return o}let ix=class{get localCapabilities(){return wi(this._localCapabilities)}get rtpCapabilities(){return wi(this._rtpCapabilities)}get candidates(){return wi(this._candidates)}get iceParameters(){return wi(this._iceParameters)}get dtlsParameters(){return wi(this._dtlsParameters)}constructor(e){M(this,"sessionDesc",void 0),M(this,"_localCapabilities",void 0),M(this,"_rtpCapabilities",void 0),M(this,"_candidates",void 0),M(this,"_iceParameters",void 0),M(this,"_dtlsParameters",void 0),M(this,"setup",void 0),M(this,"currentMidIndex",void 0),M(this,"cname","o/i14u9pJrxRKAsu"),M(this,"firefoxSsrcMidMap",new Map),e=wi(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:r,remoteRTPCapabilities:o,localCapabilities:s,direction:a,setup:c,videoCodec:d,audioCodec:l}=e;let h;this.setup=c,h=a===Je.RECEIVE_ONLY?sn(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):sn(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=o,this._candidates=r,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=s;const p=a===Je.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,f=a===Je.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,m=a===Je.RECEIVE_ONLY?o.send.videoCodecs:Vc(be.VIDEO,p,f,d),g=a===Je.RECEIVE_ONLY?o.send.audioCodecs:Vc(be.AUDIO,p,f,l);for(const S of h.mediaDescriptions)S.attributes.iceUfrag=t.iceUfrag,S.attributes.icePwd=t.icePwd,S.attributes.fingerprints=i.fingerprints,S.attributes.candidates=r,S.attributes.setup=this.setup,S.media.mediaType==="application"&&(S.attributes.sctpPort="5000"),S.media.mediaType==="video"&&(S.media.fmts=m.map(T=>T.payloadType.toString(10)),S.attributes.payloads=m,S.attributes.extmaps=p.videoExtensions),S.media.mediaType==="audio"&&(S.media.fmts=g.map(T=>T.payloadType.toString(10)),S.attributes.payloads=g,S.attributes.extmaps=p.audioExtensions,Nl(S));this.sessionDesc=h,this.currentMidIndex=h.mediaDescriptions.length-1}toString(){return Du(this.sessionDesc)}hasMid(e){return Array.isArray(e)?e.every(t=>this.hasMid(t)):this.sessionDesc.mediaDescriptions.some(t=>t.attributes.mid===e)}send(e,t,i,r,o){i=i.replace(/ /g,"-");const{ssrcs:s,ssrcGroups:a}=Kd(t,this.cname,B("SYNC_GROUP")?i:void 0),c=this.findPreloadMediaDesc(s);if(c){if(Ht()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,c.attributes.mid),o&&(o.twcc||o.remb)){const d=this.sessionDesc.mediaDescriptions.indexOf(c);return this.sessionDesc.mediaDescriptions[d]=this.mungSendMediaDesc(c,o),{mid:c.attributes.mid,needExchangeSDP:!0}}return{mid:c.attributes.mid,needExchangeSDP:!1}}{const d=this.findAvailableMediaIndex(e,s,r);let l;return d===-1?(l=this.createOrRecycleSendMedia(e,s,a,"sendonly",r,o),this.updateBundleMids()):(l=wi(this.sessionDesc.mediaDescriptions[d]),l.attributes.direction="sendonly",l.attributes.ssrcs=s,l.attributes.ssrcGroups=a,this.sessionDesc.mediaDescriptions[d]=this.mungSendMediaDesc(l,o)),Ht()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,l.attributes.mid),{needExchangeSDP:!0,mid:l.attributes.mid}}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter(i=>i.attributes.mid&&e.indexOf(i.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach(i=>{i.attributes.ssrcs=[]}),this.updateBundleMids()}receive(e,t,i){const r=[];return e.forEach(o=>{const s=o._mediaStreamTrack.kind,a=this.findAvailableRecvMediaIndex(s);let c,d=!1;a===-1?(d=!0,c=this.createOrRecycleRecvMedia(o,[],"recvonly",t,i),this.updateBundleMids()):(c=wi(this.sessionDesc.mediaDescriptions[a]),c.attributes.direction="recvonly"),r.push({mid:c.attributes.mid,needCreateTransceiver:d})}),r}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter(i=>e.indexOf(i.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach(i=>{i.media.port="0",i.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(e){const{foundation:t,protocol:i,address:r,port:o,type:s,relatedAddress:a,relatedPort:c,priority:d}=new RTCIceCandidate(e),l={foundation:t??"",componentId:"1",transport:i??"",priority:d?d+"":"",connectionAddress:r??"",port:o?o+"":"",type:s?s+"":"",relAddr:a??"",relPort:c?c+"":"",extension:{}};this.candidates.some(h=>h.priority===l.priority&&h.connectionAddress===l.connectionAddress&&h.port===l.port)||(this._candidates.push(l),this.sessionDesc.mediaDescriptions.forEach(h=>{h.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(e,t,i,r,o){const s=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=Vc(s,a,this.localCapabilities.send,s===be.AUDIO?o:r),d=s===be.VIDEO?a.videoExtensions:a.audioExtensions,l="".concat(++this.currentMidIndex);let h={media:{mediaType:s,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map(f=>f.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};h=this.mungRecvMediaDsec(h,e);const p=this.findFirstClosedMedia(s);if(p){const f=this.sessionDesc.mediaDescriptions.indexOf(p);this.sessionDesc.mediaDescriptions[f]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter(i=>z(e).call(e,i.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(i=>{i.attributes.direction="inactive"})}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter(i=>z(e).call(e,i.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(i=>{i.attributes.direction="recvonly"})}findAvailableMediaIndex(e,t,i){return this.sessionDesc.mediaDescriptions.findIndex(r=>{const o=r.media.mediaType===e&&r.media.port!=="0"&&(r.attributes.direction==="sendonly"||r.attributes.direction==="sendrecv")&&r.attributes.ssrcs.length===0;if(Ht()){if(o){const s=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(s||r.attributes.mid!=="0"&&r.attributes.mid!=="1")||!(!s||s!==r.attributes.mid)}return!1}return o&&r.attributes.mid===i})}findAvailableRecvMediaIndex(e){return this.sessionDesc.mediaDescriptions.findIndex(t=>{const i=t.media.mediaType===e&&t.media.port!=="0"&&(t.attributes.direction==="recvonly"||t.attributes.direction==="sendrecv");return t.attributes.mid!=="0"&&t.attributes.mid!=="1"&&i})}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}restartICE(e){e=wi(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd})}createOrRecycleSendMedia(e,t,i,r,o,s){const a=this.rtpCapabilities.send,c=e===be.VIDEO?a.videoCodecs:a.audioCodecs,d=e===be.VIDEO?a.videoExtensions:a.audioExtensions;Ht()&&(o="".concat(++this.currentMidIndex));let l={media:{mediaType:e,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:o}};l=this.mungSendMediaDesc(l,s);const h=this.findFirstClosedMedia(e);if(h){const p=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[p]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}mungRecvMediaDsec(e,t,i){const r=wi(e);return LT(r),Fu(r,t),cC(r,t),kT(r),cm(r,i,this.localCapabilities.send),r}mungSendMediaDesc(e,t){const i=wi(e);return cm(i,t,this.localCapabilities.recv),Nl(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===e);if(i!==-1){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=r}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(e=>e.media.port!=="0").map(e=>e.attributes.mid)}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find(t=>{var i;return((i=t.attributes)===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId)===e[0].ssrcId})}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find(t=>Ht()?t.media.port==="0"&&t.media.mediaType===e:t.media.port==="0")}};const zi=["sdp"];var Hi;function ih(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function rh(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?ih(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ih(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let mc=(Hi=class Sy extends AT{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,i;return(t=(i=this.peerConnection.getReceivers()[0])===null||i===void 0||(i=i.transport)===null||i===void 0?void 0:i.state)!==null&&t!==void 0?t:null}get localCodecs(){return[]}set isInRestartIce(t){this._isInRestartIce=t}get isInRestartIce(){return this._isInRestartIce}constructor(t,i,r){super(t,i),M(this,"direction",void 0),M(this,"name",void 0),M(this,"store",void 0),M(this,"spec",void 0),M(this,"peerConnection",void 0),M(this,"initialOffer",void 0),M(this,"transport",void 0),M(this,"statsFilter",void 0),M(this,"localCandidateCount",0),M(this,"_isInRestartIce",!1),M(this,"mutex",void 0),M(this,"onLocalCandidate",void 0),M(this,"remoteSDP",void 0),M(this,"pendingCandidates",[]),M(this,"localCapabilities",void 0),M(this,"isReady",!1),M(this,"restartCnt",0),M(this,"curTurnServerIndex",0),this.store=i,this.spec=t,this.mutex=new jr("P2PConnection-mutex",i.clientId),this.peerConnection=new RTCPeerConnection(Sy.resolvePCConfiguration(t,i.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=r??Je.SEND_ONLY,this.name=this.direction===Je.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=nT(this.peerConnection,B("STATS_UPDATE_INTERVAL"),void 0,Ht()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(t){try{const i=await uC();if(this.localCapabilities=Ol(i),t){const{sdp:r}=t,o=tx(t,zi),s=function(){const h={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},p=ba(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),f={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},m={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},g={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Ns(p,h,"videoExtensions",f,m,g),Ns(p,h,"videoCodecs",f,m,g),Ns(p,h,"audioExtensions",f,m,g),Ns(p,h,"audioCodecs",f,m,g),B("RAISE_H264_BASELINE_PRIORITY")){const S=g.videoCodecs.findIndex(T=>T.rtpMap&&T.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&T.fmtp&&T.fmtp.parameters["profile-level-id"]==="42001f");if(S!==-1){const T=g.videoCodecs.findIndex(C=>C.rtpMap&&C.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(T<S){I.debug("raising H264 baseline profile priority");const C=g.videoCodecs[S];g.videoCodecs.splice(S,1),g.videoCodecs.splice(T,0,C)}T!==-1&&B("FILTER_SEND_H264_BASELINE")&&(f.videoCodecs=f.videoCodecs.filter(C=>!(C.rtpMap&&C.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&C.fmtp&&C.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:f,recv:m,sendrecv:g}}({},{},r);this.remoteSDP=new ix({remoteIceParameters:o.iceParameters,remoteDtlsParameters:o.dtlsParameters,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const a=await this.peerConnection.createAnswer();if(!a.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const c=xc(a.sdp);await this.peerConnection.setLocalDescription(a);const d=await ac({},{},a.sdp);this.localCapabilities=Ol(d);const l=this.peerConnection.getTransceivers()[0];return l!=null&&l.receiver&&l.receiver.transport&&this.tryBindTransportEvents(l.receiver.transport),rh(rh({},c),{},{sdp:a.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const r=await this.peerConnection.createOffer();if(!r.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const o=xc(r.sdp);return this.initialOffer=r,rh(rh({},o),{},{sdp:r.sdp})}}catch(i){throw new oe(O.GET_LOCAL_CONNECTION_PARAMS_FAILED,i.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:i,iceParameters:r,dtlsParameters:o}=t,s=await ac({},{},i);this.remoteSDP=new ix({remoteIceParameters:r,remoteDtlsParameters:o,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const a=this.peerConnection.getTransceivers()[0];a!=null&&a.sender&&a.sender.transport&&this.tryBindTransportEvents(a.sender.transport)}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(i.toString()))}}async addRemoteCandidate(t){try{t&&this.pendingCandidates.push(t),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(i=>{this.peerConnection.addIceCandidate(i)}),this.pendingCandidates=[])}catch(i){throw new oe(O.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(i.toString()))}}send(t,i,r){var o=this;return ao(function*(){const s=yield Et(o.mutex.lock("From P2PConnection.send"));try{if(!o.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const a=[],c=o.remoteSDP.receive(t,i,r);t.forEach((T,C)=>{if(c[C].needCreateTransceiver){const b=o.peerConnection.addTransceiver(T._mediaStreamTrack,{direction:"sendonly"});a.push(b),T._updateRtpTransceiver(b)}else{const b=o.peerConnection.getTransceivers().find(D=>D.mid===c[C].mid);if(!b)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(c[C].mid));a.push(b),T._updateRtpTransceiver(b)}}),Ht()&&B("SIMULCAST")===!0&&(yield Et(o.applySimulcastForFirefox(a,t)));const d=c.map(T=>T.mid),l=yield Et(o.peerConnection.createOffer()),h=o.mungSendOfferSDP(l.sdp,t,d),p=sn(h),f=d.map(T=>{const C=p.mediaDescriptions.find(b=>b.attributes.mid===T);if(!C)throw new Error("Cannot extract ssrc from mediaDescription.");return aC(C,B("USE_PUB_RTX"))}),m=a.map((T,C)=>{const b=d[C];return{localSSRC:f[C],id:b}});yield Et(o.peerConnection.setLocalDescription({type:"offer",sdp:h}));try{yield m}catch(T){const C=o.remoteSDP.toString();throw yield Et(o.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield Et(o.peerConnection.setRemoteDescription({type:"answer",sdp:C})),yield Et(o.stopSending(d,!0)),T}yield Et(o.applySimulcastEncodings(a,t)),yield Et(o.applySendEncodings(a,t));const g=o.remoteSDP.toString(),S=o.logSDPExchange(h,"offer","local","send");return S==null||S(g),yield Et(o.setRemoteDescription({type:"answer",sdp:g})),a.map((T,C)=>{const b=d[C];return{localSSRC:f[C],id:b}})}catch(a){throw a instanceof oe?a:new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(a.toString()))}finally{s()}})()}async stopSending(t,i){const r=i?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const o=this.peerConnection.getTransceivers().filter(d=>t.indexOf(d.mid)!==-1);if(o.length!==t.length)throw new Error("Transceivers' length (".concat(o.length,") doesn't match mids' length (").concat(t.length,") when trying to call P2PConnection.stopSending."));o.map(d=>{var l;d.direction="inactive",(l=d.stop)===null||l===void 0||l.call(d)});const s=await this.peerConnection.createOffer(),a=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(t);const c=this.remoteSDP.toString();a==null||a(c),await this.setRemoteDescription({type:"answer",sdp:c})}catch(o){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(o.toString()))}finally{r&&r()}}async receive(t,i,r,o){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:a}=this.remoteSDP.send(t,i,r,o);if(a){const d=this.remoteSDP.toString(),l=this.logSDPExchange(d,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:d});const h=await this.peerConnection.createAnswer(),p=this.mungReceiveAnswerSDP(h.sdp,s,t);l==null||l(p||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:p}),I.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else I.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));const c=this.peerConnection.getTransceivers().find(d=>d.mid===s);if(!c||c.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:c.receiver.track,mid:c.mid,transceiver:c}}catch(s){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async mockReceive(t,i,r,o){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:a}=this.remoteSDP.send(t,i,r,o);if(a){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:c});const l=await this.peerConnection.createAnswer(),h=this.mungReceiveAnswerSDP(l.sdp,s,t);d==null||d(h||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:h}),I.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else I.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."))}catch(s){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const i=this.remoteSDP.toString(),r=this.logSDPExchange(i,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:i});const o=await this.peerConnection.createAnswer();r==null||r(o.sdp||""),await this.peerConnection.setLocalDescription(o)}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===Yr.Auto&&(this.store.p2pTransport=Yr.SdRtn,Mt().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Sy.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,Mt().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Sy.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;const i=await this.peerConnection.createOffer({iceRestart:!0});if(!i.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:r}=xc(i.sdp);return this.store.descriptionStart(),this.direction===Je.SEND_ONLY&&await this.peerConnection.setLocalDescription(i),r}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===Je.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const i=await this.peerConnection.createAnswer();if(!i.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:r}=xc(i.sdp);return await this.peerConnection.setLocalDescription(i),r}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}close(){var t;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const r=await this.peerConnection.createOffer(),o=this.mungSendOfferSDP(r.sdp,[i],[t]);this.remoteSDP.updateRecvMedia(t,i);const s=this.remoteSDP.toString(),a=this.logSDPExchange(o,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:o}),a==null||a(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(r){throw new oe(O.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(t,i){const r=this.peerConnection.getTransceivers().filter(o=>o.mid===t);r.length===1&&(this.isVP8Simulcast(i)?Ht()||await this.applySimulcastEncodings(r,[i]):await this.applySendEncodings(r,[i]))}setStatsRemoteVideoIsReady(t,i){this.statsFilter.setVideoIsReady2(t,i)}async replaceTrack(t,i){const r=this.peerConnection.getTransceivers().find(o=>o.mid===i);r&&await r.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const i=t[0].transport.iceTransport,{local:r,remote:o}=i.getSelectedCandidatePair();return{local:rh(rh({},Rs),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port}),remote:rh(rh({},Rs),{},{candidateType:o.type,protocol:o.protocol,address:o.address,port:o.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t,i;z(t=["connected","completed"]).call(t,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(i=this.onICEConnectionStateChange)===null||i===void 0||i.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=t=>{if(t.candidate){var i;t.candidate.candidate&&((i=this.onLocalCandidate)===null||i===void 0||i.call(this,t.candidate.toJSON())),this.localCandidateCount+=1}else I.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t,i){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const o={iceServers:[]};var s;return t.iceServers?o.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(bh(t.turnServer.servers)?o.iceServers=t.turnServer.servers:(o.iceServers&&o.iceServers.push(...Sy.turnServerConfigToIceServers(t.turnServer.servers,i,r)),B("USE_TURN_SERVER_OF_GATEWAY")&&o.iceServers&&t.turnServer.serversFromGateway&&o.iceServers.push(...Sy.turnServerConfigToIceServers(t.turnServer.serversFromGateway,i,r)),z(s=[Yr.Relay,Yr.SdRtn]).call(s,i)&&(o.iceTransportPolicy="relay"),B("FORCE_TURN_TCP")?o.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(a=>{a.forceturn&&(o.iceTransportPolicy="relay")}))),B("ENABLE_ENCODED_TRANSFORM")&&Mt().supportWebRTCEncodedTransform&&(o.encodedInsertableStreams=!0),I.debug("P2PConnection p2pTransport is ".concat(i)),o}static turnServerConfigToIceServers(t,i){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const o=[],s=t.filter(c=>c.tcpport);I.debug("P2PConnection turnServers is ".concat(s,", current index is ").concat(r));const a=s.length>r?s[r]:s[0];switch(i){case Yr.SdRtn:const c=t.filter(l=>{var h;return z(h=l.username).call(h,"glb:")&&l.turnServerURL==l.turnServerURL}),d=c.length>r?c[r]:c[0];d&&(o.push({username:d.username,credential:d.password,credentialType:"password",urls:"turn:".concat(ia(d.turnServerURL),":").concat(d.tcpport,"?transport=udp")}),o.push({username:d.username,credential:d.password,credentialType:"password",urls:"turns:".concat(ia(d.turnServerURL),":").concat(d.tcpport,"?transport=tcp")}));break;case Yr.Relay:a&&(o.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=udp")}),o.push({username:a.username,credential:a.password,credentialType:"password",urls:"turns:".concat(ia(a.turnServerURL),":").concat(a.tcpport,"?transport=tcp")}));break;default:a&&(o.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=udp")}),o.push({username:a.username,credential:a.password,credentialType:"password",urls:"turns:".concat(ia(a.turnServerURL),":").concat(a.tcpport,"?transport=tcp")}),o.push({username:a.username,credential:a.password,credentialType:"password",urls:"stun:".concat(a.turnServerURL,":").concat(a.tcpport)}))}return o}tryBindTransportEvents(t){if(t){this.transport=t,t.onstatechange=()=>{var r;t!=null&&t.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,t.state))},t.onerror=r=>{var o;(o=this.onDTLSTransportError)===null||o===void 0||o.call(this,"error"in r?r.error:r)};const i=t.iceTransport;i&&(i.onstatechange=()=>{const r=t==null?void 0:t.iceTransport.state;var o;r&&((o=this.onICETransportStateChange)===null||o===void 0||o.call(this,r))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:r,remote:o}=i.getSelectedCandidatePair()||{};if(r&&o){const s=r.address+":"+r.port,a=o.address+":"+o.port;I.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(Hd(s)),", remote ").concat(JSON.stringify(Hd(a))))}}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,i){var r;if(i||(i=this.peerConnection.getSenders().find(h=>h.track===t._mediaStreamTrack)),!i)return I.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return I.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Mt().supportSetRtpSenderParameters)return I.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const o={},s={};switch(t._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;default:o.degradationPreference="balanced"}if(t._encoderConfig){var a;const{bitrateMax:h,frameRate:p,scaleResolutionDownBy:f}=t._encoderConfig;h&&(s.maxBitrate=1e3*h),z(a=t._hints).call(a,ui.LOW_STREAM)&&(p&&(s.maxFramerate=qo(p)),f&&f>=1&&(s.scaleResolutionDownBy=f))}if(B("DSCP_TYPE")&&ha()){var c;const h=B("DSCP_TYPE");z(c=["very-low","low","medium","high"]).call(c,h)&&(s.networkPriority=h)}const d=i.getParameters(),l=(r=d.encodings)===null||r===void 0?void 0:r[0];Ht()&&!l&&(o.encodings=[s]),l&&Object.assign(l,s),Object.assign(d,o),I.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(d.encodings))),await i.setParameters(d)}async applySendEncodings(t,i){try{if(!Mt().supportSetRtpSenderParameters||t.length!==i.length)return;for(let r=0;r<t.length;r++){const o=t[r],s=i[r];s instanceof yi&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,o.sender)}}catch{I.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,i,r){const o=sn(t);return i.forEach((s,a)=>{const c=r[a],d=o.mediaDescriptions.find(l=>l.attributes.mid===c);d&&(Fu(d,s),dC(d,s,this.store.codec))}),Du(o)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,i,r)=>{var o;(o=this.onFirstVideoDecoded)===null||o===void 0||o.call(this,t,i,r)},this.statsFilter.onSelectedLocalCandidateChanged=(t,i)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,t,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,i)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,t,i)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,i){if(t.length===i.length)for(let d=0;d<t.length;d++){var r,o,s,a,c;const l=t[d],h=i[d];if(h instanceof yi&&!z(r=h._hints).call(r,ui.LOW_STREAM)&&(o=h._encoderConfig)!==null&&o!==void 0&&o.bitrateMax&&((s=h._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(a=h._scalabilityMode)!==null&&a!==void 0&&a.numSpatialLayers&&((c=h._scalabilityMode)===null||c===void 0?void 0:c.numSpatialLayers)>1&&this.store.codec==="vp8"){const p={},f={high:1e3*(h._encoderConfig.bitrateMax-50),medium:5e4};p.encodings=[{rid:"m",active:!0,maxBitrate:f.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:f.high}];const m=l.sender.getParameters();await l.sender.setParameters(Object.assign(m,p))}}}async applySimulcastEncodings(t,i){if(!Ht()&&t.length===i.length)for(let r=0;r<t.length;r++){const o=i[r];if(o instanceof yi&&this.isVP8Simulcast(o)){const s=t[r],a={},c={high:1e3*(o._encoderConfig.bitrateMax-50),medium:5e4};a.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:c.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:c.medium,scaleResolutionDownBy:4}];const d=s.sender.getParameters();await s.sender.setParameters(Object.assign(d,a))}}}isVP8Simulcast(t){var i,r,o,s,a;return!!(t instanceof yi&&B("SIMULCAST")&&this.store.codec==="vp8"&&!z(i=t._hints).call(i,ui.LOW_STREAM)&&(r=t._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=t._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=t._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=t._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1)}logSDPExchange(t,i,r,o){if(B("SDP_LOGGING"))return I.upload("[".concat(this.store.clientId,"] exchanging ").concat(r," ").concat(i," SDP during P2PConnection.").concat(o,`
`),t),i==="offer"?s=>{this.logSDPExchange(s,"answer",r==="local"?"remote":"local",o)}:void 0}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(a=>a.mid&&t.indexOf(a.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(a=>{a.direction="inactive"});const r=await this.peerConnection.createOffer(),o=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.muteRemote(t);const s=this.remoteSDP.toString();o==null||o(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(a=>a.mid&&t.indexOf(a.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(async a=>{a.direction="sendonly"});const r=await this.peerConnection.createOffer(),o=this.logSDPExchange(r.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.unmuteRemote(t);const s=this.remoteSDP.toString();o==null||o(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}async getRemoteSSRC(t,i){var r;if(i=i??((r=this.currentRemoteDescription)===null||r===void 0?void 0:r.sdp)){var o;const s=(o=sn(i).mediaDescriptions.find(a=>a.attributes.mid===t))===null||o===void 0?void 0:o.attributes.ssrcs;return s==null?void 0:s[0].ssrcId}}async setRemoteDescription(t){var i;await this.peerConnection.setRemoteDescription(t),z(i=["connected","completed"]).call(i,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(t,i,r){const o=sn(t),s=o.mediaDescriptions.find(a=>a.attributes.mid===i);return s&&r===be.AUDIO&&s.media.mediaType==="audio"&&Nl(s),Du(o)}},Ae(Hi.prototype,"establish",[to],Object.getOwnPropertyDescriptor(Hi.prototype,"establish"),Hi.prototype),Ae(Hi.prototype,"connect",[to],Object.getOwnPropertyDescriptor(Hi.prototype,"connect"),Hi.prototype),Ae(Hi.prototype,"receive",[to],Object.getOwnPropertyDescriptor(Hi.prototype,"receive"),Hi.prototype),Ae(Hi.prototype,"mockReceive",[to],Object.getOwnPropertyDescriptor(Hi.prototype,"mockReceive"),Hi.prototype),Ae(Hi.prototype,"stopReceiving",[to],Object.getOwnPropertyDescriptor(Hi.prototype,"stopReceiving"),Hi.prototype),Ae(Hi.prototype,"restartICE",[to],Object.getOwnPropertyDescriptor(Hi.prototype,"restartICE"),Hi.prototype),Ae(Hi.prototype,"close",[to],Object.getOwnPropertyDescriptor(Hi.prototype,"close"),Hi.prototype),Ae(Hi.prototype,"updateEncoderConfig",[to],Object.getOwnPropertyDescriptor(Hi.prototype,"updateEncoderConfig"),Hi.prototype),Ae(Hi.prototype,"updateSendParameters",[to],Object.getOwnPropertyDescriptor(Hi.prototype,"updateSendParameters"),Hi.prototype),Ae(Hi.prototype,"replaceTrack",[to],Object.getOwnPropertyDescriptor(Hi.prototype,"replaceTrack"),Hi.prototype),Ae(Hi.prototype,"muteLocal",[to],Object.getOwnPropertyDescriptor(Hi.prototype,"muteLocal"),Hi.prototype),Ae(Hi.prototype,"unmuteLocal",[to],Object.getOwnPropertyDescriptor(Hi.prototype,"unmuteLocal"),Hi.prototype),Hi);function to(e,t,i){const r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const o=this.mutex,s=await o.lock("From P2PConnection.".concat(t));try{for(var a=arguments.length,c=new Array(a),d=0;d<a;d++)c[d]=arguments[d];return await r.apply(this,c)}finally{s()}},i}let Xc=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({});var t1,i1,r1,n1,o1,s1,a1,c1,d1,l1,er,tr;function yR(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function fy(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?yR(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):yR(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let nl=(t1=ms(Xc.SEND_ONLY),i1=ms(Xc.SEND_ONLY),r1=ms(),n1=ms(Xc.RECEIVE_ONLY),o1=ms(Xc.RECEIVE_ONLY),s1=ms(Xc.RECEIVE_ONLY),a1=ms(Xc.RECEIVE_ONLY),c1=ms(Xc.RECEIVE_ONLY),d1=ms(Xc.RECEIVE_ONLY),l1=ms(),er=ms(Xc.RECEIVE_ONLY),tr=class extends Vi{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(xe.StateChange,t,this._state)}constructor(e,t){super(),M(this,"isPlanB",!1),M(this,"store",void 0),M(this,"statsUploader",void 0),M(this,"sendConnection",void 0),M(this,"recvConnection",void 0),M(this,"localTrackMap",new Map),M(this,"remoteUserMap",new Map),M(this,"localDataChannels",[]),M(this,"pendingLocalTracks",[]),M(this,"pendingRemoteTracks",[]),M(this,"statsCollector",void 0),M(this,"dtlsFailedCount",0),M(this,"sendMutex",void 0),M(this,"recvMutex",void 0),M(this,"_state",we.Disconnected),M(this,"_restartStates",["disconnected","failed"]),M(this,"reconnectInterval",void 0),M(this,"uploadUnplinkStarted",!1),M(this,"uploadDownlinkStarted",!1),M(this,"uplinkStateUploadInterval",void 0),M(this,"downlinkStatsUploadInterval",void 0),M(this,"handleMuteLocalTrack",async(i,r,o)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==we.Connected)return void o(new oe(O.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const d=this.filterTobeMutedTracks(i);if(d.length===0)return void r();const l=d.find(m=>m[0]==="videoLowTrack");l&&l[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(d.map(m=>{let[,{id:g}]=m;return g}));let h=!1;var a,c;i.trackMediaType==="video"?h=!((a=this.localTrackMap.get(ue.LocalAudioTrack))===null||a===void 0||!a.track._muted):h=((c=this.localTrackMap.get(ue.LocalVideoTrack))===null||c===void 0?void 0:c.id)===void 0;const p=this.createMuteMessage(d);await Xt(this,xe.RequestMuteLocal,p);const f=i.trackMediaType==="video"?Bh.MUTE_LOCAL_VIDEO:Bh.MUTE_LOCAL_AUDIO;await Xt(this,xe.RequestP2PMuteLocal,{action:f,message:p,isMuteAll:h}),r()}catch(d){o(d)}finally{s()}}),M(this,"handleUnmuteLocalTrack",async(i,r,o)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==we.Connected)return void o(new oe(O.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const a=this.filterTobeUnmutedTracks(i);if(a.length===0)return void r();await this.sendConnection.unmuteLocal(a.map(l=>{let[,{id:h}]=l;return h}));const c=this.createUnmuteMessage(a),d=i.trackMediaType==="video"?Bh.UNMUTE_LOCAL_VIDEO:Bh.UNMUTE_LOCAL_AUDIO;await Xt(this,xe.RequestP2PMuteLocal,{action:d,message:c}),r()}catch(a){o(a)}finally{s()}}),M(this,"handleUpdateVideoEncoder",async(i,r,o,s)=>{let a;typeof s=="boolean"&&s||(a=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoEncoder"));try{const d=this.localTrackMap.get(ue.LocalVideoTrack);if(!this.sendConnection||!d||d.track!==i||this.state!==we.Connected)return void r();const{id:l,track:h}=d;l&&(await this.sendConnection.updateSendParameters(l,h),await this.sendConnection.updateEncoderConfig(l,h),this.emit(xe.UpdateVideoEncoder,h)),r()}catch(d){o(d)}finally{var c;(c=a)===null||c===void 0||c()}}),M(this,"handleUpdateVideoSendParameters",async(i,r,o)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const a=this.localTrackMap.get(ue.LocalVideoTrack);if(!this.sendConnection||!a||a.track!==i||this.state!==we.Connected)return void r();const{id:c,track:d}=a;c&&await this.sendConnection.updateSendParameters(c,d),r()}catch(a){o(a)}finally{s()}}),M(this,"handleReplaceTrack",async(i,r,o,s)=>{let a;I.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(i.getTrackId(),"]")),typeof s=="boolean"&&s||(a=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var c;const l=Array.from(this.localTrackMap.entries()).find(h=>{let[,{track:p}]=h;return i===p});if(!this.sendConnection||!l||l[1].id===void 0||this.state!==we.Connected)return void r();if(await((c=this.sendConnection)===null||c===void 0?void 0:c.replaceTrack(i,l[1].id)),l[0]===ue.LocalVideoTrack&&Mt().supportDualStreamEncoding){const h=this.localTrackMap.get(ue.LocalVideoLowTrack);if(h){const p=i._mediaStreamTrack.clone();h.track._originMediaStreamTrack.stop(),h.track._mediaStreamTrack=p,h.track._originMediaStreamTrack=p,await new Z((f,m)=>{this.handleReplaceTrack(h.track,f,m,!0)})}}r()}catch(l){o(l)}finally{var d;(d=a)===null||d===void 0||d()}}),M(this,"handleGetLocalVideoStats",i=>{i(this.statsCollector.getLocalVideoTrackStats())}),M(this,"handleGetLocalAudioStats",i=>{i(this.statsCollector.getLocalAudioTrackStats())}),M(this,"handleGetRemoteVideoStats",i=>this.statsCollector.getRemoteVideoTrackStats(i.uid)[i.uid]),M(this,"handleGetRemoteAudioStats",i=>this.statsCollector.getRemoteAudioTrackStats(i.uid)[i.uid]),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new c2(e),this.bindStatsUploaderEvents(),this.sendMutex=new jr("P2PChannel2-send-mutex",e.clientId),this.recvMutex=new jr("P2PChannel2-recv-mutex",e.clientId),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(i=>{i&&(i.iceConnectionState!=="disconnected"&&i.iceConnectionState!=="failed"||this.handleDisconnect(i.direction))})},B("ICE_RESTART_INTERVAL"))}async startP2PConnection(e,t){throw new oe(O.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e){throw new oe(O.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,t){let i;try{if(t){this.recvConnection&&(I.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),i=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new mc(e,this.store,Je.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const r=await this.recvConnection.establish(t);return{iceParameters:r.iceParameters,dtlsParameters:r.dtlsParameters,sdp:r.sdp}}{this.state=we.New,this.sendConnection&&(I.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),i=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new mc(e,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const r=await this.sendConnection.establish();return{iceParameters:r.iceParameters,dtlsParameters:r.dtlsParameters,sdp:r.sdp}}}finally{i&&i()}}async p2pConnect(e){if(!this.sendConnection)throw new oe(O.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=we.Connected}async addRemoteCandidate(e,t){if(t===Je.RECEIVE_ONLY){if(!this.sendConnection)throw new oe(O.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(e)}else{if(!this.recvConnection)throw new oe(O.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e)}}publish(e,t,i){var r=this;return ao(function*(){const o=yield Et(r.sendMutex.lock("From P2PChannel.publish"));try{if(!r.sendConnection||r.state!==we.Connected){r.throwIfTrackTypeNotMatch(e);const l=e.filter(h=>r.pendingLocalTracks.indexOf(h)===-1);return void(r.pendingLocalTracks=r.pendingLocalTracks.concat(l))}r.store.pubId=r.store.pubId+1,eo.markPublishStart(r.store.clientId,r.store.pubId);const s=r.filterTobePublishedTracks(e,t,i);if(s.length===0)return void(yield Et(r.tryToUnmuteAudio(e)));s.forEach(l=>{let{track:h,type:p}=l;const f=Date.now();r.store.publish(h.getTrackId(),p===ue.LocalAudioTrack?"audio":"video",f)}),r.bindLocalTrackEvents(s);const a=yield Et(r.sendConnection.send(s.map(l=>{let{track:h}=l;return h}),r.store.codec,r.store.audioCodec)),c=(yield Et(a.next())).value,d=r.createGatewayPublishMessage(s,c);try{yield d}catch(l){throw a.throw(l),(l==null?void 0:l.code)===O.WS_ABORT&&s.forEach(h=>{let{track:p}=h;r.pendingLocalTracks.indexOf(p)===-1&&r.pendingLocalTracks.push(p)}),r.unbindLocalTrackEvents(s),l}yield Et(a.next()),s.forEach(l=>{let{type:h}=l;r.statsCollector.addLocalStats(h)}),r.statsUploader.startUploadOutboundStats(),r.assignLocalTracks(s,c),s.forEach(l=>{let{track:h,type:p}=l;const f=Date.now();r.store.publish(h.getTrackId(),p===ue.LocalAudioTrack?"audio":"video",void 0,f)}),r.startUploadUplinkState()}finally{o()}})()}async unpublish(e){if(!this.sendConnection||this.state!==we.Connected)return void(e.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(o=>!z(e).call(e,o)));const t=this.filterTobeUnpublishedTracks(e);if(t.length===0)return;const i=t.find(o=>o[0]==="videoLowTrack");i&&i[1].track.close();const r=this.createGatewayUnpublishMessage(t);if(await this.sendConnection.stopSending(t.map(o=>{let[,{id:s}]=o;return s})),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map(o=>{let[s,{track:a}]=o;return{type:s,track:a}})),t.forEach(o=>{let[s]=o;this.statsCollector.removeLocalStats(s)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===we.Connected)return i&&i[1].track.close(),r;e.forEach(o=>{const s=this.pendingLocalTracks.indexOf(o);s!==-1&&this.pendingLocalTracks.splice(s,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const e=()=>{const t=[],i=[];Array.from(this.localTrackMap.entries()).forEach(r=>{let[o,{track:s,ssrcs:a}]=r;const c={stream_type:EL(s,o),ssrcs:a};s._muted||!s._enabled?t.push(c):i.push(c)}),t.length>0&&t.forEach(r=>{Xt(this,xe.RequestMuteLocal,[r])}),i.length>0&&i.forEach(r=>{Xt(this,xe.RequestUnmuteLocal,[r])})};e(),this.uplinkStateUploadInterval=window.setInterval(()=>{e()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(e){return ao(function*(){throw new oe(O.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(I.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await yt(this,xe.RequestRePublish,this.pendingLocalTracks),this.emit(xe.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new oe(O.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(e,t,i,r){var o;if(!this.recvConnection)throw new oe(O.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((o=this.remoteUserMap.get(e))!==null&&o!==void 0&&o.has(t))return;const{track:s,mid:a,transceiver:c}=await this.recvConnection.receive(t,[{ssrcId:i}],String(e.uid),r);t===be.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(s):(e._audioTrack=new Eo(s,e.uid,e._uintid,this.store),I.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),c&&e._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=i,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(s):(e._videoTrack=new Wd(s,e.uid,e._uintid,this.store),I.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),c&&e._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._videoTrack));const d=this.remoteUserMap.get(e);d?d.set(t,a):this.remoteUserMap.set(e,new Map([[t,a]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const l=this.pendingRemoteTracks.findIndex(h=>{let{user:p,kind:f}=h;return p.uid===e.uid&&t===f});l!==-1&&(this.pendingRemoteTracks.splice(l,1),this.emit(xe.MediaReconnectEnd,e.uid))}async mockSubscribe(e,t,i,r){if(!this.recvConnection)throw new oe(O.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(t,[{ssrcId:i}],String(e.uid),r)}async unsubscribe(e,t,i){const r=this.pendingRemoteTracks.filter(s=>{let{user:a,kind:c}=s;return t!==void 0?a.uid===e.uid&&t===c:a.uid===e.uid});if(r.forEach(s=>{const a=this.pendingRemoteTracks.indexOf(s);this.pendingRemoteTracks.splice(a,1)}),this.recvConnection||i||r.forEach(s=>{let{kind:a}=s;var c;if(a===be.AUDIO)(c=e._audioTrack)===null||c===void 0||c._destroy(),e._audioTrack=void 0;else if(a===be.VIDEO){var d;(d=e._videoTrack)===null||d===void 0||d._destroy(),e._videoTrack=void 0}}),!this.recvConnection)return;const o=this.filterTobeUnSubscribedTracks(e,t);o.length!==0&&(await this.recvConnection.stopReceiving(o.map(s=>{let[,{id:a}]=s;return a})),this.withdrawRemoteTracks(o),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),o.forEach(s=>{let[a,{kind:c}]=s;var d,l;if(c===be.VIDEO&&a._videoSSRC&&((d=this.recvConnection)===null||d===void 0||d.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),c===be.VIDEO)this.unbindRemoteTrackEvents(a._videoTrack),i||((l=a._videoTrack)===null||l===void 0||l._destroy(),a._videoTrack=void 0);else if(c===be.AUDIO){var h;this.unbindRemoteTrackEvents(a._audioTrack),!i&&((h=a._audioTrack)===null||h===void 0||h._destroy(),a._audioTrack=void 0)}}),o.forEach(s=>{let[,{kind:a}]=s;Xt(this,xe.RequestP2PMuteRemote,a)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const e=()=>Array.from(this.remoteUserMap.entries()).forEach(t=>{let[,i]=t;[be.VIDEO,be.AUDIO].forEach(r=>{i.has(r)?Xt(this,xe.RequestP2PUnmuteRemote,r):Xt(this,xe.RequestP2PMuteRemote,r)})});e(),this.downlinkStatsUploadInterval=window.setInterval(()=>{e()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new oe(O.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new oe(O.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new oe(O.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new oe(O.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,t){if(!this.recvConnection)return;const i=this.remoteUserMap.get(e);if(!i)return void I.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!i.get(t))return void I.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const r=t===be.VIDEO?e._videoSSRC:e._audioSSRC;r!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(r,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.recvConnection)return;const i=this.remoteUserMap.get(e);if(!i)return void I.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."));i.get(t)||I.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}getAllTracks(e){const t=this.localTrackMap.get(ue.LocalAudioTrack);if((t==null?void 0:t.track)instanceof nn){const i=t.track;return Array.from(this.localTrackMap.entries()).filter(r=>{let[o]=r;return o!==ue.LocalAudioTrack}).filter(r=>{let[o]=r;return!(e&&o===ue.LocalVideoLowTrack)}).map(r=>{let[,{track:o}]=r;return o}).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter(i=>{let[r]=i;return!(e&&r===ue.LocalVideoLowTrack)}).map(i=>{let[,{track:r}]=i;return r})}reportPublishEvent(e,t,i,r,o){if(e){const a=this.localTrackMap.get(ue.LocalAudioTrack),c=r?this.localTrackMap.get(ue.LocalVideoLowTrack):this.localTrackMap.get(ue.LocalVideoTrack);H.publish(this.store.sessionId,{eventElapse:eo.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:a==null?void 0:a.track.getTrackLabel(),videoName:c==null?void 0:c.track.getTrackLabel(),screenshare:(c==null?void 0:c.track._hints.indexOf(ui.SCREEN_TRACK))!==-1,audio:!!a,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}else{var s;i||(i=[]);const a=i.find(d=>d instanceof Zi),c=r?(s=this.localTrackMap.get(ue.LocalVideoTrack))===null||s===void 0?void 0:s.track:i.find(d=>d instanceof yi);H.publish(this.store.sessionId,{eventElapse:eo.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:a==null?void 0:a.getTrackLabel(),videoName:c==null?void 0:c.getTrackLabel(),screenshare:(c==null?void 0:c._hints.indexOf(ui.SCREEN_TRACK))!==-1,audio:!!a,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}}reportSubscribeEvent(e,t,i,r){const o=r===be.VIDEO?i._videoSSRC:i._audioSSRC;o&&H.subscribe(this.store.sessionId,{succ:e,ec:t,video:r===be.VIDEO,audio:r===be.AUDIO,peerid:i.uid,subscribeRequestid:r===be.VIDEO?i._videoSSRC:i._audioSSRC,p2pid:this.store.p2pId,eventElapse:eo.measureFromSubscribeStart(this.store.clientId,o)})}reset(){I.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new jr("P2PChannel2-send-mutex",this.store.clientId),this.sendMutex=new jr("P2PChannel2-recv-mutex",this.store.clientId),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(ue.LocalAudioTrack);if((e==null?void 0:e.track)instanceof nn){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach(i=>{t.removeAudioTrack(i)})}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=we.Disconnected}getStats(e){var t,i;return e?(i=this.recvConnection)===null||i===void 0?void 0:i.getStats():(t=this.sendConnection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(e){var t;return((t=this.recvConnection)===null||t===void 0?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(ue.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(ue.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof yi||t&&t.track instanceof Zi?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){var t;const i=Array.from(ai(t=this.remoteUserMap).call(t)).find(r=>r.uid===e);return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map(i=>{let[r]=i;return{uid:r.uid,level:r.audioTrack?100*r.audioTrack._source.getAccurateVolumeLevel():0}});const t=this.localTrackMap.get(ue.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=Ka(e).call(e,(i,r)=>i.level-r.level),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(I.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=we.Reconnecting,B("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t]=e;var i;t._videoTrack&&t._videoTrack._player&&((i=t._videoTrack._player.getVideoElement())===null||i===void 0||i.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(e=>{var t;let[i,{track:r}]=e;switch(i){case ue.LocalVideoTrack:z(t=r._hints).call(t,ui.LOW_STREAM)?r.close():this.pendingLocalTracks.push(r);break;case ue.LocalAudioTrack:r instanceof nn?this.pendingLocalTracks=this.pendingLocalTracks.concat(r.trackList):this.pendingLocalTracks.push(r);case ue.LocalVideoLowTrack:}}),this.emit(xe.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,i]=e;Array.from(ai(i).call(i)).forEach(r=>{this.setPendingRemoteMedia(t,r)}),this.emit(xe.MediaReconnectStart,t.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),I.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,t){for(const i of this.pendingRemoteTracks){const{user:r,kind:o}=i;if((e instanceof ju?e.uid:e)===r.uid&&t===o)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}async restartICE(e,t){let i,r;if(e===Je.SEND_ONLY){if(!this.sendConnection)throw new oe(O.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");i=await this.sendMutex.lock("From P2PChannel.restartICE"),r=this.sendConnection}else{if(!this.recvConnection)throw new oe(O.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");i=await this.recvMutex.lock("From P2PChannel.restartICE"),r=this.recvConnection}try{if(t){const o=await r.restartICE(t);return r.isInRestartIce=!1,o}{const o=await r.restartICE();if(o){const s=await yt(this,xe.RequestP2PRestartICE,{direction:Je.RECEIVE_ONLY,iceParameter:o});await r.restartICE(s),r.isInRestartIce=!1}}}finally{i()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const e=this.sendConnection.getStats(),t=this.localTrackMap.get(ue.LocalVideoTrack),i=this.localTrackMap.get(ue.LocalAudioTrack),r=e.videoSend.find(m=>{var g;return m.ssrc===(t==null||(g=t.ssrcs)===null||g===void 0?void 0:g[0].ssrcId)}),o=e.audioSend.find(m=>{var g;return m.ssrc===(i==null||(g=i.ssrcs)===null||g===void 0?void 0:g[0].ssrcId)});if(!r||!o)return 1;const s=co(this,xe.NeedSignalRTT),a=r?r.rttMs:void 0,c=o?o.rttMs:void 0,d=a&&c?(a+c)/2:a||c,l=(d&&s?(d+s)/2:d||s)||0,h=100*e.sendPacketLossRate*.7/50+.3*l/1500,p=h<.17?1:h<.36?2:h<.59?3:h<.1?4:5,f=t==null?void 0:t.track;if(f&&f._encoderConfig&&f._hints.indexOf(ui.SCREEN_TRACK)===-1){const m=f._encoderConfig.bitrateMax,g=e.bitrate.actualEncoded;if(m&&g){const S=(1e3*m-g)/(1e3*m);return Vh[S<.15?0:S<.3?1:S<.45?2:S<.6?3:4][p]}}return p}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const e=this.recvConnection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach(i=>{let[r]=i;const o=r._audioSSRC,s=r._videoSSRC,a=e.audioRecv.find(g=>g.ssrc===o),c=e.videoRecv.find(g=>g.ssrc===s);if(!a&&!c)return void(t+=1);const d=co(this,xe.NeedSignalRTT),l=e.rtt,h=(l&&d?(l+d)/2:l||d)||0,p=a?a.jitterMs:void 0,f=e.recvPacketLossRate;let m=.7*f*100/50+.3*h/1500;p&&(m=.6*f*100/50+.2*h/1500+.2*p/400),t+=m<.1?1:m<.17?2:m<.36?3:m<.59?4:5}),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new Z((t,i)=>{this.handleMuteLocalTrack(e,t,i)})}filterTobePublishedTracks(e,t,i){const r=[],o=Mt(),s=this.getAllTracks();e=Au(e=e.filter(d=>s.indexOf(d)===-1));let a=!1,c=!1;for(const d of e){if(d instanceof yi&&(this.localTrackMap.has(ue.LocalVideoTrack)||a?new oe(O.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(r.push({track:d,type:ue.LocalVideoTrack}),a=!0),t)){const l=this.getLowVideoTrack(d,i);r.push({track:l,type:ue.LocalVideoLowTrack})}if(d instanceof Zi){const l=this.localTrackMap.get(ue.LocalAudioTrack);if(l){if(!(l.track instanceof nn))throw new oe(O.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(d._bypassWebAudio)throw new oe(O.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");l.track.addAudioTrack(d),this.bindLocalAudioTrackEvents(d,!0)}else if(c){const h=r.find(p=>{let{type:f}=p;return f===ue.LocalAudioTrack});if(!(h.track instanceof nn))throw new oe(O.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(d._bypassWebAudio)throw new oe(O.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");h.track.addAudioTrack(d)}else{if(!o.webAudioMediaStreamDest||d instanceof nn||d._bypassWebAudio)r.push({track:d,type:ue.LocalAudioTrack});else{const h=new nn;h.addAudioTrack(d),r.push({track:h,type:ue.LocalAudioTrack})}c=!0}}}return r}filterTobeUnpublishedTracks(e){const t=[],i=this.getAllTracks();e=Au(e=e.filter(r=>i.indexOf(r)!==-1));for(const r of e){if(r instanceof Zi){const o=this.localTrackMap.get(ue.LocalAudioTrack);if(!o)continue;o.track instanceof nn?(o.track.removeAudioTrack(r),this.unbindLocalAudioTrackEvents(r),o.track.trackList.length===0&&(t.push([ue.LocalAudioTrack,o]),o.track.close())):t.push([ue.LocalAudioTrack,o])}if(r instanceof yi){const o=this.localTrackMap.get(ue.LocalVideoTrack);if(!o)continue;t.push([ue.LocalVideoTrack,o]);const s=this.localTrackMap.get(ue.LocalVideoLowTrack);s&&t.push([ue.LocalVideoLowTrack,s])}}return t}bindLocalTrackEvents(e){e.forEach(t=>{let{track:i,type:r}=t;switch(r){case ue.LocalVideoTrack:i.addListener(Re.GET_STATS,this.handleGetLocalVideoStats),i.addListener(Re.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(Re.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(Re.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.addListener(Re.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),i.addListener(Re.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.addListener(Re.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(Re.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case ue.LocalAudioTrack:this.bindLocalAudioTrackEvents(i);case ue.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(e,t){e instanceof nn?e.trackList.forEach(i=>{i.addListener(Re.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(Re.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(Re.GET_STATS,this.handleGetLocalAudioStats),i.addListener(Re.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(Re.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.addListener(Re.GET_STATS,this.handleGetLocalAudioStats),e.addListener(Re.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(Re.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(Re.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(Re.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(Re.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map(t=>{let[i,{track:r}]=t;return{track:r,type:i}})),e.forEach(t=>{let{track:i,type:r}=t;switch(r){case ue.LocalVideoTrack:i.off(Re.GET_STATS,this.handleGetLocalVideoStats),i.off(Re.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.off(Re.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.off(Re.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.off(Re.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),i.off(Re.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.off(Re.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.off(Re.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case ue.LocalAudioTrack:this.unbindLocalAudioTrackEvents(i);case ue.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(e){e instanceof nn?e.trackList.forEach(t=>{t.off(Re.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Re.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Re.GET_STATS,this.handleGetLocalAudioStats),t.off(Re.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Re.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.off(Re.GET_STATS,this.handleGetLocalAudioStats),e.off(Re.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Re.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Re.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(Re.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Re.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof Wd&&t.addListener(Re.GET_STATS,i=>{i(this.handleGetRemoteVideoStats(e))}),t instanceof Eo&&t.addListener(Re.GET_STATS,i=>{i(this.handleGetRemoteAudioStats(e))})}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(Re.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,i]=e;i.has(be.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(be.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)})}createGatewayPublishMessage(e,t){return e.map((i,r)=>{var o;let s,{track:a,type:c}=i;switch(c){case ue.LocalAudioTrack:s=_t.Audio;break;case ue.LocalVideoTrack:s=z(o=a._hints).call(o,ui.SCREEN_TRACK)?_t.Screen:_t.High;break;case ue.LocalVideoLowTrack:s=_t.Low}return{kind:c===ue.LocalAudioTrack?be.AUDIO:be.VIDEO,stream_type:s,mid:t[r].id,ssrcs:t[r].localSSRC,isMuted:a.muted||!a.enabled}})}createGatewayUnpublishMessage(e){return e.map(t=>{var i;let r,[o,{track:s,ssrcs:a,id:c}]=t;switch(o){case ue.LocalVideoTrack:r=z(i=s._hints).call(i,ui.SCREEN_TRACK)?_t.Screen:_t.High;break;case ue.LocalAudioTrack:r=_t.Audio;break;case ue.LocalVideoLowTrack:r=_t.Low}return{stream_type:r,ssrcs:a,mid:c}})}assignLocalTracks(e,t){e.forEach((i,r)=>{let{track:o,type:s}=i;this.localTrackMap.set(s,{track:o,id:t[r].id,ssrcs:t[r].localSSRC})})}withdrawLocalTracks(e){e.forEach(t=>{let[i]=t;this.localTrackMap.delete(i)})}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{var i;I.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(e.name,".onConnectionStateChange(").concat(t,")")),this.emit(xe.PeerConnectionStateChange,t),t!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),t==="connected"&&(e.isInRestartIce=!1),z(i=this._restartStates).call(i,t)&&!e.isInRestartIce&&(t==="disconnected"&&await vt(800),e.iceConnectionState!=="disconnected"&&e.iceConnectionState!=="failed"||this.handleDisconnect(e.direction))},e.onICEConnectionStateChange=t=>{t!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),I.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),H.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:bi.TRACER}).onSuccess(),this.emit(xe.IceConnectionStateChange,t)},e.onICETransportStateChange=t=>{I.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},e.onDTLSTransportStateChange=t=>{I.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},e.onDTLSTransportError=t=>{I.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},e.onFirstAudioDecoded=t=>{var i;const r=Array.from(ai(i=this.remoteUserMap).call(i)).find(s=>s._audioSSRC===t);var o;r&&(this.store.subscribe(r.uid,"audio",void 0,void 0,void 0,Date.now()),(o=r.audioTrack)===null||o===void 0||o.emit(Ho.FIRST_FRAME_DECODED),H.firstRemoteFrame(this.store.sessionId,Dt.FIRST_AUDIO_DECODE,Xi.FIRST_AUDIO_DECODE,{peer:r._uintid,subscribeElapse:eo.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=t=>{var i;const r=Array.from(ai(i=this.remoteUserMap).call(i)).find(o=>o._audioSSRC===t);r&&H.firstRemoteFrame(this.store.sessionId,Dt.FIRST_AUDIO_RECEIVED,Xi.FIRST_AUDIO_RECEIVED,{peer:r._uintid,subscribeElapse:eo.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(t,i,r)=>{this.reportVideoFirstFrameDecoded(t,i,r)},e.onFirstVideoReceived=t=>{var i;const r=Array.from(ai(i=this.remoteUserMap).call(i)).find(o=>o._videoSSRC===t);r&&H.firstRemoteFrame(this.store.sessionId,Dt.FIRST_VIDEO_RECEIVED,Xi.FIRST_VIDEO_RECEIVED,{peer:r._uintid,subscribeElapse:eo.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(t,i)=>{const r=t.candidateType==="relay",o=i.candidateType==="relay";i.candidateType!=="unknown"&&r===o||this.emit(xe.ConnectionTypeChange,r),I.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(_s(i))," -> ").concat(JSON.stringify(_s(t)),")"))},e.onSelectedRemoteCandidateChanged=(t,i)=>{I.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(_s(i))," -> ").concat(JSON.stringify(_s(t)),")"))},e.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)},e.onLocalCandidate=t=>{this.emit(xe.LocalCandidate,{candidate:t,direction:e.direction})}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}async handleDisconnect(e){const t=e===Je.SEND_ONLY?this.sendConnection:this.recvConnection;t&&!t.isInRestartIce&&(t.isInRestartIce=!0,I.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(t.name,"] start use restartICE")),e===Je.SEND_ONLY?this.restartICE(e):yt(this,xe.RequestP2PRestartICE,{direction:Je.SEND_ONLY}))}filterTobeMutedTracks(e){const t=[];if(this.getAllTracks().indexOf(e)===-1)return t;const i=this.localTrackMap.get(ue.LocalAudioTrack);if(e instanceof Zi&&(i==null?void 0:i.track)instanceof nn)return i.track.isActive||t.push([ue.LocalAudioTrack,i]),t;const r=Array.from(this.localTrackMap.entries()).find(o=>{let[,{track:s}]=o;return e===s});if(r&&(t.push(r),r[0]===ue.LocalVideoTrack)){const o=this.localTrackMap.get(ue.LocalVideoLowTrack);o&&t.push([ue.LocalVideoLowTrack,o])}return t}filterTobeUnmutedTracks(e){const t=[],i=this.localTrackMap.get(ue.LocalAudioTrack);if(e instanceof Zi&&(i==null?void 0:i.track)instanceof nn)return i.track.isActive&&t.push([ue.LocalAudioTrack,i]),t;const r=Array.from(this.localTrackMap.entries()).find(o=>{let[,{track:s}]=o;return e===s});if(r)if(r[0]===ue.LocalVideoTrack){t.push(r);const o=this.localTrackMap.get(ue.LocalVideoLowTrack);o&&t.push([ue.LocalVideoLowTrack,o])}else t.push(r);return t}createMuteMessage(e){return e.map(t=>{var i;let r,[o,{track:s,ssrcs:a,id:c}]=t;switch(o){case ue.LocalAudioTrack:r=_t.Audio;break;case ue.LocalVideoTrack:r=z(i=s._hints).call(i,ui.SCREEN_TRACK)?_t.Screen:_t.High;break;case ue.LocalVideoLowTrack:r=_t.Low}return{stream_type:r,ssrcs:a,mid:c}})}createUnmuteMessage(e){return e.map(t=>{var i;let r,[o,{track:s,ssrcs:a,id:c}]=t;switch(o){case ue.LocalAudioTrack:r=_t.Audio;break;case ue.LocalVideoTrack:r=z(i=s._hints).call(i,ui.SCREEN_TRACK)?_t.Screen:_t.High;break;case ue.LocalVideoLowTrack:r=_t.Low}return{stream_type:r,ssrcs:a,mid:c}})}filterTobeUnSubscribedTracks(e,t){const i=[],r=this.remoteUserMap.get(e);if(!r)return i;if(t){const o=r.get(t);if(!o)return i;i.push([e,{kind:t,id:o}])}else Array.from(r.entries()).forEach(o=>{let[s,a]=o;i.push([e,{kind:s,id:a}])});return i}createUnsubscribeMessage(e){const t=[];return e.forEach(i=>{let[r,{kind:o,id:s}]=i;switch(o){case be.VIDEO:return void(r._videoSSRC&&t.push({stream_type:be.VIDEO,ssrcId:r._videoSSRC}));case be.AUDIO:return void(r._audioSSRC&&t.push({stream_type:be.AUDIO,ssrcId:r._audioSSRC}))}}),t}withdrawRemoteTracks(e){e.forEach(t=>{let[i,{kind:r}]=t;const o=this.remoteUserMap.get(i);o&&(o.delete(r),Array.from(o.entries()).length===0&&this.remoteUserMap.delete(i))})}async updateBitrateLimit(e){const t=this.localTrackMap.get(ue.LocalVideoTrack),i=this.localTrackMap.get(ue.LocalVideoLowTrack);t&&(await t.track.setBitrateLimit(e.uplink),await new Z((r,o)=>{this.handleUpdateVideoEncoder(t.track,r,o,!0)})),i&&e.low_stream_uplink&&(await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0}),await new Z((r,o)=>{this.handleUpdateVideoEncoder(i.track,r,o,!0)}))}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const e=this.sendConnection.peerConnectionState,t=this.recvConnection.peerConnectionState;return e!=="connected"&&t!=="connected"}return!0}async tryToUnmuteAudio(e){for(let t=0;t<e.length;t++)if(e[t]instanceof Zi){const i=this.filterTobeUnmutedTracks(e[t]);if(i.length===0)continue;const r=this.createUnmuteMessage(i);return void await Xt(this,xe.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(e=>{let[,{ssrcs:t}]=e;return!!t}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!((t=this.recvConnection)===null||t===void 0||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(xe.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(xe.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await vt(fa(this.dtlsFailedCount,yr)),this.emit(xe.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(ue.LocalVideoTrack)||this.pendingLocalTracks.some(e=>e instanceof yi)}throwIfTrackTypeNotMatch(e){if(e.filter(t=>t instanceof yi).length>1)throw new oe(O.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter(t=>t instanceof Zi).length>1&&(e.some(t=>t instanceof Zi&&t._bypassWebAudio)||!Mt().webAudioMediaStreamDest))throw new oe(O.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof yi&&this.pendingLocalTracks.some(i=>i instanceof yi))throw new oe(O.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Zi&&this.pendingLocalTracks.some(i=>i instanceof Zi)&&(!Mt().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some(i=>i instanceof Zi&&i._bypassWebAudio)))throw new oe(O.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const i=!B("DISABLE_DUAL_STREAM_USE_ENCODING")&&Mt().supportDualStreamEncoding,r=fy(fy({},{width:160,height:120,framerate:15,bitrate:50}),t);let o;o=i?e._mediaStreamTrack.clone():IC(e,r);const s=li(8,"track-low-"),a=new yi(o,fy(fy({},i&&{scaleResolutionDownBy:bl(r,e)}),{},{frameRate:r.framerate,bitrateMax:r.bitrate,bitrateMin:r.bitrate}),void 0,void 0,s);return a.on(Nc.TRANSCEIVER_UPDATED,c=>{e._updateRtpTransceiver(c,Kf.LOW_STREAM)}),a._hints.push(ui.LOW_STREAM),e.addListener(Re.NEED_CLOSE,()=>{a.close()}),a}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,t,i,r){var o;const s=Array.from(ai(o=this.remoteUserMap).call(o)).find(a=>a._videoSSRC===e);if(s){r||this.store.subscribe(s.uid,"video",void 0,void 0,void 0,void 0,Date.now());const a=this.store.keyMetrics,c=a.subscribe.find(d=>d.userId===s.uid&&d.type==="video");H.firstRemoteVideoDecode(this.store.sessionId,Dt.FIRST_VIDEO_DECODE,Xi.FIRST_VIDEO_DECODE,{peer:s._uintid,videowidth:t,videoheight:i,subscribeElapse:eo.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:a.requestAPEnd||0,apStart:a.requestAPStart||0,joinGwEnd:a.joinGatewayEnd||0,joinGwStart:a.joinGatewayStart||0,pcEnd:a.peerConnectionEnd||0,pcStart:a.peerConnectionStart||0,subscriberEnd:(c==null?void 0:c.subscribeEnd)||0,subscriberStart:(c==null?void 0:c.subscribeStart)||0,videoAddNotify:(c==null?void 0:c.streamAdded)||0,state:r?1:0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.recvConnection)return!1;const r=this.remoteUserMap.get(e);if(!r)return!1;const o=r.get(t);if(!o)return!1;const s=await this.recvConnection.getRemoteSSRC(o);return s!==void 0&&s!==i}isPreSubScribe(e){return!1}async publishDataChannel(e){throw new oe(O.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new oe(O.NOT_SUPPORTED)}async subscribeDataChannel(e,t){throw new oe(O.NOT_SUPPORTED)}async unsubscribeDataChannel(e,t){throw new oe(O.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,t){throw new oe(O.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,t){throw new oe(O.NOT_SUPPORTED)}async preConnect(e){throw new oe(O.NOT_SUPPORTED)}getEstablishParams(){throw new oe(O.NOT_SUPPORTED)}async reSubscribe(e){throw new oe(O.NOT_SUPPORTED)}reportVideoFirstFrameRender(e){}async updateVideoStreamParameter(e,t){throw new oe(O.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(e=>{let[t,{track:i}]=e;t===ue.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,Kf.LOW_STREAM):i._updateRtpTransceiver(void 0)})}},Ae(tr.prototype,"p2pConnect",[t1],Object.getOwnPropertyDescriptor(tr.prototype,"p2pConnect"),tr.prototype),Ae(tr.prototype,"unpublish",[i1],Object.getOwnPropertyDescriptor(tr.prototype,"unpublish"),tr.prototype),Ae(tr.prototype,"unpublishLowStream",[r1],Object.getOwnPropertyDescriptor(tr.prototype,"unpublishLowStream"),tr.prototype),Ae(tr.prototype,"subscribe",[n1],Object.getOwnPropertyDescriptor(tr.prototype,"subscribe"),tr.prototype),Ae(tr.prototype,"mockSubscribe",[o1],Object.getOwnPropertyDescriptor(tr.prototype,"mockSubscribe"),tr.prototype),Ae(tr.prototype,"unsubscribe",[s1],Object.getOwnPropertyDescriptor(tr.prototype,"unsubscribe"),tr.prototype),Ae(tr.prototype,"muteRemote",[a1],Object.getOwnPropertyDescriptor(tr.prototype,"muteRemote"),tr.prototype),Ae(tr.prototype,"unmuteRemote",[c1],Object.getOwnPropertyDescriptor(tr.prototype,"unmuteRemote"),tr.prototype),Ae(tr.prototype,"hasRemoteMediaWithLock",[d1],Object.getOwnPropertyDescriptor(tr.prototype,"hasRemoteMediaWithLock"),tr.prototype),Ae(tr.prototype,"disconnectForReconnect",[l1],Object.getOwnPropertyDescriptor(tr.prototype,"disconnectForReconnect"),tr.prototype),Ae(tr.prototype,"remoteMediaSsrcChanged",[er],Object.getOwnPropertyDescriptor(tr.prototype,"remoteMediaSsrcChanged"),tr.prototype),tr);function ms(e){return function(t,i,r){const o=t[i];if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];switch(e){case Xc.SEND_ONLY:{const d=await this.sendMutex.lock("From P2PChannel2.".concat(i));try{return await o.apply(this,a)}finally{d()}}case Xc.RECEIVE_ONLY:{const d=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await o.apply(this,a)}finally{d()}}default:{const d=await this.sendMutex.lock("From P2PChannel2.".concat(i)),l=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await o.apply(this,a)}finally{d(),l()}}}},r}}class tf extends Vi{constructor(t,i){super(),M(this,"signal",void 0),M(this,"token",void 0),M(this,"tokenTimeout",void 0),M(this,"tokenInterval",void 0),M(this,"_sequence",0),M(this,"userMap",new Map),M(this,"encoder",new TextEncoder),this.signal=t,this.token=i;const r=()=>{this.signal.connectionState===Ee.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(r,1e3):this.tokenInterval=window.setTimeout(r,3*B("P2P_TOKEN_INTERVAL"))};r()}async send(t,i,r,o,s){var a;if(this.userMap.size===0)return;const c=Array.from(Vr(a=this.userMap).call(a))[0].token;typeof i!="string"&&(i=JSON.stringify(i)),o=o??li(6,""),s=s??this._sequence++;const d={_id:o,_type:t,_seq:s,_message:i,token:"".concat(this.token,"_").concat(c)};B("SHOW_P2P_LOG")&&I.debug("send message",d,"noNeedResponse : ".concat(r)),this.splitMessage(JSON.stringify(d)).forEach(h=>{this.signal.request(Be.DATA_STREAM,{payload:bu(this.encoder.encode(h))})});const l=new Z((h,p)=>{const f=window.setTimeout(()=>{this.off("res-@".concat(o,"_ack"),m),this.off("res-@".concat(o),S),this.off(sc.ABORT,g),I.debug("[external-signal] request timeout, type: ".concat(t,", requestId: ").concat(o)),this.userMap.size===0?p(new oe(O.INVALID_REMOTE_USER)):p(new oe(O.TIMEOUT))},B("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),m=()=>{f&&window.clearTimeout(f),this.off(sc.ABORT,g),r&&h()},g=()=>{f&&window.clearTimeout(f),this.off("res-@".concat(o,"_ack"),m),this.off("res-@".concat(o),S),p(new oe(O.EXTERNAL_SIGNAL_ABORT,"type: ".concat(t,", requestId: ").concat(o)))};this.once(sc.ABORT,g),this.once("res-@".concat(o,"_ack"),m);const S=(C,b)=>{T=!0,f&&window.clearTimeout(f),this.off("res-@".concat(o,"_ack"),m),this.off(sc.ABORT,g),C==="success"?h(b):p(new oe(O.P2P_MESSAGE_FAILED,"request ".concat(t," failed, requestId: ").concat(o)))};let T=!1;r||(this.once("res-@".concat(o),S),vt(B("SIGNAL_REQUEST_TIMEOUT")).then(()=>{T||I.warning("external_signal request timeout, type: ".concat(t,", requestId: ").concat(o,", ").concat(d))}))});try{return await l}catch(h){if(h.code===O.TIMEOUT)return await this.send(t,i,r,o,s);throw h}}onMessage(t){var i;const{_uid:r}=t;let o,s=this.userMap.get(r);if(s)o=s.splitMessageMap;else{if(this.userMap.size>0||!("_type"in t)||t._type!==cr.CHECK)return;const{token:l}=t;o=new Map,s={uid:r,isStart:!0,token:l,splitMessageMap:o,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(r,s),this.signal.emit(Ke.ON_USER_ONLINE,{uid:r}),this.handleUserOnline()}if("id"in t&&"total"in t){var a;const{id:l,total:h}=t,p=(a=o.get(l))!==null&&a!==void 0?a:[];if(p.push(t),o.has(l)||o.set(l,p),p.length!==h)return;{const f=Ka(p).call(p,(m,g)=>m.index-g.index).map(m=>m.payload).join("");o.delete(l),(t=JSON.parse(f))._uid=r}}const{_type:c,token:d}=t;if(z(i=[cr.ACK,cr.CHECK]).call(i,c))return c===cr.CHECK&&this.handleCheckToken(s,d),void this.receiveMessage(t);d==="".concat(s.token,"_").concat(this.token)?this.handleReceivedMessage(t):I.debug('Receive unexpected message", '.concat(d,", cur_token: ").concat(s.token,"_").concat(this.token),t)}check(){const t={_id:li(6,""),token:this.token,_type:cr.CHECK};B("SHOW_P2P_LOG")&&I.debug("send message",t),this.signal.request(Be.DATA_STREAM,{payload:bu(this.encoder.encode(JSON.stringify(t)))})}ack(t){const i={_id:t,_type:cr.ACK,token:this.token};B("SHOW_P2P_LOG")&&I.debug("send message",i),this.signal.request(Be.DATA_STREAM,{payload:bu(this.encoder.encode(JSON.stringify(i)))})}response(t,i,r){this.send(cr.RESPONSE,JSON.stringify({success:!r,message:i}),!0,t)}handleReceivedMessage(t){const i=()=>{this.userMap.forEach(l=>{const{receivedMessagesMap:h,nextExpectedSequenceNumber:p}=l;for(;h.has(p);){const f=h.get(p);h.delete(p),this.receiveMessage(f),l.nextExpectedSequenceNumber++}})};if(!t)return void i();const{_uid:r,_seq:o}=t,s=this.userMap.get(r),{receivedMessagesMap:a,isStart:c,nextExpectedSequenceNumber:d}=s;if(o<d)return this.ack(t._id),void I.debug("[external-signal] receive old message, seq: ".concat(o,", ").concat(t._message));a.set(o,t),c&&o===d&&(this.receiveMessage(t),a.delete(d),s.nextExpectedSequenceNumber++,i())}receiveMessage(t){const{_id:i,_type:r,_message:o,_uid:s}=t;if(B("SHOW_P2P_LOG")&&I.debug("receive message",t),i){let a;switch(t._type!==cr.ACK&&(o&&(a=JSON.parse(o)),this.ack(t._id)),t._type){case cr.CANDIDATE:case cr.CONTROL:this.signal.emit(r,a,s);break;case cr.PUBLISH:case cr.UNPUBLISH:case cr.RESTART_ICE:case cr.CALL:a.uid=s,yt(this.signal,r,a).then(c=>{this.response(t._id,c)}).catch(()=>{this.response(t._id,void 0,!0)});break;case cr.ACK:this.getListeners("res-@".concat(i,"_ack")).length>0&&this.emit("res-@".concat(i,"_ack"));break;case cr.RESPONSE:{const{success:c,message:d}=a;this.emit("res-@".concat(i),c?"success":"failed",d);break}}}}splitMessage(t){if(t.length<tf.MAX_MESSAGE_SIZE)return[t];const i=[],{remoteToken:r}=JSON.parse(t),o=li(6,"");let s=0,a=800;const c=Math.ceil(t.length/a);for(;t.length>0;){s++;const d={id:o,index:s,total:c,payload:t.slice(0,a),token:"".concat(this.token,"_").concat(r)};JSON.stringify(d).length>tf.MAX_MESSAGE_SIZE?a-=50:(i.push(d),t=t.slice(a))}return i.map(d=>JSON.stringify(d))}handleCheckToken(t,i){return t.token!==i?(I.debug("token changed, from ".concat(t.token," to ").concat(i)),this.reset(t.uid,i),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{I.debug("token timeout, ".concat(i)),this.reset(t.uid)},B("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const t=await yt(this.signal,cr.CALL,void 0),i=await this.send(cr.CALL,t);this.signal.emit(le.P2P_CONNECTION,i,!0)}async reset(t,i){const r=this.userMap.get(t);r&&(this.emit(sc.ABORT),this.signal.emit(Ke.ON_USER_OFFLINE,{uid:r.uid,reason:pz.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),i||(I.debug("change local token from ".concat(i," to ").concat(i)),this.token=li(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(sc.ABORT)}}M(tf,"MAX_SIZE",1),M(tf,"MAX_MESSAGE_SIZE",1024);class I9 extends Vi{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===Ee.CONNECTED?this.emit(le.WS_CONNECTED):t===Ee.RECONNECTING?this.emit(le.WS_RECONNECTING,this._websocketReconnectReason):t===Ee.CLOSED&&this.emit(le.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,i){super(),M(this,"__name__","P2PSignal"),M(this,"_disconnectedReason",void 0),M(this,"_websocketReconnectReason",void 0),M(this,"_connectionState",Ee.CLOSED),M(this,"reconnectToken",void 0),M(this,"p2pToken",void 0),M(this,"websocket",void 0),M(this,"openConnectionTime",void 0),M(this,"clientId",void 0),M(this,"lastMsgTime",Date.now()),M(this,"uploadCache",[]),M(this,"uploadCacheInterval",void 0),M(this,"rttRolling",new kf(5)),M(this,"pingpongTimer",void 0),M(this,"pingpongTimeoutCount",0),M(this,"joinResponse",void 0),M(this,"multiIpOption",void 0),M(this,"initError",void 0),M(this,"spec",void 0),M(this,"store",void 0),M(this,"_external_signal",void 0),M(this,"onWebsocketMessage",r=>{if(r.data instanceof ArrayBuffer)return void this.emit(le.ON_BINARY_DATA,r.data);const o=JSON.parse(r.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(o,"_id")){const s="res-@".concat(o._id);this.emit(s,o._result,o._message)}else if(Object.prototype.hasOwnProperty.call(o,"_type")){switch(o._type){case Ke.ON_DATA_STREAM:return void this.handleDataStream(o._message);case Ke.MUTE_AUDIO:case Ke.MUTE_VIDEO:case Ke.ON_P2P_LOST:case Ke.ON_USER_ONLINE:return;case Ke.ON_USER_OFFLINE:const{uid:s}=o._message;return I.debug("[".concat(this.clientId,"] user-offline uid: ").concat(s)),void this._external_signal.reset(s)}if(this.emit(o._type,o._message),o._type===Ke.ON_NOTIFICATION&&this.handleNotification(o._message),o._type===Ke.ON_USER_BANNED)switch(o._message.error_code){case 14:this.close(bt.UID_BANNED);break;case 15:this.close(bt.IP_BANNED);break;case 16:this.close(bt.CHANNEL_BANNED)}if(o._type===Ke.ON_USER_LICENSE_BANNED)switch(o._message.error_code){case ye.ERR_LICENSE_MISSING:this.close(bt.LICENSE_MISSING);break;case ye.ERR_LICENSE_EXPIRED:this.close(bt.LICENSE_EXPIRED);break;case ye.ERR_LICENSE_MINUTES_EXCEEDED:this.close(bt.LICENSE_MINUTES_EXCEEDED);break;case ye.ERR_LICENSE_PERIOD_INVALID:this.close(bt.LICENSE_PERIOD_INVALID);break;case ye.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(bt.LICENSE_MULTIPLE_SDK_SERVICE);break;case ye.ERR_LICENSE_ILLEGAL:this.close(bt.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=t.clientId,this.spec=t,this.store=i,this.websocket=new M_("gateway-".concat(this.clientId),this.spec.retryConfig,!0,B("JOIN_GATEWAY_USE_DUAL_DOMAIN"),B("JOIN_GATEWAY_USE_443PORT_ONLY"),i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Ee.CONNECTED&&this.reconnect("retry",Gi.OFFLINE)}),this.p2pToken=li(6,""),this._external_signal=new tf(this,this.p2pToken)}async request(t,i,r,o){const s=li(6,""),a={_id:s,_type:t,_message:i},c=this.websocket.connectionID,d=()=>new Z((g,S)=>{if(this.connectionState===Ee.CONNECTED)return g();const T=()=>{this.off(le.WS_CLOSED,C),g()},C=()=>{this.off(le.WS_CONNECTED,T),S(new oe(O.WS_ABORT))};this.once(le.WS_CONNECTED,T),this.once(le.WS_CLOSED,C)});if(this.connectionState!==Ee.CONNECTING&&this.connectionState!==Ee.RECONNECTING||t===Be.JOIN||t===Be.REJOIN||await d(),this.websocket.sendMessage(a,!0),o)return;const l=new Z((g,S)=>{let T=!1;const C=(D,x)=>{T=!0,g({isSuccess:D==="success",message:x||{}}),this.off(le.WS_CLOSED,b),this.off(le.WS_RECONNECTING,b),this.emit(le.REQUEST_SUCCESS,t,i)};this.once("res-@".concat(s),C);const b=()=>{S(new oe(O.WS_ABORT,"type: ".concat(t))),this.off(le.WS_CLOSED,b),this.off(le.WS_RECONNECTING,b),this.off("res-@".concat(s),C)};this.once(le.WS_CLOSED,b),this.once(le.WS_RECONNECTING,b),vt(B("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==c||T||(I.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(le.REQUEST_TIMEOUT,t,i))})});let h=null;try{h=await l}catch(g){if(this.connectionState===Ee.CLOSED||t===Be.LEAVE)throw new oe(O.WS_ABORT);return!this.spec.forceWaitGatewayResponse||r?g.throw():t===Be.JOIN||t===Be.REJOIN?null:(await d(),await this.request(t,i))}if(h.isSuccess)return h.message;const p=Number(h.message.error_code||h.message.code),f=jh(p),m=new oe(O.UNEXPECTED_RESPONSE,"".concat(f.desc,": ").concat(h.message.error_str),{code:p,data:h.message,desc:f.desc});return f.action==="success"?h.message:(I.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(p,", message: ").concat(f.desc,", action: ").concat(f.action)),p===ye.ERR_TOO_MANY_BROADCASTERS?((t===Be.JOIN||t===Be.REJOIN)&&(this.initError=m,this.close()),m.throw()):f.action==="failed"?m.throw():f.action==="quit"?(this.initError=m,this.close(),m.throw()):(p===ye.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=h.message.option,I.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Gi.MULTI_IP)):this.reconnect(f.action,Gi.SERVER_ERROR),t===Be.JOIN||t===Be.REJOIN?null:await this.request(t,i)))}waitMessage(t,i){return new Z(r=>{const o=s=>{(!i||i(s))&&(this.off(t,o),r(s))};this.on(t,o)})}uploadWRTCStats(t){if(!this.store.sessionId)return void I.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(it.WRTC_STATS,i)}upload(t,i){const r={_type:t,_message:i};try{this.websocket.sendMessage(r)}catch{const s=B("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(r),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Ee.CONNECTED)return;const a=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(a._type,a._message)},B("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,i){const r={_type:t,_message:i};this.websocket.sendMessage(r)}async sendExtensionMessage(t,i,r){return await this._external_signal.send(t,i,r)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Z((i,r)=>{this.once(le.WS_CONNECTED,()=>i(this.joinResponse)),this.once(le.WS_CLOSED,()=>r(this.initError||new oe(O.WS_ABORT))),this.connectionState=Ee.CONNECTING,this.websocket.init(t).catch(r)})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=t||bt.LEAVE,this.connectionState=Ee.CLOSED,I.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=li(6,""),this._external_signal.clear(),this._external_signal=new tf(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(le.ABORT_P2P_EXECUTION);const t=await yt(this,le.REQUEST_JOIN_INFO),i=await this.request(Be.JOIN,t);if(!i)return this.emit(le.REPORT_JOIN_GATEWAY,O.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(le.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Ee.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(t,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,i)}async downgradeCodec(t){return!1}handleDataStream(t){try{var i;const r=_a(t.payload),o=new TextDecoder().decode(r),s=JSON.parse(o);"total"in s&&"id"in s||z(i=Object.values(cr)).call(i,s._type)?(s._uid=t.uid,this._external_signal.onMessage(s)):this.emit(Ke.ON_DATA_STREAM,t)}catch{this.emit(Ke.ON_DATA_STREAM,t)}}handleNotification(t){I.debug("[".concat(this.clientId,"] receive notification: "),t);const i=jh(t.code);if(i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?t.code===ye.ERR_REPEAT_JOIN_CHANNEL&&B("IGNORE_UID_CHECK")?void this.close(bt.UID_CONFLICT):(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(bt.UID_BANNED),void this.close()):void this.reconnect(i.action,Gi.SERVER_ERROR);I.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=B("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=t&&(I.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>B("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Gi.TIMEOUT):this.request(Be.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const r=Date.now()-i;this.rttRolling.add(r),B("REPORT_STATS")&&this.send(Be.PING_BACK,{pingpongElapse:r})}).catch(r=>{})}handleWebsocketEvents(){this.websocket.on(ht.RECONNECT_CREATE_CONNECTION,t=>{this.emit(le.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(ht.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(ht.CLOSED,()=>{this.connectionState=Ee.CLOSED}),this.websocket.on(ht.FAILED,()=>{this._disconnectedReason=bt.NETWORK_ERROR,this.connectionState=Ee.CLOSED}),this.websocket.on(ht.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===Ee.CONNECTED?this.connectionState=Ee.RECONNECTING:this.connectionState=Ee.CONNECTING}),this.websocket.on(ht.WILL_RECONNECT,(t,i,r)=>{t!=="retry"?(I.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0):I.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),r(t)}),this.websocket.on(ht.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(t=>{if(this.emit(le.REPORT_JOIN_GATEWAY,t,this.url||""),t instanceof oe&&t.code===O.UNEXPECTED_RESPONSE&&t.data.code===ye.ERR_NO_AUTHORIZED)return I.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Gi.SERVER_ERROR);I.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Gi.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(ht.REQUEST_NEW_URLS,(t,i)=>{yt(this,le.REQUEST_RECOVER,this.multiIpOption).then(t).catch(i)}),this.websocket.on(ht.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Ke.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}const rx={name:"P2PChannel",create:function(e){let{store:t,statsCollector:i}=e;return new nl(t,i)},createSubmodule:function(e){let{store:t,spec:i}=e;return new I9(i,t)}};function u1(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function nx(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?u1(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):u1(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}class Ui{constructor(t){M(this,"sessionDesc",void 0),M(this,"localCapabilities",void 0),M(this,"rtpCapabilities",void 0),M(this,"candidates",void 0),M(this,"_originCandidates",void 0),M(this,"iceParameters",void 0),M(this,"dtlsParameters",void 0),M(this,"setup",void 0),M(this,"currentMidIndex",void 0),M(this,"cname",void 0),t=wi(t);const{iceParameters:i,dtlsParameters:r,candidates:o,rtpCapabilities:s,setup:a,localCapabilities:c,sdkCodec:d,cname:l}=t,h=sn(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=s,this.candidates=o,this._originCandidates=wi(o),this.iceParameters=i,this.dtlsParameters=r,this.setup=a,this.localCapabilities=c,this.cname=l;for(let p=0;p<h.mediaDescriptions.length;p++){const f=h.mediaDescriptions[p];if(f.attributes.iceUfrag=i.iceUfrag,f.attributes.icePwd=i.icePwd,f.attributes.fingerprints=r.fingerprints,f.attributes.candidates=o,f.attributes.setup=a,f.media.mediaType==="video"){f.media.fmts=s.videoCodecs.map(S=>S.payloadType.toString(10));const m=s.videoCodecs.filter(S=>{var T,C;return(T=S.rtpMap)===null||T===void 0?void 0:z(C=T.encodingName.toLowerCase()).call(C,d)}),g=s.videoCodecs.filter(S=>!z(m).call(m,S));f.attributes.payloads=[...m,...g],f.attributes.extmaps=s.videoExtensions}f.media.mediaType==="audio"&&(f.media.fmts=s.audioCodecs.map(m=>m.payloadType.toString(10)),f.attributes.payloads=s.audioCodecs,f.attributes.extmaps=s.audioExtensions),h.mediaDescriptions[p]=this.mungMediaDesc(f)}this.sessionDesc=h,this.currentMidIndex=h.mediaDescriptions.length-1}toString(){return Du(this.sessionDesc)}send(t,i,r){const{ssrcs:o,ssrcGroups:s}=Kd(i,this.cname),a=this.sessionDesc.mediaDescriptions.find(l=>t===be.VIDEO?l.media.mediaType==="video":l.media.mediaType==="audio"),c=o[0].attributes.label,d=o[0].attributes.mslabel;return a.attributes.ssrcs=a.attributes.ssrcs.concat(o),a.attributes.ssrcGroups=a.attributes.ssrcGroups.concat(s),{id:c,mslabel:d}}batchSend(t){return t.map(i=>{let{kind:r,ssrcMsg:o}=i;return this.send(r,o,void 0)})}stopSending(t){this.sessionDesc.mediaDescriptions.forEach(i=>{const r=[],o=[],s=[];i.attributes.ssrcs.forEach(a=>{z(t).call(t,a.attributes.label||"")?s.push(a):r.push(a)}),i.attributes.ssrcGroups.forEach(a=>{var c;z(c=s.map(d=>d.ssrcId)).call(c,a.ssrcIds[0])||o.push(a)}),i.attributes.ssrcs=r,i.attributes.ssrcGroups=o})}mute(t){const i=this.sessionDesc.mediaDescriptions.find(r=>r.attributes.mid===t);if(!i)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));i.attributes.direction="inactive"}unmute(t){const i=this.sessionDesc.mediaDescriptions.find(r=>r.attributes.mid===t);if(!i)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));i.attributes.direction="sendonly"}receive(t,i,r){t.forEach((o,s)=>{const a=o._mediaStreamTrack,c=this.sessionDesc.mediaDescriptions.findIndex(l=>l.attributes.mid===a.kind),d=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[c],o);this.sessionDesc.mediaDescriptions[c]=d})}stopReceiving(t){}updateCandidates(t){const i=this._originCandidates.filter(o=>o.transport==="udp"),r=[];if(i.forEach(o=>{r.push(nx(nx({},o),{},{foundation:"tcpcandidate",priority:Number(o.priority)-1+"",transport:"tcp",port:Number(o.port)+90+""}))}),i.length!==0){switch(t){case Ir.TCP_RELAY:this.candidates=r;break;case Ir.UDP_TCP_RELAY:case Ir.RELAY:this.candidates=[...i,...r];break;default:this.candidates=i}for(const o of this.sessionDesc.mediaDescriptions)o.attributes.candidates=this.candidates}}restartICE(t){t=wi(t),this.iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(i=>{i.attributes.iceUfrag=t.iceUfrag,i.attributes.icePwd=t.icePwd})}predictReceivingMids(t){const i=[];for(let r=0;r<t;r++)i.push((this.currentMidIndex+r+1).toString(10));return i}mungRecvMediaDsec(t,i){const r=wi(t);return Fu(r,i),cC(r,i),r}updateRecvMedia(t,i){const r=this.sessionDesc.mediaDescriptions.findIndex(o=>o.attributes.mid===t);if(r!==-1){const o=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[r],i);this.sessionDesc.mediaDescriptions[r]=o}}bumpMid(t){this.currentMidIndex+=t}updateTrackLabel(t,i,r){const o=this.sessionDesc.mediaDescriptions.find(a=>t===be.VIDEO?a.attributes.mid==="video":a.attributes.mid==="audio");if(o){const a=o.attributes.ssrcs.find(c=>c.attributes.label===i);var s;a&&(a.attributes.label=r,(s=a.attributes.msid)===null||s===void 0||s.replace(i,r))}}mungMediaDesc(t){const i=wi(t);return LT(i),function(r){const o=r.attributes.extmaps.find(s=>PT(s.extensionName));o&&r.attributes.extmaps.splice(r.attributes.extmaps.indexOf(o),1),r.attributes.payloads.forEach(s=>{const a=s.rtcpFeedbacks.findIndex(c=>c.type==="transport-cc");a!==-1&&s.rtcpFeedbacks.splice(a,1)})}(i),i}getSSRC(t){for(const i of this.sessionDesc.mediaDescriptions)for(const r of i.attributes.ssrcs)if(r.attributes.label===t)return[r]}}var Di;function IR(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function my(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?IR(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):IR(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let Ec=(Di=class A1 extends ke{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var i;return z(i=Object.keys(Ph)).call(i,t)}))]}constructor(t,i){super(t,i),M(this,"store",void 0),M(this,"peerConnection",void 0),M(this,"remoteSDP",void 0),M(this,"initialOffer",void 0),M(this,"statsFilter",void 0),M(this,"useRTX",!1),M(this,"localCapabilities",void 0),M(this,"localCandidateCount",0),M(this,"allCandidatesReceived",!1),M(this,"establishPromise",void 0),M(this,"mutex",void 0),this.store=i,this.mutex=new jr("P2PConnection-mutex",i.clientId),this.peerConnection=new RTCPeerConnection(A1.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=nT(this.peerConnection,B("STATS_UPDATE_INTERVAL"),void 0,Ht()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const t=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=xc(t.sdp),r=ba(t.sdp,{filterRTX:!this.useRTX,filterVideoFec:B("FILTER_VIDEO_FEC"),filterAudioFec:B("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=r,this.initialOffer=t,my(my({},i),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:r},offerSDP:t.sdp})}catch(t){throw new oe(O.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async updateRemoteConnect(){}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new Ui(my(my({},t),{},{rtpCapabilities:t.rtpCapabilities.send,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec}));const i=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(i.toString()))}}async updateRemoteRTPCapabilities(t,i){throw new oe(O.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}getPreMedia(t){}send(t,i){var r=this;return ao(function*(){const o=yield Et(r.mutex.lock());try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=t.map(f=>r.peerConnection.addTrack(f._mediaStreamTrack)),a=yield Et(r.peerConnection.createOffer()),c=sn(a.sdp),d=t.map(f=>{const m=f._mediaStreamTrack,g=c.mediaDescriptions.find(S=>S.attributes.mid===m.kind);if(!g)throw new Error("Cannot extract ssrc from mediaDescription.");return function(S,T,C){const b=S.attributes.ssrcs.filter(x=>x.attributes.label===T),D=S.attributes.ssrcGroups;if(b.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(D&&b.length>1){const x=D.find(k=>k.ssrcIds.indexOf(b[0].ssrcId)!==-1);return x?[{ssrcId:x.ssrcIds[0],rtx:C?x.ssrcIds[1]:void 0}]:[{ssrcId:b[0].ssrcId}]}return[{ssrcId:b[0].ssrcId}]}(g,m.id,r.useRTX)});let l;try{l=yield d}catch(f){throw s.forEach(m=>{pn()&&m.replaceTrack(null),r.peerConnection.removeTrack(m)}),f}const h=r.mungSendOfferSDP(a.sdp,t);r.remoteSDP.receive(t,i,l);const p=r.remoteSDP.toString();return yield Et(r.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield Et(r.applySendEncodings(s,t)),yield Et(r.peerConnection.setRemoteDescription({type:"answer",sdp:p})),t.map((f,m)=>{const g=f._mediaStreamTrack.id;return{localSSRC:d[m],id:g}})}catch(s){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o()}})()}async stopSending(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const i=this.peerConnection.getSenders().filter(s=>{var a;return t.indexOf(((a=s.track)===null||a===void 0?void 0:a.id)||"")!==-1});if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");i.map(s=>{pn()&&s.replaceTrack(null),this.peerConnection.removeTrack(s)});const r=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(r),this.remoteSDP.stopReceiving(t);const o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(i.toString()))}}async receive(t,i,r,o){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{id:s,mslabel:a}=this.remoteSDP.send(t,i,o),c=new Z((h,p)=>{const f=setTimeout(()=>{p(new Error("Cannot receive track, id: ".concat(s)))},1e4),m=g=>{const S=ii();if((S.name==="Safari"&&Number(S.version)===11||Dr())&&g.track.id!==s&&g.streams[0].id===a){var T;const C=g.streams[0].getTracks()[0];return(T=this.remoteSDP)===null||T===void 0||T.updateTrackLabel(t,s,g.track.id),this.peerConnection.removeEventListener("track",m),clearTimeout(f),void h(C)}if(g.track.id===s)return this.peerConnection.removeEventListener("track",m),clearTimeout(f),void h(g.track)};this.peerConnection.addEventListener("track",m)}),d=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:d});const l=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(l),{track:await c,id:s}}catch(s){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(r)}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async muteRemote(t){}async unmuteRemote(t){}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const i=this.peerConnection.getSenders().filter(r=>{var o;return t.indexOf(((o=r.track)===null||o===void 0?void 0:o.id)||"")!==-1});if(i.length!==t.length)throw new Error("sender' length doesn't match mids' length.");i.map(r=>{if(pn()&&r.track)r.track.enabled=!1;else{const o=r.getParameters();o.encodings.forEach(s=>s.active=!1),r.setParameters(o)}})}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const i=this.peerConnection.getSenders().filter(s=>{var a;return t.indexOf(((a=s.track)===null||a===void 0?void 0:a.id)||"")!==-1});if(i.length!==t.length)throw new Error("Senders' length doesn't match mids' length.");i.map(async s=>{if(pn()&&s.track)s.track.enabled=!0;else{const a=s.getParameters();a.encodings.forEach(c=>c.active=!0),await s.setParameters(a)}});const r=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(r);const o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}restartICE(t){var i=this;return ao(function*(){const r=yield Et(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const o=Mt().supportPCSetConfiguration;if(t===Ir.RELAY&&!o)return;if(o){const l=i.peerConnection.getConfiguration(),h=t===Ir.RELAY?"relay":"all";l.iceTransportPolicy!==h&&(I.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(l.iceTransportPolicy,"] to [").concat(h,"]")),l.iceTransportPolicy=h,i.peerConnection.setConfiguration(l))}t!==Ir.RELAY&&i.remoteSDP.updateCandidates(t);const s=yield Et(i.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const a=xc(s.sdp),{remoteIceParameters:c}=yield a.iceParameters;i.remoteSDP.restartICE(c);const d=i.remoteSDP.toString();yield Et(i.peerConnection.setLocalDescription(s)),yield Et(i.peerConnection.setRemoteDescription({type:"answer",sdp:d}))}catch(o){I.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),o)}finally{r()}})()}close(){var t;this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const r=await this.peerConnection.createOffer(),o=this.mungSendOfferSDP(r.sdp,[i]);this.remoteSDP.updateRecvMedia(i._mediaStreamTrack.kind,i);const s=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:o}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(r){throw new oe(O.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(t,i){const r=this.peerConnection.getSenders().filter(o=>{var s;return((s=o.track)===null||s===void 0?void 0:s.id)===t});r.length===1&&await this.applySendEncodings(r,[i])}setStatsRemoteVideoIsReady(t,i){this.statsFilter.setVideoIsReady2(t,i)}async replaceTrack(t,i){const r=this.peerConnection.getSenders().find(o=>{var s;return((s=o.track)===null||s===void 0?void 0:s.id)===i});r&&await r.replaceTrack(t._mediaStreamTrack)}createDataChannels(t,i){throw new oe(O.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(t){throw new oe(O.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,I.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,I.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},B("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const i={iceServers:[],sdpSemantics:"plan-b"};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(bh(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...A1.turnServerConfigToIceServers(t.turnServer.servers)),B("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...A1.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(i.iceTransportPolicy="relay")}))),i}static turnServerConfigToIceServers(t){const i=[];return t.forEach(r=>{r.security?r.tcpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),i}async updateRtpSenderEncodings(t,i){var r;if(i||(i=this.peerConnection.getSenders().find(l=>{var h;return((h=l.track)===null||h===void 0?void 0:h.id)===t._mediaStreamTrack.id})),!i)return I.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(!Mt().supportSetRtpSenderParameters)return I.warn("Browser not support set rtp-sender parameters");const o={},s={};if(t instanceof yi)switch(t._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;default:o.degradationPreference="balanced"}if(B("DSCP_TYPE")&&ha()){var a;const l=B("DSCP_TYPE");z(a=["very-low","low","medium","high"]).call(a,l)&&(s.networkPriority=l)}const c=i.getParameters(),d=(r=c.encodings)===null||r===void 0?void 0:r[0];d&&Object.assign(d,s),Object.assign(c,o),I.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await i.setParameters(c)}async applySendEncodings(t,i){try{if(!Mt().supportSetRtpSenderParameters||t.length!==i.length)return;for(let r=0;r<t.length;r++){const o=t[r],s=i[r];o&&s&&await this.updateRtpSenderEncodings(s,o)}}catch{I.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,i){const r=sn(t);return i.forEach((o,s)=>{const a=o._mediaStreamTrack,c=r.mediaDescriptions.find(d=>d.attributes.mid===a.kind);c&&Fu(c,o)}),Du(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,i,r)=>{var o;(o=this.onFirstVideoDecoded)===null||o===void 0||o.call(this,t,i,r)},this.statsFilter.onSelectedLocalCandidateChanged=(t,i)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,t,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,i)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,t,i)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const i=this.remoteSDP.batchSend(t).map((s,a)=>{let{id:c,mslabel:d}=s;const{kind:l}=t[a];return new Z((h,p)=>{const f=setTimeout(()=>{p(new Error("Cannot receive track, id: ".concat(c)))},1e4),m=g=>{const S=ii();if(S.name==="Safari"&&Number(S.version)===11&&g.track.id!==c&&g.streams[0].id===d){var T;const C=g.streams[0].getTracks()[0];return(T=this.remoteSDP)===null||T===void 0||T.updateTrackLabel(l,c,g.track.id),this.peerConnection.removeEventListener("track",m),clearTimeout(f),void h({track:C,id:c})}if(g.track.id===c)return this.peerConnection.removeEventListener("track",m),clearTimeout(f),void h({track:g.track,id:c})};this.peerConnection.addEventListener("track",m)})}),r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const o=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(o),await Z.all(i)}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}}async getRemoteSSRC(t){if(!this.remoteSDP)return;const i=this.remoteSDP.getSSRC(t);return i==null?void 0:i[0].ssrcId}setConfiguration(t){if(Mt().supportPCSetConfiguration){const i=A1.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}},Ae(Di.prototype,"connect",[gc],Object.getOwnPropertyDescriptor(Di.prototype,"connect"),Di.prototype),Ae(Di.prototype,"stopSending",[gc],Object.getOwnPropertyDescriptor(Di.prototype,"stopSending"),Di.prototype),Ae(Di.prototype,"receive",[gc],Object.getOwnPropertyDescriptor(Di.prototype,"receive"),Di.prototype),Ae(Di.prototype,"stopReceiving",[gc],Object.getOwnPropertyDescriptor(Di.prototype,"stopReceiving"),Di.prototype),Ae(Di.prototype,"muteRemote",[gc],Object.getOwnPropertyDescriptor(Di.prototype,"muteRemote"),Di.prototype),Ae(Di.prototype,"unmuteRemote",[gc],Object.getOwnPropertyDescriptor(Di.prototype,"unmuteRemote"),Di.prototype),Ae(Di.prototype,"muteLocal",[gc],Object.getOwnPropertyDescriptor(Di.prototype,"muteLocal"),Di.prototype),Ae(Di.prototype,"unmuteLocal",[gc],Object.getOwnPropertyDescriptor(Di.prototype,"unmuteLocal"),Di.prototype),Ae(Di.prototype,"close",[gc],Object.getOwnPropertyDescriptor(Di.prototype,"close"),Di.prototype),Ae(Di.prototype,"updateEncoderConfig",[gc],Object.getOwnPropertyDescriptor(Di.prototype,"updateEncoderConfig"),Di.prototype),Ae(Di.prototype,"updateSendParameters",[gc],Object.getOwnPropertyDescriptor(Di.prototype,"updateSendParameters"),Di.prototype),Ae(Di.prototype,"replaceTrack",[gc],Object.getOwnPropertyDescriptor(Di.prototype,"replaceTrack"),Di.prototype),Ae(Di.prototype,"getRemoteSSRC",[gc],Object.getOwnPropertyDescriptor(Di.prototype,"getRemoteSSRC"),Di.prototype),Di);function gc(e,t,i){const r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const o=this.mutex,s=await o.lock("Locking from P2PConnection.".concat(t));try{for(var a=arguments.length,c=new Array(a),d=0;d<a;d++)c[d]=arguments[d];return await r.apply(this,c)}finally{s()}},i}const A9={name:"PlanBConnection",create:function(e){let{store:t,spec:i}=e;return new Ec(i,t)}},w9={interceptLocalAudioFrame:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Mt().supportWebRTCEncodedTransform)return void I.warning("browser not support audio encoded transform");if(P_.has(e)||!e.track)return;const i={track:e.track};if(Cr()){if(!e.createEncodedStreams)return void I.warning("browser not support createEncodedStreams() API");let o=null;try{o=e.createEncodedStreams()}catch(a){return void I.error("create audio-encoded-streams error",a&&a.message)}const s=new TransformStream({transform(a,c){i.controller||(i.controller=c),e.track&&e.track.id!==i.track.id&&(I.debug("audio track changed: ".concat(i.track.id," => ").concat(e.track.id)),i.track.removeEventListener("ended",r),i.track=e.track,i.track.addEventListener("ended",r));const d=t.metadata&&t.metadata();d?function(l,h){const{chunk:p,controller:f}=h,m=yl.METADATA;p.data=function(g,S,T){const C=T.byteLength,b=C+Zv+ku,D=ET+gT+b,x=new ArrayBuffer(g.byteLength+D),k=new DataView(x);k.setUint8(0,Qv),k.setUint16(1,b),k.setUint8(3,S),k.setUint16(4,C);for(let W=0;W<C;W++)k.setUint8(6+W,T[W]);const V=new Uint8Array(k.buffer);return V.set(new Uint8Array(g),D),V.buffer}(p.data,m,l),f.enqueue(p)}(d,{chunk:a,controller:c}):c.enqueue(a)}});o.readable.pipeThrough(s).pipeTo(o.writable)}else if(pn()){if(typeof RTCRtpScriptTransform>"u")return void I.warning("browser not support RTCRtpScriptTransform");const o=mT(),s=new MessageChannel;await new Z(c=>o.onmessage=d=>{d.data==="registered"&&c(void 0)});const a=new RTCRtpScriptTransform(o,{name:"audio-metadata-tx",port:s.port2},[s.port2]);e.transform=a,await new Z(c=>o.onmessage=d=>{d.data==="started"&&c(void 0)}),s.port1.onmessage=c=>{var d;if(c.data.transformed&&e.track&&((d=e.track)===null||d===void 0?void 0:d.id)!==i.track.id)I.debug("audio track changed: ".concat(i.track.id," => ").concat(e.track.id)),i.track.removeEventListener("ended",r),i.track=e.track,i.track.addEventListener("ended",r);else if(c.data.getMetadata){const l=t.metadata&&t.metadata();l&&s.port1.postMessage({metadata:l})}},i.worker=o}function r(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",r)}const o=P_.get(e);if(o){P_.delete(e);try{var s,a;(s=o.controller)===null||s===void 0||s.terminate(),(a=o.worker)===null||a===void 0||a.terminate()}catch(c){I.warning(c&&c.message)}}}P_.set(e,i),e.track.addEventListener("ended",r)},interceptRemoteAudioFrame:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Mt().supportWebRTCEncodedTransform)return void I.warning("browser not support audio encoded transform");if(iC.has(e))return;const i={track:e.track,onMetadata:t.onMetadata,onPts:t.onPts};if(Cr()&&!Dr()){if(!e.createEncodedStreams)return void I.warning("browser not support createEncodedStreams() API");Tl(di.CHROME,87,116)||(t.enableTopn=!1);let o=null;try{o=e.createEncodedStreams()}catch(a){return void I.error("create audio-encoded-streams error",a&&a.message)}const s=new TransformStream({transform(a,c){i.controller||(i.controller=c),e.track&&e.track.id!==i.track.id&&(I.debug("audio track changed: ".concat(i.track.id," => ").concat(e.track.id)),i.track.removeEventListener("ended",r),i.track=e.track,i.track.addEventListener("ended",r)),t.enableTopn?function(d,l,h){var p;const f=zf(new DataView(l.data));if(!f)return h.enqueue(l);const m=d.track.id;PP.set(m,d.track);const g=(p=f.tlv.find(x=>x.tag===yl.AUDIO_LEVEL))===null||p===void 0?void 0:p.value;let S=0;typeof g=="number"&&(S=127-g);const T=Math.round(Math.pow(10,S/60)-1),{selected:C,speaker:b}=function(x,k){let V=bs.get(x);if(V||(V=function(W){const K=new BU;return bs.set(W,K),ya||(ya=new Jf(B("TOPN_SILENCE_THRESHOLD")||500),ya.on("ActiveSpeakerChanged",J=>{J!=null&&(ST=J)})),ya.addSpeakers([K]),K}(x)),bs.size<=Uh)return{selected:!0,speaker:V};if(!ya)throw new Error("no active speaker detector");return ya.levelChanged(V.id,k),ps=ya.loudest.map(W=>W.id),ST&&!z(ps).call(ps,ST)&&ps.length>=Uh&&ps.pop(),{selected:z(ps).call(ps,V.id)||V.id===ST,speaker:V}}(d,T),D=function(x,k,V){const W=Ia.get(x)||new tC(x,k);return W.score=V,Ia.set(x,W),function(K){if(eC.set(K,!0),!TT)return void(TT=Date.now());const J=Date.now();J-TT>1e3&&(eC.get(K)?eC.set(K,!1):(RT(K),eC.delete(K)),TT=J)}(x),W}(m,d.track,b.energyScore);D.addSample(C),D.active&&(l.data=f.frame.buffer,h.enqueue(l))}(e,a,c):t.enableMetadata||t.enablePts?function(d,l,h,p){const f=new DataView(d.data),m=f.getUint8(0);let g;if(128&m&&m!==71){const C=function(b){if(b.byteLength<=0)return[];const D=[];let x=0;for(;x<b.byteLength;){const V=(128&b.getUint8(x))>>7,W=127&b.getUint8(x);if(!(V&&x+4<=b.byteLength)){x++;break}{const K=b.getUint32(x,!1),J=(16776192&K)>>10,se=1023&K;D.push({pt:W,ts_offset:J,length:se,data:new Uint8Array}),x+=4}}let k=b.byteLength-x;for(const V of D){if(V.length>k)return console.warn("Broken red payload"),[];V.length>0&&(V.data=new Uint8Array(b.buffer,b.byteOffset+x,V.length),x+=V.length,k-=V.length)}if(k>0){const V={pt:D.length>0?D[D.length-1].pt:0,ts_offset:0,length:k,data:new Uint8Array(b.buffer,b.byteOffset+x,k)};D.push(V)}return D}(f);if(C.length>0){const b=function(D){let x=0;for(let W=0;W<D.length;W++)x+=W<D.length-1?4:1,x+=D[W].length;const k=new Uint8Array(x);let V=0;for(let W=0;W<D.length;W++)if(W<D.length-1){const K=(2147483648|(127&D[W].pt)<<24|(262143&D[W].ts_offset)<<10|1023&D[W].length)>>>0;k[V++]=K>>24&255,k[V++]=K>>16&255,k[V++]=K>>8&255,k[V++]=255&K}else k[V++]=127&D[W].pt;for(const W of D)k.set(W.data,V),V+=W.length;return k}(C.map(D=>{const x=new Uint8Array(D.length);x.set(D.data);const k=zf(new DataView(x.buffer));return k!=null&&k.frame&&(D.data=k==null?void 0:k.frame),g=k,D}));d.data=b.buffer}}else g=zf(f),g&&(d.data=g.frame.buffer);if(l.enqueue(d),!g)return;const S=g.tlv.find(C=>C.tag===yl.METADATA);S&&h&&S.value instanceof Uint8Array&&h(S.value);const T=g.tlv.find(C=>C.tag===yl.AUDIO_64_BIT_PTS);T&&p&&T.value instanceof Uint8Array&&T.value.length==8&&p(new DataView(T.value.buffer).getBigUint64(0,!0))}(a,c,t.onMetadata,t.onPts):c.enqueue(a)}});o.readable.pipeThrough(s).pipeTo(o.writable)}else{if(typeof RTCRtpScriptTransform>"u")return void I.warning("browser not support RTCRtpScriptTransform");const o=mT(),s=new MessageChannel;await new Z(c=>o.onmessage=d=>{d.data==="registered"&&c(void 0)});const a=new RTCRtpScriptTransform(o,{name:"audio-metadata-rx",port:s.port2},[s.port2]);e.transform=a,await new Z(c=>o.onmessage=d=>{d.data==="started"&&c(void 0)}),s.port1.onmessage=c=>{var d;c.data.transformed&&e.track&&((d=e.track)===null||d===void 0?void 0:d.id)!==i.track.id?(I.debug("audio track changed: ".concat(i.track.id," => ").concat(e.track.id)),i.track.removeEventListener("ended",r),i.track=e.track,i.track.addEventListener("ended",r)):c.data.metadata&&i.onMetadata?i.onMetadata(c.data.metadata):c.data.pts&&i.onPts&&i.onPts(c.data.pts)},i.worker=o}function r(){e.track.removeEventListener("ended",r),function(o){const s=iC.get(o);if(s){(function(d){const l=bs.get(d);l&&(bs.delete(d),ya&&(ya.removeSpeakers([l]),bs.size===0&&(ya.destroy(),ya=null)))})(o),RT(o.track.id),iC.delete(o);try{var a,c;(a=s.controller)===null||a===void 0||a.terminate(),(c=s.worker)===null||c===void 0||c.terminate()}catch(d){I.warning(d&&d.message)}}}(e)}iC.set(e,i),e.track.addEventListener("ended",r)},interceptLocalVideoFrame:async function(e,t){if(!Mt().supportWebRTCEncodedTransform)return void I.warning("browser not support video encoded transform");if(xh.has(e)||!e.track)return;const i={track:e.track};if(Cr()){if(!e.createEncodedStreams)return void I.warning("browser not support createEncodedStreams() API");let o=null;try{o=e.createEncodedStreams()}catch(c){return void I.error("create video-encoded-streams error",c&&c.message)}const s=[];t.on("sei-to-send",c=>{s.push(c)});const a=new TransformStream({transform(c,d){i.controller||(i.controller=d),e.track&&e.track.id!==i.track.id&&(I.debug("video track changed: ".concat(i.track.id," => ").concat(e.track.id)),i.track.removeEventListener("ended",r),i.track=e.track,i.track.addEventListener("ended",r));const l=CT(new Uint8Array(c.data)),h=s.shift();if(h){const p=function(f,m,g){switch(g){case vT:return function(S,T){const C=kP(T),b=C.length,D=Math.floor(b/255),x=b%255,k=new Uint8Array(6+D+1+b+S.byteLength);k[0]=0,k[1]=0,k[2]=0,k[3]=1,k[4]=6,k[5]=101;let V=0;for(;V<D;)k[6+V]=255,V++;return k[6+V]=x,V++,k.set(C,6+V),k.set(new Uint8Array(S),6+V+b),k.buffer}(f,m);case rC:return function(S,T){const C=kP(T),b=C.length,D=Math.floor(b/255),x=b%255,k=new Uint8Array(7+D+1+b+1+S.byteLength);k[0]=0,k[1]=0,k[2]=0,k[3]=1,k[4]=78,k[5]=1,k[6]=101;let V=0;for(;V<D;)k[7+V]=255,V++;return k[7+V]=x,V++,k.set(C,7+V),V+=b,k[7+V]=128,V++,k.set(new Uint8Array(S),7+V),k.buffer}(f,m);default:return null}}(c.data,h,l);p&&(c.data=p)}d.enqueue(c)}});o.readable.pipeThrough(a).pipeTo(o.writable)}else{if(!pn())return;{if(typeof RTCRtpScriptTransform>"u")return void I.warning("browser not support RTCRtpScriptTransform");const o=mT(),s=new MessageChannel;await new Z(c=>o.onmessage=d=>{d.data==="registered"&&c(void 0)});const a=new RTCRtpScriptTransform(o,{name:"sei-tx",port:s.port2},[s.port2]);e.transform=a,await new Z(c=>o.onmessage=d=>{d.data==="started"&&c(void 0)}),t.on("sei-to-send",c=>{s.port1.postMessage({sei:c})}),s.port1.onmessage=c=>{var d;c.data.transformed&&e.track&&((d=e.track)===null||d===void 0?void 0:d.id)!==i.track.id&&(I.debug("video track changed: ".concat(i.track.id," => ").concat(e.track.id)),i.track.removeEventListener("ended",r),i.track=e.track,i.track.addEventListener("ended",r))},i.worker=o}}function r(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",r)}const o=xh.get(e);if(o){xh.delete(e);try{var s,a;(s=o.controller)===null||s===void 0||s.terminate(),(a=o.worker)===null||a===void 0||a.terminate()}catch(c){I.warning(c&&c.message)}}}xh.set(e,i),e.track.addEventListener("ended",r)},interceptRemoteVideoFrame:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Mt().supportWebRTCEncodedTransform)return void I.warning("browser not support video encoded transform");if(!e.track)return;if(yT.has(e)){const o=yT.get(e);return void(o&&(o.onSei=t.onSei))}const i={track:e.track,onSei:t.onSei};if(Cr()){if(!e.createEncodedStreams)return void I.warning("browser not support createEncodedStreams() API");let o=null;try{o=e.createEncodedStreams()}catch(a){return void I.error("create video-encoded-streams error",a&&a.message)}const s=new TransformStream({transform(a,c){if(i.controller||(i.controller=c),!i.firstFrameInfo){var d;const h=a.getMetadata()||{};i.firstFrameInfo=Mi({type:a.type,rtpTimestamp:a.timestamp,payloadType:h.payloadType||0,ssrc:h.synchronizationSource||0,length:a.data.byteLength},"mimeType"in h?{mimeType:h.mimeType}:{}),(d=t.onFirstFrame)===null||d===void 0||d.call(t,i.firstFrameInfo)}e.track&&e.track.id!==i.track.id&&(I.debug("video track changed: ".concat(i.track.id," => ").concat(e.track.id)),i.track.removeEventListener("ended",r),i.track=e.track,i.track.addEventListener("ended",r));const l=function(h,p){switch(p){case vT:return function(f){const m=new DataView(f.data);let g=0;for(;g+4<f.data.byteLength;){if(m.getUint8(g+0)===0&&m.getUint8(g+1)===0&&m.getUint8(g+2)===0&&m.getUint8(g+3)===1&&m.getUint8(g+4)===6){let S=g+6,T=0,C=0;for(;(C=m.getUint8(S++))===255;)T+=255;T+=C;const b=LP(f.data,S,T);return new Uint8Array(b)}g++}return null}(h);case rC:return function(f){const m=new DataView(f.data);let g=0;for(;g+5<f.data.byteLength;){if(m.getUint8(g+0)===0&&m.getUint8(g+1)===0&&m.getUint8(g+2)===0&&m.getUint8(g+3)===1&&m.getUint8(g+4)===78&&m.getUint8(g+5)===1&&m.getUint8(g+6)===101){let S=g+7,T=0,C=0;for(;(C=m.getUint8(S++))===255;)T+=255;T+=C;const b=LP(f.data,S,T);return new Uint8Array(b)}g++}return null}(h);default:return null}}(a,CT(new Uint8Array(a.data)));l&&i.onSei&&i.onSei(l),c.enqueue(a)}});o.readable.pipeThrough(s).pipeTo(o.writable)}else if(pn()){if(typeof RTCRtpScriptTransform>"u")return void I.warning("browser not support RTCRtpScriptTransform");const o=mT(),s=new MessageChannel;await new Z(c=>o.onmessage=d=>{d.data==="registered"&&c(void 0)});const a=new RTCRtpScriptTransform(o,{name:"sei-rx",port:s.port2},[s.port2]);e.transform=a,await new Z(c=>o.onmessage=d=>{d.data==="started"&&c(void 0)}),s.port1.onmessage=c=>{var d;if(c.data.transformed&&e.track&&((d=e.track)===null||d===void 0?void 0:d.id)!==i.track.id)I.debug("video track changed: ".concat(i.track.id," => ").concat(e.track.id)),i.track.removeEventListener("ended",r),i.track=e.track,i.track.addEventListener("ended",r);else if(c.data.sei&&i.onSei)i.onSei(c.data.sei);else if(c.data.firstFrameInfo&&t.onFirstFrame){var l;(l=t.onFirstFrame)===null||l===void 0||l.call(t,c.data.firstFrameInfo)}},i.worker=o}function r(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",r)}(function(o){const s=yT.get(o);if(s){yT.delete(o);try{var a,c;(a=s.controller)===null||a===void 0||a.terminate(),(c=s.worker)===null||c===void 0||c.terminate()}catch(d){I.warning(d&&d.message)}}})(e)}yT.set(e,i),e.track.addEventListener("ended",r)}},oi={name:"InterceptFrame",create:()=>w9};var ei;function Jc(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}function ol(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Jc(Object(i),!0).forEach(function(r){M(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Jc(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let Es=(ei=class Ty extends ke{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,i;return(t=(i=this.peerConnection.getReceivers()[0])===null||i===void 0||(i=i.transport)===null||i===void 0?void 0:i.state)!==null&&t!==void 0?t:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var i;return z(i=Object.keys(Ph)).call(i,t)}))]}constructor(t,i,r){super(t,i),M(this,"id",li(5,"connection-")),M(this,"store",void 0),M(this,"peerConnection",void 0),M(this,"forceTurn",!1),M(this,"remoteSDP",void 0),M(this,"initialOffer",void 0),M(this,"transportEventReceiver",void 0),M(this,"statsFilter",void 0),M(this,"extension",{useXR:B("USE_XR")}),M(this,"localCapabilities",void 0),M(this,"remoteCodecs",void 0),M(this,"localCandidateCount",0),M(this,"allCandidatesReceived",!1),M(this,"isPreallocation",!1),M(this,"preMediaMap",new Map),M(this,"dataStreamChannelMap",new Map),M(this,"establishPromise",void 0),M(this,"recoveredDataChannelIds",[]),M(this,"currentDataChannelId",1),M(this,"supportAV1RtpSpec",!1),M(this,"mutex",void 0),M(this,"qualityLimitationReason",Ou.NONE),M(this,"isFirstConnected",!1),this.store=i,this.forceTurn=Qt(t),this.mutex=new jr("NVConnectionExtension-mutex",i.clientId),this.peerConnection=r,this.isFirstConnected=!1,this.statsFilter=nT(this.peerConnection,B("STATS_UPDATE_INTERVAL"),void 0,Ht()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,t.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(t){return this.preMediaMap.get(t)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(t,i){if(this.remoteCodecs=i,!this.remoteSDP)return void I.debug("[NVConnectionExtension] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(i));if(this.remoteSDP.updateRemoteCodec(t,i,this.store.codec)){const r=await this.peerConnection.createOffer(),o=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r);const s=this.remoteSDP.toString();o==null||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}else I.debug("[NVConnectionExtension] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const i=await this.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const r=xc(i.sdp),o=await uC({filterRTX:!B("USE_PUB_RTX")&&!B("USE_SUB_RTX"),filterVideoFec:B("FILTER_VIDEO_FEC"),filterAudioFec:B("FILTER_AUDIO_FEC"),filterVideoCodec:B("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:B("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:B("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=Ol(o),this.initialOffer=i,B("ENABLE_SVC")&&this.store.codec=="av1"){const a=await lC();var t;a&&(this.supportAV1RtpSpec=!0,(t=o.send)===null||t===void 0||t.videoExtensions.push(a))}let s;return i.sdp&&UT(i.sdp)&&(s=wi(o),qP(s)),ol(ol({},r),{},{rtpCapabilities:s||o,offerSDP:i.sdp})}catch(i){throw new oe(O.GET_LOCAL_CONNECTION_PARAMS_FAILED,i.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnectionExtension without initial offer.");this.initialOffer.sdp&&UT(this.initialOffer.sdp)&&NT(t.rtpCapabilities,this.localCapabilities),this.remoteSDP=new _L(ol(ol({},t),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!B("ENABLE_PRE_SUB_WITH_PRE_PC")||!B("PRE_USE_LOCAL_CODECS"))&&Wf(this.store),!0),t.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const i=this.remoteSDP.toString(),r=hC(this.initialOffer.sdp,this.extension),o=this.logSDPExchange(r||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o==null||o(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i});const s=this.peerConnection.getTransceivers()[0];if(s!=null&&s.receiver&&this.tryBindTransportEvents(s.receiver),Wf(this.store))if(t.preallocation&&B("ENABLE_PRE_SUB_WITH_PRE_PC")){const a=B("PRE_SUB_NUM"),{mids:c,preSSRCs:d}=this.remoteSDP.preloadRemoteMedia(a);await Xo(this.peerConnection,this.remoteSDP,this.extension),I.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] preload media, in pre pc,add preload ssrcs ").concat(d)),this.presetMedia(c,d)}else{const{preSSRCs:a=[]}=t,c=a.map(l=>l.ssrcMsg[0].ssrcId);if(a.length===0)return;const{mids:d}=this.remoteSDP.batchSend(a.map(l=>Object.assign({},l)));await Xo(this.peerConnection,this.remoteSDP,this.extension),I.debug("[NVConnectionExtension.connect] preload media, after join, add preload ssrcs ".concat(c)),this.presetMedia(d,c)}}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"NVConnectionExtension.connect failed; ".concat(i.toString()))}}presetMedia(t,i){t.forEach((r,o)=>{this.peerConnection.getTransceivers().forEach(s=>{if(s.mid!=null&&r===s.mid&&s.receiver.track){const a=s.receiver.track;let c;a.kind==="video"&&B("ENABLE_PRE_RENDER")&&(c=new _T({trackId:"track-".concat(a.kind,"-unknown-").concat(this.store.clientId,"_").concat(li(5,""))},!0),c.updateVideoTrack(a),c.onFirstVideoFrameRender=()=>{var d;const l=this.preMediaMap.get(i[o]);l&&(l.firstVideoRender=Date.now()),(d=this.onFirstVideoRender)===null||d===void 0||d.call(this,i[o])},c.onVideoBufferReady=()=>{var d;(d=this.onFirstVideoBufferReady)===null||d===void 0||d.call(this,i[o])},c.play(this.store.sessionId||void 0)),this.preMediaMap.set(i[o],{mid:r,track:a,player:c,transceiver:s})}}),this.store.peerReceiver()})}checkDtlsParameters(t){return!!this.remoteSDP&&t.length>0&&this.remoteSDP.updateRemoteDtlsParameters(t)}async updateRemoteConnect(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateRemoteConnect before remote SDP created");let i=!1;const{rtpCapabilities:r}=t;if([,i]=this.remoteSDP.updateRemoteRTPCapabilities(r),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){const a=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);i=i||a}const{preSSRCs:o=[]}=t,s=o.map(a=>a.ssrcMsg[0].ssrcId);if(!this.remoteSDP.checkPreloadSsrcs(s)){const a=[],c=[];if(Array.from(this.preMediaMap.entries()).every(d=>{let[l,{mid:h,player:p,track:f}]=d;return a.push(h),c.push(l),this.preMediaMap.delete(l),p&&p.destroy(),!0}),a.length>0&&(this.remoteSDP.stopSending(a),await Xo(this.peerConnection,this.remoteSDP,this.extension),I.warn("[NVConnectionExtension.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(c)),H.reportApiInvoke(this.store.sessionId,{name:ct.PRELOAD_MEDIA_FAILED,options:[o,c],tag:bi.TRACER}).onSuccess()),o.length>0){const{mids:d}=this.remoteSDP.batchSend(o.map(l=>Object.assign({},l)));await Xo(this.peerConnection,this.remoteSDP,this.extension),I.debug("[NVConnectionExtension.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(s)),this.presetMedia(d,s)}}i?(await Xo(this.peerConnection,this.remoteSDP,this.extension),I.debug("[NVConnectionExtension] updateRemoteConnect by exchanging SDP.")):I.debug("[NVConnectionExtension] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"NVConnectionExtension.updateRemoteConnect failed; ".concat(i.toString()))}}send(t,i,r){var o=this;return ao(function*(){const s=yield Et(o.mutex.lock("From NVConnectionExtension.send"));try{if(!o.remoteSDP)throw new Error("Cannot call NVConnectionExtension.send before remote SDP created");const a=[],c=om();t.forEach(T=>{const C=o.peerConnection.addTransceiver(T._mediaStreamTrack,ol({direction:"sendonly"},T.trackMediaType==="video"&&o.supportAV1RtpSpec&&c?{sendEncodings:[{scalabilityMode:c}]}:{}));a.push(C),T._updateRtpTransceiver(C)}),Ht()&&B("SIMULCAST")===!0&&(yield Et(o.applySimulcastForFirefox(a,t)));const d=yield Et(o.peerConnection.createOffer()),l=o.remoteSDP.predictReceivingMids(t.length),h=o.mungSendOfferSDP(d.sdp,t,l),p=sn(h),f=l.map(T=>{const C=p.mediaDescriptions.find(b=>b.attributes.mid===T);if(!C)throw new Error("Cannot extract ssrc from mediaDescription.");return aC(C,B("USE_PUB_RTX"))});let m;try{m=yield f}catch(T){m=[],o.remoteSDP.receive(t,i,r,m);const C=o.remoteSDP.toString();throw yield Et(o.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield Et(o.peerConnection.setRemoteDescription({type:"answer",sdp:C})),yield Et(o.stopSending(l,!0)),T}o.remoteSDP.receive(t,i,r,m);const g=o.remoteSDP.toString(),S=o.logSDPExchange(h,"offer","local","send");return yield Et(o.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield Et(o.applySimulcastEncodings(a,t)),yield Et(o.applySendEncodings(a,t)),S==null||S(g),yield Et(o.peerConnection.setRemoteDescription({type:"answer",sdp:g})),a.map((T,C)=>{const b=l[C];return{localSSRC:f[C],id:b,transceiver:T}})}catch(a){throw a instanceof oe?a:new oe(O.EXCHANGE_SDP_FAILED,"NVConnectionExtension.send failed; ".concat(a.toString()))}finally{s()}})()}async createDataChannels(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.createDataChannels before remote SDP created");let r=this.dataStreamChannelMap.get(t);if(r&&r.readyState==="open")I.debug("[NVConnectionExtension] Channels are already available and can be reused directly.");else{const s=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof s!="number")throw new Error("create DataChannel error, because cannot get dc id");r=this.peerConnection.createDataChannel("datastream-channel",{id:s,negotiated:!0,ordered:!1,maxRetransmits:B("DATASTREAM_MAX_RETRANSMITS")}),r.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,r)}i.forEach(s=>{s._updateOriginDataChannel(r)});const{needExchangeSDP:o}=this.remoteSDP.sendDataChannel();if(o){const s=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a),I.debug("[NVConnectionExtension] createDataChannels by exchanging SDP.")}else I.debug("[NVConnectionExtension] createDataChannels no need to exchange SDP.");return}catch(r){throw r instanceof oe?r:new oe(O.EXCHANGE_SDP_FAILED,"NVConnectionExtension.createDataChannels failed; ".concat(r.toString()))}}async stopDataChannels(t){try{const i=this.dataStreamChannelMap.get(t);return i&&(i.id&&this.recoveredDataChannelIds.push(i.id),i.close()),void this.dataStreamChannelMap.delete(t)}catch(i){throw i instanceof oe?i:new oe(O.DATACHANNEL_FAILED,"NVConnectionExtension.stopDataChannels failed; ".concat(i.toString()))}}async stopSending(t,i){const r=i?void 0:await this.mutex.lock("From NVConnectionExtension.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopSending before remote SDP created");const o=this.peerConnection.getTransceivers().filter(d=>t.indexOf(d.mid)!==-1);if(o.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVConnectionExtension.stopSending.");o.map(d=>{var l;Em(this.id+d.mid,this),d.direction="inactive",(l=d.stop)===null||l===void 0||l.call(d)});const s=await this.peerConnection.createOffer(),a=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(t);const c=this.remoteSDP.toString();a==null||a(c),await this.peerConnection.setRemoteDescription({type:"answer",sdp:c})}catch(o){throw new oe(O.EXCHANGE_SDP_FAILED,"NVConnectionExtension.stopSending failed; ".concat(o.toString()))}finally{r&&r()}}async receive(t,i,r,o){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:a}=this.remoteSDP.send(t,i,r,o);a&&(await Xo(this.peerConnection,this.remoteSDP,this.extension),I.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] receive ").concat(t," by exchanging SDP.")));const c=this.peerConnection.getTransceivers().find(d=>d.mid===s);if(!c)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:c.receiver.track,id:s,transceiver:c}}catch(s){throw new oe(O.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(s.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.batchReceive before remoteSDP created.");const{mids:i,needExchangeSDP:r}=this.remoteSDP.batchSend(t);return r&&(await Xo(this.peerConnection,this.remoteSDP,this.extension),I.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] batchReceive by exchanging SDP."))),i.map(o=>{const s=this.peerConnection.getTransceivers().find(a=>a.mid===o);if(!s)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,id:o,transceiver:s}})}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(i.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopReceiving before remote SDP created.");t.forEach(s=>{Array.from(this.preMediaMap.entries()).some(a=>{let[c,{mid:d,player:l}]=a;if(d===s)return this.preMediaMap.delete(c),l&&l.destroy(),!0})}),this.remoteSDP.stopSending(t);const i=this.remoteSDP.toString(),r=this.logSDPExchange(i,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const o=await this.peerConnection.createAnswer();r==null||r(o.sdp||""),await this.peerConnection.setLocalDescription(o)}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"NVConnectionExtension stopReceiving failed; ".concat(i.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const i=this.remoteSDP.toString(),r=this.logSDPExchange(i,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const o=await this.peerConnection.createAnswer();r==null||r(o.sdp||""),await this.peerConnection.setLocalDescription(o)}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteRemote failed; ".concat(i.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const i=this.remoteSDP.toString(),r=this.logSDPExchange(i,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const o=await this.peerConnection.createAnswer();r==null||r(o.sdp||""),await this.peerConnection.setLocalDescription(o)}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteRemote failed; ".concat(i.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(a=>a.mid&&t.indexOf(a.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(a=>{a.direction="inactive"});const r=await this.peerConnection.createOffer(),o=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.muteRemote(t);const s=this.remoteSDP.toString();o==null||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(a=>a.mid&&t.indexOf(a.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(async(a,c)=>{a.direction="sendonly"});const r=await this.peerConnection.createOffer(),o=this.logSDPExchange(r.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.unmuteRemote(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(t,this.remoteCodecs,this.store.codec);const s=this.remoteSDP.toString();o==null||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new oe(O.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteLocal failed; ".concat(i.toString()))}}restartICE(t){var i=this;return ao(function*(){const r=yield Et(i.mutex.lock("From NVConnectionExtension.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const o=Mt().supportPCSetConfiguration,s=B("FORCE_TURN_TCP")||i.forceTurn;if(t===Ir.RELAY&&!o)return;if(o&&!s){const p=t===Ir.RELAY?"relay":"all",f=i.peerConnection.getConfiguration();f.iceTransportPolicy!==p&&(I.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(f.iceTransportPolicy,"] to [").concat(p,"]")),f.iceTransportPolicy=p,i.peerConnection.setConfiguration(f))}i.remoteSDP.updateCandidates(t);const a=yield Et(i.peerConnection.createOffer({iceRestart:!0}));if(!a.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const c=xc(a.sdp),{remoteIceParameters:d}=yield c.iceParameters;i.remoteSDP.restartICE(d);const l=i.remoteSDP.toString(),h=i.logSDPExchange(a.sdp||"","offer","local","restartICE");i.store.descriptionStart(),yield Et(i.peerConnection.setLocalDescription(a)),h==null||h(l),yield Et(i.peerConnection.setRemoteDescription({type:"answer",sdp:l}))}catch(o){I.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),o)}finally{r()}})()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;const t=await this.mutex.lock("From NVConnectionExtension.extendCandidate");try{this.remoteSDP.updateCandidates(Ir.TCP_RELAY),await Xo(this.peerConnection,this.remoteSDP,this.extension)}catch(i){I.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),i)}finally{t()}}close(){var t;this.peerConnection.getTransceivers().forEach(i=>{Em(this.id+i.mid,this)}),this.preMediaMap.forEach(i=>{let{player:r}=i;r&&r.destroy()}),this.preMediaMap.clear(),this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return ol(ol({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateEncoderConfig before remote SDP created.");const r=await this.peerConnection.createOffer(),o=this.mungSendOfferSDP(r.sdp,[i],[t]);this.remoteSDP.updateRecvMedia(t,i);const s=this.remoteSDP.toString(),a=this.logSDPExchange(o,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:o}),a==null||a(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(r){throw new oe(O.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(t,i){const r=this.peerConnection.getTransceivers().filter(o=>o.mid===t);r.length===1&&(this.isVP8Simulcast(i)?Ht()||await this.applySimulcastEncodings(r,[i]):await this.applySendEncodings(r,[i]))}setStatsRemoteVideoIsReady(t,i){this.statsFilter.setVideoIsReady2(t,i)}async replaceTrack(t,i){const r=this.peerConnection.getTransceivers().find(o=>o.mid===i);r&&await r.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const i=t[0].transport.iceTransport,{local:r,remote:o}=i.getSelectedCandidatePair();return{local:ol(ol({},Rs),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port}),remote:ol(ol({},Rs),{},{candidateType:o.type,protocol:o.protocol,address:o.address,port:o.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=t=>{if(t&&(t.errorCode||t.errorText)){var i;const r="code: ".concat(t.errorCode,", message: ").concat(t.errorText),o=t.port?"local: ".concat(t.port):"",s=Hd(t.url||"");I.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: NVConnectionExtension.onICECandidateError(").concat(r,"), url: ").concat(s||"",", host_candidate:").concat(o)),(i=this.onICECandidateError)===null||i===void 0||i.call(this,r)}},this.peerConnection.onicegatheringstatechange=t=>{t&&t.target&&"iceGatheringState"in t.target&&I.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(t.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,I.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,I.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},B("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const i={iceServers:[]},r=t.cloudProxyServer||"disabled";return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&(bh(t.turnServer.servers)?i.iceServers=t.turnServer.servers:B("NEW_TURN_MODE")&&i.iceServers&&r==="disabled"?(B("USE_TURN_SERVER_OF_GATEWAY")?t.turnServer.serversFromGateway&&i.iceServers.push(...Ty.newTurnServerConfigToIceServers(t.turnServer.serversFromGateway)):i.iceServers.push(...Ty.newTurnServerConfigToIceServers(t.turnServer.servers)),B("NEW_FORCE_TURN")&&(i.iceTransportPolicy="relay")):t.turnServer.mode!=="off"&&(i.iceServers&&i.iceServers.push(...Ty.turnServerConfigToIceServers(t.turnServer.servers)),B("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...Ty.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),B("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(o=>{o.forceturn&&(i.iceTransportPolicy="relay")}))),B("ENABLE_ENCODED_TRANSFORM")&&Mt().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),i}static turnServerConfigToIceServers(t){const i=[];return t.forEach(r=>{r.security?r.tcpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ia(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&!B("FORCE_TURN_TCP")&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),i}static newTurnServerConfigToIceServers(t){const i=[];return t.forEach(r=>{const o=B("NEW_TURN_MODE");o===1?i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=udp")}):o===2?i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=tcp")}):o===3?i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ia(r.turnServerURL),":443?transport=tcp")}):o===4&&(i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=udp")}),i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=tcp")}),i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ia(r.turnServerURL),":443?transport=tcp")}))}),i}tryBindTransportEvents(t){const i=t.transport;if(i){this.transportEventReceiver=t,i.onstatechange=()=>{var o;i!=null&&i.state&&((o=this.onDTLSTransportStateChange)===null||o===void 0||o.call(this,i.state))},i.onerror=o=>{var s;(s=this.onDTLSTransportError)===null||s===void 0||s.call(this,"error"in o?o.error:o)};const r=i.iceTransport;r&&(r.onstatechange=()=>{const o=i==null?void 0:i.iceTransport.state;var s;o&&((s=this.onICETransportStateChange)===null||s===void 0||s.call(this,o))},r.getSelectedCandidatePair&&(r.onselectedcandidatepairchange=()=>{if(r.getSelectedCandidatePair()){const{local:o,remote:s}=r.getSelectedCandidatePair()||{};if(o&&s){const a=o.address+":"+o.port,c=s.address+":"+s.port;I.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(Hd(a)),", remote ").concat(JSON.stringify(Hd(c))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,i){var r,o;if(i||(i=this.peerConnection.getSenders().find(T=>T.track===t._mediaStreamTrack)),!i)return I.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return I.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Mt().supportSetRtpSenderParameters)return I.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},a={};switch(t._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;case"balanced":s.degradationPreference="balanced"}const c=nm(this.peerConnection,t._mediaStreamTrack),d=nD(t);if(GT(t)&&c&&i&&d&&this.getLocalVideoStats&&z(r=["vp8","vp9"]).call(r,this.store.codec)){var l;const S=s.degradationPreference||(z(l=t._hints).call(l,ui.CUSTOM_TRACK)?B("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");V_(this.id+c.mid,d,this,S,T=>{i&&this.updateAdaptation(i,T)},this.getLocalVideoStats.bind(this))}if(t._encoderConfig){var h;const{bitrateMax:S,frameRate:T,scaleResolutionDownBy:C}=t._encoderConfig;S&&(a.maxBitrate=1e3*S),(z(h=t._hints).call(h,ui.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(T&&(a.maxFramerate=qo(T)),C&&C>=1&&(a.scaleResolutionDownBy=C))}const{maxFramerate:p}=B("ENCODER_CONFIG_LIMIT");if(p&&typeof p=="number"&&(a.maxFramerate=a.maxFramerate?Math.min(a.maxFramerate,p):p),B("DSCP_TYPE")&&ha()){var f;const S=B("DSCP_TYPE");z(f=["very-low","low","medium","high"]).call(f,S)&&(a.networkPriority=S)}const m=i.getParameters(),g=(o=m.encodings)===null||o===void 0?void 0:o[0];Ht()&&!g&&(s.encodings=[a]),g&&Object.assign(g,a),Object.assign(m,s),I.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(m.encodings))),await i.setParameters(m),await MT(this.store.codec,i,B("SVC_MODE"))}async updateAdaptation(t,i){var r,o;if(!t)return I.debug("[updateAdaptation] no rtpSender found");if(!Mt().supportSetRtpSenderParameters)return I.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const s={},{bitrateMax:a,frameRate:c,scaleResolutionDownBy:d}=i;a&&(s.maxBitrate=1e3*a),c&&(s.maxFramerate=qo(c)),d&&d>=1&&z(r=["vp8","vp9"]).call(r,this.store.codec)&&(s.scaleResolutionDownBy=d);const l=t.getParameters(),h=(o=l.encodings)===null||o===void 0?void 0:o[0];h&&Object.assign(h,s),Object.assign(l,{});try{await t.setParameters(l),I.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(l.encodings)))}catch(p){!("transport"in t)||t.transport&&t.transport.state==="connected"?this.peerConnectionState!=="connected"?I.debug("[updateAdaptation] peerConnection not connected}"):I.debug("[updateAdaptation] updateRtpSenderEncodings failed",p):I.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(t,i){try{if(!Mt().supportSetRtpSenderParameters||t.length!==i.length)return;for(let r=0;r<t.length;r++){const o=t[r],s=i[r];s instanceof yi&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,o.sender)}}catch{I.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,i,r){const o=sn(t);return i.forEach((s,a)=>{const c=r[a],d=o.mediaDescriptions.find(l=>l.attributes.mid===c);d&&(Fu(d,s),dC(d,s,this.store.codec))}),Du(o)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,i,r)=>{var o;(o=this.onFirstVideoDecoded)===null||o===void 0||o.call(this,t,i,r)},this.statsFilter.onSelectedLocalCandidateChanged=(t,i)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,t,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,i)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,t,i)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,i){if(t.length===i.length)for(let d=0;d<t.length;d++){var r,o,s,a,c;const l=t[d],h=i[d];if(h instanceof yi&&!z(r=h._hints).call(r,ui.LOW_STREAM)&&(o=h._encoderConfig)!==null&&o!==void 0&&o.bitrateMax&&((s=h._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(a=h._scalabilityMode)!==null&&a!==void 0&&a.numSpatialLayers&&((c=h._scalabilityMode)===null||c===void 0?void 0:c.numSpatialLayers)>1&&this.store.codec==="vp8"){const p={},f={high:1e3*(h._encoderConfig.bitrateMax-50),medium:5e4};p.encodings=[{rid:"m",active:!0,maxBitrate:f.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:f.high}];const m=l.sender.getParameters();await l.sender.setParameters(Object.assign(m,p))}}}async applySimulcastEncodings(t,i){if(!Ht()&&t.length===i.length)for(let r=0;r<t.length;r++){const o=i[r];if(o instanceof yi&&this.isVP8Simulcast(o)){const s=t[r],a={},c={high:1e3*(o._encoderConfig.bitrateMax-50),medium:5e4};a.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:c.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:c.medium,scaleResolutionDownBy:4}];const d=s.sender.getParameters();await s.sender.setParameters(Object.assign(d,a))}}}isVP8Simulcast(t){var i,r,o,s,a;return!!(t instanceof yi&&B("SIMULCAST")&&this.store.codec==="vp8"&&!z(i=t._hints).call(i,ui.LOW_STREAM)&&(r=t._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=t._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=t._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=t._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1)}logSDPExchange(t,i,r,o){if(B("SDP_LOGGING"))return I.upload("[".concat(this.store.clientId,"] exchanging ").concat(r," ").concat(i," SDP during NVConnectionExtension.").concat(o,`
`),t),i==="offer"?s=>{this.logSDPExchange(s,"answer",r==="local"?"remote":"local",o)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const i=this.remoteSDP.getSSRC(t);return i&&i.length!==0?i[0].ssrcId:void 0}setConfiguration(t){if(Mt().supportPCSetConfiguration){const i=Ty.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}t.isPreallocation&&(this.isPreallocation=!0)}},Ae(ei.prototype,"updateRemoteRTPCapabilities",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"updateRemoteRTPCapabilities"),ei.prototype),Ae(ei.prototype,"connect",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"connect"),ei.prototype),Ae(ei.prototype,"updateRemoteConnect",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"updateRemoteConnect"),ei.prototype),Ae(ei.prototype,"createDataChannels",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"createDataChannels"),ei.prototype),Ae(ei.prototype,"receive",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"receive"),ei.prototype),Ae(ei.prototype,"batchReceive",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"batchReceive"),ei.prototype),Ae(ei.prototype,"stopReceiving",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"stopReceiving"),ei.prototype),Ae(ei.prototype,"muteRemote",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"muteRemote"),ei.prototype),Ae(ei.prototype,"unmuteRemote",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"unmuteRemote"),ei.prototype),Ae(ei.prototype,"muteLocal",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"muteLocal"),ei.prototype),Ae(ei.prototype,"unmuteLocal",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"unmuteLocal"),ei.prototype),Ae(ei.prototype,"close",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"close"),ei.prototype),Ae(ei.prototype,"updateEncoderConfig",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"updateEncoderConfig"),ei.prototype),Ae(ei.prototype,"updateSendParameters",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"updateSendParameters"),ei.prototype),Ae(ei.prototype,"replaceTrack",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"replaceTrack"),ei.prototype),Ae(ei.prototype,"updateAdaptation",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"updateAdaptation"),ei.prototype),Ae(ei.prototype,"getRemoteSSRC",[Bt],Object.getOwnPropertyDescriptor(ei.prototype,"getRemoteSSRC"),ei.prototype),ei);function Bt(e,t,i){const r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const o=this.mutex,s=await o.lock("From NVConnectionExtension.".concat(t));try{for(var a=arguments.length,c=new Array(a),d=0;d<a;d++)c[d]=arguments[d];return await r.apply(this,c)}finally{s()}},i}var Ii;function AR(e){var t,i,r,o=2;for(typeof Symbol<"u"&&(i=wf,r=Symbol.iterator);o--;){if(i&&(t=e[i])!=null)return t.call(e);if(r&&(t=e[r])!=null)return new Ey(t.call(e));i="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function Ey(e){function t(i){if(Object(i)!==i)return Z.reject(new TypeError(i+" is not an object."));var r=i.done;return Z.resolve(i.value).then(function(o){return{value:o,done:r}})}return Ey=function(i){this.s=i,this.n=i.next},Ey.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(i){var r=this.s.return;return r===void 0?Z.resolve({value:i,done:!0}):t(r.apply(this.s,arguments))},throw:function(i){var r=this.s.return;return r===void 0?Z.reject(i):t(r.apply(this.s,arguments))}},new Ey(e)}let Da=(Ii=class Fx extends ke{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(t,i){super(t,i),M(this,"name","DataChannelConnection"),M(this,"store",void 0),M(this,"peerConnection",void 0),M(this,"cname",void 0),M(this,"mutex",new jr("DataChannelConnection-mutex")),M(this,"dataChannel",void 0),M(this,"_p2pConnection",void 0),M(this,"establishPromise",void 0),M(this,"_nvMedia",void 0),this.store=i,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(Fx.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new Es(t,i,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}getPreMedia(t){var i;return(i=this._p2pConnection)===null||i===void 0?void 0:i.getPreMedia(t)}isPreSub(){var t,i;return(t=(i=this._p2pConnection)===null||i===void 0?void 0:i.isPreSub())!==null&&t!==void 0&&t}async establish(){return await this._p2pConnection.establish()}getP2PConnectionParams(){return this._p2pConnection.establishPromise}updateRtpSenderEncodings(t){return this._p2pConnection.updateRtpSenderEncodings(t)}async connect(t){return this.cname=t.cname,await this._p2pConnection.connect(t),await new Z((i,r)=>{const o=setTimeout(()=>{this.closeSignal(),r(new $(O.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(t.candidates))))},B("DC_CONNECTION_TIMEOUT"));this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(o),void i()},this.dataChannel.onerror=s=>{this.closeSignal(),r(s)},this.dataChannel.addEventListener("close",()=>{r(new $(O.DATACHANNEL_CONNECTION_TIMEOUT))})}),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(t,i){return this._p2pConnection.updateRemoteRTPCapabilities(t,i)}send(t,i,r){var o=this;return ao(function*(){const s=yield Et(o.mutex.lock("From DataChannelConnection.send"));try{return yield*vu(AR(o._p2pConnection.send(t,i,r)))}finally{s()}})()}async stopSending(t,i){return this._p2pConnection.stopSending(t,i)}async createDataChannels(t,i){return this._p2pConnection.createDataChannels(t,i)}async stopDataChannels(t){return this._p2pConnection.stopDataChannels(t)}async receive(t,i,r,o){return this._nvMedia?(I.debug("[DataChannelConnection] receive ".concat(t," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(t,i,this.cname)):(I.debug("[DataChannelConnection] receive ".concat(t," by WebRTC.")),await this._p2pConnection.receive(t,i,r,o))}async batchReceive(t){return[...await this._p2pConnection.batchReceive(t)]}async stopReceiving(t){return await this._p2pConnection.stopReceiving(t)}async muteRemote(t){return await this._p2pConnection.muteRemote(t)}async unmuteRemote(t){return await this._p2pConnection.unmuteRemote(t)}async muteLocal(t){return await this._p2pConnection.muteLocal(t)}async unmuteLocal(t){return await this._p2pConnection.unmuteLocal(t)}restartICE(t){var i=this;return ao(function*(){return yield*vu(AR(i._p2pConnection.restartICE(t)))})()}close(){var t;(t=this._nvMedia)===null||t===void 0||t.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(t){return this._p2pConnection.getRemoteVideoIsReady(t)}updateRemoteConnect(t){var i;return(i=this._nvMedia)===null||i===void 0||i.setRemoteRtpCapabilities(t),this._p2pConnection.updateRemoteConnect(t)}async updateEncoderConfig(t,i){return await this._p2pConnection.updateEncoderConfig(t,i)}async updateSendParameters(t,i){return await this._p2pConnection.updateSendParameters(t,i)}setStatsRemoteVideoIsReady(t,i){this._p2pConnection.setStatsRemoteVideoIsReady(t,i)}async replaceTrack(t,i){return await this._p2pConnection.replaceTrack(t,i)}async getRemoteSSRC(t){return this._p2pConnection.getRemoteSSRC(t)}logSDPExchange(t,i,r,o){if(B("SDP_LOGGING"))return I.upload("exchanging ".concat(r," ").concat(i," SDP during DataChannelConnection.").concat(o,`
`),t),i==="offer"?s=>{this.logSDPExchange(s,"answer",r==="local"?"remote":"local",o)}:void 0}static resolvePCConfiguration(t){const i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(bh(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...Fx.turnServerConfigToIceServers(t.turnServer.servers)),B("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...Fx.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),B("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(i.iceTransportPolicy="relay")}))),B("ENABLE_ENCODED_TRANSFORM")&&Mt().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),i}static turnServerConfigToIceServers(t){const i=[];return t.forEach(r=>{r.security?r.tcpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ia(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&!B("FORCE_TURN_TCP")&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),i}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=t=>{var i;return(i=this.onICEConnectionStateChange)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onConnectionStateChange=t=>{var i;return(i=this.onConnectionStateChange)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onDTLSTransportStateChange=t=>{var i;return(i=this.onDTLSTransportStateChange)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onDTLSTransportError=t=>{var i;return(i=this.onDTLSTransportError)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onICETransportStateChange=t=>{var i;return(i=this.onICETransportStateChange)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onFirstAudioReceived=t=>{var i;return(i=this.onFirstAudioReceived)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onFirstVideoReceived=t=>{var i;return(i=this.onFirstVideoReceived)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onFirstAudioDecoded=t=>{var i;return(i=this.onFirstAudioDecoded)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onFirstVideoRender=t=>{var i;return(i=this.onFirstVideoRender)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onFirstVideoBufferReady=t=>{var i;return(i=this.onFirstVideoBufferReady)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onFirstVideoDecoded=(t,i,r)=>{var o;return(o=this.onFirstVideoDecoded)===null||o===void 0?void 0:o.call(this,t,i,r)},this._p2pConnection.onFirstVideoDecodedTimeout=t=>{var i;return(i=this.onFirstVideoDecodedTimeout)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onSelectedLocalCandidateChanged=(t,i)=>{var r;return(r=this.onSelectedLocalCandidateChanged)===null||r===void 0?void 0:r.call(this,t,i)},this._p2pConnection.onSelectedRemoteCandidateChanged=(t,i)=>{var r;return(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0?void 0:r.call(this,t,i)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}setConfiguration(t){this._p2pConnection.setConfiguration(t)}},Ae(Ii.prototype,"connect",[aa],Object.getOwnPropertyDescriptor(Ii.prototype,"connect"),Ii.prototype),Ae(Ii.prototype,"updateRemoteRTPCapabilities",[aa],Object.getOwnPropertyDescriptor(Ii.prototype,"updateRemoteRTPCapabilities"),Ii.prototype),Ae(Ii.prototype,"createDataChannels",[aa],Object.getOwnPropertyDescriptor(Ii.prototype,"createDataChannels"),Ii.prototype),Ae(Ii.prototype,"receive",[aa],Object.getOwnPropertyDescriptor(Ii.prototype,"receive"),Ii.prototype),Ae(Ii.prototype,"stopReceiving",[aa],Object.getOwnPropertyDescriptor(Ii.prototype,"stopReceiving"),Ii.prototype),Ae(Ii.prototype,"muteRemote",[aa],Object.getOwnPropertyDescriptor(Ii.prototype,"muteRemote"),Ii.prototype),Ae(Ii.prototype,"unmuteRemote",[aa],Object.getOwnPropertyDescriptor(Ii.prototype,"unmuteRemote"),Ii.prototype),Ae(Ii.prototype,"muteLocal",[aa],Object.getOwnPropertyDescriptor(Ii.prototype,"muteLocal"),Ii.prototype),Ae(Ii.prototype,"unmuteLocal",[aa],Object.getOwnPropertyDescriptor(Ii.prototype,"unmuteLocal"),Ii.prototype),Ae(Ii.prototype,"close",[aa],Object.getOwnPropertyDescriptor(Ii.prototype,"close"),Ii.prototype),Ae(Ii.prototype,"updateEncoderConfig",[aa],Object.getOwnPropertyDescriptor(Ii.prototype,"updateEncoderConfig"),Ii.prototype),Ae(Ii.prototype,"updateSendParameters",[aa],Object.getOwnPropertyDescriptor(Ii.prototype,"updateSendParameters"),Ii.prototype),Ae(Ii.prototype,"replaceTrack",[aa],Object.getOwnPropertyDescriptor(Ii.prototype,"replaceTrack"),Ii.prototype),Ae(Ii.prototype,"getRemoteSSRC",[aa],Object.getOwnPropertyDescriptor(Ii.prototype,"getRemoteSSRC"),Ii.prototype),Ii);function aa(e,t,i){const r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const o=this.mutex,s=await o.lock("From DataChannelConnection.".concat(t));try{for(var a=arguments.length,c=new Array(a),d=0;d<a;d++)c[d]=arguments[d];return await r.apply(this,c)}finally{s()}},i}function ox(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),i.push.apply(i,r)}return i}class sl extends Vi{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var i;z(i=["tryNext","recover"]).call(i,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit($i.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit($i.CONNECTED):this._state==="closed"?this.emit($i.CLOSED):this._state==="failed"&&this.emit($i.FAILED))}constructor(t,i,r,o){super(),M(this,"connectionID",0),M(this,"currentURLIndex",0),M(this,"reconnectReason",void 0),M(this,"_reconnectMode","tryNext"),M(this,"_initMutex",void 0),M(this,"_name",void 0),M(this,"_state","closed"),M(this,"_reconnectInterrupter",void 0),M(this,"_url",void 0),M(this,"_retryConfig",void 0),M(this,"_reconnectCount",0),M(this,"_forceCloseTimeout",5e3),M(this,"_onlineReconnectListener",void 0),M(this,"_closeEstablishingTransmitter",()=>{}),M(this,"_store",void 0),M(this,"_joinChannelServiceRecordIndex",void 0),M(this,"_transmitter",void 0),M(this,"_useCompress",void 0),M(this,"_inflateLength",0),M(this,"_deflateLength",0),this._store=o,this._name=t,this._retryConfig=function(s){for(var a=1;a<arguments.length;a++){var c=arguments[a]!=null?arguments[a]:{};a%2?ox(Object(c),!0).forEach(function(d){M(s,d,c[d])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(c)):ox(Object(c)).forEach(function(d){Object.defineProperty(s,d,Object.getOwnPropertyDescriptor(c,d))})}return s}({},i),this._useCompress=r}resetReconnectCount(t){I.debug("".concat(this._name," reset reconnect count, reason: ").concat(t)),this._reconnectCount=0}close(t,i){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const r=this._transmitter;i?setTimeout(()=>r.close(),500):r.close(),this._transmitter=void 0}this.state=t?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(t,i){if(!this._transmitter)return void I.warning("[".concat(this._name,"] can not reconnect, no websocket"));var r;t!==void 0&&(this.reconnectMode=t),I.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((r=this._store)===null||r===void 0||r.recordJoinChannelService({status:"error",errors:[new Error(i)]},this._joinChannelServiceRecordIndex));const o=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),o&&o.bind(this._transmitter)({code:9999,reason:i})}getInflateData(){const t=this._inflateLength,i=this._deflateLength;return this.clearInflateData(),{inflateLength:t,deflateLength:i}}setInflateData(t){this._deflateLength=this._deflateLength+t.originLength,this._inflateLength=this._inflateLength+t.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}let al=function(e){return e[e.Default=0]="Default",e[e.Ack=1]="Ack",e}({});class sx{constructor(t,i,r){M(this,"version",1),M(this,"initialRTO",void 0),M(this,"maxBatchAckCount",void 0),M(this,"maxRTO",void 0),M(this,"initialRTT",void 0),M(this,"ID",void 0),M(this,"rtt",void 0),M(this,"packetNumber",1),M(this,"rtoRatioMap",new Map),M(this,"timeoutMap",new Map),M(this,"unorderedPacketQueue",[]),M(this,"batchAckPacketQueue",[]),M(this,"lastOrderedPacketNumber",0),M(this,"batchAckTimer",void 0),M(this,"sendImpl",void 0),M(this,"receiveImpl",void 0),this.sendImpl=t,this.receiveImpl=i,this.ID=li(7,"transmitter-"),this.initialRTO=(r==null?void 0:r.initialRTO)!==void 0?r.initialRTO:B("TRANSMITTER_INITIAL_RTO"),this.initialRTT=(r==null?void 0:r.initialRTT)!==void 0?r.initialRTT:B("TRANSMITTER_INITIAL_RTT"),this.rtt=(r==null?void 0:r.initialRTT)!==void 0?r.initialRTT:B("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=(r==null?void 0:r.maxBatchAckCount)!==void 0?r.maxBatchAckCount:B("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=(r==null?void 0:r.maxRTO)!==void 0?r.maxRTO:B("TRANSMITTER_MAX_RTO")}packetize(t,i){return{type:al.Default,version:this.version,packetNumber:i,payload:t}}serialize(t){switch(t.type){case al.Default:{let i;typeof t.payload=="string"?i=new TextEncoder().encode(t.payload):i=t.payload;const r=new ArrayBuffer(i.length+15),o=new DataView(r);return o.setUint16(0,t.version),o.setUint8(2,t.type),o.setUint32(3,t.packetNumber),Nf(o,7,BigInt(t.sendTs)),new Uint8Array(o.buffer).set(i,15),r}case al.Ack:{const i=new ArrayBuffer(16),r=new DataView(i);return r.setUint16(0,t.version),r.setUint8(2,t.type),r.setUint32(3,t.maxAckPacketNumber),r.setUint8(7,t.shift),Nf(r,8,BigInt(t.ackSendTs)),i}}}deserialize(t){const i=new DataView(t),r=i.getUint16(0),o=i.getUint8(2);switch(o){case al.Default:{const s=i.getUint32(3),a=PN(i,7),c=t.slice(15),d=new Uint8Array(c);return{version:r,type:o,packetNumber:s,sendTs:Number(a),payload:d}}case al.Ack:{const s=i.getUint32(3),a=i.getUint8(7),c=PN(i,8);return{version:r,type:o,maxAckPacketNumber:s,shift:a,ackSendTs:Number(c)}}default:throw I.error("[".concat(this.ID,"] Unrecognized packet type ").concat(o)),new Error("Unrecognized packet type ".concat(o))}}sendMessage(t){B("DC_DEBUG_LOG")&&typeof t=="string"&&I.debug("[".concat(this.ID,"] sending message packet"),JSON.parse(t));const i=this.packetize(t,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;const r=this.calculateRTO(i),o=window.setTimeout(()=>{this.resendMessage(i)},r);this.timeoutMap.set(i.packetNumber,o),this.sendPacket(i)}onData(t){const i=this.deserialize(t);i.type===al.Default?this.ack(i):i.type===al.Ack&&(this.updateRTT(i,Math.round(performance.now())),this.clearRTO(i))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach(t=>{let[i,r]=t;window.clearTimeout(r)}),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(t){const i=this.calculateRTO(t),r=window.setTimeout(()=>{B("DC_DEBUG_LOG")&&typeof t.payload=="string"&&I.debug("[".concat(this.ID,"] resending message packet"),JSON.parse(t.payload),"timeout: ".concat(i)),this.resendMessage(t)},i);this.timeoutMap.set(t.packetNumber,r),this.sendPacket(t)}calculateRTO(t){const i=this.rtoRatioMap.get(t.packetNumber);if(i===void 0)return this.rtoRatioMap.set(t.packetNumber,1),this.initialRTO;{const r=9*this.rtt/8*i;return this.rtoRatioMap.set(t.packetNumber,i+1),r>this.maxRTO?this.maxRTO:r}}updateRTT(t,i){const r=t.ackSendTs;this.rtt=this.rtt*(7/8)+(i-r-this.rtt)/8}ack(t){if(t.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(t):(this.batchAckPacketQueue.push(t),this.batchAckTimer=window.setTimeout(()=>{this.batchAck()},this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(t.payload);;){const i=this.unorderedPacketQueue[0];if(!i){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(i.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(t.packetNumber<=this.lastOrderedPacketNumber){const i={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:al.Ack,version:this.version};B("DC_DEBUG_LOG")&&I.debug("[".concat(this.ID,"] sending ack packet"),i,"packetNumber: ".concat(t.packetNumber)),this.sendPacket(i)}else if(t.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[t.packetNumber-this.lastOrderedPacketNumber-2]=t;const i={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:al.Ack,version:this.version};B("DC_DEBUG_LOG")&&I.debug("[".concat(this.ID,"] sending ack packet"),i,"packetNumber: ".concat(t.packetNumber)),this.sendPacket(i)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const t={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:al.Ack,version:this.version};B("DC_DEBUG_LOG")&&I.debug("[".concat(this.ID,"] sending batch ack packet"),t,"shift: ".concat(this.batchAckPacketQueue.length-1)),this.sendPacket(t),this.batchAckPacketQueue=[]}sendPacket(t){t.type===al.Default&&(t.sendTs=Math.round(performance.now()));const i=this.serialize(t);this.sendImpl(i)}clearRTO(t){for(let i=t.maxAckPacketNumber-t.shift;i<=t.maxAckPacketNumber;i++){const r=this.timeoutMap.get(i);r!==void 0&&window.clearTimeout(r),this.timeoutMap.delete(i),this.rtoRatioMap.delete(i)}}}class ax extends sl{constructor(t,i){super(t,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),M(this,"_initMutex",void 0),M(this,"_reconnectInterrupter",void 0),M(this,"_url",void 0),M(this,"_transmitter",void 0),M(this,"_addresses",void 0),M(this,"_reliableTransmission",void 0),M(this,"_textEncoder",void 0),M(this,"_textDecoder",void 0),this._textEncoder=new TextEncoder,this._textDecoder=new TextDecoder,this._initMutex=new jr("datachannel");const{timeout:r,timeoutFactor:o}=i,s=Math.max(300,Math.floor(3*r/5)),a=Math.max(1.2,Math.floor(8*o)/10);yn.ONLINE&&(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=a),fi.on(fr.NETWORK_STATE_CHANGE,(c,d)=>{c!==d&&(this.resetReconnectCount("network state change: ".concat(d," -> ").concat(c)),c===yn.ONLINE?(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=a):(this._retryConfig.timeout=r,this._retryConfig.timeoutFactor=o))})}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=i;const r=(o,s)=>{this._addresses=t,this.currentURLIndex=this._addresses.findIndex(c=>c.fingerprint||B("FINGERPRINT"));const a=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(a).then(o).catch(s),this.once($i.CLOSED,()=>s(new $(O.WS_DISCONNECT))),this.once($i.CONNECTED,()=>o())};return this._initMutex.lock().then(o=>new Z((s,a)=>{r(s,a)}).then(()=>{o()}).catch(()=>{o()}))}async sendMessage(t){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new $(O.WS_ABORT,"datachannel is not ready");try{i||(t=JSON.stringify(t));const r=this._textEncoder.encode(t),o=a9(r,{raw:!0});this._reliableTransmission.sendMessage(o)}catch(r){throw new $(O.WS_ERR,"send datachannel signal message error"+r.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(t){const i=JSON.stringify(t);return{compressed:i,compressedLength:i.length,origin:t}}sendMessageWithUint8Array(t){return{compressed:t,compressedLength:t.byteLength,origin:t}}createTransmitterConnection(t){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(t.ip,":").concat(t.port),new Z((i,r)=>{var o;const s=()=>{I.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="recover",this.state="connected",this.resetReconnectCount("opened"),i()},a=async h=>{var p;if((p=this._closeEstablishingTransmitter)===null||p===void 0||p.call(this),I.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(h.code,", reason: ").concat(h.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=h.reason,this.state="reconnecting");const f=co(this,$i.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,m=await this.reconnectWithAction(f);if(this.state==="closed")return void I.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!m)return r(new $(O.WS_DISCONNECT,"datachannel reconnect failed: ".concat(h.code))),void this.close(!0);i()}else r(new $(O.WS_DISCONNECT,"datachannel close: ".concat(h.code))),this.close()},c=async h=>{try{var p;(p=this._reliableTransmission)===null||p===void 0||p.onData(h.data)}catch(f){console.log(f)}};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),I.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(t)));const d=(o=this._store)===null||o===void 0?void 0:o.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),l=Date.now();yt(this,$i.TO_CONNECT_DATACHANNEL).then(h=>{var p,f;if(!h)throw new Error("transmissonInfo not exist yet");const{transmitter:m,close:g}=h;this._transmitter=m,(p=this._store)===null||p===void 0||p.signalChannelOpen();const S=Date.now()-l;I.debug("[choose dc] dc open cost ".concat(S,"ms")),this._reliableTransmission=new sx(T=>{var C;this._transmitter&&this._transmitter.readyState==="open"&&((C=this._transmitter)===null||C===void 0||C.send(T))},T=>{if(typeof T=="string")this.emit($i.ON_MESSAGE,T);else{const C=j2(T,{raw:!0}).buffer,b=this._textDecoder.decode(C);this.emit($i.ON_MESSAGE,b)}}),this._closeEstablishingTransmitter=()=>{var T;(T=this._reliableTransmission)===null||T===void 0||T.close(),this._reliableTransmission=void 0,g()},s&&s(),m.onclose=a,m.onmessage=c,(f=this._store)===null||f===void 0||f.recordJoinChannelService({endTs:Date.now(),status:"success"},d),this._joinChannelServiceRecordIndex=d}).catch(h=>{var p;if((p=this._store)===null||p===void 0||p.recordJoinChannelService({endTs:Date.now(),status:h instanceof $&&h.code===O.WS_ABORT?"aborted":"error",errors:[h]},d),this.state!=="closed"){if(h instanceof $&&h.code===O.WS_ERR){const f=new $(O.WS_ERR,"init datachannel failed! Error: ".concat(h.toString()));return I.error("[".concat(this._name,"]").concat(f)),void r(f)}a&&a(h)}else r(new $(O.WS_DISCONNECT,"datachannel is closed: ".concat(h.toString())))})})}async reconnectWithAction(t){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||fi.networkState!==yn.OFFLINE||(this._onlineReconnectListener=fi.onlineWaiter&&fi.onlineWaiter.then(()=>{this._onlineReconnectListener=void 0}));let r=!0;if(this._reconnectInterrupter=()=>{r=!1},i){const c=fa(this._reconnectCount,this._retryConfig);I.debug("[".concat(this._name,"] wait ").concat(c,"ms to reconnect datachannel, mode: ").concat(t)),await Z.race([vt(c),this._onlineReconnectListener||new Z(()=>{})])}if(this.state==="closed"||!r)return!1;this._reconnectCount+=1;const o=async(c,d)=>{this.emit($i.RECONNECT_CREATE_CONNECTION,d),await this.createTransmitterConnection(c)};try{if(t==="retry"){const c=this._addresses[this.currentURLIndex];await o(c,t)}else if(t==="tryNext"){this.currentURLIndex+=1;for(let d=this.currentURLIndex;d<this._addresses.length;d++){if(this._addresses[d].fingerprint||B("FINGERPRINT")){this.currentURLIndex=d;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return I.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);I.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const c=this._addresses[this.currentURLIndex];await o(c,t)}else t==="recover"&&(I.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit($i.FAILBACK));return!0}catch(c){var s,a;return I.error("[".concat(this._name,"] reconnect failed"),c.toString()),c!=null&&(s=c.data)!==null&&s!==void 0&&s.desc&&Array.isArray(c.data.desc)&&c.data.desc.length&&z(a=c.data.desc).call(a,"dynamic key expired")?(this.emit($i.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(t,i)}}}class b9 extends Vi{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===Ee.CONNECTED?this.emit(le.WS_CONNECTED):t===Ee.RECONNECTING?this.emit(le.WS_RECONNECTING,this._websocketReconnectReason):t===Ee.CLOSED&&this.emit(le.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}processPendingNotifications(){this.pendingNotifications.length!==0&&(I.debug("[".concat(this.clientId,"] processing ").concat(this.pendingNotifications.length," pending notifications")),this.pendingNotifications.forEach(t=>{let{type:i,message:r}=t;this.emit(i,r),i===Ke.ON_NOTIFICATION&&this.handleNotification(r),i===Ke.ON_USER_BANNED&&this.handleUserBanned(r)}),this.pendingNotifications=[])}handleUserBanned(t){switch(t.error_code){case 14:this.close(bt.UID_BANNED);break;case 15:this.close(bt.IP_BANNED);break;case 16:this.close(bt.CHANNEL_BANNED)}}constructor(t,i){super(),M(this,"__name__","DataChannelSignal"),M(this,"_disconnectedReason",void 0),M(this,"_websocketReconnectReason",void 0),M(this,"_connectionState",Ee.CLOSED),M(this,"reconnectToken",void 0),M(this,"websocket",void 0),M(this,"openConnectionTime",void 0),M(this,"clientId",void 0),M(this,"lastMsgTime",Date.now()),M(this,"uploadCache",[]),M(this,"uploadCacheInterval",void 0),M(this,"rttRolling",new kf(5)),M(this,"pingpongTimer",void 0),M(this,"inflateDataTimer",void 0),M(this,"pingpongTimeoutCount",0),M(this,"ortc",void 0),M(this,"joinResponse",void 0),M(this,"multiIpOption",void 0),M(this,"initError",void 0),M(this,"spec",void 0),M(this,"store",void 0),M(this,"isJoining",!1),M(this,"pendingNotifications",[]),M(this,"onWebsocketMessage",r=>{if(r instanceof ArrayBuffer)return void this.emit(le.ON_BINARY_DATA,r);const o=JSON.parse(r);if(B("DC_DEBUG_LOG")&&I.debug("[datachannel-signal] received packet",o),this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(o,"_id")){const s="res-@".concat(o._id);this.emit(s,o._result,o._message)}else Object.prototype.hasOwnProperty.call(o,"_type")&&(this.isJoining?o._type===Ke.ON_NOTIFICATION||o._type===Ke.ON_USER_BANNED?(this.emit(o._type,o._message),o._type===Ke.ON_NOTIFICATION&&this.handleNotification(o._message),o._type===Ke.ON_USER_BANNED&&this.handleUserBanned(o._message)):(this.pendingNotifications.push({type:o._type,message:o._message}),I.debug("[".concat(this.clientId,"] cached notification during join: ").concat(o._type))):(this.emit(o._type,o._message),o._type===Ke.ON_NOTIFICATION&&this.handleNotification(o._message),o._type===Ke.ON_USER_BANNED&&this.handleUserBanned(o._message)))}),this.clientId=t.clientId,this.spec=t,this.store=i,this.websocket=new ax("gateway-".concat(this.clientId),this.spec.retryConfig,!0,i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Ee.CONNECTED&&this.reconnect("retry",gr.OFFLINE)})}async request(t,i,r,o){const s=li(6,""),a={_id:s,_type:t,_message:i},c=this.websocket.connectionID,d=()=>new Z((g,S)=>{if(this.connectionState===Ee.CONNECTED)return g();const T=()=>{this.off(le.WS_CLOSED,C),g()},C=()=>{this.off(le.WS_CONNECTED,T),S(new $(O.WS_ABORT))};this.once(le.WS_CONNECTED,T),this.once(le.WS_CLOSED,C),t!==Be.PUBLISH&&t!==Be.SUBSCRIBE&&t!==Be.UNSUBSCRIBE&&t!==Be.UNPUBLISH&&t!==Be.CONTROL&&t!==Be.RESTART_ICE||this.once(le.DISCONNECT_P2P,()=>{S(new $(O.DISCONNECT_P2P))}),t!==Be.PUBLISH&&t!==Be.RESTART_ICE||this.once(le.ABORT_P2P_EXECUTION,()=>{S(new $(O.DISCONNECT_P2P))})});if(this.connectionState!==Ee.CONNECTING&&this.connectionState!==Ee.RECONNECTING||t===Be.JOIN||t===Be.REJOIN||await d(),t===Be.LEAVE&&(this.websocket.unbindDcCloseEventListener(),o=!0),B("DC_DEBUG_LOG")&&I.debug("[datachannel-signal] sendMessage",a),await this.websocket.sendMessage(a,!0,!1),o)return;const l=new Z((g,S)=>{let T=!1;const C=(D,x)=>{T=!0,g({isSuccess:D==="success",message:x||{}}),this.off(le.WS_CLOSED,b),this.off(le.WS_RECONNECTING,b),this.emit(le.REQUEST_SUCCESS,t,i)};this.once("res-@".concat(s),C);const b=()=>{S(new $(O.WS_ABORT,"type: ".concat(t))),this.off(le.WS_CLOSED,b),this.off(le.WS_RECONNECTING,b),this.off("res-@".concat(s),C)};this.once(le.WS_CLOSED,b),this.once(le.WS_RECONNECTING,b),vt(B("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==c||T||(I.warning("dc request timeout, type: ".concat(t)),this.emit(le.REQUEST_TIMEOUT,t,i))})});let h=null;try{h=await l}catch(g){if(this.connectionState===Ee.CLOSED||t===Be.LEAVE)throw new $(O.WS_ABORT);return!this.spec.forceWaitGatewayResponse||r?g.throw():t===Be.JOIN||t===Be.REJOIN?null:(await d(),await this.request(t,i))}if(h.isSuccess)return h.message;const p=Number(h.message.error_code||h.message.code),f=jh(p),m=new $(O.UNEXPECTED_RESPONSE,"".concat(f.desc,": ").concat(h.message.error_str),{code:p,data:h.message});return f.action==="success"?h.message:(I.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(p,", message: ").concat(f.desc,", action: ").concat(f.action)),p===ye.ERR_TOO_MANY_BROADCASTERS?((t===Be.JOIN||t===Be.REJOIN)&&(this.initError=m,this.close()),m.throw()):f.action==="failed"?m.throw():f.action==="quit"?(this.initError=m,this.close(),m.throw()):(p===ye.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=h.message.option,I.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",gr.MULTI_IP)):this.reconnect(f.action,gr.SERVER_ERROR),t===Be.JOIN||t===Be.REJOIN?null:await this.request(t,i)))}waitMessage(t,i){return new Z(r=>{const o=s=>{(!i||i(s))&&(this.off(t,o),r(s))};this.on(t,o)})}uploadWRTCStats(t){if(!this.store.sessionId)return void I.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(it.WRTC_STATS,i)}upload(t,i){const r={_type:t,_message:i};try{this.websocket.sendMessage(r)}catch{const s=B("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(r),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Ee.CONNECTED)return;const a=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(a._type,a._message)},B("UPLOAD_CACHE_INTERVAL")||2e3))}}async send(t,i){const r={_type:t,_message:i};await this.websocket.sendMessage(r)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Z((i,r)=>{this.once(le.WS_CONNECTED,()=>i(this.joinResponse)),this.once(le.WS_CLOSED,()=>r(this.initError||new $(O.WS_ABORT))),this.connectionState=Ee.CONNECTING,this.websocket.init(t).catch(r),this.websocket.once($i.FAILBACK,()=>{r(new $(O.INIT_DATACHANNEL_TIMEOUT))}),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval(()=>{this.handleInflateData()},2e4),setTimeout(()=>{this.openConnectionTime===void 0&&(I.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),r(new $(O.INIT_DATACHANNEL_TIMEOUT)))},B("DC_JOIN_WITH_FAILBACK"))})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this.isJoining=!1,this.pendingNotifications=[],this._disconnectedReason=t||bt.LEAVE,this.connectionState=Ee.CLOSED,I.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),t===bt.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new ax("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),B("DC_PINGPONG_INTERVAL")),!this.joinResponse){this.emit(le.ABORT_P2P_EXECUTION),this.store.signalConnected();const t=await yt(this,le.REQUEST_JOIN_INFO);this.store.joinReq(),this.isJoining=!0,this.pendingNotifications=[];const i=await this.request(Be.JOIN,t);if(this.store.joinRep(),this.ortc=t==null?void 0:t.ortc,!i)return this.emit(le.REPORT_JOIN_GATEWAY,O.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(le.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Ee.CONNECTED,this.isJoining=!1,this.processPendingNotifications(),!0}async rejoin(){if(!this.reconnectToken)throw new $(O.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=Wi(this,le.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const i=await this.request(Be.REJOIN,t);return!!i&&(this.connectionState=Ee.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),B("DC_PINGPONG_INTERVAL")),i.peers&&i.peers.forEach(r=>{this.emit(Ke.ON_USER_ONLINE,{uid:r.uid}),r.audio&&this.emit(Ke.ON_ADD_AUDIO_STREAM,{uid:r.uid,uint_id:r.uint_id,audio:!0,ssrcId:r.audio_ssrc}),r.video&&this.emit(Ke.ON_ADD_VIDEO_STREAM,{uid:r.uid,uint_id:r.uint_id,video:!0,ssrcId:r.video_ssrc}),r.audio_mute?this.emit(Ke.MUTE_AUDIO,{uid:r.uid}):this.emit(Ke.UNMUTE_AUDIO,{uid:r.uid}),r.video_mute?this.emit(Ke.MUTE_VIDEO,{uid:r.uid}):this.emit(Ke.UNMUTE_VIDEO,{uid:r.uid}),r.audio_enable_local?this.emit(Ke.ENABLE_LOCAL_AUDIO,{uid:r.uid}):this.emit(Ke.DISABLE_LOCAL_AUDIO,{uid:r.uid}),r.video_enable_local?this.emit(Ke.ENABLE_LOCAL_VIDEO,{uid:r.uid}):this.emit(Ke.DISABLE_LOCAL_VIDEO,{uid:r.uid}),r.audio||r.video||this.emit(Ke.ON_REMOVE_STREAM,{uid:r.uid,uint_id:r.uint_id})}),!0)}reconnect(t,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,i)}async downgradeCodec(t){if(!this.ortc)return!1;const i={downgrade_codec:t,ortc:this.ortc};return!!await this.request(Be.DOWNGRADE_CODEC,i)}handleNotification(t){I.debug("[".concat(this.clientId,"] receive notification: "),t);const i=jh(t.code);if(i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(bt.UID_BANNED),void this.close()):void this.reconnect(i.action,gr.SERVER_ERROR);I.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1,B("DC_DEBUG_LOG")&&console.debug("[datachannel-signal] pingpongTimeoutCount: ".concat(this.pingpongTimeoutCount));const t=B("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=t&&(I.warning("[datachannel-signal] PINGPONG Timeout. Last Socket Message: ".concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>B("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("recover",gr.FALLBACK):this.request(Be.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const r=Date.now()-i;this.rttRolling.add(r),B("REPORT_STATS")&&this.send(Be.PING_BACK,{pingpongElapse:r})}).catch(r=>{})}handleInflateData(){const{inflateLength:t,deflateLength:i}=this.websocket.getInflateData();t!==0&&i!==0&&this.upload(it.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:i,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on($i.RECONNECT_CREATE_CONNECTION,t=>{this.emit(le.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on($i.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on($i.CLOSED,()=>{this.connectionState=Ee.CLOSED}),this.websocket.on($i.FAILED,()=>{this._disconnectedReason=bt.NETWORK_ERROR,this.connectionState=Ee.CLOSED}),this.websocket.on($i.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===Ee.CONNECTED?this.connectionState=Ee.RECONNECTING:this.connectionState=Ee.CONNECTING}),this.websocket.on($i.WILL_RECONNECT,(t,i)=>{if(Wi(this,le.IS_P2P_DISCONNECTED)&&t==="retry")return I.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(le.NEED_RENEW_SESSION),this.emit(le.DISCONNECT_P2P),i("tryNext");t!=="retry"&&(I.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(le.NEED_RENEW_SESSION),this.emit(le.DISCONNECT_P2P)),i(t)}),this.websocket.on($i.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(t=>{I.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",gr.SERVER_ERROR)}):this.join().catch(t=>{if(this.emit(le.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof $&&t.code===O.UNEXPECTED_RESPONSE&&t.data.code===ye.ERR_NO_AUTHORIZED)return I.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",gr.SERVER_ERROR);I.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",gr.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on($i.REQUEST_NEW_URLS,(t,i)=>{yt(this,le.REQUEST_RECOVER,this.multiIpOption).then(t).catch(i)}),this.websocket.on($i.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Ke.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on($i.TO_CONNECT_DATACHANNEL,(t,i)=>{yt(this,le.PRE_CONNECT_PC).then(t).catch(i)}),this.websocket.on($i.FAILBACK,()=>{this.openConnectionTime!==void 0&&this.emit(le.DATACHANNEL_FAILBACK)})}}const O9={name:"DataChannelConnection",create:function(e){let{store:t,spec:i}=e;return new Da(i,t)}},cx={name:"DataChannelSignal",create:function(e){let{store:t,spec:i}=e;return new b9(i,t)}};Js(),F("PROCESS_ID","process-".concat(li(8,""),"-").concat(li(4,""),"-").concat(li(4,""),"-").concat(li(4,""),"-").concat(li(12,""))),function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void I.error("Error loading sdk config",t.message)}if(e)try{const t=JSON.parse(window.atob(e)),i=Date.now();I.debug("Loading global parameters from cache",t),Object.keys(t).forEach(r=>{if(Object.prototype.hasOwnProperty.call($e,r)){const{value:o,expires:s}=t[r];if(s&&s<=i)return;Ye[r]=o,$e[r]=o}})}catch(t){I.error("Error loading mutableParamsCache: ".concat(e),t.message)}}(),Array.isArray(Ye.AREAS)&&Ye.AREAS.length>0&&mC(Ye.AREAS,!0);const Kr=(e,t,i)=>{I.debug("setParameter key:".concat(e,", value:").concat(JSON.stringify(t))),F(e,t,i)};go(W2,!1),go(_9,!1),go(E2,!1),go(J2,!1),go(l9,!1),go(rx,!1),go(A9,!1),go(oi,!1),go(O9,!1),go(cx,!1);const n=function(e){const t=new Vi,i=e,r={getListeners:t.getListeners.bind(t),on:(o,s)=>(function(a,c){a===$n.SECURITY_POLICY_VIOLATION&&R2(c,!0)}(o,s),t.on.bind(t)(o,s)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return UC(UC({},i),r)}({__TRACK_LIST__:Mh,VERSION:Qs,BUILD:sT,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:Kr,getParameter:B,getSupportedCodec:async function(){let e={audio:[],video:[]};try{let t=new RTCPeerConnection;const i=await async function(r){let o;return Mt().supportUnifiedPlan?(r.addTransceiver("video",{direction:"recvonly"}),r.addTransceiver("audio",{direction:"recvonly"}),o=(await r.createOffer()).sdp):o=(await r.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,o}(t);if(!i)return e;t.close(),t=null,e=function(r){const o={video:[],audio:[]};return r.match(/ VP8/i)&&o.video.push("VP8"),r.match(/ VP9/i)&&o.video.push("VP9"),r.match(/ AV1/i)&&o.video.push("AV1"),r.match(/ H264/i)&&o.video.push("H264"),r.match(/ H265/i)&&o.video.push("H265"),r.match(/ opus/i)&&o.audio.push("OPUS"),r.match(/ PCMU/i)&&o.audio.push("PCMU"),r.match(/ PCMA/i)&&o.audio.push("PCMA"),r.match(/ G722/i)&&o.audio.push("G722"),o}(i)}catch(t){throw new $(O.CREATE_OFFER_FAILED,t.toString&&t.toString()).print()}return e},checkSystemRequirements:function(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];const t=H.reportApiInvoke(null,{name:ct.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:bi.TRACER}),i=function(){let s=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0],a=!1;try{const c=window.RTCPeerConnection,d=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,l=window.WebSocket;a=!(!c||!l),s&&!d&&(a=!1),a&&yu()&&_v(75)&&new c().close()}catch(c){I.error("check system requirement failed: ",c),a=!1}return a}(e),r=oR();I.debug("checkSystemRequirements, api:",i,"browser",r);const o=i&&r;return t.onSuccess(o),B("IGNORE_RTC_DEVICE_CHECK")?i:o},getDevices:function(e){return As.enumerateDevices(!0,!0,e)},getMicrophones:function(e){return As.getRecordingDevices(e)},getCameras:function(e){return As.getCamerasDevices(e)},getElectronScreenSources:Bv,getPlaybackDevices:function(e){return As.getSpeakers(e)},createClient:S2,createCameraVideoTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=B("CAMERA_CAPTURE_CONFIG"),i=li(8,"track-cam-"),r=H.reportApiInvoke(null,{id:i,tag:bi.TRACER,name:ct.CREATE_CAM_VIDEO_TRACK,options:[Mi({},e),t]});t&&(e.encoderConfig=t);const o=uT(e);let s=null;I.info("start create camera video track with config",JSON.stringify(e),"trackId",i);try{s=(await Ra({video:o},i)).getVideoTracks()[0]||null}catch(c){throw r.onError(c),c}if(!s){const c=new oe(O.UNEXPECTED_ERROR,"can not find track in media stream");return r.onError(c),c.throw(I)}if(e.optimizationMode&&Xv(i,s,e,Ta(e.encoderConfig)),B("USE_STANDARD_BITRATE_DEFAULT")){const c=Ta(e.encoderConfig);e.encoderConfig=c,delete c.bitrateMax,delete c.bitrateMin}const a=new fT(s,e,o,e.scalabiltyMode?Lv(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,i);return r.onSuccess(a.getTrackId()),I.info("create camera video success, trackId:",i),a},createCustomVideoTrack:function(e){const t=li(8,"track-cus-"),i=H.reportApiInvoke(null,{id:t,tag:bi.TRACER,name:ct.CREATE_CUSTOM_VIDEO_TRACK,options:[e]});B("USE_STANDARD_BITRATE_DEFAULT")&&(delete e.bitrateMax,delete e.bitrateMin);const r=new yi(e.mediaStreamTrack,{width:e.width,height:e.height,frameRate:e.frameRate,bitrateMax:e.bitrateMax,bitrateMin:e.bitrateMin},e.scalabiltyMode?Lv(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,t,[ui.CUSTOM_TRACK]);return i.onSuccess(r.getTrackId()),I.info("create custom video track success with config",e,"trackId",r.getTrackId()),r},createScreenVideoTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable";const i=typeof t=="object"?function(f){const m=iD(f);return zN()&&f.suppressLocalAudioPlayback&&(m.suppressLocalAudioPlayback=f.suppressLocalAudioPlayback),In()&&f.restrictOwnAudio&&(m.restrictOwnAudio=!0),m}(t):void 0;i&&(t="auto");const r=li(8,"track-scr-v-"),o=H.reportApiInvoke(null,{id:r,tag:bi.TRACER,name:ct.CREATE_SCREEN_VIDEO_TRACK,options:[Mi({},e),t]});e.encoderConfig?typeof e.encoderConfig=="string"||e.encoderConfig.width&&e.encoderConfig.height||(e.encoderConfig.width={max:1920},e.encoderConfig.height={max:1080}):e.encoderConfig="1080p_2";const s=function(f){const m={};f.screenSourceType&&(m.mediaSource=f.screenSourceType),f.extensionId&&Cr()&&(m.extensionId=f.extensionId);const{displaySurface:g,selfBrowserSurface:S,surfaceSwitching:T,systemAudio:C,preferCurrentTab:b,windowAudio:D,monitorTypeSurfaces:x}=f;(bc(107)||Rl(107)||Ah(93))&&(g&&(Rt(g,"displaySurface",["browser","window","monitor"]),m.displaySurface=g),S?(Rt(S,"selfBrowserSurface",["exclude","include"]),m.selfBrowserSurface=S):m.selfBrowserSurface="include",T&&(Rt(T,"surfaceSwitching",["exclude","include"]),m.surfaceSwitching=T)),(bc(105)||Rl(105)||Ah(91))&&C&&(Rt(C,"systemAudio",["exclude","include"]),m.systemAudio=C),(bc(94)||Rl(94)||Ah(80))&&b&&(m.preferCurrentTab=!0),(bc(141)||Rl(141)||Ah(125))&&D&&(Rt(D,"windowAudio",["exclude","system"]),m.windowAudio=D),(bc(119)||Rl(119)||Ah(105))&&x&&(Rt(x,"monitorTypeSurfaces",["exclude","include"]),m.monitorTypeSurfaces=x),f.electronScreenSourceId&&(m.sourceId=f.electronScreenSourceId);const k=f.encoderConfig?Hf(f.encoderConfig):null;return m.mandatory={chromeMediaSource:"desktop",maxWidth:k?k.width:void 0,maxHeight:k?k.height:void 0},k&&(k.frameRate&&(typeof k.frameRate=="number"?(m.mandatory.maxFrameRate=k.frameRate,m.mandatory.minFrameRate=k.frameRate):(m.mandatory.maxFrameRate=k.frameRate.max||k.frameRate.ideal||k.frameRate.exact||void 0,m.mandatory.minFrameRate=k.frameRate.min||k.frameRate.ideal||k.frameRate.exact||void 0),m.frameRate=k.frameRate),k.width&&(m.width=k.width),k.height&&(m.height=k.height)),m}(e);let a=null,c=null;const d=Mt();if(!d.supportShareAudio&&t==="enable"){const f=new oe(O.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return o.onError(f),f.throw(I)}I.info("start create screen video track with config",e,"withAudio",t,"trackId",r);const l=d.supportShareAudio&&t!=="disable";try{const f=await Ra({screen:s,screenAudio:l?i||!0:void 0},r);a=f.getVideoTracks()[0]||null,c=f.getAudioTracks()[0]||null}catch(f){throw o.onError(f),f}if(!a){const f=new oe(O.UNEXPECTED_ERROR,"can not find track in media stream");return o.onError(f),f.throw(I)}if(!c&&t==="enable"){a&&a.stop();const f=new oe(O.SHARE_AUDIO_NOT_ALLOWED);return o.onError(f),f.throw(I)}e.optimizationMode||(e.optimizationMode="detail"),e.optimizationMode&&(Xv(r,a,e,e.encoderConfig&&Hf(e.encoderConfig)||void 0),e.encoderConfig&&typeof e.encoderConfig!="string"&&(e.encoderConfig.bitrateMin=e.encoderConfig.bitrateMax));const h=new yi(a,e.encoderConfig?Hf(e.encoderConfig):{},e.scalabiltyMode?Lv(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,r,[ui.SCREEN_TRACK]);if(!c)return o.onSuccess(h.getTrackId()),I.info("create screen video track success","video:",h.getTrackId()),h;const p=new Zi(c,void 0,li(8,"track-scr-a-"),!1);return o.onSuccess([h.getTrackId(),p.getTrackId()]),I.info("create screen video track success","video:",h.getTrackId(),"audio:",p.getTrackId()),[h,p]},createMicrophoneAndCameraTracks:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const i=B("CAMERA_CAPTURE_CONFIG"),r=li(8,"track-mic-"),o=li(8,"track-cam-"),s=H.reportApiInvoke(null,{id:"".concat(r,"-").concat(o),tag:bi.TRACER,name:ct.CREATE_MIC_AND_CAM_TRACKS,options:[e,t,i]});i&&(t.encoderConfig=i);const a=uT(t),c=rD(e);let d=null,l=null;I.info("start create camera video track(".concat(o,") and microphone audio track(").concat(r,") with config, audio: ").concat(JSON.stringify(e),", video: ").concat(JSON.stringify(t)));try{const f=await Ra({audio:c,video:a},"".concat(r,"-").concat(o));d=f.getAudioTracks()[0],l=f.getVideoTracks()[0]}catch(f){throw s.onError(f),f}if(!d||!l){const f=new oe(O.UNEXPECTED_ERROR,"can not find tracks in media stream");return s.onError(f),f.throw(I)}if(t.optimizationMode&&Xv(o,l,t,Ta(t.encoderConfig)),B("USE_STANDARD_BITRATE_DEFAULT")){const f=Ta(t.encoderConfig);t.encoderConfig=f,delete f.bitrateMax,delete f.bitrateMin}const h=new hT(d,e,c,r),p=new fT(l,t,a,t.scalabiltyMode?Lv(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,o);return s.onSuccess([h.getTrackId(),p.getTrackId()]),I.info("create camera video track(".concat(o,") and microphone audio track(").concat(r,") success")),[h,p]},createMicrophoneAudioTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=li(8,"track-mic-"),i=H.reportApiInvoke(null,{id:t,tag:bi.TRACER,name:ct.CREATE_MIC_AUDIO_TRACK,options:[e]}),r=rD(e);let o=null;I.info("start create microphone audio track with config",JSON.stringify(e),"trackId",t);try{o=(await Ra({audio:r},t)).getAudioTracks()[0]||null}catch(a){throw i.onError(a),a}if(!o){const a=new oe(O.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(a),a.throw(I)}const s=new hT(o,e,r,t);return i.onSuccess(s.getTrackId()),I.info("create microphone audio track success, trackId:",t),s},createCustomAudioTrack:qv,createBufferSourceAudioTrack:async function(e){var t;const{cacheOnlineFile:i,encoderConfig:r}=e;let{source:o}=e;const s={source:o instanceof AudioBuffer?"AudioBuffer":o instanceof File?(t=File.name)!==null&&t!==void 0?t:"File":o,cacheOnlineFile:i,encoderConfig:r},a=li(8,"track-buf-"),c=H.reportApiInvoke(null,{id:a,tag:bi.TRACER,name:ct.CREATE_BUFFER_AUDIO_TRACK,options:[s]});if(B("DISABLE_WEBAUDIO"))throw new oe(O.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");I.info("start create buffer source audio track with config",JSON.stringify(s),"trackId",a);const d=o;if(!(o instanceof AudioBuffer))try{o=await async function(p,f){let m=null;if(typeof p=="string"){const S=BD.get(p);if(S)return I.debug("use cached audio resource: ",p),S;try{m=(await ma(()=>hs.get(p,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(T){throw new oe(O.FETCH_AUDIO_FILE_FAILED,T.toString())}}else m=await new Z((T,C)=>{const b=new FileReader;b.onload=D=>{D.target?T(D.target.result):C(new oe(O.READ_LOCAL_AUDIO_FILE_ERROR))},b.onerror=()=>{C(new oe(O.READ_LOCAL_AUDIO_FILE_ERROR))},b.readAsArrayBuffer(p)});const g=await function(S){const T=Pc();return new Z((C,b)=>{T.decodeAudioData(S,D=>{C(D)},D=>{b(new oe(O.DECODE_AUDIO_FILE_FAILED,D.toString()))})})}(m);return typeof p=="string"&&f&&BD.set(p,g),g}(o,i)}catch(p){return c.onError(p),p.throw(I)}const l=new UU(o),h=new rn(d,l,r?Cl(r):{},a);return I.info("create buffer source audio track success, trackId:",a),c.onSuccess(h.getTrackId()),h},setAppType:function(e){if(I.debug("setAppType: ".concat(e)),!(Number.isInteger(e)&&e>=0))throw I.debug("Invalid appType"),new $(O.INVALID_PARAMS,"invalid app type",e);F("APP_TYPE",Math.floor(e))},setLogLevel:function(e){I.setLogLevel(e)},enableLogUpload:function(){B("USE_NEW_LOG")?F("UPLOAD_LOG",!0):I.enableLogUpload()},disableLogUpload:function(){B("USE_NEW_LOG")?F("UPLOAD_LOG",!1):I.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new hL},checkAudioTrackIsActive:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const i=H.reportApiInvoke(null,{tag:bi.TRACER,name:ct.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof Zi||e instanceof Eo)){const d=new $(O.INVALID_TRACK,"the parameter is not a audio track");return i.onError(d),d.throw()}t&&t<1e3&&(t=1e3);const r=e instanceof Zi?e.getTrackLabel():"remote_track",o=e.getVolumeLevel();let s=o,a=o;const c=Date.now();return new Z(d=>{const l=setInterval(()=>{const h=e.getVolumeLevel();s=h>s?h:s,a=h<a?h:a;const p=s-a>1e-4,f=Date.now()-c;if(p||f>t){clearInterval(l);const m=p,g={duration:f,deviceLabel:r,maxVolumeLevel:s,result:m};I.info("[track-".concat(e.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(g))),i.onSuccess(g),d(m)}},200)})},checkVideoTrackIsActive:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const i=H.reportApiInvoke(null,{tag:bi.TRACER,name:ct.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof yi||e instanceof Wd)){const p=new $(O.INVALID_TRACK,"the parameter is not a video track");return i.onError(p),p.throw()}t&&t<1e3&&(t=1e3);const r=e instanceof yi?e.getTrackLabel():"remote_track",o=e.getMediaStreamTrack(!0),s=document.createElement("video");s.style.width="1px",s.style.height="1px",s.setAttribute("muted",""),s.muted=!0,s.setAttribute("playsinline",""),s.controls=!1,(pn()||wc())&&(s.style.opacity="0.01",s.style.position="fixed",s.style.left="0",s.style.top="0",document.body.appendChild(s)),s.srcObject=new MediaStream([o]),s.play();const a=document.createElement("canvas");a.width=160,a.height=120;let c=0,d=0;try{const p=Date.now();c=await function(f,m,g,S){let T,C=0,b=null;return new Z((D,x)=>{function k(){C>S&&T&&(T(),D(C));const V=g.getContext("2d");if(!V){const J=new $(O.UNEXPECTED_ERROR,"can not get canvas 2d context.");return I.error(J.toString()),void x(J)}V.drawImage(f,0,0,160,120);const W=V.getImageData(0,0,g.width,g.height),K=Math.floor(W.data.length/3);if(b){for(let J=0;J<K;J+=3)if(W.data[J]!==b[J])return C+=1,void(b=W.data);b=W.data}else b=W.data}setTimeout(()=>{T&&(T(),D(C))},m),T=xv(()=>{k()},30)})}(s,t,a,4),d=Date.now()-p}catch(p){throw i.onError(p),p}u2===di.SAFARI&&(s.pause(),s.remove()),s.srcObject=null;const l=c>4,h={duration:d,changedPicNum:c,deviceLabel:r,result:l};return I.info("[track-".concat(e.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(h))),i.onSuccess(h),l},setArea:mC,audioElementPlayCenter:pi,resumeAudioContext:function(){return pi.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(e){T2.processExternalMediaAEC(e)},registerExtensions:function(e){const t=B("PLUGIN_INFO")||[];e.forEach(i=>{"name"in i&&!z(t).call(t,i.name)&&t.push(i.name);const r=i;r.__registered__=!0,r.logger.hookLog=I.extLog,r.reporter.hookApiInvoke=H.extApiInvoke,r.parameters&&Object.keys(r.parameters).forEach(o=>{r.parameters[o]=B(o)})}),Kr("PLUGIN_INFO",t)},ChannelMediaRelayError:_i,ChannelMediaRelayEvent:An,ChannelMediaRelayState:lo,RemoteStreamFallbackType:b_,RemoteStreamType:HY,ConnectionDisconnectedReason:bt,AudienceLatencyLevelType:Gt,AREAS:mi,preload:async function(e,t,i,r){return $T(e,t,i,r)},startLastmileProbeTest:async function(e,t,i,r){let o={state:"unavailable"};await $T(e,t,i,r);const s=await bC({appId:e,cname:t,token:i||e,uid:r,cloudProxyServer:"disabled"});if(!s)return o;await eR(s);let a,c=S2({mode:"rtc",codec:"vp8"});try{a=await c.join(e,t,i,r,{networkQualityProbe:!0})}catch{return o}const d=new bL,l=d.createMuteAudioTrack();let h=await qv({mediaStreamTrack:l});await c.publish([h]);let[p,f,m]=await new Z((D,x)=>{const k=setTimeout(()=>{clearTimeout(k),D([!0,null,"audio"])},5e3);c.on("user-published",async(V,W)=>{V.uid===a&&(clearTimeout(k),D([!1,V,W]))})});if(p||!f)return await c.unpublish([h]),await c.leave(),h.close(),d.close(),o;await c.subscribe(f,m),await new Z((D,x)=>{const k=setTimeout(()=>{clearTimeout(k),D(null)},5e3)});let g=c.getRTCStats(),S=c.getLocalAudioStats();const T=g.RTT,C=S.sendJitterMs,b=S.currentPacketLossRate;return o={state:"complete",rtt:T,packetLossRate:b,jitter:C,networkQuality:((D,x,k)=>{let V=1;if(k>0){let Ne=Math.log(100*k)/Math.log(2)+1;Ne=Math.min(5,Math.max(0,Ne)),V=1-Ne/5}let W=1;if(D>0){let Ne=Math.log(D/40)/Math.log(2)+1;Ne=Math.min(5,Math.max(0,Ne)),W=1-Ne/5}let K=1;if(x>0){let Ne=Math.log(x/10)/Math.log(2.5)+1;Ne=Math.min(5,Math.max(0,Ne)),K=1-Ne/5}const J=.5*V+.3*W+.2*K;let se=0;return se=J>=.8?1:J>=.6?2:J>=.4?3:J>=.2?4:5,se})(T,C,b)},await c.unsubscribe(f),await c.unpublish([h]),await c.leave(),h.close(),d.close(),await eR(s),o}});return Object.defineProperties(n,{onAudioAutoplayFailed:{get:()=>Yo.onAudioAutoplayFailed,set:e=>{Yo.onAudioAutoplayFailed=e}},onAutoplayFailed:{get:()=>Yo.onAutoplayFailed,set:e=>{Yo.onAutoplayFailed=e}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>n._onSecurityPolicyViolation,set(e){n._onSecurityPolicyViolation=e,R2(e)}},__CLIENT_LIST__:{get:()=>B("SHOW_GLOBAL_CLIENT_LIST")?Lc:[]}}),As.on(tn.CAMERA_DEVICE_CHANGED,e=>{I.info("camera device changed",JSON.stringify(e)),n.onCameraChanged&&n.onCameraChanged(e),n.safeEmit($n.CAMERA_CHANGED,e)}),As.on(tn.RECORDING_DEVICE_CHANGED,e=>{I.info("microphone device changed",JSON.stringify(e)),n.onMicrophoneChanged&&n.onMicrophoneChanged(e),n.safeEmit($n.MICROPHONE_CHANGED,e)}),As.on(tn.PLAYOUT_DEVICE_CHANGED,e=>{I.debug("playout device changed",JSON.stringify(e)),n.onPlaybackDeviceChanged&&n.onPlaybackDeviceChanged(e),n.safeEmit($n.PLAYBACK_DEVICE_CHANGED,e)}),pi.onAutoplayFailed=()=>{I.info("detect audio element autoplay failed"),Yo.onAudioAutoplayFailed&&Yo.onAudioAutoplayFailed()},Ei.on("autoplay-failed",()=>{I.info("detect webaudio autoplay failed"),Yo.onAudioAutoplayFailed&&Yo.onAudioAutoplayFailed(),n.safeEmit($n.AUTOPLAY_FAILED)}),Ei.on(zr.STATE_CHANGE,(e,t)=>{I.info("audio context state changed: ".concat(t," => ").concat(e)),n.onAudioContextStateChanged&&n.onAudioContextStateChanged(e,t),n.safeEmit($n.AUDIO_CONTEXT_STATE_CHANGED,e,t)}),fi.on(fr.NETWORK_STATE_CHANGE,(e,t)=>{I.info("[network-indicator] network state changed, ".concat(t," => ").concat(e))}),window&&(window.__ARTC__=n),n})})(gZ);var mte=gZ.exports;const Ete=GZ(mte);/**
 * @license agora-rtc-react
 * @version 2.5.1
 *
 * Copyright (c) Agora, Inc.
 *
 * This source code is licensed under the MIT license.
 */var gte=Object.create,WX=Object.defineProperty,Ste=Object.getOwnPropertyDescriptor,Tte=Object.getOwnPropertyNames,Rte=Object.getPrototypeOf,vte=Object.prototype.hasOwnProperty,Cte=(u,_)=>()=>(_||u((_={exports:{}}).exports,_),_.exports),yte=(u,_)=>{for(var E in _)WX(u,E,{get:_[E],enumerable:!0})},RZ=(u,_,E,R)=>{if(_&&typeof _=="object"||typeof _=="function")for(let A of Tte(_))!vte.call(u,A)&&A!==E&&WX(u,A,{get:()=>_[A],enumerable:!(R=Ste(_,A))||R.enumerable});return u},Ite=(u,_,E)=>(RZ(u,_,"default"),E),WR=(u,_,E)=>(E=u!=null?gte(Rte(u)):{},RZ(!u||!u.__esModule?WX(E,"default",{value:u,enumerable:!0}):E,u)),HR=Cte((u,_)=>{(function(E,R){typeof u=="object"&&typeof _<"u"?_.exports=R():typeof define=="function"&&define.amd?define(R):(E=typeof globalThis<"u"?globalThis:E||self).AgoraRTC=R()})(u,function(){function E(n,e){return e.forEach(function(t){t&&typeof t!="string"&&!Array.isArray(t)&&Object.keys(t).forEach(function(i){if(i!=="default"&&!(i in n)){var r=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(n,i,r.get?r:{enumerable:!0,get:function(){return t[i]}})}})}),Object.freeze(n)}var R=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function A(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var P=function(n){try{return!!n()}catch{return!0}},G=!P(function(){var n=(function(){}).bind();return typeof n!="function"||n.hasOwnProperty("prototype")}),q=G,ee=Function.prototype,de=ee.call,Ie=q&&ee.bind.bind(de,de),he=q?Ie:function(n){return function(){return de.apply(n,arguments)}},me=he({}.isPrototypeOf),je=function(n){return n&&n.Math===Math&&n},ve=je(typeof globalThis=="object"&&globalThis)||je(typeof window=="object"&&window)||je(typeof self=="object"&&self)||je(typeof R=="object"&&R)||je(typeof R=="object"&&R)||function(){return this}()||Function("return this")(),ge=G,Ge=Function.prototype,pe=Ge.apply,ce=Ge.call,fe=typeof Reflect=="object"&&Reflect.apply||(ge?ce.bind(pe):function(){return ce.apply(pe,arguments)}),We=he,lt=We({}.toString),jt=We("".slice),dt=function(n){return jt(lt(n),8,-1)},zt=dt,Pn=he,Ri=function(n){if(zt(n)==="Function")return Pn(n)},is=typeof document=="object"&&document.all,ci=is===void 0&&is!==void 0?function(n){return typeof n=="function"||n===is}:function(n){return typeof n=="function"},Va={},ur=!P(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!==7}),Zy=G,rd=Function.prototype.call,gi=Zy?rd.bind(rd):function(){return rd.apply(rd,arguments)},mt={},vi={}.propertyIsEnumerable,Ni=Object.getOwnPropertyDescriptor,Ln=Ni&&!vi.call({1:2},1);mt.f=Ln?function(n){var e=Ni(this,n);return!!e&&e.enumerable}:vi;var hr,yc,kn=function(n,e){return{enumerable:!(1&n),configurable:!(2&n),writable:!(4&n),value:e}},aE=P,ql=dt,El=Object,NV=he("".split),lp=aE(function(){return!El("z").propertyIsEnumerable(0)})?function(n){return ql(n)==="String"?NV(n,""):El(n)}:El,up=function(n){return n==null},DV=up,PV=TypeError,Vs=function(n){if(DV(n))throw new PV("Can't call method on "+n);return n},LV=lp,kV=Vs,Fs=function(n){return LV(kV(n))},MV=ci,ir=function(n){return typeof n=="object"?n!==null:MV(n)},Qr={},cE=Qr,dE=ve,UV=ci,$y=function(n){return UV(n)?n:void 0},Sr=function(n,e){return arguments.length<2?$y(cE[n])||$y(dE[n]):cE[n]&&cE[n][e]||dE[n]&&dE[n][e]},eI=ve.navigator,tI=eI&&eI.userAgent,rs=tI?String(tI):"",iI=ve,lE=rs,rI=iI.process,nI=iI.Deno,oI=rI&&rI.versions||nI&&nI.version,sI=oI&&oI.v8;sI&&(yc=(hr=sI.split("."))[0]>0&&hr[0]<4?1:+(hr[0]+hr[1])),!yc&&lE&&(!(hr=lE.match(/Edge\/(\d+)/))||hr[1]>=74)&&(hr=lE.match(/Chrome\/(\d+)/))&&(yc=+hr[1]);var Fa=yc,aI=Fa,xV=P,VV=ve.String,nd=!!Object.getOwnPropertySymbols&&!xV(function(){var n=Symbol("symbol detection");return!VV(n)||!(Object(n)instanceof Symbol)||!Symbol.sham&&aI&&aI<41}),cI=nd&&!Symbol.sham&&typeof Symbol.iterator=="symbol",FV=Sr,BV=ci,jV=me,GV=Object,Xl=cI?function(n){return typeof n=="symbol"}:function(n){var e=FV("Symbol");return BV(e)&&jV(e.prototype,GV(n))},WV=String,od=function(n){try{return WV(n)}catch{return"Object"}},HV=ci,KV=od,YV=TypeError,Zr=function(n){if(HV(n))return n;throw new YV(KV(n)+" is not a function")},zV=Zr,qV=up,Jl=function(n,e){var t=n[e];return qV(t)?void 0:zV(t)},dI=gi,lI=ci,uI=ir,XV=TypeError,hI={exports:{}},pI=ve,JV=Object.defineProperty,QV=ve,ZV=function(n,e){try{JV(pI,n,{value:e,configurable:!0,writable:!0})}catch{pI[n]=e}return e},_I="__core-js_shared__",fI=hI.exports=QV[_I]||ZV(_I,{});(fI.versions||(fI.versions=[])).push({version:"3.46.0",mode:"pure",copyright:" 2014-2025 Denis Pushkarev (zloirock.ru), 2025 CoreJS Company (core-js.io)",license:"https://github.com/zloirock/core-js/blob/v3.46.0/LICENSE",source:"https://github.com/zloirock/core-js"});var uE=hI.exports,mI=uE,sd=function(n,e){return mI[n]||(mI[n]=e||{})},$V=Vs,eF=Object,Co=function(n){return eF($V(n))},tF=Co,iF=he({}.hasOwnProperty),Bi=Object.hasOwn||function(n,e){return iF(tF(n),e)},rF=he,nF=0,oF=Math.random(),sF=rF(1.1.toString),hE=function(n){return"Symbol("+(n===void 0?"":n)+")_"+sF(++nF+oF,36)},aF=sd,EI=Bi,cF=hE,dF=nd,lF=cI,ad=ve.Symbol,pE=aF("wks"),uF=lF?ad.for||ad:ad&&ad.withoutSetter||cF,qt=function(n){return EI(pE,n)||(pE[n]=dF&&EI(ad,n)?ad[n]:uF("Symbol."+n)),pE[n]},hF=gi,gI=ir,SI=Xl,pF=Jl,_F=function(n,e){var t,i;if(lI(t=n.toString)&&!uI(i=dI(t,n))||lI(t=n.valueOf)&&!uI(i=dI(t,n))||e!=="string")return i;throw new XV("Can't convert object to primitive value")},fF=TypeError,mF=qt("toPrimitive"),EF=function(n,e){if(!gI(n)||SI(n))return n;var t,i=pF(n,mF);if(i){if(t=hF(i,n,e),!gI(t)||SI(t))return t;throw new fF("Can't convert object to primitive value")}return _F(n,e)},gF=Xl,_E=function(n){var e=EF(n,"string");return gF(e)?e:e+""},TI=ir,fE=ve.document,SF=TI(fE)&&TI(fE.createElement),mE=function(n){return SF?fE.createElement(n):{}},TF=mE,RI=!ur&&!P(function(){return Object.defineProperty(TF("div"),"a",{get:function(){return 7}}).a!==7}),RF=ur,vF=gi,CF=mt,yF=kn,IF=Fs,AF=_E,wF=Bi,bF=RI,vI=Object.getOwnPropertyDescriptor;Va.f=RF?vI:function(n,e){if(n=IF(n),e=AF(e),bF)try{return vI(n,e)}catch{}if(wF(n,e))return yF(!vF(CF.f,n,e),n[e])};var OF=P,NF=ci,DF=/#|\.prototype\./,Ql=function(n,e){var t=LF[PF(n)];return t===MF||t!==kF&&(NF(e)?OF(e):!!e)},PF=Ql.normalize=function(n){return String(n).replace(DF,".").toLowerCase()},LF=Ql.data={},kF=Ql.NATIVE="N",MF=Ql.POLYFILL="P",CI=Ql,UF=Zr,xF=G,VF=Ri(Ri.bind),Bs=function(n,e){return UF(n),e===void 0?n:xF?VF(n,e):function(){return n.apply(e,arguments)}},Mn={},yI=ur&&P(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!==42}),FF=ir,BF=String,jF=TypeError,Ur=function(n){if(FF(n))return n;throw new jF(BF(n)+" is not an object")},GF=ur,WF=RI,HF=yI,hp=Ur,II=_E,KF=TypeError,EE=Object.defineProperty,YF=Object.getOwnPropertyDescriptor,gE="enumerable",SE="configurable",TE="writable";Mn.f=GF?HF?function(n,e,t){if(hp(n),e=II(e),hp(t),typeof n=="function"&&e==="prototype"&&"value"in t&&TE in t&&!t[TE]){var i=YF(n,e);i&&i[TE]&&(n[e]=t.value,t={configurable:SE in t?t[SE]:i[SE],enumerable:gE in t?t[gE]:i[gE],writable:!1})}return EE(n,e,t)}:EE:function(n,e,t){if(hp(n),e=II(e),hp(t),WF)try{return EE(n,e,t)}catch{}if("get"in t||"set"in t)throw new KF("Accessors not supported");return"value"in t&&(n[e]=t.value),n};var zF=Mn,qF=kn,Ba=ur?function(n,e,t){return zF.f(n,e,qF(1,t))}:function(n,e,t){return n[e]=t,n},Zl=ve,XF=fe,JF=Ri,QF=ci,ZF=Va.f,$F=CI,cd=Qr,eB=Bs,dd=Ba,AI=Bi,tB=function(n){var e=function(t,i,r){if(this instanceof e){switch(arguments.length){case 0:return new n;case 1:return new n(t);case 2:return new n(t,i)}return new n(t,i,r)}return XF(n,this,arguments)};return e.prototype=n.prototype,e},qe=function(n,e){var t,i,r,o,s,a,c,d,l,h=n.target,p=n.global,f=n.stat,m=n.proto,g=p?Zl:f?Zl[h]:Zl[h]&&Zl[h].prototype,S=p?cd:cd[h]||dd(cd,h,{})[h],T=S.prototype;for(o in e)i=!(t=$F(p?o:h+(f?".":"#")+o,n.forced))&&g&&AI(g,o),a=S[o],i&&(c=n.dontCallGetSet?(l=ZF(g,o))&&l.value:g[o]),s=i&&c?c:e[o],(t||m||typeof a!=typeof s)&&(d=n.bind&&i?eB(s,Zl):n.wrap&&i?tB(s):m&&QF(s)?JF(s):s,(n.sham||s&&s.sham||a&&a.sham)&&dd(d,"sham",!0),dd(S,o,d),m&&(AI(cd,r=h+"Prototype")||dd(cd,r,{}),dd(cd[r],o,s),n.real&&T&&(t||!T[o])&&dd(T,o,s)))},iB=Math.ceil,rB=Math.floor,nB=Math.trunc||function(n){var e=+n;return(e>0?rB:iB)(e)},oB=nB,RE=function(n){var e=+n;return e!=e||e===0?0:oB(e)},sB=RE,aB=Math.max,cB=Math.min,vE=function(n,e){var t=sB(n);return t<0?aB(t+e,0):cB(t,e)},dB=RE,lB=Math.min,wI=function(n){var e=dB(n);return e>0?lB(e,9007199254740991):0},uB=wI,js=function(n){return uB(n.length)},hB=Fs,pB=vE,_B=js,bI=function(n){return function(e,t,i){var r=hB(e),o=_B(r);if(o===0)return!n&&-1;var s,a=pB(i,o);if(n&&t!=t){for(;o>a;)if((s=r[a++])!=s)return!0}else for(;o>a;a++)if((n||a in r)&&r[a]===t)return n||a||0;return!n&&-1}},CE={includes:bI(!0),indexOf:bI(!1)},fB=CE.includes;qe({target:"Array",proto:!0,forced:P(function(){return!Array(1).includes()})},{includes:function(n){return fB(this,n,arguments.length>1?arguments[1]:void 0)}});var mB=ve,EB=Qr,ln=function(n,e){var t=EB[n+"Prototype"],i=t&&t[e];if(i)return i;var r=mB[n],o=r&&r.prototype;return o&&o[e]},gB=ln("Array","includes"),SB=ir,TB=dt,RB=qt("match"),yE=function(n){var e;return SB(n)&&((e=n[RB])!==void 0?!!e:TB(n)==="RegExp")},vB=yE,CB=TypeError,OI={};OI[qt("toStringTag")]="z";var IE=String(OI)==="[object z]",yB=IE,IB=ci,pp=dt,AB=qt("toStringTag"),wB=Object,bB=pp(function(){return arguments}())==="Arguments",Gs=yB?pp:function(n){var e,t,i;return n===void 0?"Undefined":n===null?"Null":typeof(t=function(r,o){try{return r[o]}catch{}}(e=wB(n),AB))=="string"?t:bB?pp(e):(i=pp(e))==="Object"&&IB(e.callee)?"Arguments":i},OB=Gs,NB=String,xr=function(n){if(OB(n)==="Symbol")throw new TypeError("Cannot convert a Symbol value to a string");return NB(n)},DB=qt("match"),PB=qe,LB=function(n){if(vB(n))throw new CB("The method doesn't accept regular expressions");return n},kB=Vs,NI=xr,MB=function(n){var e=/./;try{"/./"[n](e)}catch{try{return e[DB]=!1,"/./"[n](e)}catch{}}return!1},UB=he("".indexOf);PB({target:"String",proto:!0,forced:!MB("includes")},{includes:function(n){return!!~UB(NI(kB(this)),NI(LB(n)),arguments.length>1?arguments[1]:void 0)}});var xB=ln("String","includes"),DI=me,VB=gB,FB=xB,AE=Array.prototype,wE=String.prototype,BB=function(n){var e=n.includes;return n===AE||DI(AE,n)&&e===AE.includes?VB:typeof n=="string"||n===wE||DI(wE,n)&&e===wE.includes?FB:e},z=A(BB),jB=Zr,GB=Co,WB=lp,HB=js,PI=TypeError,LI="Reduce of empty array with no initial value",KB=function(n){return function(e,t,i,r){var o=GB(e),s=WB(o),a=HB(o);if(jB(t),a===0&&i<2)throw new PI(LI);var c=0,d=1;if(i<2)for(;;){if(c in s){r=s[c],c+=d;break}if(c+=d,a<=c)throw new PI(LI)}for(;a>c;c+=d)c in s&&(r=t(r,s[c],c,o));return r}},YB={left:KB()},zB=P,_p=function(n,e){var t=[][n];return!!t&&zB(function(){t.call(null,e||function(){return 1},1)})},$l=ve,qB=rs,XB=dt,fp=function(n){return qB.slice(0,n.length)===n},bE=fp("Bun/")?"BUN":fp("Cloudflare-Workers")?"CLOUDFLARE":fp("Deno/")?"DENO":fp("Node.js/")?"NODE":$l.Bun&&typeof Bun.version=="string"?"BUN":$l.Deno&&typeof Deno.version=="object"?"DENO":XB($l.process)==="process"?"NODE":$l.window&&$l.document?"BROWSER":"REST",mp=bE==="NODE",JB=YB.left;qe({target:"Array",proto:!0,forced:!mp&&Fa>79&&Fa<83||!_p("reduce")},{reduce:function(n){var e=arguments.length;return JB(this,n,e,e>1?arguments[1]:void 0)}});var QB=ln("Array","reduce"),ZB=me,$B=QB,OE=Array.prototype,ej=function(n){var e=n.reduce;return n===OE||ZB(OE,n)&&e===OE.reduce?$B:e},kI=ej,un=A(kI),tj=dt,eu=Array.isArray||function(n){return tj(n)==="Array"},ij=qe,rj=eu,nj=he([].reverse),MI=[1,2];ij({target:"Array",proto:!0,forced:String(MI)===String(MI.reverse())},{reverse:function(){return rj(this)&&(this.length=this.length),nj(this)}});var oj=ln("Array","reverse"),sj=me,aj=oj,NE=Array.prototype,cj=function(n){var e=n.reverse;return n===NE||sj(NE,n)&&e===NE.reverse?aj:e},UI=cj,xI=A(UI),dj=hE,VI=sd("keys"),Ep=function(n){return VI[n]||(VI[n]=dj(n))},lj=!P(function(){function n(){}return n.prototype.constructor=null,Object.getPrototypeOf(new n)!==n.prototype}),uj=Bi,hj=ci,pj=Co,_j=lj,FI=Ep("IE_PROTO"),DE=Object,fj=DE.prototype,PE=_j?DE.getPrototypeOf:function(n){var e=pj(n);if(uj(e,FI))return e[FI];var t=e.constructor;return hj(t)&&e instanceof t?t.prototype:e instanceof DE?fj:null},mj=he,Ej=Zr,gj=ir,Sj=function(n){return gj(n)||n===null},Tj=String,Rj=TypeError,vj=function(n,e,t){try{return mj(Ej(Object.getOwnPropertyDescriptor(n,e)[t]))}catch{}},Cj=ir,yj=Vs,Ij=function(n){if(Sj(n))return n;throw new Rj("Can't set "+Tj(n)+" as a prototype")},Aj=Object.setPrototypeOf||("__proto__"in{}?function(){var n,e=!1,t={};try{(n=vj(Object.prototype,"__proto__","set"))(t,[]),e=t instanceof Array}catch{}return function(i,r){return yj(i),Ij(r),Cj(i)&&(e?n(i,r):i.__proto__=r),i}}():void 0),gp={},Sp={},LE=Bi,wj=Fs,bj=CE.indexOf,Oj=Sp,BI=he([].push),jI=function(n,e){var t,i=wj(n),r=0,o=[];for(t in i)!LE(Oj,t)&&LE(i,t)&&BI(o,t);for(;e.length>r;)LE(i,t=e[r++])&&(~bj(o,t)||BI(o,t));return o},kE=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Nj=jI,Dj=kE.concat("length","prototype");gp.f=Object.getOwnPropertyNames||function(n){return Nj(n,Dj)};var tu={};tu.f=Object.getOwnPropertySymbols;var Pj=Sr,Lj=gp,kj=tu,Mj=Ur,Uj=he([].concat),xj=Pj("Reflect","ownKeys")||function(n){var e=Lj.f(Mj(n)),t=kj.f;return t?Uj(e,t(n)):e},GI=Bi,Vj=xj,Fj=Va,Bj=Mn,ME={},jj=jI,Gj=kE,Tp=Object.keys||function(n){return jj(n,Gj)},Wj=ur,Hj=yI,Kj=Mn,Yj=Ur,zj=Fs,qj=Tp;ME.f=Wj&&!Hj?Object.defineProperties:function(n,e){Yj(n);for(var t,i=zj(e),r=qj(e),o=r.length,s=0;o>s;)Kj.f(n,t=r[s++],i[t]);return n};var Rp,WI=Sr("document","documentElement"),Xj=Ur,Jj=ME,HI=kE,Qj=Sp,Zj=WI,$j=mE,UE="prototype",xE="script",KI=Ep("IE_PROTO"),VE=function(){},YI=function(n){return"<"+xE+">"+n+"</"+xE+">"},zI=function(n){n.write(YI("")),n.close();var e=n.parentWindow.Object;return n=null,e},vp=function(){try{Rp=new ActiveXObject("htmlfile")}catch{}var n,e,t;vp=typeof document<"u"?document.domain&&Rp?zI(Rp):(e=$j("iframe"),t="java"+xE+":",e.style.display="none",Zj.appendChild(e),e.src=String(t),(n=e.contentWindow.document).open(),n.write(YI("document.F=Object")),n.close(),n.F):zI(Rp);for(var i=HI.length;i--;)delete vp[UE][HI[i]];return vp()};Qj[KI]=!0;var iu=Object.create||function(n,e){var t;return n!==null?(VE[UE]=Xj(n),t=new VE,VE[UE]=null,t[KI]=n):t=vp(),e===void 0?t:Jj.f(t,e)},e3=ir,t3=Ba,qI=Error,i3=he("".replace),r3=String(new qI("zxcasd").stack),XI=/\n\s*at [^:]*:[^\n]*/,n3=XI.test(r3),o3=kn,s3=!P(function(){var n=new Error("a");return!("stack"in n)||(Object.defineProperty(n,"stack",o3(1,7)),n.stack!==7)}),a3=Ba,c3=function(n,e){if(n3&&typeof n=="string"&&!qI.prepareStackTrace)for(;e--;)n=i3(n,XI,"");return n},d3=s3,JI=Error.captureStackTrace,ld={},l3=ld,u3=qt("iterator"),h3=Array.prototype,QI=function(n){return n!==void 0&&(l3.Array===n||h3[u3]===n)},p3=Gs,ZI=Jl,_3=up,f3=ld,m3=qt("iterator"),Cp=function(n){if(!_3(n))return ZI(n,m3)||ZI(n,"@@iterator")||f3[p3(n)]},E3=gi,g3=Zr,S3=Ur,T3=od,R3=Cp,v3=TypeError,FE=function(n,e){var t=arguments.length<2?R3(n):e;if(g3(t))return S3(E3(t,n));throw new v3(T3(n)+" is not iterable")},C3=gi,$I=Ur,y3=Jl,eA=function(n,e,t){var i,r;$I(n);try{if(!(i=y3(n,"return"))){if(e==="throw")throw t;return t}i=C3(i,n)}catch(o){r=!0,i=o}if(e==="throw")throw t;if(r)throw i;return $I(i),t},I3=Bs,A3=gi,w3=Ur,b3=od,O3=QI,N3=js,tA=me,D3=FE,P3=Cp,iA=eA,L3=TypeError,yp=function(n,e){this.stopped=n,this.result=e},rA=yp.prototype,ru=function(n,e,t){var i,r,o,s,a,c,d,l=t&&t.that,h=!(!t||!t.AS_ENTRIES),p=!(!t||!t.IS_RECORD),f=!(!t||!t.IS_ITERATOR),m=!(!t||!t.INTERRUPTED),g=I3(e,l),S=function(C){return i&&iA(i,"normal"),new yp(!0,C)},T=function(C){return h?(w3(C),m?g(C[0],C[1],S):g(C[0],C[1])):m?g(C,S):g(C)};if(p)i=n.iterator;else if(f)i=n;else{if(!(r=P3(n)))throw new L3(b3(n)+" is not iterable");if(O3(r)){for(o=0,s=N3(n);s>o;o++)if((a=T(n[o]))&&tA(rA,a))return a;return new yp(!1)}i=D3(n,r)}for(c=p?n.next:i.next;!(d=A3(c,i)).done;){try{a=T(d.value)}catch(C){iA(i,"throw",C)}if(typeof a=="object"&&a&&tA(rA,a))return a}return new yp(!1)},k3=xr,M3=qe,U3=me,x3=PE,Ip=Aj,V3=function(n,e,t){for(var i=Vj(e),r=Bj.f,o=Fj.f,s=0;s<i.length;s++){var a=i[s];GI(n,a)||t&&GI(t,a)||r(n,a,o(e,a))}},nA=iu,BE=Ba,jE=kn,F3=function(n,e){e3(e)&&"cause"in e&&t3(n,"cause",e.cause)},B3=function(n,e,t,i){d3&&(JI?JI(n,e):a3(n,"stack",c3(t,i)))},j3=ru,G3=function(n,e){return n===void 0?arguments.length<2?"":e:k3(n)},W3=qt("toStringTag"),Ap=Error,H3=[].push,ud=function(n,e){var t,i=U3(GE,this);Ip?t=Ip(new Ap,i?x3(this):GE):(t=i?this:nA(GE),BE(t,W3,"Error")),e!==void 0&&BE(t,"message",G3(e)),B3(t,ud,t.stack,1),arguments.length>2&&F3(t,arguments[2]);var r=[];return j3(n,H3,{that:r}),BE(t,"errors",r),t};Ip?Ip(ud,Ap):V3(ud,Ap,{name:!0});var GE=ud.prototype=nA(Ap.prototype,{constructor:jE(1,ud),message:jE(1,""),name:jE(1,"AggregateError")});M3({global:!0},{AggregateError:ud});var wp,nu,bp,K3=ci,oA=ve.WeakMap,Y3=K3(oA)&&/native code/.test(String(oA)),sA=ve,z3=ir,q3=Ba,WE=Bi,HE=uE,X3=Ep,J3=Sp,aA="Object already initialized",KE=sA.TypeError,Q3=sA.WeakMap;if(Y3||HE.state){var yo=HE.state||(HE.state=new Q3);yo.get=yo.get,yo.has=yo.has,yo.set=yo.set,wp=function(n,e){if(yo.has(n))throw new KE(aA);return e.facade=n,yo.set(n,e),e},nu=function(n){return yo.get(n)||{}},bp=function(n){return yo.has(n)}}else{var hd=X3("state");J3[hd]=!0,wp=function(n,e){if(WE(n,hd))throw new KE(aA);return e.facade=n,q3(n,hd,e),e},nu=function(n){return WE(n,hd)?n[hd]:{}},bp=function(n){return WE(n,hd)}}var ja,cA,dA,Ga={set:wp,get:nu,has:bp,enforce:function(n){return bp(n)?nu(n):wp(n,{})},getterFor:function(n){return function(e){var t;if(!z3(e)||(t=nu(e)).type!==n)throw new KE("Incompatible receiver, "+n+" required");return t}}},YE=ur,Z3=Bi,lA=Function.prototype,$3=YE&&Object.getOwnPropertyDescriptor,uA=Z3(lA,"name"),hA={PROPER:uA&&(function(){}).name==="something",CONFIGURABLE:uA&&(!YE||YE&&$3(lA,"name").configurable)},eG=Ba,Ws=function(n,e,t,i){return i&&i.enumerable?n[e]=t:eG(n,e,t),n},tG=P,iG=ci,rG=ir,nG=iu,pA=PE,oG=Ws,zE=qt("iterator"),_A=!1;[].keys&&("next"in(dA=[].keys())?(cA=pA(pA(dA)))!==Object.prototype&&(ja=cA):_A=!0);var sG=!rG(ja)||tG(function(){var n={};return ja[zE].call(n)!==n});iG((ja=sG?{}:nG(ja))[zE])||oG(ja,zE,function(){return this});var fA={IteratorPrototype:ja,BUGGY_SAFARI_ITERATORS:_A},aG=Gs,cG=IE?{}.toString:function(){return"[object "+aG(this)+"]"},dG=IE,lG=Mn.f,uG=Ba,hG=Bi,pG=cG,mA=qt("toStringTag"),ns=function(n,e,t,i){var r=t?n:n&&n.prototype;r&&(hG(r,mA)||lG(r,mA,{configurable:!0,value:e}),i&&!dG&&uG(r,"toString",pG))},_G=fA.IteratorPrototype,fG=iu,mG=kn,EG=ns,gG=ld,SG=function(){return this},qE=function(n,e,t,i){var r=e+" Iterator";return n.prototype=fG(_G,{next:mG(+!i,t)}),EG(n,r,!1,!0),gG[r]=SG,n},TG=qe,RG=gi,vG=hA,CG=qE,yG=PE,IG=ns,EA=Ws,gA=ld,AG=fA,wG=vG.PROPER,Op=AG.BUGGY_SAFARI_ITERATORS,XE=qt("iterator"),SA="keys",Np="values",TA="entries",bG=function(){return this},RA=function(n,e,t,i,r,o,s){CG(t,e,i);var a,c,d,l=function(T){if(T===r&&g)return g;if(!Op&&T&&T in f)return f[T];switch(T){case SA:case Np:case TA:return function(){return new t(this,T)}}return function(){return new t(this)}},h=e+" Iterator",p=!1,f=n.prototype,m=f[XE]||f["@@iterator"]||r&&f[r],g=!Op&&m||l(r),S=e==="Array"&&f.entries||m;if(S&&(a=yG(S.call(new n)))!==Object.prototype&&a.next&&(IG(a,h,!0,!0),gA[h]=bG),wG&&r===Np&&m&&m.name!==Np&&(p=!0,g=function(){return RG(m,this)}),r)if(c={values:l(Np),keys:o?g:l(SA),entries:l(TA)},s)for(d in c)(Op||p||!(d in f))&&EA(f,d,c[d]);else TG({target:e,proto:!0,forced:Op||p},c);return s&&f[XE]!==g&&EA(f,XE,g,{}),gA[e]=g,c},Dp=function(n,e){return{value:n,done:e}},OG=Fs,vA=ld,CA=Ga;Mn.f;var NG=RA,Pp=Dp,yA="Array Iterator",DG=CA.set,PG=CA.getterFor(yA);NG(Array,"Array",function(n,e){DG(this,{type:yA,target:OG(n),index:0,kind:e})},function(){var n=PG(this),e=n.target,t=n.index++;if(!e||t>=e.length)return n.target=null,Pp(void 0,!0);switch(n.kind){case"keys":return Pp(t,!1);case"values":return Pp(e[t],!1)}return Pp([t,e[t]],!1)},"values"),vA.Arguments=vA.Array;var LG=Mn,Lp=function(n,e,t){return LG.f(n,e,t)},kG=Sr,MG=Lp,UG=ur,IA=qt("species"),xG=me,VG=TypeError,JE=function(n,e){if(xG(e,n))return n;throw new VG("Incorrect invocation")},FG=ci,QE=uE,BG=he(Function.toString);FG(QE.inspectSource)||(QE.inspectSource=function(n){return BG(n)});var AA=QE.inspectSource,jG=he,GG=P,wA=ci,WG=Gs,HG=AA,bA=function(){},OA=Sr("Reflect","construct"),ZE=/^\s*(?:class|function)\b/,KG=jG(ZE.exec),YG=!ZE.test(bA),ou=function(n){if(!wA(n))return!1;try{return OA(bA,[],n),!0}catch{return!1}},NA=function(n){if(!wA(n))return!1;switch(WG(n)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return YG||!!KG(ZE,HG(n))}catch{return!0}};NA.sham=!0;var su,pd,DA,$E,kp=!OA||GG(function(){var n;return ou(ou.call)||!ou(Object)||!ou(function(){n=!0})||n})?NA:ou,zG=kp,qG=od,XG=TypeError,PA=Ur,JG=function(n){if(zG(n))return n;throw new XG(qG(n)+" is not a constructor")},QG=up,ZG=qt("species"),eg=function(n,e){var t,i=PA(n).constructor;return i===void 0||QG(t=PA(i)[ZG])?e:JG(t)},Hs=he([].slice),$G=TypeError,Wa=function(n,e){if(n<e)throw new $G("Not enough arguments");return n},LA=/(?:ipad|iphone|ipod).*applewebkit/i.test(rs),hn=ve,e4=fe,t4=Bs,kA=ci,i4=Bi,MA=P,UA=WI,r4=Hs,xA=mE,n4=Wa,o4=LA,s4=mp,tg=hn.setImmediate,ig=hn.clearImmediate,a4=hn.process,rg=hn.Dispatch,c4=hn.Function,VA=hn.MessageChannel,d4=hn.String,ng=0,au={},FA="onreadystatechange";MA(function(){su=hn.location});var og=function(n){if(i4(au,n)){var e=au[n];delete au[n],e()}},sg=function(n){return function(){og(n)}},BA=function(n){og(n.data)},jA=function(n){hn.postMessage(d4(n),su.protocol+"//"+su.host)};tg&&ig||(tg=function(n){n4(arguments.length,1);var e=kA(n)?n:c4(n),t=r4(arguments,1);return au[++ng]=function(){e4(e,void 0,t)},pd(ng),ng},ig=function(n){delete au[n]},s4?pd=function(n){a4.nextTick(sg(n))}:rg&&rg.now?pd=function(n){rg.now(sg(n))}:VA&&!o4?($E=(DA=new VA).port2,DA.port1.onmessage=BA,pd=t4($E.postMessage,$E)):hn.addEventListener&&kA(hn.postMessage)&&!hn.importScripts&&su&&su.protocol!=="file:"&&!MA(jA)?(pd=jA,hn.addEventListener("message",BA,!1)):pd=FA in xA("script")?function(n){UA.appendChild(xA("script"))[FA]=function(){UA.removeChild(this),og(n)}}:function(n){setTimeout(sg(n),0)});var Mp={set:tg,clear:ig},GA=ve,l4=ur,u4=Object.getOwnPropertyDescriptor,WA=function(n){if(!l4)return GA[n];var e=u4(GA,n);return e&&e.value},HA=function(){this.head=null,this.tail=null};HA.prototype={add:function(n){var e={item:n,next:null},t=this.tail;t?t.next=e:this.head=e,this.tail=e},get:function(){var n=this.head;if(n)return(this.head=n.next)===null&&(this.tail=null),n.item}};var _d,ag,cg,dg,KA,YA=HA,h4=/ipad|iphone|ipod/i.test(rs)&&typeof Pebble<"u",p4=/web0s(?!.*chrome)/i.test(rs),fd=ve,_4=WA,zA=Bs,lg=Mp.set,f4=YA,m4=LA,E4=h4,g4=p4,ug=mp,qA=fd.MutationObserver||fd.WebKitMutationObserver,XA=fd.document,JA=fd.process,Up=fd.Promise,hg=_4("queueMicrotask");if(!hg){var xp=new f4,Vp=function(){var n,e;for(ug&&(n=JA.domain)&&n.exit();e=xp.get();)try{e()}catch(t){throw xp.head&&_d(),t}n&&n.enter()};m4||ug||g4||!qA||!XA?!E4&&Up&&Up.resolve?((dg=Up.resolve(void 0)).constructor=Up,KA=zA(dg.then,dg),_d=function(){KA(Vp)}):ug?_d=function(){JA.nextTick(Vp)}:(lg=zA(lg,fd),_d=function(){lg(Vp)}):(ag=!0,cg=XA.createTextNode(""),new qA(Vp).observe(cg,{characterData:!0}),_d=function(){cg.data=ag=!ag}),hg=function(n){xp.head||_d(),xp.add(n)}}var QA=hg,md=function(n){try{return{error:!1,value:n()}}catch(e){return{error:!0,value:e}}},Ha=ve.Promise,S4=ve,cu=Ha,T4=ci,R4=CI,v4=AA,C4=qt,ZA=bE,pg=Fa,$A=cu&&cu.prototype,y4=C4("species"),ew=T4(S4.PromiseRejectionEvent),I4=R4("Promise",function(){var n=v4(cu),e=n!==String(cu);if(!e&&pg===66||!$A.catch||!$A.finally)return!0;if(!pg||pg<51||!/native code/.test(n)){var t=new cu(function(r){r(1)}),i=function(r){r(function(){},function(){})};if((t.constructor={})[y4]=i,!(t.then(function(){})instanceof i))return!0}return!(e||ZA!=="BROWSER"&&ZA!=="DENO"||ew)}),du={CONSTRUCTOR:I4,REJECTION_EVENT:ew},Io={},tw=Zr,A4=TypeError,w4=function(n){var e,t;this.promise=new n(function(i,r){if(e!==void 0||t!==void 0)throw new A4("Bad Promise constructor");e=i,t=r}),this.resolve=tw(e),this.reject=tw(t)};Io.f=function(n){return new w4(n)};var _g,iw,rw,b4=qe,Fp=mp,Ks=ve,O4=Qr,lu=gi,N4=Ws,D4=ns,P4=function(n){var e=kG(n);UG&&e&&!e[IA]&&MG(e,IA,{configurable:!0,get:function(){return this}})},L4=Zr,fg=ci,k4=ir,M4=JE,U4=eg,nw=Mp.set,mg=QA,x4=function(n,e){try{arguments.length===1?console.error(n):console.error(n,e)}catch{}},V4=md,F4=YA,ow=Ga,Eg=Ha,sw=du,aw=Io,Bp="Promise",cw=sw.CONSTRUCTOR,B4=sw.REJECTION_EVENT,gg=ow.getterFor(Bp),j4=ow.set,G4=Eg&&Eg.prototype,uu=Eg,Sg=G4,dw=Ks.TypeError,Tg=Ks.document,Rg=Ks.process,vg=aw.f,W4=vg,H4=!!(Tg&&Tg.createEvent&&Ks.dispatchEvent),lw="unhandledrejection",uw=function(n){var e;return!(!k4(n)||!fg(e=n.then))&&e},hw=function(n,e){var t,i,r,o=e.value,s=e.state===1,a=s?n.ok:n.fail,c=n.resolve,d=n.reject,l=n.domain;try{a?(s||(e.rejection===2&&Y4(e),e.rejection=1),a===!0?t=o:(l&&l.enter(),t=a(o),l&&(l.exit(),r=!0)),t===n.promise?d(new dw("Promise-chain cycle")):(i=uw(t))?lu(i,t,c,d):c(t)):d(o)}catch(h){l&&!r&&l.exit(),d(h)}},pw=function(n,e){n.notified||(n.notified=!0,mg(function(){for(var t,i=n.reactions;t=i.get();)hw(t,n);n.notified=!1,e&&!n.rejection&&K4(n)}))},_w=function(n,e,t){var i,r;H4?((i=Tg.createEvent("Event")).promise=e,i.reason=t,i.initEvent(n,!1,!0),Ks.dispatchEvent(i)):i={promise:e,reason:t},!B4&&(r=Ks["on"+n])?r(i):n===lw&&x4("Unhandled promise rejection",t)},K4=function(n){lu(nw,Ks,function(){var e,t=n.facade,i=n.value;if(fw(n)&&(e=V4(function(){Fp?Rg.emit("unhandledRejection",i,t):_w(lw,t,i)}),n.rejection=Fp||fw(n)?2:1,e.error))throw e.value})},fw=function(n){return n.rejection!==1&&!n.parent},Y4=function(n){lu(nw,Ks,function(){var e=n.facade;Fp?Rg.emit("rejectionHandled",e):_w("rejectionhandled",e,n.value)})},Ed=function(n,e,t){return function(i){n(e,i,t)}},gd=function(n,e,t){n.done||(n.done=!0,t&&(n=t),n.value=e,n.state=2,pw(n,!0))},Cg=function(n,e,t){if(!n.done){n.done=!0,t&&(n=t);try{if(n.facade===e)throw new dw("Promise can't be resolved itself");var i=uw(e);i?mg(function(){var r={done:!1};try{lu(i,e,Ed(Cg,r,n),Ed(gd,r,n))}catch(o){gd(r,o,n)}}):(n.value=e,n.state=1,pw(n,!1))}catch(r){gd({done:!1},r,n)}}};cw&&(Sg=(uu=function(n){M4(this,Sg),L4(n),lu(_g,this);var e=gg(this);try{n(Ed(Cg,e),Ed(gd,e))}catch(t){gd(e,t)}}).prototype,(_g=function(n){j4(this,{type:Bp,done:!1,notified:!1,parent:!1,reactions:new F4,rejection:!1,state:0,value:null})}).prototype=N4(Sg,"then",function(n,e){var t=gg(this),i=vg(U4(this,uu));return t.parent=!0,i.ok=!fg(n)||n,i.fail=fg(e)&&e,i.domain=Fp?Rg.domain:void 0,t.state===0?t.reactions.add(i):mg(function(){hw(i,t)}),i.promise}),iw=function(){var n=new _g,e=gg(n);this.promise=n,this.resolve=Ed(Cg,e),this.reject=Ed(gd,e)},aw.f=vg=function(n){return n===uu||n===rw?new iw(n):W4(n)}),b4({global:!0,wrap:!0,forced:cw},{Promise:uu}),rw=O4.Promise,D4(uu,Bp,!1,!0),P4(Bp);var mw=qt("iterator"),Ew=!1;try{var z4=0,gw={next:function(){return{done:!!z4++}},return:function(){Ew=!0}};gw[mw]=function(){return this},Array.from(gw,function(){throw 2})}catch{}var q4=Ha,X4=function(n,e){try{if(!e&&!Ew)return!1}catch{return!1}var t=!1;try{var i={};i[mw]=function(){return{next:function(){return{done:t=!0}}}},n(i)}catch{}return t},jp=du.CONSTRUCTOR||!X4(function(n){q4.all(n).then(void 0,function(){})}),J4=gi,Q4=Zr,Z4=Io,$4=md,e5=ru;qe({target:"Promise",stat:!0,forced:jp},{all:function(n){var e=this,t=Z4.f(e),i=t.resolve,r=t.reject,o=$4(function(){var s=Q4(e.resolve),a=[],c=0,d=1;e5(n,function(l){var h=c++,p=!1;d++,J4(s,e,l).then(function(f){p||(p=!0,a[h]=f,--d||i(a))},r)}),--d||i(a)});return o.error&&r(o.value),t.promise}});var t5=qe,i5=du.CONSTRUCTOR;Ha&&Ha.prototype,t5({target:"Promise",proto:!0,forced:i5,real:!0},{catch:function(n){return this.then(void 0,n)}});var r5=gi,n5=Zr,o5=Io,s5=md,a5=ru;qe({target:"Promise",stat:!0,forced:jp},{race:function(n){var e=this,t=o5.f(e),i=t.reject,r=s5(function(){var o=n5(e.resolve);a5(n,function(s){r5(o,e,s).then(t.resolve,i)})});return r.error&&i(r.value),t.promise}});var c5=Io;qe({target:"Promise",stat:!0,forced:du.CONSTRUCTOR},{reject:function(n){var e=c5.f(this);return(0,e.reject)(n),e.promise}});var d5=Ur,l5=ir,u5=Io,Sw=function(n,e){if(d5(n),l5(e)&&e.constructor===n)return e;var t=u5.f(n);return(0,t.resolve)(e),t.promise},h5=qe,p5=Ha,_5=du.CONSTRUCTOR,f5=Sw,m5=Sr("Promise"),E5=!_5;h5({target:"Promise",stat:!0,forced:!0},{resolve:function(n){return f5(E5&&this===m5?p5:this,n)}});var g5=gi,S5=Zr,T5=Io,R5=md,v5=ru;qe({target:"Promise",stat:!0,forced:jp},{allSettled:function(n){var e=this,t=T5.f(e),i=t.resolve,r=t.reject,o=R5(function(){var s=S5(e.resolve),a=[],c=0,d=1;v5(n,function(l){var h=c++,p=!1;d++,g5(s,e,l).then(function(f){p||(p=!0,a[h]={status:"fulfilled",value:f},--d||i(a))},function(f){p||(p=!0,a[h]={status:"rejected",reason:f},--d||i(a))})}),--d||i(a)});return o.error&&r(o.value),t.promise}});var C5=gi,y5=Zr,I5=Sr,A5=Io,w5=md,b5=ru,Tw="No one promise resolved";qe({target:"Promise",stat:!0,forced:jp},{any:function(n){var e=this,t=I5("AggregateError"),i=A5.f(e),r=i.resolve,o=i.reject,s=w5(function(){var a=y5(e.resolve),c=[],d=0,l=1,h=!1;b5(n,function(p){var f=d++,m=!1;l++,C5(a,e,p).then(function(g){m||h||(h=!0,r(g))},function(g){m||h||(m=!0,c[f]=g,--l||o(new t(c,Tw)))})}),--l||o(new t(c,Tw))});return s.error&&o(s.value),i.promise}});var O5=qe,N5=fe,D5=Hs,P5=Io,L5=Zr,Rw=md,yg=ve.Promise,vw=!1;O5({target:"Promise",stat:!0,forced:!yg||!yg.try||Rw(function(){yg.try(function(n){vw=n===8},8)}).error||!vw},{try:function(n){var e=arguments.length>1?D5(arguments,1):[],t=P5.f(this),i=Rw(function(){return N5(L5(n),void 0,e)});return(i.error?t.reject:t.resolve)(i.value),t.promise}});var k5=Io;qe({target:"Promise",stat:!0},{withResolvers:function(){var n=k5.f(this);return{promise:n.promise,resolve:n.resolve,reject:n.reject}}});var M5=qe,Ig=Ha,U5=P,x5=Sr,V5=ci,F5=eg,Cw=Sw,B5=Ig&&Ig.prototype;M5({target:"Promise",proto:!0,real:!0,forced:!!Ig&&U5(function(){B5.finally.call({then:function(){}},function(){})})},{finally:function(n){var e=F5(this,x5("Promise")),t=V5(n);return this.then(t?function(i){return Cw(e,n()).then(function(){return i})}:n,t?function(i){return Cw(e,n()).then(function(){throw i})}:n)}});var Ag=he,j5=RE,G5=xr,W5=Vs,H5=Ag("".charAt),yw=Ag("".charCodeAt),K5=Ag("".slice),Iw=function(n){return function(e,t){var i,r,o=G5(W5(e)),s=j5(t),a=o.length;return s<0||s>=a?n?"":void 0:(i=yw(o,s))<55296||i>56319||s+1===a||(r=yw(o,s+1))<56320||r>57343?n?H5(o,s):i:n?K5(o,s,s+2):r-56320+(i-55296<<10)+65536}},wg={codeAt:Iw(!1),charAt:Iw(!0)},Y5=wg.charAt,z5=xr,Aw=Ga,q5=RA,ww=Dp,bw="String Iterator",X5=Aw.set,J5=Aw.getterFor(bw);q5(String,"String",function(n){X5(this,{type:bw,string:z5(n),index:0})},function(){var n,e=J5(this),t=e.string,i=e.index;return i>=t.length?ww(void 0,!0):(n=Y5(t,i),e.index+=n.length,ww(n,!1))});var Q5=Qr.Promise,Z5={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},$5=ve,eW=ns,Ow=ld;for(var bg in Z5)eW($5[bg],bg),Ow[bg]=Ow.Array;var Nw=Q5,Z=A(Nw),tW=ln("Array","values"),iW=Gs,rW=Bi,nW=me,oW=tW,Og=Array.prototype,sW={DOMTokenList:!0,NodeList:!0},aW=function(n){var e=n.values;return n===Og||nW(Og,n)&&e===Og.values||rW(sW,iW(n))?oW:e},Vr=A(aW),Dw=od,cW=TypeError,Pw=Hs,dW=Math.floor,Ng=function(n,e){var t=n.length;if(t<8)for(var i,r,o=1;o<t;){for(r=o,i=n[o];r&&e(n[r-1],i)>0;)n[r]=n[--r];r!==o++&&(n[r]=i)}else for(var s=dW(t/2),a=Ng(Pw(n,0,s),e),c=Ng(Pw(n,s),e),d=a.length,l=c.length,h=0,p=0;h<d||p<l;)n[h+p]=h<d&&p<l?e(a[h],c[p])<=0?a[h++]:c[p++]:h<d?a[h++]:c[p++];return n},Lw=Ng,kw=rs.match(/firefox\/(\d+)/i),lW=!!kw&&+kw[1],uW=/MSIE|Trident/.test(rs),Mw=rs.match(/AppleWebKit\/(\d+)\./),hW=!!Mw&&+Mw[1],pW=qe,Uw=he,_W=Zr,fW=Co,xw=js,mW=function(n,e){if(!delete n[e])throw new cW("Cannot delete property "+Dw(e)+" of "+Dw(n))},Vw=xr,Dg=P,EW=Lw,gW=_p,Fw=lW,SW=uW,Bw=Fa,jw=hW,Ys=[],Gw=Uw(Ys.sort),TW=Uw(Ys.push),RW=Dg(function(){Ys.sort(void 0)}),vW=Dg(function(){Ys.sort(null)}),CW=gW("sort"),Ww=!Dg(function(){if(Bw)return Bw<70;if(!(Fw&&Fw>3)){if(SW)return!0;if(jw)return jw<603;var n,e,t,i,r="";for(n=65;n<76;n++){switch(e=String.fromCharCode(n),n){case 66:case 69:case 70:case 72:t=3;break;case 68:case 71:t=4;break;default:t=2}for(i=0;i<47;i++)Ys.push({k:e+i,v:t})}for(Ys.sort(function(o,s){return s.v-o.v}),i=0;i<Ys.length;i++)e=Ys[i].k.charAt(0),r.charAt(r.length-1)!==e&&(r+=e);return r!=="DGBEFHACIJK"}});pW({target:"Array",proto:!0,forced:RW||!vW||!CW||!Ww},{sort:function(n){n!==void 0&&_W(n);var e=fW(this);if(Ww)return n===void 0?Gw(e):Gw(e,n);var t,i,r=[],o=xw(e);for(i=0;i<o;i++)i in e&&TW(r,e[i]);for(EW(r,function(s){return function(a,c){return c===void 0?-1:a===void 0?1:s!==void 0?+s(a,c)||0:Vw(a)>Vw(c)?1:-1}}(n)),t=xw(r),i=0;i<t;)e[i]=r[i++];for(;i<o;)mW(e,i++);return e}});var yW=ln("Array","sort"),IW=me,AW=yW,Pg=Array.prototype,wW=function(n){var e=n.sort;return n===Pg||IW(Pg,n)&&e===Pg.sort?AW:e},Ka=A(wW),bW=qe,OW=he,NW=vE,DW=RangeError,Hw=String.fromCharCode,Kw=String.fromCodePoint,PW=OW([].join);bW({target:"String",stat:!0,forced:!!Kw&&Kw.length!==1},{fromCodePoint:function(n){for(var e,t=[],i=arguments.length,r=0;i>r;){if(e=+arguments[r++],NW(e,1114111)!==e)throw new DW(e+" is not a valid code point");t[r]=e<65536?Hw(e):Hw(55296+((e-=65536)>>10),e%1024+56320)}return PW(t,"")}});var LW=P,kW=qt("iterator"),Gp=!LW(function(){var n=new URL("b?a=1&b=2&c=3","https://a"),e=n.searchParams,t=new URLSearchParams("a=1&a=2&b=3"),i="";return n.pathname="c%20d",e.forEach(function(r,o){e.delete("b"),i+=o+r}),t.delete("a",2),t.delete("b",void 0),!n.toJSON||!t.has("a",1)||t.has("a",2)||!t.has("a",void 0)||t.has("b")||!e.size&&!0||!e.sort||n.href!=="https://a/c%20d?a=1&c=3"||e.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!e[kW]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("https://").host!=="xn--e1aybc"||new URL("https://a#").hash!=="#%D0%B1"||i!=="a1c3"||new URL("https://x",void 0).host!=="x"}),MW=Ws,Lg=qe,Yw=ve,kg=WA,UW=Sr,Wp=gi,ro=he,hu=ur,zw=Gp,qw=Ws,xW=Lp,VW=function(n,e,t){for(var i in e)t&&t.unsafe&&n[i]?n[i]=e[i]:MW(n,i,e[i],t);return n},FW=ns,BW=qE,Mg=Ga,Xw=JE,Ug=ci,jW=Bi,GW=Bs,WW=Gs,HW=Ur,Jw=ir,Fr=xr,KW=iu,Qw=kn,Zw=FE,YW=Cp,Hp=Dp,Sd=Wa,zW=Lw,qW=qt("iterator"),Td="URLSearchParams",$w=Td+"Iterator",eb=Mg.set,Un=Mg.getterFor(Td),XW=Mg.getterFor($w),tb=kg("fetch"),Kp=kg("Request"),pu=kg("Headers"),xg=Kp&&Kp.prototype,ib=pu&&pu.prototype,JW=Yw.TypeError,QW=Yw.encodeURIComponent,ZW=String.fromCharCode,$W=UW("String","fromCodePoint"),e6=parseInt,Yp=ro("".charAt),rb=ro([].join),zs=ro([].push),nb=ro("".replace),t6=ro([].shift),ob=ro([].splice),sb=ro("".split),ab=ro("".slice),i6=ro(/./.exec),r6=/\+/g,n6=/^[0-9a-f]+$/i,cb=function(n,e){var t=ab(n,e,e+2);return i6(n6,t)?e6(t,16):NaN},o6=function(n){for(var e=0,t=128;t>0&&n&t;t>>=1)e++;return e},s6=function(n){var e=null;switch(n.length){case 1:e=n[0];break;case 2:e=(31&n[0])<<6|63&n[1];break;case 3:e=(15&n[0])<<12|(63&n[1])<<6|63&n[2];break;case 4:e=(7&n[0])<<18|(63&n[1])<<12|(63&n[2])<<6|63&n[3]}return e>1114111?null:e},db=function(n){for(var e=(n=nb(n,r6," ")).length,t="",i=0;i<e;){var r=Yp(n,i);if(r==="%"){if(Yp(n,i+1)==="%"||i+3>e){t+="%",i++;continue}var o=cb(n,i+1);if(o!=o){t+=r,i++;continue}i+=2;var s=o6(o);if(s===0)r=ZW(o);else{if(s===1||s>4){t+="",i++;continue}for(var a=[o],c=1;c<s&&!(++i+3>e||Yp(n,i)!=="%");){var d=cb(n,i+1);if(d!=d){i+=3;break}if(d>191||d<128)break;zs(a,d),i+=2,c++}if(a.length!==s){t+="";continue}var l=s6(a);l===null?t+="":r=$W(l)}}t+=r,i++}return t},a6=/[!'()~]|%20/g,c6={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},d6=function(n){return c6[n]},lb=function(n){return nb(QW(n),a6,d6)},Vg=BW(function(n,e){eb(this,{type:$w,target:Un(n).entries,index:0,kind:e})},Td,function(){var n=XW(this),e=n.target,t=n.index++;if(!e||t>=e.length)return n.target=null,Hp(void 0,!0);var i=e[t];switch(n.kind){case"keys":return Hp(i.key,!1);case"values":return Hp(i.value,!1)}return Hp([i.key,i.value],!1)},!0),ub=function(n){this.entries=[],this.url=null,n!==void 0&&(Jw(n)?this.parseObject(n):this.parseQuery(typeof n=="string"?Yp(n,0)==="?"?ab(n,1):n:Fr(n)))};ub.prototype={type:Td,bindURL:function(n){this.url=n,this.update()},parseObject:function(n){var e,t,i,r,o,s,a,c=this.entries,d=YW(n);if(d)for(t=(e=Zw(n,d)).next;!(i=Wp(t,e)).done;){if(o=(r=Zw(HW(i.value))).next,(s=Wp(o,r)).done||(a=Wp(o,r)).done||!Wp(o,r).done)throw new JW("Expected sequence with length 2");zs(c,{key:Fr(s.value),value:Fr(a.value)})}else for(var l in n)jW(n,l)&&zs(c,{key:l,value:Fr(n[l])})},parseQuery:function(n){if(n)for(var e,t,i=this.entries,r=sb(n,"&"),o=0;o<r.length;)(e=r[o++]).length&&(t=sb(e,"="),zs(i,{key:db(t6(t)),value:db(rb(t,"="))}))},serialize:function(){for(var n,e=this.entries,t=[],i=0;i<e.length;)n=e[i++],zs(t,lb(n.key)+"="+lb(n.value));return rb(t,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var zp=function(){Xw(this,Rd);var n=eb(this,new ub(arguments.length>0?arguments[0]:void 0));hu||(this.size=n.entries.length)},Rd=zp.prototype;if(VW(Rd,{append:function(n,e){var t=Un(this);Sd(arguments.length,2),zs(t.entries,{key:Fr(n),value:Fr(e)}),hu||this.length++,t.updateURL()},delete:function(n){for(var e=Un(this),t=Sd(arguments.length,1),i=e.entries,r=Fr(n),o=t<2?void 0:arguments[1],s=o===void 0?o:Fr(o),a=0;a<i.length;){var c=i[a];if(c.key!==r||s!==void 0&&c.value!==s)a++;else if(ob(i,a,1),s!==void 0)break}hu||(this.size=i.length),e.updateURL()},get:function(n){var e=Un(this).entries;Sd(arguments.length,1);for(var t=Fr(n),i=0;i<e.length;i++)if(e[i].key===t)return e[i].value;return null},getAll:function(n){var e=Un(this).entries;Sd(arguments.length,1);for(var t=Fr(n),i=[],r=0;r<e.length;r++)e[r].key===t&&zs(i,e[r].value);return i},has:function(n){for(var e=Un(this).entries,t=Sd(arguments.length,1),i=Fr(n),r=t<2?void 0:arguments[1],o=r===void 0?r:Fr(r),s=0;s<e.length;){var a=e[s++];if(a.key===i&&(o===void 0||a.value===o))return!0}return!1},set:function(n,e){var t=Un(this);Sd(arguments.length,1);for(var i,r=t.entries,o=!1,s=Fr(n),a=Fr(e),c=0;c<r.length;c++)(i=r[c]).key===s&&(o?ob(r,c--,1):(o=!0,i.value=a));o||zs(r,{key:s,value:a}),hu||(this.size=r.length),t.updateURL()},sort:function(){var n=Un(this);zW(n.entries,function(e,t){return e.key>t.key?1:-1}),n.updateURL()},forEach:function(n){for(var e,t=Un(this).entries,i=GW(n,arguments.length>1?arguments[1]:void 0),r=0;r<t.length;)i((e=t[r++]).value,e.key,this)},keys:function(){return new Vg(this,"keys")},values:function(){return new Vg(this,"values")},entries:function(){return new Vg(this,"entries")}},{enumerable:!0}),qw(Rd,qW,Rd.entries,{}),qw(Rd,"toString",function(){return Un(this).serialize()},{enumerable:!0}),hu&&xW(Rd,"size",{get:function(){return Un(this).entries.length},configurable:!0,enumerable:!0}),FW(zp,Td),Lg({global:!0,forced:!zw},{URLSearchParams:zp}),!zw&&Ug(pu)){var l6=ro(ib.has),u6=ro(ib.set),hb=function(n){if(Jw(n)){var e,t=n.body;if(WW(t)===Td)return e=n.headers?new pu(n.headers):new pu,l6(e,"content-type")||u6(e,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),KW(n,{body:Qw(0,Fr(t)),headers:Qw(0,e)})}return n};if(Ug(tb)&&Lg({global:!0,dontCallGetSet:!0,forced:!0},{fetch:function(n){return tb(n,arguments.length>1?hb(arguments[1]):{})}}),Ug(Kp)){var Fg=function(n){return Xw(this,xg),new Kp(n,arguments.length>1?hb(arguments[1]):{})};xg.constructor=Fg,Fg.prototype=xg,Lg({global:!0,dontCallGetSet:!0,forced:!0},{Request:Fg})}}var xn,h6={URLSearchParams:zp,getState:Un},p6=Qr.URLSearchParams,pb=ur,_6=he,f6=gi,m6=P,Bg=Tp,E6=tu,g6=mt,S6=Co,T6=lp,vd=Object.assign,_b=Object.defineProperty,R6=_6([].concat),v6=!vd||m6(function(){if(pb&&vd({b:1},vd(_b({},"a",{enumerable:!0,get:function(){_b(this,"b",{value:3,enumerable:!1})}}),{b:2})).b!==1)return!0;var n={},e={},t=Symbol("assign detection"),i="abcdefghijklmnopqrst";return n[t]=7,i.split("").forEach(function(r){e[r]=r}),vd({},n)[t]!==7||Bg(vd({},e)).join("")!==i})?function(n,e){for(var t=S6(n),i=arguments.length,r=1,o=E6.f,s=g6.f;i>r;)for(var a,c=T6(arguments[r++]),d=o?R6(Bg(c),o(c)):Bg(c),l=d.length,h=0;l>h;)a=d[h++],pb&&!f6(s,c,a)||(t[a]=c[a]);return t}:vd,C6=Ur,y6=eA,I6=ur,A6=Mn,w6=kn,jg=function(n,e,t){I6?A6.f(n,e,w6(0,t)):n[e]=t},b6=Bs,O6=gi,N6=Co,D6=function(n,e,t,i){try{return i?e(C6(t)[0],t[1]):e(t)}catch(r){y6(n,"throw",r)}},P6=QI,L6=kp,k6=js,fb=jg,M6=FE,U6=Cp,mb=Array,Ya=he,Gg=2147483647,x6=/[^\0-\u007E]/,Eb=/[.\u3002\uFF0E\uFF61]/g,gb="Overflow: input needs wider integers to process",Sb=RangeError,V6=Ya(Eb.exec),Cd=Math.floor,Wg=String.fromCharCode,Tb=Ya("".charCodeAt),Rb=Ya([].join),qs=Ya([].push),F6=Ya("".replace),B6=Ya("".split),j6=Ya("".toLowerCase),vb=function(n){return n+22+75*(n<26)},G6=function(n,e,t){var i=0;for(n=t?Cd(n/700):n>>1,n+=Cd(n/e);n>455;)n=Cd(n/35),i+=36;return Cd(i+36*n/(n+38))},W6=function(n){var e=[];n=function(T){for(var C=[],b=0,D=T.length;b<D;){var x=Tb(T,b++);if(x>=55296&&x<=56319&&b<D){var k=Tb(T,b++);(64512&k)==56320?qs(C,((1023&x)<<10)+(1023&k)+65536):(qs(C,x),b--)}else qs(C,x)}return C}(n);var t,i,r=n.length,o=128,s=0,a=72;for(t=0;t<n.length;t++)(i=n[t])<128&&qs(e,Wg(i));var c=e.length,d=c;for(c&&qs(e,"-");d<r;){var l=Gg;for(t=0;t<n.length;t++)(i=n[t])>=o&&i<l&&(l=i);var h=d+1;if(l-o>Cd((Gg-s)/h))throw new Sb(gb);for(s+=(l-o)*h,o=l,t=0;t<n.length;t++){if((i=n[t])<o&&++s>Gg)throw new Sb(gb);if(i===o){for(var p=s,f=36;;){var m=f<=a?1:f>=a+26?26:f-a;if(p<m)break;var g=p-m,S=36-m;qs(e,Wg(vb(m+g%S))),p=Cd(g/S),f+=36}qs(e,Wg(vb(p))),a=G6(s,h,d===c),s=0,d++}}s++,o++}return Rb(e,"")},H6=qe,Hg=ur,K6=Gp,Kg=ve,Cb=Bs,Vn=he,qp=Ws,Fn=Lp,Y6=JE,Yg=Bi,zg=v6,yd=function(n){var e=N6(n),t=L6(this),i=arguments.length,r=i>1?arguments[1]:void 0,o=r!==void 0;o&&(r=b6(r,i>2?arguments[2]:void 0));var s,a,c,d,l,h,p=U6(e),f=0;if(!p||this===mb&&P6(p))for(s=k6(e),a=t?new this(s):mb(s);s>f;f++)h=o?r(e[f],f):e[f],fb(a,f,h);else for(a=t?new this:[],l=(d=M6(e,p)).next;!(c=O6(l,d)).done;f++)h=o?D6(d,r,[c.value,f],!0):c.value,fb(a,f,h);return a.length=f,a},no=Hs,z6=wg.codeAt,q6=function(n){var e,t,i=[],r=B6(F6(j6(n),Eb,"."),".");for(e=0;e<r.length;e++)t=r[e],qs(i,V6(x6,t)?"xn--"+W6(t):t);return Rb(i,".")},os=xr,X6=ns,J6=Wa,yb=h6,Ib=Ga,Q6=Ib.set,Xp=Ib.getterFor("URL"),Z6=yb.URLSearchParams,$6=yb.getState,_u=Kg.URL,qg=Kg.TypeError,Jp=Kg.parseInt,eH=Math.floor,Ab=Math.pow,Bn=Vn("".charAt),oo=Vn(/./.exec),fu=Vn([].join),tH=Vn(1.1.toString),iH=Vn([].pop),Id=Vn([].push),Xg=Vn("".replace),rH=Vn([].shift),nH=Vn("".split),mu=Vn("".slice),Qp=Vn("".toLowerCase),oH=Vn([].unshift),Jg="Invalid scheme",Ad="Invalid host",wb="Invalid port",bb=/[a-z]/i,sH=/[\d+-.a-z]/i,Qg=/\d/,aH=/^0x/i,cH=/^[0-7]+$/,dH=/^\d+$/,Ob=/^[\da-f]+$/i,lH=/[\0\t\n\r #%/:<>?@[\\\]^|]/,uH=/[\0\t\n\r #/:<>?@[\\\]^|]/,hH=/^[\u0000-\u0020]+/,pH=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,_H=/[\t\n\r]/g,Eu=function(n){var e,t,i,r;if(typeof n=="number"){for(e=[],t=0;t<4;t++)oH(e,n%256),n=eH(n/256);return fu(e,".")}if(typeof n=="object"){for(e="",i=function(o){for(var s=null,a=1,c=null,d=0,l=0;l<8;l++)o[l]!==0?(d>a&&(s=c,a=d),c=null,d=0):(c===null&&(c=l),++d);return d>a?c:s}(n),t=0;t<8;t++)r&&n[t]===0||(r&&(r=!1),i===t?(e+=t?":":"::",r=!0):(e+=tH(n[t],16),t<7&&(e+=":")));return"["+e+"]"}return n},Zp={},Nb=zg({},Zp,{" ":1,'"':1,"<":1,">":1,"`":1}),Db=zg({},Nb,{"#":1,"?":1,"{":1,"}":1}),Zg=zg({},Db,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),Xs=function(n,e){var t=z6(n,0);return t>32&&t<127&&!Yg(e,n)?n:encodeURIComponent(n)},$p={ftp:21,file:null,http:80,https:443,ws:80,wss:443},gu=function(n,e){var t;return n.length===2&&oo(bb,Bn(n,0))&&((t=Bn(n,1))===":"||!e&&t==="|")},Pb=function(n){var e;return n.length>1&&gu(mu(n,0,2))&&(n.length===2||(e=Bn(n,2))==="/"||e==="\\"||e==="?"||e==="#")},fH=function(n){return n==="."||Qp(n)==="%2e"},$g={},Lb={},eS={},kb={},Mb={},tS={},Ub={},xb={},e_={},t_={},iS={},rS={},nS={},oS={},Vb={},sS={},wd={},Ao={},Fb={},za={},ss={},aS=function(n,e,t){var i,r,o,s=os(n);if(e){if(r=this.parse(s))throw new qg(r);this.searchParams=null}else{if(t!==void 0&&(i=new aS(t,!0)),r=this.parse(s,null,i))throw new qg(r);(o=$6(new Z6)).bindURL(this),this.searchParams=o}};aS.prototype={type:"URL",parse:function(n,e,t){var i,r,o,s,a,c=this,d=e||$g,l=0,h="",p=!1,f=!1,m=!1;for(n=os(n),e||(c.scheme="",c.username="",c.password="",c.host=null,c.port=null,c.path=[],c.query=null,c.fragment=null,c.cannotBeABaseURL=!1,n=Xg(n,hH,""),n=Xg(n,pH,"$1")),n=Xg(n,_H,""),i=yd(n);l<=i.length;){switch(r=i[l],d){case $g:if(!r||!oo(bb,r)){if(e)return Jg;d=eS;continue}h+=Qp(r),d=Lb;break;case Lb:if(r&&(oo(sH,r)||r==="+"||r==="-"||r==="."))h+=Qp(r);else{if(r!==":"){if(e)return Jg;h="",d=eS,l=0;continue}if(e&&(c.isSpecial()!==Yg($p,h)||h==="file"&&(c.includesCredentials()||c.port!==null)||c.scheme==="file"&&!c.host))return;if(c.scheme=h,e)return void(c.isSpecial()&&$p[c.scheme]===c.port&&(c.port=null));h="",c.scheme==="file"?d=oS:c.isSpecial()&&t&&t.scheme===c.scheme?d=kb:c.isSpecial()?d=xb:i[l+1]==="/"?(d=Mb,l++):(c.cannotBeABaseURL=!0,Id(c.path,""),d=Fb)}break;case eS:if(!t||t.cannotBeABaseURL&&r!=="#")return Jg;if(t.cannotBeABaseURL&&r==="#"){c.scheme=t.scheme,c.path=no(t.path),c.query=t.query,c.fragment="",c.cannotBeABaseURL=!0,d=ss;break}d=t.scheme==="file"?oS:tS;continue;case kb:if(r!=="/"||i[l+1]!=="/"){d=tS;continue}d=e_,l++;break;case Mb:if(r==="/"){d=t_;break}d=Ao;continue;case tS:if(c.scheme=t.scheme,r===xn)c.username=t.username,c.password=t.password,c.host=t.host,c.port=t.port,c.path=no(t.path),c.query=t.query;else if(r==="/"||r==="\\"&&c.isSpecial())d=Ub;else if(r==="?")c.username=t.username,c.password=t.password,c.host=t.host,c.port=t.port,c.path=no(t.path),c.query="",d=za;else{if(r!=="#"){c.username=t.username,c.password=t.password,c.host=t.host,c.port=t.port,c.path=no(t.path),c.path.length--,d=Ao;continue}c.username=t.username,c.password=t.password,c.host=t.host,c.port=t.port,c.path=no(t.path),c.query=t.query,c.fragment="",d=ss}break;case Ub:if(!c.isSpecial()||r!=="/"&&r!=="\\"){if(r!=="/"){c.username=t.username,c.password=t.password,c.host=t.host,c.port=t.port,d=Ao;continue}d=t_}else d=e_;break;case xb:if(d=e_,r!=="/"||Bn(h,l+1)!=="/")continue;l++;break;case e_:if(r!=="/"&&r!=="\\"){d=t_;continue}break;case t_:if(r==="@"){p&&(h="%40"+h),p=!0,o=yd(h);for(var g=0;g<o.length;g++){var S=o[g];if(S!==":"||m){var T=Xs(S,Zg);m?c.password+=T:c.username+=T}else m=!0}h=""}else if(r===xn||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()){if(p&&h==="")return"Invalid authority";l-=yd(h).length+1,h="",d=iS}else h+=r;break;case iS:case rS:if(e&&c.scheme==="file"){d=sS;continue}if(r!==":"||f){if(r===xn||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()){if(c.isSpecial()&&h==="")return Ad;if(e&&h===""&&(c.includesCredentials()||c.port!==null))return;if(s=c.parseHost(h))return s;if(h="",d=wd,e)return;continue}r==="["?f=!0:r==="]"&&(f=!1),h+=r}else{if(h==="")return Ad;if(s=c.parseHost(h))return s;if(h="",d=nS,e===rS)return}break;case nS:if(!oo(Qg,r)){if(r===xn||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()||e){if(h!==""){var C=Jp(h,10);if(C>65535)return wb;c.port=c.isSpecial()&&C===$p[c.scheme]?null:C,h=""}if(e)return;d=wd;continue}return wb}h+=r;break;case oS:if(c.scheme="file",r==="/"||r==="\\")d=Vb;else{if(!t||t.scheme!=="file"){d=Ao;continue}switch(r){case xn:c.host=t.host,c.path=no(t.path),c.query=t.query;break;case"?":c.host=t.host,c.path=no(t.path),c.query="",d=za;break;case"#":c.host=t.host,c.path=no(t.path),c.query=t.query,c.fragment="",d=ss;break;default:Pb(fu(no(i,l),""))||(c.host=t.host,c.path=no(t.path),c.shortenPath()),d=Ao;continue}}break;case Vb:if(r==="/"||r==="\\"){d=sS;break}t&&t.scheme==="file"&&!Pb(fu(no(i,l),""))&&(gu(t.path[0],!0)?Id(c.path,t.path[0]):c.host=t.host),d=Ao;continue;case sS:if(r===xn||r==="/"||r==="\\"||r==="?"||r==="#"){if(!e&&gu(h))d=Ao;else if(h===""){if(c.host="",e)return;d=wd}else{if(s=c.parseHost(h))return s;if(c.host==="localhost"&&(c.host=""),e)return;h="",d=wd}continue}h+=r;break;case wd:if(c.isSpecial()){if(d=Ao,r!=="/"&&r!=="\\")continue}else if(e||r!=="?")if(e||r!=="#"){if(r!==xn&&(d=Ao,r!=="/"))continue}else c.fragment="",d=ss;else c.query="",d=za;break;case Ao:if(r===xn||r==="/"||r==="\\"&&c.isSpecial()||!e&&(r==="?"||r==="#")){if((a=Qp(a=h))===".."||a==="%2e."||a===".%2e"||a==="%2e%2e"?(c.shortenPath(),r==="/"||r==="\\"&&c.isSpecial()||Id(c.path,"")):fH(h)?r==="/"||r==="\\"&&c.isSpecial()||Id(c.path,""):(c.scheme==="file"&&!c.path.length&&gu(h)&&(c.host&&(c.host=""),h=Bn(h,0)+":"),Id(c.path,h)),h="",c.scheme==="file"&&(r===xn||r==="?"||r==="#"))for(;c.path.length>1&&c.path[0]==="";)rH(c.path);r==="?"?(c.query="",d=za):r==="#"&&(c.fragment="",d=ss)}else h+=Xs(r,Db);break;case Fb:r==="?"?(c.query="",d=za):r==="#"?(c.fragment="",d=ss):r!==xn&&(c.path[0]+=Xs(r,Zp));break;case za:e||r!=="#"?r!==xn&&(r==="'"&&c.isSpecial()?c.query+="%27":c.query+=r==="#"?"%23":Xs(r,Zp)):(c.fragment="",d=ss);break;case ss:r!==xn&&(c.fragment+=Xs(r,Nb))}l++}},parseHost:function(n){var e,t,i;if(Bn(n,0)==="["){if(Bn(n,n.length-1)!=="]"||(e=function(r){var o,s,a,c,d,l,h,p=[0,0,0,0,0,0,0,0],f=0,m=null,g=0,S=function(){return Bn(r,g)};if(S()===":"){if(Bn(r,1)!==":")return;g+=2,m=++f}for(;S();){if(f===8)return;if(S()!==":"){for(o=s=0;s<4&&oo(Ob,S());)o=16*o+Jp(S(),16),g++,s++;if(S()==="."){if(s===0||(g-=s,f>6))return;for(a=0;S();){if(c=null,a>0){if(!(S()==="."&&a<4))return;g++}if(!oo(Qg,S()))return;for(;oo(Qg,S());){if(d=Jp(S(),10),c===null)c=d;else{if(c===0)return;c=10*c+d}if(c>255)return;g++}p[f]=256*p[f]+c,++a!=2&&a!==4||f++}if(a!==4)return;break}if(S()===":"){if(g++,!S())return}else if(S())return;p[f++]=o}else{if(m!==null)return;g++,m=++f}}if(m!==null)for(l=f-m,f=7;f!==0&&l>0;)h=p[f],p[f--]=p[m+l-1],p[m+--l]=h;else if(f!==8)return;return p}(mu(n,1,-1)),!e))return Ad;this.host=e}else if(this.isSpecial()){if(n=q6(n),oo(lH,n)||(e=function(r){var o,s,a,c,d,l,h,p=nH(r,".");if(p.length&&p[p.length-1]===""&&p.length--,(o=p.length)>4)return r;for(s=[],a=0;a<o;a++){if((c=p[a])==="")return r;if(d=10,c.length>1&&Bn(c,0)==="0"&&(d=oo(aH,c)?16:8,c=mu(c,d===8?1:2)),c==="")l=0;else{if(!oo(d===10?dH:d===8?cH:Ob,c))return r;l=Jp(c,d)}Id(s,l)}for(a=0;a<o;a++)if(l=s[a],a===o-1){if(l>=Ab(256,5-o))return null}else if(l>255)return null;for(h=iH(s),a=0;a<s.length;a++)h+=s[a]*Ab(256,3-a);return h}(n),e===null))return Ad;this.host=e}else{if(oo(uH,n))return Ad;for(e="",t=yd(n),i=0;i<t.length;i++)e+=Xs(t[i],Zp);this.host=e}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||this.scheme==="file"},includesCredentials:function(){return this.username!==""||this.password!==""},isSpecial:function(){return Yg($p,this.scheme)},shortenPath:function(){var n=this.path,e=n.length;!e||this.scheme==="file"&&e===1&&gu(n[0],!0)||n.length--},serialize:function(){var n=this,e=n.scheme,t=n.username,i=n.password,r=n.host,o=n.port,s=n.path,a=n.query,c=n.fragment,d=e+":";return r!==null?(d+="//",n.includesCredentials()&&(d+=t+(i?":"+i:"")+"@"),d+=Eu(r),o!==null&&(d+=":"+o)):e==="file"&&(d+="//"),d+=n.cannotBeABaseURL?s[0]:s.length?"/"+fu(s,"/"):"",a!==null&&(d+="?"+a),c!==null&&(d+="#"+c),d},setHref:function(n){var e=this.parse(n);if(e)throw new qg(e);this.searchParams.update()},getOrigin:function(){var n=this.scheme,e=this.port;if(n==="blob")try{return new bd(n.path[0]).origin}catch{return"null"}return n!=="file"&&this.isSpecial()?n+"://"+Eu(this.host)+(e!==null?":"+e:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(n){this.parse(os(n)+":",$g)},getUsername:function(){return this.username},setUsername:function(n){var e=yd(os(n));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var t=0;t<e.length;t++)this.username+=Xs(e[t],Zg)}},getPassword:function(){return this.password},setPassword:function(n){var e=yd(os(n));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var t=0;t<e.length;t++)this.password+=Xs(e[t],Zg)}},getHost:function(){var n=this.host,e=this.port;return n===null?"":e===null?Eu(n):Eu(n)+":"+e},setHost:function(n){this.cannotBeABaseURL||this.parse(n,iS)},getHostname:function(){var n=this.host;return n===null?"":Eu(n)},setHostname:function(n){this.cannotBeABaseURL||this.parse(n,rS)},getPort:function(){var n=this.port;return n===null?"":os(n)},setPort:function(n){this.cannotHaveUsernamePasswordPort()||((n=os(n))===""?this.port=null:this.parse(n,nS))},getPathname:function(){var n=this.path;return this.cannotBeABaseURL?n[0]:n.length?"/"+fu(n,"/"):""},setPathname:function(n){this.cannotBeABaseURL||(this.path=[],this.parse(n,wd))},getSearch:function(){var n=this.query;return n?"?"+n:""},setSearch:function(n){(n=os(n))===""?this.query=null:(Bn(n,0)==="?"&&(n=mu(n,1)),this.query="",this.parse(n,za)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var n=this.fragment;return n?"#"+n:""},setHash:function(n){(n=os(n))!==""?(Bn(n,0)==="#"&&(n=mu(n,1)),this.fragment="",this.parse(n,ss)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var bd=function(n){var e=Y6(this,Br),t=J6(arguments.length,1)>1?arguments[1]:void 0,i=Q6(e,new aS(n,!1,t));Hg||(e.href=i.serialize(),e.origin=i.getOrigin(),e.protocol=i.getProtocol(),e.username=i.getUsername(),e.password=i.getPassword(),e.host=i.getHost(),e.hostname=i.getHostname(),e.port=i.getPort(),e.pathname=i.getPathname(),e.search=i.getSearch(),e.searchParams=i.getSearchParams(),e.hash=i.getHash())},Br=bd.prototype,jn=function(n,e){return{get:function(){return Xp(this)[n]()},set:e&&function(t){return Xp(this)[e](t)},configurable:!0,enumerable:!0}};if(Hg&&(Fn(Br,"href",jn("serialize","setHref")),Fn(Br,"origin",jn("getOrigin")),Fn(Br,"protocol",jn("getProtocol","setProtocol")),Fn(Br,"username",jn("getUsername","setUsername")),Fn(Br,"password",jn("getPassword","setPassword")),Fn(Br,"host",jn("getHost","setHost")),Fn(Br,"hostname",jn("getHostname","setHostname")),Fn(Br,"port",jn("getPort","setPort")),Fn(Br,"pathname",jn("getPathname","setPathname")),Fn(Br,"search",jn("getSearch","setSearch")),Fn(Br,"searchParams",jn("getSearchParams")),Fn(Br,"hash",jn("getHash","setHash"))),qp(Br,"toJSON",function(){return Xp(this).serialize()},{enumerable:!0}),qp(Br,"toString",function(){return Xp(this).serialize()},{enumerable:!0}),_u){var Bb=_u.createObjectURL,jb=_u.revokeObjectURL;Bb&&qp(bd,"createObjectURL",Cb(Bb,_u)),jb&&qp(bd,"revokeObjectURL",Cb(jb,_u))}X6(bd,"URL"),H6({global:!0,forced:!K6,sham:!Hg},{URL:bd});var mH=qe,Gb=P,EH=Wa,Wb=xr,gH=Gp,cS=Sr("URL"),SH=gH&&Gb(function(){cS.canParse()}),TH=Gb(function(){return cS.canParse.length!==1});mH({target:"URL",stat:!0,forced:!SH||TH},{canParse:function(n){var e=EH(arguments.length,1),t=Wb(n),i=e<2||arguments[1]===void 0?void 0:Wb(arguments[1]);try{return!!new cS(t,i)}catch{return!1}}});var RH=qe,vH=Wa,Hb=xr,CH=Gp,yH=Sr("URL");RH({target:"URL",stat:!0,forced:!CH},{parse:function(n){var e=vH(arguments.length,1),t=Hb(n),i=e<2||arguments[1]===void 0?void 0:Hb(arguments[1]);try{return new yH(t,i)}catch{return null}}});var i_=A(Qr.URL);let Kb=!0,Yb=!0;function r_(n,e,t){let i=n.match(e);return i&&i.length>=t&&parseInt(i[t],10)}function qa(n,e,t){if(!n.RTCPeerConnection)return;let i=n.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(s,a){if(s!==e)return r.apply(this,arguments);let c=d=>{let l=t(d);l&&(a.handleEvent?a.handleEvent(l):a(l))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(a,c),r.apply(this,[s,c])};let o=i.removeEventListener;i.removeEventListener=function(s,a){if(s!==e||!this._eventMap||!this._eventMap[e])return o.apply(this,arguments);if(!this._eventMap[e].has(a))return o.apply(this,arguments);let c=this._eventMap[e].get(a);return this._eventMap[e].delete(a),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,o.apply(this,[s,c])},Object.defineProperty(i,"on"+e,{get(){return this["_on"+e]},set(s){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),s&&this.addEventListener(e,this["_on"+e]=s)},enumerable:!0,configurable:!0})}function IH(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(Kb=n,n?"adapter.js logging disabled":"adapter.js logging enabled")}function AH(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(Yb=!n,"adapter.js deprecation warnings "+(n?"disabled":"enabled"))}function zb(){if(typeof window=="object"){if(Kb)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function dS(n,e){Yb&&console.warn(n+" is deprecated, please use "+e+" instead.")}function qb(n){return Object.prototype.toString.call(n)==="[object Object]"}function Xb(n){var e;return qb(n)?un(e=Object.keys(n)).call(e,function(t,i){let r=qb(n[i]),o=r?Xb(n[i]):n[i],s=r&&!Object.keys(o).length;return o===void 0||s?t:Object.assign(t,{[i]:o})},{}):n}function lS(n,e,t){e&&!t.has(e.id)&&(t.set(e.id,e),Object.keys(e).forEach(i=>{i.endsWith("Id")?lS(n,n.get(e[i]),t):i.endsWith("Ids")&&e[i].forEach(r=>{lS(n,n.get(r),t)})}))}function Jb(n,e,t){let i=t?"outbound-rtp":"inbound-rtp",r=new Map;if(e===null)return r;let o=[];return n.forEach(s=>{s.type==="track"&&s.trackIdentifier===e.id&&o.push(s)}),o.forEach(s=>{n.forEach(a=>{a.type===i&&a.trackId===s.id&&lS(n,a,r)})}),r}let Qb=zb;function Zb(n,e){let t=n&&n.navigator;if(!t.mediaDevices)return;let i=function(s){if(typeof s!="object"||s.mandatory||s.optional)return s;let a={};return Object.keys(s).forEach(c=>{if(c==="require"||c==="advanced"||c==="mediaSource")return;let d=typeof s[c]=="object"?s[c]:{ideal:s[c]};d.exact!==void 0&&typeof d.exact=="number"&&(d.min=d.max=d.exact);let l=function(h,p){return h?h+p.charAt(0).toUpperCase()+p.slice(1):p==="deviceId"?"sourceId":p};if(d.ideal!==void 0){a.optional=a.optional||[];let h={};typeof d.ideal=="number"?(h[l("min",c)]=d.ideal,a.optional.push(h),h={},h[l("max",c)]=d.ideal,a.optional.push(h)):(h[l("",c)]=d.ideal,a.optional.push(h))}d.exact!==void 0&&typeof d.exact!="number"?(a.mandatory=a.mandatory||{},a.mandatory[l("",c)]=d.exact):["min","max"].forEach(h=>{d[h]!==void 0&&(a.mandatory=a.mandatory||{},a.mandatory[l(h,c)]=d[h])})}),s.advanced&&(a.optional=(a.optional||[]).concat(s.advanced)),a},r=function(s,a){if(e.version>=61)return a(s);if((s=JSON.parse(JSON.stringify(s)))&&typeof s.audio=="object"){let c=function(d,l,h){l in d&&!(h in d)&&(d[h]=d[l],delete d[l])};c((s=JSON.parse(JSON.stringify(s))).audio,"autoGainControl","googAutoGainControl"),c(s.audio,"noiseSuppression","googNoiseSuppression"),s.audio=i(s.audio)}if(s&&typeof s.video=="object"){let c=s.video.facingMode;c=c&&(typeof c=="object"?c:{ideal:c});let d=e.version<66;if(c&&(c.exact==="user"||c.exact==="environment"||c.ideal==="user"||c.ideal==="environment")&&(!t.mediaDevices.getSupportedConstraints||!t.mediaDevices.getSupportedConstraints().facingMode||d)){let l;if(delete s.video.facingMode,c.exact==="environment"||c.ideal==="environment"?l=["back","rear"]:c.exact!=="user"&&c.ideal!=="user"||(l=["front"]),l)return t.mediaDevices.enumerateDevices().then(h=>{h=h.filter(f=>f.kind==="videoinput");let p=h.find(f=>l.some(m=>{var g;return z(g=f.label.toLowerCase()).call(g,m)}));return!p&&h.length&&z(l).call(l,"back")&&(p=h[h.length-1]),p&&(s.video.deviceId=c.exact?{exact:p.deviceId}:{ideal:p.deviceId}),s.video=i(s.video),Qb("chrome: "+JSON.stringify(s)),a(s)})}s.video=i(s.video)}return Qb("chrome: "+JSON.stringify(s)),a(s)},o=function(s){return e.version>=64?s:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[s.name]||s.name,message:s.message,constraint:s.constraint||s.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(t.getUserMedia=(function(s,a,c){r(s,d=>{t.webkitGetUserMedia(d,a,l=>{c&&c(o(l))})})}).bind(t),t.mediaDevices.getUserMedia){let s=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(a){return r(a,c=>s(c).then(d=>{if(c.audio&&!d.getAudioTracks().length||c.video&&!d.getVideoTracks().length)throw d.getTracks().forEach(l=>{l.stop()}),new DOMException("","NotFoundError");return d},d=>Z.reject(o(d))))}}}function $b(n){n.MediaStream=n.MediaStream||n.webkitMediaStream}function eO(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("ontrack"in n.RTCPeerConnection.prototype)){Object.defineProperty(n.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});let e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",i=>{let r;r=n.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(s=>s.track&&s.track.id===i.track.id):{track:i.track};let o=new Event("track");o.track=i.track,o.receiver=r,o.transceiver={receiver:r},o.streams=[t.stream],this.dispatchEvent(o)}),t.stream.getTracks().forEach(i=>{let r;r=n.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(s=>s.track&&s.track.id===i.id):{track:i};let o=new Event("track");o.track=i,o.receiver=r,o.transceiver={receiver:r},o.streams=[t.stream],this.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else qa(n,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function tO(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("getSenders"in n.RTCPeerConnection.prototype)&&"createDTMFSender"in n.RTCPeerConnection.prototype){let e=function(r,o){return{track:o,get dtmf(){return this._dtmf===void 0&&(o.kind==="audio"?this._dtmf=r.createDTMFSender(o):this._dtmf=null),this._dtmf},_pc:r}};if(!n.RTCPeerConnection.prototype.getSenders){n.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};let r=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(s,a){let c=r.apply(this,arguments);return c||(c=e(this,s),this._senders.push(c)),c};let o=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(s){o.apply(this,arguments);let a=this._senders.indexOf(s);a!==-1&&this._senders.splice(a,1)}}let t=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(r){this._senders=this._senders||[],t.apply(this,[r]),r.getTracks().forEach(o=>{this._senders.push(e(this,o))})};let i=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(r){this._senders=this._senders||[],i.apply(this,[r]),r.getTracks().forEach(o=>{let s=this._senders.find(a=>a.track===o);s&&this._senders.splice(this._senders.indexOf(s),1)})}}else if(typeof n=="object"&&n.RTCPeerConnection&&"getSenders"in n.RTCPeerConnection.prototype&&"createDTMFSender"in n.RTCPeerConnection.prototype&&n.RTCRtpSender&&!("dtmf"in n.RTCRtpSender.prototype)){let e=n.RTCPeerConnection.prototype.getSenders;n.RTCPeerConnection.prototype.getSenders=function(){let t=e.apply(this,[]);return t.forEach(i=>i._pc=this),t},Object.defineProperty(n.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function iO(n){if(!n.RTCPeerConnection)return;let e=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){let[t,i,r]=arguments;if(arguments.length>0&&typeof t=="function")return e.apply(this,arguments);if(e.length===0&&(arguments.length===0||typeof t!="function"))return e.apply(this,[]);let o=function(a){let c={};return a.result().forEach(d=>{let l={id:d.id,timestamp:d.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[d.type]||d.type};d.names().forEach(h=>{l[h]=d.stat(h)}),c[l.id]=l}),c},s=function(a){return new Map(Object.keys(a).map(c=>[c,a[c]]))};if(arguments.length>=2){let a=function(c){i(s(o(c)))};return e.apply(this,[a,t])}return new Z((a,c)=>{e.apply(this,[function(d){a(s(o(d)))},c])}).then(i,r)}}function rO(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender&&n.RTCRtpReceiver))return;if(!("getStats"in n.RTCRtpSender.prototype)){let t=n.RTCPeerConnection.prototype.getSenders;t&&(n.RTCPeerConnection.prototype.getSenders=function(){let r=t.apply(this,[]);return r.forEach(o=>o._pc=this),r});let i=n.RTCPeerConnection.prototype.addTrack;i&&(n.RTCPeerConnection.prototype.addTrack=function(){let r=i.apply(this,arguments);return r._pc=this,r}),n.RTCRtpSender.prototype.getStats=function(){let r=this;return this._pc.getStats().then(o=>Jb(o,r.track,!0))}}if(!("getStats"in n.RTCRtpReceiver.prototype)){let t=n.RTCPeerConnection.prototype.getReceivers;t&&(n.RTCPeerConnection.prototype.getReceivers=function(){let i=t.apply(this,[]);return i.forEach(r=>r._pc=this),i}),qa(n,"track",i=>(i.receiver._pc=i.srcElement,i)),n.RTCRtpReceiver.prototype.getStats=function(){let i=this;return this._pc.getStats().then(r=>Jb(r,i.track,!1))}}if(!("getStats"in n.RTCRtpSender.prototype)||!("getStats"in n.RTCRtpReceiver.prototype))return;let e=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof n.MediaStreamTrack){let t=arguments[0],i,r,o;return this.getSenders().forEach(s=>{s.track===t&&(i?o=!0:i=s)}),this.getReceivers().forEach(s=>(s.track===t&&(r?o=!0:r=s),s.track===t)),o||i&&r?Z.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):i?i.getStats():r?r.getStats():Z.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function nO(n){n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(o=>this._shimmedLocalStreams[o][0])};let e=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(o,s){if(!s)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};let a=e.apply(this,arguments);return this._shimmedLocalStreams[s.id]?this._shimmedLocalStreams[s.id].indexOf(a)===-1&&this._shimmedLocalStreams[s.id].push(a):this._shimmedLocalStreams[s.id]=[s,a],a};let t=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(o){this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(c=>{if(this.getSenders().find(d=>d.track===c))throw new DOMException("Track already exists.","InvalidAccessError")});let s=this.getSenders();t.apply(this,arguments);let a=this.getSenders().filter(c=>s.indexOf(c)===-1);this._shimmedLocalStreams[o.id]=[o].concat(a)};let i=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],i.apply(this,arguments)};let r=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(s=>{let a=this._shimmedLocalStreams[s].indexOf(o);a!==-1&&this._shimmedLocalStreams[s].splice(a,1),this._shimmedLocalStreams[s].length===1&&delete this._shimmedLocalStreams[s]}),r.apply(this,arguments)}}function oO(n,e){if(!n.RTCPeerConnection)return;if(n.RTCPeerConnection.prototype.addTrack&&e.version>=65)return nO(n);let t=n.RTCPeerConnection.prototype.getLocalStreams;n.RTCPeerConnection.prototype.getLocalStreams=function(){let c=t.apply(this);return this._reverseStreams=this._reverseStreams||{},c.map(d=>this._reverseStreams[d.id])};let i=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(c){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},c.getTracks().forEach(d=>{if(this.getSenders().find(l=>l.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[c.id]){let d=new n.MediaStream(c.getTracks());this._streams[c.id]=d,this._reverseStreams[d.id]=c,c=d}i.apply(this,[c])};let r=n.RTCPeerConnection.prototype.removeStream;function o(c,d){let l=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(h=>{let p=c._reverseStreams[h],f=c._streams[p.id];l=l.replace(new RegExp(f.id,"g"),p.id)}),new RTCSessionDescription({type:d.type,sdp:l})}n.RTCPeerConnection.prototype.removeStream=function(c){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[c.id]||c]),delete this._reverseStreams[this._streams[c.id]?this._streams[c.id].id:c.id],delete this._streams[c.id]},n.RTCPeerConnection.prototype.addTrack=function(c,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");let l=[].slice.call(arguments,1);if(l.length!==1||!l[0].getTracks().find(p=>p===c))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(p=>p.track===c))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};let h=this._streams[d.id];if(h)h.addTrack(c),Z.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{let p=new n.MediaStream([c]);this._streams[d.id]=p,this._reverseStreams[p.id]=d,this.addStream(p)}return this.getSenders().find(p=>p.track===c)},["createOffer","createAnswer"].forEach(function(c){let d=n.RTCPeerConnection.prototype[c],l={[c](){let h=arguments;return arguments.length&&typeof arguments[0]=="function"?d.apply(this,[p=>{let f=o(this,p);h[0].apply(null,[f])},p=>{h[1]&&h[1].apply(null,p)},arguments[2]]):d.apply(this,arguments).then(p=>o(this,p))}};n.RTCPeerConnection.prototype[c]=l[c]});let s=n.RTCPeerConnection.prototype.setLocalDescription;n.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(c,d){let l=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(h=>{let p=c._reverseStreams[h],f=c._streams[p.id];l=l.replace(new RegExp(p.id,"g"),f.id)}),new RTCSessionDescription({type:d.type,sdp:l})}(this,arguments[0]),s.apply(this,arguments)):s.apply(this,arguments)};let a=Object.getOwnPropertyDescriptor(n.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(n.RTCPeerConnection.prototype,"localDescription",{get(){let c=a.get.apply(this);return c.type===""?c:o(this,c)}}),n.RTCPeerConnection.prototype.removeTrack=function(c){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!c._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(c._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let d;this._streams=this._streams||{},Object.keys(this._streams).forEach(l=>{this._streams[l].getTracks().find(h=>c.track===h)&&(d=this._streams[l])}),d&&(d.getTracks().length===1?this.removeStream(this._reverseStreams[d.id]):d.removeTrack(c.track),this.dispatchEvent(new Event("negotiationneeded")))}}function uS(n,e){!n.RTCPeerConnection&&n.webkitRTCPeerConnection&&(n.RTCPeerConnection=n.webkitRTCPeerConnection),n.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){let i=n.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new(t==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};n.RTCPeerConnection.prototype[t]=r[t]})}function sO(n,e){qa(n,"negotiationneeded",t=>{let i=t.target;if(!(e.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")||i.signalingState==="stable")return t})}var aO=Object.freeze({__proto__:null,fixNegotiationNeeded:sO,shimAddTrackRemoveTrack:oO,shimAddTrackRemoveTrackWithNative:nO,shimGetDisplayMedia:function(n,e){n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices||n.navigator.mediaDevices&&(typeof e=="function"?n.navigator.mediaDevices.getDisplayMedia=function(t){return e(t).then(i=>{let r=t.video&&t.video.width,o=t.video&&t.video.height,s=t.video&&t.video.frameRate;return t.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:i,maxFrameRate:s||3}},r&&(t.video.mandatory.maxWidth=r),o&&(t.video.mandatory.maxHeight=o),n.navigator.mediaDevices.getUserMedia(t)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:tO,shimGetStats:iO,shimGetUserMedia:Zb,shimMediaStream:$b,shimOnTrack:eO,shimPeerConnection:uS,shimSenderReceiverGetStats:rO});function cO(n,e){let t=n&&n.navigator,i=n&&n.MediaStreamTrack;if(t.getUserMedia=function(r,o,s){dS("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),t.mediaDevices.getUserMedia(r).then(o,s)},!(e.version>55&&"autoGainControl"in t.mediaDevices.getSupportedConstraints())){let r=function(s,a,c){a in s&&!(c in s)&&(s[c]=s[a],delete s[a])},o=t.mediaDevices.getUserMedia.bind(t.mediaDevices);if(t.mediaDevices.getUserMedia=function(s){return typeof s=="object"&&typeof s.audio=="object"&&(s=JSON.parse(JSON.stringify(s)),r(s.audio,"autoGainControl","mozAutoGainControl"),r(s.audio,"noiseSuppression","mozNoiseSuppression")),o(s)},i&&i.prototype.getSettings){let s=i.prototype.getSettings;i.prototype.getSettings=function(){let a=s.apply(this,arguments);return r(a,"mozAutoGainControl","autoGainControl"),r(a,"mozNoiseSuppression","noiseSuppression"),a}}if(i&&i.prototype.applyConstraints){let s=i.prototype.applyConstraints;i.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a,"autoGainControl","mozAutoGainControl"),r(a,"noiseSuppression","mozNoiseSuppression")),s.apply(this,[a])}}}}function dO(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function hS(n,e){if(typeof n!="object"||!n.RTCPeerConnection&&!n.mozRTCPeerConnection)return;!n.RTCPeerConnection&&n.mozRTCPeerConnection&&(n.RTCPeerConnection=n.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){let o=n.RTCPeerConnection.prototype[r],s={[r](){return arguments[0]=new(r==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};n.RTCPeerConnection.prototype[r]=s[r]});let t={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){let[r,o,s]=arguments;return i.apply(this,[r||null]).then(a=>{if(e.version<53&&!o)try{a.forEach(c=>{c.type=t[c.type]||c.type})}catch(c){if(c.name!=="TypeError")throw c;a.forEach((d,l)=>{a.set(l,Object.assign({},d,{type:t[d.type]||d.type}))})}return a}).then(o,s)}}function lO(n){if(typeof n!="object"||!n.RTCPeerConnection||!n.RTCRtpSender||n.RTCRtpSender&&"getStats"in n.RTCRtpSender.prototype)return;let e=n.RTCPeerConnection.prototype.getSenders;e&&(n.RTCPeerConnection.prototype.getSenders=function(){let i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i});let t=n.RTCPeerConnection.prototype.addTrack;t&&(n.RTCPeerConnection.prototype.addTrack=function(){let i=t.apply(this,arguments);return i._pc=this,i}),n.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Z.resolve(new Map)}}function uO(n){if(typeof n!="object"||!n.RTCPeerConnection||!n.RTCRtpSender||n.RTCRtpSender&&"getStats"in n.RTCRtpReceiver.prototype)return;let e=n.RTCPeerConnection.prototype.getReceivers;e&&(n.RTCPeerConnection.prototype.getReceivers=function(){let t=e.apply(this,[]);return t.forEach(i=>i._pc=this),t}),qa(n,"track",t=>(t.receiver._pc=t.srcElement,t)),n.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function hO(n){n.RTCPeerConnection&&!("removeStream"in n.RTCPeerConnection.prototype)&&(n.RTCPeerConnection.prototype.removeStream=function(e){dS("removeStream","removeTrack"),this.getSenders().forEach(t=>{var i;t.track&&z(i=e.getTracks()).call(i,t.track)&&this.removeTrack(t)})})}function pO(n){n.DataChannel&&!n.RTCDataChannel&&(n.RTCDataChannel=n.DataChannel)}function _O(n){if(typeof n!="object"||!n.RTCPeerConnection)return;let e=n.RTCPeerConnection.prototype.addTransceiver;e&&(n.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let t=arguments[1]&&arguments[1].sendEncodings;t===void 0&&(t=[]),t=[...t];let i=t.length>0;i&&t.forEach(o=>{if("rid"in o&&!/^[a-z0-9]{0,16}$/i.test(o.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in o&&!(parseFloat(o.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in o&&!(parseFloat(o.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});let r=e.apply(this,arguments);if(i){let{sender:o}=r,s=o.getParameters();(!("encodings"in s)||s.encodings.length===1&&Object.keys(s.encodings[0]).length===0)&&(s.encodings=t,o.sendEncodings=t,this.setParametersPromises.push(o.setParameters(s).then(()=>{delete o.sendEncodings}).catch(()=>{delete o.sendEncodings})))}return r})}function fO(n){if(typeof n!="object"||!n.RTCRtpSender)return;let e=n.RTCRtpSender.prototype.getParameters;e&&(n.RTCRtpSender.prototype.getParameters=function(){let t=e.apply(this,arguments);return"encodings"in t||(t.encodings=[].concat(this.sendEncodings||[{}])),t})}function mO(n){if(typeof n!="object"||!n.RTCPeerConnection)return;let e=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Z.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function EO(n){if(typeof n!="object"||!n.RTCPeerConnection)return;let e=n.RTCPeerConnection.prototype.createAnswer;n.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Z.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var gO=Object.freeze({__proto__:null,shimAddTransceiver:_O,shimCreateAnswer:EO,shimCreateOffer:mO,shimGetDisplayMedia:function(n,e){n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices||n.navigator.mediaDevices&&(n.navigator.mediaDevices.getDisplayMedia=function(t){if(!t||!t.video){let i=new DOMException("getDisplayMedia without video constraints is undefined");return i.name="NotFoundError",i.code=8,Z.reject(i)}return t.video===!0?t.video={mediaSource:e}:t.video.mediaSource=e,n.navigator.mediaDevices.getUserMedia(t)})},shimGetParameters:fO,shimGetUserMedia:cO,shimOnTrack:dO,shimPeerConnection:hS,shimRTCDataChannel:pO,shimReceiverGetStats:uO,shimRemoveStream:hO,shimSenderGetStats:lO});function SO(n){if(typeof n=="object"&&n.RTCPeerConnection){if("getLocalStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in n.RTCPeerConnection.prototype)){let e=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addStream=function(t){var i;this._localStreams||(this._localStreams=[]),z(i=this._localStreams).call(i,t)||this._localStreams.push(t),t.getAudioTracks().forEach(r=>e.call(this,r,t)),t.getVideoTracks().forEach(r=>e.call(this,r,t))},n.RTCPeerConnection.prototype.addTrack=function(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return r&&r.forEach(s=>{var a;this._localStreams?z(a=this._localStreams).call(a,s)||this._localStreams.push(s):this._localStreams=[s]}),e.apply(this,arguments)}}"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);let t=this._localStreams.indexOf(e);if(t===-1)return;this._localStreams.splice(t,1);let i=e.getTracks();this.getSenders().forEach(r=>{z(i).call(i,r.track)&&this.removeTrack(r)})})}}function TO(n){if(typeof n=="object"&&n.RTCPeerConnection&&("getRemoteStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in n.RTCPeerConnection.prototype))){Object.defineProperty(n.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach(r=>{var o;if(this._remoteStreams||(this._remoteStreams=[]),z(o=this._remoteStreams).call(o,r))return;this._remoteStreams.push(r);let s=new Event("addstream");s.stream=r,this.dispatchEvent(s)})})}});let e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){let t=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(i){i.streams.forEach(r=>{if(t._remoteStreams||(t._remoteStreams=[]),t._remoteStreams.indexOf(r)>=0)return;t._remoteStreams.push(r);let o=new Event("addstream");o.stream=r,t.dispatchEvent(o)})}),e.apply(t,arguments)}}}function RO(n){if(typeof n!="object"||!n.RTCPeerConnection)return;let e=n.RTCPeerConnection.prototype,t=e.createOffer,i=e.createAnswer,r=e.setLocalDescription,o=e.setRemoteDescription,s=e.addIceCandidate;e.createOffer=function(c,d){let l=arguments.length>=2?arguments[2]:arguments[0],h=t.apply(this,[l]);return d?(h.then(c,d),Z.resolve()):h},e.createAnswer=function(c,d){let l=arguments.length>=2?arguments[2]:arguments[0],h=i.apply(this,[l]);return d?(h.then(c,d),Z.resolve()):h};let a=function(c,d,l){let h=r.apply(this,[c]);return l?(h.then(d,l),Z.resolve()):h};e.setLocalDescription=a,a=function(c,d,l){let h=o.apply(this,[c]);return l?(h.then(d,l),Z.resolve()):h},e.setRemoteDescription=a,a=function(c,d,l){let h=s.apply(this,[c]);return l?(h.then(d,l),Z.resolve()):h},e.addIceCandidate=a}function vO(n){let e=n&&n.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){let t=e.mediaDevices,i=t.getUserMedia.bind(t);e.mediaDevices.getUserMedia=r=>i(CO(r))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(t,i,r){e.mediaDevices.getUserMedia(t).then(i,r)}).bind(e))}function CO(n){return n&&n.video!==void 0?Object.assign({},n,{video:Xb(n.video)}):n}function yO(n){if(!n.RTCPeerConnection)return;let e=n.RTCPeerConnection;n.RTCPeerConnection=function(t,i){if(t&&t.iceServers){let r=[];for(let o=0;o<t.iceServers.length;o++){let s=t.iceServers[o];!s.hasOwnProperty("urls")&&s.hasOwnProperty("url")?(dS("RTCIceServer.url","RTCIceServer.urls"),s=JSON.parse(JSON.stringify(s)),s.urls=s.url,delete s.url,r.push(s)):r.push(t.iceServers[o])}t.iceServers=r}return new e(t,i)},n.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(n.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate})}function IO(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function AO(n){let e=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(t){if(t){t.offerToReceiveAudio!==void 0&&(t.offerToReceiveAudio=!!t.offerToReceiveAudio);let i=this.getTransceivers().find(o=>o.receiver.track.kind==="audio");t.offerToReceiveAudio===!1&&i?i.direction==="sendrecv"?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":i.direction==="recvonly"&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):t.offerToReceiveAudio!==!0||i||this.addTransceiver("audio",{direction:"recvonly"}),t.offerToReceiveVideo!==void 0&&(t.offerToReceiveVideo=!!t.offerToReceiveVideo);let r=this.getTransceivers().find(o=>o.receiver.track.kind==="video");t.offerToReceiveVideo===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):t.offerToReceiveVideo!==!0||r||this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function wO(n){typeof n!="object"||n.AudioContext||(n.AudioContext=n.webkitAudioContext)}var bO=Object.freeze({__proto__:null,shimAudioContext:wO,shimCallbacksAPI:RO,shimConstraints:CO,shimCreateOfferLegacy:AO,shimGetUserMedia:vO,shimLocalStreamsAPI:SO,shimRTCIceServerUrls:yO,shimRemoteStreamsAPI:TO,shimTrackEventTransceiver:IO}),OO=`	
\v\f\r \u2028\u2029\uFEFF`,wH=Vs,bH=xr,pS=OO,NO=he("".replace),OH=RegExp("^["+pS+"]+"),NH=RegExp("(^|[^"+pS+"])["+pS+"]+$"),DH=function(n){return function(e){var t=bH(wH(e));return t=NO(t,OH,""),t=NO(t,NH,"$1"),t}},PH={trim:DH()},LH=hA.PROPER,kH=P,DO=OO,MH=PH.trim;qe({target:"String",proto:!0,forced:function(n){return kH(function(){return!!DO[n]()||""[n]()!==""||LH&&DO[n].name!==n})}("trim")},{trim:function(){return MH(this)}});var UH=ln("String","trim"),xH=me,VH=UH,_S=String.prototype,FH=function(n){var e=n.trim;return typeof n=="string"||n===_S||xH(_S,n)&&e===_S.trim?VH:e},rr=A(FH),PO={exports:{}};(function(n){let e={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};e.localCName=e.generateIdentifier(),e.splitLines=function(t){return t.trim().split(`
`).map(i=>i.trim())},e.splitSections=function(t){return t.split(`
m=`).map((i,r)=>(r>0?"m="+i:i).trim()+`\r
`)},e.getDescription=function(t){let i=e.splitSections(t);return i&&i[0]},e.getMediaSections=function(t){let i=e.splitSections(t);return i.shift(),i},e.matchPrefix=function(t,i){return e.splitLines(t).filter(r=>r.indexOf(i)===0)},e.parseCandidate=function(t){let i;i=t.indexOf("a=candidate:")===0?t.substring(12).split(" "):t.substring(10).split(" ");let r={foundation:i[0],component:{1:"rtp",2:"rtcp"}[i[1]]||i[1],protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]};for(let o=8;o<i.length;o+=2)switch(i[o]){case"raddr":r.relatedAddress=i[o+1];break;case"rport":r.relatedPort=parseInt(i[o+1],10);break;case"tcptype":r.tcpType=i[o+1];break;case"ufrag":r.ufrag=i[o+1],r.usernameFragment=i[o+1];break;default:r[i[o]]===void 0&&(r[i[o]]=i[o+1])}return r},e.writeCandidate=function(t){let i=[];i.push(t.foundation);let r=t.component;r==="rtp"?i.push(1):r==="rtcp"?i.push(2):i.push(r),i.push(t.protocol.toUpperCase()),i.push(t.priority),i.push(t.address||t.ip),i.push(t.port);let o=t.type;return i.push("typ"),i.push(o),o!=="host"&&t.relatedAddress&&t.relatedPort&&(i.push("raddr"),i.push(t.relatedAddress),i.push("rport"),i.push(t.relatedPort)),t.tcpType&&t.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(i.push("ufrag"),i.push(t.usernameFragment||t.ufrag)),"candidate:"+i.join(" ")},e.parseIceOptions=function(t){return t.substring(14).split(" ")},e.parseRtpMap=function(t){let i=t.substring(9).split(" "),r={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),r.name=i[0],r.clockRate=parseInt(i[1],10),r.channels=i.length===3?parseInt(i[2],10):1,r.numChannels=r.channels,r},e.writeRtpMap=function(t){let i=t.payloadType;t.preferredPayloadType!==void 0&&(i=t.preferredPayloadType);let r=t.channels||t.numChannels||1;return"a=rtpmap:"+i+" "+t.name+"/"+t.clockRate+(r!==1?"/"+r:"")+`\r
`},e.parseExtmap=function(t){let i=t.substring(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1],attributes:i.slice(2).join(" ")}},e.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&t.direction!=="sendrecv"?"/"+t.direction:"")+" "+t.uri+(t.attributes?" "+t.attributes:"")+`\r
`},e.parseFmtp=function(t){let i={},r,o=t.substring(t.indexOf(" ")+1).split(";");for(let s=0;s<o.length;s++)r=o[s].trim().split("="),i[r[0].trim()]=r[1];return i},e.writeFmtp=function(t){let i="",r=t.payloadType;if(t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){let o=[];Object.keys(t.parameters).forEach(s=>{t.parameters[s]!==void 0?o.push(s+"="+t.parameters[s]):o.push(s)}),i+="a=fmtp:"+r+" "+o.join(";")+`\r
`}return i},e.parseRtcpFb=function(t){let i=t.substring(t.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},e.writeRtcpFb=function(t){let i="",r=t.payloadType;return t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach(o=>{i+="a=rtcp-fb:"+r+" "+o.type+(o.parameter&&o.parameter.length?" "+o.parameter:"")+`\r
`}),i},e.parseSsrcMedia=function(t){let i=t.indexOf(" "),r={ssrc:parseInt(t.substring(7,i),10)},o=t.indexOf(":",i);return o>-1?(r.attribute=t.substring(i+1,o),r.value=t.substring(o+1)):r.attribute=t.substring(i+1),r},e.parseSsrcGroup=function(t){let i=t.substring(13).split(" ");return{semantics:i.shift(),ssrcs:i.map(r=>parseInt(r,10))}},e.getMid=function(t){let i=e.matchPrefix(t,"a=mid:")[0];if(i)return i.substring(6)},e.parseFingerprint=function(t){let i=t.substring(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1].toUpperCase()}},e.getDtlsParameters=function(t,i){return{role:"auto",fingerprints:e.matchPrefix(t+i,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(t,i){let r="a=setup:"+i+`\r
`;return t.fingerprints.forEach(o=>{r+="a=fingerprint:"+o.algorithm+" "+o.value+`\r
`}),r},e.parseCryptoLine=function(t){let i=t.substring(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},e.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+(typeof t.keyParams=="object"?e.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(t){if(t.indexOf("inline:")!==0)return null;let i=t.substring(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")},e.getCryptoParameters=function(t,i){return e.matchPrefix(t+i,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(t,i){let r=e.matchPrefix(t+i,"a=ice-ufrag:")[0],o=e.matchPrefix(t+i,"a=ice-pwd:")[0];return r&&o?{usernameFragment:r.substring(12),password:o.substring(10)}:null},e.writeIceParameters=function(t){let i="a=ice-ufrag:"+t.usernameFragment+`\r
a=ice-pwd:`+t.password+`\r
`;return t.iceLite&&(i+=`a=ice-lite\r
`),i},e.parseRtpParameters=function(t){let i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=e.splitLines(t)[0].split(" ");i.profile=r[2];for(let s=3;s<r.length;s++){let a=r[s],c=e.matchPrefix(t,"a=rtpmap:"+a+" ")[0];if(c){let d=e.parseRtpMap(c),l=e.matchPrefix(t,"a=fmtp:"+a+" ");switch(d.parameters=l.length?e.parseFmtp(l[0]):{},d.rtcpFeedback=e.matchPrefix(t,"a=rtcp-fb:"+a+" ").map(e.parseRtcpFb),i.codecs.push(d),d.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(d.name.toUpperCase())}}}e.matchPrefix(t,"a=extmap:").forEach(s=>{i.headerExtensions.push(e.parseExtmap(s))});let o=e.matchPrefix(t,"a=rtcp-fb:* ").map(e.parseRtcpFb);return i.codecs.forEach(s=>{o.forEach(a=>{s.rtcpFeedback.find(c=>c.type===a.type&&c.parameter===a.parameter)||s.rtcpFeedback.push(a)})}),i},e.writeRtpDescription=function(t,i){let r="";r+="m="+t+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map(s=>s.preferredPayloadType!==void 0?s.preferredPayloadType:s.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach(s=>{r+=e.writeRtpMap(s),r+=e.writeFmtp(s),r+=e.writeRtcpFb(s)});let o=0;return i.codecs.forEach(s=>{s.maxptime>o&&(o=s.maxptime)}),o>0&&(r+="a=maxptime:"+o+`\r
`),i.headerExtensions&&i.headerExtensions.forEach(s=>{r+=e.writeExtmap(s)}),r},e.parseRtpEncodingParameters=function(t){let i=[],r=e.parseRtpParameters(t),o=r.fecMechanisms.indexOf("RED")!==-1,s=r.fecMechanisms.indexOf("ULPFEC")!==-1,a=e.matchPrefix(t,"a=ssrc:").map(p=>e.parseSsrcMedia(p)).filter(p=>p.attribute==="cname"),c=a.length>0&&a[0].ssrc,d,l=e.matchPrefix(t,"a=ssrc-group:FID").map(p=>p.substring(17).split(" ").map(f=>parseInt(f,10)));l.length>0&&l[0].length>1&&l[0][0]===c&&(d=l[0][1]),r.codecs.forEach(p=>{if(p.name.toUpperCase()==="RTX"&&p.parameters.apt){let f={ssrc:c,codecPayloadType:parseInt(p.parameters.apt,10)};c&&d&&(f.rtx={ssrc:d}),i.push(f),o&&(f=JSON.parse(JSON.stringify(f)),f.fec={ssrc:c,mechanism:s?"red+ulpfec":"red"},i.push(f))}}),i.length===0&&c&&i.push({ssrc:c});let h=e.matchPrefix(t,"b=");return h.length&&(h=h[0].indexOf("b=TIAS:")===0?parseInt(h[0].substring(7),10):h[0].indexOf("b=AS:")===0?1e3*parseInt(h[0].substring(5),10)*.95-16e3:void 0,i.forEach(p=>{p.maxBitrate=h})),i},e.parseRtcpParameters=function(t){let i={},r=e.matchPrefix(t,"a=ssrc:").map(a=>e.parseSsrcMedia(a)).filter(a=>a.attribute==="cname")[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);let o=e.matchPrefix(t,"a=rtcp-rsize");i.reducedSize=o.length>0,i.compound=o.length===0;let s=e.matchPrefix(t,"a=rtcp-mux");return i.mux=s.length>0,i},e.writeRtcpParameters=function(t){let i="";return t.reducedSize&&(i+=`a=rtcp-rsize\r
`),t.mux&&(i+=`a=rtcp-mux\r
`),t.ssrc!==void 0&&t.cname&&(i+="a=ssrc:"+t.ssrc+" cname:"+t.cname+`\r
`),i},e.parseMsid=function(t){let i,r=e.matchPrefix(t,"a=msid:");if(r.length===1)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};let o=e.matchPrefix(t,"a=ssrc:").map(s=>e.parseSsrcMedia(s)).filter(s=>s.attribute==="msid");return o.length>0?(i=o[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},e.parseSctpDescription=function(t){let i=e.parseMLine(t),r=e.matchPrefix(t,"a=max-message-size:"),o;r.length>0&&(o=parseInt(r[0].substring(19),10)),isNaN(o)&&(o=65536);let s=e.matchPrefix(t,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substring(12),10),protocol:i.fmt,maxMessageSize:o};let a=e.matchPrefix(t,"a=sctpmap:");if(a.length>0){let c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:o}}},e.writeSctpDescription=function(t,i){let r=[];return r=t.protocol!=="DTLS/SCTP"?["m="+t.kind+" 9 "+t.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:["m="+t.kind+" 9 "+t.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&r.push("a=max-message-size:"+i.maxMessageSize+`\r
`),r.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(t,i,r){let o,s=i!==void 0?i:2;return o=t||e.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+o+" "+s+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(t,i){let r=e.splitLines(t);for(let o=0;o<r.length;o++)switch(r[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[o].substring(2)}return i?e.getDirection(i):"sendrecv"},e.getKind=function(t){return e.splitLines(t)[0].split(" ")[0].substring(2)},e.isRejected=function(t){return t.split(" ",2)[1]==="0"},e.parseMLine=function(t){let i=e.splitLines(t)[0].substring(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},e.parseOLine=function(t){let i=e.matchPrefix(t,"o=")[0].substring(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},e.isValidSDP=function(t){if(typeof t!="string"||t.length===0)return!1;let i=e.splitLines(t);for(let r=0;r<i.length;r++)if(i[r].length<2||i[r].charAt(1)!=="=")return!1;return!0},n.exports=e})(PO);var LO=PO.exports,Od=A(LO),BH=E({__proto__:null,default:Od},[LO]);function n_(n){if(!n.RTCIceCandidate||n.RTCIceCandidate&&"foundation"in n.RTCIceCandidate.prototype)return;let e=n.RTCIceCandidate;n.RTCIceCandidate=function(t){if(typeof t=="object"&&t.candidate&&t.candidate.indexOf("a=")===0&&((t=JSON.parse(JSON.stringify(t))).candidate=t.candidate.substr(2)),t.candidate&&t.candidate.length){let i=new e(t),r=Od.parseCandidate(t.candidate),o=Object.assign(i,r);return o.toJSON=function(){return{candidate:o.candidate,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex,usernameFragment:o.usernameFragment}},o}return new e(t)},n.RTCIceCandidate.prototype=e.prototype,qa(n,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new n.RTCIceCandidate(t.candidate),writable:"false"}),t))}function fS(n){!n.RTCIceCandidate||n.RTCIceCandidate&&"relayProtocol"in n.RTCIceCandidate.prototype||qa(n,"icecandidate",e=>{if(e.candidate){let t=Od.parseCandidate(e.candidate.candidate);t.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e})}function o_(n,e){if(!n.RTCPeerConnection)return;"sctp"in n.RTCPeerConnection.prototype||Object.defineProperty(n.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});let t=function(a){if(!a||!a.sdp)return!1;let c=Od.splitSections(a.sdp);return c.shift(),c.some(d=>{let l=Od.parseMLine(d);return l&&l.kind==="application"&&l.protocol.indexOf("SCTP")!==-1})},i=function(a){let c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;let d=parseInt(c[1],10);return d!=d?-1:d},r=function(a){let c=65536;return e.browser==="firefox"&&(c=e.version<57?a===-1?16384:2147483637:e.version<60?e.version===57?65535:65536:2147483637),c},o=function(a,c){let d=65536;e.browser==="firefox"&&e.version===57&&(d=65535);let l=Od.matchPrefix(a.sdp,"a=max-message-size:");return l.length>0?d=parseInt(l[0].substr(19),10):e.browser==="firefox"&&c!==-1&&(d=2147483637),d},s=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){let{sdpSemantics:a}=this.getConfiguration();a==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(t(arguments[0])){let a=i(arguments[0]),c=r(a),d=o(arguments[0],a),l;l=c===0&&d===0?Number.POSITIVE_INFINITY:c===0||d===0?Math.max(c,d):Math.min(c,d);let h={};Object.defineProperty(h,"maxMessageSize",{get:()=>l}),this._sctp=h}return s.apply(this,arguments)}}function s_(n){if(!n.RTCPeerConnection||!("createDataChannel"in n.RTCPeerConnection.prototype))return;function e(i,r){let o=i.send;i.send=function(){let s=arguments[0],a=s.length||s.size||s.byteLength;if(i.readyState==="open"&&r.sctp&&a>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return o.apply(i,arguments)}}let t=n.RTCPeerConnection.prototype.createDataChannel;n.RTCPeerConnection.prototype.createDataChannel=function(){let i=t.apply(this,arguments);return e(i,this),i},qa(n,"datachannel",i=>(e(i.channel,i.target),i))}function mS(n){if(!n.RTCPeerConnection||"connectionState"in n.RTCPeerConnection.prototype)return;let e=n.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(t=>{let i=e[t];e[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{let o=r.target;if(o._lastConnectionState!==o.connectionState){o._lastConnectionState=o.connectionState;let s=new Event("connectionstatechange",r);o.dispatchEvent(s)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function ES(n,e){if(!n.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e.version>=605)return;let t=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(i){if(i&&i.sdp&&i.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){let r=i.sdp.split(`
`).filter(o=>rr(o).call(o)!=="a=extmap-allow-mixed").join(`
`);n.RTCSessionDescription&&i instanceof n.RTCSessionDescription?arguments[0]=new n.RTCSessionDescription({type:i.type,sdp:r}):i.sdp=r}return t.apply(this,arguments)}}function a_(n,e){if(!n.RTCPeerConnection||!n.RTCPeerConnection.prototype)return;let t=n.RTCPeerConnection.prototype.addIceCandidate;t&&t.length!==0&&(n.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Z.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Z.resolve())})}function c_(n,e){if(!n.RTCPeerConnection||!n.RTCPeerConnection.prototype)return;let t=n.RTCPeerConnection.prototype.setLocalDescription;t&&t.length!==0&&(n.RTCPeerConnection.prototype.setLocalDescription=function(){let i=arguments[0]||{};if(typeof i!="object"||i.type&&i.sdp)return t.apply(this,arguments);if(i={type:i.type,sdp:i.sdp},!i.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":i.type="offer";break;default:i.type="answer"}return i.sdp||i.type!=="offer"&&i.type!=="answer"?t.apply(this,[i]):(i.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(r=>t.apply(this,[r]))})}var jH=Object.freeze({__proto__:null,removeExtmapAllowMixed:ES,shimAddIceCandidateNullOrEmpty:a_,shimConnectionState:mS,shimMaxMessageSize:o_,shimParameterlessSetLocalDescription:c_,shimRTCIceCandidate:n_,shimRTCIceCandidateRelayProtocol:fS,shimSendThrowTypeError:s_});(function(){let{window:n}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0},t=zb,i=function(o){let s={browser:null,version:null};if(o===void 0||!o.navigator)return s.browser="Not a browser.",s;let{navigator:a}=o;if(a.mozGetUserMedia)s.browser="firefox",s.version=r_(a.userAgent,/Firefox\/(\d+)\./,1);else if(a.webkitGetUserMedia||o.isSecureContext===!1&&o.webkitRTCPeerConnection)s.browser="chrome",s.version=r_(a.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!o.RTCPeerConnection||!a.userAgent.match(/AppleWebKit\/(\d+)\./))return s.browser="Not a supported browser.",s;s.browser="safari",s.version=r_(a.userAgent,/AppleWebKit\/(\d+)\./,1),s.supportsUnifiedPlan=o.RTCRtpTransceiver&&"currentDirection"in o.RTCRtpTransceiver.prototype}return s}(n),r={browserDetails:i,commonShim:jH,extractVersion:r_,disableLog:IH,disableWarnings:AH,sdp:BH};switch(i.browser){case"chrome":if(!aO||!uS||!e.shimChrome)return t("Chrome shim is not included in this adapter release."),r;if(i.version===null)return t("Chrome shim can not determine version, not shimming."),r;t("adapter.js shimming chrome."),r.browserShim=aO,a_(n,i),c_(n),Zb(n,i),$b(n),uS(n,i),eO(n),oO(n,i),tO(n),iO(n),rO(n),sO(n,i),n_(n),fS(n),mS(n),o_(n,i),s_(n),ES(n,i);break;case"firefox":if(!gO||!hS||!e.shimFirefox)return t("Firefox shim is not included in this adapter release."),r;t("adapter.js shimming firefox."),r.browserShim=gO,a_(n,i),c_(n),cO(n,i),hS(n,i),dO(n),hO(n),lO(n),uO(n),pO(n),_O(n),fO(n),mO(n),EO(n),n_(n),mS(n),o_(n,i),s_(n);break;case"safari":if(!bO||!e.shimSafari)return t("Safari shim is not included in this adapter release."),r;t("adapter.js shimming safari."),r.browserShim=bO,a_(n,i),c_(n),yO(n),AO(n),RO(n),SO(n),TO(n),IO(n),vO(n),wO(n),n_(n),fS(n),o_(n,i),s_(n),ES(n,i);break;default:t("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var GH=P,kO=ve.RegExp,WH=!GH(function(){var n=!0;try{kO(".","d")}catch{n=!1}var e={},t="",i=n?"dgimsy":"gimsy",r=function(a,c){Object.defineProperty(e,a,{get:function(){return t+=c,!0}})},o={dotAll:"s",global:"g",ignoreCase:"i",multiline:"m",sticky:"y"};for(var s in n&&(o.hasIndices="d"),o)r(s,o[s]);return Object.getOwnPropertyDescriptor(kO.prototype,"flags").get.call(e)!==i||t!==i}),HH=Ur,KH=gi,YH=Bi,zH=me,MO={correct:WH},qH=function(){var n=HH(this),e="";return n.hasIndices&&(e+="d"),n.global&&(e+="g"),n.ignoreCase&&(e+="i"),n.multiline&&(e+="m"),n.dotAll&&(e+="s"),n.unicode&&(e+="u"),n.unicodeSets&&(e+="v"),n.sticky&&(e+="y"),e},XH=RegExp.prototype,gS=MO.correct?function(n){return n.flags}:function(n){return MO.correct||!zH(XH,n)||YH(n,"flags")?n.flags:KH(qH,n)},SS=he,JH=Math.floor,TS=SS("".charAt),QH=SS("".replace),RS=SS("".slice),ZH=/\$([$&'`]|\d{1,2})/g,$H=qe,eK=gi,vS=he,UO=Vs,tK=ci,iK=ir,rK=yE,Nd=xr,nK=Jl,oK=gS,sK=function(n,e,t,i,r,o){var s=t+n.length,a=i.length,c=ZH;return QH(o,c,function(d,l){var h;switch(TS(l,0)){case"$":return"$";case"&":return n;case"`":return RS(e,0,t);case"'":return RS(e,s);case"<":h=r[RS(l,1,-1)];break;default:var p=+l;if(p===0)return d;if(p>a){var f=JH(p/10);return f===0?d:f<=a?i[f-1]===void 0?TS(l,1):i[f-1]+TS(l,1):d}h=i[p-1]}return h===void 0?"":h})},aK=qt("replace"),cK=TypeError,CS=vS("".indexOf),dK=vS("".replace),xO=vS("".slice),lK=Math.max;$H({target:"String",proto:!0},{replaceAll:function(n,e){var t,i,r,o,s,a,c,d,l,h,p=UO(this),f=0,m="";if(iK(n)){if((t=rK(n))&&(i=Nd(UO(oK(n))),!~CS(i,"g")))throw new cK("`.replaceAll` does not allow non-global regexes");if(r=nK(n,aK))return eK(r,n,p,e);if(t)return dK(Nd(p),n,e)}for(o=Nd(p),s=Nd(n),(a=tK(e))||(e=Nd(e)),c=s.length,d=lK(1,c),l=CS(o,s);l!==-1;)h=a?Nd(e(s,l,o)):sK(s,o,l,[],void 0,e),m+=xO(o,f,l)+h,f=l+c,l=l+d>o.length?-1:CS(o,s,l+d);return f<o.length&&(m+=xO(o,f)),m}});var uK=ln("String","replaceAll"),hK=me,pK=uK,yS=String.prototype,_K=function(n){var e=n.replaceAll;return typeof n=="string"||n===yS||hK(yS,n)&&e===yS.replaceAll?pK:e},fK=A(_K),IS=ve;qe({global:!0,forced:IS.globalThis!==IS},{globalThis:IS});var VO=A(ve),AS={exports:{}};(function(n,e){(function(t,i){var r="function",o="undefined",s="object",a="string",c="major",d="model",l="name",h="type",p="vendor",f="version",m="architecture",g="console",S="mobile",T="tablet",C="smarttv",b="wearable",D="embedded",x="Amazon",k="Apple",V="ASUS",W="BlackBerry",K="Browser",J="Chrome",se="Firefox",Ne="Google",Ce="Honor",De="Huawei",Me="LG",et="Microsoft",ae="Motorola",Y="Nvidia",ie="OnePlus",Q="Opera",w="OPPO",v="Samsung",N="Sharp",j="Sony",ne="Xiaomi",Ve="Zebra",wt="Facebook",Ji="Chromium OS",Ro="Mac OS",cl=" Browser",nh=function(Or){for(var ti={},Ot=0;Ot<Or.length;Ot++)ti[Or[Ot].toUpperCase()]=Or[Ot];return ti},oh=function(Or,ti){return typeof Or===a&&jl(ti).indexOf(jl(Or))!==-1},jl=function(Or){return Or.toLowerCase()},dl=function(Or,ti){if(typeof Or===a)return Or=Or.replace(/^\s\s*/,""),typeof ti===o?Or:Or.substring(0,500)},ll=function(Or,ti){for(var Ot,si,dn,Fi,qi,kt,Lt=0;Lt<ti.length&&!qi;){var gs=ti[Lt],Ms=ti[Lt+1];for(Ot=si=0;Ot<gs.length&&!qi&&gs[Ot];)if(qi=gs[Ot++].exec(Or))for(dn=0;dn<Ms.length;dn++)kt=qi[++si],typeof(Fi=Ms[dn])===s&&Fi.length>0?Fi.length===2?typeof Fi[1]==r?this[Fi[0]]=Fi[1].call(this,kt):this[Fi[0]]=Fi[1]:Fi.length===3?typeof Fi[1]!==r||Fi[1].exec&&Fi[1].test?this[Fi[0]]=kt?kt.replace(Fi[1],Fi[2]):i:this[Fi[0]]=kt?Fi[1].call(this,kt,Fi[2]):i:Fi.length===4&&(this[Fi[0]]=kt?Fi[3].call(this,kt.replace(Fi[1],Fi[2])):i):this[Fi]=kt||i;Lt+=2}},Pa=function(Or,ti){for(var Ot in ti)if(typeof ti[Ot]===s&&ti[Ot].length>0){for(var si=0;si<ti[Ot].length;si++)if(oh(ti[Ot][si],Or))return Ot==="?"?i:Ot}else if(oh(ti[Ot],Or))return Ot==="?"?i:Ot;return ti.hasOwnProperty("*")?ti["*"]:Or},sh={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},h1={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[f,[l,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[f,[l,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[l,f],[/opios[\/ ]+([\w\.]+)/i],[f,[l,Q+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[f,[l,Q+" GX"]],[/\bopr\/([\w\.]+)/i],[f,[l,Q]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[f,[l,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[f,[l,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon)\/([-\w\.]+)/i,/(heytap|ovi|115)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[l,f],[/quark(?:pc)?\/([-\w\.]+)/i],[f,[l,"Quark"]],[/\bddg\/([\w\.]+)/i],[f,[l,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[f,[l,"UC"+K]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[f,[l,"WeChat"]],[/konqueror\/([\w\.]+)/i],[f,[l,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[f,[l,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[f,[l,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[f,[l,"Smart Lenovo "+K]],[/(avast|avg)\/([\w\.]+)/i],[[l,/(.+)/,"$1 Secure "+K],f],[/\bfocus\/([\w\.]+)/i],[f,[l,se+" Focus"]],[/\bopt\/([\w\.]+)/i],[f,[l,Q+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[f,[l,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[f,[l,"Dolphin"]],[/coast\/([\w\.]+)/i],[f,[l,Q+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[f,[l,"MIUI"+cl]],[/fxios\/([\w\.-]+)/i],[f,[l,se]],[/\bqihoobrowser\/?([\w\.]*)/i],[f,[l,"360"]],[/\b(qq)\/([\w\.]+)/i],[[l,/(.+)/,"$1Browser"],f],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[l,/(.+)/,"$1"+cl],f],[/samsungbrowser\/([\w\.]+)/i],[f,[l,v+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[f,[l,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[l,"Sogou Mobile"],f],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[l,f],[/(lbbrowser|rekonq)/i,/\[(linkedin)app\]/i],[l],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[f,l],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[l,wt],f],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/(daum)apps[\/ ]([\w\.]+)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[l,f],[/\bgsa\/([\w\.]+) .*safari\//i],[f,[l,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[f,[l,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[f,[l,J+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[l,J+" WebView"],f],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[f,[l,"Android "+K]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[l,f],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[f,[l,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[f,l],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[l,[f,Pa,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[l,f],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[l,"Netscape"],f],[/(wolvic|librewolf)\/([\w\.]+)/i],[l,f],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[f,[l,se+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(amaya|dillo|doris|icab|ladybird|lynx|mosaic|netsurf|obigo|polaris|w3m|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/\b(links) \(([\w\.]+)/i],[l,[f,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[l,[f,/master.|lts./,""]]],cpu:[[/\b((amd|x|x86[-_]?|wow|win)64)\b/i],[[m,"amd64"]],[/(ia32(?=;))/i,/\b((i[346]|x)86)(pc)?\b/i],[[m,"ia32"]],[/\b(aarch64|arm(v?[89]e?l?|_?64))\b/i],[[m,"arm64"]],[/\b(arm(v[67])?ht?n?[fl]p?)\b/i],[[m,"armhf"]],[/( (ce|mobile); ppc;|\/[\w\.]+arm\b)/i],[[m,"arm"]],[/((ppc|powerpc)(64)?)( mac|;|\))/i],[[m,/ower/,"",jl]],[/ sun4\w[;\)]/i],[[m,"sparc"]],[/\b(avr32|ia64(?=;)|68k(?=\))|\barm(?=v([1-7]|[5-7]1)l?|;|eabi)|(irix|mips|sparc)(64)?\b|pa-risc)/i],[[m,jl]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[p,v],[h,T]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr])[-\w]+)/i,/sec-(sgh\w+)/i],[d,[p,v],[h,S]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[d,[p,k],[h,S]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[p,k],[h,T]],[/(macintosh);/i],[d,[p,k]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[p,N],[h,S]],[/\b((?:brt|eln|hey2?|gdi|jdn)-a?[lnw]09|(?:ag[rm]3?|jdn2|kob2)-a?[lw]0[09]hn)(?: bui|\)|;)/i],[d,[p,Ce],[h,T]],[/honor([-\w ]+)[;\)]/i],[d,[p,Ce],[h,S]],[/\b((?:ag[rs][2356]?k?|bah[234]?|bg[2o]|bt[kv]|cmr|cpn|db[ry]2?|jdn2|got|kob2?k?|mon|pce|scm|sht?|[tw]gr|vrd)-[ad]?[lw][0125][09]b?|605hw|bg2-u03|(?:gem|fdr|m2|ple|t1)-[7a]0[1-4][lu]|t1-a2[13][lw]|mediapad[\w\. ]*(?= bui|\)))\b(?!.+d\/s)/i],[d,[p,De],[h,T]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[p,De],[h,S]],[/oid[^\)]+; (2[\dbc]{4}(182|283|rp\w{2})[cgl]|m2105k81a?c)(?: bui|\))/i,/\b((?:red)?mi[-_ ]?pad[\w- ]*)(?: bui|\))/i],[[d,/_/g," "],[p,ne],[h,T]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i,/ ([\w ]+) miui\/v?\d/i],[[d,/_/g," "],[p,ne],[h,S]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[p,w],[h,S]],[/\b(opd2(\d{3}a?))(?: bui|\))/i],[d,[p,Pa,{OnePlus:["304","403","203"],"*":w}],[h,T]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[p,"Vivo"],[h,S]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[d,[p,"Realme"],[h,S]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto(?! 360)[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[p,ae],[h,S]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[p,ae],[h,T]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[p,Me],[h,T]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv|watch)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[p,Me],[h,S]],[/(ideatab[-\w ]+|602lv|d-42a|a101lv|a2109a|a3500-hv|s[56]000|pb-6505[my]|tb-?x?\d{3,4}(?:f[cu]|xu|[av])|yt\d?-[jx]?\d+[lfmx])( bui|;|\)|\/)/i,/lenovo ?(b[68]0[08]0-?[hf]?|tab(?:[\w- ]+?)|tb[\w-]{6,7})( bui|;|\)|\/)/i],[d,[p,"Lenovo"],[h,T]],[/(nokia) (t[12][01])/i],[p,d,[h,T]],[/(?:maemo|nokia).*(n900|lumia \d+|rm-\d+)/i,/nokia[-_ ]?(([-\w\. ]*))/i],[[d,/_/g," "],[h,S],[p,"Nokia"]],[/(pixel (c|tablet))\b/i],[d,[p,Ne],[h,T]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[p,Ne],[h,S]],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[p,j],[h,S]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[p,j],[h,T]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[p,ie],[h,S]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[p,x],[h,T]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[p,x],[h,S]],[/(playbook);[-\w\),; ]+(rim)/i],[d,p,[h,T]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[p,W],[h,S]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[p,V],[h,T]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[p,V],[h,S]],[/(nexus 9)/i],[d,[p,"HTC"],[h,T]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[p,[d,/_/g," "],[h,S]],[/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])\w*(\)| bui)/i],[d,[p,"TCL"],[h,T]],[/(itel) ((\w+))/i],[[p,jl],d,[h,Pa,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[p,"Acer"],[h,T]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[p,"Meizu"],[h,S]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[d,[p,"Ulefone"],[h,S]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[d,[p,"Energizer"],[h,S]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[d,[p,"Cat"],[h,S]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[d,[p,"Smartfren"],[h,S]],[/droid.+; (a(?:015|06[35]|142p?))/i],[d,[p,"Nothing"],[h,S]],[/; (x67 5g|tikeasy \w+|ac[1789]\d\w+)( b|\))/i,/archos ?(5|gamepad2?|([\w ]*[t1789]|hello) ?\d+[\w ]*)( b|\))/i],[d,[p,"Archos"],[h,T]],[/archos ([\w ]+)( b|\))/i,/; (ac[3-6]\d\w{2,8})( b|\))/i],[d,[p,"Archos"],[h,S]],[/(imo) (tab \w+)/i,/(infinix) (x1101b?)/i],[p,d,[h,T]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus(?! zenw)|dell|jolla|meizu|motorola|polytron|infinix|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (hmd|imo) ([\w ]+?)(?: bui|\))/i,/(hp) ([\w ]+\w)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w ]+?)(?: bui|\)|\/)/i,/(oppo) ?([\w ]+) bui/i],[p,d,[h,S]],[/(kobo)\s(ereader|touch)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[p,d,[h,T]],[/(surface duo)/i],[d,[p,et],[h,T]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[p,"Fairphone"],[h,S]],[/(u304aa)/i],[d,[p,"AT&T"],[h,S]],[/\bsie-(\w*)/i],[d,[p,"Siemens"],[h,S]],[/\b(rct\w+) b/i],[d,[p,"RCA"],[h,T]],[/\b(venue[\d ]{2,7}) b/i],[d,[p,"Dell"],[h,T]],[/\b(q(?:mv|ta)\w+) b/i],[d,[p,"Verizon"],[h,T]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[p,"Barnes & Noble"],[h,T]],[/\b(tm\d{3}\w+) b/i],[d,[p,"NuVision"],[h,T]],[/\b(k88) b/i],[d,[p,"ZTE"],[h,T]],[/\b(nx\d{3}j) b/i],[d,[p,"ZTE"],[h,S]],[/\b(gen\d{3}) b.+49h/i],[d,[p,"Swiss"],[h,S]],[/\b(zur\d{3}) b/i],[d,[p,"Swiss"],[h,T]],[/\b((zeki)?tb.*\b) b/i],[d,[p,"Zeki"],[h,T]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[p,"Dragon Touch"],d,[h,T]],[/\b(ns-?\w{0,9}) b/i],[d,[p,"Insignia"],[h,T]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[p,"NextBook"],[h,T]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[p,"Voice"],d,[h,S]],[/\b(lvtel\-)?(v1[12]) b/i],[[p,"LvTel"],d,[h,S]],[/\b(ph-1) /i],[d,[p,"Essential"],[h,S]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[p,"Envizen"],[h,T]],[/\b(trio[-\w\. ]+) b/i],[d,[p,"MachSpeed"],[h,T]],[/\btu_(1491) b/i],[d,[p,"Rotor"],[h,T]],[/((?:tegranote|shield t(?!.+d tv))[\w- ]*?)(?: b|\))/i],[d,[p,Y],[h,T]],[/(sprint) (\w+)/i],[p,d,[h,S]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[p,et],[h,S]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[p,Ve],[h,T]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[p,Ve],[h,S]],[/smart-tv.+(samsung)/i],[p,[h,C]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[p,v],[h,C]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[p,Me],[h,C]],[/(apple) ?tv/i],[p,[d,k+" TV"],[h,C]],[/crkey/i],[[d,J+"cast"],[p,Ne],[h,C]],[/droid.+aft(\w+)( bui|\))/i],[d,[p,x],[h,C]],[/(shield \w+ tv)/i],[d,[p,Y],[h,C]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[p,N],[h,C]],[/(bravia[\w ]+)( bui|\))/i],[d,[p,j],[h,C]],[/(mi(tv|box)-?\w+) bui/i],[d,[p,ne],[h,C]],[/Hbbtv.*(technisat) (.*);/i],[p,d,[h,C]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[p,dl],[d,dl],[h,C]],[/droid.+; ([\w- ]+) (?:android tv|smart[- ]?tv)/i],[d,[h,C]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[h,C]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[p,d,[h,g]],[/droid.+; (shield)( bui|\))/i],[d,[p,Y],[h,g]],[/(playstation \w+)/i],[d,[p,j],[h,g]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[p,et],[h,g]],[/\b(sm-[lr]\d\d[0156][fnuw]?s?|gear live)\b/i],[d,[p,v],[h,b]],[/((pebble))app/i,/(asus|google|lg|oppo) ((pixel |zen)?watch[\w ]*)( bui|\))/i],[p,d,[h,b]],[/(ow(?:19|20)?we?[1-3]{1,3})/i],[d,[p,w],[h,b]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[p,k],[h,b]],[/(opwwe\d{3})/i],[d,[p,ie],[h,b]],[/(moto 360)/i],[d,[p,ae],[h,b]],[/(smartwatch 3)/i],[d,[p,j],[h,b]],[/(g watch r)/i],[d,[p,Me],[h,b]],[/droid.+; (wt63?0{2,3})\)/i],[d,[p,Ve],[h,b]],[/droid.+; (glass) \d/i],[d,[p,Ne],[h,b]],[/(pico) (4|neo3(?: link|pro)?)/i],[p,d,[h,b]],[/; (quest( \d| pro)?)/i],[d,[p,wt],[h,b]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[p,[h,D]],[/(aeobc)\b/i],[d,[p,x],[h,D]],[/(homepod).+mac os/i],[d,[p,k],[h,D]],[/windows iot/i],[[h,D]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[d,[h,S]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[h,T]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[h,T]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[h,S]],[/droid .+?; ([\w\. -]+)( bui|\))/i],[d,[p,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[f,[l,"EdgeHTML"]],[/(arkweb)\/([\w\.]+)/i],[l,f],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[f,[l,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[l,f],[/ladybird\//i],[[l,"LibWeb"]],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[f,l]],os:[[/microsoft (windows) (vista|xp)/i],[l,f],[/(windows (?:phone(?: os)?|mobile|iot))[\/ ]?([\d\.\w ]*)/i],[l,[f,Pa,sh]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[f,Pa,sh],[l,"Windows"]],[/[adehimnop]{4,7}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[f,/_/g,"."],[l,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[l,Ro],[f,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[f,l],[/(ubuntu) ([\w\.]+) like android/i],[[l,/(.+)/,"$1 Touch"],f],[/(android|bada|blackberry|kaios|maemo|meego|openharmony|qnx|rim tablet os|sailfish|series40|symbian|tizen|webos)\w*[-\/; ]?([\d\.]*)/i],[l,f],[/\(bb(10);/i],[f,[l,W]],[/(?:symbian ?os|symbos|s60(?=;)|series ?60)[-\/ ]?([\w\.]*)/i],[f,[l,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[f,[l,se+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[f,[l,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[f,[l,"watchOS"]],[/crkey\/([\d\.]+)/i],[f,[l,J+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[l,Ji],f],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux)(?: arm\w*| x86\w*| ?)([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[l,f],[/(sunos) ?([\w\.\d]*)/i],[[l,"Solaris"],f],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[l,f]]},Qc=function(Or,ti){if(typeof Or===s&&(ti=Or,Or=i),!(this instanceof Qc))return new Qc(Or,ti).getResult();var Ot=typeof t!==o&&t.navigator?t.navigator:i,si=Or||(Ot&&Ot.userAgent?Ot.userAgent:""),dn=Ot&&Ot.userAgentData?Ot.userAgentData:i,Fi=ti?function(kt,Lt){var gs={};for(var Ms in kt)Lt[Ms]&&Lt[Ms].length%2==0?gs[Ms]=Lt[Ms].concat(kt[Ms]):gs[Ms]=kt[Ms];return gs}(h1,ti):h1,qi=Ot&&Ot.userAgent==si;return this.getBrowser=function(){var kt={};return kt[l]=i,kt[f]=i,ll.call(kt,si,Fi.browser),kt[c]=function(Lt){return typeof Lt===a?Lt.replace(/[^\d\.]/g,"").split(".")[0]:i}(kt[f]),qi&&Ot&&Ot.brave&&typeof Ot.brave.isBrave==r&&(kt[l]="Brave"),kt},this.getCPU=function(){var kt={};return kt[m]=i,ll.call(kt,si,Fi.cpu),kt},this.getDevice=function(){var kt={};return kt[p]=i,kt[d]=i,kt[h]=i,ll.call(kt,si,Fi.device),qi&&!kt[h]&&dn&&dn.mobile&&(kt[h]=S),qi&&kt[d]=="Macintosh"&&Ot&&typeof Ot.standalone!==o&&Ot.maxTouchPoints&&Ot.maxTouchPoints>2&&(kt[d]="iPad",kt[h]=T),kt},this.getEngine=function(){var kt={};return kt[l]=i,kt[f]=i,ll.call(kt,si,Fi.engine),kt},this.getOS=function(){var kt={};return kt[l]=i,kt[f]=i,ll.call(kt,si,Fi.os),qi&&!kt[l]&&dn&&dn.platform&&dn.platform!="Unknown"&&(kt[l]=dn.platform.replace(/chrome os/i,Ji).replace(/macos/i,Ro)),kt},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return si},this.setUA=function(kt){return si=typeof kt===a&&kt.length>500?dl(kt,500):kt,this},this.setUA(si),this};Qc.VERSION="0.7.41",Qc.BROWSER=nh([l,f,c]),Qc.CPU=nh([m]),Qc.DEVICE=nh([d,p,h,g,S,C,T,b,D]),Qc.ENGINE=Qc.OS=nh([l,f]),n.exports&&(e=n.exports=Qc),e.UAParser=Qc;var ks=typeof t!==o&&(t.jQuery||t.Zepto);if(ks&&!ks.ua){var ah=new Qc;ks.ua=ah.getResult(),ks.ua.get=function(){return ah.getUA()},ks.ua.set=function(Or){ah.setUA(Or);var ti=ah.getResult();for(var Ot in ti)ks.ua[Ot]=ti[Ot]}}})(typeof window=="object"?window:R)})(AS,AS.exports);var mK=A(AS.exports),FO=Mp.clear;qe({global:!0,bind:!0,forced:ve.clearImmediate!==FO},{clearImmediate:FO});var BO=ve,EK=fe,gK=ci,SK=bE,TK=rs,RK=Hs,vK=Wa,CK=BO.Function,yK=/MSIE .\./.test(TK)||SK==="BUN"&&function(){var n=BO.Bun.version.split(".");return n.length<3||n[0]==="0"&&(n[1]<3||n[1]==="3"&&n[2]==="0")}(),IK=qe,jO=ve,GO=Mp.set,AK=function(n,e){var t=1;return yK?function(i,r){var o=vK(arguments.length,1)>t,s=gK(i)?i:CK(i),a=o?RK(arguments,t):[],c=o?function(){EK(s,this,a)}:s;return n(c)}:n},WO=jO.setImmediate?AK(GO):GO;IK({global:!0,bind:!0,forced:jO.setImmediate!==WO},{setImmediate:WO});var HO=A(Qr.setImmediate),wK=ve,bK=QA,OK=Zr,NK=Wa,DK=ur;qe({global:!0,dontCallGetSet:!0,forced:P(function(){return DK&&Object.getOwnPropertyDescriptor(wK,"queueMicrotask").value.length!==1})},{queueMicrotask:function(n){NK(arguments.length,1),bK(OK(n))}});var KO=A(Qr.queueMicrotask);function YO(n,e){return function(){return n.apply(e,arguments)}}let{toString:PK}=Object.prototype,{getPrototypeOf:wS}=Object,{iterator:d_,toStringTag:zO}=Symbol,l_=(bS=Object.create(null),n=>{let e=PK.call(n);return bS[e]||(bS[e]=e.slice(8,-1).toLowerCase())});var bS;let so=n=>(n=n.toLowerCase(),e=>l_(e)===n),u_=n=>e=>typeof e===n,{isArray:Dd}=Array,Pd=u_("undefined");function Su(n){return n!==null&&!Pd(n)&&n.constructor!==null&&!Pd(n.constructor)&&$r(n.constructor.isBuffer)&&n.constructor.isBuffer(n)}let qO=so("ArrayBuffer"),LK=u_("string"),$r=u_("function"),XO=u_("number"),Tu=n=>n!==null&&typeof n=="object",h_=n=>{if(l_(n)!=="object")return!1;let e=wS(n);return!(e!==null&&e!==Object.prototype&&Object.getPrototypeOf(e)!==null||zO in n||d_ in n)},kK=so("Date"),MK=so("File"),UK=so("Blob"),xK=so("FileList"),VK=so("URLSearchParams"),[FK,BK,jK,GK]=["ReadableStream","Request","Response","Headers"].map(so);function Ru(n,e){let t,i,{allOwnKeys:r=!1}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(n!=null)if(typeof n!="object"&&(n=[n]),Dd(n))for(t=0,i=n.length;t<i;t++)e.call(null,n[t],t,n);else{if(Su(n))return;let o=r?Object.getOwnPropertyNames(n):Object.keys(n),s=o.length,a;for(t=0;t<s;t++)a=o[t],e.call(null,n[a],a,n)}}function JO(n,e){if(Su(n))return null;e=e.toLowerCase();let t=Object.keys(n),i,r=t.length;for(;r-- >0;)if(i=t[r],e===i.toLowerCase())return i;return null}let Xa=VO!==void 0?VO:typeof self<"u"?self:typeof window<"u"?window:global,QO=n=>!Pd(n)&&n!==Xa,WK=(OS=typeof Uint8Array<"u"&&wS(Uint8Array),n=>OS&&n instanceof OS);var OS;let HK=so("HTMLFormElement"),ZO=(n=>{let{hasOwnProperty:e}=n;return(t,i)=>e.call(t,i)})(Object.prototype),KK=so("RegExp"),$O=(n,e)=>{let t=Object.getOwnPropertyDescriptors(n),i={};Ru(t,(r,o)=>{let s;(s=e(r,o,n))!==!1&&(i[o]=s||r)}),Object.defineProperties(n,i)},YK=so("AsyncFunction"),e0=(t0=typeof HO=="function",i0=$r(Xa.postMessage),t0?HO:i0?(NS="axios@".concat(Math.random()),p_=[],Xa.addEventListener("message",n=>{let{source:e,data:t}=n;e===Xa&&t===NS&&p_.length&&p_.shift()()},!1),n=>{p_.push(n),Xa.postMessage(NS,"*")}):n=>setTimeout(n));var t0,i0,NS,p_;let zK=KO!==void 0?KO.bind(Xa):typeof process<"u"&&process.nextTick||e0;var te={isArray:Dd,isArrayBuffer:qO,isBuffer:Su,isFormData:n=>{let e;return n&&(typeof FormData=="function"&&n instanceof FormData||$r(n.append)&&((e=l_(n))==="formdata"||e==="object"&&$r(n.toString)&&n.toString()==="[object FormData]"))},isArrayBufferView:function(n){let e;return e=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(n):n&&n.buffer&&qO(n.buffer),e},isString:LK,isNumber:XO,isBoolean:n=>n===!0||n===!1,isObject:Tu,isPlainObject:h_,isEmptyObject:n=>{if(!Tu(n)||Su(n))return!1;try{return Object.keys(n).length===0&&Object.getPrototypeOf(n)===Object.prototype}catch{return!1}},isReadableStream:FK,isRequest:BK,isResponse:jK,isHeaders:GK,isUndefined:Pd,isDate:kK,isFile:MK,isBlob:UK,isRegExp:KK,isFunction:$r,isStream:n=>Tu(n)&&$r(n.pipe),isURLSearchParams:VK,isTypedArray:WK,isFileList:xK,forEach:Ru,merge:function n(){let{caseless:e,skipUndefined:t}=QO(this)&&this||{},i={},r=(o,s)=>{let a=e&&JO(i,s)||s;h_(i[a])&&h_(o)?i[a]=n(i[a],o):h_(o)?i[a]=n({},o):Dd(o)?i[a]=o.slice():t&&Pd(o)||(i[a]=o)};for(let o=0,s=arguments.length;o<s;o++)arguments[o]&&Ru(arguments[o],r);return i},extend:function(n,e,t){let{allOwnKeys:i}=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};return Ru(e,(r,o)=>{t&&$r(r)?n[o]=YO(r,t):n[o]=r},{allOwnKeys:i}),n},trim:n=>rr(n)?rr(n).call(n):n.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:n=>(n.charCodeAt(0)===65279&&(n=n.slice(1)),n),inherits:(n,e,t,i)=>{n.prototype=Object.create(e.prototype,i),n.prototype.constructor=n,Object.defineProperty(n,"super",{value:e.prototype}),t&&Object.assign(n.prototype,t)},toFlatObject:(n,e,t,i)=>{let r,o,s,a={};if(e=e||{},n==null)return e;do{for(r=Object.getOwnPropertyNames(n),o=r.length;o-- >0;)s=r[o],i&&!i(s,n,e)||a[s]||(e[s]=n[s],a[s]=!0);n=t!==!1&&wS(n)}while(n&&(!t||t(n,e))&&n!==Object.prototype);return e},kindOf:l_,kindOfTest:so,endsWith:(n,e,t)=>{n=String(n),(t===void 0||t>n.length)&&(t=n.length),t-=e.length;let i=n.indexOf(e,t);return i!==-1&&i===t},toArray:n=>{if(!n)return null;if(Dd(n))return n;let e=n.length;if(!XO(e))return null;let t=new Array(e);for(;e-- >0;)t[e]=n[e];return t},forEachEntry:(n,e)=>{let t=(n&&n[d_]).call(n),i;for(;(i=t.next())&&!i.done;){let r=i.value;e.call(n,r[0],r[1])}},matchAll:(n,e)=>{let t,i=[];for(;(t=n.exec(e))!==null;)i.push(t);return i},isHTMLForm:HK,hasOwnProperty:ZO,hasOwnProp:ZO,reduceDescriptors:$O,freezeMethods:n=>{$O(n,(e,t)=>{if($r(n)&&["arguments","caller","callee"].indexOf(t)!==-1)return!1;let i=n[t];$r(i)&&(e.enumerable=!1,"writable"in e?e.writable=!1:e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+t+"'")}))})},toObjectSet:(n,e)=>{let t={},i=r=>{r.forEach(o=>{t[o]=!0})};return Dd(n)?i(n):i(String(n).split(e)),t},toCamelCase:n=>n.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(e,t,i){return t.toUpperCase()+i}),noop:()=>{},toFiniteNumber:(n,e)=>n!=null&&Number.isFinite(n=+n)?n:e,findKey:JO,global:Xa,isContextDefined:QO,isSpecCompliantForm:function(n){return!!(n&&$r(n.append)&&n[zO]==="FormData"&&n[d_])},toJSONObject:n=>{let e=new Array(10),t=(i,r)=>{if(Tu(i)){if(e.indexOf(i)>=0)return;if(Su(i))return i;if(!("toJSON"in i)){e[r]=i;let o=Dd(i)?[]:{};return Ru(i,(s,a)=>{let c=t(s,r+1);!Pd(c)&&(o[a]=c)}),e[r]=void 0,o}}return i};return t(n,0)},isAsyncFn:YK,isThenable:n=>n&&(Tu(n)||$r(n))&&$r(n.then)&&$r(n.catch),setImmediate:e0,asap:zK,isIterable:n=>n!=null&&$r(n[d_])};function nt(n,e,t,i,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=n,this.name="AxiosError",e&&(this.code=e),t&&(this.config=t),i&&(this.request=i),r&&(this.response=r,this.status=r.status?r.status:null)}te.inherits(nt,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:te.toJSONObject(this.config),code:this.code,status:this.status}}});let r0=nt.prototype,n0={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(n=>{n0[n]={value:n}}),Object.defineProperties(nt,n0),Object.defineProperty(r0,"isAxiosError",{value:!0}),nt.from=(n,e,t,i,r,o)=>{let s=Object.create(r0);te.toFlatObject(n,s,function(d){return d!==Error.prototype},d=>d!=="isAxiosError");let a=n&&n.message?n.message:"Error",c=e==null&&n?n.code:e;return nt.call(s,a,c,t,i,r),n&&s.cause==null&&Object.defineProperty(s,"cause",{value:n,configurable:!0}),s.name=n&&n.name||"Error",o&&Object.assign(s,o),s};function DS(n){return te.isPlainObject(n)||te.isArray(n)}function o0(n){return te.endsWith(n,"[]")?n.slice(0,-2):n}function s0(n,e,t){return n?n.concat(e).map(function(i,r){return i=o0(i),!t&&r?"["+i+"]":i}).join(t?".":""):e}let qK=te.toFlatObject(te,{},null,function(n){return/^is[A-Z]/.test(n)});function __(n,e,t){if(!te.isObject(n))throw new TypeError("target must be an object");e=e||new FormData;let i=(t=te.toFlatObject(t,{metaTokens:!0,dots:!1,indexes:!1},!1,function(p,f){return!te.isUndefined(f[p])})).metaTokens,r=t.visitor||d,o=t.dots,s=t.indexes,a=(t.Blob||typeof Blob<"u"&&Blob)&&te.isSpecCompliantForm(e);if(!te.isFunction(r))throw new TypeError("visitor must be a function");function c(p){if(p===null)return"";if(te.isDate(p))return p.toISOString();if(te.isBoolean(p))return p.toString();if(!a&&te.isBlob(p))throw new nt("Blob is not supported. Use a Buffer instead.");return te.isArrayBuffer(p)||te.isTypedArray(p)?a&&typeof Blob=="function"?new Blob([p]):Buffer.from(p):p}function d(p,f,m){let g=p;if(p&&!m&&typeof p=="object"){if(te.endsWith(f,"{}"))f=i?f:f.slice(0,-2),p=JSON.stringify(p);else if(te.isArray(p)&&function(S){return te.isArray(S)&&!S.some(DS)}(p)||(te.isFileList(p)||te.endsWith(f,"[]"))&&(g=te.toArray(p)))return f=o0(f),g.forEach(function(S,T){!te.isUndefined(S)&&S!==null&&e.append(s===!0?s0([f],T,o):s===null?f:f+"[]",c(S))}),!1}return!!DS(p)||(e.append(s0(m,f,o),c(p)),!1)}let l=[],h=Object.assign(qK,{defaultVisitor:d,convertValue:c,isVisitable:DS});if(!te.isObject(n))throw new TypeError("data must be an object");return function p(f,m){if(!te.isUndefined(f)){if(l.indexOf(f)!==-1)throw Error("Circular reference detected in "+m.join("."));l.push(f),te.forEach(f,function(g,S){(!(te.isUndefined(g)||g===null)&&r.call(e,g,te.isString(S)?rr(S).call(S):S,m,h))===!0&&p(g,m?m.concat(S):[S])}),l.pop()}}(n),e}function a0(n){let e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(n).replace(/[!'()~]|%20|%00/g,function(t){return e[t]})}function PS(n,e){this._pairs=[],n&&__(n,this,e)}let c0=PS.prototype;function XK(n){return encodeURIComponent(n).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+")}function d0(n,e,t){if(!e)return n;let i=t&&t.encode||XK;te.isFunction(t)&&(t={serialize:t});let r=t&&t.serialize,o;if(o=r?r(e,t):te.isURLSearchParams(e)?e.toString():new PS(e,t).toString(i),o){let s=n.indexOf("#");s!==-1&&(n=n.slice(0,s)),n+=(n.indexOf("?")===-1?"?":"&")+o}return n}c0.append=function(n,e){this._pairs.push([n,e])},c0.toString=function(n){let e=n?function(t){return n.call(this,t,a0)}:a0;return this._pairs.map(function(t){return e(t[0])+"="+e(t[1])},"").join("&")};var l0=class{constructor(){this.handlers=[]}use(n,e,t){return this.handlers.push({fulfilled:n,rejected:e,synchronous:!!t&&t.synchronous,runWhen:t?t.runWhen:null}),this.handlers.length-1}eject(n){this.handlers[n]&&(this.handlers[n]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(n){te.forEach(this.handlers,function(e){e!==null&&n(e)})}},u0={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},h0={exports:{}},JK=qe,QK=ur,p0=Mn.f;JK({target:"Object",stat:!0,forced:Object.defineProperty!==p0,sham:!QK},{defineProperty:p0});var _0=Qr.Object,ZK=h0.exports=function(n,e,t){return _0.defineProperty(n,e,t)};_0.defineProperty.sham&&(ZK.sham=!0);var f0=A(h0.exports),$K=TypeError,m0=eu,e8=kp,t8=ir,i8=qt("species"),E0=Array,r8=function(n){var e;return m0(n)&&(e=n.constructor,(e8(e)&&(e===E0||m0(e.prototype))||t8(e)&&(e=e[i8])===null)&&(e=void 0)),e===void 0?E0:e},g0=function(n,e){return new(r8(n))(e===0?0:e)},n8=P,o8=Fa,s8=qt("species"),S0=function(n){return o8>=51||!n8(function(){var e=[];return(e.constructor={})[s8]=function(){return{foo:1}},e[n](Boolean).foo!==1})},a8=qe,c8=P,d8=eu,l8=ir,u8=Co,h8=js,T0=function(n){if(n>9007199254740991)throw $K("Maximum allowed index exceeded");return n},R0=jg,p8=g0,_8=S0,f8=Fa,v0=qt("isConcatSpreadable"),m8=f8>=51||!c8(function(){var n=[];return n[v0]=!1,n.concat()[0]!==n}),E8=function(n){if(!l8(n))return!1;var e=n[v0];return e!==void 0?!!e:d8(n)};a8({target:"Array",proto:!0,forced:!m8||!_8("concat")},{concat:function(n){var e,t,i,r,o,s=u8(this),a=p8(s,0),c=0;for(e=-1,i=arguments.length;e<i;e++)if(E8(o=e===-1?s:arguments[e]))for(r=h8(o),T0(c+r),t=0;t<r;t++,c++)t in o&&R0(a,c,o[t]);else T0(c+1),R0(a,c++,o);return a.length=c,a}});var C0={},g8=dt,S8=Fs,y0=gp.f,T8=Hs,I0=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];C0.f=function(n){return I0&&g8(n)==="Window"?function(e){try{return y0(e)}catch{return T8(I0)}}(n):y0(S8(n))};var Ld={},R8=qt;Ld.f=R8;var A0=Qr,v8=Bi,C8=Ld,y8=Mn.f,Ci=function(n){var e=A0.Symbol||(A0.Symbol={});v8(e,n)||y8(e,n,{value:C8.f(n)})},I8=gi,A8=Sr,w8=qt,b8=Ws,w0=function(){var n=A8("Symbol"),e=n&&n.prototype,t=e&&e.valueOf,i=w8("toPrimitive");e&&!e[i]&&b8(e,i,function(r){return I8(t,this)},{})},O8=Bs,N8=lp,D8=Co,P8=js,L8=g0;he([].push);var oM=function(n){return function(e,t,i,r){for(var o,s,a=D8(e),c=N8(a),d=P8(c),l=O8(t,i),h=0,p=r||L8,f=void 0;d>h;h++)h in c&&(s=l(o=c[h],h,a));return f}},sM={forEach:oM(0)},LS=qe,mh=ve,f_=gi,b0=he,pf=ur,kd=nd,_f=P,Bo=Bi,jo=me,O0=Ur,ff=Fs,mf=_E,N0=xr,D0=kn,Eh=iu,m_=Tp,aM=gp,cM=C0,dM=tu,lM=Va,P0=Mn,uM=ME,hM=mt,L0=Ws,pM=Lp,k0=sd,zR=Sp,M0=hE,_M=qt,k8=Ld,M8=Ci,U8=w0,x8=ns,fM=Ga,kS=sM.forEach,as=Ep("hidden"),cs="Symbol",gh="prototype",MS=fM.set,mM=fM.getterFor(cs),Ic=Object[gh],ds=mh.Symbol,gl=ds&&ds[gh],qR=mh.RangeError,V8=mh.TypeError,U0=mh.QObject,XR=lM.f,Sh=P0.f,Th=cM.f,EM=hM.f,gM=b0([].push),Sl=k0("symbols"),Ja=k0("op-symbols"),US=k0("wks"),x0=!U0||!U0[gh]||!U0[gh].findChild,JR=function(n,e,t){var i=XR(Ic,e);i&&delete Ic[e],Sh(n,e,t),i&&n!==Ic&&Sh(Ic,e,i)},QR=pf&&_f(function(){return Eh(Sh({},"a",{get:function(){return Sh(this,"a",{value:7}).a}})).a!==7})?JR:Sh,xS=function(n,e){var t=Sl[n]=Eh(gl);return MS(t,{type:cs,tag:n,description:e}),pf||(t.description=e),t},Ef=function(n,e,t){n===Ic&&Ef(Ja,e,t),O0(n);var i=mf(e);return O0(t),Bo(Sl,i)?(t.enumerable?(Bo(n,as)&&n[as][i]&&(n[as][i]=!1),t=Eh(t,{enumerable:D0(0,!1)})):(Bo(n,as)||Sh(n,as,D0(1,Eh(null))),n[as][i]=!0),QR(n,i,t)):Sh(n,i,t)},gf=function(n,e){O0(n);var t=ff(e),i=m_(t).concat(B0(t));return kS(i,function(r){pf&&!f_(ZR,t,r)||Ef(n,r,t[r])}),n},ZR=function(n){var e=mf(n),t=f_(EM,this,e);return!(this===Ic&&Bo(Sl,e)&&!Bo(Ja,e))&&(!(t||!Bo(this,e)||!Bo(Sl,e)||Bo(this,as)&&this[as][e])||t)},V0=function(n,e){var t=ff(n),i=mf(e);if(t!==Ic||!Bo(Sl,i)||Bo(Ja,i)){var r=XR(t,i);return!r||!Bo(Sl,i)||Bo(t,as)&&t[as][i]||(r.enumerable=!0),r}},F0=function(n){var e=Th(ff(n)),t=[];return kS(e,function(i){Bo(Sl,i)||Bo(zR,i)||gM(t,i)}),t},B0=function(n){var e=n===Ic,t=Th(e?Ja:ff(n)),i=[];return kS(t,function(r){!Bo(Sl,r)||e&&!Bo(Ic,r)||gM(i,Sl[r])}),i};kd||(ds=function(){if(jo(gl,this))throw new V8("Symbol is not a constructor");var n=arguments.length&&arguments[0]!==void 0?N0(arguments[0]):void 0,e=M0(n),t=function(i){var r=this===void 0?mh:this;r===Ic&&f_(t,Ja,i),Bo(r,as)&&Bo(r[as],e)&&(r[as][e]=!1);var o=D0(1,i);try{QR(r,e,o)}catch(s){if(!(s instanceof qR))throw s;JR(r,e,o)}};return pf&&x0&&QR(Ic,e,{configurable:!0,set:t}),xS(e,n)},L0(gl=ds[gh],"toString",function(){return mM(this).tag}),L0(ds,"withoutSetter",function(n){return xS(M0(n),n)}),hM.f=ZR,P0.f=Ef,uM.f=gf,lM.f=V0,aM.f=cM.f=F0,dM.f=B0,k8.f=function(n){return xS(_M(n),n)},pf&&pM(gl,"description",{configurable:!0,get:function(){return mM(this).description}})),LS({global:!0,wrap:!0,forced:!kd,sham:!kd},{Symbol:ds}),kS(m_(US),function(n){M8(n)}),LS({target:cs,stat:!0,forced:!kd},{useSetter:function(){x0=!0},useSimple:function(){x0=!1}}),LS({target:"Object",stat:!0,forced:!kd,sham:!pf},{create:function(n,e){return e===void 0?Eh(n):gf(Eh(n),e)},defineProperty:Ef,defineProperties:gf,getOwnPropertyDescriptor:V0}),LS({target:"Object",stat:!0,forced:!kd},{getOwnPropertyNames:F0}),U8(),x8(ds,cs),zR[as]=!0;var j0=nd&&!!Symbol.for&&!!Symbol.keyFor,SM=qe,F8=Sr,B8=Bi,j8=xr,TM=sd,RM=j0,G0=TM("string-to-symbol-registry"),W0=TM("symbol-to-string-registry");SM({target:"Symbol",stat:!0,forced:!RM},{for:function(n){var e=j8(n);if(B8(G0,e))return G0[e];var t=F8("Symbol")(e);return G0[e]=t,W0[t]=e,t}});var G8=qe,W8=Bi,H8=Xl,K8=od,Y8=j0,vM=sd("symbol-to-string-registry");G8({target:"Symbol",stat:!0,forced:!Y8},{keyFor:function(n){if(!H8(n))throw new TypeError(K8(n)+" is not a symbol");if(W8(vM,n))return vM[n]}});var H0=eu,CM=ci,yM=dt,IM=xr,AM=he([].push),wM=qe,bM=Sr,K0=fe,OM=gi,VS=he,Sf=P,Y0=ci,z0=Xl,q0=Hs,NM=function(n){if(CM(n))return n;if(H0(n)){for(var e=n.length,t=[],i=0;i<e;i++){var r=n[i];typeof r=="string"?AM(t,r):typeof r!="number"&&yM(r)!=="Number"&&yM(r)!=="String"||AM(t,IM(r))}var o=t.length,s=!0;return function(a,c){if(s)return s=!1,c;if(H0(this))return c;for(var d=0;d<o;d++)if(t[d]===a)return c}}},z8=nd,q8=String,Rh=bM("JSON","stringify"),Md=VS(/./.exec),FS=VS("".charAt),DM=VS("".charCodeAt),X8=VS("".replace),J8=VS(1.1.toString),Q8=/[\uD800-\uDFFF]/g,PM=/^[\uD800-\uDBFF]$/,X0=/^[\uDC00-\uDFFF]$/,J0=!z8||Sf(function(){var n=bM("Symbol")("stringify detection");return Rh([n])!=="[null]"||Rh({a:n})!=="{}"||Rh(Object(n))!=="{}"}),Q0=Sf(function(){return Rh("\uDF06\uD834")!=='"\\udf06\\ud834"'||Rh("\uDEAD")!=='"\\udead"'}),LM=function(n,e){var t=q0(arguments),i=NM(e);if(Y0(i)||n!==void 0&&!z0(n))return t[1]=function(r,o){if(Y0(i)&&(o=OM(i,this,q8(r),o)),!z0(o))return o},K0(Rh,null,t)},Z8=function(n,e,t){var i=FS(t,e-1),r=FS(t,e+1);return Md(PM,n)&&!Md(X0,r)||Md(X0,n)&&!Md(PM,i)?"\\u"+J8(DM(n,0),16):n};Rh&&wM({target:"JSON",stat:!0,forced:J0||Q0},{stringify:function(n,e,t){var i=q0(arguments),r=K0(J0?LM:Rh,null,i);return Q0&&typeof r=="string"?X8(r,Q8,Z8):r}});var kM=tu,MM=Co;qe({target:"Object",stat:!0,forced:!nd||P(function(){kM.f(1)})},{getOwnPropertySymbols:function(n){var e=kM.f;return e?e(MM(n)):[]}}),Ci("asyncDispose"),Ci("asyncIterator"),Ci("dispose"),Ci("hasInstance"),Ci("isConcatSpreadable"),Ci("iterator"),Ci("match"),Ci("matchAll"),Ci("replace"),Ci("search"),Ci("species"),Ci("split");var $8=w0;Ci("toPrimitive"),$8();var eY=Sr,tY=ns;Ci("toStringTag"),tY(eY("Symbol"),"Symbol"),Ci("unscopables"),ns(ve.JSON,"JSON",!0);var iY=Qr.Symbol,rY=qt,nY=Mn.f,UM=rY("metadata"),Z0=Function.prototype;Z0[UM]===void 0&&nY(Z0,UM,{value:null}),Ci("metadata");var xM=iY,oY=he,$0=Sr("Symbol"),eN=$0.keyFor,sY=oY($0.prototype.valueOf),VM=$0.isRegisteredSymbol||function(n){try{return eN(sY(n))!==void 0}catch{return!1}};qe({target:"Symbol",stat:!0},{isRegisteredSymbol:VM});for(var FM=sd,BM=Sr,jM=he,aY=Xl,cY=qt,$R=BM("Symbol"),BS=$R.isWellKnownSymbol,tN=BM("Object","getOwnPropertyNames"),GM=jM($R.prototype.valueOf),WM=FM("wks"),ev=0,tv=tN($R),HM=tv.length;ev<HM;ev++)try{var KM=tv[ev];aY($R[KM])&&cY(KM)}catch{}var iN=function(n){if(BS&&BS(n))return!0;try{for(var e=GM(n),t=0,i=tN(WM),r=i.length;t<r;t++)if(WM[i[t]]==e)return!0}catch{}return!1};qe({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:iN}),Ci("customMatcher"),Ci("observable"),qe({target:"Symbol",stat:!0},{isRegistered:VM}),qe({target:"Symbol",stat:!0,forced:!0},{isWellKnown:iN}),Ci("matcher"),Ci("metadataKey"),Ci("patternMatch"),Ci("replaceAll");var E_=A(xM),g_=A(Ld.f("iterator"));function Tf(n){return Tf=typeof E_=="function"&&typeof g_=="symbol"?function(e){return typeof e}:function(e){return e&&typeof E_=="function"&&e.constructor===E_&&e!==E_.prototype?"symbol":typeof e},Tf(n)}var jS=A(Ld.f("toPrimitive"));function dY(n){var e=function(t,i){if(Tf(t)!="object"||!t)return t;var r=t[jS];if(r!==void 0){var o=r.call(t,i);if(Tf(o)!="object")return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return(i==="string"?String:Number)(t)}(n,"string");return Tf(e)=="symbol"?e:e+""}function U(n,e,t){return(e=dY(e))in n?f0(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}var M=A(p6),YM={isBrowser:!0,classes:{URLSearchParams:M!==void 0?M:PS,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};let rN=typeof window<"u"&&typeof document<"u",GS=typeof navigator=="object"&&navigator||void 0,nN=rN&&(!GS||["ReactNative","NativeScript","NS"].indexOf(GS.product)<0),lY=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",uY=rN&&window.location.href||"http://localhost";function zM(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function oN(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?zM(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):zM(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}var ls=oN(oN({},Object.freeze({__proto__:null,hasBrowserEnv:rN,hasStandardBrowserEnv:nN,hasStandardBrowserWebWorkerEnv:lY,navigator:GS,origin:uY})),YM);function us(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function qM(n,e){return __(n,new ls.classes.URLSearchParams,function(t){for(var i=1;i<arguments.length;i++){var r=arguments[i]!=null?arguments[i]:{};i%2?us(Object(r),!0).forEach(function(o){U(t,o,r[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):us(Object(r)).forEach(function(o){Object.defineProperty(t,o,Object.getOwnPropertyDescriptor(r,o))})}return t}({visitor:function(t,i,r,o){return ls.isNode&&te.isBuffer(t)?(this.append(i,t.toString("base64")),!1):o.defaultVisitor.apply(this,arguments)}},e))}var hY=wg.charAt,XM=gi,JM=Ur,pY=ci,_Y=dt,fY=/./.exec,mY=TypeError,EY=qe,QM=gi,sN=Ri,ZM=qE,iv=Dp,WS=Vs,aN=wI,Rf=xr,HS=Ur,gY=ir,SY=dt,TY=yE,$M=gS,eU=Jl,RY=P,vY=eg,CY=function(n,e,t){return e+(t?hY(n,e).length:1)},yY=function(n,e){var t=n.exec;if(pY(t)){var i=XM(t,n,e);return i!==null&&JM(i),i}if(_Y(n)==="RegExp")return XM(fY,n,e);throw new mY("RegExp#exec called on incompatible receiver")},tU=Ga,iU=qt("matchAll"),rU="RegExp String",cN=rU+" Iterator",nU=tU.set,IY=tU.getterFor(cN),AY=TypeError,dN=sN("".indexOf),vf=sN("".matchAll),Cf=!!vf&&!RY(function(){vf("a",/./)}),lN=ZM(function(n,e,t,i){nU(this,{type:cN,regexp:n,string:e,global:t,unicode:i,done:!1})},rU,function(){var n=IY(this);if(n.done)return iv(void 0,!0);var e=n.regexp,t=n.string,i=yY(e,t);return i===null?(n.done=!0,iv(void 0,!0)):n.global?(Rf(i[0])===""&&(e.lastIndex=CY(t,aN(e.lastIndex),n.unicode)),iv(i,!1)):(n.done=!0,iv(i,!1))}),oU=function(n){var e,t,i,r=HS(this),o=Rf(n),s=vY(r,RegExp),a=Rf($M(r));return e=new s(s===RegExp?r.source:r,a),t=!!~dN(a,"g"),i=!!~dN(a,"u"),e.lastIndex=aN(r.lastIndex),new lN(e,o,t,i)};EY({target:"String",proto:!0,forced:Cf},{matchAll:function(n){var e,t,i,r,o=WS(this);if(gY(n)){if(TY(n)&&(e=Rf(WS($M(n))),!~dN(e,"g")))throw new AY("`.matchAll` does not allow non-global regexes");if(Cf)return vf(o,n);if((i=eU(n,iU))===void 0&&SY(n)==="RegExp"&&(i=oU),i)return QM(i,n,o)}else if(Cf)return vf(o,n);return t=Rf(o),r=new RegExp(n,"g"),QM(oU,r,t)}});var sU=ln("String","matchAll"),wY=me,bY=sU,uN=String.prototype,hN=function(n){var e=n.matchAll;return typeof n=="string"||n===uN||wY(uN,n)&&e===uN.matchAll?bY:e},OY=A(hN);function aU(n){function e(t,i,r,o){let s=t[o++];if(s==="__proto__")return!0;let a=Number.isFinite(+s),c=o>=t.length;return s=!s&&te.isArray(r)?r.length:s,c?(te.hasOwnProp(r,s)?r[s]=[r[s],i]:r[s]=i,!a):(r[s]&&te.isObject(r[s])||(r[s]=[]),e(t,i,r[s],o)&&te.isArray(r[s])&&(r[s]=function(d){let l={},h=Object.keys(d),p,f=h.length,m;for(p=0;p<f;p++)m=h[p],l[m]=d[m];return l}(r[s])),!a)}if(te.isFormData(n)&&te.isFunction(n.entries)){let t={};return te.forEachEntry(n,(i,r)=>{e(function(o){return OY(te).call(te,/\w+|\[(\w*)]/g,o).map(s=>s[0]==="[]"?"":s[1]||s[0])}(i),r,t,0)}),t}return null}let rv={transitional:u0,adapter:["xhr","http","fetch"],transformRequest:[function(n,e){let t=e.getContentType()||"",i=t.indexOf("application/json")>-1,r=te.isObject(n);if(r&&te.isHTMLForm(n)&&(n=new FormData(n)),te.isFormData(n))return i?JSON.stringify(aU(n)):n;if(te.isArrayBuffer(n)||te.isBuffer(n)||te.isStream(n)||te.isFile(n)||te.isBlob(n)||te.isReadableStream(n))return n;if(te.isArrayBufferView(n))return n.buffer;if(te.isURLSearchParams(n))return e.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),n.toString();let o;if(r){if(t.indexOf("application/x-www-form-urlencoded")>-1)return qM(n,this.formSerializer).toString();if((o=te.isFileList(n))||t.indexOf("multipart/form-data")>-1){let s=this.env&&this.env.FormData;return __(o?{"files[]":n}:n,s&&new s,this.formSerializer)}}return r||i?(e.setContentType("application/json",!1),function(s,a,c){if(te.isString(s))try{return(a||JSON.parse)(s),rr(te).call(te,s)}catch(d){if(d.name!=="SyntaxError")throw d}return(c||JSON.stringify)(s)}(n)):n}],transformResponse:[function(n){let e=this.transitional||rv.transitional,t=e&&e.forcedJSONParsing,i=this.responseType==="json";if(te.isResponse(n)||te.isReadableStream(n))return n;if(n&&te.isString(n)&&(t&&!this.responseType||i)){let r=!(e&&e.silentJSONParsing)&&i;try{return JSON.parse(n,this.parseReviver)}catch(o){if(r)throw o.name==="SyntaxError"?nt.from(o,nt.ERR_BAD_RESPONSE,this,null,this.response):o}}return n}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:ls.classes.FormData,Blob:ls.classes.Blob},validateStatus:function(n){return n>=200&&n<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};te.forEach(["delete","get","head","post","put","patch"],n=>{rv.headers[n]={}});var KS=rv;let pN=te.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),cU=Symbol("internals");function yf(n){var e;return n&&rr(e=String(n)).call(e).toLowerCase()}function vh(n){return n===!1||n==null?n:te.isArray(n)?n.map(vh):String(n)}function If(n,e,t,i,r){return te.isFunction(i)?i.call(this,e,t):(r&&(e=t),te.isString(e)?te.isString(i)?e.indexOf(i)!==-1:te.isRegExp(i)?i.test(e):void 0:void 0)}class Af{constructor(e){e&&this.set(e)}set(e,t,i){let r=this;function o(c,d,l){let h=yf(d);if(!h)throw new Error("header name must be a non-empty string");let p=te.findKey(r,h);(!p||r[p]===void 0||l===!0||l===void 0&&r[p]!==!1)&&(r[p||d]=vh(c))}let s=(c,d)=>te.forEach(c,(l,h)=>o(l,h,d));if(te.isPlainObject(e)||e instanceof this.constructor)s(e,t);else if(te.isString(e)&&(e=rr(e).call(e))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(rr(a=e).call(a)))s((c=>{let d={},l,h,p;return c&&c.split(`
`).forEach(function(f){var m,g;p=f.indexOf(":"),l=rr(m=f.substring(0,p)).call(m).toLowerCase(),h=rr(g=f.substring(p+1)).call(g),!l||d[l]&&pN[l]||(l==="set-cookie"?d[l]?d[l].push(h):d[l]=[h]:d[l]=d[l]?d[l]+", "+h:h)}),d})(e),t);else if(te.isObject(e)&&te.isIterable(e)){let c,d,l={};for(let h of e){if(!te.isArray(h))throw TypeError("Object iterator must return a key-value pair");l[d=h[0]]=(c=l[d])?te.isArray(c)?[...c,h[1]]:[c,h[1]]:h[1]}s(l,t)}else e!=null&&o(t,e,i);var a;return this}get(e,t){if(e=yf(e)){let i=te.findKey(this,e);if(i){let r=this[i];if(!t)return r;if(t===!0)return function(o){let s=Object.create(null),a=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g,c;for(;c=a.exec(o);)s[c[1]]=c[2];return s}(r);if(te.isFunction(t))return t.call(this,r,i);if(te.isRegExp(t))return t.exec(r);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=yf(e)){let i=te.findKey(this,e);return!(!i||this[i]===void 0||t&&!If(0,this[i],i,t))}return!1}delete(e,t){let i=this,r=!1;function o(s){if(s=yf(s)){let a=te.findKey(i,s);!a||t&&!If(0,i[a],a,t)||(delete i[a],r=!0)}}return te.isArray(e)?e.forEach(o):o(e),r}clear(e){let t=Object.keys(this),i=t.length,r=!1;for(;i--;){let o=t[i];e&&!If(0,this[o],o,e,!0)||(delete this[o],r=!0)}return r}normalize(e){let t=this,i={};return te.forEach(this,(r,o)=>{var s;let a=te.findKey(i,o);if(a)return t[a]=vh(r),void delete t[o];let c=e?function(d){return rr(d).call(d).toLowerCase().replace(/([a-z\d])(\w*)/g,(l,h,p)=>h.toUpperCase()+p)}(o):rr(s=String(o)).call(s);c!==o&&delete t[o],t[c]=vh(r),i[c]=!0}),this}concat(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return this.constructor.concat(this,...t)}toJSON(e){let t=Object.create(null);return te.forEach(this,(i,r)=>{i!=null&&i!==!1&&(t[r]=e&&te.isArray(i)?i.join(", "):i)}),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(e=>{let[t,i]=e;return t+": "+i}).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e){let t=new this(e);for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return r.forEach(s=>t.set(s)),t}static accessor(e){let t=(this[cU]=this[cU]={accessors:{}}).accessors,i=this.prototype;function r(o){let s=yf(o);t[s]||(function(a,c){let d=te.toCamelCase(" "+c);["get","set","has"].forEach(l=>{Object.defineProperty(a,l+d,{value:function(h,p,f){return this[l].call(this,c,h,p,f)},configurable:!0})})}(i,o),t[s]=!0)}return te.isArray(e)?e.forEach(r):r(e),this}}Af.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),te.reduceDescriptors(Af.prototype,(n,e)=>{let{value:t}=n,i=e[0].toUpperCase()+e.slice(1);return{get:()=>t,set(r){this[i]=r}}}),te.freezeMethods(Af);var ua=Af;function Qa(n,e){let t=this||KS,i=e||t,r=ua.from(i.headers),o=i.data;return te.forEach(n,function(s){o=s.call(t,o,r.normalize(),e?e.status:void 0)}),r.normalize(),o}function nv(n){return!(!n||!n.__CANCEL__)}function S_(n,e,t){nt.call(this,n??"canceled",nt.ERR_CANCELED,e,t),this.name="CanceledError"}function T_(n,e,t){let i=t.config.validateStatus;t.status&&i&&!i(t.status)?e(new nt("Request failed with status code "+t.status,[nt.ERR_BAD_REQUEST,nt.ERR_BAD_RESPONSE][Math.floor(t.status/100)-4],t.config,t.request,t)):n(t)}te.inherits(S_,nt,{__CANCEL__:!0});let YS=function(n,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:3,i=0,r=function(o,s){o=o||10;let a=new Array(o),c=new Array(o),d,l=0,h=0;return s=s!==void 0?s:1e3,function(p){let f=Date.now(),m=c[h];d||(d=f),a[l]=p,c[l]=f;let g=h,S=0;for(;g!==l;)S+=a[g++],g%=o;if(l=(l+1)%o,l===h&&(h=(h+1)%o),f-d<s)return;let T=m&&f-m;return T?Math.round(1e3*S/T):void 0}}(50,250);return function(o,s){let a,c,d=0,l=1e3/s,h=function(p){d=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Date.now(),a=null,c&&(clearTimeout(c),c=null),o(...p)};return[function(){let p=Date.now(),f=p-d;for(var m=arguments.length,g=new Array(m),S=0;S<m;S++)g[S]=arguments[S];f>=l?h(g,p):(a=g,c||(c=setTimeout(()=>{c=null,h(a)},l-f)))},()=>a&&h(a)]}(o=>{let s=o.loaded,a=o.lengthComputable?o.total:void 0,c=s-i,d=r(c);i=s,n({loaded:s,total:a,progress:a?s/a:void 0,bytes:c,rate:d||void 0,estimated:d&&a&&s<=a?(a-s)/d:void 0,event:o,lengthComputable:a!=null,[e?"download":"upload"]:!0})},t)},zS=(n,e)=>{let t=n!=null;return[i=>e[0]({lengthComputable:t,total:n,loaded:i}),e[1]]},_N=n=>function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return te.asap(()=>n(...t))};var dU=ls.hasStandardBrowserEnv?((n,e)=>t=>(t=new i_(t,ls.origin),n.protocol===t.protocol&&n.host===t.host&&(e||n.port===t.port)))(new i_(ls.origin),ls.navigator&&/(msie|trident)/i.test(ls.navigator.userAgent)):()=>!0,NY=ls.hasStandardBrowserEnv?{write(n,e,t,i,r,o,s){if(typeof document>"u")return;let a=["".concat(n,"=").concat(encodeURIComponent(e))];te.isNumber(t)&&a.push("expires=".concat(new Date(t).toUTCString())),te.isString(i)&&a.push("path=".concat(i)),te.isString(r)&&a.push("domain=".concat(r)),o===!0&&a.push("secure"),te.isString(s)&&a.push("SameSite=".concat(s)),document.cookie=a.join("; ")},read(n){if(typeof document>"u")return null;let e=document.cookie.match(new RegExp("(?:^|; )"+n+"=([^;]*)"));return e?decodeURIComponent(e[1]):null},remove(n){this.write(n,"",Date.now()-864e5,"/")}}:{write(){},read:()=>null,remove(){}};function lU(n,e,t){let i=!function(r){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(r)}(e);return n&&(i||t==0)?function(r,o){return o?r.replace(/\/?\/$/,"")+"/"+o.replace(/^\/+/,""):r}(n,e):e}function fN(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function ov(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?fN(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):fN(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}let sv=n=>n instanceof ua?ov({},n):n;function Ch(n,e){e=e||{};let t={};function i(d,l,h,p){return te.isPlainObject(d)&&te.isPlainObject(l)?te.merge.call({caseless:p},d,l):te.isPlainObject(l)?te.merge({},l):te.isArray(l)?l.slice():l}function r(d,l,h,p){return te.isUndefined(l)?te.isUndefined(d)?void 0:i(void 0,d,0,p):i(d,l,0,p)}function o(d,l){if(!te.isUndefined(l))return i(void 0,l)}function s(d,l){return te.isUndefined(l)?te.isUndefined(d)?void 0:i(void 0,d):i(void 0,l)}function a(d,l,h){return h in e?i(d,l):h in n?i(void 0,d):void 0}let c={url:o,method:o,data:o,baseURL:s,transformRequest:s,transformResponse:s,paramsSerializer:s,timeout:s,timeoutMessage:s,withCredentials:s,withXSRFToken:s,adapter:s,responseType:s,xsrfCookieName:s,xsrfHeaderName:s,onUploadProgress:s,onDownloadProgress:s,decompress:s,maxContentLength:s,maxBodyLength:s,beforeRedirect:s,transport:s,httpAgent:s,httpsAgent:s,cancelToken:s,socketPath:s,responseEncoding:s,validateStatus:a,headers:(d,l,h)=>r(sv(d),sv(l),0,!0)};return te.forEach(Object.keys(ov(ov({},n),e)),function(d){let l=c[d]||r,h=l(n[d],e[d],d);te.isUndefined(h)&&l!==a||(t[d]=h)}),t}var yh=n=>{let e=Ch({},n),{data:t,withXSRFToken:i,xsrfHeaderName:r,xsrfCookieName:o,headers:s,auth:a}=e;if(e.headers=s=ua.from(s),e.url=d0(lU(e.baseURL,e.url,e.allowAbsoluteUrls),n.params,n.paramsSerializer),a&&s.set("Authorization","Basic "+btoa((a.username||"")+":"+(a.password?unescape(encodeURIComponent(a.password)):""))),te.isFormData(t)){if(ls.hasStandardBrowserEnv||ls.hasStandardBrowserWebWorkerEnv)s.setContentType(void 0);else if(te.isFunction(t.getHeaders)){let c=t.getHeaders(),d=["content-type","content-length"];Object.entries(c).forEach(l=>{let[h,p]=l;z(d).call(d,h.toLowerCase())&&s.set(h,p)})}}if(ls.hasStandardBrowserEnv&&(i&&te.isFunction(i)&&(i=i(e)),i||i!==!1&&dU(e.url))){let c=r&&o&&NY.read(o);c&&s.set(r,c)}return e},uU=typeof XMLHttpRequest<"u"&&function(n){return new Z(function(e,t){let i=yh(n),r=i.data,o=ua.from(i.headers).normalize(),s,a,c,d,l,{responseType:h,onUploadProgress:p,onDownloadProgress:f}=i;function m(){d&&d(),l&&l(),i.cancelToken&&i.cancelToken.unsubscribe(s),i.signal&&i.signal.removeEventListener("abort",s)}let g=new XMLHttpRequest;function S(){if(!g)return;let C=ua.from("getAllResponseHeaders"in g&&g.getAllResponseHeaders());T_(function(b){e(b),m()},function(b){t(b),m()},{data:h&&h!=="text"&&h!=="json"?g.response:g.responseText,status:g.status,statusText:g.statusText,headers:C,config:n,request:g}),g=null}g.open(i.method.toUpperCase(),i.url,!0),g.timeout=i.timeout,"onloadend"in g?g.onloadend=S:g.onreadystatechange=function(){g&&g.readyState===4&&(g.status!==0||g.responseURL&&g.responseURL.indexOf("file:")===0)&&setTimeout(S)},g.onabort=function(){g&&(t(new nt("Request aborted",nt.ECONNABORTED,n,g)),g=null)},g.onerror=function(C){let b=new nt(C&&C.message?C.message:"Network Error",nt.ERR_NETWORK,n,g);b.event=C||null,t(b),g=null},g.ontimeout=function(){let C=i.timeout?"timeout of "+i.timeout+"ms exceeded":"timeout exceeded",b=i.transitional||u0;i.timeoutErrorMessage&&(C=i.timeoutErrorMessage),t(new nt(C,b.clarifyTimeoutError?nt.ETIMEDOUT:nt.ECONNABORTED,n,g)),g=null},r===void 0&&o.setContentType(null),"setRequestHeader"in g&&te.forEach(o.toJSON(),function(C,b){g.setRequestHeader(b,C)}),te.isUndefined(i.withCredentials)||(g.withCredentials=!!i.withCredentials),h&&h!=="json"&&(g.responseType=i.responseType),f&&([c,l]=YS(f,!0),g.addEventListener("progress",c)),p&&g.upload&&([a,d]=YS(p),g.upload.addEventListener("progress",a),g.upload.addEventListener("loadend",d)),(i.cancelToken||i.signal)&&(s=C=>{g&&(t(!C||C.type?new S_(null,n,g):C),g.abort(),g=null)},i.cancelToken&&i.cancelToken.subscribe(s),i.signal&&(i.signal.aborted?s():i.signal.addEventListener("abort",s)));let T=function(C){let b=/^([-+\w]{1,25})(:?\/\/|:)/.exec(C);return b&&b[1]||""}(i.url);T&&ls.protocols.indexOf(T)===-1?t(new nt("Unsupported protocol "+T+":",nt.ERR_BAD_REQUEST,n)):g.send(r||null)})},DY=(n,e)=>{let{length:t}=n=n?n.filter(Boolean):[];if(e||t){let i,r=new AbortController,o=function(d){if(!i){i=!0,a();let l=d instanceof Error?d:this.reason;r.abort(l instanceof nt?l:new S_(l instanceof Error?l.message:l))}},s=e&&setTimeout(()=>{s=null,o(new nt("timeout ".concat(e," of ms exceeded"),nt.ETIMEDOUT))},e),a=()=>{n&&(s&&clearTimeout(s),s=null,n.forEach(d=>{d.unsubscribe?d.unsubscribe(o):d.removeEventListener("abort",o)}),n=null)};n.forEach(d=>d.addEventListener("abort",o));let{signal:c}=r;return c.unsubscribe=()=>te.asap(a),c}},mN=A(Nw),av=Ld.f("asyncIterator"),hU=A(av);function EN(n,e){this.v=n,this.k=e}function wo(n){return function(){return new ao(n.apply(this,arguments))}}function ao(n){var e,t;function i(o,s){try{var a=n[o](s),c=a.value,d=c instanceof EN;mN.resolve(d?c.v:c).then(function(l){if(d){var h=o==="return"?"return":"next";if(!c.k||l.done)return i(h,l);l=n[h](l).value}r(a.done?"return":"normal",l)},function(l){i("throw",l)})}catch(l){r("throw",l)}}function r(o,s){switch(o){case"return":e.resolve({value:s,done:!0});break;case"throw":e.reject(s);break;default:e.resolve({value:s,done:!1})}(e=e.next)?i(e.key,e.arg):t=null}this._invoke=function(o,s){return new mN(function(a,c){var d={key:o,arg:s,resolve:a,reject:c,next:null};t?t=t.next=d:(e=t=d,i(o,s))})},typeof n.return!="function"&&(this.return=void 0)}function St(n){return new EN(n,0)}function Et(n){var e={},t=!1;function i(r,o){return t=!0,o=new mN(function(s){s(n[r](o))}),{done:!1,value:new EN(o,1)}}return e[E_!==void 0&&g_||"@@iterator"]=function(){return this},e.next=function(r){return t?(t=!1,r):i("next",r)},typeof n.throw=="function"&&(e.throw=function(r){if(t)throw t=!1,r;return i("throw",r)}),typeof n.return=="function"&&(e.return=function(r){return t?(t=!1,r):i("return",r)}),e}ao.prototype[typeof E_=="function"&&hU||"@@asyncIterator"]=function(){return this},ao.prototype.next=function(n){return this._invoke("next",n)},ao.prototype.throw=function(n){return this._invoke("throw",n)},ao.prototype.return=function(n){return this._invoke("return",n)};var vu=A(av);function wf(n){var e,t,i,r=2;for(typeof Symbol<"u"&&(t=vu,i=Symbol.iterator);r--;){if(t&&(e=n[t])!=null)return e.call(n);if(i&&(e=n[i])!=null)return new bf(e.call(n));t="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function bf(n){function e(t){if(Object(t)!==t)return Z.reject(new TypeError(t+" is not an object."));var i=t.done;return Z.resolve(t.value).then(function(r){return{value:r,done:i}})}return bf=function(t){this.s=t,this.n=t.next},bf.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(t){var i=this.s.return;return i===void 0?Z.resolve({value:t,done:!0}):e(i.apply(this.s,arguments))},throw:function(t){var i=this.s.return;return i===void 0?Z.reject(t):e(i.apply(this.s,arguments))}},new bf(n)}let cv=function*(n,e){let t=n.byteLength;if(!e||t<e)return void(yield n);let i,r=0;for(;r<t;)i=r+e,yield n.slice(r,i),r=i},PY=function(){var n=wo(function*(e,t){var i,r=!1,o=!1;try{for(var s,a=wf(LY(e));r=!(s=yield St(a.next())).done;r=!1){let c=s.value;yield*Et(wf(cv(c,t)))}}catch(c){o=!0,i=c}finally{try{r&&a.return!=null&&(yield St(a.return()))}finally{if(o)throw i}}});return function(e,t){return n.apply(this,arguments)}}(),LY=function(){var n=wo(function*(e){if(e[vu])return void(yield*Et(wf(e)));let t=e.getReader();try{for(;;){let{done:i,value:r}=yield St(t.read());if(i)break;yield r}}finally{yield St(t.cancel())}});return function(e){return n.apply(this,arguments)}}(),pU=(n,e,t,i)=>{let r=PY(n,e),o,s=0,a=c=>{o||(o=!0,i&&i(c))};return new ReadableStream({async pull(c){try{let{done:d,value:l}=await r.next();if(d)return a(),void c.close();let h=l.byteLength;if(t){let p=s+=h;t(p)}c.enqueue(new Uint8Array(l))}catch(d){throw a(d),d}},cancel:c=>(a(c),r.return())},{highWaterMark:2})};function gN(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function SN(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?gN(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):gN(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}let{isFunction:qS}=te,dv=(n=>{let{Request:e,Response:t}=n;return{Request:e,Response:t}})(te.global),{ReadableStream:_U,TextEncoder:TN}=te.global,RN=function(n){try{for(var e=arguments.length,t=new Array(e>1?e-1:0),i=1;i<e;i++)t[i-1]=arguments[i];return!!n(...t)}catch{return!1}},fU=n=>{n=te.merge.call({skipUndefined:!0},dv,n);let{fetch:e,Request:t,Response:i}=n,r=e?qS(e):typeof fetch=="function",o=qS(t),s=qS(i);if(!r)return!1;let a=r&&qS(_U),c=r&&(typeof TN=="function"?(d=new TN,m=>d.encode(m)):async m=>new Uint8Array(await new t(m).arrayBuffer()));var d;let l=o&&a&&RN(()=>{let m=!1,g=new t(ls.origin,{body:new _U,method:"POST",get duplex(){return m=!0,"half"}}).headers.has("Content-Type");return m&&!g}),h=s&&a&&RN(()=>te.isReadableStream(new i("").body)),p={stream:h&&(m=>m.body)};r&&["text","arrayBuffer","blob","formData","stream"].forEach(m=>{!p[m]&&(p[m]=(g,S)=>{let T=g&&g[m];if(T)return T.call(g);throw new nt("Response type '".concat(m,"' is not supported"),nt.ERR_NOT_SUPPORT,S)})});let f=async(m,g)=>te.toFiniteNumber(m.getContentLength())??(async T=>T==null?0:te.isBlob(T)?T.size:te.isSpecCompliantForm(T)?(await new t(ls.origin,{method:"POST",body:T}).arrayBuffer()).byteLength:te.isArrayBufferView(T)||te.isArrayBuffer(T)?T.byteLength:(te.isURLSearchParams(T)&&(T+=""),te.isString(T)?(await c(T)).byteLength:void 0))(g);return async m=>{let{url:g,method:S,data:T,signal:C,cancelToken:b,timeout:D,onDownloadProgress:x,onUploadProgress:k,responseType:V,headers:W,withCredentials:K="same-origin",fetchOptions:J}=yh(m),se=e||fetch;V=V?(V+"").toLowerCase():"text";let Ne=DY([C,b&&b.toAbortSignal()],D),Ce=null,De=Ne&&Ne.unsubscribe&&(()=>{Ne.unsubscribe()}),Me;try{if(k&&l&&S!=="get"&&S!=="head"&&(Me=await f(W,T))!==0){let w,v=new t(g,{method:"POST",body:T,duplex:"half"});if(te.isFormData(T)&&(w=v.headers.get("content-type"))&&W.setContentType(w),v.body){let[N,j]=zS(Me,YS(_N(k)));T=pU(v.body,65536,N,j)}}te.isString(K)||(K=K?"include":"omit");let et=o&&"credentials"in t.prototype,ae=SN(SN({},J),{},{signal:Ne,method:S.toUpperCase(),headers:W.normalize().toJSON(),body:T,duplex:"half",credentials:et?K:void 0});Ce=o&&new t(g,ae);let Y=await(o?se(Ce,J):se(g,ae)),ie=h&&(V==="stream"||V==="response");if(h&&(x||ie&&De)){let w={};["status","statusText","headers"].forEach(ne=>{w[ne]=Y[ne]});let v=te.toFiniteNumber(Y.headers.get("content-length")),[N,j]=x&&zS(v,YS(_N(x),!0))||[];Y=new i(pU(Y.body,65536,N,()=>{j&&j(),De&&De()}),w)}V=V||"text";let Q=await p[te.findKey(p,V)||"text"](Y,m);return!ie&&De&&De(),await new Z((w,v)=>{T_(w,v,{data:Q,headers:ua.from(Y.headers),status:Y.status,statusText:Y.statusText,config:m,request:Ce})})}catch(et){throw De&&De(),et&&et.name==="TypeError"&&/Load failed|fetch/i.test(et.message)?Object.assign(new nt("Network Error",nt.ERR_NETWORK,m,Ce),{cause:et.cause||et}):nt.from(et,et&&et.code,m,Ce)}}},kY=new Map,mU=n=>{let e=n&&n.env||{},{fetch:t,Request:i,Response:r}=e,o=[i,r,t],s,a,c=o.length,d=kY;for(;c--;)s=o[c],a=d.get(s),a===void 0&&d.set(s,a=c?new Map:fU(e)),d=a;return a};mU();let lv={http:null,xhr:uU,fetch:{get:mU}};te.forEach(lv,(n,e)=>{if(n){try{Object.defineProperty(n,"name",{value:e})}catch{}Object.defineProperty(n,"adapterName",{value:e})}});let uv=n=>"- ".concat(n),EU=n=>te.isFunction(n)||n===null||n===!1;var gU={getAdapter:function(n,e){n=te.isArray(n)?n:[n];let{length:t}=n,i,r,o={};for(let s=0;s<t;s++){let a;if(i=n[s],r=i,!EU(i)&&(r=lv[(a=String(i)).toLowerCase()],r===void 0))throw new nt("Unknown adapter '".concat(a,"'"));if(r&&(te.isFunction(r)||(r=r.get(e))))break;o[a||"#"+s]=r}if(!r){let s=Object.entries(o).map(a=>{let[c,d]=a;return"adapter ".concat(c," ")+(d===!1?"is not supported by the environment":"is not available in the build")});throw new nt("There is no suitable adapter to dispatch the request "+(t?s.length>1?`since :
`+s.map(uv).join(`
`):" "+uv(s[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return r},adapters:lv};function hv(n){if(n.cancelToken&&n.cancelToken.throwIfRequested(),n.signal&&n.signal.aborted)throw new S_(null,n)}function pv(n){return hv(n),n.headers=ua.from(n.headers),n.data=Qa.call(n,n.transformRequest),["post","put","patch"].indexOf(n.method)!==-1&&n.headers.setContentType("application/x-www-form-urlencoded",!1),gU.getAdapter(n.adapter||KS.adapter,n)(n).then(function(e){return hv(n),e.data=Qa.call(n,n.transformResponse,e),e.headers=ua.from(e.headers),e},function(e){return nv(e)||(hv(n),e&&e.response&&(e.response.data=Qa.call(n,n.transformResponse,e.response),e.response.headers=ua.from(e.response.headers))),Z.reject(e)})}let vN="1.13.2",XS={};["object","boolean","number","function","string","symbol"].forEach((n,e)=>{XS[n]=function(t){return typeof t===n||"a"+(e<1?"n ":" ")+n}});let JS={};XS.transitional=function(n,e,t){function i(r,o){return"[Axios v"+vN+"] Transitional option '"+r+"'"+o+(t?". "+t:"")}return(r,o,s)=>{if(n===!1)throw new nt(i(o," has been removed"+(e?" in "+e:"")),nt.ERR_DEPRECATED);return e&&!JS[o]&&(JS[o]=!0,console.warn(i(o," has been deprecated since v"+e+" and will be removed in the near future"))),!n||n(r,o,s)}},XS.spelling=function(n){return(e,t)=>(console.warn("".concat(t," is likely a misspelling of ").concat(n)),!0)};var QS={assertOptions:function(n,e,t){if(typeof n!="object")throw new nt("options must be an object",nt.ERR_BAD_OPTION_VALUE);let i=Object.keys(n),r=i.length;for(;r-- >0;){let o=i[r],s=e[o];if(s){let a=n[o],c=a===void 0||s(a,o,n);if(c!==!0)throw new nt("option "+o+" must be "+c,nt.ERR_BAD_OPTION_VALUE)}else if(t!==!0)throw new nt("Unknown option "+o,nt.ERR_BAD_OPTION)}},validators:XS};let Za=QS.validators,$a=class{constructor(n){this.defaults=n||{},this.interceptors={request:new l0,response:new l0}}async request(n,e){try{return await this._request(n,e)}catch(t){if(t instanceof Error){let i={};Error.captureStackTrace?Error.captureStackTrace(i):i=new Error;let r=i.stack?i.stack.replace(/^.+\n/,""):"";try{t.stack?r&&!String(t.stack).endsWith(r.replace(/^.+\n.+\n/,""))&&(t.stack+=`
`+r):t.stack=r}catch{}}throw t}}_request(n,e){typeof n=="string"?(e=e||{}).url=n:e=n||{},e=Ch(this.defaults,e);let{transitional:t,paramsSerializer:i,headers:r}=e;t!==void 0&&QS.assertOptions(t,{silentJSONParsing:Za.transitional(Za.boolean),forcedJSONParsing:Za.transitional(Za.boolean),clarifyTimeoutError:Za.transitional(Za.boolean)},!1),i!=null&&(te.isFunction(i)?e.paramsSerializer={serialize:i}:QS.assertOptions(i,{encode:Za.function,serialize:Za.function},!0)),e.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?e.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:e.allowAbsoluteUrls=!0),QS.assertOptions(e,{baseUrl:Za.spelling("baseURL"),withXsrfToken:Za.spelling("withXSRFToken")},!0),e.method=(e.method||this.defaults.method||"get").toLowerCase();let o=r&&te.merge(r.common,r[e.method]);r&&te.forEach(["delete","get","head","post","put","patch","common"],f=>{delete r[f]}),e.headers=ua.concat(o,r);let s=[],a=!0;this.interceptors.request.forEach(function(f){typeof f.runWhen=="function"&&f.runWhen(e)===!1||(a=a&&f.synchronous,s.unshift(f.fulfilled,f.rejected))});let c=[],d;this.interceptors.response.forEach(function(f){c.push(f.fulfilled,f.rejected)});let l,h=0;if(!a){let f=[pv.bind(this),void 0];for(f.unshift(...s),f.push(...c),l=f.length,d=Z.resolve(e);h<l;)d=d.then(f[h++],f[h++]);return d}l=s.length;let p=e;for(;h<l;){let f=s[h++],m=s[h++];try{p=f(p)}catch(g){m.call(this,g);break}}try{d=pv.call(this,p)}catch(f){return Z.reject(f)}for(h=0,l=c.length;h<l;)d=d.then(c[h++],c[h++]);return d}getUri(n){return d0(lU((n=Ch(this.defaults,n)).baseURL,n.url,n.allowAbsoluteUrls),n.params,n.paramsSerializer)}};te.forEach(["delete","get","head","options"],function(n){$a.prototype[n]=function(e,t){return this.request(Ch(t||{},{method:n,url:e,data:(t||{}).data}))}}),te.forEach(["post","put","patch"],function(n){function e(t){return function(i,r,o){return this.request(Ch(o||{},{method:n,headers:t?{"Content-Type":"multipart/form-data"}:{},url:i,data:r}))}}$a.prototype[n]=e(),$a.prototype[n+"Form"]=e(!0)});var R_=$a;class Of{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let t;this.promise=new Z(function(r){t=r});let i=this;this.promise.then(r=>{if(!i._listeners)return;let o=i._listeners.length;for(;o-- >0;)i._listeners[o](r);i._listeners=null}),this.promise.then=r=>{let o,s=new Z(a=>{i.subscribe(a),o=a}).then(r);return s.cancel=function(){i.unsubscribe(o)},s},e(function(r,o,s){i.reason||(i.reason=new S_(r,o,s),t(i.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;let t=this._listeners.indexOf(e);t!==-1&&this._listeners.splice(t,1)}toAbortSignal(){let e=new AbortController,t=i=>{e.abort(i)};return this.subscribe(t),e.signal.unsubscribe=()=>this.unsubscribe(t),e.signal}static source(){let e;return{token:new Of(function(t){e=t}),cancel:e}}}var CN=Of;let yN={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511,WebServerIsDown:521,ConnectionTimedOut:522,OriginIsUnreachable:523,TimeoutOccurred:524,SslHandshakeFailed:525,InvalidSslCertificate:526};Object.entries(yN).forEach(n=>{let[e,t]=n;yN[t]=e});var IN=yN;let fo=function n(e){let t=new R_(e),i=YO(R_.prototype.request,t);return te.extend(i,R_.prototype,t,{allOwnKeys:!0}),te.extend(i,t,null,{allOwnKeys:!0}),i.create=function(r){return n(Ch(e,r))},i}(KS);fo.Axios=R_,fo.CanceledError=S_,fo.CancelToken=CN,fo.isCancel=nv,fo.VERSION=vN,fo.toFormData=__,fo.AxiosError=nt,fo.Cancel=fo.CanceledError,fo.all=function(n){return Z.all(n)},fo.spread=function(n){return function(e){return n.apply(null,e)}},fo.isAxiosError=function(n){return te.isObject(n)&&n.isAxiosError===!0},fo.mergeConfig=Ch,fo.AxiosHeaders=ua,fo.formToJSON=n=>aU(te.isHTMLForm(n)?new FormData(n):n),fo.getAdapter=gU.getAdapter,fo.HttpStatusCode=IN,fo.default=fo;var Qi=fo;let hs=()=>{};function ZS(){let n={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:hs};return n.promise=new Z((e,t)=>{n.resolve=i=>{n.isFinished||(n.isResolved=!0,n.isFinished=!0,e(i),n.value=i)},n.reject=i=>{n.isFinished||(n.isRejected=!0,n.isFinished=!0,t(i))}}),n}let Ih=new Map,v_=new Map,ec=new Map,pr=function(n){return n.WIN_10="Windows 10",n.WIN_81="Windows 8.1",n.WIN_8="Windows 8",n.WIN_7="Windows 7",n.WIN_VISTA="Windows Vista",n.WIN_SERVER_2003="Windows Server 2003",n.WIN_XP="Windows XP",n.WIN_2000="Windows 2000",n.ANDROID="Android",n.HARMONY_OS="HarmonyOS",n.OPEN_BSD="Open BSD",n.SUN_OS="Sun OS",n.LINUX="Linux",n.IOS="iOS",n.MAC_OS="Mac OS",n.CHROMIUM_OS="Chromium OS",n.QNX="QNX",n.UNIX="UNIX",n.BEOS="BeOS",n.OS_2="OS/2",n.SEARCH_BOT="Search Bot",n}({}),pt=function(n){return n.CHROME="Chrome",n.SAFARI="Safari",n.EDGE="Edge",n.FIREFOX="Firefox",n.OPERA="OPR",n.QQ="QQBrowser",n.WECHAT="MicroMessenger",n}({}),di=new mK,Ac=di.getResult(),tc=null;function Zt(n){if(!tc){Ac=di.getResult();let e=function(a){if(a.engine.name==="Blink"&&a.browser.name!=="WeChat")return pt.CHROME;switch(a.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return pt.CHROME;case"Safari":case"Mobile Safari":return pt.SAFARI;case"Edge":return pt.EDGE;case"Firefox":return pt.FIREFOX;case"QQ":case"QQBrowser":return pt.QQ;case"Opera":return pt.OPERA;case"WeChat":return pt.WECHAT;default:return a.browser.name||""}}(Ac),t=ii(Ac),i=function(a){return a.os.name==="Windows"?a.os.version?a.os.name+" "+a.os.version:a.os.name:a.os.name||""}(Ac),r=Ac.os.version,o=ii(Ac,!1),s=Ac.device.type;if(!(e&&t&&i&&r))return{name:e,version:t,os:i,osVersion:r,browserVersion:o,deviceType:s};tc={name:e,version:t,os:i,osVersion:r,browserVersion:o,deviceType:s}}return tc}function ii(n){let e,t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return e=n.engine.name==="Blink"?n.engine.version||"":n.browser.version||"",t?e.split(".")[0]:e}function $S(){return Zt().os}function eT(){let n=Zt();return"".concat(n.os," ").concat(n.osVersion)}function tT(){let n=Zt();return!!(Ac.engine.name==="WebKit"&&n.os===pr.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&n.name!==pt.SAFARI||Ht()&&n.name!==pt.SAFARI)}function wc(){return Zt().name===pt.CHROME}function Cr(){return Zt().name===pt.SAFARI}function pn(){let n=Zt();if(n.name!==pt.SAFARI||!n.browserVersion)return!1;let e=n.browserVersion.split(".");return Number(e[0])>15||Number(e[0])===15&&Number(e[1])>=4}function AN(){return Zt().name===pt.EDGE}function ji(){return Zt().name===pt.FIREFOX}function Ht(){return Zt().os===pr.IOS}function Dr(n){let e=Zt();return!(e.name!==pt.CHROME||!e.osVersion)&&Number(e.version)>=n}function bc(n){let e=Zt();return!(e.name!==pt.CHROME||!e.osVersion)&&Number(e.version)<n}function _v(n,e,t){let i=Zt();return!(i.name!==n||!i.osVersion)&&(t?Number(i.version)>=e&&Number(i.version)<=t:Number(i.version)===e)}function Tl(n){let e=Zt();return!(e.name!==pt.EDGE||!e.osVersion)&&Number(e.version)>=n}function Rl(n){let e=Zt();return!(e.name!==pt.FIREFOX||!e.osVersion)&&Number(e.version)>=n}function fv(n){let e=Zt();return!(e.name!==pt.SAFARI||!e.osVersion)&&Number(e.version)>=n}function wN(n,e,t){let i=Zt();if(i.os!==pr.IOS||!i.osVersion)return!1;let r=i.osVersion.split(".");return t?e&&Number(r[0])===n&&Number(r[1])>e||Number(r[0])>n:e?Number(r[0])===n&&Number(r[1])>=e||Number(r[0])>n:Number(r[0])>=n}function bN(n,e,t){let i=Zt();if(i.os!==pr.IOS||!i.osVersion)return!1;let r=i.osVersion.split(".");return t?e&&Number(r[0])===n&&Number(r[1])<e||Number(r[0])<n:e?Number(r[0])===n&&Number(r[1])<=e||Number(r[0])<n:Number(r[0])<=n}function mv(n,e,t){let i=Zt();if(i.name!==pt.SAFARI||!i.osVersion||!i.browserVersion)return!1;let r=i.browserVersion.split(".");return t?e&&Number(r[0])===n&&Number(r[1])<e||Number(r[0])<n:e?Number(r[0])===n&&Number(r[1])<=e||Number(r[0])<n:Number(r[0])<=n}function Cu(n){let e=Zt();return!(e.name!==pt.OPERA||!e.osVersion)&&Number(e.version)>=n}function Ah(){let n=Zt();if(n.os!==pr.IOS||!n.osVersion)return!1;let e=n.osVersion.split(".");return Number(e[0])<14||Number(e[0])===14&&Number(e[1])<=6}function C_(){let n=Zt();if(n.os!==pr.IOS||!n.osVersion)return!1;let e=n.osVersion.split(".");return Number(e[0])===15}function wh(){let n=Zt();if(n.os!==pr.IOS||!n.osVersion)return!1;let e=n.osVersion.split(".");return Number(e[0])===16}function Ev(){let n=Zt();if(n.os!==pr.IOS||!n.osVersion)return!1;let e=n.osVersion.split(".");return Number(e[0])===15&&Number(e[1])>=1}function ic(){return Cr()&&navigator.maxTouchPoints>0}function rc(){return Zt().name===pt.WECHAT}function ON(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function NN(){let n=$S();return function(){let{deviceType:e}=Zt();return e==="mobile"||e==="tablet"}()||n===pr.ANDROID||n===pr.IOS||n===pr.HARMONY_OS}function Ud(){let n=Zt();return n.name!==pt.EDGE&&n.name!==pt.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function ha(){return $S()===pr.ANDROID}function yu(){let n=Zt();return ha()&&(n.name===pt.CHROME||n.name===pt.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function at(n,e,t){return(e=function(i){var r=function(o,s){if(typeof o!="object"||!o)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(i);return typeof r=="symbol"?r:r+""}(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function ut(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function Te(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ut(Object(t),!0).forEach(function(i){at(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):ut(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}let L=function(n){return n.UNEXPECTED_ERROR="UNEXPECTED_ERROR",n.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",n.TIMEOUT="TIMEOUT",n.INVALID_PARAMS="INVALID_PARAMS",n.NOT_READABLE="NOT_READABLE",n.NOT_SUPPORTED="NOT_SUPPORTED",n.INVALID_OPERATION="INVALID_OPERATION",n.OPERATION_ABORTED="OPERATION_ABORTED",n.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",n.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",n.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",n.DATACHANNEL_FAILED="DATACHANNEL_FAILED",n.NETWORK_ERROR="NETWORK_ERROR",n.NETWORK_TIMEOUT="NETWORK_TIMEOUT",n.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",n.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",n.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",n.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",n.ELECTRON_IS_NULL="ELECTRON_IS_NULL",n.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",n.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",n.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",n.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",n.PERMISSION_DENIED="PERMISSION_DENIED",n.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",n.TRACK_IS_DISABLED="TRACK_IS_DISABLED",n.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",n.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",n.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",n.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",n.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",n.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",n.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",n.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",n.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",n.UID_CONFLICT="UID_CONFLICT",n.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",n.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",n.TOKEN_EXPIRE="TOKEN_EXPIRE",n.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",n.INVALID_TRACK="INVALID_TRACK",n.SENDER_NOT_FOUND="SENDER_NOT_FOUND",n.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",n.SET_ANSWER_FAILED="SET_ANSWER_FAILED",n.ICE_FAILED="ICE_FAILED",n.PC_CLOSED="PC_CLOSED",n.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",n.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",n.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",n.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",n.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",n.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",n.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",n.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",n.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",n.INVALID_REMOTE_USER="INVALID_REMOTE_USER",n.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",n.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",n.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",n.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",n.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",n.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",n.WS_ABORT="WS_ABORT",n.WS_DISCONNECT="WS_DISCONNECT",n.WS_ERR="WS_ERR",n.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",n.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",n.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",n.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",n.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",n.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",n.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",n.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",n.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",n.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",n.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",n.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",n.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",n.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",n.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",n.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",n.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",n.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",n.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",n.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",n.INVALID_PLUGIN="INVALID_PLUGIN",n.DISCONNECT_P2P="DISCONNECT_P2P",n.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",n.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",n.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",n.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",n.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",n.PROHIBITED_OPERATION="PROHIBITED_OPERATION",n.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",n.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",n}({}),O=class extends Error{constructor(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",t=arguments.length>2?arguments[2]:void 0;super(e),at(this,"code",void 0),at(this,"message",void 0),at(this,"data",void 0),at(this,"name","AgoraRTCException"),this.code=n,this.message="AgoraRTCError ".concat(this.code,": ").concat(e),this.data=t}toString(){return this.data?"".concat(this.message,`
data: `).concat(JSON.stringify(this.data)):this.message}print(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",e=arguments.length>1?arguments[1]:void 0;return n==="error"&&(e||console).error(this.toString()),n==="warning"&&(e||console).warn(this.toString()),this}throw(n){throw this.print("error",n),this}};function oe(n,e){if(typeof n!="boolean")throw new O(L.INVALID_PARAMS,"Invalid ".concat(e,": The value is of the boolean type."))}function xi(n,e,t){if(!z(t).call(t,n))throw new O(L.INVALID_PARAMS,"".concat(e," can only be set as ").concat(JSON.stringify(t)))}function Rt(n,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(n<t||n>i||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(r){return typeof r=="number"&&r%1==0}(n))throw new O(L.INVALID_PARAMS,"invalid ".concat(e,": the value range is [").concat(t,", ").concat(i,"]. integer only"))}function Ai(n,e){if(typeof n!="number"){if(!(n.min||n.max||n.ideal||n.exact))throw new O(L.INVALID_PARAMS,"".concat(e," is not a valid ConstrainLong"));n.min!==void 0&&Rt(n.min,"".concat(e,".min"),0,1/0),n.max!==void 0&&Rt(n.max,"".concat(e,".max"),1,1/0),n.exact!==void 0&&Rt(n.exact,"".concat(e,".exact"),1,1/0),n.ideal!==void 0&&Rt(n.ideal,"".concat(e,".ideal"),1,1/0)}else Rt(n,e,1,1/0)}function _n(n,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,r=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(n==null)throw new O(L.INVALID_PARAMS,"".concat(e||"param"," cannot be empty"));if(!_r(n,t,i,r))throw new O(L.INVALID_PARAMS,"Invalid ".concat(e||"string param",": Length of the string: [").concat(t,",").concat(i,"].").concat(r?" ASCII characters only.":""))}function Ar(n,e){if(!Array.isArray(n))throw new O(L.INVALID_PARAMS,"".concat(e," should be an array"))}function Pi(n){return n==null}function _r(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,i=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof n=="string"&&n.length<=t&&n.length>=e&&(!i||function(r){if(typeof r!="string")return!1;for(let o=0;o<r.length;o+=1){let s=r.charCodeAt(o);if(s<0||s>255)return!1}return!0}(n))}function DN(n,e,t){if("getBigUint64"in DataView.prototype)return n.getBigUint64(e,t);let i=n.getUint32(e,t),r=n.getUint32(e+4,t),o=0,s=1;return BigInt(i*s+r*o)<<BigInt(32)|BigInt(i*o+r*s)}function PN(n,e,t,i){if("setBigUint64"in DataView.prototype)return n.setBigUint64(e,t,i);let r=Number(t>>BigInt(32)),o=Number(t&BigInt(4294967295));n.setUint32(e,r,i),n.setUint32(e+4,o,i)}var Nf=function(n){return n.COVERED="COVERED",n.POSITION="POSITION",n.SIZE="SIZE",n.STYLE="STYLE",n}(Nf||{}),y_=function(n){return n.UNMOUNTED="UNMOUNTED",n.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",n}(y_||{});let gv=new class{constructor(){at(this,"_clientSize",null),at(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),at(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),at(this,"getStyle",n=>window.getComputedStyle(n,null)),at(this,"checkCssVisibleProperty",n=>{var e;let t=!0,i=this.getStyle(n),{display:r,visibility:o,opacity:s,filter:a}=i;return(r==="none"||z(e=["hidden","collapse"]).call(e,o)||Number(s)<.1)&&(t=!1),!!t&&(a&&a.split(" ").filter(c=>{var d;let l=c.split("(")[0];return z(d=["brightness","blur","opacity"]).call(d,l)}).map(c=>{let[d,l]=c.split(/\(|\)/);return[d,Number(l.match(/^[0-9\.]+/))]}).forEach(c=>{let[d,l]=c;switch(d){case"brightness":(l<.1||l>3)&&(t=!1);break;case"blur":l>3&&(t=!1);break;case"opacity":l<.1&&(t=!1)}}),t)}),at(this,"checkPropertyUpToAllParentNodes",(n,e)=>{let t=!0,i=!0,r=s=>e(s),o=n;for(;o&&i;)r(o)||(t=!1,i=!1),o=o.parentElement,o||(i=!1);return t}),at(this,"checkActualCssVisibleIncludeInherit",n=>this.checkPropertyUpToAllParentNodes(n,this.checkCssVisibleProperty)),at(this,"getSizeAboutClient",n=>{let{width:e,height:t,left:i,right:r,top:o,bottom:s}=n.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:e,height:t,left:i,right:r,top:o,bottom:s,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}}),at(this,"checkActualSize",()=>{let{width:n,height:e,clientMin:t}=this._clientSize;return this.checkSizeIsVisible(n,e,t)}),at(this,"elementFromPoint",(n,e)=>document.elementFromPoint?document.elementFromPoint(n,e):null),at(this,"checkCoverForAPoint",(n,e,t)=>{let i=this.elementFromPoint(n,e);return i!==null&&i!==t}),at(this,"getPointPositionList",()=>{let{width:n,height:e,left:t,top:i}=this._clientSize,r=n/6,o=e/6,s=[],a=10**6;for(let c=0;c<5;c++)for(let d=0;d<5;d++){let l=(t*a+(c===0?.1:c===4?(r*c*a-1e5)/a:r*c)*a)/a,h=(i*a+(d===0?.1:d===4?(o*d*a-1e5)/a:o*d)*a)/a;s.push({x:l,y:h})}return[...s]}),at(this,"checkElementCover",n=>this.getPointPositionList().map(e=>this.checkCoverForAPoint(e.x,e.y,n)).filter(e=>!!e).length>6),at(this,"checkSizeIsVisible",(n,e,t)=>(n>50||t/n<=10)&&(e>50||t/e<=10)),at(this,"checkSizeOfPartInClient",()=>{let{left:n,right:e,top:t,bottom:i,clientHeight:r,clientWidth:o,clientMin:s}=this._clientSize,a,c,d,l;if(n<0)a=0;else{if(!(n<o))return!1;a=n}if(e<0)return!1;if(c=e<o?e:o,t<0)d=0;else{if(!(t<r))return!1;d=t}if(i<0)return!1;l=i<r?i:r;let h=c-a,p=l-d;return this.checkSizeIsVisible(h,p,s)}),at(this,"returnHiddenResult",n=>(this._clientSize=null,{visible:!1,reason:n})),at(this,"checkOneElementVisible",n=>{if(n instanceof HTMLElement){if(this.checkElementIsMountedOnDom(n)){if(this.checkActualCssVisibleIncludeInherit(n)){if(this._clientSize=this.getSizeAboutClient(n),this.checkElementCover(n))return this.returnHiddenResult(Nf.COVERED);{let e=this.checkActualSize(),t=this.checkSizeOfPartInClient();return e&&!t?this.returnHiddenResult(Nf.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(Nf.SIZE)}}return this.returnHiddenResult(Nf.STYLE)}return this.returnHiddenResult(y_.UNMOUNTED)}return this.returnHiddenResult(y_.INVALID_HTML_ELEMENT)}),at(this,"checkElementIsMountedOnDom",n=>this.checkPropertyUpToAllParentNodes(n,e=>e.nodeName.toUpperCase()!=="HTML"?e.parentElement!==null:!!document.documentElement))}};function Sv(n){return new TextEncoder().encode(n)}let Tv=function(n,e){let t=new Uint8Array(n.byteLength+e.byteLength);return t.set(new Uint8Array(n),0),t.set(new Uint8Array(e),n.byteLength),t},Rv=async n=>function(e,t){let i="";return new Uint8Array(e).forEach(r=>{i+=r.toString(t).padStart(2,"0")}),i}(await crypto.subtle.digest("SHA-256",Sv(n)),16),Ki=class{constructor(){at(this,"_events",{}),at(this,"addListener",this.on)}getListeners(n){return this._events[n]?this._events[n].map(e=>e.listener):[]}on(n,e){this._events[n]||(this._events[n]=[]);let t=this._events[n];this._indexOfListener(t,e)===-1&&t.push({listener:e,once:!1})}once(n,e){this._events[n]||(this._events[n]=[]);let t=this._events[n];this._indexOfListener(t,e)===-1&&t.push({listener:e,once:!0})}off(n,e){if(!this._events[n])return;let t=this._events[n],i=this._indexOfListener(t,e);i!==-1&&t.splice(i,1),this._events[n].length===0&&delete this._events[n]}removeAllListeners(n){n?delete this._events[n]:this._events={}}emit(n){this._events[n]||(this._events[n]=[]);let e=this._events[n].map(o=>o);for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];for(let o=0;o<e.length;o+=1){let s=e[o];s.once&&this.off(n,s.listener),s.listener.apply(this,i||[])}}safeEmit(n){for(var e=arguments.length,t=new Array(e>1?e-1:0),i=1;i<e;i++)t[i-1]=arguments[i];[...this._events[n]||[]].forEach(r=>{r.once&&this.off(n,r.listener);try{r.listener.apply(this,t)}catch(o){console.error("safeEmit event:".concat(n," error ").concat(o==null?void 0:o.toString()))}})}_indexOfListener(n,e){let t=n.length;for(;t--;)if(n[t].listener===e)return t;return-1}},Vi=null;function Df(){if(Vi)return Vi;if(window.electron)return Vi=window.electron;if(!window.require)return null;try{return Vi=window.require("electron"),Vi}catch{return null}}let Yi=function(n){return n.CREATE_CLIENT="createClient",n.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",n.SET_AREA="setArea",n.PRELOAD="PRELOAD",n.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",n.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",n.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",n.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",n.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",n.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",n.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",n.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",n.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",n.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",n.START_PROXY_SERVER="Client.startProxyServer",n.STOP_PROXY_SERVER="Client.stopProxyServer",n.SET_PROXY_SERVER="Client.setProxyServer",n.SET_TURN_SERVER="Client.setTurnServer",n.SET_CLIENT_ROLE="Client.setClientRole",n.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",n.ENABLE_DUAL_STREAM="Client.enableDualStream",n.DISABLE_DUAL_STREAM="Client.disableDualStream",n.JOIN="Client.join",n.LEAVE="Client.leave",n.PUBLISH="Client.publish",n.UNPUBLISH="Client.unpublish",n.SUBSCRIBE="Client.subscribe",n.MASS_SUBSCRIBE="Client.massSubscribe",n.MASS_UNSUBSCRIBE="Client.massUnsubscribe",n.UNSUBSCRIBE="Client.unsubscribe",n.RENEW_TOKEN="Client.renewToken",n.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",n.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",n.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",n.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",n.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",n.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",n.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",n.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",n.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",n.START_LIVE_STREAMING="Client.startLiveStreaming",n.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",n.STOP_LIVE_STREAMING="Client.stopLiveStreaming",n.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",n.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",n.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",n.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",n.SET_CONFIG_DISTRIBUTE="_configDistribute",n.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",n.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",n.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",n.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",n.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",n.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",n.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",n.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",n.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",n.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",n.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",n.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",n.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",n.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",n.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",n.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",n.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",n.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",n.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",n.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",n.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",n.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",n.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",n.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",n.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",n.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",n.STREAM_TYPE_CHANGE="streamTypeChange",n.CONNECTION_STATE_CHANGE="connectionStateChange",n.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",n.IMAGE_MODERATION_UPLOAD="imageModerationUpload",n.REPUB_AFTER_PC_CONNECTED="repubAfterPCConnected",n.PRELOAD_MEDIA_FAILED="preloadMediaFailed",n.MISMATCH_DTLS_PARAMETERS="mismatchDtlsParameters",n.VOS_FALLBACK_CN="vosFallbackCN",n.DATACHANNEL_FAILBACK="datachannelFailback",n}({}),ct=function(n){return n.TRACER="tracer",n}({});function bi(n){return Rt(n.timeout,"config.timeout",0,1e5),Rt(n.timeoutFactor,"config.timeoutFactor",0,100,!1),Rt(n.maxRetryCount,"config.maxRetryConfig",0,1/0),Rt(n.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let SU=function(n){return n[n.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",n[n.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",n[n.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",n}({}),Gt=function(n){return n.LEAVE="LEAVE",n.NETWORK_ERROR="NETWORK_ERROR",n.SERVER_ERROR="SERVER_ERROR",n.UID_BANNED="UID_BANNED",n.FALLBACK="FALLBACK",n.IP_BANNED="IP_BANNED",n.CHANNEL_BANNED="CHANNEL_BANNED",n.LICENSE_MISSING="LICENSE_MISSING",n.LICENSE_EXPIRED="LICENSE_EXPIRED",n.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",n.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",n.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",n.LICENSE_ILLEGAL="LICENSE_ILLEGAL",n.TOKEN_EXPIRE="TOKEN_EXPIRE",n.FALLBACK_TO_HLS="FALLBACK_TO_HLS",n.UID_CONFLICT="UID_CONFLICT",n}({});function bt(n){if(!Array.isArray(n)||n.length<1)return!1;try{n.forEach(e=>{if(!e.urls)throw Error()})}catch{return!1}return!0}function bh(n){return _n(n.turnServerURL,"turnServerURL"),_n(n.username,"username"),_n(n.password,"password"),n.udpport&&Rt(n.udpport,"udpport",1,99999,!0),n.forceturn&&oe(n.forceturn,"forceturn"),n.security&&oe(n.security,"security"),n.tcpport&&Rt(n.tcpport,"tcpport",1,99999,!0),!0}let I_=function(n){return n[n.AUTO_SIMULCAST_STREAM=-1]="AUTO_SIMULCAST_STREAM",n[n.DISABLE_SIMULCAST_STREM=0]="DISABLE_SIMULCAST_STREM",n[n.ENABLE_SIMULCAST_STREAM=1]="ENABLE_SIMULCAST_STREAM",n}({});function Oh(n){return n.level!==void 0&&xi(n.level,"level",[1,2,3]),n.delay!==void 0&&Rt(n.delay,"delay",0,3e3,!0),!0}let It=function(n){return n.PEERCONNECTION_STATE_CHANGE="peerconnection-state-change",n.AUDIO_METADATA="audio-metadata",n.AUDIO_PTS="audio-pts",n.CONNECTION_STATE_CHANGE="connection-state-change",n.MEDIA_RECONNECT_START="media-reconnect-start",n.MEDIA_RECONNECT_END="media-reconnect-end",n.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",n.USER_JOINED="user-joined",n.USER_LEAVED="user-left",n.USER_PUBLISHED="user-published",n.USER_UNPUBLISHED="user-unpublished",n.USER_INFO_UPDATED="user-info-updated",n.CLIENT_BANNED="client-banned",n.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",n.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",n.VOLUME_INDICATOR="volume-indicator",n.CRYPT_ERROR="crypt-error",n.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",n.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",n.NETWORK_QUALITY="network-quality",n.STREAM_TYPE_CHANGED="stream-type-changed",n.STREAM_FALLBACK="stream-fallback",n.RECEIVE_METADATA="receive-metadata",n.STREAM_MESSAGE="stream-message",n.LIVE_STREAMING_ERROR="live-streaming-error",n.LIVE_STREAMING_WARNING="live-streaming-warning",n.EXCEPTION="exception",n.ERROR="error",n.P2P_LOST="p2p_lost",n.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",n.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",n.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",n.PUBLISHED_USER_LIST="published-user-list",n.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",n.CONTENT_INSPECT_ERROR="content-inspect-error",n.CONTENT_INSPECT_RESULT="content-inspect-result",n.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",n.FALLBACK_TO_HLS="fallback-to-hls",n.FIRST_VIDEO_BUFFER_READY="first-video-buffer-ready",n.FIRST_VIDEO_PRE_RENDER="first-video-pre-render",n.AV1_DECODABLE_RESULT="av1-decodable-result",n}({}),At=function(n){return n.CONFIG="config",n.VOSERROR="vos_error",n.AP_ERROR="ap_error",n}({}),Cn=function(n){return n.NETWORK_ERROR="NETWORK_ERROR",n.SERVER_ERROR="SERVER_ERROR",n.MULTI_IP="MULTI_IP",n.TIMEOUT="TIMEOUT",n.OFFLINE="OFFLINE",n.LEAVE="LEAVE",n.P2P_FAILED="P2P_FAILED",n.FALLBACK="FALLBACK",n.REGIONAL_DISTRIBUTION="REGIONAL_DISTRIBUTION",n}({}),Gi=function(n){return n.ONLINE="ONLINE",n.OFFLINE="OFFLINE",n}({}),yn=function(n){return n.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",n.ONLINE="ONLINE",n.OFFLINE="OFFLINE",n}({});function fr(n,e){for(var t=arguments.length,i=new Array(t>2?t-2:0),r=2;r<t;r++)i[r-2]=arguments[r];return n.getListeners(e).length===0?Z.reject(new O(L.UNEXPECTED_ERROR,"can not emit promise")):new Z((o,s)=>{n.emit(e,...i,o,s)})}function yt(n,e){if(n.getListeners(e).length===0)return Z.resolve();for(var t=arguments.length,i=new Array(t>2?t-2:0),r=2;r<t;r++)i[r-2]=arguments[r];return fr(n,e,...i)}function Xt(n,e){if(n.getListeners(e).length===0)return null;for(var t=arguments.length,i=new Array(t>2?t-2:0),r=2;r<t;r++)i[r-2]=arguments[r];return co(n,e,...i)}function co(n,e){let t=null,i=null;for(var r=arguments.length,o=new Array(r>2?r-2:0),s=2;s<r;s++)o[s-2]=arguments[s];if(n.emit(e,...o,a=>{t=a},a=>{i=a}),i!==null)throw i;if(t===null)throw new O(L.UNEXPECTED_ERROR,"handler is not sync");return t}let Wi=new class extends Ki{set networkState(n){this.emit(yn.NETWORK_STATE_CHANGE,n,this._networkState),n===Gi.ONLINE?this.emit(yn.ONLINE):n===Gi.OFFLINE&&(this.onlineWaiter=new Z(e=>{this.once(yn.ONLINE,()=>{this.onlineWaiter=void 0,e(Gi.ONLINE)})}),this.emit(yn.OFFLINE)),this._networkState=n}get networkState(){return this._networkState}get isOnline(){return this._networkState===Gi.ONLINE}constructor(){super(),at(this,"_moduleName","network-indicator"),at(this,"_networkState",Gi.ONLINE),at(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=Gi.ONLINE}),window.addEventListener("offline",()=>{this.networkState=Gi.OFFLINE})}},fi=[];for(let n=0;n<256;++n)fi.push((n+256).toString(16).slice(1));let Go=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),vv,LN=new Uint8Array(16);function MY(){return Go?Go():function(t,i,r){var o,s,a,c;let d=(o=(s=(t=t||{}).random)!==null&&s!==void 0?s:(a=(c=t).rng)===null||a===void 0?void 0:a.call(c))!==null&&o!==void 0?o:function(){if(!vv){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");vv=crypto.getRandomValues.bind(crypto)}return vv(LN)}();if(d.length<16)throw new Error("Random bytes length must be >= 16");if(d[6]=15&d[6]|64,d[8]=63&d[8]|128,i){if((r=r||0)<0||r+16>i.length)throw new RangeError("UUID byte range ".concat(r,":").concat(r+15," is out of buffer bounds"));for(let l=0;l<16;++l)i[r+l]=d[l];return i}return function(l){let h=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(fi[l[h+0]]+fi[l[h+1]]+fi[l[h+2]]+fi[l[h+3]]+"-"+fi[l[h+4]]+fi[l[h+5]]+"-"+fi[l[h+6]]+fi[l[h+7]]+"-"+fi[l[h+8]]+fi[l[h+9]]+"-"+fi[l[h+10]]+fi[l[h+11]]+fi[l[h+12]]+fi[l[h+13]]+fi[l[h+14]]+fi[l[h+15]]).toLowerCase()}(d)}(n,e,void 0);var n,e}function Cv(n,e){let t=n.indexOf(e);t!==-1&&n.splice(t,1)}function Iu(n){let e=[];return n.forEach(t=>{e.indexOf(t)===-1&&e.push(t)}),e}function Au(n){Z!==void 0?Z.resolve().then(n):setTimeout(n,0)}function Li(n){return JSON.parse(JSON.stringify(n))}function wi(n){try{return Li(n)}catch{return n}}let Nh={};function wu(n,e){Nh[e]||(Nh[e]=!0,n())}function pa(n){let e=window.atob(n),t=new Uint8Array(new ArrayBuffer(e.length));for(let i=0;i<e.length;i+=1)t[i]=e.charCodeAt(i);return t}function _a(n){let e="";for(let t=0;t<n.length;t+=1)e+=String.fromCharCode(n[t]);return window.btoa(e)}function bu(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,t=new TextEncoder().encode(n);if(t.length>e)t=t.slice(0,e);else if(t.length<e){let i=new Uint8Array(e);i.set(t),t=i}return t}function kN(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];let i=un(e).call(e,(s,a)=>s+a.length,0),r=new Uint8Array(new ArrayBuffer(i)),o=0;return e.forEach(s=>{r.set(s,o),o+=s.length}),r}function xd(n){return window.TextEncoder?new TextEncoder().encode(n).length:n.length}function Vd(n){let e=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&n.realFormData&&(n=n.realFormData),n.forEach(t=>{e+=typeof t=="string"?xd(t):t.size}),e+138}function TU(n){let e=new O(L.TIMEOUT,"timeout");return new Z((t,i)=>{window.setTimeout(()=>i(e),n)})}function fn(n){return new Z(e=>{window.setTimeout(e,n)})}function vt(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,e=arguments.length>1?arguments[1]:void 0,t=Math.random().toString(16).substr(2,n).toLowerCase();return t.length===n?"".concat(e).concat(t):"".concat(e).concat(t)+vt(n-t.length,"")}function li(){let n,e=!1;try{var t;n=fK(t=MY()).call(t,"-","")}catch{e=!0}return!e&&n&&n.length===32||(n=vt(32,"")),n.toUpperCase()}let Fd=()=>{},Pf=new class{constructor(){at(this,"fnMap",new Map)}throttleByKey(n,e,t,i){for(var r=arguments.length,o=new Array(r>4?r-4:0),s=4;s<r;s++)o[s-4]=arguments[s];if(this.fnMap.has(e)){let a=this.fnMap.get(e);if(a.threshold!==t){a.fn(...a.args),clearTimeout(a.timer);let c=window.setTimeout(()=>{let d=this.fnMap.get(e);d&&d.fn(...d.args),this.fnMap.delete(e)},t);this.fnMap.set(e,{fn:n,threshold:t,timer:c,args:o,skipFn:i})}else a.skipFn&&a.skipFn(...a.args),this.fnMap.set(e,Te(Te({},a),{},{fn:n,args:o,skipFn:i}))}else{let a=window.setTimeout(()=>{let c=this.fnMap.get(e);c&&c.fn(...c.args),this.fnMap.delete(e)},t);this.fnMap.set(e,{fn:n,threshold:t,timer:a,args:o,skipFn:i})}}},MN=Pf.throttleByKey.bind(Pf);function UN(n){return typeof n=="object"&&n!==null&&!(n instanceof RegExp)}function yv(n,e){if(!UN(n)||!UN(e)||Array.isArray(n)&&!Array.isArray(e)||!Array.isArray(n)&&Array.isArray(e))return e;if(Array.isArray(e)&&Array.isArray(n)){let t=[...n];for(let i=0;i<e.length;i++)t[i]=yv(n[i],e[i]);return t}{let t=Te({},n);for(let i in e)Object.prototype.hasOwnProperty.call(e,i)&&(Object.prototype.hasOwnProperty.call(n,i)?t[i]=yv(n[i],e[i]):t[i]=e[i]);return t}}function Iv(n,e){let t=[0];if(t=new Array(e).fill(0),n===0)return t;let i=0;for(;n>0&&(t[i]=255&n,n>>=8,i++,i!==e););return t}function A_(n){return typeof n=="number"?n:n.exact||n.ideal||n.max||n.min||0}function Dh(n,e){try{return typeof n=="object"&&typeof e=="object"&&JSON.stringify(n)===JSON.stringify(e)}catch{return!1}}function iT(n){return un(n).call(n,(e,t)=>e+t,0)}function Av(n){let e="0123456789abcdef";function t(b){let D,x="";for(D=0;D<=3;D++)x+=e.charAt(b>>8*D+4&15)+e.charAt(b>>8*D&15);return x}function i(b,D){let x=(65535&b)+(65535&D);return(b>>16)+(D>>16)+(x>>16)<<16|65535&x}function r(b,D,x,k,V,W){return i(function(K,J){return K<<J|K>>>32-J}(i(i(D,b),i(k,W)),V),x)}function o(b,D,x,k,V,W,K){return r(D&x|~D&k,b,D,V,W,K)}function s(b,D,x,k,V,W,K){return r(D&k|x&~k,b,D,V,W,K)}function a(b,D,x,k,V,W,K){return r(D^x^k,b,D,V,W,K)}function c(b,D,x,k,V,W,K){return r(x^(D|~k),b,D,V,W,K)}let d=function(b){let D,x=1+(b.length+8>>6),k=new Array(16*x);for(D=0;D<16*x;D++)k[D]=0;for(D=0;D<b.length;D++)k[D>>2]|=b.charCodeAt(D)<<D%4*8;return k[D>>2]|=128<<D%4*8,k[16*x-2]=8*b.length,k}(n),l,h,p,f,m,g=1732584193,S=-271733879,T=-1732584194,C=271733878;for(l=0;l<d.length;l+=16)h=g,p=S,f=T,m=C,g=o(g,S,T,C,d[l+0],7,-680876936),C=o(C,g,S,T,d[l+1],12,-389564586),T=o(T,C,g,S,d[l+2],17,606105819),S=o(S,T,C,g,d[l+3],22,-1044525330),g=o(g,S,T,C,d[l+4],7,-176418897),C=o(C,g,S,T,d[l+5],12,1200080426),T=o(T,C,g,S,d[l+6],17,-1473231341),S=o(S,T,C,g,d[l+7],22,-45705983),g=o(g,S,T,C,d[l+8],7,1770035416),C=o(C,g,S,T,d[l+9],12,-1958414417),T=o(T,C,g,S,d[l+10],17,-42063),S=o(S,T,C,g,d[l+11],22,-1990404162),g=o(g,S,T,C,d[l+12],7,1804603682),C=o(C,g,S,T,d[l+13],12,-40341101),T=o(T,C,g,S,d[l+14],17,-1502002290),S=o(S,T,C,g,d[l+15],22,1236535329),g=s(g,S,T,C,d[l+1],5,-165796510),C=s(C,g,S,T,d[l+6],9,-1069501632),T=s(T,C,g,S,d[l+11],14,643717713),S=s(S,T,C,g,d[l+0],20,-373897302),g=s(g,S,T,C,d[l+5],5,-701558691),C=s(C,g,S,T,d[l+10],9,38016083),T=s(T,C,g,S,d[l+15],14,-660478335),S=s(S,T,C,g,d[l+4],20,-405537848),g=s(g,S,T,C,d[l+9],5,568446438),C=s(C,g,S,T,d[l+14],9,-1019803690),T=s(T,C,g,S,d[l+3],14,-187363961),S=s(S,T,C,g,d[l+8],20,1163531501),g=s(g,S,T,C,d[l+13],5,-1444681467),C=s(C,g,S,T,d[l+2],9,-51403784),T=s(T,C,g,S,d[l+7],14,1735328473),S=s(S,T,C,g,d[l+12],20,-1926607734),g=a(g,S,T,C,d[l+5],4,-378558),C=a(C,g,S,T,d[l+8],11,-2022574463),T=a(T,C,g,S,d[l+11],16,1839030562),S=a(S,T,C,g,d[l+14],23,-35309556),g=a(g,S,T,C,d[l+1],4,-1530992060),C=a(C,g,S,T,d[l+4],11,1272893353),T=a(T,C,g,S,d[l+7],16,-155497632),S=a(S,T,C,g,d[l+10],23,-1094730640),g=a(g,S,T,C,d[l+13],4,681279174),C=a(C,g,S,T,d[l+0],11,-358537222),T=a(T,C,g,S,d[l+3],16,-722521979),S=a(S,T,C,g,d[l+6],23,76029189),g=a(g,S,T,C,d[l+9],4,-640364487),C=a(C,g,S,T,d[l+12],11,-421815835),T=a(T,C,g,S,d[l+15],16,530742520),S=a(S,T,C,g,d[l+2],23,-995338651),g=c(g,S,T,C,d[l+0],6,-198630844),C=c(C,g,S,T,d[l+7],10,1126891415),T=c(T,C,g,S,d[l+14],15,-1416354905),S=c(S,T,C,g,d[l+5],21,-57434055),g=c(g,S,T,C,d[l+12],6,1700485571),C=c(C,g,S,T,d[l+3],10,-1894986606),T=c(T,C,g,S,d[l+10],15,-1051523),S=c(S,T,C,g,d[l+1],21,-2054922799),g=c(g,S,T,C,d[l+8],6,1873313359),C=c(C,g,S,T,d[l+15],10,-30611744),T=c(T,C,g,S,d[l+6],15,-1560198380),S=c(S,T,C,g,d[l+13],21,1309151649),g=c(g,S,T,C,d[l+4],6,-145523070),C=c(C,g,S,T,d[l+11],10,-1120210379),T=c(T,C,g,S,d[l+2],15,718787259),S=c(S,T,C,g,d[l+9],21,-343485551),g=i(g,h),S=i(S,p),T=i(T,f),C=i(C,m);return t(g)+t(S)+t(T)+t(C)}let RU=1,vU=console,mn=class{static setLogger(n){vU=n}constructor(n,e){at(this,"id",void 0),at(this,"lockingPromise",Z.resolve()),at(this,"locks",0),at(this,"name",""),at(this,"lockId",void 0),this.lockId=RU++,n&&(this.name=n),e&&(this.id=e),this.logger("created")}logger(n,e){let t=(this.id?"[".concat(this.id,"]"):"")+"[lock-".concat(this.name,"-").concat(this.lockId,"]"),i=n==="created"?"is ".concat(n,"."):"is ".concat(n,", current queue ").concat(this.locks,". ").concat(e??"");vU.debug("".concat(t," ").concat(i))}setId(n){this.id=n}get isLocked(){return this.locks>0}lock(n){let e;this.locks+=1,this.logger("locked",n);let t=new Z(r=>{e=()=>{this.locks-=1,this.logger("unlocked",n),r()}}),i=this.lockingPromise.then(()=>e);return this.lockingPromise=this.lockingPromise.then(()=>t),i}};function jr(n,e){return function(t,i,r){let o=r.value;if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){let s=this[e];if(!s)throw new Error("mutex property key ".concat(e," doesn't exist on ").concat(n));let a=await s.lock("From ".concat(n,".").concat(i));try{for(var c=arguments.length,d=new Array(c),l=0;l<c;l++)d[l]=arguments[l];return await o.apply(this,d)}finally{a()}},r}}let mr={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function yr(n,e){let t=Math.floor(e.timeout*Math.pow(e.timeoutFactor,n));return Math.min(e.maxRetryTimeout,t)}function fa(n,e,t,i){let r=Object.assign({},mr,i),o=r.timeout,s=async()=>{await function(d){return new Z(l=>{window.setTimeout(l,d)})}(o),o*=r.timeoutFactor,o=Math.min(r.maxRetryTimeout,o)},a=!1,c=new Z(async(d,l)=>{e=e||(()=>!1),t=t||(()=>!0);for(let h=0;h<r.maxRetryCount;h+=1){if(a)return l(new O(L.OPERATION_ABORTED));try{let p=await n();if(!e(p,h)||h+1===r.maxRetryCount)return d(p);await s()}catch(p){if(!t(p,h)||h+1===r.maxRetryCount)return l(p);await s()}}});return c.cancel=()=>a=!0,c}let ma,Lf=class{constructor(n){at(this,"input",[]),at(this,"size",void 0),this.size=n}add(n){this.input.push(n),this.input.length>this.size&&this.input.splice(0,1)}mean(){var n;return this.input.length===0?0:un(n=this.input).call(n,(e,t)=>e+t)/this.input.length}},kf=0,Mf=0;function rT(n,e,t,i){return new Z((r,o)=>{e.responseType=e.responseType||"json",e.data&&!t?(e.data=JSON.stringify(e.data),kf+=xd(e.data)):t&&(e.data.size?kf+=e.data.size:e.data instanceof FormData?kf+=Vd(e.data):kf+=xd(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=n,Qi.request(e).then(s=>{typeof s.data=="string"?Mf+=xd(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?Mf+=s.data.byteLength:Mf+=xd(JSON.stringify(s.data)),r(s.data)}).catch(s=>{Qi.isCancel(s)?o(new O(L.OPERATION_ABORTED,"cancel token canceled")):s.code==="ECONNABORTED"?o(new O(L.NETWORK_TIMEOUT,s.message)):s.response?o(new O(L.NETWORK_RESPONSE_ERROR,s.response.status)):o(new O(L.NETWORK_ERROR,s.message))})})}async function xN(n,e){let t=new Blob([e.data],{type:"buffer"});return await rT(n,Te(Te({},e),{},{data:t,headers:{"Content-Type":"application/octet-stream"}}),!0)}let CU=()=>window.isSecureContext!==void 0;function nc(n){if(Array.isArray(n))return n.map(t=>t);if(!oc(n))return n;let e={};for(let t in n){let i=n[t];oc(i)||Array.isArray(i)?e[t]=nc(i):e[t]=i}return e}function oc(n){return!(typeof n!="object"||Array.isArray(n)||!n)}let wv=class{constructor(n){at(this,"input",[]),at(this,"size",void 0),this.size=n}add(n){this.input.push(n),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}},Ea={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},Rs={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],transport:{bytesSent:0,bytesReceived:0,packetsSent:0,packetsReceived:0},selectedCandidatePair:{id:"unknown",localCandidate:Ea,remoteCandidate:Ea},updateInterval:0},Uf={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0,packetsDiscarded:0,framesAssembledFromMultiplePackets:0,totalProcessingDelay:0,avgDecodeMs:0,avgFramesAssembledFromMultiplePacketsMs:0,avgProcessingDelayMs:0,avgInterFrameDelayMs:0,totalAssemblyTime:0},VN={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},FN={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},BN={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packetsDiscarded:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0,totalSamplesReceived:0,silentConcealedSamples:0,concealmentEvents:0,freezeMs80:0,freezeMs200:0,freezeSamples80:0,freezeSamples200:0},bv=class{constructor(n,e){at(this,"onFirstVideoReceived",void 0),at(this,"onFirstVideoDecoded",void 0),at(this,"onFirstAudioReceived",void 0),at(this,"onFirstVideoDecodedTimeout",void 0),at(this,"onFirstAudioDecoded",void 0),at(this,"onSelectedLocalCandidateChanged",void 0),at(this,"onSelectedRemoteCandidateChanged",void 0),at(this,"videoIsReady",!1),at(this,"videoIsReady2",{}),at(this,"pc",void 0),at(this,"options",void 0),at(this,"intervalTimer",void 0),at(this,"stats",nc(Rs)),at(this,"isFirstVideoReceived",{}),at(this,"isFirstVideoDecoded",{}),at(this,"isFirstAudioReceived",{}),at(this,"isFirstAudioDecoded",{}),at(this,"isFirstVideoDecodedTimeout",{}),at(this,"lossRateWindowStats",[]),this.pc=n,this.options=e,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new Z(n=>{n({local:Te({},Ea),remote:Te({},Ea)})})}setVideoIsReady(n){this.videoIsReady=n}setVideoIsReady2(n,e){this.videoIsReady2[n]=e}getVideoIsReady(n){return this.videoIsReady2[n]||!1}setIsFirstAudioDecoded(n){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(n){this.lossRateWindowStats.push(n),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);let e=this.lossRateWindowStats.length,t=["videoSend","audioSend","videoRecv","audioRecv"],i=0,r=0,o=0,s=0;for(let a of t)n[a].forEach((c,d)=>{if(!this.lossRateWindowStats[e-1][a][d]||!this.lossRateWindowStats[0][a][d])return;let l=this.lossRateWindowStats[e-1][a][d].packets-this.lossRateWindowStats[0][a][d].packets,h=this.lossRateWindowStats[e-1][a][d].packetsLost-this.lossRateWindowStats[0][a][d].packetsLost;a==="videoSend"||a==="audioSend"?(i+=l,o+=h):(r+=l,s+=h),Number.isNaN(l)||Number.isNaN(l)?c.packetLostRate=0:c.packetLostRate=l<=0||h<=0?0:h/(l+h)});n.sendPacketLossRate=i<=0||o<=0?0:o/(i+o),n.recvPacketLossRate=r<=0||s<=0?0:s/(r+s)}},jN=class extends bv{constructor(){super(...arguments),at(this,"_stats",Rs),at(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){let n=await this._getStats(),e=this.statsResponsesToObjects(n);this._stats=nc(Rs);let t=e.filter(r=>r.type==="ssrc");this.processSSRCStats(t);let i=e.find(r=>r.type==="VideoBwe");i&&this.processBandwidthStats(i),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(n){this._stats.bitrate={actualEncoded:Number(n.googActualEncBitrate),targetEncoded:Number(n.googTargetEncBitrate),retransmit:Number(n.googRetransmitBitrate),transmit:Number(n.googTransmitBitrate)},this._stats.sendBandwidth=Number(n.googAvailableSendBandwidth)}processSSRCStats(n){n.forEach(e=>{var t;let i=z(t=e.id).call(t,"send");switch("".concat(e.mediaType,"_").concat(i?"send":"recv")){case"video_send":{let r=nc(VN);r.codec=e.googCodecName,r.adaptionChangeReason="none",e.googCpuLimitedResolution&&(r.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(r.adaptionChangeReason="bandwidth"),r.avgEncodeMs=Number(e.googAvgEncodeMs),r.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},r.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},r.firsCount=Number(e.googFirReceived),r.nacksCount=Number(e.googNacksReceived),r.plisCount=Number(e.googPlisReceived),r.frameCount=Number(e.framesEncoded),r.bytes=Number(e.bytesSent),r.packets=Number(e.packetsSent),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(r),this._stats.rtt=r.rttMs;break}case"video_recv":{let r=nc(Uf),o=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(r.codec=e.googCodecName,r.targetDelayMs=Number(e.googTargetDelayMs),r.renderDelayMs=Number(e.googRenderDelayMs),r.currentDelayMs=Number(e.googCurrentDelayMs),r.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),r.decodeMs=Number(e.googDecodeMs),r.maxDecodeMs=Number(e.googMaxDecodeMs),r.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},r.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},r.decodeFrameRate=Number(e.googFrameRateDecoded),r.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},r.jitterBufferMs=Number(e.googJitterBufferMs),r.firsCount=Number(e.googFirsSent),r.nacksCount=Number(e.googNacksSent),r.plisCount=Number(e.googPlisSent),r.framesDecodeCount=Number(e.framesDecoded),r.bytes=Number(e.bytesReceived),r.packets=Number(e.packetsReceived),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.packets>0&&!this.isFirstVideoReceived[r.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(r.ssrc),this.isFirstVideoReceived[r.ssrc]=!0),r.framesDecodeCount>0&&!this.isFirstVideoDecoded[r.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(r.ssrc,r.decodedFrame.width,r.decodedFrame.height),this.isFirstVideoDecoded[r.ssrc]=!0),o){let s=o.stats,a=Date.now()-o.lts;r.framesDecodeFreezeTime=s.framesDecodeFreezeTime,r.framesDecodeInterval=s.framesDecodeInterval,r.framesDecodeCount>s.framesDecodeCount&&this.isFirstVideoDecoded[r.ssrc]?(o.lts=Date.now(),r.framesDecodeInterval=a,r.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?r.framesDecodeFreezeTime+=r.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):r.framesDecodeCount<o.stats.framesDecodeCount&&(r.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(r.ssrc,{stats:Te({},r),lts:Date.now()}),this._stats.videoRecv.push(r);break}case"audio_recv":{let r=nc(BN);r.codec=e.googCodecName,r.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,r.decodingCNG=Number(e.googDecodingCNG),r.decodingCTN=Number(e.googDecodingCTN),r.decodingCTSG=Number(e.googDecodingCTSG),r.decodingNormal=Number(e.googDecodingNormal),r.decodingPLC=Number(e.googDecodingPLC),r.decodingPLCCNG=Number(e.googDecodingPLCCNG),r.expandRate=Number(e.googExpandRate),r.accelerateRate=Number(e.googAccelerateRate),r.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),r.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),r.speechExpandRate=Number(e.googSpeechExpandRate),r.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),r.jitterBufferMs=Number(e.googJitterBufferMs),r.jitterMs=Number(e.googJitterReceived),r.bytes=Number(e.bytesReceived),r.packets=Number(e.packetsReceived),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),r.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),r.receivedFrames>0&&!this.isFirstAudioReceived[r.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(r.ssrc),this.isFirstAudioReceived[r.ssrc]=!0),r.decodingNormal>0&&!this.isFirstAudioDecoded[r.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(r.ssrc),this.isFirstAudioDecoded[r.ssrc]=!0),this._stats.audioRecv.push(r);break}case"audio_send":{let r=nc(FN);r.codec=e.googCodecName,r.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,r.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),r.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),r.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),r.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),r.bytes=Number(e.bytesSent),r.packets=Number(e.packetsSent),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.rttMs=Number(e.googRtt||0),this._stats.rtt=r.rttMs,this._stats.audioSend.push(r);break}}})}_getStats(){return new Z((n,e)=>{this.pc.getStats(n,e)})}statsResponsesToObjects(n){let e=[];return n.result().forEach(t=>{let i={id:t.id,timestamp:t.timestamp.valueOf().toString(),type:t.type};t.names().forEach(r=>{i[r]=t.stat(r)}),e.push(i)}),e}},xf=function(n){return n.BANDWIDTH="bandwidth",n.CPU="cpu",n.NONE="none",n.OTHER="other",n}({}),Ou=function(n){return n.L1T1="L1T1",n.L1T2="L1T2",n.L1T3="L1T3",n.L1T3_KEY="L1T3_KEY",n.L2T1_KEY="L2T1_KEY",n.L2T2_KEY="L2T2_KEY",n.L2T3_KEY="L2T3_KEY",n.L3T1_KEY="L3T1_KEY",n.L3T2_KEY="L3T2_KEY",n.L3T3_KEY="L3T3_KEY",n}({}),Vf=function(n){return n[n.new=0]="new",n[n.connecting=1]="connecting",n[n.connected=2]="connected",n[n.disconnected=3]="disconnected",n[n.failed=4]="failed",n[n.closed=5]="closed",n}({}),vs=function(n){return n.CERTIFICATE="certificate",n.CODEC="codec",n.CANDIDATE_PAIR="candidate-pair",n.LOCAL_CANDIDATE="local-candidate",n.REMOTE_CANDIDATE="remote-candidate",n.INBOUND="inbound-rtp",n.TRACK="track",n.OUTBOUND="outbound-rtp",n.PC="peer-connection",n.REMOTE_INBOUND="remote-inbound-rtp",n.REMOTE_OUTBOUND="remote-outbound-rtp",n.TRANSPORT="transport",n.CSRC="csrc",n.DATA_CHANNEL="data-channel",n.STREAM="stream",n.SENDER="sender",n.RECEIVER="receiver",n}({});var bo=function(n){return n[n.kNone=1]="kNone",n[n.kMillisecondsFromSeconds=1e3]="kMillisecondsFromSeconds",n[n.kBytesToBits=8]="kBytesToBits",n}(bo||{});function vl(n,e,t,i){let r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:bo.kNone;if(!e)return;let o=Number(e[t]);if(typeof o!="number")return;let s=Number(e[i]);if(typeof s!="number")return;if(!n)return s?o/s*r:void 0;let a=Number(n[t]);if(typeof a!="number")return;let c=Number(n[i]);if(typeof c!="number")return;let d=s-c;return d?(o-a)/d*r:void 0}let Ff=class extends bv{constructor(){super(...arguments),at(this,"_stats",Rs),at(this,"report",void 0),at(this,"lastDecodeVideoReceiverStats",new Map),at(this,"lastVideoFramesRecv",new Map),at(this,"lastVideoFramesSent",new Map),at(this,"lastVideoFramesDecode",new Map),at(this,"lastVideoFramesOutput",new Map),at(this,"lastVideoJBDelay",new Map),at(this,"lastAudioJBDelay",new Map),at(this,"mediaBytesSent",new Map),at(this,"mediaBytesRetransmit",new Map),at(this,"mediaBytesTargetEncode",new Map),at(this,"lastDecodeAudioReceiverStats",new Map),at(this,"lastAudioConcealment",new Map),at(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=nc(Rs),this.report.forEach(n=>{switch(n.type){case vs.OUTBOUND:case vs.INBOUND:{let e=n.mediaType||n.kind,t=!e&&"frameWidth"in n,i=!e&&!("frameWidth"in n);n.type===vs.OUTBOUND?e==="audio"||i?this.processAudioOutboundStats(n):(e==="video"||t)&&this.processVideoOutboundStats(n):n.type===vs.INBOUND&&(e==="audio"||i?this.processAudioInboundStats(n):(e==="video"||t)&&this.processVideoInboundStats(n));break}case vs.TRANSPORT:{this.processTransportStats(n);let e=this.report.get(n.selectedCandidatePairId);e&&this.processCandidatePairStats(e);break}case vs.CANDIDATE_PAIR:n.selected&&this.processCandidatePairStats(n)}}),this.updateSendBitrate(),this._stats.updateInterval=Date.now()-this.stats.timestamp,this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){let n=await this.pc.getStats(),e={local:Te({},Ea),remote:Te({},Ea)};return n.forEach(t=>{let i;if(t.type===vs.TRANSPORT&&(i=n.get(t.selectedCandidatePairId)),t.type===vs.CANDIDATE_PAIR&&t.selected&&(i=t),i){let r=(o,s)=>{o.type=s.type,o.id=s.id,s.address&&(o.address=s.address),s.candidateType&&(o.candidateType=s.candidateType),s.port&&(o.port=s.port),s.priority&&(o.priority=s.priority),s.protocol&&(o.protocol=s.protocol),s.relayProtocol&&(o.relayProtocol=s.relayProtocol)};if(i.localCandidateId){let o=n.get(i.localCandidateId);o&&r(e.local,o)}if(i.remoteCandidateId){let o=n.get(i.remoteCandidateId);o&&r(e.remote,o)}}}),e}processCandidatePairStats(n){if(this._stats.sendBandwidth=n.availableOutgoingBitrate||0,n.currentRoundTripTime&&(this._stats.rtt=1e3*n.currentRoundTripTime),this._stats.videoSend.forEach(e=>{n.currentRoundTripTime&&(e.rttMs=1e3*n.currentRoundTripTime)}),this._stats.audioSend.forEach(e=>{n.currentRoundTripTime&&(e.rttMs=1e3*n.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=n.id,n.localCandidateId){let e=this.report.get(n.localCandidateId);e&&this.processCandidateStats(e)}if(n.remoteCandidateId){let e=this.report.get(n.remoteCandidateId);e&&this.processCandidateStats(e)}}processCandidateStats(n){let e;n.type===vs.LOCAL_CANDIDATE&&(e=this._stats.selectedCandidatePair.localCandidate),n.type===vs.REMOTE_CANDIDATE&&(e=this._stats.selectedCandidatePair.remoteCandidate),e&&(e.type=n.type,e.id=n.id,n.address&&(e.address=n.address),n.candidateType&&(e.candidateType=n.candidateType),n.port&&(e.port=n.port),n.priority&&(e.priority=n.priority),n.protocol&&(e.protocol=n.protocol),n.relayProtocol&&(e.relayProtocol=n.relayProtocol),n.type===vs.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==e.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(Te({},e),Te({},this.stats.selectedCandidatePair.localCandidate)),n.type===vs.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==e.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(Te({},e),Te({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(n){let e=this._stats.audioRecv.find(i=>i.ssrc===n.ssrc);e||(e=nc(BN),this._stats.audioRecv.push(e)),e.ssrc=n.ssrc,e.packets=n.packetsReceived,e.packetsLost=n.packetsLost,e.packetsDiscarded=n.packetsDiscarded,e.bytes=n.bytesReceived,e.jitterMs=1e3*n.jitter,e.retransmittedBytesReceived=n.retransmittedBytesReceived,e.retransmittedPacketsReceived=n.retransmittedPacketsReceived,e.totalProcessingDelay=n.totalProcessingDelay,e.jitterBufferEmittedCount=n.jitterBufferEmittedCount,e.estimatedPlayoutTimestamp=n.estimatedPlayoutTimestamp;let t=this.lastDecodeAudioReceiverStats.get(e.ssrc);e.avgProcessingDelayMs=vl(t,e,"totalProcessingDelay","jitterBufferEmittedCount",bo.kMillisecondsFromSeconds),this.processAudioTrackReceiverStats(n,n.trackId,e),this.calculateAudioFreeze(e,t,n),n.codecId&&(e.codec=this.getCodecFromCodecStats(n.codecId)),e.receivedFrames||(e.receivedFrames=n.packetsReceived),e.droppedFrames||(e.droppedFrames=n.packetsLost),e.receivedFrames>0&&!this.isFirstAudioReceived[e.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(e.ssrc),this.isFirstAudioReceived[e.ssrc]=!0),e.outputLevel&&e.outputLevel>0&&!this.isFirstAudioDecoded[e.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(e.ssrc),this.isFirstAudioDecoded[e.ssrc]=!0),typeof n.concealedSamples=="number"&&(e.concealedSamples=n.concealedSamples),this.lastDecodeAudioReceiverStats.set(e.ssrc,Te({},e))}calculateAudioFreeze(n,e,t){let i=this.lastAudioConcealment.get(n.ssrc);if(e!=null&&i!=null){let r=i.lts,o=t.timestamp,s=o-r;if(s<=0)return;let a=n.concealedSamples-e.concealedSamples-0,c=i.nonSilent+a,d=n.totalSamplesReceived-e.totalSamplesReceived;if(d<=0)return;let l=80*d/s,h=200*d/s,p=s/d,f=0;n.freezeSamples80=e.freezeSamples80,n.freezeMs80=e.freezeMs80,c>l&&(i.plc80>0?(n.freezeSamples80+=a,n.freezeMs80+=Math.round(a*p)):(n.freezeSamples80+=c,n.freezeMs80+=Math.round(c*p)),f=i.plc80+1);let m=0;n.freezeSamples200=e.freezeSamples200,n.freezeMs200=e.freezeMs200,c>h&&(i.plc200>0?(n.freezeSamples200+=a,n.freezeMs200+=Math.round(a*p)):(n.freezeSamples200+=c,n.freezeMs200+=Math.round(c*p)),m=i.plc200+1),this.lastAudioConcealment.set(n.ssrc,{nonSilent:a,lts:o,plc80:f,plc200:m})}else n.freezeSamples80=0,n.freezeSamples200=0,n.freezeMs80=0,n.freezeMs200=0,this.lastAudioConcealment.set(n.ssrc,{nonSilent:0,lts:t.timestamp,plc80:0,plc200:0})}processVideoInboundStats(n){let e=this._stats.videoRecv.find(s=>s.ssrc===n.ssrc);e||(e=nc(Uf),this._stats.videoRecv.push(e)),e.ssrc=n.ssrc,e.packets=n.packetsReceived,e.packetsLost=n.packetsLost,e.bytes=n.bytesReceived,e.firsCount=n.firCount,e.nacksCount=n.nackCount,e.plisCount=n.pliCount,e.framesDecodeCount=n.framesDecoded,e.framesDroppedCount=n.framesDropped,e.totalInterFrameDelay=n.totalInterFrameDelay,e.totalSquaredInterFrameDelay=n.totalSquaredInterFrameDelay,e.totalFreezesDuration=n.totalFreezesDuration,e.totalProcessingDelay=n.totalProcessingDelay,e.packetsDiscarded=n.packetsDiscarded,e.framesAssembledFromMultiplePackets=n.framesAssembledFromMultiplePackets,e.totalAssemblyTime=n.totalAssemblyTime,e.keyFramesDecoded=n.keyFramesDecoded,e.retransmittedBytesReceived=n.retransmittedBytesReceived,e.retransmittedPacketsReceived=n.retransmittedPacketsReceived,e.estimatedPlayoutTimestamp=n.estimatedPlayoutTimestamp;let t=this.lastDecodeVideoReceiverStats.get(e.ssrc),i=this.lastVideoFramesDecode.get(e.ssrc),r=this.lastVideoFramesOutput.get(e.ssrc),o=Date.now();if(e.framesDecodeCount>0&&!this.isFirstVideoDecoded[e.ssrc]){let s=e.decodedFrame?e.decodedFrame.width:0,a=e.decodedFrame?e.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(e.ssrc,s,a),this.isFirstVideoDecoded[e.ssrc]=!0}if(t){let s=t.stats,a=o-t.lts;e.framesDecodeFreezeTime=s.framesDecodeFreezeTime,e.framesDecodeInterval=s.framesDecodeInterval,!this.isFirstVideoDecoded[e.ssrc]&&a>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[e.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(e.ssrc),this.isFirstVideoDecodedTimeout[e.ssrc]=!0),e.framesDecodeCount>s.framesDecodeCount&&this.isFirstVideoDecoded[e.ssrc]?(t.lts=Date.now(),e.framesDecodeInterval=a,e.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(n.ssrc))?e.framesDecodeFreezeTime+=e.framesDecodeInterval:this.setVideoIsReady2(parseInt(n.ssrc,10),!0))):e.framesDecodeCount<s.framesDecodeCount&&(e.framesDecodeInterval=0),n.framesDecoded&&n.qpSum&&(t.stats.framesDecodeCount>n.framesDecoded?e.qpSumPerFrame=n.qpSum/n.framesDecoded:e.qpSumPerFrame=(n.qpSum-t.qpSum)/(n.framesDecoded-t.stats.framesDecodeCount))}n.totalDecodeTime&&(e.decodeMs=1e3*n.totalDecodeTime,e.avgDecodeMs=vl(t==null?void 0:t.stats,e,"decodeMs","framesDecodeCount")),e.avgProcessingDelayMs=vl(t==null?void 0:t.stats,e,"totalProcessingDelay","framesDecodeCount",bo.kMillisecondsFromSeconds),e.avgFramesAssembledFromMultiplePacketsMs=vl(t==null?void 0:t.stats,e,"totalAssemblyTime","framesAssembledFromMultiplePackets",bo.kMillisecondsFromSeconds),e.avgInterFrameDelayMs=vl(t==null?void 0:t.stats,e,"totalInterFrameDelay","framesDecodeCount",bo.kMillisecondsFromSeconds),i&&o-i.lts>=800?(e.decodeFrameRate=Math.round((e.framesDecodeCount-i.count)/((o-i.lts)/1e3)),this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:o,rate:e.decodeFrameRate})):i?e.decodeFrameRate=i.rate:this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:o,rate:0}),e.framesDroppedCount&&n.framesReceived&&(r&&o-r.lts>=800?(e.outputFrameRate=Math.round((n.framesReceived-e.framesDroppedCount-r.count)/((o-r.lts)/1e3)),this.lastVideoFramesOutput.set(e.ssrc,{count:n.framesReceived-e.framesDroppedCount,lts:o,rate:Math.max(e.outputFrameRate,0)})):r?e.outputFrameRate=r.rate:this.lastVideoFramesOutput.set(e.ssrc,{count:n.framesReceived-e.framesDroppedCount,lts:o,rate:0})),this.processVideoTrackReceiverStats(n,n.trackId,e),n.codecId&&(e.codec=this.getCodecFromCodecStats(n.codecId)),n.framerateMean&&(e.framesRateFirefox=n.framerateMean),e.packets>0&&!this.isFirstVideoReceived[e.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(e.ssrc),this.isFirstVideoReceived[e.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(e.ssrc,{stats:Te({},e),lts:t?t.lts:Date.now(),qpSum:n.qpSum})}processVideoOutboundStats(n){let e=this._stats.videoSend.find(i=>i.ssrc===n.ssrc);e||(e=nc(VN),this._stats.videoSend.push(e));let t=this.mediaBytesSent.get(n.ssrc);if(t)t.add(n.bytesSent);else{let i=new wv(10);i.add(n.bytesSent),this.mediaBytesSent.set(n.ssrc,i)}if(n.retransmittedBytesSent!==void 0){let i=this.mediaBytesRetransmit.get(n.ssrc);if(i)i.add(n.retransmittedBytesSent);else{let r=new wv(10);r.add(n.retransmittedBytesSent),this.mediaBytesRetransmit.set(n.ssrc,r)}}if(n.totalEncodedBytesTarget){let i=this.mediaBytesTargetEncode.get(n.ssrc);if(i)i.add(n.totalEncodedBytesTarget);else{let r=new wv(10);r.add(n.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(n.ssrc,r)}}if(e.ssrc=n.ssrc,e.bytes=n.bytesSent,e.packets=n.packetsSent,e.firsCount=n.firCount,e.nacksCount=n.nackCount,e.plisCount=n.pliCount,e.frameCount=n.framesEncoded,e.adaptionChangeReason=n.qualityLimitationReason,e.scalabilityMode=n.scalabilityMode,e.retransmittedBytesSent=n.retransmittedBytesSent,e.retransmittedPacketsSent=n.retransmittedPacketsSent,e.hugeFramesSent=n.hugeFramesSent,e.keyFramesEncoded=n.keyFramesEncoded,e.targetBitrate=n.targetBitrate,n.totalEncodeTime&&n.framesEncoded){let i=this.lastEncoderMs.get(n.ssrc);if(!i||i.lastFrameCount>n.framesEncoded)e.avgEncodeMs=1e3*n.totalEncodeTime/n.framesEncoded;else{let r=n.framesEncoded-i.lastFrameCount,o=n.totalEncodeTime-i.lastEncoderTime;e.avgEncodeMs=1e3*o/r}}if(n.framesEncoded&&n.qpSum){let i=this.lastEncoderMs.get(n.ssrc);!i||i.lastFrameCount>n.framesEncoded?e.qpSumPerFrame=n.qpSum/n.framesEncoded:e.qpSumPerFrame=(n.qpSum-i.lastQpSum)/(n.framesEncoded-i.lastFrameCount)}if(this.lastEncoderMs.set(n.ssrc,{lastFrameCount:n.framesEncoded,lastEncoderTime:n.totalEncodeTime,lastQpSum:n.qpSum,lts:Date.now()}),n.codecId&&(e.codec=this.getCodecFromCodecStats(n.codecId)),n.mediaSourceId&&this.processVideoMediaSource(n.mediaSourceId,e),this.processVideoTrackSenderStats(n,n.trackId,e),n.remoteId)this.processRemoteInboundStats(n.remoteId,e);else{let i=this.findRemoteStatsId(n.ssrc,vs.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,e)}}processAudioOutboundStats(n){let e=this._stats.audioSend.find(t=>t.ssrc===n.ssrc);if(e||(e=nc(FN),this._stats.audioSend.push(e)),e.ssrc=n.ssrc,e.packets=n.packetsSent,e.bytes=n.bytesSent,e.retransmittedBytesSent=n.retransmittedBytesSent,e.retransmittedPacketsSent=n.retransmittedPacketsSent,n.mediaSourceId&&this.processAudioMediaSource(n.mediaSourceId,e),n.codecId&&(e.codec=this.getCodecFromCodecStats(n.codecId)),this.processAudioTrackSenderStats(n,n.trackId,e),n.remoteId)this.processRemoteInboundStats(n.remoteId,e);else{let t=this.findRemoteStatsId(n.ssrc,vs.REMOTE_INBOUND);t&&this.processRemoteInboundStats(t,e)}}processTransportStats(n){this._stats.transport.bytesReceived=n.bytesReceived||this._stats.transport.bytesReceived,this._stats.transport.bytesSent=n.bytesSent||this._stats.transport.bytesSent,this._stats.transport.packetsReceived=n.packetsReceived||this._stats.transport.packetsReceived,this._stats.transport.packetsSent=n.packetsSent||this._stats.transport.packetsSent}findRemoteStatsId(n,e){var t;let i=Array.from(Vr(t=this.report).call(t)).find(r=>r.type===e&&r.ssrc===n);return i?i.id:null}processVideoMediaSource(n,e){let t=this.report.get(n);t&&t.width&&t.height&&t.framesPerSecond&&(e.inputFrame={width:t.width,height:t.height,frameRate:t.framesPerSecond})}processAudioMediaSource(n,e){let t=this.report.get(n);t&&(e.inputLevel=t.audioLevel)}processVideoTrackSenderStats(n,e,t){var i,r,o,s;let a=e?this.report.get(e):void 0,c=(i=a==null?void 0:a.framesSent)!==null&&i!==void 0?i:n.framesSent;if(typeof c!="number")return;let d=(r=a==null?void 0:a.frameWidth)!==null&&r!==void 0?r:n.frameWidth,l=(o=a==null?void 0:a.frameHeight)!==null&&o!==void 0?o:n.frameHeight,h=(s=a==null?void 0:a.framesPerSecond)!==null&&s!==void 0?s:n.framesPerSecond;if(typeof d=="number"&&typeof l=="number"||(d=0,l=0),h==null){let p=Date.now(),f=this.lastVideoFramesSent.get(t.ssrc);f&&p-f.lts>=800?(h=Math.round((c-f.count)/((p-f.lts)/1e3)),this.lastVideoFramesSent.set(t.ssrc,{count:c,lts:p,rate:h})):f?h=f.rate:this.lastVideoFramesSent.set(t.ssrc,{count:c,lts:p,rate:0})}t.sentFrame={width:d,height:l,frameRate:Math.max(0,h)}}processVideoTrackReceiverStats(n,e,t){var i,r,o,s,a;let c=e?this.report.get(e):void 0,d=(i=c==null?void 0:c.framesReceived)!==null&&i!==void 0?i:n.framesReceived,l=(r=c==null?void 0:c.frameWidth)!==null&&r!==void 0?r:n.frameWidth,h=(o=c==null?void 0:c.frameHeight)!==null&&o!==void 0?o:n.frameHeight,p=(s=c==null?void 0:c.jitterBufferDelay)!==null&&s!==void 0?s:n.jitterBufferDelay,f=(a=c==null?void 0:c.jitterBufferEmittedCount)!==null&&a!==void 0?a:n.jitterBufferEmittedCount;if(typeof d=="number"){let m=this.lastVideoFramesRecv.get(t.ssrc),g=Date.now();t.framesReceivedCount=d;let S=0;m&&g-m.lts>=800?(S=Math.round((d-m.count)/((g-m.lts)/1e3)),this.lastVideoFramesRecv.set(t.ssrc,{count:d,lts:g,rate:S})):m?S=m.rate:this.lastVideoFramesRecv.set(t.ssrc,{count:d,lts:g,rate:0}),t.receivedFrame={width:l||0,height:h||0,frameRate:S||0},t.decodedFrame={width:l||0,height:h||0,frameRate:t.decodeFrameRate||0},t.outputFrame={width:l||0,height:h||0,frameRate:t.outputFrameRate||t.decodeFrameRate||0}}if(p&&f){let m=this.lastVideoJBDelay.get(t.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0},g=m.jitterBufferMs,S=f-m.jitterBufferEmittedCount;S>0&&(g=1e3*(p-m.jitterBufferDelay)/S),t.jitterBufferMs=g,t.currentDelayMs=Math.round(g),this.lastVideoJBDelay.set(t.ssrc,{jitterBufferDelay:p,jitterBufferEmittedCount:f,jitterBufferMs:t.currentDelayMs})}}processAudioTrackSenderStats(n,e,t){var i,r,o,s;let a=e?this.report.get(e):void 0,c=(i=(r=a==null?void 0:a.echoReturnLoss)!==null&&r!==void 0?r:n.echoReturnLoss)!==null&&i!==void 0?i:0,d=(o=(s=a==null?void 0:a.echoReturnLossEnhancement)!==null&&s!==void 0?s:n.echoReturnLossEnhancement)!==null&&o!==void 0?o:0;t.aecReturnLoss=c,t.aecReturnLossEnhancement=d}processAudioTrackReceiverStats(n,e,t){var i,r,o,s,a,c,d,l,h;let p=e?this.report.get(e):void 0,f=(i=p==null?void 0:p.removedSamplesForAcceleration)!==null&&i!==void 0?i:n.removedSamplesForAcceleration,m=(r=p==null?void 0:p.totalSamplesReceived)!==null&&r!==void 0?r:n.totalSamplesReceived,g=(o=p==null?void 0:p.jitterBufferDelay)!==null&&o!==void 0?o:n.jitterBufferDelay,S=(s=p==null?void 0:p.jitterBufferEmittedCount)!==null&&s!==void 0?s:n.jitterBufferEmittedCount,T=(a=p==null?void 0:p.audioLevel)!==null&&a!==void 0?a:n==null?void 0:n.audioLevel,C=(c=p==null?void 0:p.totalSamplesDuration)!==null&&c!==void 0?c:n==null?void 0:n.totalSamplesDuration,b=(d=p==null?void 0:p.concealedSamples)!==null&&d!==void 0?d:n.concealedSamples,D=(l=p==null?void 0:p.silentConcealedSamples)!==null&&l!==void 0?l:n.silentConcealedSamples,x=(h=p==null?void 0:p.concealmentEvents)!==null&&h!==void 0?h:n.concealmentEvents;if(typeof m=="number"&&(t.totalSamplesReceived=m),typeof D=="number"&&(t.silentConcealedSamples=D),typeof x=="number"&&(t.concealmentEvents=x),typeof b=="number"&&(t.concealedSamples=b),f&&m&&(t.accelerateRate=f/m),g&&S){let V=this.lastAudioJBDelay.get(t.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0},W=V.jitterBufferMs,K=S-V.jitterBufferEmittedCount;K>0&&(W=1e3*(g-V.jitterBufferDelay)/K),t.jitterBufferMs=Math.round(W),this.lastAudioJBDelay.set(t.ssrc,{jitterBufferDelay:g,jitterBufferEmittedCount:S,jitterBufferMs:t.jitterBufferMs})}t.outputLevel=T;let k=1920;C&&m&&(k=m/C/50,t.receivedFrames=Math.round(m/k)),b&&(t.droppedFrames=Math.round(b/k))}processRemoteInboundStats(n,e){let t=this.report.get(n);t&&(e.packetsLost=t.packetsLost,t.roundTripTime&&(e.rttMs=1e3*t.roundTripTime),t.jitter&&(e.jitterMs=1e3*t.jitter),t.timestamp&&(e.timestamp=t.timestamp))}getCodecFromCodecStats(n){let e=this.report.get(n);if(!e)return"";let t=e.mimeType.match(/\/(.*)$/);return t&&t[1]?t[1]:""}updateSendBitrate(){let n=0,e=null,t=null;this.mediaBytesSent.forEach(r=>{n+=r.diffMean()}),this.mediaBytesRetransmit.forEach(r=>{e=e===null?r.diffMean():e+r.diffMean()}),this.mediaBytesTargetEncode.forEach(r=>{t=t===null?r.diffMean():t+r.diffMean()});let i=e!==null?n-e:n;this._stats.bitrate={actualEncoded:8*i/(this.options.updateInterval/1e3),transmit:8*n/(this.options.updateInterval/1e3)},e!==null&&(this._stats.bitrate.retransmit=8*e/(this.options.updateInterval/1e3)),t!==null&&(this._stats.bitrate.targetEncoded=8*t/(this.options.updateInterval/1e3))}},yU=class extends bv{updateStats(){return Z.resolve()}};function Ov(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4,o=function(){let s=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return s&&s[0]?Number(s[0].split("/")[1]):null}();return o?o<76?new jN(n,{updateInterval:e,lossRateInterval:t,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new Ff(n,{updateInterval:e,lossRateInterval:t,freezeRateLimit:i,firstVideoDecodedTimeout:r}):function(s){if(!window.RTCStatsReport)return!1;let a=s.getStats();return!!(a instanceof Z||function(c){return!!c&&(typeof c=="object"||typeof c=="function")&&typeof c.then=="function"}(a))}(n)?new Ff(n,{updateInterval:e,lossRateInterval:t,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new yU(n,{updateInterval:e,lossRateInterval:t,freezeRateLimit:i,firstVideoDecodedTimeout:r})}let nT="websdk_ng_install_id";function Nv(){try{if(F("INSTALL_ID"))return F("INSTALL_ID");let n=window.localStorage.getItem(nT);return n||(n=li(),window.localStorage.setItem(nT,n)),$e("INSTALL_ID",n),n}catch{return}}let Js=function(n){if(n.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return n;let e=n.match(/([0-9]+\.[0-9]+\.[0-9]+)\-([0-9]+)/);if(e&&e[1]&&e[2]){let t=e[1],i=e[2];return"".concat(t,".").concat(i)}return"4.0.0.999"}("4.24.2"),Qs=function(){try{return JSON.parse("true")===!0}catch{return!0}}(),Nu=function(n){return n.Default="default",n.Auto="auto",n.Relay="relay",n.SdRtn="sd-rtn",n}({}),Yr=function(){let n="us".concat("erna","me"),e="pa".concat("sswo","rd"),t=["t","s","t"];t.splice(1,0,"e");let i=t.join(""),r=[];for(let a=0;a<6;a++)r.push("1");let o=r.join(""),s={};return s[n]=i,s[e]=o,Object.assign(s,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=Yr;let En={ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,ENABLE_USER_LICENSE_CHECK:!0,DISABLE_FEC:void 0,ENABLE_NTP_REPORT:!1,ENABLE_INSTANT_VIDEO:!1,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:!0,FORCE_ENABLE_AUT_CC:!1,ENABLE_CC_FALLBACK:void 0,SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,ENABLE_SVC_DEFAULT_CODECS:["H264","VP8","VP9","AV1"],SVC:[],ENABLE_FULL_LINK_AV_SYNC:!1,SVC_MODE:null,PRE_SUB_NUM:1,ENABLE_AUT_FEEDBACK:!0,SVC_EXTENDED:["VP9"]},Bf={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},oT="v4.24.2-0-g002485b1-dirty(12/12/2025, 5:26:54 PM)",sT={ENABLE_EVENT_REPORT:!0,UPLOAD_LOG:!1,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,ENABLE_PRELOAD:!0,NEW_ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,RESTART_SEQUENCE:["udp_tcp_relay","relay"],FIRST_TCP_CANDIDATE:!1,FIRST_TCP_CANDIDATE_INTERVAL:1e3,TURN_DOMAIN:"edge.agora.io",TURN_DOMAINS:["edge.agora.io"],USE_TURN_IP:!0,NEW_TURN_MODE:4,NEW_FORCE_TURN:!1,USE_NEW_RENDER_FREEZE_TIME:!1,FLS_FALLBACK_TIMEOUT:3e4,RTE_DETAIL_REPORT_INTERVAL:6e4,ENCODE_EXCEPTION_TIMES:5,ENABLE_ENCODE_EXCEPTION:!0,ENCODE_EXCEPTION_VALIDATE_CODEC:["h264"],VIDEO_ENCODER_CONFIG_LIST:[{width:240,height:180},{width:320,height:240},{width:400,height:300},{width:480,height:360},{width:560,height:420},{width:640,height:480}],DELETE_NEQ_AFTER_USER_LEAVE:!0,UPDATE_RTP_CAP_IN_HOST:!1,IOS_BG_TAG:!0,IOS_AUTO_RESTART_BG_TAG:!0,IGNORE_UID_CHECK:!1,ENABLE_UP_SPS_PPS:!1,ENABLE_DOWN_SPS_PPS:!1,NO_EDGES_RETRY:!0,BUFFER_READY_FRAMES:3,FLS_SYNC_AV_PLAY_LIMIT:0,FLS_BUFFER_WAIT_TIME:1500,VOS_CONFIGURE:void 0,ENABLE_QUALITY_FALLBACK:!1,QUALITY_FALLBACK_REHEARSAL:!0,ENABLE_FLS_AV1_FIRST:!1,ENABLE_AP_MULTI_IP:!0,FLS_ENABLE_AV1_DETECT:!0,FLS_ENABLE_AV1_DECODE_DETECT:!0},Si=Te(Te(Te(Te({},sT),{},{PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,NOT_REPORT_EVENT:[],PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,SHOW_REPORT_USER_INVOKER_LOG:!0,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,FIRST_H264_PROFILE_LEVEL_ID:"42001f",FIRST_PACKETIZATION_MODE:"",X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_MANAGER_WSS:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,FINGERPRINT:null,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,ENABLE_AUDIO_TOPN:!1,ENABLE_AUDIO_METADATA:!1,ENABLE_AUDIO_PTS:!1,TOPN_SMOOTH_LEVEL:void 0,TOPN_NEW_SPEAKER_DELAY:void 0,TOPN_SWITCH_HOLD_MS:void 0,TOPN_AUDIO_GAIN:void 0,TOPN_SILENCE_THRESHOLD:250,AP_AREA:!0,ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_WSS:"",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,DATASTREAM_MAX_RETRANSMITS:10,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ENABLE_AUDIO_RED:!1,OPUS_PTIME:void 0,AUDIO_DUPLICATE_NUM:void 0,ENABLE_ABSSENDTIME_AS_SENTTS:!0,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,DC_JOIN_WITH_FAILBACK:4e3,DC_CONNECTION_TIMEOUT:2e3,DC_PINGPONG_INTERVAL:2e3,DC_DEBUG_LOG:!1,UNSUPPORTED_VIDEO_UPLINK_CODEC:[],UNSUPPORTED_VIDEO_DOWNLINK_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:Bf,CUSTOM_ADAPTATION_DEFAULT_MODE:"",HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,DISABLE_SCREEN_SHARE_REMB:!1},En),{},{USE_CANDIDATE_FROM_AP_DETAIL:!1,AP_REQUEST_DETAIL:void 0,ENABLE_ROLE_SELECT_EDGE:!1,CLIENT_ROLE_OPTIONS:void 0,REMOTE_VIDEO_STREAM_TYPE:void 0,COMPATIBLE_SDP_EXTENSION:["gdpr_forbidden"],LIMIT_BITRATE:void 0,EXPERIMENTS:{},USE_PUB_RTX:!0,USE_SUB_RTX:!0,ENABLE_DATASTREAM_2:!1,USE_XR:!0,ENABLE_PREALLOC_PC:!1,ENABLE_PRE_SUB:!1,ENABLE_SVC:!1,ENABLE_FORCE_HLS:!1,MAX_WEBAUDIO_VOLUME:300,ENABLE_VOS_FALLBACK:!1,ENABLE_FALLBACK_TO_HLS:!1,ENABLE_PRE_RENDER:!1,FORCE_DISABLE_AUTO_SUB:!1,ENABLE_PRE_SUB_WITH_PRE_PC:!0,PRE_USE_LOCAL_CODECS:!0},{INSTALL_ID:""}),{},{K_MIN_RENDER_DELAY:66,USE_STANDARD_BITRATE_DEFAULT:!1,VIDEO_NEW_BITRATE_RATIO:void 0,VIDEO_STANDARD_BITRATE_VERSION:2,BASELINE_MORE_H264_BITRATE_RATIO:1.1,IGNORE_RTC_DEVICE_CHECK:!1,FLS_AUTOPLAY_EMITS:!1,ENABLE_DUAL_STREAM_FLAG:!1,FORBID_MODIFY_LOCAL_OFFER_SDP:!1,RESERVE_MID_1_MLINE:!1});function $e(n,e,t){var i,r,o;z(i=Object.keys(Si)).call(i,n)&&(!t&&z(r=Object.keys(Zs)).call(r,n)||(Si[n]=e,n!=="ENABLE_VIDEO_SEI"&&n!=="ENABLE_AUDIO_TOPN"&&n!=="ENABLE_AUDIO_METADATA"&&n!=="ENABLE_AUDIO_PTS"||e!==!0||(Si.ENABLE_ENCODED_TRANSFORM=!0),n==="USE_NEW_NETWORK_CONFIG"&&e&&(o=!!e,Si.USE_NEW_NETWORK_CONFIG=o,o&&(Si.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],Si.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],Si.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],Si.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],Si.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",Si.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",Si.GATEWAY_DOMAINS=["edge.sd-rtn.com"])),n==="ENABLE_PRE_SUB"&&e&&(Si.ENABLE_INSTANT_VIDEO=!0,Si.ENABLE_PREALLOC_PC=!0),n==="ENABLE_SVC"&&e&&(Si.ENABLE_AUT_CC=!0),n==="NEW_FORCE_TURN"&&e&&(Si.NEW_TURN_MODE||(Si.NEW_TURN_MODE=4))))}function F(n){if(n==="TURN_DOMAINS"){let e=Si.TURN_DOMAINS;return z(e).call(e,F("TURN_DOMAIN"))?e:[F("TURN_DOMAIN")].concat(e)}return Si[n]}Qs||(Si.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],Si.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],Si.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],Si.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],Si.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],Si.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],Si.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",Si.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",Si.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",Si.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",Si.AREAS=["NORTH_AMERICA","OVERSEA"]);let B=function(n){return n[n.REALTIME=1]="REALTIME",n}({}),Zs={};var Ye=function(n){return n.SET_SESSION_ID="SET_SESSION_ID",n.SET_RTE_URL="SET_RTE_URL",n.SET_RTE_SID="SET_RTE_SID",n.SET_P2P_ID="SET_P2P_id",n.SET_DC_ID="SET_DC_id",n.SET_UID="SET_UID",n.SET_INT_UID="SET_INT_UID",n.SET_PUB_ID="SET_PUB_ID",n.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",n.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",n.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",n.KEY_METRIC_PRELOAD_START="KEY_METRIC_PRELOAD_START",n.KEY_METRIC_PRELOAD_END="KEY_METRIC_PRELOAD_END",n.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",n.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",n.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",n.KEY_METRIC_REQUEST_SUA_END="KEY_METRIC_REQUEST_SUA_END",n.KEY_METRIC_BEFORE_CONNECT="KEY_METRIC_BEFORE_CONNECT",n.KEY_METRIC_PEER_RECEIVER="KEY_METRIC_PEER_RECEIVER",n.KEY_METRIC_SIGNAL_CONNECTED="KEY_METRIC_SIGNAL_CONNECTED",n.KEY_METRIC_JOIN_REQ="KEY_METRIC_JOIN_REQ",n.KEY_METRIC_JOIN_REP="KEY_METRIC_JOIN_REP",n.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",n.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",n.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",n.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",n.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED="KEY_METRIC_FIRST_VIDEO_FRAME_DECODED",n.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",n.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",n.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",n.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",n.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",n.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",n.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",n.RESET_KEY_METRICS="RESET_KEY_METRICS",n.RESET_FIRST_VIDEO_FRAME_DECODED="RESET_FIRST_VIDEO_FRAME_DECODED",n.SET_USE_P2P="SET_USE_P2P",n.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",n}(Ye||{});let tt=function(n){return n.h264="h264",n.h265="h265",n.vp8="vp8",n.vp9="vp9",n.av1="av1",n}({});(function(n){n.opus="opus",n.pcma="pcma",n.pcmu="pcmu",n.g722="g722"})({});let Ph=128,IU=96,AU=1e3,w_=10,jf=0;var wU=(()=>{var n={8:(i,r,o)=>{o.r(r),o.d(r,{Parser:()=>K,Printer:()=>De,parse:()=>Y,print:()=>ie});let s=`
`,a="".concat("\r").concat(s),c=" ",d;function l(Q){return Q>="0"&&Q<="9"}function h(Q){return Q>="!"&&Q<="~"}function p(Q){return h(Q)||Q>=""&&Q<=""}function f(Q){return Q==="!"||Q>="#"&&Q<="'"||Q>="*"&&Q<="+"||Q>="-"&&Q<="."||Q>="0"&&Q<="9"||Q>="A"&&Q<="Z"||Q>="^"&&Q<="~"}function m(Q){return Q>="1"&&Q<="9"}function g(Q){return Q>="A"&&Q<="Z"||Q>="a"&&Q<="z"}function S(Q){return Q==="d"||Q==="h"||Q==="m"||Q==="s"}function T(Q){return Q>""&&Q<"	"||Q>"\v"&&Q<"\f"||Q>""&&Q<""}function C(Q){return g(Q)||l(Q)||Q==="+"||Q==="/"}function b(Q){return l(Q)||g(Q)||Q==="+"||Q==="/"||Q==="-"||Q==="_"}function D(Q){return g(Q)||l(Q)||Q==="+"||Q==="/"}function x(Q,w){var v=Object.keys(Q);if(Object.getOwnPropertySymbols){var N=Object.getOwnPropertySymbols(Q);w&&(N=N.filter(function(j){return Object.getOwnPropertyDescriptor(Q,j).enumerable})),v.push.apply(v,N)}return v}function k(Q){for(var w=1;w<arguments.length;w++){var v=arguments[w]!=null?arguments[w]:{};w%2?x(Object(v),!0).forEach(function(N){V(Q,N,v[N])}):Object.getOwnPropertyDescriptors?Object.defineProperties(Q,Object.getOwnPropertyDescriptors(v)):x(Object(v)).forEach(function(N){Object.defineProperty(Q,N,Object.getOwnPropertyDescriptor(v,N))})}return Q}function V(Q,w,v){return w in Q?Object.defineProperty(Q,w,{value:v,enumerable:!0,configurable:!0,writable:!0}):Q[w]=v,Q}(function(Q){Q.VERSION="v",Q.ORIGIN="o",Q.SESSION_NAME="s",Q.INFORMATION="i",Q.URI="u",Q.EMAIL="e",Q.PHONE="p",Q.CONNECTION="c",Q.BANDWIDTH="b",Q.TIME="t",Q.REPEAT="r",Q.ZONE_ADJUSTMENTS="z",Q.KEY="k",Q.ATTRIBUTE="a",Q.MEDIA="m"})(d||(d={}));class W{consumeText(w,v){let N=v;for(;N<w.length;){let j=w[N];if(j==="\0"||j==="\r"||j===s)break;N+=1}if(N-v==0)throw new Error("Invalid text, at ".concat(w));return N}consumeUnicastAddress(w,v,N){return this.consumeTill(w,v,c)}consumeOneOrMore(w,v,N){let j=v;for(;N(w[j]);)j++;if(j-v==0)throw new Error("Invalid rule at ".concat(v,"."));return j}consumeSpace(w,v){if(w[v]===c)return v+1;throw new Error("Invalid space at ".concat(v,"."))}consumeIP4Address(w,v){let N=v;for(let j=0;j<4;j++)if(N=this.consumeDecimalUChar(w,N),j!==3){if(w[N]!==".")throw new Error("Invalid IP4 address.");N++}return N}consumeDecimalUChar(w,v){let N=v;for(let ne=0;ne<3&&l(w[N]);ne++,N++);if(N-v==0)throw new Error("Invalid decimal uchar.");let j=parseInt(w.slice(v,N));if(j>=0&&j<=255)return N;throw new Error("Invalid decimal uchar")}consumeIP6Address(w,v){let N=this.consumeHexpart(w,v);return w[N]===":"&&(N+=1,N=this.consumeIP4Address(w,N)),N}consumeHexpart(w,v){let N=v;if(w[N]===":"&&w[N+1]===":"){N+=2;try{N=this.consumeHexseq(w,N)}catch{}return N}if(N=this.consumeHexseq(w,N),w[N]===":"&&w[N+1]===":"){N+=2;try{N=this.consumeHexseq(w,N)}catch{}return N}return N}consumeHexseq(w,v){let N=v;for(;N=this.consumeHex4(w,N),w[N]===":"&&w[N+1]!==":";)N+=1;return N}consumeHex4(w,v){let N=0;for(;N<4;N++)if(!((j=w[v+N])>="0"&&j<="9"||j>="a"&&j<="f"||j>="A"&&j<="F")){if(N===0)throw new Error("Invalid hex 4");break}var j;return v+N}consumeFQDN(w,v){let N=v;for(;l(w[N])||g(w[N])||w[N]==="-"||w[N]===".";)N+=1;if(N-v<4)throw new Error("Invalid FQDN");return N}consumeExtnAddr(w,v){return this.consumeOneOrMore(w,v,p)}consumeMulticastAddress(w,v,N){switch(N){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(w,v);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(w,v);default:try{return this.consumeFQDN(w,v)}catch{return this.consumeExtnAddr(w,v)}}}consumeIP6MulticastAddress(w,v){let N=this.consumeHexpart(w,v);return w[N]==="/"?this.consumeInteger(w,N+1):N}consumeIP4MulticastAddress(w,v){let N=v+3,j=w.slice(v,N),ne=parseInt(j);if(ne<224||ne>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let Ve=0;Ve<3;Ve++){if(w[N]!==".")throw new Error("Invalid IP4 multicast address.");N+=1,N=this.consumeDecimalUChar(w,N)}return w[N]==="/"&&(N+=1),N=this.consumeTTL(w,N),w[N]==="/"&&(N=this.consumeInteger(w,N)),N}consumeInteger(w,v){if(!m(w[v]))throw new Error("Invalid integer.");for(v+=1;l(w[v]);)v+=1;return v}consumeTTL(w,v){if(w[v]==="0")return v+1;if(!m(w[v]))throw new Error("Invalid TTL.");v+=1;for(let N=0;N<2&&l(w[v]);N++)v+=1;return v}consumeToken(w,v){return this.consumeOneOrMore(w,v,f)}consumeTime(w,v){let N=v;if(w[N]==="0")return N+1;for(m(w[N])&&(N+=1);l(w[N]);)N++;if(N-v<10)throw new Error("Invalid time");return N}consumeAddress(w,v){return this.consumeTill(w,v,c)}consumeTypedTime(w,v){let N=v;return N=this.consumeOneOrMore(w,N,l),S(w[N])?N+1:N}consumeRepeatInterval(w,v){if(!m(w[v]))throw new Error("Invalid repeat interval");for(v+=1;l(w[v]);)v+=1;return S(w[v])&&(v+=1),v}consumePort(w,v){return this.consumeOneOrMore(w,v,l)}consume(w,v,N){for(let j=0;j<N.length;j++){if(v+j>=w.length)throw new Error("consume exceeding value length");if(w[v+j]!==N[j])throw new Error("consume ".concat(N," failed at ").concat(j))}return v+N.length}consumeTill(w,v,N){let j=v;for(;j<w.length&&(typeof N!="string"||w[j]!==N)&&(typeof N!="function"||!N(w[j]));)j++;return j}}class K extends W{constructor(){super(),V(this,"records",[]),V(this,"currentLine",0)}parse(w){let v=this.probeEOL(w);this.records=w.split(v).filter(Pa=>!!rr(Pa).call(Pa)).map(this.parseLine),this.currentLine=0;let N=this.parseVersion(),j=this.parseOrigin(),ne=this.parseSessionName(),Ve=this.parseInformation(),wt=this.parseUri(),Ji=this.parseEmail(),Ro=this.parsePhone(),cl=this.parseConnection(),nh=this.parseBandWidth(),oh=this.parseTimeFields(),jl=this.parseKey(),dl=this.parseSessionAttribute(),ll=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:N,origin:j,sessionName:ne,information:Ve,uri:wt,emails:Ji,phones:Ro,connection:cl,bandwidths:nh,timeFields:oh,key:jl,attributes:dl,mediaDescriptions:ll}}getCurrentRecord(){let w=this.records[this.currentLine];if(!w)throw new Error("Record doesn't exit.");return w}probeEOL(w){for(let v=0;v<w.length;v++)if(w[v]===s)return w[v-1]==="\r"?a:s;throw new Error("Invalid newline character.")}parseLine(w,v){if(w.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");let N=w[0];if(w[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:N,value:w.slice(2),line:v,cur:0}}parseSessionAttribute(){let w=new se;for(;this.currentLine<this.records.length;){let v=this.getCurrentRecord();if(v.type!==d.ATTRIBUTE)break;let N={attField:this.extractOneOrMore(v,j=>f(j)&&j!==":"),_cur:0};v.value[v.cur]===":"&&(v.cur+=1,N.attValue=this.extractOneOrMore(v,T)),w.parse(N),this.currentLine++}return w.digest()}parseMediaAttributes(w){let v=new Ne(w);for(;this.currentLine<this.records.length;){let N=this.getCurrentRecord();if(N.type!==d.ATTRIBUTE)break;let j={attField:this.extractOneOrMore(N,ne=>f(ne)&&ne!==":"),_cur:0};N.value[N.cur]===":"&&(N.cur+=1,j.attValue=this.extractOneOrMore(N,T)),v.parse(j),this.currentLine++}return v.digest()}parseKey(){let w=this.getCurrentRecord();if(w.type===d.KEY){if(w.value==="prompt"||w.value==="clear:"||w.value==="base64:"||w.value==="uri:")return w.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){let w=this.getCurrentRecord();if(w.type===d.ZONE_ADJUSTMENTS){let v=[];for(;;)try{let N=this.extract(w,this.consumeTime);this.consumeSpaceForRecord(w);let j=!1;w.value[w.cur]==="-"&&(j=!0,w.cur+=1);let ne=this.extract(w,this.consumeTypedTime);v.push({time:N,typedTime:ne,back:j})}catch{break}if(v.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,v}return[]}parseRepeat(){let w=[];for(;;){let v=this.getCurrentRecord();if(v.type!==d.REPEAT)break;{let N=this.extract(v,this.consumeRepeatInterval),j=this.parseTypedTime(v);w.push({repeatInterval:N,typedTimes:j}),this.currentLine++}}return w}parseTypedTime(w){let v=[];for(;;)try{this.consumeSpaceForRecord(w),v.push(this.extract(w,this.consumeTypedTime))}catch{break}if(v.length===0)throw new Error("Invalid typed time.");return v}parseTime(){let w=this.getCurrentRecord(),v=this.extract(w,this.consumeTime);this.consumeSpaceForRecord(w);let N=this.extract(w,this.consumeTime);return this.currentLine++,{startTime:v,stopTime:N}}parseBandWidth(){let w=[];for(;this.currentLine<this.records.length;){let v=this.getCurrentRecord();if(v.type!==d.BANDWIDTH)break;{let N=this.extractOneOrMore(v,f);if(v.value[v.cur]!==":")throw new Error("Invalid bandwidth field.");v.cur++;let j=this.extractOneOrMore(v,l);w.push({bwtype:N,bandwidth:j}),this.currentLine++}}return w}parseVersion(){let w=this.getCurrentRecord();if(w.type!==d.VERSION)throw new Error("first sdp record must be version");let v=w.value.slice(0,this.consumeOneOrMore(w.value,0,l));if(v.length!==w.value.length)throw new Error('invalid proto version, "v='.concat(w.value,'"'));return this.currentLine++,v}parseOrigin(){let w=this.getCurrentRecord();if(w.type!==d.ORIGIN)throw new Error("second line of sdp must be origin");let v=this.extractOneOrMore(w,p);this.consumeSpaceForRecord(w);let N=this.extractOneOrMore(w,l);this.consumeSpaceForRecord(w);let j=this.extractOneOrMore(w,l);this.consumeSpaceForRecord(w);let ne=this.extractOneOrMore(w,f);this.consumeSpaceForRecord(w);let Ve=this.extractOneOrMore(w,f);this.consumeSpaceForRecord(w);let wt=this.extract(w,this.consumeUnicastAddress);return this.currentLine++,{username:v,sessId:N,sessVersion:j,nettype:ne,addrtype:Ve,unicastAddress:wt}}parseSessionName(){let w=this.getCurrentRecord();if(w.type===d.SESSION_NAME){let v=this.extract(w,this.consumeText);return this.currentLine++,v}}parseInformation(){let w=this.getCurrentRecord();if(w.type!==d.INFORMATION)return;let v=this.extract(w,this.consumeText);return this.currentLine++,v}parseUri(){let w=this.getCurrentRecord();if(w.type===d.URI)return this.currentLine++,w.value}parseEmail(){let w=[];for(;;){let v=this.getCurrentRecord();if(v.type!==d.EMAIL)break;w.push(v.value),this.currentLine++}return w}parsePhone(){let w=[];for(;;){let v=this.getCurrentRecord();if(v.type!==d.PHONE)break;w.push(v.value),this.currentLine++}return w}parseConnection(){let w=this.getCurrentRecord();if(w.type===d.CONNECTION){let v=this.extractOneOrMore(w,f);this.consumeSpaceForRecord(w);let N=this.extractOneOrMore(w,f);this.consumeSpaceForRecord(w);let j=this.extract(w,this.consumeAddress);return this.currentLine++,{nettype:v,addrtype:N,address:j}}}parseMedia(){let w=this.getCurrentRecord(),v=this.extract(w,this.consumeToken);this.consumeSpaceForRecord(w);let N=this.extract(w,this.consumePort);w.value[w.cur]==="/"&&(w.cur+=1,N+=this.extract(w,this.consumeInteger)),this.consumeSpaceForRecord(w);let j=[];for(j.push(this.extract(w,this.consumeToken));w.value[w.cur]==="/";)w.cur+=1,j.push(this.extract(w,this.consumeToken));if(j.length===0)throw new Error("Invalid proto");let ne=this.parseFmt(w);return this.currentLine++,{mediaType:v,port:N,protos:j,fmts:ne}}parseTimeFields(){let w=[];for(;this.getCurrentRecord().type===d.TIME;){let v=this.parseTime(),N=this.parseRepeat(),j=this.parseZone();w.push({time:v,repeats:N,zones:j})}return w}parseMediaDescription(){let w=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===d.MEDIA;){let v=this.parseMedia(),N=this.parseInformation(),j=this.parseConnections(),ne=this.parseBandWidth(),Ve=this.parseKey(),wt=this.parseMediaAttributes(v);w.push({media:v,information:N,connections:j,bandwidths:ne,key:Ve,attributes:wt})}return w}parseConnections(){let w=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===d.CONNECTION;)w.push(this.parseConnection());return w}parseFmt(w){let v=[];for(;;)try{this.consumeSpaceForRecord(w),v.push(this.extract(w,this.consumeToken))}catch{break}if(v.length===0)throw new Error("Invalid fmts");return v}extract(w,v){for(var N=arguments.length,j=new Array(N>2?N-2:0),ne=2;ne<N;ne++)j[ne-2]=arguments[ne];let Ve=v.call(this,w.value,w.cur,...j),wt=w.value.slice(w.cur,Ve);return w.cur=Ve,wt}extractOneOrMore(w,v){let N=this.consumeOneOrMore(w.value,w.cur,v),j=w.value.slice(w.cur,N);return w.cur=N,j}consumeSpaceForRecord(w){if(w.value[w.cur]!==c)throw new Error("Invalid space at ".concat(w.cur,"."));w.cur+=1}}class J extends W{constructor(){super(...arguments),V(this,"attributes",void 0),V(this,"digested",!1)}extractOneOrMore(w,v,N){let j=this.consumeOneOrMore(w.attValue,w._cur,v),ne=w.attValue.slice(w._cur,j),[Ve,wt]=N||[];if(typeof Ve=="number"&&ne.length<Ve)throw new Error("error in length, should be more or equal than ".concat(Ve," characters."));if(typeof wt=="number"&&ne.length>wt)throw new Error("error in length, should be less or equal than ".concat(wt," characters."));return w._cur=j,ne}consumeAttributeSpace(w){if(w.attValue[w._cur]!==c)throw new Error("Invalid space at ".concat(w._cur,"."));w._cur+=1}extract(w,v){if(!w.attValue)throw new Error("Nothing to extract from attValue.");for(var N=arguments.length,j=new Array(N>2?N-2:0),ne=2;ne<N;ne++)j[ne-2]=arguments[ne];let Ve=v.call(this,w.attValue,w._cur,...j),wt=w.attValue.slice(w._cur,Ve);return w._cur=Ve,wt}atEnd(w){if(!w.attValue)throw new Error;return w._cur>=w.attValue.length}peekChar(w){if(!w.attValue)throw new Error;return w.attValue[w._cur]}peek(w,v){if(!w.attValue)throw new Error;for(let N=0;N<v.length;N++)if(v[N]!==w.attValue[w._cur+N])return!1;return!0}parseIceUfrag(w){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(w,C,[4,256])}parseIcePwd(w){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(w,C,[22,256])}parseIceOptions(w){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");let v=[];for(;!this.atEnd(w);){v.push(this.extractOneOrMore(w,C));try{this.consumeAttributeSpace(w)}catch(N){if(this.atEnd(w))break;throw N}}this.attributes.iceOptions=v}parseFingerprint(w){let v=this.extract(w,this.consumeToken);this.consumeAttributeSpace(w);let N=this.extract(w,this.consumeTill);this.attributes.fingerprints.push({hashFunction:v,fingerprint:N})}parseExtmap(w){let v=this.extractOneOrMore(w,l),N;this.peekChar(w)==="/"&&(this.extract(w,this.consume,"/"),N=this.extract(w,this.consumeToken)),this.consumeAttributeSpace(w);let j=this.extract(w,this.consumeTill,c),ne=k(k({entry:parseInt(v,10)},N&&{direction:N}),{},{extensionName:j});this.peekChar(w)===c&&(this.consumeAttributeSpace(w),ne.extensionAttributes=this.extract(w,this.consumeTill)),this.attributes.extmaps.push(ne)}parseSetup(w){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");let v=this.extract(w,this.consumeTill);if(v!=="active"&&v!=="passive"&&v!=="actpass"&&v!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=v}}class se extends J{constructor(){super(...arguments),V(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(w){if(this.digested)throw new Error("already digested");try{switch(w.attField){case"group":this.parseGroup(w);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(w);break;case"ice-pwd":this.parseIcePwd(w);break;case"ice-options":this.parseIceOptions(w);break;case"fingerprint":this.parseFingerprint(w);break;case"setup":this.parseSetup(w);break;case"tls-id":this.parseTlsId(w);break;case"identity":this.parseIdentity(w);break;case"extmap":this.parseExtmap(w);break;case"msid-semantic":this.parseMsidSemantic(w);break;default:w.ignored=!0,this.attributes.unrecognized.push(w)}}catch(v){throw console.error("parsing session attribute ".concat(w.attField,' error, "a=').concat(w.attField,":").concat(w.attValue,'"')),v}if(!w.ignored&&w.attValue&&!this.atEnd(w))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(w){let v=this.extract(w,this.consumeToken),N=[];for(;!this.atEnd(w)&&this.peekChar(w)===c;)this.consumeAttributeSpace(w),N.push(this.extract(w,this.consumeToken));this.attributes.groups.push({semantic:v,identificationTag:N})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(w){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(w,b)}parseIdentity(w){let v=this.extractOneOrMore(w,D),N=[];for(;!this.atEnd(w)&&this.peekChar(w)===c;){this.consumeAttributeSpace(w);let j=this.extract(w,this.consumeToken);this.extract(w,this.consume,"=");let ne=this.extractOneOrMore(w,Ve=>Ve!==c&&T(Ve));N.push({name:j,value:ne})}this.attributes.identities.push({assertionValue:v,extensions:N})}parseMsidSemantic(w){this.peekChar(w)===c&&this.consumeAttributeSpace(w);let v={semantic:this.extract(w,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(w)}catch{break}if(this.peekChar(w)==="*"){this.extract(w,this.consume,"*"),v.applyForAll=!0;break}{let N=this.extract(w,this.consumeTill,c);v.identifierList.push(N)}}this.attributes.msidSemantic=v}}class Ne extends J{constructor(w){super(),V(this,"attributes",void 0),w.protos.indexOf("RTP")!==-1||w.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(w){if(this.digested)throw new Error("already digested");try{switch(w.attField){case"extmap":this.parseExtmap(w);break;case"setup":this.parseSetup(w);break;case"ice-ufrag":this.parseIceUfrag(w);break;case"ice-pwd":this.parseIcePwd(w);break;case"ice-options":this.parseIceOptions(w);break;case"candidate":this.parseCandidate(w);break;case"remote-candidate":this.parseRemoteCandidate(w);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(w);break;case"rtpmap":this.parseRtpmap(w);break;case"ptime":this.parsePtime(w);break;case"maxptime":this.parseMaxPtime(w);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(w);break;case"ssrc":this.parseSSRC(w);break;case"fmtp":this.parseFmtp(w);break;case"rtcp-fb":this.parseRtcpFb(w);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(w);break;case"mid":this.parseMid(w);break;case"msid":this.parseMsid(w);break;case"imageattr":this.parseImageAttr(w);break;case"rid":this.parseRid(w);break;case"simulcast":this.parseSimulcast(w);break;case"sctp-port":this.parseSctpPort(w);break;case"max-message-size":this.parseMaxMessageSize(w);break;case"ssrc-group":this.parseSSRCGroup(w);break;default:w.ignored=!0,this.attributes.unrecognized.push(w)}}catch(v){throw console.error("parsing media attribute ".concat(w.attField,' error, "a=').concat(w.attField,":").concat(w.attValue,'"')),v}if(!w.ignored&&w.attValue&&!this.atEnd(w))throw new Error("attribute parsing error")}parseCandidate(w){let v=this.extractOneOrMore(w,C,[1,32]);this.consumeAttributeSpace(w);let N=this.extractOneOrMore(w,l,[1,5]);this.consumeAttributeSpace(w);let j=this.extract(w,this.consumeToken);this.consumeAttributeSpace(w);let ne=this.extractOneOrMore(w,l,[1,10]);this.consumeAttributeSpace(w);let Ve=this.extract(w,this.consumeAddress);this.consumeAttributeSpace(w);let wt=this.extract(w,this.consumePort);this.consumeAttributeSpace(w),this.extract(w,this.consume,"typ"),this.consumeAttributeSpace(w);let Ji={foundation:v,componentId:N,transport:j,priority:ne,connectionAddress:Ve,port:wt,type:this.extract(w,this.consumeToken),extension:{}};for(this.peek(w," raddr")&&(this.extract(w,this.consume," raddr"),this.consumeAttributeSpace(w),Ji.relAddr=this.extract(w,this.consumeAddress)),this.peek(w," rport")&&(this.extract(w,this.consume," rport"),this.consumeAttributeSpace(w),Ji.relPort=this.extract(w,this.consumePort));this.peekChar(w)===c;){this.consumeAttributeSpace(w);let Ro=this.extract(w,this.consumeToken);this.consumeAttributeSpace(w),Ji.extension[Ro]=this.extractOneOrMore(w,h)}this.attributes.candidates.push(Ji)}parseRemoteCandidate(w){let v=[];for(;;){let N=this.extractOneOrMore(w,l,[1,5]);this.consumeAttributeSpace(w);let j=this.extract(w,this.consumeAddress);this.consumeAttributeSpace(w);let ne=this.extract(w,this.consumePort);v.push({componentId:N,connectionAddress:j,port:ne});try{this.consumeAttributeSpace(w)}catch{break}}this.attributes.remoteCandidatesList.push(v)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(w){let v=this.extract(w,this.consumeToken);this.consumeAttributeSpace(w);let N=this.extract(w,this.consumeTill,"/");this.extract(w,this.consume,"/");let j={encodingName:N,clockRate:this.extractOneOrMore(w,l)};this.atEnd(w)||this.peekChar(w)!=="/"||(this.extract(w,this.consume,"/"),j.encodingParameters=parseInt(this.extract(w,this.consumeTill),10));let ne=this.attributes.payloads.find(Ve=>Ve.payloadType===parseInt(v,10));ne?ne.rtpMap=j:this.attributes.payloads.push({payloadType:parseInt(v,10),rtpMap:j,rtcpFeedbacks:[]})}parsePtime(w){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(w,this.consumeTill)}parseMaxPtime(w){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(w,this.consumeTill)}parseDirection(w){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=w.attField}parseSSRC(w){let v=this.extractOneOrMore(w,l);this.consumeAttributeSpace(w);let N=this.extract(w,this.consumeTill,":"),j;this.peekChar(w)===":"&&(this.extract(w,this.consume,":"),j=this.extract(w,this.consumeTill));let ne=this.attributes.ssrcs.find(Ve=>Ve.ssrcId===parseInt(v,10));ne?ne.attributes[N]=j:this.attributes.ssrcs.push({ssrcId:parseInt(v,10),attributes:{[N]:j}})}parseFmtp(w){let v=this.extract(w,this.consumeTill,c);this.consumeAttributeSpace(w);let N=this.extract(w,this.consumeTill),j={};N.split(";").forEach(Ve=>{let[wt,Ji]=Ve.split("=");wt=rr(wt).call(wt);let Ro=typeof Ji=="string"?rr(Ji).call(Ji):null;typeof wt=="string"&&wt.length>0&&(j[wt]=Ro)});let ne=this.attributes.payloads.find(Ve=>Ve.payloadType===parseInt(v,10));ne?ne.fmtp={parameters:j}:this.attributes.payloads.push({payloadType:parseInt(v,10),rtcpFeedbacks:[],fmtp:{parameters:j}})}parseFmtParameters(w){let v={},N=this.extract(w,this.consumeTill,"=");w._cur++;let j=this.extract(w,this.consumeTill,";");for(v[N]=j;w.attValue[w._cur]===";";){let ne=this.extract(w,this.consumeTill,"=");w._cur++;let Ve=this.extract(w,this.consumeTill,";");v[ne]=Ve}return v}parseRtcpFb(w){let v="";v=this.peekChar(w)==="*"?this.extract(w,this.consume,"*"):this.extract(w,this.consumeTill,c),this.consumeAttributeSpace(w);let N=this.extract(w,this.consumeTill,c),j;if(N==="trr-int")j={type:N,interval:this.extract(w,this.consumeTill)};else{let ne={type:N};this.peekChar(w)===c&&(this.consumeAttributeSpace(w),ne.parameter=this.extract(w,this.consumeToken),this.peekChar(w)===c&&(ne.additional=this.extract(w,this.consumeTill))),j=ne}if(v==="*")this.attributes.rtcpFeedbackWildcards.push(j);else{let ne=this.attributes.payloads.find(Ve=>Ve.payloadType===parseInt(v,10));ne?ne.rtcpFeedbacks.push(j):this.attributes.payloads.push({payloadType:parseInt(v,10),rtcpFeedbacks:[j]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(w){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");let v={port:this.extract(w,this.consumePort)};this.peekChar(w)===c&&(this.consumeAttributeSpace(w),v.netType=this.extractOneOrMore(w,f),this.consumeAttributeSpace(w),v.addressType=this.extractOneOrMore(w,f),this.consumeAttributeSpace(w),v.address=this.extract(w,this.consumeAddress)),this.attributes.rtcp=v}parseMsid(w){let v={id:this.extractOneOrMore(w,f,[1,64])};this.peekChar(w)===c&&(this.consumeAttributeSpace(w),v.appdata=this.extractOneOrMore(w,f,[1,64])),this.attributes.msids.push(v)}parseImageAttr(w){this.attributes.imageattr.push(w.attValue)}parseRid(w){let v=this.extractOneOrMore(w,j=>g(j)||l(j)||j==="_"||j==="-");this.consumeAttributeSpace(w);let N={id:v,direction:this.extract(w,this.consumeToken),params:[]};if(this.peekChar(w)===c){if(this.consumeAttributeSpace(w),this.peek(w,"pt=")){this.extract(w,this.consume,"pt=");let j=[];for(;;){let ne=this.extract(w,this.consumeToken);j.push(ne);try{this.extract(w,this.consume,",")}catch{break}}N.payloads=j,this.peekChar(w)===c&&this.extract(w,this.consume,c)}for(;;){let j=this.extract(w,this.consumeToken);switch(j){case"depend":{let ne={type:j,rids:this.extract(w,this.consume,"=").split(",")};N.params.push(ne);break}default:{let ne={type:j};this.peekChar(w)==="="&&(this.extract(w,this.consume,"="),ne.val=this.extract(w,this.consumeTill,";")),N.params.push(ne)}}try{this.extract(w,this.consume,";")}catch{break}}}this.attributes.rids.push(N)}parseSimulcast(w){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=w.attValue,this.extract(w,this.consumeTill)}parseSctpPort(w){this.attributes.sctpPort=this.extractOneOrMore(w,l,[1,5])}parseMaxMessageSize(w){this.attributes.maxMessageSize=this.extractOneOrMore(w,l,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(w){this.attributes.mid=this.extract(w,this.consumeToken)}parseSSRCGroup(w){let v=this.extract(w,this.consumeToken),N=[];for(;;)try{this.consumeAttributeSpace(w);let j=this.extract(w,this.consumeInteger);N.push(parseInt(j,10))}catch{break}this.attributes.ssrcGroups.push({semantic:v,ssrcIds:N})}}function Ce(Q,w,v){return w in Q?Object.defineProperty(Q,w,{value:v,enumerable:!0,configurable:!0,writable:!0}):Q[w]=v,Q}class De{constructor(){Ce(this,"eol",a)}print(w,v){let N="";return v&&(this.eol=v),N+=this.printVersion(w.version),N+=this.printOrigin(w.origin),N+=this.printSessionName(w.sessionName),N+=this.printInformation(w.information),N+=this.printUri(w.uri),N+=this.printEmail(w.emails),N+=this.printPhone(w.phones),N+=this.printConnection(w.connection),N+=this.printBandwidth(w.bandwidths),N+=this.printTimeFields(w.timeFields),N+=this.printKey(w.key),N+=this.printSessionAttributes(w.attributes),N+=this.printMediaDescription(w.mediaDescriptions),N}printVersion(w){return"v=".concat(w).concat(this.eol)}printOrigin(w){return"o=".concat(w.username," ").concat(w.sessId," ").concat(w.sessVersion," ").concat(w.nettype," ").concat(w.addrtype," ").concat(w.unicastAddress).concat(this.eol)}printSessionName(w){return w?"s=".concat(w).concat(this.eol):""}printInformation(w){return w?"i=".concat(w).concat(this.eol):""}printUri(w){return w?"u=".concat(w).concat(this.eol):""}printEmail(w){let v="";for(let N of w)v+="e=".concat(N).concat(this.eol);return v}printPhone(w){let v="";for(let N of w)v+="e=".concat(N).concat(this.eol);return v}printConnection(w){return w?"c=".concat(w.nettype," ").concat(w.addrtype," ").concat(w.address).concat(this.eol):""}printBandwidth(w){let v="";for(let N of w)v+="b=".concat(N.bwtype,":").concat(N.bandwidth).concat(this.eol);return v}printTimeFields(w){let v="";for(let N of w){v+="t=".concat(N.time.startTime," ").concat(N.time.startTime).concat(this.eol);for(let j of N.repeats)v+="r=".concat(j.repeatInterval," ").concat(j.typedTimes.join(" ")).concat(this.eol);N.zoneAdjustments&&(v+="z=",v+="z=".concat(N.zoneAdjustments.map(j=>"".concat(j.time," ").concat(j.back?"-":""," ").concat(j.typedTime)).join(" ")).concat(this.eol),v+=this.eol)}return v}printKey(w){return w?"k=".concat(w).concat(this.eol):""}printAttributes(w){let v="";for(let N of w)v+="a=".concat(N.attField).concat(N.attValue?":".concat(N.attValue):"").concat(this.eol);return v}printMediaDescription(w){let v="";for(let N of w)v+=this.printMedia(N.media),v+=this.printInformation(N.information),v+=this.printConnections(N.connections),v+=this.printBandwidth(N.bandwidths),v+=this.printKey(N.key),v+=this.printMediaAttributes(N);return v}printConnections(w){let v="";for(let N of w)v+=this.printConnection(N);return v}printMedia(w){return"m=".concat(w.mediaType," ").concat(w.port," ").concat(w.protos.join("/")," ").concat(w.fmts.join(" ")).concat(this.eol)}printSessionAttributes(w){return new et(this.eol).print(w)}printMediaAttributes(w){return new ae(this.eol).print(w)}}class Me{constructor(w){Ce(this,"eol",void 0),this.eol=w}printIceUfrag(w){return w===void 0?"":"a=ice-ufrag:".concat(w).concat(this.eol)}printIcePwd(w){return w===void 0?"":"a=ice-pwd:".concat(w).concat(this.eol)}printIceOptions(w){return w===void 0?"":"a=ice-options:".concat(w.join(c)).concat(this.eol)}printFingerprints(w){return w.length>0?w.map(v=>"a=fingerprint:".concat(v.hashFunction).concat(c).concat(v.fingerprint)).join(this.eol)+this.eol:""}printExtmap(w){return w.map(v=>"a=extmap:".concat(v.entry).concat(v.direction?"/".concat(v.direction):"").concat(c).concat(v.extensionName).concat(v.extensionAttributes?"".concat(c).concat(v.extensionAttributes):"").concat(this.eol)).join("")}printSetup(w){return w===void 0?"":"a=setup:".concat(w).concat(this.eol)}printUnrecognized(w){return w.map(v=>"a=".concat(v.attField).concat(v.attValue?":".concat(v.attValue):"").concat(this.eol)).join("")}}class et extends Me{print(w){let v="";return v+=this.printGroups(w.groups),v+=this.printMsidSemantic(w.msidSemantic),v+=this.printIceLite(w.iceLite),v+=this.printIceUfrag(w.iceUfrag),v+=this.printIcePwd(w.icePwd),v+=this.printIceOptions(w.iceOptions),v+=this.printFingerprints(w.fingerprints),v+=this.printSetup(w.setup),v+=this.printTlsId(w.tlsId),v+=this.printIdentity(w.identities),v+=this.printExtmap(w.extmaps),v+=this.printUnrecognized(w.unrecognized),v}printGroups(w){let v="";return w.length>0&&(v+=w.map(N=>"a=group:".concat(N.semantic).concat(N.identificationTag.map(j=>"".concat(c).concat(j)).join("")).concat(this.eol)).join("")),v}printIceLite(w){return w===void 0?"":"a=ice-lite"+this.eol}printTlsId(w){return w?"a=tls-id:".concat(w).concat(this.eol):""}printIdentity(w){return w.length===0?"":w.map(v=>"a=identity:".concat(v.assertionValue).concat(v.extensions.map(N=>"".concat(c).concat(N.name).concat(N.value?"=".concat(N.value):"")))).join(this.eol)+this.eol}printMsidSemantic(w){if(!w)return"";let v="a=msid-semantic:".concat(w.semantic);return w.applyForAll?v+="".concat(c,"*"):w.identifierList.length>0&&(v+=w.identifierList.map(N=>"".concat(c).concat(N))),v+this.eol}}class ae extends Me{print(w){let v=w.attributes,N="";return N+=this.printRTCP(v.rtcp),N+=this.printIceUfrag(v.iceUfrag),N+=this.printIcePwd(v.icePwd),N+=this.printIceOptions(v.iceOptions),N+=this.printCandidates(v.candidates),N+=this.printRemoteCandidatesList(v.remoteCandidatesList),N+=this.printEndOfCandidates(v.endOfCandidates),N+=this.printFingerprints(v.fingerprints),N+=this.printSetup(v.setup),N+=this.printMid(v.mid),N+=this.printExtmap(v.extmaps),N+=this.printRTPRelated(v),N+=this.printPtime(v.ptime),N+=this.printMaxPtime(v.maxPtime),N+=this.printDirection(v.direction),N+=this.printSSRCGroups(v.ssrcGroups),N+=this.printSSRC(v.ssrcs),N+=this.printRTCPMux(v.rtcpMux),N+=this.printRTCPMuxOnly(v.rtcpMuxOnly),N+=this.printRTCPRsize(v.rtcpRsize),N+=this.printMSId(v.msids),N+=this.printImageattr(v.imageattr),N+=this.printRid(v.rids),N+=this.printSimulcast(v.simulcast),N+=this.printSCTPPort(v.sctpPort),N+=this.printMaxMessageSize(v.maxMessageSize),N+=this.printUnrecognized(v.unrecognized),N}printCandidates(w){return w.map(v=>"a=candidate:".concat(v.foundation).concat(c).concat(v.componentId).concat(c).concat(v.transport).concat(c).concat(v.priority).concat(c).concat(v.connectionAddress).concat(c).concat(v.port).concat(c,"typ").concat(c).concat(v.type).concat(v.relAddr?"".concat(c,"raddr").concat(c).concat(v.relAddr):"").concat(v.relPort?"".concat(c,"rport").concat(c).concat(v.relPort):"").concat(Object.keys(v.extension).map(N=>"".concat(c).concat(N).concat(c).concat(v.extension[N])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(w){return w.map(v=>"a=remote-candidates:".concat(v.join(c)).concat(this.eol)).join("")}printEndOfCandidates(w){return w===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(w){if(!w.payloads)return"";let v=w.payloads,N="";N+=w.rtcpFeedbackWildcards.map(j=>this.printRTCPFeedback("*",j)).join("");for(let j of v)N+=this.printRtpMap(j.payloadType,j.rtpMap),N+=this.printFmtp(j.payloadType,j.fmtp),N+=j.rtcpFeedbacks.map(ne=>this.printRTCPFeedback(j.payloadType,ne)).join("");return N}printFmtp(w,v){if(!v)return"";let N=Object.keys(v.parameters);return N.length===1&&v.parameters[N[0]]===null?"a=fmtp:".concat(w).concat(c).concat(N[0]).concat(this.eol):"a=fmtp:".concat(w).concat(c).concat(Object.keys(v.parameters).map(j=>"".concat(j,"=").concat(v.parameters[j])).join(";")).concat(this.eol)}printRtpMap(w,v){return v?"a=rtpmap:".concat(w).concat(c).concat(v.encodingName,"/").concat(v.clockRate).concat(v.encodingParameters?"/".concat(v.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(w,v){let N="a=rtcp-fb:".concat(w).concat(c),j=v;return j.type==="trr-int"?N+="ttr-int".concat(c).concat(j.interval):(N+="".concat(j.type),j.parameter&&(N+="".concat(c).concat(j.parameter),j.additional&&(N+="".concat(c).concat(j.additional)))),N+this.eol}printPtime(w){return w===void 0?"":"a=ptime:".concat(w).concat(this.eol)}printMaxPtime(w){return w===void 0?"":"a=maxptime:".concat(w).concat(this.eol)}printDirection(w){return w===void 0?"":"a=".concat(w).concat(this.eol)}printSSRC(w){return w.map(v=>Object.keys(v.attributes).map(N=>"a=ssrc:".concat(v.ssrcId.toString(10)).concat(c).concat(N).concat(v.attributes[N]?":".concat(v.attributes[N]):"").concat(this.eol)).join("")).join("")}printRTCPMux(w){return w===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(w){return w===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(w){return w===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(w){if(w===void 0)return"";let v="a=rtcp:".concat(w.port);return w.netType&&(v+="".concat(c).concat(w.netType)),w.addressType&&(v+="".concat(c).concat(w.addressType)),w.address&&(v+="".concat(c).concat(w.address)),v+this.eol}printMSId(w){return w.map(v=>"a=msid:".concat(v.id).concat(v.appdata?"".concat(c).concat(v.appdata):"").concat(this.eol)).join("")}printImageattr(w){return w.map(v=>"a=imageattr:".concat(v).concat(this.eol)).join("")}printRid(w){return w.map(v=>{let N="a=rid:".concat(v.id).concat(c).concat(v.direction);return v.payloads&&(N+="".concat(c,"pt=").concat(v.payloads.join(","))),v.params.length>0&&(N+="".concat(c).concat(v.params.map(j=>j.type==="depend"?"depend=".concat(j.rids.join(",")):"".concat(j.type,"=").concat(j.val)).join(";"))),N+this.eol}).join("")}printSimulcast(w){return w===void 0?"":"a=simulcast:".concat(w).concat(this.eol)}printSCTPPort(w){return w===void 0?"":"a=sctp-port:".concat(w).concat(this.eol)}printMaxMessageSize(w){return w===void 0?"":"a=max-message-size:".concat(w).concat(this.eol)}printMid(w){return w===void 0?"":"a=mid:".concat(w).concat(this.eol)}printSSRCGroups(w){return w.map(v=>"a=ssrc-group:".concat(v.semantic).concat(v.ssrcIds.map(N=>"".concat(c).concat(N.toString(10))).join("")).concat(this.eol)).join("")}}function Y(Q){return new K().parse(Q)}function ie(Q,w){return new De().print(Q,w)}}},e={};function t(i){if(e[i])return e[i].exports;var r=e[i]={exports:{}};return n[i](r,r.exports,t),r.exports}return t.d=(i,r)=>{for(var o in r)t.o(r,o)&&!t.o(i,o)&&Object.defineProperty(i,o,{enumerable:!0,get:r[o]})},t.o=(i,r)=>Object.prototype.hasOwnProperty.call(i,r),t.r=i=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(i,"__esModule",{value:!0})},t(8)})();function Oo(n){return wU.parse(n)}function sn(n,e){return wU.print(n,e)}var Du=ln("Array","keys"),UY=Gs,xY=Bi,VY=me,FY=Du,GN=Array.prototype,WN={DOMTokenList:!0,NodeList:!0},BY=function(n){var e=n.keys;return n===GN||VY(GN,n)&&e===GN.keys||xY(WN,UY(n))?FY:e},mo=A(BY);function ai(n,e,t){return(e=function(i){var r=function(o,s){if(typeof o!="object"||!o)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(i);return typeof r=="symbol"?r:r+""}(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function Er(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function Tt(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Er(Object(t),!0).forEach(function(i){ai(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):Er(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}function ft(n,e){return ft=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,i){return t.__proto__=i,t},ft(n,e)}function Gf(){Gf=function(r,o){return new t(r,void 0,o)};var n=RegExp.prototype,e=new WeakMap;function t(r,o,s){var a=RegExp(r,o);return e.set(a,s||e.get(r)),ft(a,t.prototype)}function i(r,o){var s,a=e.get(o);return un(s=Object.keys(a)).call(s,function(c,d){var l=a[d];if(typeof l=="number")c[d]=r[l];else{for(var h=0;r[l[h]]===void 0&&h+1<l.length;)h++;c[d]=r[l[h]]}return c},Object.create(null))}return function(r,o){if(typeof o!="function"&&o!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(o&&o.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),o&&ft(r,o)}(t,RegExp),t.prototype.exec=function(r){var o=n.exec.call(this,r);if(o){o.groups=i(o,this);var s=o.indices;s&&(s.groups=i(s,this))}return o},t.prototype[Symbol.replace]=function(r,o){if(typeof o=="string"){var s=e.get(this);return n[Symbol.replace].call(this,r,o.replace(/\$<([^>]+)(>|$)/g,function(c,d,l){if(l==="")return c;var h=s[d];return Array.isArray(h)?"$"+h.join("$"):typeof h=="number"?"$"+h:""}))}if(typeof o=="function"){var a=this;return n[Symbol.replace].call(this,r,function(){var c=arguments;return typeof c[c.length-1]!="object"&&(c=[].slice.call(c)).push(i(c,a)),o.apply(this,c)})}return n[Symbol.replace].call(this,r,o)},Gf.apply(this,arguments)}let Dv=new class extends Ki{constructor(){super(...arguments),ai(this,"currentUploadLogID",0)}reportLogUploadError(n){let{errorRange:e}=n;e[e.length-1]&&e[e.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=e[e.length-1],this.emit("REPORT_LOG_UPLOAD",n))}};class bU{constructor(e){ai(this,"logger",void 0),ai(this,"prefixLists",[]),this.logger=e}debug(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.logger.debug(...this.prefixLists,...t)}info(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.logger.info(...this.prefixLists,...t)}warning(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.logger.warning(...this.prefixLists,...t)}error(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.logger.error(...this.prefixLists,...t)}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}function HN(){let n=new Date;return n.toTimeString().split(" ")[0]+":"+n.getMilliseconds()}function Pv(){let n=new Date,e=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return e?(e==null?void 0:e[0])+":"+n.getUTCMilliseconds():n.toTimeString().split(" ")[0]+":"+n.getMilliseconds()}let ga={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Cs=Date.now(),Lh=n=>{for(let e in ga)if(Object.prototype.hasOwnProperty.call(ga,e)&&ga[e]===n)return e;return"DEFAULT"},y=new class{constructor(){ai(this,"proxyServerURL",void 0),ai(this,"logLevel",ga.DEBUG),ai(this,"uploadState","collecting"),ai(this,"uploadLogWaitingList",[]),ai(this,"uploadLogUploadingList",[]),ai(this,"uploadErrorCount",0),ai(this,"currentLogID",0),ai(this,"url",void 0),ai(this,"extLog",(n,e)=>{this.appendLogToWaitingList(n,...e)})}debug(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];let i=[ga.DEBUG].concat(e);this.log.apply(this,i)}info(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];let i=[ga.INFO].concat(e);this.log.apply(this,i)}warning(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];let i=[ga.WARNING].concat(e);this.log.apply(this,i)}warn(){this.warning(...arguments)}error(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];let i=[ga.ERROR].concat(e);this.log.apply(this,i)}upload(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];let i=[ga.DEBUG].concat(e);this.uploadLog.apply(this,i)}setLogLevel(n){n=Math.min(Math.max(0,n),4),this.logLevel=n}enableLogUpload(){$e("UPLOAD_LOG",!0)}disableLogUpload(){$e("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(n){this.proxyServerURL=n}prefix(n){return new bU(this).prefix(n)}log(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];if(Date.now()-Cs<100)return void setTimeout(()=>{this.log(...e)},Date.now()-Cs);let i=Math.max(0,Math.min(4,e[0]));if(e[0]=HN()+" Agora-SDK [".concat(Lh(i),"]:"),this.appendLogToWaitingList(i,...e),i<this.logLevel)return;let r=HN()+" %cAgora-SDK [".concat(Lh(i),"]:"),o=[];if(!F("USE_NEW_LOG"))switch(i){case ga.DEBUG:o=[r,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,o);break;case ga.INFO:o=[r,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,o);break;case ga.WARNING:o=[r,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,o);break;case ga.ERROR:o=[r,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,o)}}uploadLog(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];if(Date.now()-Cs<100)return void setTimeout(()=>{this.uploadLog(...e)},Date.now()-Cs);let i=Math.max(0,Math.min(4,e[0]));e[0]=HN()+" Agora-SDK [".concat(Lh(i),"]:"),this.appendLogToWaitingList(i,...e)}appendLogToWaitingList(n){if(!F("UPLOAD_LOG"))return;for(var e=arguments.length,t=new Array(e>1?e-1:0),i=1;i<e;i++)t[i-1]=arguments[i];Array.isArray(t[0])?t[0][0]=Pv()+" Agora-SDK [".concat(Lh(n),"]:"):t[0]=Pv()+" Agora-SDK [".concat(Lh(n),"]:");let r="";t.forEach(o=>{typeof o=="object"&&(o=JSON.stringify(o)),r+="".concat(o," ")}),this.uploadLogWaitingList.push({payload_str:r,log_level:n,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){let n=this.uploadLogUploadingList,e={sdk_version:Js,process_id:F("PROCESS_ID"),payload:JSON.stringify(n)};return fa(async()=>{let t=await Qi.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(F("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(F("LOG_UPLOAD_SERVER"),"/upload/v1")),e,{responseType:"text"});if(t.data!=="OK"){let i=new Error("unexpected upload log response");throw i.response=t,i}},()=>(this.uploadLogUploadingList=[],!1),t=>{let i={status:-1,message:t.message,errorRange:n.map(r=>r.log_item_id)};return t.response?(i.status=t.response.status,i.data=t.response.data,i.headers=t.response.headers):t.request&&(i.status=t.request.status),Dv.reportLogUploadError(i),!0},{timeout:F("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:F("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,F("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),F("UPLOAD_LOG_INTERVAL"))}).catch(n=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),F("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),F("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var I;function OU(n){return _n(n.reportId,"params.reportId",0,100,!1),_n(n.category,"params.category",0,100,!1),_n(n.event,"params.event",0,100,!1),_n(n.label,"params.label",0,100,!1),Rt(n.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(I={}).FREE="free",I.UPLOADING="uploading",function(n){n[n.MISC=0]="MISC",n[n.INTERNAL_EVENT=1]="INTERNAL_EVENT",n[n.PUBLIC_EVENT=2]="PUBLIC_EVENT",n[n.WEB_EVENT=3]="WEB_EVENT",n[n.INTERNAL_API=4]="INTERNAL_API",n[n.WEB_API=5]="WEB_API",n[n.PUBLIC_API=6]="PUBLIC_API"}({});let jY={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0},en=function(n){return n.PUBLISH="publish",n.SUBSCRIBE="subscribe",n.WS_COMPRESSOR_INIT="ws_compressor_init",n.SESSION_INIT="session_init",n.JOIN_CHOOSE_SERVER="join_choose_server",n.RTE_DETAIL="rte_detail_stats",n.REQ_USER_ACCOUNT="req_user_account",n.JOIN_GATEWAY="join_gateway",n.REJOIN_GATEWAY="rejoin_gateway",n.STREAM_SWITCH="stream_switch",n.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",n.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",n.FIRST_VIDEO_RECEIVED="first_video_received",n.FIRST_AUDIO_RECEIVED="first_audio_received",n.FIRST_VIDEO_DECODE="first_video_decode",n.FIRST_AUDIO_DECODE="first_audio_decode",n.XLA_PEER_FIRST_VIDEO_FRAME="xla_peer_first_video_frame",n.ON_ADD_AUDIO_STREAM="on_add_audio_stream",n.ON_ADD_VIDEO_STREAM="on_add_video_stream",n.ON_UPDATE_STREAM="on_update_stream",n.ON_REMOVE_STREAM="on_remove_stream",n.USER_ANALYTICS="req_user_analytics",n.PC_STATS="pc_stats",n.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",n.AB_TEST="ab_test",n}({}),Dt=function(n){return n.SESSION="io.agora.pb.Wrtc.Session",n.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",n.RTE_DETAIL="io.agora.pb.Wrtc.RteDetailStats",n.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",n.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",n.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",n.PUBLISH="io.agora.pb.Wrtc.Publish",n.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",n.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",n.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",n.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",n.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",n.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",n.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",n.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",n.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",n.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",n.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",n.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",n.XLA_PEER_FIRST_VIDEO_FRAME="io.agora.pb.Wrtc.XLAPeerFirstVideoFrame",n.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",n.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",n.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",n.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",n.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",n.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",n.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",n.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",n.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",n.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",n.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",n.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",n.PC_STATS="io.agora.pb.Wrtc.PCStats",n.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",n.AB_TEST="io.agora.pb.Wrtc.ABTest",n}({});(function(n){n[n.WORKER_EVENT=156]="WORKER_EVENT",n[n.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"})({});let Xi=function(n){return n[n.SESSION=26]="SESSION",n[n.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",n[n.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",n[n.JOIN_GATEWAY=28]="JOIN_GATEWAY",n[n.PUBLISH=30]="PUBLISH",n[n.SUBSCRIBE=29]="SUBSCRIBE",n[n.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",n[n.STREAM_SWITCH=32]="STREAM_SWITCH",n[n.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",n[n.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",n[n.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",n[n.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",n[n.API_INVOKE=41]="API_INVOKE",n[n.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",n[n.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",n[n.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",n[n.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",n[n.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",n[n.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",n[n.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",n[n.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",n[n.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",n[n.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",n[n.WORKER_EVENT=156]="WORKER_EVENT",n[n.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",n[n.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",n[n.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",n[n.USER_ANALYTICS=1e4]="USER_ANALYTICS",n[n.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",n}({});function Xe(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(e,t,i){let r=i.value;if(typeof r=="function"){let o=n.className||e.__className__||(e.constructor.name==="AgoraRTCClient"?"Client":e.constructor.name);i.value=function(){for(var s,a=arguments.length,c=new Array(a),d=0;d<a;d++)c[d]=arguments[d];let l=c;if(n.argsMap)try{l=n.argsMap(this,...c)}catch(p){y.warning(p),l=[]}try{JSON.stringify(l)}catch{y.warning("arguments for method ".concat(o,".").concat(String(t)," not serializable for apiInvoke.")),l=[]}let h=(n.report||_e).reportApiInvoke(this._sessionId||null,{id:this._clientId||((s=this.store)===null||s===void 0?void 0:s.clientId)||this._ID,name:"".concat(o,".").concat(String(t)),options:l,tag:ct.TRACER,reportResult:n.reportResult},n.throttleTime);try{let p=r.apply(this,c);return p instanceof Z?p.then(f=>(h.onSuccess(n.reportResult&&f),f)).catch(f=>{throw h.onError(f),f}):(h.onSuccess(n.reportResult&&p),p)}catch(p){throw h.onError(p),p}}}return i}}let _e=new class{constructor(){ai(this,"baseInfoMap",new Map),ai(this,"proxyServer",void 0),ai(this,"eventUploadTimer",void 0),ai(this,"setSessionIdTimer",void 0),ai(this,"url",void 0),ai(this,"sids",new Set),ai(this,"backupUrl",void 0),ai(this,"_appId",void 0),ai(this,"_aid",0),ai(this,"keyEventUploadPendingItems",[]),ai(this,"normalEventUploadPendingItems",[]),ai(this,"apiInvokeUploadPendingItems",[]),ai(this,"apiInvokeCount",0),ai(this,"apiInvokeLoggedCount",0),ai(this,"ltsList",[]),ai(this,"lastSendNormalEventTime",Date.now()),ai(this,"customReportCounterTimer",void 0),ai(this,"customReportCount",0),ai(this,"extApiInvoke",async n=>{for(let e of n){let t=Tt(Tt({},e),{},{sid:null,invokeId:++this.apiInvokeCount,tag:ct.TRACER});this.sendApiInvoke(t)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),F("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),F("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(n){return this.baseInfoMap.get(n)}setAppId(n){this._appId=n,this._aid=parseInt(n.replace(/[a-fA-F0-9]{8}/g,e=>{let[t,i]=e;return t+i}),16)||0}reportApiInvoke(n,e,t){e.timeout=e.timeout||6e4,e.reportResult=e.reportResult===void 0||e.reportResult;let i=Date.now();this.apiInvokeCount+=1;let r=this.apiInvokeCount,o=!!F("SHOW_REPORT_INVOKER_LOG"),s=!!F("SHOW_REPORT_USER_INVOKER_LOG"),a=o||s&&e.id;a&&(this.apiInvokeLoggedCount+=1);let c=this.apiInvokeLoggedCount;function d(f,m){if(a){let g="[apiInvoke-".concat(c,"]");if(e.id&&(g+="[".concat(e.id,"]")),e.name&&(g+="[".concat(e.name,"]"),e.name===Yi.JOIN))return y.info("".concat(g," ").concat(f));y.info("".concat(g," ").concat(f),f==="start"?e.options:m||"")}}let l=()=>({tag:e.tag,invokeId:r,sid:n,name:e.name,apiInvokeTime:i,options:e.options,states:e.states||null});d("start");let h=!1;fn(e.timeout).then(()=>{h||(this.sendApiInvoke(Tt(Tt({},l()),{},{error:L.API_INVOKE_TIMEOUT,success:!1})),d("timeout"))});let p=new O(L.UNEXPECTED_ERROR,"".concat(e.name,": this api invoke is end"));return{onSuccess:f=>{let m=()=>{if(h)throw p;return h=!0,this.sendApiInvoke(Tt(Tt({},l()),{},{success:!0},e.reportResult&&{result:f})),d("onSuccess"),f};return t?MN(m,e.name+"Success",t,()=>h=!0):m()},onError:f=>{let m=()=>{if(h)throw f;h=!0,this.sendApiInvoke(Tt(Tt({},l()),{},{success:!1,error:f})),d("onFailure",f.toString())};return t?MN(m,e.name+"Error",t,()=>h=!0):m()}}}_send(n,e,t){this.send({type:n,data:e},t)}_sendApiInvoke(n){return this.sendApiInvoke(n)}sessionInit(n,e){if(this.baseInfoMap.has(n))return;let t=Date.now(),i=this.createBaseInfo(n,t);i.cname=e.cname,i.rteUrl=e.rteUrl;let r=Object.assign({},{willUploadConsoleLog:F("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:Qs?"global":"oversea",areas:F("AREAS")&&F("AREAS").join(",")},e.extend),{stringUid:o,channelProfile:s,channelMode:a,isABTestSuccess:c,lsid:d,clientRole:l}=e,h=Date.now(),p=Tt(Tt({},i),{},{eventType:en.SESSION_INIT,appid:e.appid,browser:navigator.userAgent,buildFormat:e.buildFormat,build:oT,lts:h,elapse:h-t,extend:JSON.stringify(r),mode:e.mode,process:F("PROCESS_ID"),appType:F("APP_TYPE"),success:!0,version:Js,stringUid:o,channelProfile:s,channelMode:a,isABTestSuccess:c,lsid:d,clientType:z(f=window.navigator.userAgent).call(f,"AgoraWebView")?42:20,clientRole:l,serviceId:F("PROCESS_ID"),extensionID:F("PLUGIN_INFO").join(",")||"",rteUrl:e.rteUrl,rteSid:e.rteSid});var f;this.send({type:Dt.SESSION,data:p},!0)}reportRteDetail(n){let e=this.baseInfoMap.get(n);if(!e)return;let t=e.info,i=Date.now(),r=Tt(Tt({},t),{},{eventType:en.RTE_DETAIL,lts:i,success:!0,elapse:i-e.startTime,vid:t.vid===void 0?0:Number(t.vid),ua:navigator.userAgent});this.send({type:Dt.RTE_DETAIL,data:r},!0)}joinChooseServer(n,e){let t=this.baseInfoMap.get(n);if(!t)return;let i=t.info;e.vid&&(i.vid=e.vid);let r=Date.now(),o=Tt(Tt({},i),{},{role:e.role,eventType:en.JOIN_CHOOSE_SERVER,lts:r,eventElapse:e.elapse||r-e.lts,chooseServerAddr:e.csAddr,errorCode:e.ec,elapse:r-t.startTime,success:e.succ,chooseServerAddrList:JSON.stringify(e.serverList),uid:e.uid?parseInt(e.uid):null,cid:e.cid?parseInt(e.cid):null,chooseServerIp:e.csIp||"",opid:e.opid,unilbsServerIds:e.unilbsServerIds,extend:e.extend||void 0,isHttp3:e.isHttp3,corssRegionTagReq:e.corssRegionTagReq||void 0,corssRegionTagRes:e.corssRegionTagRes||void 0,ua:navigator.userAgent,resourceTimingInfo:e.resourceTimingInfo||void 0});this.send({type:Dt.JOIN_CHOOSE_SERVER,data:o},!0)}reqUserAccount(n,e){let t=this.baseInfoMap.get(n);if(!t)return;let i=t.info,r=Date.now(),o=Tt(Tt({},i),{},{eventType:en.REQ_USER_ACCOUNT,lts:r,success:e.success,serverAddress:e.serverAddr,stringUid:e.stringUid,uid:e.uid,errorCode:e.errorCode,elapse:e.elapse||r-t.startTime,eventElapse:r-e.lts,extend:JSON.stringify(e.extend)});this.send({type:Dt.REQ_USER_ACCOUNT,data:o},!0)}joinGateway(n,e){let t=this.baseInfoMap.get(n);if(!t)return;let i=t.info;e.vid&&(i.vid=e.vid),i.uid=e.uid,i.cid=e.cid;let r=Date.now(),{firstSuccess:o,addr:s,isProxy:a}=e,c=r-t.startTime,d=Tt(Tt({},i),{},{eventType:en.JOIN_GATEWAY,lts:r,gatewayAddr:e.addr,success:e.succ,errorCode:e.ec,errorMsg:e.errorMsg||"",elapse:c,eventElapse:r-e.lts,firstSuccess:o,signalChannel:e.signalChannel,preload:e.preload?1:0,installId:Nv(),isABTestSuccess:e.isABTestSuccess?1:0,gatewayIp:null,gatewayPort:null,isProxy:a?1:0}),l=d.success?1:0;if(e.succ&&(t.lastJoinSuccessTime=r),s)if(d.signalChannel==="1"){let h=Gf(/(\d+\.\d+\.\d+\.\d+):(\d+)/,{ip:1,port:2}),p=s.match(h);d.gatewayIp=p&&p.groups?p.groups.ip:"",d.gatewayPort=p&&p.groups?p.groups.port:""}else if(a){let h=s.match(/h=(\d{1,3}-){3}\d{1,3}/g),p=s.match(/p=[0-9]{1,6}/g);d.gatewayIp=h&&h.length?h[0].split("=")[1].replace(/-/g,"."):"",d.gatewayPort=p&&p.length?p[0].split("=")[1]:""}else{let h=s.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),p=s.match(/(:|p=)[0-9]{1,6}/g);d.gatewayIp=h&&h.length?h[0].split("//")[1].replace(/-/g,"."):"",d.gatewayPort=p&&p.length?p[0].split(/:|p=/g)[1]:""}if(o)this.send({type:Dt.JOIN_GATEWAY,data:d},!0);else{let h={isSuccess:l,port:d.gatewayPort};delete d.success,delete d.eventType,delete d.firstSuccess,delete d.gatewayPort,d.vid=Number(d.vid);let p=Object.assign({},d,h,{eventType:en.REJOIN_GATEWAY});this.send({type:Dt.RE_JOIN_GATEWAY,data:p},!0)}}joinChannelTimeout(n,e){let t=this.baseInfoMap.get(n);if(!t)return;let i=Date.now(),r=Tt(Tt({},t.info),{},{lts:i,timeout:e,elapse:i-t.startTime});this.send({type:Dt.JOIN_CHANNEL_TIMEOUT,data:r},!0)}publish(n,e){let t=this.baseInfoMap.get(n);if(!t)return;let i=t.info,r=Date.now(),o=Tt(Tt({},i),{},{eventType:en.PUBLISH,lts:r,eventElapse:e.eventElapse,elapse:r-t.startTime,success:e.succ,errorCode:e.ec,videoName:e.videoName,audioName:e.audioName,screenName:e.screenName,screenshare:e.screenshare,audio:e.audio,video:e.video,p2pid:e.p2pid,publishRequestid:e.publishRequestid});this.send({type:Dt.PUBLISH,data:o},!0)}subscribe(n,e,t){let i=this.baseInfoMap.get(n);if(!i)return;let r=i.info,o=Date.now(),s=Tt(Tt({},r),{},{eventType:en.SUBSCRIBE,lts:o,eventElapse:e.eventElapse,elapse:o-i.startTime,success:e.succ,errorCode:e.ec,video:e.video,audio:e.audio,subscribeRequestid:e.subscribeRequestid,p2pid:e.p2pid,preSsrc:e.preSsrc?1:0},t&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof e.peerid=="string"?s.peerSuid=e.peerid:s.peer=e.peerid,this.send({type:Dt.SUBSCRIBE,data:s},!0)}wsCompressorInit(n){var e;let t=[...mo(e=this.baseInfoMap).call(e)],i=t.length?t[0]:"UnableToGetSid",r=this.baseInfoMap.get(i);if(!r)return;let o=r.info,s=Date.now(),a=Tt(Tt({},o),{},{eventType:en.WS_COMPRESSOR_INIT,lts:s,eventElapse:n.eventElapse,elapse:s-r.startTime,status:n.status?1:2});this.send({type:Dt.WS_COMPRESSOR_INIT,data:a},!0)}firstXLAPeerFirstVideoFrame(n,e){let t=this.baseInfoMap.get(n);if(!t)return;let i=t.info,r=Date.now(),o=e.peerPubStatusMs-(t.lastJoinSuccessTime||r),s=Tt(Tt({},i),{},{elapse:r-t.startTime,eventType:en.XLA_PEER_FIRST_VIDEO_FRAME,lts:r,peer:e.peer,width:e.width,height:e.height,ssrc:e.ssrc,p2pid:e.p2pid,peerPublishDuration:e.peerPublishDuration,joinChannelSuccessElapse:o,peerPubStatusMs:e.peerPubStatusMs-e.joinChannelStart,availablePublish:e.peerPublishDuration>o?1:0,preloadStart:Math.max(e.preloadStart-e.joinChannelStart,0),preloadEnd:Math.max(e.preloadEnd-e.joinChannelStart,0),encrypt:Math.max(e.apStart-e.joinChannelStart,0),ap:Math.max(e.apEnd-e.joinChannelStart,0),sua:Math.max(e.suaEnd-e.joinChannelStart,0),beforeConnect:Math.max(e.beforeConnect-e.joinChannelStart,0),peerRecevier:Math.max(e.peerReceiver-e.joinChannelStart,0),ice:Math.max(e.ice-e.joinChannelStart,0),pc:Math.max(e.pc-e.joinChannelStart,0),signalConnected:Math.max(e.signalConnected-e.joinChannelStart,0),joinReq:Math.max(e.joinReq-e.joinChannelStart,0),joinRes:Math.max(e.joinRes-e.joinChannelStart,0),userJoinNotify:Math.max(e.userJoinNotify-e.joinChannelStart,0),videoSsrcNotify:Math.max(e.videoAddNotify-e.joinChannelStart,0),subscribeDelayMs:Math.max(e.subscribeStart-e.videoAddNotify,0),subscribeStart:Math.max(e.subscribeStart-e.joinChannelStart,0),subscribeEnd:Math.max(e.subscribeEnd-e.joinChannelStart,0),firstReceived:Math.max(e.firstReceived-e.joinChannelStart,0),firstDecoded:Math.max(e.firstDecoded-e.joinChannelStart,0),firstPreRender:Math.max(e.firstPreRender-e.joinChannelStart,0),firstRender:Math.max(e.firstRender-e.joinChannelStart,0),playDelayMs:Math.max(e.playStart-e.subscribeEnd,0),playStart:Math.max(e.playStart-e.joinChannelStart,0),playEnd:Math.max(e.playEnd-e.joinChannelStart,0),isPreSub:e.isPreSub?1:0,isPrePc:e.isPrePc?1:0,isPreInstantVideo:e.isPreInstantVideo?1:0,firstReceivedEncodedFrame:e.firstReceivedEncodedFrame?Math.max(e.firstReceivedEncodedFrame-e.joinChannelStart,0):void 0,frameType:e.frameType||"",rtpTimestamp:e.rtpTimestamp||0,framePayloadType:e.framePayloadType||0,frameDataLength:e.frameDataLength||0,mimeType:e.mimeType||""});this.send({type:Dt.XLA_PEER_FIRST_VIDEO_FRAME,data:s},!0)}firstRemoteVideoDecode(n,e,t,i){let r=this.baseInfoMap.get(n);if(!r)return;let o=r.info,s=Date.now(),a=Tt(Tt(Tt({},o),i),{},{elapse:s-r.startTime,eventType:e,lts:s,firstDecodeFrame:Math.max((i.firstFrame||s)-r.startTime,0),apEnd:Math.max(i.apEnd-r.startTime,0),apStart:Math.max(i.apStart-r.startTime,0),joinGwEnd:Math.max(i.joinGwEnd-r.startTime,0),joinGwStart:Math.max(i.joinGwStart-r.startTime,0),pcEnd:Math.max(i.pcEnd-r.startTime,0),pcStart:Math.max(i.pcStart-r.startTime,0),subscriberEnd:Math.max(i.subscriberEnd-r.startTime,0),subscriberStart:Math.max(i.subscriberStart-r.startTime,0),videoAddNotify:Math.max(i.videoAddNotify-r.startTime,0)});this.send({type:t,data:a},!0)}firstRemoteFrame(n,e,t,i){let r=this.baseInfoMap.get(n);if(!r)return;let o=r.info,s=Date.now(),a=Tt(Tt(Tt({},o),i),{},{elapse:s-r.startTime,eventType:e,lts:s});this.send({type:t,data:a},!0)}abTest(n,e){let t=this.baseInfoMap.get(n);if(!t)return;let i=t.info,r=Date.now(),o=Tt(Tt(Tt({},i),e),{},{vid:i.vid===void 0?0:Number(i.vid),elapse:r-t.startTime,eventType:en.AB_TEST,lts:r});this.send({type:Dt.AB_TEST,data:o},!0)}pcStats(n,e){let t=this.baseInfoMap.get(n);if(!t)return;let i=t.info,r=Date.now(),o=Tt(Tt(Tt({},i),e),{},{vid:i.vid===void 0?0:Number(i.vid),elapse:r-t.startTime,eventType:en.PC_STATS,lts:r,preallocation:e.preallocation?1:0});this.send({type:Dt.PC_STATS,data:o},!0)}updateRemoteRTPCapabilities(n,e){if(n){let t=this.baseInfoMap.get(n);if(!t)return;let i=t.info,r=Date.now(),o=Tt(Tt(Tt({},i),e),{},{vid:i.vid===void 0?0:Number(i.vid),eventType:en.UPDATE_REMOTE_RTPCAPABILITIES,lts:r});this.send({type:Dt.UPDATE_REMOTE_RTPCAPABILITIES,data:o},!0)}}onGatewayStream(n,e,t,i){let r=this.baseInfoMap.get(n);if(!r)return;let o=r.info,s=Date.now(),a=Tt(Tt(Tt({},o),i),{},{eventType:e,lts:s});this.send({type:t,data:a},!0)}streamSwitch(n,e){let t=this.baseInfoMap.get(n);if(!t)return;let i=t.info,r=Date.now(),o=Tt(Tt({},i),{},{eventType:en.STREAM_SWITCH,lts:r,isDual:e.isdual,elapse:r-t.startTime,success:e.succ});this.send({type:Dt.STREAM_SWITCH,data:o},!0)}requestProxyAppCenter(n,e){let t=this.baseInfoMap.get(n);if(!t)return;let i=t.info,r=Date.now(),o=Tt(Tt({},i),{},{eventType:en.REQUEST_PROXY_APPCENTER,lts:r,eventElapse:r-e.lts,elapse:r-t.startTime,APAddr:e.APAddr,workerManagerList:e.workerManagerList,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:Dt.REQUEST_PROXY_APPCENTER,data:o},!0)}requestProxyWorkerManager(n,e){let t=this.baseInfoMap.get(n);if(!t)return;let i=t.info,r=Date.now(),o=Tt(Tt({},i),{},{eventType:en.REQUEST_PROXY_WORKER_MANAGER,lts:r,eventElapse:r-e.lts,elapse:r-t.startTime,workerManagerAddr:e.workerManagerAddr,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:Dt.REQUEST_PROXY_WORKER_MANAGER,data:o},!0)}setProxyServer(n){this.proxyServer=n,n?y.debug("reportProxyServerurl: ".concat(n)):y.debug("disable reportProxyServerurl: ".concat(n))}peerPublishStatus(n,e){let t=this.baseInfoMap.get(n);if(!t)return;let i=t.info,r=Date.now(),o=Tt(Tt({},i),{},{subscribeElapse:e.subscribeElapse,peer:e.peer,peerPublishDuration:Math.max(e.audioPublishDuration,e.videoPublishDuration),audiotag:e.audioPublishDuration>0?1:-1,videotag:e.videoPublishDuration>0?1:-1,lts:r,elapse:r-t.startTime,joinChannelSuccessElapse:r-(t.lastJoinSuccessTime||r),peerPublishDurationVideo:e.videoPublishDuration,peerPublishDurationAudio:e.audioPublishDuration});this.send({type:Dt.PEER_PUBLISH_STATUS,data:o},!0)}workerEvent(n,e){let t=this.baseInfoMap.get(n);if(!t)return;let i=t.info,r=Date.now();(function(o,s,a){let c=o[s];if(!c||typeof c!="string")return[o];o[s]="";let d=xd(JSON.stringify(o)),l=0,h=[],p=0;for(let f=0;f<c.length;f++)p+=c.charCodeAt(f)<=127?1:3,p<=a-d||(h[h.length]=Te(Te({},o),{},{[s]:c.substring(l,f)}),l=f,p=c.charCodeAt(f)<=127?1:3);return l!==c.length-1&&(h[h.length]=Te(Te({},o),{},{[s]:c.substring(l)})),h})(Tt(Tt(Tt({},i),e),{},{elapse:r-t.startTime,lts:r,productType:"WebRTC"}),"payload",1300).forEach(o=>this.send({type:Dt.WORKER_EVENT,data:o},!0))}apworkerEvent(n,e){let t=this.baseInfoMap.get(n);if(!t)return;let i=t.info,r=Date.now(),o=Tt(Tt(Tt({},i),e),{},{elapse:r-t.startTime,lts:r});this.send({type:Dt.AP_WORKER_EVENT,data:o},!0)}joinWebProxyAP(n,e){let t=this.baseInfoMap.get(n);if(!t)return;let i=t.info,r=Date.now(),o=Tt(Tt(Tt({},i),e),{},{elapse:r-t.startTime,lts:r,extend:e.extend||void 0});this.send({type:Dt.JOIN_WEB_PROXY_AP,data:o},!0)}WebSocketQuit(n,e){let t=this.baseInfoMap.get(n);if(!t)return;let i=t.info,r=Date.now(),o=Tt(Tt(Tt({},i),e),{},{elapse:r-t.startTime,lts:r});this.send({type:Dt.WEBSOCKET_QUIT,data:o},!0)}async sendCustomReportMessage(n,e){if(this.customReportCount+=e.length,this.customReportCount>F("CUSTOM_REPORT_LIMIT"))throw new O(L.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));let t=Date.now(),i=e.map(r=>({type:Dt.USER_ANALYTICS,data:Tt(Tt({sid:n},r),{},{lts:t})}));try{F("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(i):await this.postDataToStatsCollector(i)}catch(r){throw y.error("send custom report message failed",r.toString()),new O(L.CUSTOM_REPORT_SEND_FAILED,r.message)}}sendApiInvoke(n){let e=F("NOT_REPORT_EVENT");if(n.tag&&z(e)&&z(e).call(e,n.tag))return!1;if(n.sid===null)return this.apiInvokeUploadPendingItems.push(n),!1;let t=this.baseInfoMap.get(n.sid);if(!t)return this.apiInvokeUploadPendingItems.push(n),!1;let{cname:i,uid:r,cid:o}=t.info,s;if(n.lts=n.lts||Date.now(),n.error)if(n.error instanceof O){let{code:c,message:d}=n.error;s=c||d||n.error.toString()}else s=n.error.toString();let a={invokeId:n.invokeId,sid:n.sid,cname:i,cid:o,uid:r,lts:n.lts,success:n.success,elapse:n.lts-t.startTime,execElapse:n.lts-n.apiInvokeTime,apiName:n.name,options:n.options?JSON.stringify(n.options):void 0,execStates:n.states?JSON.stringify(n.states):void 0,execResult:n.result?JSON.stringify(n.result):void 0,errorCode:n.error?s:void 0,errorMsg:n.error?JSON.stringify(n.error):void 0};return this.send({type:Dt.API_INVOKE,data:a},!1),!0}addSid(n){this.sids.add(n)}removeSid(n){this.sids.delete(n)}appendSessionId(){let n=this.apiInvokeUploadPendingItems;if(n.length===0)return;let e=Array.from(this.sids).find(t=>t!==null);e&&n.forEach(t=>{t&&(t.sid=e,this.sendApiInvoke(Object.assign({},t)))}),n.length=0}send(n,e){if(e)return this.keyEventUploadPendingItems.push(n),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(n),this.normalEventUploadPendingItems.length>F("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(n,e){let t=[],i=[];for(;n.length;){let o=n.shift();t.length<20?t.push(o):i.push(o)}n.push(...i);for(let o of[...t]){var r;this.ltsList.indexOf(o.data.lts)!==-1?(o.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(o.data.lts)):(this.ltsList.push(o.data.lts),Ka(r=this.ltsList).call(r,(s,a)=>s-a))}return e||(this.lastSendNormalEventTime=Date.now()),F("ENABLE_EVENT_REPORT")&&t.length&&(F("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(t):this.postDataToStatsCollector(t)).catch((o=>s=>{F("EVENT_REPORT_RETRY")&&(e?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(o):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(o),this.normalEventUploadPendingItems.length>F("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-F("NORMAL_EVENT_QUEUE_CAPACITY")),y.warning("report: drop normal events"))))})(t)),n}async postDataToStatsCollector2(n){Wi.networkState===Gi.OFFLINE&&await Z.race([Wi.onlineWaiter,fn(2*mr.maxRetryTimeout)]);let e=r=>{let o=new Uint8Array;return r.forEach(s=>{let a=Sv(JSON.stringify(s.data)),c=new ArrayBuffer(5),d=(h=>{let p=0;return Object.entries(Dt).forEach(f=>{let[m,g]=f;g===h.type&&(p=Xi[m])}),p})(s),l=new DataView(c);l.setUint16(0,a.byteLength,!0),l.setUint8(2,255&d),l.setUint8(3,d>>>8&255),l.setUint8(4,d>>>16&255),o=Tv(o,new Uint8Array(c)),o=Tv(o,a)}),o},t="event",i=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(F("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(t):"https://".concat(F("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(t);for(let r=0;r<2;r+=1){r===1&&(i=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(F("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(t):"https://".concat(F("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(t));try{await rT(i,{timeout:1e4,data:e(n),headers:Tt(Tt({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(o){if(r===1)throw o;continue}return}}async postDataToStatsCollector(n){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],t=(a=>{let c=a&&a.data.sid&&this.baseInfoMap.get(a.data.sid);return c&&c.info.vid&&+c.info.vid||0})(n[0]),i=t?void 0:this._aid,r={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:n.map(a=>JSON.stringify(a)),vid:t,aid:i};Wi.networkState===Gi.OFFLINE&&await Z.race([Wi.onlineWaiter,fn(2*mr.maxRetryTimeout)]);let o=e?"/events/proto-raws":"/events/messages",s=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(F("EVENT_REPORT_DOMAIN"),"&p=").concat(F("STATS_COLLECTOR_PORT"),"&d=").concat(o):"https://".concat(F("EVENT_REPORT_DOMAIN"),":").concat(F("STATS_COLLECTOR_PORT")).concat(o));for(let a=0;a<2;a+=1){a===1&&(s=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(F("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(F("STATS_COLLECTOR_PORT"),"&d=").concat(o):"https://".concat(F("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(F("STATS_COLLECTOR_PORT")).concat(o)));try{e?await xN(s,{timeout:1e4,data:r}):await rT(s,{timeout:1e4,data:r})}catch(c){if(a===1)throw c;continue}return}}createBaseInfo(n,e){let t=Object.assign({},jY);return t.sid=n,this.baseInfoMap.set(n,{info:t,startTime:e}),t}reportResourceTiming(n,e){let t=performance.getEntriesByName(n),i=t[t.length-1];i&&this.reportApiInvoke(e,{name:"Client.resourceTiming",options:i,tag:ct.TRACER}).onSuccess()}};Dv.on("REPORT_LOG_UPLOAD",n=>{n.networkState=Wi.networkState,_e.reportApiInvoke(null,{name:"logUploadError",options:n,tag:ct.TRACER}).onSuccess("logUploadError")});let H=class extends O{constructor(n){super(n,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),ai(this,"name","AgoraRTCException")}print(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(n,y)}throw(){super.throw(y)}},$={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1,supportSuppressLocalAudioPlayback:!1,supportRestrictOwnAudio:!1};function ot(){return $}function Mt(){return"setSinkId"in HTMLAudioElement.prototype&&(!F("RESTRICTION_SET_PLAYBACK_DEVICE")||(wc()||AN())&&!NN())}function aT(){return!$.supportUnifiedPlan||F("CHROME_FORCE_PLAN_B")&&Ud()}function kh(n){return!(ji()||bc(87)||aT()||!F("ENABLE_PRE_SUB")&&(n==null||!n.autoSubscribe||F("FORCE_DISABLE_AUTO_SUB")))}function Wf(n){return F("ENABLE_INSTANT_VIDEO")?F("ENABLE_INSTANT_VIDEO"):!(n==null||!n.autoSubscribe||F("FORCE_DISABLE_AUTO_SUB"))}function KN(){return navigator.mediaDevices&&"getSupportedConstraints"in navigator.mediaDevices}function YN(){if(KN()){let n=navigator.mediaDevices.getSupportedConstraints();return!(!("suppressLocalAudioPlayback"in n)||!n.suppressLocalAudioPlayback)}return Dr(141)||Tl(141)||Cu(141)}function zN(){if(KN()){let n=navigator.mediaDevices.getSupportedConstraints();return!(!("restrictOwnAudio"in n)||!n.restrictOwnAudio)}return Dr(141)||Tl(141)||Cu(125)}let In=function(n){return n.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",n.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",n.IOS_INTERRUPTION_START="ios-interruption-start",n.IOS_INTERRUPTION_END="ios-interruption-end",n.STATE_CHANGE="state-change",n}({});function zr(n,e,t){return{sampleRate:n,stereo:e,bitrate:t}}function Kt(n,e,t,i,r){return{width:n,height:e,frameRate:t,bitrateMin:i,bitrateMax:r}}function Pt(n,e,t,i,r){return{width:{max:n},height:{max:e},frameRate:t,bitrateMin:i,bitrateMax:r}}function Sa(n,e){return{numSpatialLayers:n,numTemporalLayers:e}}let qN={"90p":Kt(160,90),"90p_1":Kt(160,90),"120p":Kt(160,120,15,30,65),"120p_1":Kt(160,120,15,30,65),"120p_3":Kt(120,120,15,30,50),"120p_4":Kt(212,120),"180p":Kt(320,180,15,30,140),"180p_1":Kt(320,180,15,30,140),"180p_3":Kt(180,180,15,30,100),"180p_4":Kt(240,180,15,30,120),"240p":Kt(320,240,15,40,200),"240p_1":Kt(320,240,15,40,200),"240p_3":Kt(240,240,15,40,140),"240p_4":Kt(424,240,15,40,220),"360p":Kt(640,360,15,80,400),"360p_1":Kt(640,360,15,80,400),"360p_3":Kt(360,360,15,80,260),"360p_4":Kt(640,360,30,80,600),"360p_6":Kt(360,360,30,80,400),"360p_7":Kt(480,360,15,80,320),"360p_8":Kt(480,360,30,80,490),"360p_9":Kt(640,360,15,80,800),"360p_10":Kt(640,360,24,80,800),"360p_11":Kt(640,360,24,80,1e3),"480p":Kt(640,480,15,100,500),"480p_1":Kt(640,480,15,100,500),"480p_2":Kt(640,480,30,100,1e3),"480p_3":Kt(480,480,15,100,400),"480p_4":Kt(640,480,30,100,750),"480p_6":Kt(480,480,30,100,600),"480p_8":Kt(848,480,15,100,610),"480p_9":Kt(848,480,30,100,930),"480p_10":Kt(640,480,10,100,400),"720p":Kt(1280,720,15,120,1130),"720p_auto":Kt(1280,720,30,900,3e3),"720p_1":Kt(1280,720,15,120,1130),"720p_2":Kt(1280,720,30,120,2e3),"720p_3":Kt(1280,720,30,120,1710),"720p_5":Kt(960,720,15,120,910),"720p_6":Kt(960,720,30,120,1380),"1080p":Kt(1920,1080,15,120,2080),"1080p_1":Kt(1920,1080,15,120,2080),"1080p_2":Kt(1920,1080,30,120,3e3),"1080p_3":Kt(1920,1080,30,120,3150),"1080p_5":Kt(1920,1080,60,120,4780),"1440p":Kt(2560,1440,30,120,4850),"1440p_1":Kt(2560,1440,30,120,4850),"1440p_2":Kt(2560,1440,60,120,7350),"4k":Kt(3840,2160,30,120,8910),"4k_1":Kt(3840,2160,30,120,8910),"4k_3":Kt(3840,2160,60,120,13500)},GY={"480p":Pt(640,480,5),"480p_1":Pt(640,480,5),"480p_2":Pt(640,480,30),"480p_3":Pt(640,480,15),"720p":Pt(1280,720,5),"720p_auto":Kt(1280,720,30,900,3e3),"720p_1":Pt(1280,720,5),"720p_2":Pt(1280,720,30),"720p_3":Pt(1280,720,15),"1080p":Pt(1920,1080,5),"1080p_1":Pt(1920,1080,5),"1080p_2":Pt(1920,1080,30),"1080p_3":Pt(1920,1080,15)},WY={"1SL1TL":Sa(1,1),"3SL3TL":Sa(3,3),"2SL3TL":Sa(2,3)};function Oc(n){return n||(n="480p_1"),typeof n=="string"?Object.assign({},qN[n]):n}function Ta(n){return typeof n=="string"?Object.assign({},GY[n]):n}function Hf(n){return typeof n=="string"?Object.assign({},WY[n]):n}let Lv={speech_low_quality:zr(16e3,!1),speech_standard:zr(32e3,!1,18),music_standard:zr(48e3,!1),standard_stereo:zr(48e3,!0,56),high_quality:zr(48e3,!1,128),high_quality_stereo:zr(48e3,!0,192)};function kv(n){return typeof n=="string"?Object.assign({},Lv[n]):n}let Cl=[];function Mh(n){return xi(n,"mediaSource",["screen","window","application"]),!0}let Ue=function(n){return n.NEED_RENEGOTIATE="@need_renegotiate",n.NEED_REPLACE_TRACK="@need_replace_track",n.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",n.NEED_CLOSE="@need_close",n.NEED_ENABLE_TRACK="@need_enable_track",n.NEED_DISABLE_TRACK="@need_disable_track",n.NEED_SESSION_ID="@need_sid",n.SET_OPTIMIZATION_MODE="@set_optimization_mode",n.GET_STATS="@get_stats",n.GET_RTC_STATS="@get_rtc_stats",n.GET_LOW_VIDEO_TRACK="@get_low_video_track",n.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",n.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",n.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",n.NEED_MUTE_TRACK="@need_mute_track",n.NEED_UNMUTE_TRACK="@need_unmute_track",n}({}),Re=function(n){return n.SCREEN_TRACK="screen_track",n.CUSTOM_TRACK="custome_track",n.LOW_STREAM="low_stream",n.SCREEN_LOW_TRACK="screen_low_track",n}({}),ui=function(n){return n[n.HIGH_STREAM=0]="HIGH_STREAM",n[n.LOW_STREAM=1]="LOW_STREAM",n}({}),Kf=function(n){return n[n.HIGH_STREAM=0]="HIGH_STREAM",n[n.LOW_STREAM=1]="LOW_STREAM",n[n.HIGH_STREAM_LAYER1=4]="HIGH_STREAM_LAYER1",n[n.HIGH_STREAM_LAYER2=5]="HIGH_STREAM_LAYER2",n[n.HIGH_STREAM_LAYER3=6]="HIGH_STREAM_LAYER3",n[n.HIGH_STREAM_LAYER4=7]="HIGH_STREAM_LAYER4",n[n.HIGH_STREAM_LAYER5=8]="HIGH_STREAM_LAYER5",n[n.HIGH_STREAM_LAYER6=9]="HIGH_STREAM_LAYER6",n}({}),HY=function(n){return n[n.DISABLE=0]="DISABLE",n[n.LOW_STREAM=1]="LOW_STREAM",n[n.AUDIO_ONLY=2]="AUDIO_ONLY",n[n.HIGH_STREAM_LAYER1=3]="HIGH_STREAM_LAYER1",n[n.HIGH_STREAM_LAYER2=4]="HIGH_STREAM_LAYER2",n[n.HIGH_STREAM_LAYER3=5]="HIGH_STREAM_LAYER3",n[n.HIGH_STREAM_LAYER4=6]="HIGH_STREAM_LAYER4",n[n.HIGH_STREAM_LAYER5=7]="HIGH_STREAM_LAYER5",n[n.HIGH_STREAM_LAYER6=8]="HIGH_STREAM_LAYER6",n}({}),b_=function(n){return n.TRANSCEIVER_UPDATED="transceiver-updated",n.SEI_TO_SEND="sei-to-send",n.SEI_RECEIVED="sei-received",n.TRACK_UPDATED="track-updated",n}({}),Nc=function(n){return n.SOURCE_STATE_CHANGE="source-state-change",n.TRACK_ENDED="track-ended",n.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",n.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",n.CLOSED="closed",n}({}),Wo=function(n){return n.FIRST_FRAME_DECODED="first-frame-decoded",n.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",n.VIDEO_STATE_CHANGED="video-state-changed",n.PLAY_START="play-start",n.PLAY_END="play-end",n.FIRST_FRAME_RENDER="first-frame-render",n}({}),Ho=function(n){return n.AUDIO="audio",n.VIDEO="video",n.DATA="data",n}({}),No=function(n){return n.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",n.RECEIVE_TRACK_BUFFER="receive_track_buffer",n.ON_AUDIO_BUFFER="on_audio_buffer",n.UPDATE_SOURCE="update_source",n}({});(function(n){n.UPDATE_TRACK_SOURCE="update-track-source"})({});let ys={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},cT={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},Mv={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receivePacketsDiscarded:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},NU={uplinkNetworkQuality:0,downlinkNetworkQuality:0},DU={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},Do=function(n){return n.ON_TRACK="on_track",n.ON_NODE="on_node",n}({}),wr=function(n){return n.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",n.REQUEST_CONSTRAINTS="request_constraints",n}({}),Ko=function(n){return n.IDLE="IDLE",n.INITING="INITING",n.INITEND="INITEND",n}({}),Bd=function(n){return n.STATE_CHANGE="state_change",n.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",n.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",n.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",n}({}),tn=function(n){return n.NONE="none",n.INIT="init",n.CANPLAY="canplay",n.PLAYING="playing",n.PAUSED="paused",n.SUSPEND="suspend",n.STALLED="stalled",n.WAITING="waiting",n.ERROR="error",n.DESTROYED="destroyed",n.ABORT="abort",n.ENDED="ended",n.EMPTIED="emptied",n.LOADEDDATA="loadeddata",n}({}),Pr=function(n){return n[n.VideoStateStopped=0]="VideoStateStopped",n[n.VideoStateStarting=1]="VideoStateStarting",n[n.VideoStateDecoding=2]="VideoStateDecoding",n[n.VideoStateFrozen=3]="VideoStateFrozen",n}({}),Dc={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370},Yf=function(n){return n.OPEN="open",n.MESSAGE="message",n.CLOSE="close",n.CLOSING="closing",n.ERROR="error",n}({});function Wt(n,e,t,i,r){var o,s,a={};return Object.keys(i).forEach(function(c){a[c]=i[c]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=un(o=xI(s=t.slice()).call(s)).call(o,function(c,d){return d(n,e,c)||c},a),r&&a.initializer!==void 0&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),a.initializer===void 0?(Object.defineProperty(n,e,a),null):a}function X(n,e,t){return(e=function(i){var r=function(o,s){if(typeof o!="object"||!o)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(i);return typeof r=="symbol"?r:r+""}(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function re(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function ki(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?re(Object(t),!0).forEach(function(i){X(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):re(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}class Mi extends Ki{set _mediaStreamTrack(e){e!==this.mediaStreamTrack&&(this.safeEmit(b_.TRACK_UPDATED,e),this.mediaStreamTrack=e)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(e,t){super(),X(this,"trackMediaType",void 0),X(this,"_ID",void 0),X(this,"_rtpTransceiver",void 0),X(this,"_lowRtpTransceiver",void 0),X(this,"_hints",[]),X(this,"_isClosed",!1),X(this,"_originMediaStreamTrack",void 0),X(this,"mediaStreamTrack",void 0),X(this,"_external",{}),this._ID=t||vt(8,"track-"),this._originMediaStreamTrack=e,this.mediaStreamTrack=e,function(i){z(Cl).call(Cl,i)||Cl.push(i)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){return e||wu(()=>{var t;_e.reportApiInvoke(null,{name:Yi.GET_MEDIA_STREAM_TRACK,options:[],tag:ct.TRACER}).onSuccess(((t=this._mediaStreamTrack)===null||t===void 0?void 0:t.label)||"")},this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(e){return e===ui.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(e){let t=Cl.indexOf(e);t!==-1&&Cl.splice(t,1)}(this),this.emit(Nc.CLOSED),this.removeAllListeners(b_.SEI_RECEIVED)}_updateRtpTransceiver(e,t){if(t===ui.LOW_STREAM){if(this._lowRtpTransceiver===e)return;this._lowRtpTransceiver=e}else{if(this._rtpTransceiver===e)return;this._rtpTransceiver=e}this.emit(b_.TRANSCEIVER_UPDATED,e,t)}}class O_ extends Mi{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(e,t){super(e,t),X(this,"_enabled",!0),X(this,"_muted",!1),X(this,"_isExternalTrack",!1),X(this,"_isClosed",!1),X(this,"_enabledMutex",void 0),X(this,"processor",void 0),X(this,"_processorContext",void 0),X(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new mn("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var e,t;return(e=(t=this._originMediaStreamTrack)===null||t===void 0?void 0:t.label)!==null&&e!==void 0?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,y.debug("[".concat(this.getTrackId(),"] close")),this.emit(Ue.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(e,t){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=i,e!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await yt(this,Ue.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){y.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Nc.TRACK_ENDED)}stateCheck(e,t){if(y.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(t,"]")),oe(t,e),this._enabled&&this._muted&&e==="enabled"&&t===!1)throw new O(L.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",y);if(!this._enabled&&!this._muted&&e==="muted"&&t===!0)throw new O(L.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",y)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():Z.resolve([])}}let N_=window.AudioContext||window.webkitAudioContext,Uv,Is=null,Yt=new class extends Ki{constructor(){super(...arguments),X(this,"prevState",void 0),X(this,"curState",void 0),X(this,"currentTime",void 0),X(this,"currentTimeStuckAt",void 0),X(this,"interruptDetectorTrack",void 0),X(this,"onLocalAudioTrackMute",()=>{y.info("ios15-interruption-start"),this.emit(In.IOS_15_16_INTERRUPTION_START)}),X(this,"onLocalAudioTrackUnmute",async()=>{y.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?y.info("ios15-interruption-end-canceled"):(Is&&await Is.suspend(),this.emit(In.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(n){y.debug("webaudio bindInterruptDetectorTrack ".concat(n.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=n,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(n){y.debug("webaudio unbindInterruptDetectorTrack ".concat(n.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===n&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function Ei(){if(!Is){if(function(){if(!N_)return void y.error("your browser is not support web audio");y.info("create audio context");let n=ki({},F("WEBAUDIO_INIT_OPTIONS"));y.debug("audio context init option:",JSON.stringify(n)),Is=new N_(n),Yt.curState=Is.state,Is.onstatechange=()=>{Yt.prevState=Yt.curState,Yt.curState=Is?Is.state:void 0;let{prevState:e,curState:t}=Yt,i=t==="running",r=t==="interrupted",o=e==="running",s=e==="suspended",a=e==="interrupted",c=Zt().osVersion;(Ht()||ic())&&o&&r&&(y.info("ios".concat(c,"-interruption-start")),Yt.emit(In.IOS_INTERRUPTION_START)),(Ht()||ic())&&(s||a)&&i&&(y.info("ios".concat(c,"-interruption-end")),Yt.emit(In.IOS_INTERRUPTION_END)),e!==t&&Yt.emit(In.STATE_CHANGE,t,e)},setInterval(()=>{var e;let t=(e=Is)===null||e===void 0?void 0:e.currentTime;Yt.currentTime!==t?(Yt.currentTimeStuckAt&&(y.debug("AudioContext current time resume at ".concat(t)),Yt.currentTimeStuckAt=void 0),Yt.currentTime=t):(t!==Yt.currentTimeStuckAt&&(_e.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:t},tag:ct.TRACER}).onSuccess(),y.warning("AudioContext current time stuck at ".concat(t))),Yt.currentTimeStuckAt=t)},5e3),async function(e){let t=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"],i,r,o=!1,s=!1,a=!1;function c(T){e.state==="running"?d(!1):Ht()||ic()?e.state==="suspended"&&(d(!0),T&&e.resume().then(l,l)):e.state!=="closed"&&(d(!0),T&&e.resume().then(l,l))}function d(T){if(o!==T){o=T;for(let C=0,b=t;C<b.length;C+=1){let D=b[C];T?window.addEventListener(D,h,{capture:!0,passive:!0}):window.removeEventListener(D,h,{capture:!0,passive:!0})}}}function l(){c(!1)}function h(){c(!0)}function p(){let T;try{T=i.play(),T?T.then(g,g):(i.addEventListener("playing",g),i.addEventListener("abort",g),i.addEventListener("error",g))}catch{g()}}function f(T){a||(i.paused?T?(m(!1),a=!0,p()):m(!0):m(!1))}function m(T){if(s!==T){s=T;for(let C=0,b=t;C<b.length;C++){let D=b[C];T?window.addEventListener(D,S,{capture:!0,passive:!0}):window.removeEventListener(D,S,{capture:!0,passive:!0})}}}function g(){i.removeEventListener("playing",g),i.removeEventListener("abort",g),i.removeEventListener("error",g),a=!1,f(!1)}function S(){f(!0)}if(Ht()&&F("IOS_BG_TAG")){let T=e.createMediaStreamDestination(),C=document.createElement("div");C.innerHTML="<audio x-webkit-airplay='deny'></audio>",i=C.children.item(0),i.controls=!1,i.disableRemotePlayback=!0,i.preload="auto",i.srcObject=T.stream,r=()=>{if(F("IOS_AUTO_RESTART_BG_TAG")&&i&&i.srcObject&&!a&&(!i.paused||s!==!0)){i.paused||i.pause();try{a=!0,p()}catch{a=!1}return!0}},f(!0)}return Yt.on(In.STATE_CHANGE,function(){c(!0)}),c(!1),r}(Is).then(e=>{Uv=e})}(),!Is)throw new O(L.NOT_SUPPORTED,"can not create audio context");return Is}return Is}function Pc(n){if(function(){if(Pu!==null)return Pu;let i=Ei(),r=i.createBufferSource(),o=i.createGain(),s=i.createGain();r.connect(o),r.connect(s),r.disconnect(o);let a=!1;try{r.disconnect(o)}catch{a=!0}return r.disconnect(),Pu=a,a}())return;let e=n.connect,t=n.disconnect;n.connect=(i,r,o)=>{var s;return n._inputNodes||(n._inputNodes=[]),z(s=n._inputNodes).call(s,i)||(i instanceof AudioNode?(n._inputNodes.push(i),e.call(n,i,r,o)):e.call(n,i,r)),n},n.disconnect=(i,r,o)=>{t.call(n),i?Cv(n._inputNodes,i):n._inputNodes=[];for(let s of n._inputNodes)e.call(n,s)}}let Pu=null;function dT(n,e){let t=!1,i=1/e;if(F("DISABLE_WEBAUDIO")){let r=window.setInterval(()=>{t?window.clearInterval(r):n(performance.now()/1e3)},1e3*i)}else{let r=Ei(),o=r.createGain();o.gain.value=0,o.connect(r.destination);let s=()=>{if(t)return void(o=null);let a=r.createOscillator();a.onended=s,a.connect(o),a.start(0),a.stop(r.currentTime+i),n(r.currentTime)};s()}return()=>{t=!0}}class xv{constructor(){X(this,"context",void 0),X(this,"analyserNode",void 0),X(this,"sourceNode",void 0),this.context=Ei(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=e,e==null||e.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||Ht()||ic()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;let e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else{let i=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(i);for(let r=0;r<e.length;++r)e[r]=i[r]/128-1}let t=un(e).call(e,(i,r)=>i+r*r,0)/e.length;return Math.max(10*Math.log10(t)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,t;(e=this.sourceNode)===null||e===void 0||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(t=this.sourceNode)===null||t===void 0||t.connect(this.analyserNode)}catch{y.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class XN extends Ki{get processSourceNode(){return this.sourceNode}set processedNode(e){var t;if(!this.isDestroyed&&this._processedNode!==e){try{var i;(i=this.sourceNode)===null||i===void 0||i.disconnect(this.outputNode)}catch{}(t=this._processedNode)===null||t===void 0||t.disconnect(),this._processedNode=e,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),X(this,"outputNode",void 0),X(this,"outputTrack",void 0),X(this,"isPlayed",!1),X(this,"sourceNode",void 0),X(this,"context",void 0),X(this,"audioBufferNode",void 0),X(this,"destNode",void 0),X(this,"audioOutputLevel",0),X(this,"volumeLevelAnalyser",void 0),X(this,"_processedNode",void 0),X(this,"playNode",void 0),X(this,"isDestroyed",!1),X(this,"onNoAudioInput",void 0),X(this,"isNoAudioInput",!1),X(this,"_noAudioInputCount",0),this.context=Ei(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),Pc(this.outputNode),this.volumeLevelAnalyser=new xv}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=t=>{this.emit(No.ON_AUDIO_BUFFER,function(i){for(let r=0;r<i.outputBuffer.numberOfChannels;r+=1){let o=i.outputBuffer.getChannelData(r);for(let s=0;s<o.length;s+=1)o[s]=0}return i.inputBuffer}(t))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!ot().webAudioMediaStreamDest)throw new O(L.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){this.context.state!=="running"&&Au(()=>{Yt.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(e>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;Ht()||ic()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();let t=this.volumeLevelAnalyser.getAnalyserNode(),i;t.getFloatTimeDomainData?(i=new Float32Array(t.fftSize),t.getFloatTimeDomainData(i)):(i=new Uint8Array(t.fftSize),t.getByteTimeDomainData(i));let r=!1;for(let o=0;o<i.length;o++)i[o]!==0&&(r=!0);return r?(this.isNoAudioInput=!1,!0):(await fn(200),await this.checkHasAudioInput(e?e+1:1)&&r)}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var e,t;(e=this.processedNode)===null||e===void 0||e.disconnect(),(t=this.sourceNode)===null||t===void 0||t.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var e;this.processedNode?(e=this.processedNode)===null||e===void 0||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class Vv extends XN{get isFreeze(){return!1}constructor(e,t,i){var r;if(super(),X(this,"sourceNode",void 0),X(this,"track",void 0),X(this,"clonedTrack",void 0),X(this,"audioElement",void 0),X(this,"isCurrentTrackCloned",!1),X(this,"isRemoteTrack",!1),X(this,"originVolumeLevelAnalyser",void 0),X(this,"rebuildWebAudio",async()=>{if(y.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void y.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>y.info("resume success")),y.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();let a=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?a.stop():this.isCurrentTrackCloned=!0;let c=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(c),Pc(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();let d=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(d,this.context.currentTime),Pc(this.outputNode),this.emit(No.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=c,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),e.kind!=="audio")throw new O(L.UNEXPECTED_ERROR);this.track=e;let o=new MediaStream([this.track]);if(this.isRemoteTrack=!!t,this.sourceNode=this.context.createMediaStreamSource(o),Pc(this.sourceNode),i){let a=i.clone();a.enabled=!0,this.clonedTrack=a,y.debug("create an unmuted track ".concat(a.id," from the original track ").concat(i.id," to get the volume"));let c=this.context.createMediaStreamSource(new MediaStream([a]));Pc(c),this.originVolumeLevelAnalyser=new xv,this.originVolumeLevelAnalyser.updateSource(c)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=o;let s=Zt();t&&s.os===pr.IOS&&Number((r=s.osVersion)===null||r===void 0?void 0:r.split(".")[0])<15&&(Yt.on(In.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(a=>{a||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;let t=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(t),Pc(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(No.UPDATE_SOURCE),this.audioElement.srcObject=t}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),Yt.off("state-change",this.rebuildWebAudio),(e=this.originVolumeLevelAnalyser)===null||e===void 0||e.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){let t=e.clone();t.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=t),y.debug("create an unmuted track ".concat(t.id," from the original track ").concat(e.id," to get the volume"));let i=this.context.createMediaStreamSource(new MediaStream([t]));Pc(i),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(i)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function Fv(n,e,t){let i=(o,s)=>o?typeof o!="number"?o.max||o.exact||o.ideal||o.min||s:o:s,r={audio:!!t&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n,maxHeight:i(e.height,1080),maxWidth:i(e.width,1920)}}};return e.frameRate&&typeof e.frameRate!="number"?(r.video.mandatory.maxFrameRate=e.frameRate.max,r.video.mandatory.minFrameRate=e.frameRate.min):typeof e.frameRate=="number"&&(r.video.mandatory.maxFrameRate=e.frameRate),await navigator.mediaDevices.getUserMedia(r)}async function PU(n,e){let t=await LU(n.mediaSource),{sourceId:i,audio:r}=await function(o){let s=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new Z((a,c)=>{let d=document.createElement("div");d.innerText="share screen",d.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");let l=document.createElement("div");l.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");let h=document.createElement("div");h.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",h.setAttribute("style","height: 12%;");let p=document.createElement("div");p.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");let f=document.createElement("div");f.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");let m=document.createElement("button");m.innerHTML="cancel",m.setAttribute("style","width: 85px;"),m.onclick=()=>{document.body.removeChild(T);let C=new Error("NotAllowedError");C.name="NotAllowedError",c(C)};let g=s,S=document.createElement("div");if(s){let C=document.createElement("input");C.setAttribute("type","checkbox");let b=document.createElement("span");C.setAttribute("style","margin-right: 6px;"),b.innerText="Share audio",C.checked=g,C.onchange=()=>{g=C.checked},S.appendChild(C),S.appendChild(b)}f.appendChild(S),f.appendChild(m),l.appendChild(h),l.appendChild(p),l.appendChild(f);let T=document.createElement("div");T.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),T.appendChild(d),T.appendChild(l),document.body.appendChild(T),o.map(C=>{if(C.id){let b=document.createElement("div");b.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let D=C.thumbnail;try{let{width:x}=D.getSize();x>1920&&(D=D.resize({width:1920}))}catch(x){throw x&&x.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),x}b.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+D.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+C.name.replace(/[\u00A0-\u9999<>\&]/g,function(x){return"&#"+x.charCodeAt(0)+";"})+"</span>",b.onclick=()=>{document.body.removeChild(T),a({sourceId:C.id,audio:g})},p.appendChild(b)}})})}(t,e);return await Fv(i,n,r)}async function LU(n){let e=["window","screen"];n!=="application"&&n!=="window"||(e=["window"]),n==="screen"&&(e=["screen"]);let t=Df();if(!t)throw console.error("failed to fetch electron, please mount it to window"),new O(L.ELECTRON_IS_NULL);let i=null;try{var r;i=((r=t.desktopCapturer)===null||r===void 0?void 0:r.getSources({types:e}))||t.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:e})}catch{i=null}i&&i.then||(i=new Z((o,s)=>{t.desktopCapturer.getSources({types:e},(a,c)=>{a?s(a):o(c)})}));try{return await i}catch(o){throw new O(L.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,o.toString())}}let Bv=new mn("safari"),jv=!1,JN=!1;async function $s(n,e){let t=0,i=null;for(;t<2;)try{i=await Ra(n,e,t>0);break}catch(r){if(r instanceof O)throw y.error("[".concat(e,"] ").concat(r.toString())),r;let o=Gv(r.name||r.code||r,r.message);if(o.code===L.MEDIA_OPTION_INVALID){y.debug("[".concat(e,"] detect media option invalid, retry")),t+=1,await fn(500);continue}throw y.error("[".concat(e,"] ").concat(o.toString())),o}if(!i)throw new O(L.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return i}async function Ra(n,e,t){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new O(L.NOT_SUPPORTED,"can not find getUserMedia");t&&(n.video&&(delete n.video.width,delete n.video.height),n.screen&&(delete n.screen.width,delete n.screen.height));let i=ot(),r=new MediaStream;if(n.audioSource&&r.addTrack(n.audioSource),n.videoSource&&r.addTrack(n.videoSource),!n.audio&&!n.video&&!n.screen)return y.debug("Using Video Source/ Audio Source"),r;if(n.screen)if(Df())n.screen.sourceId?Lu(r,await Fv(n.screen.sourceId,n.screen,!!n.screenAudio)):Lu(r,await PU(n.screen,!!n.screenAudio));else if(wc()&&n.screen.extensionId&&n.screen.mandatory){if(!i.getStreamFromExtension)throw new O(L.NOT_SUPPORTED,"This browser does not support screen sharing");y.debug("[".concat(e,'] Screen access on chrome stable, looking for extension"'));let p=await(s=n.screen.extensionId,a=e,new Z((f,m)=>{try{chrome.runtime.sendMessage(s,{getStream:!0},g=>{if(!g||!g.streamId)return y.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),g),void m(new O(L.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));f(g.streamId)})}catch(g){y.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(s,")"),g.toString()),m(new O(L.CHROME_PLUGIN_NOT_INSTALL))}}));n.screen.mandatory.chromeMediaSourceId=p,Lu(r,await navigator.mediaDevices.getUserMedia({video:{mandatory:n.screen.mandatory}}))}else if(i.getDisplayMedia){var o;n.screen.mediaSource&&Mh(n.screen.mediaSource);let p={width:n.screen.width,height:n.screen.height,frameRate:n.screen.frameRate,displaySurface:(o=n.screen.displaySurface)!==null&&o!==void 0?o:n.screen.mediaSource==="screen"?"monitor":n.screen.mediaSource},{selfBrowserSurface:f,surfaceSwitching:m,systemAudio:g,preferCurrentTab:S,windowAudio:T,monitorTypeSurfaces:C}=n.screen,b={selfBrowserSurface:f,surfaceSwitching:m,systemAudio:g,preferCurrentTab:S,windowAudio:T,monitorTypeSurfaces:C};!f&&delete b.selfBrowserSurface,!m&&delete b.surfaceSwitching,!g&&delete b.systemAudio,!S&&delete b.preferCurrentTab,!T&&delete b.windowAudio,!C&&delete b.monitorTypeSurfaces,y.debug("[".concat(e,"] getDisplayMedia:"),JSON.stringify({video:p,audio:n.screenAudio,controls:b})),Lu(r,await navigator.mediaDevices.getDisplayMedia(ki({video:p,audio:n.screenAudio},b)))}else{if(!ji())throw y.error("[".concat(e,"] This browser does not support screenSharing")),new O(L.NOT_SUPPORTED,"This browser does not support screen sharing");{n.screen.mediaSource&&Mh(n.screen.mediaSource);let p={video:{mediaSource:n.screen.mediaSource,width:n.screen.width,height:n.screen.height,frameRate:n.screen.frameRate}};y.debug("[".concat(e,"] getUserMedia: ").concat(JSON.stringify(p))),Lu(r,await navigator.mediaDevices.getUserMedia(p))}}var s,a;if(!n.video&&!n.audio)return r;let c={video:n.video,audio:n.audio},d=F("MEDIA_DEVICE_CONSTRAINTS");if(d)try{typeof d=="string"&&(d=JSON.parse(d)),c=yv(c,d)}catch{}y.debug("[".concat(e,"] GetUserMedia"),JSON.stringify(c)),Zt();let l,h=null;(Cr()||Ht()||tT())&&(h=await Bv.lock());try{l=await navigator.mediaDevices.getUserMedia(c)}catch(p){throw h&&h(),p}return c.audio&&(jv=!0),c.video&&(JN=!0),Lu(r,l),h&&h(),r}function Gv(n,e){switch(n){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new O(L.MEDIA_OPTION_INVALID,"".concat(n,": ").concat(e));case"NotFoundError":case"DevicesNotFoundError":return new O(L.DEVICE_NOT_FOUND,"".concat(n,": ").concat(e));case"NotSupportedError":return new O(L.NOT_SUPPORTED,"".concat(n,": ").concat(e));case"NotReadableError":return new O(L.NOT_READABLE,"".concat(n,": ").concat(e));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new O(L.PERMISSION_DENIED,"".concat(n,": ").concat(e));case"ConstraintNotSatisfiedError":return new O(L.CONSTRAINT_NOT_SATISFIED,"".concat(n,": ").concat(e));default:return y.error("getUserMedia unexpected error",n),new O(L.UNEXPECTED_ERROR,"".concat(n,": ").concat(e))}}function Lu(n,e){let t=n.getVideoTracks()[0],i=n.getAudioTracks()[0],r=e.getVideoTracks()[0],o=e.getAudioTracks()[0];o&&(i&&n.removeTrack(i),n.addTrack(o)),r&&(t&&n.removeTrack(t),n.addTrack(r))}let Po=new class extends Ki{get state(){return this._state}set state(n){n!==this._state&&(this.emit(Bd.STATE_CHANGE,n),this._state=n)}constructor(){super(),X(this,"_state",Ko.IDLE),X(this,"isAccessMicrophonePermission",!1),X(this,"isAccessCameraPermission",!1),X(this,"lastAccessMicrophonePermission",!1),X(this,"lastAccessCameraPermission",!1),X(this,"checkdeviceMatched",!1),X(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(F("ENUMERATE_DEVICES_INTERVAL")||(ha()||$S()===pr.HARMONY_OS)&&Ud())&&this.updateDevicesInfo()},F("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(n=>y.error(n.toString()))}async enumerateDevices(n,e){let t=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)throw new O(L.NOT_SUPPORTED,"enumerateDevices() not supported.");let i=await navigator.mediaDevices.enumerateDevices(),r=this.checkMediaDeviceInfoIsOk(i),o=!this.isAccessMicrophonePermission&&n,s=!this.isAccessCameraPermission&&e;r.audio&&(o=!1),r.video&&(s=!1);let a=null,c=null,d=null;if(!t&&(o||s)){if(Bv.isLocked&&(y.debug("[device manager] wait GUM lock"),(await Bv.lock())(),y.debug("[device manager] GUM unlock")),jv&&(o=!1,this.isAccessMicrophonePermission=!0),JN&&(s=!1,this.isAccessCameraPermission=!0),y.debug("[device manager] check media device permissions",n,e,o,s),o&&s){try{d=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(l){let h=Gv(l.name||l.code||l,l.message);if(h.code===L.PERMISSION_DENIED)throw h;y.warning("getUserMedia failed in getDevices",h)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(o){try{a=await navigator.mediaDevices.getUserMedia({audio:n})}catch(l){let h=Gv(l.name||l.code||l,l.message);if(h.code===L.PERMISSION_DENIED)throw h;y.warning("getUserMedia failed in getDevices",h)}this.isAccessMicrophonePermission=!0}else if(s){try{c=await navigator.mediaDevices.getUserMedia({video:e})}catch(l){let h=Gv(l.name||l.code||l,l.message);if(h.code===L.PERMISSION_DENIED)throw h;y.warning("getUserMedia failed in getDevices",h)}this.isAccessCameraPermission=!0}y.debug("[device manager] mic permission",n,"cam permission",e)}try{let l=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach(h=>h.stop()),c&&c.getTracks().forEach(h=>h.stop()),d&&d.getTracks().forEach(h=>h.stop()),a=null,c=null,d=null,l}catch(l){return a&&a.getTracks().forEach(h=>h.stop()),c&&c.getTracks().forEach(h=>h.stop()),d&&d.getTracks().forEach(h=>h.stop()),a=null,c=null,d=null,new O(L.ENUMERATE_DEVICES_FAILED,l.toString()).throw()}}async getRecordingDevices(){let n=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,n)).filter(e=>e.kind==="audioinput")}async getCamerasDevices(){let n=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,n)).filter(e=>e.kind==="videoinput")}async getSpeakers(){let n=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,n)).filter(e=>e.kind==="audiooutput")}searchDeviceIdByName(n){let e=null;return this.deviceInfoMap.forEach(t=>{t.device.label===n&&(e=t.device.deviceId)}),e}async getDeviceById(n){let e=(await this.enumerateDevices(!0,!0,!0)).find(t=>t.deviceId===n);if(!e)throw new O(L.DEVICE_NOT_FOUND,"deviceId: ".concat(n));return e}async init(){this.state=Ko.INITING;try{await this.updateDevicesInfo(),this.state=Ko.INITEND}catch(n){throw this.state=Ko.IDLE,(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")?(y.warning("Device Detection functionality cannot start properly.",n.toString()),n):new O(L.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.")}}async updateDevicesInfo(){let n=await this.enumerateDevices(!0,!0,!0),e=Date.now(),t=[];if(n[0]&&n[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;let r=n.find(s=>s.kind==="audioinput"&&s.deviceId==="default"),o=n.find(s=>s.kind==="audiooutput"&&s.deviceId==="default");r&&o?o.groupId===r.groupId?y.debug("[device-check] default input ".concat(r.label," and output ").concat(o.label," is the same group")):y.debug("[device-check] default input ".concat(r.label," and output ").concat(o.label," is not the same group")):y.debug("[device-check] default input or output not found")}let i=this.checkMediaDeviceInfoIsOk(n);if(n.forEach(r=>{if(!r.deviceId)return;let o=this.deviceInfoMap.get("".concat(r.kind,"_").concat(r.deviceId));if((o?o.state:"INACTIVE")!=="ACTIVE"){let s={initAt:e,updateAt:e,device:r,state:"ACTIVE"};this.deviceInfoMap.set("".concat(r.kind,"_").concat(r.deviceId),s),t.push(s)}o&&(o.updateAt=e)}),this.deviceInfoMap.forEach((r,o)=>{r.state==="ACTIVE"&&r.updateAt!==e&&(r.state="INACTIVE",t.push(r))}),this.state!==Ko.INITEND)return i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));t.forEach(r=>{switch(r.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Bd.RECORDING_DEVICE_CHANGED,r);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(Bd.CAMERA_DEVICE_CHANGED,r);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Bd.PLAYOUT_DEVICE_CHANGED,r)}}),i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(n){let e=n.filter(r=>r.kind==="audioinput"),t=n.filter(r=>r.kind==="videoinput"),i={audio:!1,video:!1};for(let r of e)if(r.label&&r.deviceId){i.audio=!0;break}for(let r of t)if(r.label&&r.deviceId){i.video=!0;break}return i}},As=!1,Lo=new class extends Ki{constructor(){super(...arguments),X(this,"onAutoplayFailed",void 0),X(this,"onAudioAutoplayFailed",void 0)}};function Yo(){if(As)return F("FLS_AUTOPLAY_EMITS")?(Lo.onAutoplayFailed&&Lo.onAutoplayFailed(),Lo.emit("autoplay-failed")):void 0;{let n=e=>{e.preventDefault(),As=!1,yu()?document.body.removeEventListener("click",n,!0):(document.body.removeEventListener("touchstart",n,!0),document.body.removeEventListener("mousedown",n,!0))};As=!0,yu()?document.body.addEventListener("click",n,!0):(document.body.addEventListener("touchstart",n,!0),document.body.addEventListener("mousedown",n,!0)),y.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),Lo.onAutoplayFailed?Lo.onAutoplayFailed():Lo.onAudioAutoplayFailed?y.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):y.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),Lo.emit("autoplay-failed")}}function QN(n,e,t,i){if(!n)return;let r=_e.getBaseInfoBySessionId(n);if(!r)return;let o=r.info,s=Date.now(),a=ki(ki({},o),{},{vid:o.vid===void 0?0:Number(o.vid),lts:s,elapse:s-r.startTime,cbRegistered:Lo.onAutoplayFailed||Lo.onAudioAutoplayFailed?1:-1,errorMsg:t,mediaType:e,trackId:i,extend:void 0});_e.send({type:Dt.AUTOPLAY_FAILED,data:a},!0)}let kU=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],ko=new class{constructor(){X(this,"onAutoplayFailed",void 0),X(this,"elementMap",new Map),X(this,"elementStateMap",new Map),X(this,"elementsNeedToResume",[]),X(this,"sinkIdMap",new Map),X(this,"autoResumeAfterInterruption",n=>Z.all(Array.from(this.elementMap.entries()).map(async e=>{let[t,i]=e,r=this.elementStateMap.get(t),o=i.srcObject.getAudioTracks()[0],s=o&&o.readyState;if(y.debug("resume after interrupted, ele: ".concat(r," audio: ").concat(s," ").concat(n)),s==="live"){if(n)return i.pause(),i.play();if(Yt.curState==="running")return C_()?(i.pause(),i.play()):r&&r==="paused"?i.play():void 0}}))),X(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(n=>{let[e,t]=n,i=t.srcObject.getAudioTracks()[0];i&&i.readyState==="live"&&(y.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),t.pause(),t.play())})}),this.autoResumeAudioElement(),Yt.on(In.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Yt.on(In.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),Yt.on(In.STATE_CHANGE,()=>{Ht()&&Yt.prevState==="suspended"&&Yt.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(n,e){let t=this.elementMap.get(n);if(this.sinkIdMap.set(n,e),t)try{await t.setSinkId(e)}catch(i){throw new O(L.PERMISSION_DENIED,"can not set sink id: "+i.toString())}}play(n,e,t,i){if(this.elementMap.has(e))return;let r=document.createElement("audio");r.autoplay=!0,r.srcObject=new MediaStream([n]),this.bindAudioElementEvents(e,r),this.elementMap.set(e,r),this.elementStateMap.set(e,tn.INIT),this.setVolume(e,t);let o=this.sinkIdMap.get(e);if(o)try{r.setSinkId(o).catch(a=>{y.warning("[".concat(e,"] set sink id failed"),a.toString())})}catch(a){y.warning("[".concat(e,"] set sink id failed"),a.toString())}let s=r.play();s&&s.then&&s.catch(a=>{i&&QN(i,"audio",a.message,e),y.warning("audio element play warning",a.toString()),this.elementMap.has(e)&&a.name==="NotAllowedError"&&(y.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(r),Au(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),Yo()}))})}updateTrack(n,e){let t=this.elementMap.get(n);t&&(t.srcObject=new MediaStream([e]))}isPlaying(n){return this.elementMap.has(n)&&this.elementStateMap.get(n)==="playing"}setVolume(n,e){let t=this.elementMap.get(n);t&&(e=Math.max(0,Math.min(100,e)),t.volume=e/100)}getVolume(n){let e=this.elementMap.get(n);return e?e.volume:0}stop(n){let e=this.elementMap.get(n);if(this.sinkIdMap.delete(n),!e)return;let t=this.elementsNeedToResume.indexOf(e);this.elementsNeedToResume.splice(t,1),e.srcObject=null,e.remove(),this.elementMap.delete(n),this.elementStateMap.delete(n)}bindAudioElementEvents(n,e){kU.forEach(t=>{e.addEventListener(t,i=>{let r=this.elementStateMap.get(n),o=i.type==="pause"?"paused":i.type;if(y.debug("[".concat(n,"] audio-element-status change ").concat(r," => ").concat(o)),i.type==="error"){let s=e==null?void 0:e.error;s&&y.error("[".concat(n,"] media error, code: ").concat(s.code,", message: ").concat(s.message))}this.elementStateMap.set(n,o)})})}getPlayerState(n){return this.elementStateMap.get(n)||"uninit"}autoResumeAudioElement(){let n=()=>{this.elementsNeedToResume.forEach(e=>{e.play().then(t=>{y.debug("Auto resume audio element success")}).catch(t=>{y.warning("Auto resume audio element failed!",t)})}),this.elementsNeedToResume=[]};new Z(e=>{document.body?e():window.addEventListener("load",()=>e())}).then(()=>{yu()?document.body.addEventListener("click",n,!0):(document.body.addEventListener("touchstart",n,!0),document.body.addEventListener("mousedown",n,!0))})}};function pi(){return function(n,e,t){let i=t.value;return typeof i=="function"&&(t.value=function(){this._isClosed&&new O(L.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",y);for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];let a=i.apply(this,o);return a instanceof Z?new Z((c,d)=>{a.then(c).catch(d)}):a}),t}}class Tr extends Ki{constructor(e){super(),X(this,"name","VideoProcessorDestination"),X(this,"ID","0"),X(this,"_source",void 0),X(this,"videoContext",void 0),X(this,"inputTrack",void 0),this.videoContext=e}get kind(){return"video"}get enabled(){return!0}pipe(){throw new O(L.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new O(L.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(Do.ON_TRACK,e.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(Do.ON_TRACK,void 0)}}class ZN extends Ki{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,t){super(),X(this,"constraintsMap",new Map),X(this,"statsRegistry",[]),X(this,"usageRegistry",[]),X(this,"trackId",void 0),X(this,"direction",void 0),X(this,"_chained",!1),this.trackId=e,this.direction=t}async getConstraints(){return await fr(this,wr.REQUEST_CONSTRAINTS)}async requestApplyConstraints(e,t){var i;return y.info("processor ".concat(t.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(t,e),yt(this,wr.REQUEST_UPDATE_CONSTRAINTS,Array.from(Vr(i=this.constraintsMap).call(i)))}async requestRevertConstraints(e){var t;if(this.constraintsMap.has(e))return y.info("processor ".concat(e.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(e),yt(this,wr.REQUEST_UPDATE_CONSTRAINTS,Array.from(Vr(t=this.constraintsMap).call(t)))}registerStats(e,t,i){this.statsRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===t)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:t,cb:i})}unregisterStats(e,t){let i=this.statsRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===t);i!==-1&&this.statsRegistry.splice(i,1)}gatherStats(){let e=[];for(let{processorID:t,processorName:i,type:r,cb:o}of this.statsRegistry)try{let s=o();e.push({processorID:t,processorName:i,type:r,stats:s})}catch(s){y.error(new O(L.UNEXPECTED_ERROR,s.message))}return e}registerUsage(e,t){this.usageRegistry.find(i=>i.processorID===e.ID&&i.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:t})}unregisterUsage(e){let t=this.usageRegistry.findIndex(i=>i.processorID===e.ID&&i.processorName===e.name);t!==-1&&this.usageRegistry.splice(t,1)}async gatherUsage(){let e=[];if(!this.chained)return[];for(let{cb:t}of this.usageRegistry)try{let i=t();i instanceof Z&&(i=await i),e.push(ki(ki({},i),{},{direction:this.direction}))}catch(i){y.error("gather extension usage error",i)}return e}getDirection(){return this.direction}}class $N extends Ki{constructor(e){super(),X(this,"name","AudioProcessorDestination"),X(this,"ID","0"),X(this,"inputTrack",void 0),X(this,"inputNode",void 0),X(this,"audioProcessorContext",void 0),X(this,"_source",void 0),this.audioProcessorContext=e}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new O(L.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new O(L.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(Do.ON_TRACK,void 0),this.emit(Do.ON_NODE,void 0)}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(Do.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(Do.ON_NODE,this.inputNode))}}class eD extends Ki{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,t,i){super(),X(this,"constraintsMap",new Map),X(this,"statsRegistry",[]),X(this,"audioContext",void 0),X(this,"trackId",void 0),X(this,"direction",void 0),X(this,"usageRegistry",[]),X(this,"_chained",!1),this.audioContext=e,this.trackId=t,this.direction=i}async getConstraints(){return fr(this,wr.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(e,t){var i;return y.info("processor ".concat(t.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(t,e),yt(this,wr.REQUEST_UPDATE_CONSTRAINTS,Array.from(Vr(i=this.constraintsMap).call(i)))}async requestRevertConstraints(e){var t;if(this.constraintsMap.has(e))return this.constraintsMap.delete(e),yt(this,wr.REQUEST_UPDATE_CONSTRAINTS,Array.from(Vr(t=this.constraintsMap).call(t)))}registerStats(e,t,i){this.statsRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===t)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:t,cb:i})}unregisterStats(e,t){let i=this.statsRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===t);i!==-1&&this.statsRegistry.splice(i,1)}gatherStats(){let e=[];for(let{processorID:t,processorName:i,type:r,cb:o}of this.statsRegistry)try{let s=o();e.push({processorID:t,processorName:i,type:r,stats:s})}catch(s){y.error(new O(L.UNEXPECTED_ERROR,s.message))}return e}registerUsage(e,t){this.usageRegistry.find(i=>i.processorID===e.ID&&i.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:t})}unregisterUsage(e){let t=this.usageRegistry.findIndex(i=>i.processorID===e.ID&&i.processorName===e.name);t!==-1&&this.usageRegistry.splice(t,1)}async gatherUsage(){let e=[];if(!this.chained)return[];for(let{cb:t}of this.usageRegistry)try{let i=t();i instanceof Z&&(i=await i),e.push(ki(ki({},i),{},{direction:this.direction}))}catch(i){y.error("gather extension usage error",i)}return e}getDirection(){return this.direction}}class Wv extends Ki{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),X(this,"context",void 0),X(this,"processSourceNode",void 0),X(this,"outputTrack",void 0),X(this,"processedNode",void 0),X(this,"clonedTrack",void 0),X(this,"outputNode",void 0),this.outputNode=new tD}setVolume(){}createOutputTrack(){throw new O(L.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class tD{disconnect(){}connect(){}}function MU(n){return new Z((e,t)=>{let i=!1,r=document.createElement("video");r.setAttribute("autoplay",""),r.setAttribute("muted",""),r.muted=!0,r.autoplay=!0,r.setAttribute("playsinline",""),r.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(r);let o=Ht()?"canplay":"playing";r.addEventListener(o,()=>{let s=r.videoWidth,a=r.videoHeight;!s&&ji()||(i=!0,r.srcObject=null,r.remove(),e([s,a]))}),r.srcObject=new MediaStream([n]),r.play().catch(Fd),setTimeout(()=>{i||(r.srcObject=null,r.remove(),e([r.videoWidth,r.videoHeight]))},4e3)})}function lT(n){let e={};n.facingMode&&(e.facingMode=n.facingMode),n.cameraId&&(e.deviceId={exact:n.cameraId});let t=Oc(n.encoderConfig);return t.width!=null&&(e.width=t.width),t.height!=null&&(e.height=t.height),!ON()&&t.frameRate&&(e.frameRate=t.frameRate),AN()&&typeof e.frameRate=="object"&&(e.frameRate.max=60),ji()&&(e.frameRate={ideal:30,max:30}),e}function uT(n){let e={};return ON()||(n.AGC!==void 0&&(e.autoGainControl=n.AGC),n.AEC!==void 0&&(e.echoCancellation=n.AEC),n.ANS!==void 0&&(e.noiseSuppression=n.ANS,wc()&&n.ANS&&(e.googHighpassFilter=n.ANS))),e}function iD(n){let e=uT(n);if(n.encoderConfig){let t=kv(n.encoderConfig);e.channelCount=t.stereo?2:1,e.sampleRate=t.sampleRate,e.sampleSize=t.sampleSize}return n.microphoneId&&(e.deviceId={exact:n.microphoneId}),ha()&&(e.sampleRate=void 0),e}let rD=n=>{let e=n._encoderConfig;if(!e)return;let{frameRate:t,width:i,height:r}=n.getMediaStreamTrackSettings(),{frameRate:o=t,width:s=i,height:a=r}=e;if(!o||!s||!a)return;s=A_(s),a=A_(a),o=A_(o);let{max:c,min:d}=function(f,m,g){let S=200*Math.pow(g/15,.6)*Math.pow(f*m/640/360,.75);return{min:Math.floor(S),max:Math.floor(4*S)}}(s,a,o),{bitrateMax:l,bitrateMin:h}=e||{};l||y.debug("calculate bitrate: [w: ".concat(s,", h: ").concat(a,", fps: ").concat(o,"] => [brMax: ").concat(l,", brMin: ").concat(h,"]"));let{maxFramerate:p}=F("ENCODER_CONFIG_LIMIT");return p&&typeof p=="number"&&(o=Math.min(o,p)),{frameRate:o,bitrateMax:l||c,bitrateMin:h||d,scaleResolutionDownBy:1,scale:0}},nD=async(n,e,t)=>await(async(i,r,o)=>{let s=function(d){let l=[];for(let h=0;h<d.length;h+=2)l.push(parseInt(d.slice(h,h+2),16));return Uint8Array.from(l)}(Av(""+r+o)).slice(0,16),a=s.slice(0,12),c=await window.crypto.subtle.importKey("raw",s,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},c,i))})(n.buffer,e,t),Hv=n=>{let e=document.createElement("canvas");return e.width=2,e.height=2,new Z((t,i)=>{e.toBlob(async r=>{if(e.remove(),r){let o=await Kv(r);t({buffer:o,width:e.width,height:e.height})}else i(new O(L.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},n,1)})},Kv=async n=>{let e=await n.arrayBuffer();return new Uint8Array(e)};var oD,sD,aD,cD,dD,lD,uD,hD,pD,_D,fD,mD,ED,gD,SD,TD,RD,vD,nr,or,CD,yD,ID,AD,wD,jd,Gd,bD,OD,ND,DD,PD,LD,kD,MD,UD,xD,VD,FD,Gn;let ri=(oD=Xe({argsMap:(n,e)=>[n.getTrackId(),e],throttleTime:300}),sD=Xe({argsMap:(n,e)=>[n.getTrackId(),e]}),aD=pi(),cD=jr("LocalAudioTrack","_enabledMutex"),dD=Xe({argsMap:(n,e)=>[n.getTrackId(),e]}),lD=pi(),uD=jr("LocalAudioTrack","_enabledMutex"),hD=Xe({argsMap:(n,e)=>[n.getTrackId(),e]}),pD=pi(),_D=pi(),fD=pi(),mD=Xe({argsMap:n=>[n.getTrackId()]}),ED=pi(),gD=Xe({argsMap:n=>[n.getTrackId()]}),SD=pi(),TD=Xe({argsMap:n=>[n.getTrackId()]}),RD=Xe({argsMap:(n,e)=>[n.getTrackId(),e.name]}),vD=Xe({argsMap:n=>[n.getTrackId()]}),Wt((nr=class extends O_{get _source(){return this.initWebAudio()}set _source(n){this._trackSource=n}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?ko.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(n,e,t,i){super(n,t),X(this,"trackMediaType",Ho.AUDIO),X(this,"_encoderConfig",void 0),X(this,"_trackSource",void 0),X(this,"metadata",[]),X(this,"_enabled",!0),X(this,"_volume",100),X(this,"_useAudioElement",!0),X(this,"_bypassWebAudio",!1),X(this,"processor",void 0),X(this,"_processorContext",void 0),X(this,"_processorDestination",void 0),X(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=e,this._getOriginVolumeLevel=!!i,this._trackSource=new Wv,F("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),F("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),Cr()&&!Is?setTimeout(()=>this.initWebAudio()):this.initWebAudio()}setVolume(n){Rt(n,"volume",0,1e3),this._volume=n,this._source.setVolume(n/100),this._useAudioElement&&ko.setVolume(this.getTrackId(),n);try{if(this._bypassWebAudio)return void y.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));let e=this._source.createOutputTrack();this._mediaStreamTrack!==e&&(this._mediaStreamTrack=e,yt(this,Ue.NEED_REPLACE_TRACK,this).then(()=>{y.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(t=>{y.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),t)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(n){if(!this._useAudioElement||!Mt())throw new O(L.NOT_SUPPORTED,"your browser does not support setting the audio output device");await ko.setSinkID(this.getTrackId(),n)}async setEnabled(n,e,t){return this._setEnabled(n,e,t)}async _setEnabled(n,e,t){if(!t){if(n===this._enabled)return;this.stateCheck("enabled",n)}if(y.info("[".concat(this.getTrackId(),"] start setEnabled"),n),n){this._originMediaStreamTrack.enabled=!0;try{t||(this._enabled=!0),await yt(this,Ue.NEED_ENABLE_TRACK,this),y.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(n," success"))}catch(i){throw t||(this._enabled=!1),y.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}}else{this._originMediaStreamTrack.enabled=!1,t||(this._enabled=!1);try{await yt(this,Ue.NEED_DISABLE_TRACK,this)}catch(i){throw t||(this._enabled=!0),y.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}}}async setMuted(n){n!==this._muted&&(this.stateCheck("muted",n),this._muted=n,this._originMediaStreamTrack.enabled=!n,y.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(n)),n?await yt(this,Ue.NEED_MUTE_TRACK,this):await yt(this,Ue.NEED_UNMUTE_TRACK,this))}getStats(){return wu(()=>{y.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),Xt(this,Ue.GET_STATS)||ki({},ys)}setAudioFrameCallback(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!n)return this._source.removeAllListeners(No.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(No.ON_AUDIO_BUFFER),this._source.on(No.ON_AUDIO_BUFFER,t=>n(t))}play(){y.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(y.debug("[".concat(this.getTrackId(),"] start audio playback in element")),ko.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){y.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?ko.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let n=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];y.debug("[".concat(this.getTrackId(),"] update player source track")),n&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&ko.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(n,e){this._originMediaStreamTrack!==n&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop()),n.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=n,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:n,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await yt(this,Ue.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(n))}renewMediaStreamTrack(n){return Z.resolve(void 0)}pipe(n){if(this._bypassWebAudio)throw new O(L.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===n)return n;if(n._source)throw new O(L.INVALID_OPERATION,"Processor ".concat(n.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=n,this.processor._source=this,n.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),n}unpipe(){var n;if(!this.processor)return;let e=this.processor;(n=this._source.processSourceNode)===null||n===void 0||n.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(n){n.on(Do.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e),await yt(this,Ue.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await yt(this,Ue.NEED_REPLACE_TRACK,this))}),n.on(Do.ON_NODE,e=>{this._source.processedNode=e})}unbindProcessorDestinationEvents(n){n.removeAllListeners(Do.ON_TRACK),n.removeAllListeners(Do.ON_NODE)}bindProcessorContextEvents(n){n.on(wr.REQUEST_CONSTRAINTS,async e=>{e(this._originMediaStreamTrack.getSettings())})}unbindProcessorContextEvents(n){n.removeAllListeners(wr.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof Wv&&(this._trackSource=new Vv(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){let n=new eD(this._source.context,this.getTrackId(),"local"),e=new $N(n);return this._processorContext=n,this._processorDestination=e,this.bindProcessorContextEvents(n),this.bindProcessorDestinationEvents(e),this._source.on(No.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:n})}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(ko.stop(this.getTrackId()),this._source.play()),yt(this,Ue.NEED_REPLACE_MIXING_TRACK,this).then(()=>{y.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))}).catch(t=>{y.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),t)})),{processorContext:n,processorDestination:e}}}).prototype,"setVolume",[oD],Object.getOwnPropertyDescriptor(nr.prototype,"setVolume"),nr.prototype),Wt(nr.prototype,"setPlaybackDevice",[sD,aD],Object.getOwnPropertyDescriptor(nr.prototype,"setPlaybackDevice"),nr.prototype),Wt(nr.prototype,"setEnabled",[cD,dD,lD],Object.getOwnPropertyDescriptor(nr.prototype,"setEnabled"),nr.prototype),Wt(nr.prototype,"setMuted",[uD,hD,pD],Object.getOwnPropertyDescriptor(nr.prototype,"setMuted"),nr.prototype),Wt(nr.prototype,"getStats",[_D],Object.getOwnPropertyDescriptor(nr.prototype,"getStats"),nr.prototype),Wt(nr.prototype,"setAudioFrameCallback",[fD],Object.getOwnPropertyDescriptor(nr.prototype,"setAudioFrameCallback"),nr.prototype),Wt(nr.prototype,"play",[mD,ED],Object.getOwnPropertyDescriptor(nr.prototype,"play"),nr.prototype),Wt(nr.prototype,"stop",[gD,SD],Object.getOwnPropertyDescriptor(nr.prototype,"stop"),nr.prototype),Wt(nr.prototype,"close",[TD],Object.getOwnPropertyDescriptor(nr.prototype,"close"),nr.prototype),Wt(nr.prototype,"pipe",[RD],Object.getOwnPropertyDescriptor(nr.prototype,"pipe"),nr.prototype),Wt(nr.prototype,"unpipe",[vD],Object.getOwnPropertyDescriptor(nr.prototype,"unpipe"),nr.prototype),nr),Zi=(or=Xe({argsMap:(n,e)=>[n.getTrackId(),e]}),CD=pi(),yD=jr("MicrophoneAudioTrack","_enabledMutex"),ID=Xe({argsMap:(n,e,t)=>[n.getTrackId(),e,t]}),AD=pi(),wD=Xe({argsMap:n=>[n.getTrackId()]}),Wt((jd=class extends ri{get __className__(){return"MicrophoneAudioTrack"}constructor(n,e,t,i){super(n,e.encoderConfig?kv(e.encoderConfig):{},i,F("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),X(this,"_config",void 0),X(this,"_deviceName","default"),X(this,"_constraints",void 0),X(this,"_originalConstraints",void 0),X(this,"_enabled",!0),this._config=e,this._constraints=t,this._originalConstraints=t,this._deviceName=n.label,typeof e.bypassWebAudio=="boolean"&&(this._bypassWebAudio=e.bypassWebAudio),(C_()||wh())&&Yt.bindInterruptDetectorTrack(this)}async setDevice(n){if(y.info("[".concat(this.getTrackId(),"] start set device to ").concat(n)),this._enabled)try{let e=await Po.getDeviceById(n),t={};t.audio=ki({},this._constraints),t.audio.deviceId={exact:n},this._originMediaStreamTrack.stop();let i=null;try{i=await $s(t,this.getTrackId())}catch(r){throw y.error("[".concat(this.getTrackId(),"] setDevice failed"),r.toString()),i=await $s({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),this._deviceName=e.label,this._config.microphoneId=n,this._constraints.deviceId={exact:n}}catch(e){throw y.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{let e=await Po.getDeviceById(n);this._deviceName=e.label,this._config.microphoneId=n,this._constraints.deviceId={exact:n}}catch(e){throw y.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}y.info("[".concat(this.getTrackId(),"] set device to ").concat(n," success"))}async setEnabled(n,e,t){if(e)return y.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(n);if(!t){if(n===this._enabled)return;this.stateCheck("enabled",n)}if(y.info("[".concat(this.getTrackId(),"] start setEnabled"),n),F("AUTO_RESET_AUDIO_ROUTE")&&(Ht()||ic())){let s=navigator.audioSession;s&&(n||(s.type="playback"),s.type="auto")}if(!n){var i;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(i=this._source.clonedTrack)===null||i===void 0||i.stop(),t||(this._enabled=!1);try{await yt(this,Ue.NEED_DISABLE_TRACK,this)}catch(s){throw y.error("[".concat(this.getTrackId(),"] setEnabled false failed"),s.toString()),s}return}let r=ki({},this._constraints),o=Po.searchDeviceIdByName(this._deviceName);o&&!r.deviceId&&(r.deviceId=o);try{t||(this._enabled=!0);let s=await $s({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(s.getAudioTracks()[0],!1),await yt(this,Ue.NEED_ENABLE_TRACK,this)}catch(s){throw t||(this._enabled=!1),y.error("[".concat(this.getTrackId(),"] setEnabled true failed"),s.toString()),s}y.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(C_()||wh())&&Yt.unbindInterruptDetectorTrack(this),Cl.some(n=>function(e){return"__className__"in e&&e.__className__==="MicrophoneAudioTrack"}(n))||Uv&&Uv()&&(_e.reportApiInvoke(null,{name:"BG_AUDIO_TAG_RESTART",options:{},tag:ct.TRACER}).onSuccess(),y.debug("restart background audio tag success"))}onTrackEnded(){if((Ht()||ic())&&this._enabled&&!this._isClosed&&Yt.duringInterruption){let n=async()=>{Yt.off(In.IOS_INTERRUPTION_END,n),this._enabled&&!this._isClosed&&(y.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Yt.on(In.IOS_INTERRUPTION_END,n)}else y.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Nc.TRACK_ENDED)}async renewMediaStreamTrack(n){let e=n||this._constraints,t=Po.searchDeviceIdByName(this._deviceName);if(t&&!e.deviceId&&(e.deviceId=t),this._constraints=e,this._enabled){this._originMediaStreamTrack.stop();let i=await $s({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!0)}}bindProcessorContextEvents(n){super.bindProcessorContextEvents(n),n.on(wr.REQUEST_UPDATE_CONSTRAINTS,async(e,t,i)=>{try{let r=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(r),t()}catch(r){i(r)}})}unbindProcessorContextEvents(n){super.unbindProcessorContextEvents(n),n.removeAllListeners(wr.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[or,CD],Object.getOwnPropertyDescriptor(jd.prototype,"setDevice"),jd.prototype),Wt(jd.prototype,"setEnabled",[yD,ID,AD],Object.getOwnPropertyDescriptor(jd.prototype,"setEnabled"),jd.prototype),Wt(jd.prototype,"close",[wD],Object.getOwnPropertyDescriptor(jd.prototype,"close"),jd.prototype),jd),hT=(Gd=Xe({argsMap:(n,e)=>[n.getTrackId(),e,n.duration]}),bD=pi(),OD=Xe({argsMap:n=>[n.getTrackId()]}),ND=pi(),DD=Xe({argsMap:n=>[n.getTrackId()]}),PD=pi(),LD=Xe({argsMap:n=>[n.getTrackId()]}),kD=pi(),MD=Xe({argsMap:n=>[n.getTrackId()]}),UD=pi(),xD=Xe({argsMap:n=>[n.getTrackId()]}),VD=Xe({argsMap:n=>[n.getTrackId()]}),FD=pi(),Wt((Gn=class extends ri{get __className__(){return"BufferSourceAudioTrack"}constructor(n,e,t,i){super(e.createOutputTrack(),t,i),X(this,"source",void 0),X(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=n,this._bufferSource=e,this._bufferSource.on(No.AUDIO_SOURCE_STATE_CHANGE,r=>{this.safeEmit(Nc.SOURCE_STATE_CHANGE,r)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(n){n&&this._bufferSource.updateOptions(n),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(n){this._bufferSource.seekAudioBuffer(n)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(n){Rt(n,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(n)}}).prototype,"startProcessAudioBuffer",[Gd,bD],Object.getOwnPropertyDescriptor(Gn.prototype,"startProcessAudioBuffer"),Gn.prototype),Wt(Gn.prototype,"pauseProcessAudioBuffer",[OD,ND],Object.getOwnPropertyDescriptor(Gn.prototype,"pauseProcessAudioBuffer"),Gn.prototype),Wt(Gn.prototype,"seekAudioBuffer",[DD,PD],Object.getOwnPropertyDescriptor(Gn.prototype,"seekAudioBuffer"),Gn.prototype),Wt(Gn.prototype,"resumeProcessAudioBuffer",[LD,kD],Object.getOwnPropertyDescriptor(Gn.prototype,"resumeProcessAudioBuffer"),Gn.prototype),Wt(Gn.prototype,"stopProcessAudioBuffer",[MD,UD],Object.getOwnPropertyDescriptor(Gn.prototype,"stopProcessAudioBuffer"),Gn.prototype),Wt(Gn.prototype,"close",[xD],Object.getOwnPropertyDescriptor(Gn.prototype,"close"),Gn.prototype),Wt(Gn.prototype,"setAudioBufferPlaybackSpeed",[VD,FD],Object.getOwnPropertyDescriptor(Gn.prototype,"setAudioBufferPlaybackSpeed"),Gn.prototype),Gn);class rn extends ri{get __className__(){return"MixingAudioTrack"}get isActive(){for(let e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return!0;return!1}constructor(){let e=Ei().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,vt(8,"track-mix-")),X(this,"trackList",void 0),X(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=e,this.trackList=[]}hasAudioTrack(e){return this.trackList.indexOf(e)!==-1}addAudioTrack(e){this.trackList.indexOf(e)===-1?(y.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):y.debug("track ".concat(e.getTrackId()," is already added"))}removeAudioTrack(e){if(this.trackList.indexOf(e)!==-1){y.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode)}catch{}Cv(this.trackList,e),this.updateEncoderConfig()}}updateEncoderConfig(){let e={};this.trackList.forEach(t=>{t._encoderConfig&&((t._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=t._encoderConfig.bitrate),(t._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=t._encoderConfig.sampleRate),(t._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=t._encoderConfig.sampleSize),t._encoderConfig.stereo&&(e.stereo=!0))}),this._encoderConfig=e}_updateRtpTransceiver(e){this._rtpTransceiver!==e&&(this._rtpTransceiver=e,this.trackList.forEach(t=>{t instanceof rn?t.emit(b_.TRANSCEIVER_UPDATED,e):t._updateRtpTransceiver(e)}))}}class nn extends XN{set currentState(e){e!==this._currentState&&(this._currentState=e,this.safeEmit(No.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),X(this,"audioBuffer",void 0),X(this,"sourceNode",void 0),X(this,"startPlayTime",0),X(this,"startPlayOffset",0),X(this,"pausePlayTime",0),X(this,"options",void 0),X(this,"currentLoopCount",0),X(this,"currentPlaybackSpeed",100),X(this,"_currentState","stopped"),this.audioBuffer=e,this.options=t,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(e){this.currentState==="stopped"?(this.options=e,this.startPlayOffset=this.options.startPlayTime||0):y.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(e){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=e,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=e))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(e){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=e/100),this.currentPlaybackSpeed=e}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){let e=this.context.createBufferSource();return e.buffer=this.audioBuffer,e.loop=!!this.options.loop,e.connect(this.outputNode),e.playbackRate.value=this.currentPlaybackSpeed/100,e}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}let UU=new Map;function BD(n,e){if(n.length===0||e.length===0)return 1/0;let t=iT(n),i=iT(e);return Math.floor(i/t)}class Yv{get rendFrameRate(){let e=Math.max(1,BD(this._render_interframe_delays_sizes,this._render_interframe_delays));return Math.floor(1e3/e)}get videoElementStatus(){return this._isInPage?this._videoElementStatus:tn.DESTROYED}set videoElementStatus(e){e!==this._videoElementStatus&&(y.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e)}get videoState(){return this._videoState}set videoState(e){var t;e!==this._videoState&&(this._videoState=e,(t=this.onVideoStateChanged)===null||t===void 0||t.call(this,this.videoState))}constructor(e){X(this,"trackId",void 0),X(this,"config",void 0),X(this,"onFirstVideoFrameDecoded",void 0),X(this,"onFirstVideoFrameRender",void 0),X(this,"onVideoBufferReady",void 0),X(this,"onVideoStateChanged",void 0),X(this,"freezeTimeCounterList",[]),X(this,"renderFreezeAccTime",0),X(this,"renderFreezeAccTime2",0),X(this,"isKeepLastFrame",!1),X(this,"isDestroyed",!1),X(this,"timeUpdatedCount",0),X(this,"freezeTime",0),X(this,"playbackTime",0),X(this,"lastTimeUpdatedTime",0),X(this,"autoplayFailed",!1),X(this,"videoTrack",void 0),X(this,"videoElement",void 0),X(this,"cacheVideoElement",void 0),X(this,"cancelRVFId",void 0),X(this,"internal",!1),X(this,"_render_interframe_delays",[]),X(this,"_render_interframe_delays_sizes",[]),X(this,"_videoState",Pr.VideoStateStopped),X(this,"videoElementCheckInterval",void 0),X(this,"videoElementFreezeTimeout",void 0),X(this,"_videoElementStatus",tn.NONE),X(this,"_isInPage",!0),X(this,"isGettingVideoDimensions",!1),X(this,"startGetVideoDimensions",()=>{let t=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return y.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(t,500)};!this.isGettingVideoDimensions&&t()}),X(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&Yt.curState==="running"&&(y.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(eT())),Ev()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),X(this,"handleVideoEvents",t=>{switch(t.type){case"play":case"playing":t.type==="play"&&y.debug("[".concat(this.trackId,"] video element status: play")),this.startGetVideoDimensions(),this.videoElementStatus=tn.PLAYING;break;case"loadeddata":if(this.videoState=Pr.VideoStateStarting,this.onFirstVideoFrameRender&&this.onFirstVideoFrameRender(),this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=tn.CANPLAY;break;case"stalled":this.videoElementStatus=tn.STALLED;break;case"suspend":this.videoElementStatus=tn.SUSPEND;break;case"pause":this.videoElementStatus=tn.PAUSED,Ht()||ic()||Cr()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(y.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=tn.WAITING;break;case"abort":this.videoElementStatus=tn.ABORT;break;case"ended":this.videoElementStatus=tn.ENDED;break;case"emptied":this.videoElementStatus=tn.EMPTIED;break;case"error":{let i=this.videoElement.error;i&&(this.videoElementStatus=tn.ERROR,y.error("[".concat(this.trackId,"] media error: ").concat(i.message," (").concat(i.code,")")));break}case"timeupdate":{let i=performance.now();if(this.timeUpdatedCount+=1,this.onVideoBufferReady&&this.timeUpdatedCount>F("BUFFER_READY_FRAMES")&&this.onVideoBufferReady(),this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=i);let r=i-this.lastTimeUpdatedTime,o=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=i,Eo.lastVisibleTime<Eo.lastHiddenTime||o<Eo.lastHiddenTime||o<Eo.lastVisibleTime||this.isSkipCalcRenderFreezeTime())return;for(r>F("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=r),this.playbackTime+=r;this.playbackTime>=6e3;){this.playbackTime-=6e3;let s=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(s),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),X(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(y.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(eT())),Ev()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=e.trackId,this.config=e,e.element instanceof HTMLVideoElement?this.videoElement=e.element:this.videoElement=document.createElement("video"),Yt.on(In.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Yt.on(In.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var e;return(e=this.videoElement.parentElement)!==null&&e!==void 0?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement())}play(e){let t=this.videoElement.play();t&&t.catch&&t.catch(r=>{e&&QN(e,"video",r.message,this.trackId),r.name==="NotAllowedError"?(y.warning("detected video element autoplay failed",r),this.autoplayFailed=!0,this.handleAutoPlayFailed()):y.warning("[".concat(this.trackId,"] play warning: "),r)});let i=Zt();if((i.name==="Safari"&&Number(i.version)===15||C_())&&t&&t.then){let r=()=>{this.config.mirror&&!this.config.noStyle&&(this.videoElement.style.transform="rotateY(180deg)")};t.then(r).catch(r)}}getCurrentFrame(){let e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;let t=e.getContext("2d");if(!t)return y.error("create canvas context failed!"),new ImageData(2,2);t.drawImage(this.videoElement,0,0,e.width,e.height);let i=t.getImageData(0,0,e.width,e.height);return e.remove(),i}async getCurrentFrameToUint8Array(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,i=document.createElement("canvas");i.width=this.videoElement.videoWidth,i.height=this.videoElement.videoHeight;let r=i.getContext("2d");return r?(r.drawImage(this.videoElement,0,0,i.width,i.height),new Z((o,s)=>{i.toBlob(async a=>{if(i.remove(),a){let c=await Kv(a);o({buffer:c,width:i.width,height:i.height})}else s(new O(L.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},e,t<0?.1:t>1?1:t)})):await Hv(e)}destroy(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];this.isDestroyed=!0,Yt.off(In.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Yt.off(In.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),e?this.videoElement.pause():this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=Pr.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=tn.INIT,!this.videoElementCheckInterval&&(zv.forEach(o=>{this.videoElement.addEventListener(o,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{this._isInPage=function(o){return o!==document.body&&document.body.contains(o)}(this.videoElement)},1e3),F("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,t;let o,s=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",s),this.videoElementFreezeTimeout=window.setTimeout(a,F("VIDEO_FREEZE_DURATION")))},a=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===Pr.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=Pr.VideoStateFrozen:document.addEventListener("visibilitychange",s))},c=(d,l)=>{if(this.videoElementStatus===tn.PLAYING){if(o){let f=l.presentationTime-o.presentationTime,m=l.presentedFrames-o.presentedFrames;this._render_interframe_delays_sizes.push(m),this._render_interframe_delays.push(f);let g=iT(this._render_interframe_delays_sizes),S=g-this._render_interframe_delays_sizes[0];if(g>30&&S>5&&(this._render_interframe_delays_sizes.shift(),this._render_interframe_delays.shift()),this.videoState===Pr.VideoStateStarting&&(this.videoState=Pr.VideoStateDecoding),this.videoState===Pr.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(a,F("VIDEO_FREEZE_DURATION"))),f<F("VIDEO_FREEZE_DURATION")&&this.videoState===Pr.VideoStateFrozen&&(this.videoState=Pr.VideoStateDecoding),f>F("VIDEO_FREEZE_DURATION")&&Eo.lastVisibleTime>=Eo.lastHiddenTime&&o.timestamp>Eo.lastVisibleTime&&o.timestamp>Eo.lastHiddenTime){let T=Math.min(66,BD(this._render_interframe_delays_sizes,this._render_interframe_delays)),C=Math.max(0,f-(m-1)*T);this.renderFreezeAccTime2+=C>T?C:0,this.renderFreezeAccTime+=f}}o=ki(ki({},l),{},{timestamp:d})}else this.isSkipCalcRenderFreezeTime()&&(o=ki(ki({},l),{},{timestamp:d}));var h,p;F("ENABLE_VIDEO_FRAME_CALLBACK")&&(this.cancelRVFId=(h=(p=this.videoElement).requestVideoFrameCallback)===null||h===void 0?void 0:h.call(p,c))};this.cancelRVFId=(e=(t=this.videoElement).requestVideoFrameCallback)===null||e===void 0?void 0:e.call(t,c)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),ha()&&!F("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");let i=Zt();this.config.noStyle||(i.name==="Safari"&&Number(i.version)===15||C_()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover"),this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,ji()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,ji()&&this.videoElement.load());let r=this.videoElement.play();r!==void 0&&r.catch(o=>{y.debug("[".concat(this.trackId,"] playback interrupted"),o.toString())})}resetVideoElement(){var e,t;zv.forEach(i=>{this.videoElement&&this.videoElement.removeEventListener(i,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.cancelRVFId&&this.videoElement&&((e=(t=this.videoElement).cancelVideoFrameCallback)===null||e===void 0||e.call(t,this.cancelRVFId),this.cancelRVFId=void 0),this.videoElementStatus=tn.NONE}isSkipCalcRenderFreezeTime(){return this.videoElementStatus===tn.DESTROYED||this.internal}handleAutoPlayFailed(){let e=t=>{t.preventDefault(),this.videoElement.play().then(()=>{y.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(i=>{y.error(i)}),this.autoplayFailed=!1,yu()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};yu()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),Yo()}}let zv=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class pT extends Yv{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];super(e),X(this,"container",void 0),X(this,"slot",void 0),this.slot=e.element,this.internal=t,this.updateConfig(e)}updateConfig(e){this.config=e,this.trackId=e.trackId;let t=e.element;var i;!this.internal||this.slot?(t!==this.slot&&(this.destroy(),this.slot=t),this.createElements()):(this.slot=t,t&&this.container?(this.internal=!1,this.container.id="agora-video-player-".concat(this.trackId),this.videoElement.id="video_".concat(this.trackId),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",(i=this.slot)===null||i===void 0||i.appendChild(this.container)):this.createElements())}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements())}play(e){var t;(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)&&super.play(e)}getCurrentFrame(){var e;return(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(e){var t;let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(e,i):await Hv(e)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{var e;this.container.remove(),(e=this.slot)===null||e===void 0||e.removeChild(this.container)}catch{}this.container=void 0}}createElements(){var e;this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",F("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),(e=this.slot)===null||e===void 0||e.appendChild(this.container)}mountedVideoElement(){var e;!this.container||(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var e;if((e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var e;(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var _T,jD,GD,WD,HD,KD,YD,zD,qD,XD,JD,QD,ZD,$D,eP,tP,iP,rP,nP,oP,sP,aP,cP,dP,lP,uP,hP,pP,Ut,xt,_P,fP,mP,EP,gP,SP,TP,ea;let Jt=(_T=Xe({argsMap:(n,e,t)=>[n.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",t]}),jD=pi(),GD=Xe({argsMap:n=>[n.getTrackId()]}),WD=jr("LocalVideoTrack","_enabledMutex"),HD=Xe({argsMap:(n,e)=>[n.getTrackId(),e]}),KD=pi(),YD=jr("LocalVideoTrack","_enabledMutex"),zD=Xe({argsMap:(n,e)=>[n.getTrackId(),e]}),qD=pi(),XD=Xe({argsMap:(n,e)=>[n.getTrackId(),e,n._saveEncodeBitrateRatio]}),JD=pi(),QD=Xe({argsMap:(n,e)=>[n.getTrackId(),e]}),ZD=pi(),$D=pi(),eP=Xe({argsMap:(n,e,t)=>[n.getTrackId(),e,t]}),tP=pi(),iP=pi(),rP=pi(),nP=Xe({argsMap:n=>[n.getTrackId()]}),oP=pi(),sP=pi(),aP=pi(),cP=pi(),dP=pi(),lP=Xe({argsMap:(n,e)=>[n.getTrackId(),e.name]}),uP=Xe({argsMap:n=>[n.getTrackId()]}),hP=Xe({argsMap:n=>[n.getTrackId()]}),pP=Xe({argsMap:(n,e,t)=>[n.getTrackId(),e.label,t]}),Ut=class vZ extends O_{get videoHeight(){if(Cr()){let{height:e}=this._mediaStreamTrack.getSettings();return this._videoHeight=e,this._videoHeight}return this._videoHeight}get videoWidth(){if(Cr()){let{width:e}=this._mediaStreamTrack.getSettings();return this._videoWidth=e,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==tn.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get __className__(){return"LocalVideoTrack"}constructor(e,t,i,r,o,s){if(super(e,o),X(this,"trackMediaType",Ho.VIDEO),X(this,"_player",void 0),X(this,"isUseScaleResolutionDownBy",!1),X(this,"_videoVisibleTimer",null),X(this,"_previousVideoVisibleStatus",void 0),X(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),X(this,"_encoderConfig",void 0),X(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),X(this,"_optimizationMode",void 0),X(this,"_saveEncodeBitrateRatio",1),X(this,"_videoHeight",void 0),X(this,"_videoWidth",void 0),X(this,"_forceBitrateLimit",void 0),X(this,"_enabled",!0),X(this,"_processorDestination",void 0),X(this,"_processorContext",void 0),Cr()){let{width:a,height:c}=e.getSettings();this._videoWidth=a,this._videoHeight=c}else this.updateMediaStreamTrackResolution();if(this._scalabilityMode=i,this._optimizationMode=r,this._hints=s||[],t&&this._hints.indexOf(Re.CUSTOM_TRACK)!==-1?this._encoderConfig=Li(t):this._encoderConfig=t,this._hints.indexOf(Re.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(_v(pt.CHROME,115)&&$S().indexOf("Windows")!==-1){let a=function(c,d){if("VideoFrame"in window&&"TransformStream"in window&&ot().supportWebRTCInsertableStream){let l=new MediaStreamTrackProcessor(c),h=new MediaStreamTrackGenerator({kind:"video"}),p,f,m=Date.now(),g=()=>{S&&(clearInterval(S),S=void 0),p&&(p.close(),p=void 0),c.stop(),f=void 0,h.removeEventListener("ended",g)},S=window.setInterval(()=>{if(f&&p&&Date.now()-m>1e3)try{h.readyState==="live"?f.enqueue(p.clone()):g()}catch{g()}},1e3),T=new TransformStream({transform:(C,b)=>{h.readyState==="live"?(f=b,m=Date.now(),p===void 0?(p=C,b.enqueue(C.clone())):(b.enqueue(p),p=C)):C.close()}});return h.addEventListener("ended",g),l.readable.pipeThrough(T).pipeTo(h.writable),h}}(e);a&&(y.info("local screen video track begin to inject frame"),this._mediaStreamTrack=a)}t&&this._hints.indexOf(Re.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(t),this._processorContext=new ZN(this.getTrackId(),"local"),this._processorDestination=new Tr(this.processorContext),this.bindProcessorDestinationEvents()}play(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){let r=document.getElementById(e);r?e=r:(y.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}y.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));let i=ki(ki(ki({},this._getDefaultPlayerConfig()),t),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(i):(e instanceof HTMLVideoElement?this._player=new Yv(i):this._player=new pT(i),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{let r=this.getVideoElementVisibleStatus();this.safeEmit(Nc.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}},F("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,y.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(e,t){if(!t){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(y.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){this._originMediaStreamTrack.enabled=!1;try{await yt(this,Ue.NEED_DISABLE_TRACK,this)}catch(i){throw y.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}return t||(this._enabled=!1),void y.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await yt(this,Ue.NEED_ENABLE_TRACK,this)}catch(i){throw y.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}y.info("[".concat(this.getTrackId(),"] setEnabled to true success")),t||(this._enabled=!0)}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,y.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await yt(this,Ue.NEED_MUTE_TRACK,this):await yt(this,Ue.NEED_UNMUTE_TRACK,this))}async setSaveEncodeBitrateRatio(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this._saveEncodeBitrateRatio;if(this._saveEncodeBitrateRatio!==1&&this._encoderConfig&&this._encoderConfig.bitrateMax&&this._encoderConfig.bitrateMin){this._encoderConfig.bitrateMin=Math.floor(this._encoderConfig.bitrateMin*e),this._encoderConfig.bitrateMax=Math.floor(this._encoderConfig.bitrateMax*e),y.debug("[".concat(this.getTrackId(),"] set save encode bitrate ratio, ").concat(e)),this._saveEncodeBitrateRatio=1;try{await yt(this,Ue.NEED_UPDATE_VIDEO_ENCODER,this)}catch(t){return t.throw(y)}}}async setEncoderConfiguration(e,t){if(!this._enabled)throw new O(L.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(e=Oc(e),F("USE_STANDARD_BITRATE_DEFAULT")&&(delete e.bitrateMax,delete e.bitrateMin),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){let i=lT({encoderConfig:e});(Cr()||Ht()||ic())&&(i.deviceId=void 0),y.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(i));try{await this._originMediaStreamTrack.applyConstraints(i),this.updateMediaStreamTrackResolution()}catch(r){let o=new O(L.UNEXPECTED_ERROR,r.toString());throw y.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}}this._encoderConfig=e,this._hints.indexOf(Re.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await yt(this,Ue.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(y)}}getStats(){return wu(()=>{y.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),Xt(this,Ue.GET_STATS)||ki({},cT)}async setBeautyEffect(e){y.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(e,t):await Hv(e)}async findClosestProfile(){let{width:e,height:t,frameRate:i}=this.getMediaStreamTrackSettings(),{width:r,height:o,frameRate:s}=this._encoderConfig||{},a=A_(this._videoWidth||e||r||0),c=A_(this._videoHeight||t||o||0),d=function(l,h,p){if(!Array.isArray(F("VIDEO_ENCODER_CONFIG_LIST"))||F("VIDEO_ENCODER_CONFIG_LIST").length===0)return!1;let f=Math.min(l,h);return!(f>=480)&&ki(ki({},F("VIDEO_ENCODER_CONFIG_LIST").find(m=>m.height>f)),{},{frameRate:p})}(a,c,A_(i||s||15));if(d)return y.debug("[".concat(this.getTrackId(),"] find closest profile, ").concat(a,"x").concat(c," => ").concat(JSON.stringify(d))),this.setEncoderConfiguration(d)}async setBitrateLimit(e){y.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e&&(this._forceBitrateLimit=e,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<e.max_bitrate?this._encoderConfig.bitrateMax:e.max_bitrate:this._encoderConfig.bitrateMax=e.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=e.min_bitrate))}async setOptimizationMode(e){if(e!=="motion"&&e!=="detail"&&e!=="balanced")return void y.error(L.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");let t=this._optimizationMode;try{this._optimizationMode=e,await yt(this,Ue.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(i){throw this._optimizationMode=t,y.error("[".concat(this.getTrackId(),"] set optimization mode failed"),i.toString()),i}y.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(e,")"))}setScalabiltyMode(e){if(e.numSpatialLayers===1&&e.numTemporalLayers!==1)return y.error(L.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=e,y.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"))}updateMediaStreamTrackResolution(){MU(this._originMediaStreamTrack).then(e=>{let[t,i]=e;this._videoHeight=i,this._videoWidth=t}).catch(Fd)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(e){if(!this._enabled)throw new O(L.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");y.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(e)),e=Oc(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),this._encoderConfig=e,this._hints.indexOf(Re.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await yt(this,Ue.NEED_UPDATE_VIDEO_ENCODER,this)}catch(t){return t.throw(y)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;let{width:e,height:t,frameRate:i}=this.getMediaStreamTrackSettings();if(!e||!t||!i)return;let{bitrateMax:r,bitrateMin:o}=this._encoderConfig;if(o==null||r==null){let{max:s,min:a}=function(c,d,l,h,p){let f=F("BITRATE_ADAPTER_TYPE");if(f==="DEFAULT_BITRATE")return{min:h,max:p};if(p===void 0){let m=Math.floor(200*Math.pow(l/15,.6)*Math.pow(c*d/640/360,.75));p=f==="STANDARD_BITRATE"?4*m:2*m,h=h??m}else h=h??Math.floor(p/10);return{min:h,max:p}}(e,t,i,o,r);if(this._encoderConfig.bitrateMin=a,this._encoderConfig.bitrateMax=s,F("VIDEO_STANDARD_BITRATE_VERSION")&&o==null&&r==null){let[c,d]=function(l,h,p){let f=4*Math.floor(2e5*Math.pow(p/15,.6)*Math.pow(l*h/230400,.75)),m=l*h,g=new Map([[19200,.9],[230400,.85],[518400,.75],[921600,.7],[2073600,.6],[3686400,.5]]),S=new Map([[230400,.95],[518400,.9],[921600,.85],[2073600,.8]]),T=Vr(g).call(g).next().value,C=1;if(g.has(m))T=g.get(m);else{var b;let J=Ka(b=Array.from(g.entries())).call(b,(Ne,Ce)=>{let[De]=Ne,[Me]=Ce;return De-Me}),se=J.find(Ne=>{let[Ce]=Ne;return Ce>m});if(se){let Ne=J.indexOf(se);if(Ne>0){let Ce=J[Ne-1],De=(m-Ce[0])/(se[0]-Ce[0]);T=Ce[1]+De*(se[1]-Ce[1])}else T=se[1]}else T=J[J.length-1][1]}if(S.has(m))C=S.get(m);else{var D;let J=Ka(D=Array.from(S.entries())).call(D,(Ne,Ce)=>{let[De]=Ne,[Me]=Ce;return De-Me}),se=J.find(Ne=>{let[Ce]=Ne;return Ce>m});if(se){let Ne=J.indexOf(se);if(Ne>0){let Ce=J[Ne-1],De=(m-Ce[0])/(se[0]-Ce[0]);C=Ce[1]+De*(se[1]-Ce[1])}else C=se[1]}else C=J[J.length-1][1]}let x=F("VIDEO_NEW_BITRATE_RATIO");x&&x>0&&(T=x/100);let k=Math.floor(f*T),V=Math.floor(65e4*Math.pow(l*h/230400,.5)*Math.pow(p/15,.69)),W=k,K=F("VIDEO_STANDARD_BITRATE_VERSION");return K&&K>0&&(K===1?W=f:K===2?W=k:K===3&&(W=V)),[Math.floor(W/1e3),C]}(e,t,i);this._encoderConfig.bitrateMax=c,this._encoderConfig.bitrateMin=a?Math.min(a,c):c,this._saveEncodeBitrateRatio=d,y.debug("[".concat(this.getTrackId(),"] update new bitrate from profile, [w: ").concat(e,", h: ").concat(t,", fps: ").concat(i,"] => [brMax: ").concat(this._encoderConfig.bitrateMax,", brMin: ").concat(this._encoderConfig.bitrateMin,", save_bitrate_ratio: ").concat(this._saveEncodeBitrateRatio,"]"))}else y.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(t,", fps: ").concat(i,"] => [brMax: ").concat(s,", brMin: ").concat(a,"]")),this._saveEncodeBitrateRatio=1}}getVideoElementVisibleStatus(){try{var e,t;let i=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),r={track:this,element:this==null||(t=this._player)===null||t===void 0?void 0:t.getVideoElement(),slot:i==null?void 0:i.parentElement},{element:o,slot:s}=r;if(this.isPlaying&&o instanceof HTMLVideoElement&&s instanceof HTMLElement){let a=gv.checkOneElementVisible(o),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;let d=_e.reportApiInvoke(null,{tag:ct.TRACER,name:Yi.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(i){throw new O(L.GET_VIDEO_ELEMENT_VISIBLE_ERROR,i.message)}}async renewMediaStreamTrack(e){}pipe(e){if(this.processor===e)return e;if(e._source)throw new O(L.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;let e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;e&&(i=ki(ki({},i),Oc(e))),i=wi(i);let r=vt(8,"track-video-cloned-"),o=new vZ(t?this._mediaStreamTrack.clone():this._mediaStreamTrack,i,wi(this._scalabilityMode),this._optimizationMode,r,wi(this._hints));return e&&i&&o.setEncoderConfiguration(i),y.debug("clone video track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(t)),o}async replaceTrack(e,t){if(!(e instanceof MediaStreamTrack))throw new O(L.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(e.kind!=="video")throw new O(L.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(e,t,!0),this.updateMediaStreamTrackResolution()}sendSeiData(e){if(wu(()=>{_e.reportApiInvoke(null,{name:Yi.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:ct.TRACER}).onSuccess("")},this._mediaStreamTrack.id||this.getTrackId()),!F("ENABLE_VIDEO_SEI")||!F("ENABLE_ENCODED_TRANSFORM"))return void y.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(e instanceof Uint8Array==0)return new O(L.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();let t=this.getRTCRtpTransceiver();if(!t)return void y.warning("Video track is not published, SEI can not be send");let i=t.sender.getParameters();if(i.codecs.length===0)return;let r=i.codecs[0].mimeType.toLocaleLowerCase();r==="video/h264"||r==="video/h265"?this.safeEmit("sei-to-send",e):y.warning("SEI is not supported by ".concat(r))}bindProcessorDestinationEvents(){this.processorDestination.on(Do.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(),await yt(this,Ue.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await yt(this,Ue.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Do.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(wr.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(wr.REQUEST_CONSTRAINTS)}},Wt(Ut.prototype,"play",[_T,jD],Object.getOwnPropertyDescriptor(Ut.prototype,"play"),Ut.prototype),Wt(Ut.prototype,"stop",[GD],Object.getOwnPropertyDescriptor(Ut.prototype,"stop"),Ut.prototype),Wt(Ut.prototype,"setEnabled",[WD,HD,KD],Object.getOwnPropertyDescriptor(Ut.prototype,"setEnabled"),Ut.prototype),Wt(Ut.prototype,"setMuted",[YD,zD,qD],Object.getOwnPropertyDescriptor(Ut.prototype,"setMuted"),Ut.prototype),Wt(Ut.prototype,"setSaveEncodeBitrateRatio",[XD,JD],Object.getOwnPropertyDescriptor(Ut.prototype,"setSaveEncodeBitrateRatio"),Ut.prototype),Wt(Ut.prototype,"setEncoderConfiguration",[QD,ZD],Object.getOwnPropertyDescriptor(Ut.prototype,"setEncoderConfiguration"),Ut.prototype),Wt(Ut.prototype,"getStats",[$D],Object.getOwnPropertyDescriptor(Ut.prototype,"getStats"),Ut.prototype),Wt(Ut.prototype,"setBeautyEffect",[eP,tP],Object.getOwnPropertyDescriptor(Ut.prototype,"setBeautyEffect"),Ut.prototype),Wt(Ut.prototype,"getCurrentFrameData",[iP],Object.getOwnPropertyDescriptor(Ut.prototype,"getCurrentFrameData"),Ut.prototype),Wt(Ut.prototype,"getCurrentFrameImage",[rP],Object.getOwnPropertyDescriptor(Ut.prototype,"getCurrentFrameImage"),Ut.prototype),Wt(Ut.prototype,"findClosestProfile",[nP,oP],Object.getOwnPropertyDescriptor(Ut.prototype,"findClosestProfile"),Ut.prototype),Wt(Ut.prototype,"setBitrateLimit",[sP],Object.getOwnPropertyDescriptor(Ut.prototype,"setBitrateLimit"),Ut.prototype),Wt(Ut.prototype,"setOptimizationMode",[aP],Object.getOwnPropertyDescriptor(Ut.prototype,"setOptimizationMode"),Ut.prototype),Wt(Ut.prototype,"setScalabiltyMode",[cP],Object.getOwnPropertyDescriptor(Ut.prototype,"setScalabiltyMode"),Ut.prototype),Wt(Ut.prototype,"updateMediaStreamTrackResolution",[dP],Object.getOwnPropertyDescriptor(Ut.prototype,"updateMediaStreamTrackResolution"),Ut.prototype),Wt(Ut.prototype,"pipe",[lP],Object.getOwnPropertyDescriptor(Ut.prototype,"pipe"),Ut.prototype),Wt(Ut.prototype,"unpipe",[uP],Object.getOwnPropertyDescriptor(Ut.prototype,"unpipe"),Ut.prototype),Wt(Ut.prototype,"close",[hP],Object.getOwnPropertyDescriptor(Ut.prototype,"close"),Ut.prototype),Wt(Ut.prototype,"replaceTrack",[pP],Object.getOwnPropertyDescriptor(Ut.prototype,"replaceTrack"),Ut.prototype),Ut),yi=(xt=Xe({argsMap:(n,e)=>[n.getTrackId(),e]}),_P=pi(),fP=jr("CameraVideoTrack","_enabledMutex"),mP=Xe({argsMap:(n,e)=>[n.getTrackId(),e]}),EP=pi(),gP=Xe({argsMap:(n,e)=>[n.getTrackId(),e]}),SP=pi(),TP=Xe({argsMap:n=>[n.getTrackId()]}),ea=class CZ extends Jt{get __className__(){return"CameraVideoTrack"}constructor(e,t,i,r,o,s){super(e,Oc(t.encoderConfig),r,o,s),X(this,"_config",void 0),X(this,"_originalConstraints",void 0),X(this,"_constraints",void 0),X(this,"_enabled",!0),X(this,"_deviceName","default"),X(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(C_()||wh())&&!function(){let a=Zt();if(a.os!==pr.IOS||!a.osVersion)return!1;let c=a.osVersion.split(".");return Number(c[0])===15&&Number(c[1])>=2}()&&rc()&&this._enabled&&!this._isClosed&&(y.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=t,this._originalConstraints=i,this._constraints=i,this._deviceName=e.label,this._encoderConfig=Oc(this._config.encoderConfig),Yt.on(In.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Yt.on(In.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(e){return typeof e=="string"?this._setDeviceById(e):e.deviceId?this._setDeviceById(e.deviceId):e.facingMode?this._setDeviceByFacingModel(e.facingMode):void 0}async _setDeviceById(e){if(y.info("[".concat(this.getTrackId(),"] set device to ").concat(e)),this._enabled)try{let t=await Po.getDeviceById(e),i={};i.video=ki({},this._constraints),i.video.deviceId={exact:e},i.video.facingMode=void 0,this._originMediaStreamTrack.stop();let r=null;try{r=await $s(i,this.getTrackId())}catch(o){throw y.error("[".concat(this.getTrackId(),"] setDevice failed"),o.toString()),r=await $s({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),o}await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=t.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(t){throw y.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}else try{let t=await Po.getDeviceById(e);this._deviceName=t.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(t){throw y.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}y.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(e){y.info("[".concat(this.getTrackId(),"] set facingMode ").concat(e));let t={video:ki(ki({},this._constraints),{},{deviceId:void 0,facingMode:{exact:e}})};if(this._enabled){this._originMediaStreamTrack.stop();let i=null;try{i=await $s(t,this.getTrackId())}catch(r){throw y.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),r.toString()),i=await $s({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=e,this._config.cameraId=void 0,this._constraints=ki({},t.video),y.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(e,t){if(!t){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(y.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{let i=await $s({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1)}await yt(this,Ue.NEED_ENABLE_TRACK,this)}catch(i){throw y.error("[".concat(this.getTrackId(),"] setEnabled true error"),i.toString()),i}this.updateMediaStreamTrackResolution(),y.info("[".concat(this.getTrackId(),"] setEnabled to true success")),t||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),t||(this._enabled=!1);try{await yt(this,Ue.NEED_DISABLE_TRACK,this)}catch(i){throw y.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}y.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(e,t){if(!this._enabled)throw new O(L.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");e=Oc(e),F("USE_STANDARD_BITRATE_DEFAULT")&&(delete e.bitrateMax,delete e.bitrateMin),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate||e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate||e.bitrateMin);let i=Li(this._config);i.encoderConfig=e;let r=lT(i);(Cr()||Ht()||ic())&&(r.deviceId=void 0),y.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(r));try{await this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution()}catch(o){let s=new O(L.UNEXPECTED_ERROR,o.toString());throw y.error("[".concat(this.getTrackId(),"] applyConstraints error"),s.toString()),s}this._config=i,this._constraints=r,this._originalConstraints=r,this._encoderConfig=e,this._hints.indexOf(Re.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await yt(this,Ue.NEED_UPDATE_VIDEO_ENCODER,this)}catch(o){return o.throw(y)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((Ht()||ic())&&this._enabled&&!this._isClosed&&Yt.duringInterruption){let e=async()=>{Yt.off(In.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(y.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Yt.on(In.IOS_INTERRUPTION_END,e)}else y.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Nc.TRACK_ENDED)}async renewMediaStreamTrack(e){let t=e||this._constraints,i=Po.searchDeviceIdByName(this._deviceName);if(i&&!t.deviceId&&(t.deviceId={exact:i}),this._enabled){let r=await $s({video:t},this.getTrackId());this._constraints=t,await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),Yt.off(In.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Yt.off(In.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;e&&(i=ki(ki({},i),Oc(e))),i=wi(i);let r=vt(8,"track-cam-cloned-"),o=new CZ(t?this._mediaStreamTrack.clone():this._mediaStreamTrack,wi(ki(ki({},this._config),{},{encoderConfig:i})),wi(this._constraints),wi(this._scalabilityMode),this._optimizationMode,r);return e&&i&&o.setEncoderConfiguration(i),y.debug("clone track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(t)),o}bindProcessorContextEvents(){this.processorContext.on(wr.REQUEST_UPDATE_CONSTRAINTS,async(e,t,i)=>{try{let r=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(r),t()}catch(r){i(r)}}),this.processorContext.on(wr.REQUEST_CONSTRAINTS,async e=>{e(this._originMediaStreamTrack.getSettings())})}},Wt(ea.prototype,"setDevice",[xt,_P],Object.getOwnPropertyDescriptor(ea.prototype,"setDevice"),ea.prototype),Wt(ea.prototype,"setEnabled",[fP,mP,EP],Object.getOwnPropertyDescriptor(ea.prototype,"setEnabled"),ea.prototype),Wt(ea.prototype,"setEncoderConfiguration",[gP,SP],Object.getOwnPropertyDescriptor(ea.prototype,"setEncoderConfiguration"),ea.prototype),Wt(ea.prototype,"close",[TP],Object.getOwnPropertyDescriptor(ea.prototype,"close"),ea.prototype),ea);function fT(n){let e=vt(8,"track-cus-"),t=_e.reportApiInvoke(null,{id:e,tag:ct.TRACER,name:Yi.CREATE_CUSTOM_AUDIO_TRACK,options:[n]}),i=new ri(n.mediaStreamTrack,n.encoderConfig?kv(n.encoderConfig):{},e,!1);return y.info("create custom audio track success with config",n,"trackId",i.getTrackId()),t.onSuccess(i.getTrackId()),i}function qv(n,e,t,i){t.optimizationMode&&(i&&i.width&&i.height?(t.encoderConfig=ki(ki({},i),{},{bitrateMin:i.bitrateMin,bitrateMax:i.bitrateMax}),t.optimizationMode!=="motion"&&t.optimizationMode!=="detail"||(e.contentHint=t.optimizationMode,e.contentHint===t.optimizationMode?y.debug("[".concat(n,"] set content hint to"),t.optimizationMode):y.debug("[".concat(n,"] set content hint failed")))):y.warning("[".concat(n,"] can not apply optimization mode bitrate config, no encoderConfig")))}var Xv,RP,vP,CP,va,Ca,yP,IP,AP,wP,bP,OP,Wn;class Hn extends Mi{getUserId(){return this._userId}constructor(e,t,i,r){super(e,"track-".concat(e.kind,"-").concat(t,"-").concat(r.clientId,"_").concat(vt(5,""))),X(this,"_userId",void 0),X(this,"_uintId",void 0),X(this,"_isDestroyed",!1),X(this,"store",void 0),X(this,"processor",void 0),X(this,"processorContext",void 0),this._userId=t,this._uintId=i,this.store=r}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,y.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let D_=(Xv=Xe({argsMap:(n,e,t)=>[n.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",t]}),RP=Xe({argsMap:n=>[n.getTrackId()]}),vP=Xe({argsMap:(n,e)=>[n.getTrackId(),e.name]}),CP=Xe({argsMap:n=>[n.getTrackId()]}),Wt((va=class extends Hn{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==tn.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(n,e,t,i,r){super(n,e,t,i),X(this,"_videoVisibleTimer",null),X(this,"_previousVideoVisibleStatus",void 0),X(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),X(this,"trackMediaType",Ho.VIDEO),X(this,"_videoWidth",void 0),X(this,"_videoHeight",void 0),X(this,"_player",void 0),X(this,"_prePlayer",void 0),X(this,"processorDestination",void 0),X(this,"processorContext",void 0),this._prePlayer=r,this.updateMediaStreamTrackResolution(),this.processorContext=new ZN(this.getTrackId(),"remote"),this.processorDestination=new Tr(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return wu(()=>{y.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),Xt(this,Ue.GET_STATS)||ki({},DU)}play(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.safeEmit(Wo.PLAY_START),typeof n=="string"){let i=document.getElementById(n);i?n=i:(y.warning("[".concat(this.getTrackId(),'] can not find "#').concat(n,'" element, use document.body')),n=document.body)}y.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(n instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));let t=ki(ki({fit:"cover"},e),{},{trackId:this.getTrackId(),element:n});if(this._player)this._player.updateConfig(t);else{let i=!1,r=!1;n instanceof HTMLVideoElement?(this._player=new Yv(t),this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0,r=!0)):this._prePlayer&&!this._prePlayer.isDestroyed?(this._player=this._prePlayer,this._prePlayer=void 0,i=this._player.videoState>0,this._player.updateConfig(t)):this._player=new pT(t),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(Wo.FIRST_FRAME_DECODED),r&&this.safeEmit(Wo.FIRST_FRAME_RENDER)},this._player.onVideoStateChanged=o=>{this.safeEmit(Wo.VIDEO_STATE_CHANGED,o)},i&&(this._player.onFirstVideoFrameDecoded(),this._player.onVideoStateChanged(this._player.videoState))}this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{let i=this.getVideoElementVisibleStatus();this.safeEmit(Wo.VIDEO_ELEMENT_VISIBLE_STATUS,i)}catch{}},F("CHECK_VIDEO_VISIBLE_INTERVAL")),this.safeEmit(Wo.PLAY_END)}stop(){let n=arguments.length>0&&arguments[0]!==void 0&&arguments[0];this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(n),this._player=void 0,y.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){MU(this._originMediaStreamTrack).then(n=>{let[e,t]=n;this._videoHeight=t,this._videoWidth=e}).catch(Fd)}_updatePlayerSource(){y.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var n,e;let t=this==null||(n=this._player)===null||n===void 0?void 0:n.getContainerElement(),i={track:this,element:this==null||(e=this._player)===null||e===void 0?void 0:e.getVideoElement(),slot:t==null?void 0:t.parentElement},{element:r,slot:o}=i;if(this.isPlaying&&r instanceof HTMLVideoElement&&o instanceof HTMLElement){let s=gv.checkOneElementVisible(r),a=Object.assign({},s);if(a.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=a.visible;let c=_e.reportApiInvoke(null,{tag:ct.TRACER,name:Yi.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});a.visible?c.onSuccess("Video is visible"):c.onSuccess("Invisible because of ".concat(a.reason))}return a}return}catch(t){throw new O(L.GET_VIDEO_ELEMENT_VISIBLE_ERROR,t.message)}}pipe(n){if(this.processor===n)return n;if(n._source)throw new O(L.INVALID_OPERATION,"Processor ".concat(n.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=n,this.processor._source=this,n.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),n}unpipe(){if(!this.processor)return;let n=this.processor;this.processor._source=void 0,this.processor=void 0,n.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Do.ON_TRACK,async n=>{n?n!==this._mediaStreamTrack&&(this._mediaStreamTrack=n,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Do.ON_TRACK)}_destroy(){this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0),super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(n){this.emit(b_.SEI_RECEIVED,n)}}).prototype,"play",[Xv],Object.getOwnPropertyDescriptor(va.prototype,"play"),va.prototype),Wt(va.prototype,"stop",[RP],Object.getOwnPropertyDescriptor(va.prototype,"stop"),va.prototype),Wt(va.prototype,"pipe",[vP],Object.getOwnPropertyDescriptor(va.prototype,"pipe"),va.prototype),Wt(va.prototype,"unpipe",[CP],Object.getOwnPropertyDescriptor(va.prototype,"unpipe"),va.prototype),va),Wd=(Ca=Xe({argsMap:(n,e)=>[n.getTrackId(),e],throttleTime:300}),yP=Xe({argsMap:(n,e)=>[n.getTrackId(),e],throttleTime:300}),IP=Xe({argsMap:(n,e)=>[n.getTrackId(),e]}),AP=Xe({argsMap:n=>[n.getTrackId()]}),wP=Xe({argsMap:n=>[n.getTrackId()]}),bP=Xe({argsMap:(n,e)=>[n.getTrackId(),e.name]}),OP=Xe({argsMap:n=>[n.getTrackId()]}),Wt((Wn=class extends Hn{get isPlaying(){return this._useAudioElement?ko.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(n,e,t,i){super(n,e,t,i),X(this,"trackMediaType",Ho.AUDIO),X(this,"_source",void 0),X(this,"_useAudioElement",!0),X(this,"_volume",100),X(this,"processorContext",void 0),X(this,"processorDestination",void 0),X(this,"_played",!1),X(this,"_bypassWebAudio",!1),F("DISABLE_WEBAUDIO")?(this._source=new Wv,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new Vv(n,!0),F("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(No.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(Wo.FIRST_FRAME_DECODED)}),this.processorContext=new eD(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new $N(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(No.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!n)return this._source.removeAllListeners(No.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(No.ON_AUDIO_BUFFER),this._source.on(No.ON_AUDIO_BUFFER,t=>n(t))}setVolume(n){this._volume=n,this._useAudioElement?ko.setVolume(this.getTrackId(),n):this._source.setVolume(n/100)}setAmplifiedVolume(n){this._useAudioElement&&this._played&&(ko.stop(this.getTrackId()),this._source.play()),this._useAudioElement=!1,n=Math.min(n,F("MAX_WEBAUDIO_VOLUME")),this._volume=n,this._source.setVolume(n/100)}async setPlaybackDevice(n){if(!this._useAudioElement||!Mt())throw new O(L.NOT_SUPPORTED,"your browser does not support setting the audio output device");await ko.setSinkID(this.getTrackId(),n)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getVolume(){return this._useAudioElement?ko.getVolume(this.getTrackId()):this._source instanceof Vv?this._source.getAudioVolume():0}getStats(){return wu(()=>{y.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),Xt(this,Ue.GET_STATS)||ki({},Mv)}play(){y.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(y.debug("[".concat(this.getTrackId(),"] use audio element to play")),ko.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):(y.debug("[".concat(this.getTrackId(),"] use audio context to play")),this._source.play())}stop(){y.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?ko.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let n=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];y.debug("[".concat(this.getTrackId(),"] update player source track")),n&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&ko.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(n){if(this._bypassWebAudio)throw new O(L.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===n)return n;if(n._source)throw new O(L.INVALID_OPERATION,"Processor ".concat(n.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=n,this.processor._source=this,n.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),n}unpipe(){var n;if(this._bypassWebAudio)throw new O(L.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;let e=this.processor;(n=this._source.processSourceNode)===null||n===void 0||n.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Do.ON_TRACK,async n=>{n?n!==this._mediaStreamTrack&&(this._mediaStreamTrack=n,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(n)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(Do.ON_NODE,n=>{this._source.processedNode=n;let e=!n;this._useAudioElement!==e&&(this._played?(this.stop(),this._useAudioElement=e,this.play()):this._useAudioElement=e)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Do.ON_TRACK),this.processorDestination.removeAllListeners(Do.ON_NODE)}}).prototype,"setVolume",[Ca],Object.getOwnPropertyDescriptor(Wn.prototype,"setVolume"),Wn.prototype),Wt(Wn.prototype,"setAmplifiedVolume",[yP],Object.getOwnPropertyDescriptor(Wn.prototype,"setAmplifiedVolume"),Wn.prototype),Wt(Wn.prototype,"setPlaybackDevice",[IP],Object.getOwnPropertyDescriptor(Wn.prototype,"setPlaybackDevice"),Wn.prototype),Wt(Wn.prototype,"play",[AP],Object.getOwnPropertyDescriptor(Wn.prototype,"play"),Wn.prototype),Wt(Wn.prototype,"stop",[wP],Object.getOwnPropertyDescriptor(Wn.prototype,"stop"),Wn.prototype),Wt(Wn.prototype,"pipe",[bP],Object.getOwnPropertyDescriptor(Wn.prototype,"pipe"),Wn.prototype),Wt(Wn.prototype,"unpipe",[OP],Object.getOwnPropertyDescriptor(Wn.prototype,"unpipe"),Wn.prototype),Wn),Eo=new class extends Ki{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),X(this,"_lastHiddenTime",0),X(this,"_lastVisibleTime",0),X(this,"needUploadStats",[]),X(this,"isCollectingStats",!1),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),this.isCollectingStats&&this.needUploadStats.push(document.visibilityState==="visible"?1:0),y.debug("current web page is ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}startCollectStats(){this.isCollectingStats=!0,this.needUploadStats.push(this.visibility==="visible"?1:0)}stopCollectStats(){this.isCollectingStats=!1,this.needUploadStats.length=0}};class ws extends Ki{constructor(e,t){super(),X(this,"trackMediaType",Ho.DATA),X(this,"_version",1),X(this,"_type",3),X(this,"_config",void 0),X(this,"_originDataChannel",void 0),X(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),X(this,"_dataStreamPacketHandler",{serialize:i=>i,deserialize:i=>i}),X(this,"_datachannelEventMap",new Map),this._config=e,t&&(this._originDataChannel=t,this._bandDataChannelEvents(t)),this._initPacketHeader()}useDataStream(e){this._dataStreamPacketHandler=e}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return F("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var e,t;return(e=(t=this._originDataChannel)===null||t===void 0?void 0:t.readyState)!==null&&e!==void 0?e:"connecting"}get _originDataChannelId(){var e,t;return(e=(t=this._originDataChannel)===null||t===void 0?void 0:t.id)!==null&&e!==void 0?e:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new Z((e,t)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&e();let i=setTimeout(()=>{var r;t(new O(L.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((r=this._originDataChannel)===null||r===void 0?void 0:r.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(i),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),e()},this._originDataChannel.onerror=()=>{throw clearTimeout(i),new O(L.DATACHANNEL_CONNECTION_TIMEOUT)}}else t(new O(L.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(e){this._originDataChannel=e,this._bandDataChannelEvents(e)}_initPacketHeader(){let e=new DataView(this._dataStreamPacketHeader);e.setUint16(0,this._version),e.setUint8(2,this._type),e.setUint8(3,this._config.id)}_bandDataChannelEvents(e){this._unbindDataChannelEvents(e),[Yf.OPEN,Yf.CLOSE,Yf.ERROR].forEach(t=>{let i=()=>{this.emit(t)};this._datachannelEventMap.set(t,i),e.addEventListener(t,i)})}_unbindDataChannelEvents(e){Array.from(this._datachannelEventMap.entries()).forEach(t=>{let[i,r]=t;e.removeEventListener(i,r)}),this._datachannelEventMap.clear()}}class xU extends ws{constructor(e){super(e),X(this,"_messageListener",void 0),this._messageListener=t=>{if(t.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);let i=t.data.slice(0,this._dataStreamPacketHeader.byteLength),r=new DataView(i).getUint8(3);if(r!==this.id)return void(F("SHOW_DATASTREAM2_LOG")&&y.debug("invalid datachannel id: ".concat(r," !== ").concat(this.id)));let o=t.data.slice(this._dataStreamPacketHeader.byteLength);o=this._dataStreamPacketHandler.deserialize(o),this.emit(Yf.MESSAGE,o)}}_updateOriginDataChannel(e){super._updateOriginDataChannel(e),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class KY extends ws{send(e){if(this._originDataChannel){let t=e;t=this._dataStreamPacketHandler.serialize(e);let i=new Uint8Array(this._dataStreamPacketHeader.byteLength+t.byteLength);i.set(new Uint8Array(this._dataStreamPacketHeader),0),i.set(new Uint8Array(t),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(i.buffer)}}}function Jv(){let n=new Blob([atob("Y29uc3QgdD0idmlkZW8vaDI2NCIsZT0idmlkZW8vaDI2NSI7ZnVuY3Rpb24gbih0LGUsbil7bGV0IGE9bmV3IFVpbnQ4QXJyYXkodCxlLG4pLHI9W10sbz0wO2Zvcig7ci5sZW5ndGg8bjspbyszPG4mJjA9PT1hW29dJiYwPT09YVtvKzFdJiYzPT09YVtvKzJdJiYoMD09PWFbbyszXXx8MT09PWFbbyszXXx8Mj09PWFbbyszXXx8Mz09PWFbbyszXSk/KHIucHVzaChhW29dLGFbbysxXSxhW28rM10pLG8rPTQpOihyLnB1c2goYVtvXSksbysrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkocil9ZnVuY3Rpb24gYShhLHIpe3N3aXRjaChyKXtjYXNlIHQ6cmV0dXJuIGZ1bmN0aW9uKHQpe2NvbnN0IGU9bmV3IERhdGFWaWV3KHQuZGF0YSk7bGV0IGE9MDtmb3IoO2ErNDx0LmRhdGEuYnl0ZUxlbmd0aDspe2lmKDA9PT1lLmdldFVpbnQ4KGErMCkmJjA9PT1lLmdldFVpbnQ4KGErMSkmJjA9PT1lLmdldFVpbnQ4KGErMikmJjE9PT1lLmdldFVpbnQ4KGErMykmJjY9PT1lLmdldFVpbnQ4KGErNCkpe2xldCByPWErNixvPTAsaT0wO2Zvcig7MjU1PT09KGk9ZS5nZXRVaW50OChyKyspKTspbys9MjU1O28rPWk7Y29uc3Qgcz1uKHQuZGF0YSxyLG8pO3JldHVybiBuZXcgVWludDhBcnJheShzKX1hKyt9cmV0dXJuIG51bGx9KGEpO2Nhc2UgZTpyZXR1cm4gZnVuY3Rpb24odCl7Y29uc3QgZT1uZXcgRGF0YVZpZXcodC5kYXRhKTtsZXQgYT0wO2Zvcig7YSs1PHQuZGF0YS5ieXRlTGVuZ3RoOyl7aWYoMD09PWUuZ2V0VWludDgoYSswKSYmMD09PWUuZ2V0VWludDgoYSsxKSYmMD09PWUuZ2V0VWludDgoYSsyKSYmMT09PWUuZ2V0VWludDgoYSszKSYmNzg9PT1lLmdldFVpbnQ4KGErNCkmJjE9PT1lLmdldFVpbnQ4KGErNSkmJjEwMT09PWUuZ2V0VWludDgoYSs2KSl7bGV0IHI9YSs3LG89MCxpPTA7Zm9yKDsyNTU9PT0oaT1lLmdldFVpbnQ4KHIrKykpOylvKz0yNTU7bys9aTtjb25zdCBzPW4odC5kYXRhLHIsbyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KHMpfWErK31yZXR1cm4gbnVsbH0oYSk7ZGVmYXVsdDpyZXR1cm4gbnVsbH19ZnVuY3Rpb24gcih0KXtjb25zdCBlPXQubGVuZ3RoO2xldCBuPVtdLGE9MDtmb3IoO2E8ZTspYSsyPGUmJjA9PT10W2FdJiYwPT09dFthKzFdJiYoMD09PXRbYSsyXXx8MT09PXRbYSsyXXx8Mj09PXRbYSsyXXx8Mz09PXRbYSsyXSk/KG4ucHVzaCh0W2FdLHRbYSsxXSwzLHRbYSsyXSksYSs9Myk6KG4ucHVzaCh0W2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShuKX1mdW5jdGlvbiBvKG4sYSxvKXtzd2l0Y2gobyl7Y2FzZSB0OnJldHVybiBmdW5jdGlvbih0LGUpe2NvbnN0IG49cihlKSxhPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihhLzI1NSksaT1hJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK2ErdC5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNitmXT0yNTUsZisrO3JldHVybiBzWzYrZl09aSxmKysscy5zZXQobiw2K2YpLHMuc2V0KG5ldyBVaW50OEFycmF5KHQpLDYrZithKSxzLmJ1ZmZlcn0obixhKTtjYXNlIGU6cmV0dXJuIGZ1bmN0aW9uKHQsZSl7Y29uc3Qgbj1yKGUpLGE9bi5sZW5ndGgsbz1NYXRoLmZsb29yKGEvMjU1KSxpPWElMjU1LHM9bmV3IFVpbnQ4QXJyYXkoNytvKzErYSsxK3QuYnl0ZUxlbmd0aCk7c1swXT0wLHNbMV09MCxzWzJdPTAsc1szXT0xLHNbNF09Nzgsc1s1XT0xLHNbNl09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNytmXT0yNTUsZisrO3JldHVybiBzWzcrZl09aSxmKysscy5zZXQobiw3K2YpLGYrPWEsc1s3K2ZdPTEyOCxmKysscy5zZXQobmV3IFVpbnQ4QXJyYXkodCksNytmKSxzLmJ1ZmZlcn0obixhKTtkZWZhdWx0OnJldHVybiBudWxsfX1mdW5jdGlvbiBpKG4pe2lmKG4ubGVuZ3RoPDUpcmV0dXJuIiI7bGV0IGE9LTE7Zm9yKGxldCB0PTA7dDxuLmxlbmd0aC0zO3QrKyl7aWYoMD09PW5bdF0mJjA9PT1uW3QrMV0mJjE9PT1uW3QrMl0pe2E9dDticmVha31pZih0PG4ubGVuZ3RoLTQmJjA9PT1uW3RdJiYwPT09blt0KzFdJiYwPT09blt0KzJdJiYxPT09blt0KzNdKXthPXQ7YnJlYWt9fWlmKC0xPT09YSlyZXR1cm4iIjtjb25zdCByPWErKDA9PT1uW2ErMl0/NDozKTtpZihyPj1uLmxlbmd0aClyZXR1cm4iIjtjb25zdCBvPW5bcl07aWYoMTI4Jm8pcmV0dXJuIiI7aWYoKG8+PjEmNjMpPj0zMilyZXR1cm4gZTtpZihyKzE8bi5sZW5ndGgpe2lmKDA9PSgyNDgmbltyKzFdKSlyZXR1cm4gZX1yZXR1cm4oMzEmbyk8PTMxP3Q6IiJ9Y29uc3Qgcz03MSxmPTEsbD0yLHU9MSxnPTI7dmFyIGM7ZnVuY3Rpb24gZCh0LGU9ITEpe2NvbnN0IG49dC5nZXRVaW50OCgwKTtpZihuIT09cylyZXR1cm47Y29uc3QgYT10LmdldFVpbnQxNigxKSxyPWYrbCthLG89bmV3IFVpbnQ4QXJyYXkodC5ieXRlTGVuZ3RoLXIpO28uc2V0KG5ldyBVaW50OEFycmF5KHQuYnVmZmVyLHIsdC5ieXRlTGVuZ3RoLXIpKTtjb25zdCBpPXttOm4sdGx2TGVuOmEsdGx2OltdLGZyYW1lOm99O2xldCBkPWYrbDtmb3IoO2Q8cjspe2NvbnN0IG49dC5nZXRVaW50OChkKSxhPXQuZ2V0VWludDE2KGQrdSkscj11K2c7aWYobj09PWMuQVVESU9fTEVWRUwpe2xldCBvPXQuZ2V0VWludDgoZCtyKTtmb3IobGV0IGU9MTtlPGE7ZSsrKW89bzw8OHx0LmdldFVpbnQ4KGQrcitlKTtpLnRsdi5wdXNoKHt0YWc6bixsZW5ndGg6YSx2YWx1ZTplPzEyN15vPj4xOjEyNyZvfSl9ZWxzZSBpZihuPT09Yy5NRVRBREFUQXx8bj09PWMuQVVESU9fNjRfQklUX1BUUyl7Y29uc3QgZT1uZXcgVWludDhBcnJheShhKTtmb3IobGV0IG49MDtuPGE7bisrKWVbbl09dC5nZXRVaW50OChkK3Irbik7aS50bHYucHVzaCh7dGFnOm4sbGVuZ3RoOmEsdmFsdWU6ZX0pfWQrPXIrYX1yZXR1cm4gaX0hZnVuY3Rpb24odCl7dFt0LkFVRElPX0xFVkVMPTFdPSJBVURJT19MRVZFTCIsdFt0Lk1FVEFEQVRBPTJdPSJNRVRBREFUQSIsdFt0LkFVRElPXzY0X0JJVF9QVFM9M109IkFVRElPXzY0X0JJVF9QVFMifShjfHwoYz17fSkpLHNlbGYub25ydGN0cmFuc2Zvcm09dD0+e2NvbnN0IGU9dC50cmFuc2Zvcm1lcixuPVtdLHI9W107bGV0IGg9bnVsbDtlLm9wdGlvbnMucG9ydC5vbm1lc3NhZ2U9dD0+e3QuZGF0YS5zZWkmJm4ucHVzaCh0LmRhdGEuc2VpKSx0LmRhdGEubWV0YWRhdGEmJnIucHVzaCh0LmRhdGEubWV0YWRhdGEpfSxzZWxmLnBvc3RNZXNzYWdlKCJzdGFydGVkIik7Y29uc3QgcD1lLnJlYWRhYmxlLmdldFJlYWRlcigpLFU9ZS53cml0YWJsZS5nZXRXcml0ZXIoKTsic2VpLXJ4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1pKG5ldyBVaW50OEFycmF5KG4udmFsdWUuZGF0YSkpLHI9YShuLnZhbHVlLHQpO2lmKHImJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtzZWk6cn0pLCFoKXtjb25zdCB0PW4udmFsdWUuZ2V0TWV0YWRhdGEoKXx8e307aD17dHlwZTpuLnZhbHVlLnR5cGUscnRwVGltZXN0YW1wOm4udmFsdWUudGltZXN0YW1wLHBheWxvYWRUeXBlOnQucGF5bG9hZFR5cGV8fDAsc3NyYzp0LnN5bmNocm9uaXphdGlvblNvdXJjZXx8MCxsZW5ndGg6bi52YWx1ZS5kYXRhLmJ5dGVMZW5ndGgsLi4uIm1pbWVUeXBlImluIHQ/e21pbWVUeXBlOnQubWltZVR5cGV9Ont9fSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7Zmlyc3RGcmFtZUluZm86aH0pfX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToic2VpLXR4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigoYT0+e2lmKCFhLmRvbmUpe2lmKGEudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1pKG5ldyBVaW50OEFycmF5KGEudmFsdWUuZGF0YSkpLGU9bi5zaGlmdCgpO2lmKGUpe2NvbnN0IG49byhhLnZhbHVlLmRhdGEsZSx0KTtuJiYoYS52YWx1ZS5kYXRhPW4pfX1VLndyaXRlKGEudmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtcngiPT09ZS5vcHRpb25zLm5hbWU/ZnVuY3Rpb24gdChlKXtwLnJlYWQoKS50aGVuKChuPT57aWYoIW4uZG9uZSl7aWYobi52YWx1ZSBpbnN0YW5jZW9mIFJUQ0VuY29kZWRBdWRpb0ZyYW1lKXtjb25zdCB0PW5ldyBEYXRhVmlldyhuLnZhbHVlLmRhdGEpLGE9dC5nZXRVaW50OCgwKTtsZXQgcjtpZigwIT0oMTI4JmEpJiY3MSE9PWEpe2NvbnN0IGU9ZnVuY3Rpb24odCl7aWYodC5ieXRlTGVuZ3RoPD0wKXJldHVybltdO2NvbnN0IGU9W107bGV0IG49MDtmb3IoO248dC5ieXRlTGVuZ3RoOyl7Y29uc3QgYT0oMTI4JnQuZ2V0VWludDgobikpPj43LHI9MTI3JnQuZ2V0VWludDgobik7aWYoIShhJiZuKzQ8PXQuYnl0ZUxlbmd0aCkpe24rKzticmVha317Y29uc3QgYT10LmdldFVpbnQzMihuLCExKSxvPSgxNjc3NjE5MiZhKT4+MTAsaT0xMDIzJmE7ZS5wdXNoKHtwdDpyLHRzX29mZnNldDpvLGxlbmd0aDppLGRhdGE6bmV3IFVpbnQ4QXJyYXl9KSxuKz00fX1sZXQgYT10LmJ5dGVMZW5ndGgtbjtmb3IoY29uc3QgciBvZiBlKXtpZihyLmxlbmd0aD5hKXJldHVybiBjb25zb2xlLndhcm4oIkJyb2tlbiByZWQgcGF5bG9hZCIpLFtdO3IubGVuZ3RoPjAmJihyLmRhdGE9bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIsdC5ieXRlT2Zmc2V0K24sci5sZW5ndGgpLG4rPXIubGVuZ3RoLGEtPXIubGVuZ3RoKX1pZihhPjApe2NvbnN0IHI9e3B0OmUubGVuZ3RoPjA/ZVtlLmxlbmd0aC0xXS5wdDowLHRzX29mZnNldDowLGxlbmd0aDphLGRhdGE6bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIsdC5ieXRlT2Zmc2V0K24sYSl9O2UucHVzaChyKX1yZXR1cm4gZX0odCk7aWYoZS5sZW5ndGg+MCl7Y29uc3QgdD1mdW5jdGlvbih0KXtsZXQgZT0wO2ZvcihsZXQgbj0wO248dC5sZW5ndGg7bisrKWUrPW48dC5sZW5ndGgtMT80OjEsZSs9dFtuXS5sZW5ndGg7Y29uc3Qgbj1uZXcgVWludDhBcnJheShlKTtsZXQgYT0wO2ZvcihsZXQgZT0wO2U8dC5sZW5ndGg7ZSsrKWlmKGU8dC5sZW5ndGgtMSl7Y29uc3Qgcj0oMjE0NzQ4MzY0OHwoMTI3JnRbZV0ucHQpPDwyNHwoMjYyMTQzJnRbZV0udHNfb2Zmc2V0KTw8MTB8MTAyMyZ0W2VdLmxlbmd0aCk+Pj4wO25bYSsrXT1yPj4yNCYyNTUsblthKytdPXI+PjE2JjI1NSxuW2ErK109cj4+OCYyNTUsblthKytdPTI1NSZyfWVsc2UgblthKytdPTEyNyZ0W2VdLnB0O2Zvcihjb25zdCBlIG9mIHQpbi5zZXQoZS5kYXRhLGEpLGErPWUubGVuZ3RoO3JldHVybiBufShlLm1hcCgodD0+e2NvbnN0IGU9bmV3IFVpbnQ4QXJyYXkodC5sZW5ndGgpO2Uuc2V0KHQuZGF0YSk7Y29uc3Qgbj1kKG5ldyBEYXRhVmlldyhlLmJ1ZmZlcikpO3JldHVybiBuPy5mcmFtZSYmKHQuZGF0YT1uPy5mcmFtZSkscj1uLHR9KSkpO24udmFsdWUuZGF0YT10LmJ1ZmZlcn19ZWxzZSByPWQodCksciYmKG4udmFsdWUuZGF0YT1yLmZyYW1lLmJ1ZmZlcik7aWYocil7bGV0IHQ9ci50bHYuZmluZCgodD0+dC50YWc9PT1jLk1FVEFEQVRBKSk7aWYodCYmdC52YWx1ZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkmJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHttZXRhZGF0YTp0LnZhbHVlfSksdD1yLnRsdi5maW5kKCh0PT50LnRhZz09PWMuQVVESU9fNjRfQklUX1BUUykpLHQmJnQudmFsdWUgaW5zdGFuY2VvZiBVaW50OEFycmF5JiY4PT10LnZhbHVlLmxlbmd0aCl7Y29uc3Qgbj1uZXcgRGF0YVZpZXcodC52YWx1ZS5idWZmZXIpLmdldEJpZ1VpbnQ2NCgwLCEwKTt0JiZ0LnZhbHVlIGluc3RhbmNlb2YgVWludDhBcnJheSYmZS5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe3B0czpufSl9fX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtdHgiPT09ZS5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtnZXRNZXRhZGF0YTohMH0pLG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkQXVkaW9GcmFtZSl7Y29uc3QgdD1yLnNoaWZ0KCk7dCYmKG4udmFsdWUuZGF0YT1mdW5jdGlvbih0LGUsbil7Y29uc3QgYT1uLmJ5dGVMZW5ndGgscj1hK3UrZyxvPWYrbCtyLGk9bmV3IEFycmF5QnVmZmVyKHQuYnl0ZUxlbmd0aCtvKSxjPW5ldyBEYXRhVmlldyhpKTtjLnNldFVpbnQ4KDAscyksYy5zZXRVaW50MTYoMSxyKSxjLnNldFVpbnQ4KDMsZSksYy5zZXRVaW50MTYoNCxhKTtmb3IobGV0IHQ9MDt0PGE7dCsrKWMuc2V0VWludDgoNit0LG5bdF0pO2NvbnN0IGQ9bmV3IFVpbnQ4QXJyYXkoYy5idWZmZXIpO3JldHVybiBkLnNldChuZXcgVWludDhBcnJheSh0KSxvKSxkLmJ1ZmZlcn0obi52YWx1ZS5kYXRhLGMuQVVESU9fNjRfQklUX1BUUyx0KSl9VS53cml0ZShuLnZhbHVlKSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSx0KGUpfX0pKX0oZSl9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKTsK")],{type:"text/javascript"});return setTimeout(()=>i_.revokeObjectURL(n),0),new Worker(i_.createObjectURL(n))}let mT=71,Qv=1,ET=2,gT=1,Zv=2;var ku=function(n){return n[n.AUDIO_LEVEL=1]="AUDIO_LEVEL",n[n.METADATA=2]="METADATA",n[n.AUDIO_64_BIT_PTS=3]="AUDIO_64_BIT_PTS",n}(ku||{});function yl(n){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],t=n.getUint8(0);if(t!==mT)return;let i=n.getUint16(1),r=Qv+ET+i,o=new Uint8Array(n.byteLength-r);o.set(new Uint8Array(n.buffer,r,n.byteLength-r));let s={m:t,tlvLen:i,tlv:[],frame:o},a=Qv+ET;for(;a<r;){let c=n.getUint8(a),d=n.getUint16(a+gT),l=gT+Zv;if(c===ku.AUDIO_LEVEL){let h=n.getUint8(a+l);for(let p=1;p<d;p++)h=h<<8|n.getUint8(a+l+p);s.tlv.push({tag:c,length:d,value:e?127^h>>1:127&h})}else if(c===ku.METADATA||c===ku.AUDIO_64_BIT_PTS){let h=new Uint8Array(d);for(let p=0;p<d;p++)h[p]=n.getUint8(a+l+p);s.tlv.push({tag:c,length:d,value:h})}a+=l+d}return s}let zf=new Map,P_=127,Il=1e-10,Mu=139/13,qf=new Map;function Xf(n,e,t){let i="".concat(n,"-").concat(e,"-").concat(t),r=0;return qf.has(i)?r=qf.get(i):(r=Math.log(function(o,s){let a=o-s;s<a&&(s=a);let c=1;for(let d=o,l=1;d>s;d--,l++)c=c*d/l;return c}(e,n))+n*Math.log(.5)+(e-n)*Math.log(1-.5)-Math.log(t)+t*n,qf.set(i,r)),r<Il&&(r=Il),r}function $v(n,e,t){let i=e.length,r=n.length/i,o=!1;for(let s=0,a=0;s<i;s++){let c=0;for(let d=a+r;a<d;a++)n[a]>t&&c++;e[s]!==c&&(e[s]=c,o=!0)}return o}window.cache=qf;let VU=0;class FU{constructor(e){X(this,"id",void 0),X(this,"immediates",[]),X(this,"lastNonSilence",-1),X(this,"immediateSpeechActivityScore",Il),X(this,"lastLevelChangedTime",Date.now()),X(this,"levels",[]),X(this,"longs",[]),X(this,"longSpeechActivityScore",Il),X(this,"mediums",[]),X(this,"mediumSpeechActivityScore",Il),X(this,"minLevel",0),X(this,"nextMinLevel",0),X(this,"nextMinLevelWindowLength",0),X(this,"energyScore",0),this.id=e||"".concat(VU++),this.immediates.length=50,this.mediums.length=10,this.longs.length=1,this.levels.length=this.immediates.length}computeImmediates(){let e=this.immediates,t=this.levels,i=this.minLevel+Mu,r=!1;for(let o=0;o<e.length;++o){let s=t[o];s<i&&(s=0);let a=Math.floor(s/Mu);e[o]!==a&&(e[o]=a,r=!0)}return r}computeLongs(){return $v(this.mediums,this.longs,4)}computeMediums(){return $v(this.immediates,this.mediums,7)}evaluateImmediateSpeechActivityScore(){this.immediateSpeechActivityScore=Xf(this.immediates[0],13,.78)}evaluateLongSpeechActivityScore(e){this.longSpeechActivityScore=Xf(this.longs[0],10,47),this.longSpeechActivityScore>Il&&(this.lastNonSilence=e)}evaluateMediumSpeechActivityScore(){this.mediumSpeechActivityScore=Xf(this.mediums[0],5,24)}evaluateSpeechActivityScores(e){this.computeImmediates()&&(this.evaluateImmediateSpeechActivityScore(),this.computeMediums()&&(this.evaluateMediumSpeechActivityScore(),this.computeLongs()&&this.evaluateLongSpeechActivityScore(e)))}getLastLevelChangedTime(){return this.lastLevelChangedTime}getLevels(){var e;return"[".concat(xI(e=[...this.levels]).call(e).join(),"]")}getSpeechActivityScore(e){switch(e){case 0:return this.immediateSpeechActivityScore;case 1:return this.mediumSpeechActivityScore;case 2:return this.longSpeechActivityScore;default:throw new Error("interval "+e)}}levelChanged(e,t){if(this.lastLevelChangedTime<=t){this.lastLevelChangedTime=t;let i=e;return e<0&&(i=0),e>P_&&(i=P_),this.levels.unshift(i),this.levels.length>this.immediates.length&&this.levels.pop(),this.updateMinLevel(i),i>=this.minLevel+Mu?i:i/2}return-1}levelTimedOut(){this.levelChanged(0,this.lastLevelChangedTime)}updateMinLevel(e){if(e!==0){if(this.minLevel===0||this.minLevel>e)return this.minLevel=e,this.nextMinLevel=0,void(this.nextMinLevelWindowLength=0);if(this.nextMinLevel===0)return this.nextMinLevel=e,void(this.nextMinLevelWindowLength=1);if(this.nextMinLevel>e&&(this.nextMinLevel=e),this.nextMinLevelWindowLength++,this.nextMinLevelWindowLength>=750){let t=Math.sqrt(this.minLevel*this.nextMinLevel);t<0?t=0:t>P_&&(t=P_),this.minLevel=t,this.nextMinLevel=0,this.nextMinLevelWindowLength=0}}}}class BU{constructor(e){X(this,"algorithm",void 0),this.algorithm=e}execute(){let e=!this.algorithm;if(!e)try{let t=this.algorithm.runInDecisionMaker(this);t<=0?e=!0:setTimeout(this.execute.bind(this),t)}catch{e=!0}e&&this.algorithm&&this.algorithm.decisionMakerExited(this)}}class NP{constructor(e,t,i){X(this,"isDominant",void 0),X(this,"energyRanking",void 0),X(this,"energyScore",void 0),this.isDominant=e,this.energyRanking=t,this.energyScore=i}}class DP extends Ki{constructor(e){super(),X(this,"dominantId",null),X(this,"lastDecisionTime",0),X(this,"lastLevelChangedTime",0),X(this,"lastLevelIdleTime",0),X(this,"relativeSpeechActivities",[]),X(this,"speakers",new Map),X(this,"enableSilence",!1),X(this,"timeoutToSilenceInterval",0),X(this,"decisionMaker",null),X(this,"loudest",[]),X(this,"numLoudestToTrack",3),X(this,"energyExpireTimeMs",250),X(this,"energyAlphaPct",50),this.timeoutToSilenceInterval=e,this.enableSilence=e>0,this.relativeSpeechActivities.length=3}setLoudestConfig(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:3,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0;this.numLoudestToTrack=e,t!=null&&(this.energyExpireTimeMs=t),i!=null&&(this.energyAlphaPct=i),this.loudest.length>e&&this.loudest.splice(e)}getDominantSpeaker(){return this.dominantId}isAmongLoudest(e){return this.loudest.some(t=>t.id===e)}levelChanged(e,t){let i=Date.now(),r=this.getOrCreateSpeaker(e);this.lastLevelChangedTime<i&&(this.lastLevelChangedTime=i,this.maybeStartDecisionMaker());let o=r.levelChanged(t,i);return this.updateLoudestList(r,o,i)}runInDecisionMaker(e){return this.decisionMaker!==e||this.lastDecisionTime>0&&this.lastDecisionTime-this.lastLevelChangedTime>=15e3?-1:this._runInDecisionMaker()}decisionMakerExited(e){this.decisionMaker===e&&(this.decisionMaker=null)}destroy(){this.decisionMaker=null,this.loudest.length=0,this.speakers.clear(),this.removeAllListeners()}addSpeakers(e){e.forEach(t=>{this.speakers.has(t.id)||this.speakers.set(t.id,t)})}removeSpeakers(e){e.forEach(t=>{this.speakers.delete(t.id)})}getOrCreateSpeaker(e){let t=this.speakers.get(e);return t||(t=new FU(e),this.speakers.set(e,t),this.maybeStartDecisionMaker()),t}updateLoudestList(e,t,i){let r=e.id===this.dominantId;if(t<0){let c=0;for(;c<this.loudest.length&&this.loudest[c]!==e;)++c;return new NP(r,c,e.energyScore)}if(e.energyScore=Math.floor((this.energyAlphaPct*t+(100-this.energyAlphaPct)*e.energyScore+50)/100),this.numLoudestToTrack===0)return new NP(r,0,e.energyScore);let o=i-this.energyExpireTimeMs,s=0;for(;s<this.loudest.length;){let c=this.loudest[s];if(c.getLastLevelChangedTime()<o&&this.loudest.length>=this.numLoudestToTrack)this.loudest.splice(s,1);else if(c.id!==e.id)++s;else if(this.loudest.splice(s,1),this.loudest.length<this.numLoudestToTrack)break}let a=0;for(;a<this.loudest.length&&!(this.loudest[a].energyScore<e.energyScore);)++a;return a<this.numLoudestToTrack&&(this.loudest.splice(a,0,e),this.loudest.length>this.numLoudestToTrack&&this.loudest.splice(this.numLoudestToTrack,1)),new NP(r,a,e.energyScore)}maybeStartDecisionMaker(){!this.decisionMaker&&this.speakers.size>0&&(this.decisionMaker=new BU(this),this.decisionMaker.execute())}makeDecision(e){let t=null,i=null,r=this.speakers.size,o=null;if(r===0)o=null;else if(r===1){var s;let a=Vr(s=this.speakers).call(s).next().value;this.enableSilence&&a&&(o=a.id,a.evaluateSpeechActivityScores(e),e-a.lastNonSilence>this.timeoutToSilenceInterval&&(o=null))}else{let a=this.dominantId==null?null:this.speakers.get(this.dominantId);if(a==null){let l=this.speakers.entries().next();l.value&&(o=l.value[0],a=l.value[1])}else o=a.id;a==null||a.evaluateSpeechActivityScores(e);let c=this.relativeSpeechActivities,d=2;for(let l of this.speakers.entries()){let[h,p]=l;if(p===a)continue;p.evaluateSpeechActivityScores(e);for(let S=0;S<c.length;++S){let T=a==null?Il:a.getSpeechActivityScore(S);c[S]=Math.log(p.getSpeechActivityScore(S)/T)}let f=c[0],m=c[1],g=c[2];f>3&&m>2&&g>0&&m>d&&(d=m,o=h)}this.enableSilence&&a!=null&&o===a.id&&e-a.lastNonSilence>this.timeoutToSilenceInterval&&(o=null)}o==null&&!this.enableSilence||o===this.dominantId||(t=this.dominantId,this.dominantId=o,i=this.dominantId),i==null&&!this.enableSilence||i===t||this.emit("ActiveSpeakerChanged",i)}_runInDecisionMaker(){let e=Date.now(),t=300-(e-this.lastLevelIdleTime),i=0;t<=0?(this.lastLevelIdleTime!==0&&this.timeoutIdleLevels(e),this.lastLevelIdleTime=e):i=t;let r=300-(e-this.lastDecisionTime);return r<=0&&(this.lastDecisionTime=e,this.makeDecision(e),r=300-(Date.now()-e)),r>0&&i>r&&(i=r),i}timeoutIdleLevels(e){let t=[];for(let r of Vr(i=this.speakers).call(i)){var i;let o=e-r.getLastLevelChangedTime();36e5<o&&(this.dominantId==null||r.id!==this.dominantId)?t.push(r.id):300<o&&r.levelTimedOut()}t.forEach(r=>this.speakers.delete(r))}}let Jf=new Map,bs=null,ya=null,ST=3,Uh=[],ps=new Map,Ia=new Map;class eC{get samples(){return this.actives+this.inactives}get activeRate(){return this.actives/this.samples}constructor(e,t){X(this,"id",void 0),X(this,"track",void 0),X(this,"score",0),X(this,"active",!0),X(this,"muted",!1),X(this,"timer",0),X(this,"actives",0),X(this,"inactives",0),this.id=e,this.track=t,this.setActive(ps.size<3)}autoCheckActive(){this.autoSetActive(),this.autoAdjustActive(),this.resetTimer(),this.actives=0,this.inactives=0}autoSetActive(){let e=this.active;this.active=this.activeRate>=.8;let{actives:t,inactives:i}=function(){let r=[],o=[];return Array.from(Vr(ps).call(ps)).forEach(s=>{s.active?r.push(s):o.push(s)}),{actives:r,inactives:o}}();if(t.length>3){let r;t.forEach(o=>{(!r||r.score>o.score)&&(r=o)}),r&&r.setActive(!1)}if(t.length<3&&i.length>0){let r;i.forEach(o=>{(!r||r.score<o.score)&&o.id!==this.id&&(r=o)}),r&&e&&!this.active&&(r.samples>40&&r.activeRate-this.activeRate>.4?r.setActive(!0):this.active=!0)}this.setMuted(!this.active)}setActive(e){this.active=e,this.resetTimer(),this.setMuted(!e)}autoAdjustActive(){this.active?this.autoSwitchToInactive():this.autoSwitchToActive()}autoSwitchToActive(){let e=function(t){let i;return Array.from(Vr(ps).call(ps)).forEach(r=>{!r.active||r.id===t||r.samples<40||(!i||r.score<i.score)&&(i=r)}),i}(this.id);e&&this.activeRate-e.activeRate>.4&&(e.setActive(!1),this.setActive(!0))}autoSwitchToInactive(){let e=function(t){let i;return Array.from(Vr(ps).call(ps)).forEach(r=>{r.active||r.id===t||r.samples<40||(!i||r.score>i.score)&&(i=r)}),i}(this.id);e&&e.activeRate-this.activeRate>.4&&(e.setActive(!0),this.setActive(!1))}addSample(e){e?this.actives+=1:this.inactives+=1,this.samples>66.66666666666667&&this.autoCheckActive()}setMuted(e){this.track&&(this.track.enabled=!e,this.muted=e)}resetTimer(){this.clearTimer(),this.timer=window.setTimeout(()=>{if(this.samples!==0)return this.samples<50?this.resetTimer():void this.autoCheckActive()},1e3)}clearTimer(){this.timer&&(clearTimeout(this.timer),this.timer=0)}}let tC;function TT(n){let e=ps.get(n);e&&(ps.delete(n),e.clearTimer())}let RT=new Map,iC=new Map,PP="video/h264",vT="video/h265";function rC(n,e,t){let i=new Uint8Array(n,e,t),r=[],o=0;for(;r.length<t;)o+3<t&&i[o]===0&&i[o+1]===0&&i[o+2]===3&&(i[o+3]===0||i[o+3]===1||i[o+3]===2||i[o+3]===3)?(r.push(i[o],i[o+1],i[o+3]),o+=4):(r.push(i[o]),o++);return new Uint8Array(r)}function LP(n){let e=n.length,t=[],i=0;for(;i<e;)i+2<e&&n[i]===0&&n[i+1]===0&&(n[i+2]===0||n[i+2]===1||n[i+2]===2||n[i+2]===3)?(t.push(n[i],n[i+1],3,n[i+2]),i+=3):(t.push(n[i]),i++);return new Uint8Array(t)}function kP(n){if(n.length<5)return"";let e=-1;for(let r=0;r<n.length-3;r++){if(n[r]===0&&n[r+1]===0&&n[r+2]===1){e=r;break}if(r<n.length-4&&n[r]===0&&n[r+1]===0&&n[r+2]===0&&n[r+3]===1){e=r;break}}if(e===-1)return"";let t=e+(n[e+2]===0?4:3);if(t>=n.length)return"";let i=n[t];return 128&i?"":(i>>1&63)>=32||t+1<n.length&&!(248&n[t+1])?vT:(31&i)<=31?PP:""}let CT=new Map,xh=new Map;(function(){let n=Zt();$.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),$.getStreamFromExtension=n.name===pt.CHROME&&Number(n.version)>34,$.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let e=new RTCPeerConnection,t=!1;try{e.addTransceiver("audio"),t=!0}catch{}return e.close(),t}(),$.supportMinBitrate=n.name===pt.CHROME||n.name===pt.EDGE,$.supportSetRtpSenderParameters=function(){let e=Zt();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!Ud()||!(!Cr()&&!tT())||e.name===pt.FIREFOX&&Number(e.version)>=64)}(),n.name===pt.SAFARI&&(Number(n.version)>=14?$.supportDualStream=!0:$.supportDualStream=!1),$.webAudioMediaStreamDest=function(){let e=Zt();return!(e.name===pt.SAFARI&&Number(e.version)<12)}(),$.supportReplaceTrack=!!window.RTCRtpSender&&typeof RTCRtpSender.prototype.replaceTrack=="function",$.supportWebGL=typeof WebGLRenderingContext<"u",$.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,Ud()||($.webAudioWithAEC=!0),$.supportShareAudio=function(){let e=Zt();return(e.os===pr.WIN_10||e.os===pr.WIN_81||e.os===pr.WIN_7||e.os===pr.LINUX||e.os===pr.MAC_OS||e.os===pr.CHROMIUM_OS)&&e.name===pt.CHROME&&Number(e.version)>=74}(),$.supportDataChannel=!!(Dr(76)||Rl(68)||fv(14)),$.supportPCSetConfiguration=function(){let e=window.RTCPeerConnection;return!ji()&&!!e&&e.prototype.setConfiguration instanceof Function}(),$.supportWebRTCEncodedTransform=Dr(87)||pn()||Rl(117),$.supportWebRTCInsertableStream=function(){let e=Zt();return(e.name===pt.CHROME||e.name===pt.EDGE)&&Number(e.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),$.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,$.supportWebCrypto=typeof window<"u"&&window.crypto!==void 0&&window.crypto.subtle!==void 0,$.supportSuppressLocalAudioPlayback=YN(),$.supportRestrictOwnAudio=zN(),Au(()=>{$.supportDualStreamEncoding=function(){let e=Zt();return!!F("DISABLE_WEBAUDIO")||e.name==="Safari"&&Number(e.version)>=14||!!(e.name==="Chrome"&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&F("CHROME_DUAL_STREAM_USE_ENCODING"))}(),y.debug("browser ua: ",navigator.userAgent),y.info("browser info: ",n),y.info("browser compatibility: ",$)})})();let yT=["CHINA","GLOBAL"],jU=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Vh=[],Lc=[];function kc(n,e){return!!e&&Vh.some(t=>t.uid===n&&t.channelName===e)}function Uu(){return Lc.length>0}var MP=sM.forEach,GU=_p("forEach")?[].forEach:function(n){return MP(this,n,arguments.length>1?arguments[1]:void 0)};qe({target:"Array",proto:!0,forced:[].forEach!==GU},{forEach:GU});var WU=ln("Array","forEach"),YY=Gs,zY=Bi,qY=me,XY=WU,UP=Array.prototype,xP={DOMTokenList:!0,NodeList:!0},JY=function(n){var e=n.forEach;return n===UP||qY(UP,n)&&e===UP.forEach||zY(xP,YY(n))?XY:e},QY=A(JY),ZY=Co,HU=Tp;qe({target:"Object",stat:!0,forced:P(function(){HU(1)})},{keys:function(n){return HU(ZY(n))}});var KU=A(Qr.Object.keys),$Y=A(kI),ez=A(UI),tz=qe,YU=eu,zU=kp,iz=ir,qU=vE,XU=js,rz=Fs,nz=jg,oz=qt,sz=Hs,az=S0("slice"),cz=oz("species"),VP=Array,FP=Math.max;tz({target:"Array",proto:!0,forced:!az},{slice:function(n,e){var t,i,r,o=rz(this),s=XU(o),a=qU(n,s),c=qU(e===void 0?s:e,s);if(YU(o)&&(t=o.constructor,(zU(t)&&(t===VP||YU(t.prototype))||iz(t)&&(t=t[cz])===null)&&(t=void 0),t===VP||t===void 0))return sz(o,a,c);for(i=new(t===void 0?VP:t)(FP(c-a,0)),r=0;a<c;a++,r++)a in o&&nz(i,r,o[a]);return i.length=r,i}});var dz=ln("Array","slice"),lz=me,uz=dz,BP=Array.prototype,jP=function(n){var e=n.slice;return n===BP||lz(BP,n)&&e===BP.slice?uz:e},hz=A(jP);function Oe(n,e,t,i,r){var o,s,a,c={};return QY(o=KU(i)).call(o,function(d){c[d]=i[d]}),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=$Y(s=ez(a=hz(t).call(t)).call(a)).call(s,function(d,l){return l(n,e,d)||d},c),r&&c.initializer!==void 0&&(c.value=c.initializer?c.initializer.call(r):void 0,c.initializer=void 0),c.initializer===void 0?(f0(n,e,c),null):c}let Ae=function(n){return n[n.ACCESS_POINT=101]="ACCESS_POINT",n[n.UNILBS=201]="UNILBS",n[n.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",n}({}),Qf=function(n){return n[n.IIIEGAL_APPID=1]="IIIEGAL_APPID",n[n.IIIEGAL_UID=2]="IIIEGAL_UID",n[n.INTERNAL_ERROR=3]="INTERNAL_ERROR",n}({}),ta=function(n){return n[n.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",n[n.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",n[n.INTERNAL_ERROR=8]="INTERNAL_ERROR",n[n.NO_AUTHORIZED=9]="NO_AUTHORIZED",n[n.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",n[n.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",n[n.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",n[n.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",n[n.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",n[n.USER_OVERLOAD=16]="USER_OVERLOAD",n[n.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",n[n.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",n[n.REQ_DOWNGRADE_FALLBACK=27]="REQ_DOWNGRADE_FALLBACK",n}({}),Lr=function(n){return n[n.NO_FLAG_SET=100]="NO_FLAG_SET",n[n.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",n[n.INVALID_FALG_SET=102]="INVALID_FALG_SET",n[n.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",n[n.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",n[n.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",n[n.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",n[n.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",n[n.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",n[n.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",n[n.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",n[n.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",n[n.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",n[n.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",n[n.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",n[n.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",n[n.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",n[n.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",n[n.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",n}({}),Fe=function(n){return n[n.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",n[n.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",n[n.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",n[n.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",n[n.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",n[n.K_TICKET_INVALID=7]="K_TICKET_INVALID",n[n.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",n[n.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",n[n.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",n[n.K_UID_BANNED=14]="K_UID_BANNED",n[n.K_IP_BANNED=15]="K_IP_BANNED",n[n.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",n[n.DATASTREAM2_NOT_AVAILABLE=27]="DATASTREAM2_NOT_AVAILABLE",n[n.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",n[n.K_VOS_FALLBACK=30]="K_VOS_FALLBACK",n[n.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",n[n.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",n[n.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",n[n.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",n[n.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",n[n.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",n[n.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",n[n.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",n[n.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",n[n.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",n[n.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",n[n.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",n[n.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",n[n.ERR_INVALID_UID=117]="ERR_INVALID_UID",n[n.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",n[n.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",n[n.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",n[n.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",n[n.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",n[n.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",n[n.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",n[n.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",n[n.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",n[n.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",n[n.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",n[n.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",n[n.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",n[n.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",n[n.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",n[n.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",n[n.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",n[n.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",n[n.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",n[n.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",n[n.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",n[n.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",n[n.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",n[n.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",n[n.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",n[n.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",n[n.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",n[n.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",n[n.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",n[n.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",n[n.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",n[n.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",n[n.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",n[n.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",n[n.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",n[n.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",n[n.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",n}({}),ye=function(n){return n.CONNECTING="connecting",n.CONNECTED="connected",n.RECONNECTING="reconnecting",n.CLOSED="closed",n}({}),Ee=function(n){return n.WS_CONNECTED="ws_connected",n.WS_RECONNECTING="ws_reconnecting",n.WS_CLOSED="ws_closed",n.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",n.ON_BINARY_DATA="on_binary_data",n.REQUEST_RECOVER="request_recover",n.REQUEST_JOIN_INFO="request_join_info",n.REQUEST_REJOIN_INFO="req_rejoin_info",n.IS_P2P_DISCONNECTED="is_p2p_dis",n.DISCONNECT_P2P="dis_p2p",n.ABORT_P2P_EXECUTION="abort_p2p_execution",n.NEED_RENEW_SESSION="need-sid",n.REPORT_JOIN_GATEWAY="report_join_gateway",n.REQUEST_TIMEOUT="request_timeout",n.REQUEST_SUCCESS="request_success",n.JOIN_RESPONSE="join_response",n.PRE_CONNECT_PC="pre_connect_pc",n.DATACHANNEL_PRECONNECT="datachannel_preconnect",n.DATACHANNEL_CONNECTING="datachannel_connecting",n.DATACHANNEL_FAILBACK="datachannel_failback",n.P2P_CONNECTION="p2p_connection",n.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",n.P2P_SUBSCRIBE="p2p_subscribe",n.P2P_UNSUBSCRIBE="p2p_unsubscribe",n.P2P_EXCHANGE_SDP="p2p_exchange_sdp",n.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",n.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",n.RECOVER_NOTIFICATION="recover_notification",n.VOS_FALLBACK="vos_fallback",n.VOS_FALLBACK_PROMISE="vos_fallback_promise",n}({}),le=function(n){return n.PING="ping",n.PING_BACK="ping_back",n.JOIN="join_v3",n.REJOIN="rejoin_v3",n.LEAVE="leave",n.SET_CLIENT_ROLE="set_client_role",n.PUBLISH="publish",n.PUBLISH_DATASTREAM="publish_datastream",n.UNPUBLISH="unpublish",n.UNPUBLISH_DATASTREAM="unpublish_datastream",n.SUBSCRIBE="subscribe",n.PRE_SUBSCRIBE="pre_subscribe",n.SUBSCRIBE_DATASTREAM="subscribe_datastream",n.SUBSCRIBE_STREAMS="subscribe_streams",n.UNSUBSCRIBE="unsubscribe",n.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",n.UNSUBSCRIBE_STREAMS="unsubscribe_streams",n.SUBSCRIBE_CHANGE="subscribe_change",n.TRAFFIC_STATS="traffic_stats",n.RENEW_TOKEN="renew_token",n.SET_DUAL_STREAM_MODE="set_dual_stream_mode",n.SWITCH_VIDEO_STREAM="switch_video_stream",n.DEFAULT_VIDEO_STREAM="default_video_stream",n.SET_FALLBACK_OPTION="set_fallback_option",n.CONFIGURE="configure",n.GATEWAY_INFO="gateway_info",n.CONTROL="control",n.SEND_METADATA="send_metadata",n.DATA_STREAM="data_stream",n.PICK_SVC_LAYER="pick_svc_layer",n.RESTART_ICE="restart_ice",n.CONNECT_PC="connect_pc",n.SET_VIDEO_PROFILE="set_video_profile",n.SET_PARAMETER="set_parameter",n.SET_RTM2_FLAG="set_rtm2_flag",n.DOWNGRADE_CODEC="downgrade_codec",n}({}),Be=function(n){return n.WRTC_STATS="wrtc_stats",n.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",n.DENOISER_STATS="denoiser_stats",n.EXTENSION_USAGE_STATS="extension_usage_stats",n}({}),it=function(n){return n.ON_USER_ONLINE="on_user_online",n.ON_USER_OFFLINE="on_user_offline",n.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",n.ON_PUBLISH_STREAM="on_publish_stream",n.ON_UPLINK_STATS="on_uplink_stats",n.ON_P2P_LOST="on_p2p_lost",n.ON_REMOVE_STREAM="on_remove_stream",n.ON_ADD_AUDIO_STREAM="on_add_audio_stream",n.ON_ADD_VIDEO_STREAM="on_add_video_stream",n.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",n.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",n.ON_USER_BANNED="on_user_banned",n.ON_USER_LICENSE_BANNED="on_user_license_banned",n.ON_NOTIFICATION="on_notification",n.ON_CRYPT_ERROR="on_crypt_error",n.MUTE_AUDIO="mute_audio",n.MUTE_VIDEO="mute_video",n.UNMUTE_AUDIO="unmute_audio",n.UNMUTE_VIDEO="unmute_video",n.ON_P2P_OK="on_p2p_ok",n.RECEIVE_METADATA="receive_metadata",n.ON_DATA_STREAM="on_data_stream",n.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",n.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",n.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",n.ENABLE_LOCAL_VIDEO="enable_local_video",n.DISABLE_LOCAL_VIDEO="disable_local_video",n.ENABLE_LOCAL_AUDIO="enable_local_audio",n.DISABLE_LOCAL_AUDIO="disable_local_audio",n.ON_PUBLISHED_USER_LIST="on_published_user_list",n.ENABLE_MULTI_STREAM="enable_multi_stream",n}({}),Ke=function(n){return n.SEND_ONLY="SEND_ONLY",n.RECEIVE_ONLY="RECEIVE_ONLY",n}({}),Je=function(n){return n.CONNECTED="websocket:connected",n.RECONNECTING="websocket:reconnecting",n.WILL_RECONNECT="websocket:will_reconnect",n.CLOSED="websocket:closed",n.FAILED="websocket:failed",n.ON_MESSAGE="websocket:on_message",n.REQUEST_NEW_URLS="websocket:request_new_urls",n.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",n.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",n.ON_FALLBACK="websocket:on_fallback",n}({});function ht(n){if(typeof n!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(n))throw y.error("Invalid Channel Name ".concat(n)),new H(L.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function L_(n){if(e=n,!(typeof e=="number"&&Math.floor(e)===e&&0<=e&&e<=4294967295||_r(n,1,255)))throw new H(L.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var e;typeof n=="string"&&y.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let Mc=function(n){return n.TRANSCODE="mix_streaming",n.RAW="raw_streaming",n}({}),xu={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},GP={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function IT(n,e){_n(n.url,"".concat(e,".url"),1,1e3,!1),Pi(n.x)||Rt(n.x,"".concat(e,".x"),0,1e4),Pi(n.y)||Rt(n.y,"".concat(e,".y"),0,1e4),Pi(n.width)||Rt(n.width,"".concat(e,".width"),0,1e4),Pi(n.height)||Rt(n.height,"".concat(e,".height"),0,1e4),Pi(n.zOrder)||Rt(n.zOrder,"".concat(e,".zOrder"),0,255),Pi(n.alpha)||Rt(n.alpha,"".concat(e,".alpha"),0,1,!1)}let WP={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},Fh=function(n){return n.WARNING="@live_uap-warning",n.ERROR="@line_uap-error",n.PUBLISH_STREAM_STATUS="@live_uap-publish-status",n.WORKER_STATUS="@live_uap-worker-status",n.REQUEST_NEW_ADDRESS="@live_uap-request-address",n}({}),Al=function(n){return n.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",n}({}),Gr=function(n){return n[n.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",n[n.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",n[n.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",n[n.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",n[n.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",n[n.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",n[n.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",n[n.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",n[n.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",n[n.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",n[n.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",n[n.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",n[n.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",n[n.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",n[n.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",n[n.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",n[n.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",n[n.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",n[n.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",n[n.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",n[n.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",n}({});function qr(n){if(!n.channelName)throw new H(L.INVALID_PARAMS,"invalid channelName in info");if(typeof n.uid!="number")throw new H(L.INVALID_PARAMS,"invalid uid in info, uid must be a number");return n.token&&_n(n.token,"info.token",1,2047),L_(n.uid),ht(n.channelName),!0}let zo=function(n){return n[n.SetSdkProfile=0]="SetSdkProfile",n[n.SetSourceChannel=1]="SetSourceChannel",n[n.SetSourceUserId=2]="SetSourceUserId",n[n.SetDestChannel=3]="SetDestChannel",n[n.StartPacketTransfer=4]="StartPacketTransfer",n[n.StopPacketTransfer=5]="StopPacketTransfer",n[n.UpdateDestChannel=6]="UpdateDestChannel",n[n.Reconnect=7]="Reconnect",n[n.SetVideoProfile=8]="SetVideoProfile",n}({}),gn=function(n){return n.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",n.NETWORK_CONNECTED="NETWORK_CONNECTED",n.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",n.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",n.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",n.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",n.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",n.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",n.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",n.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",n}({}),An=function(n){return n.RELAY_STATE_IDLE="RELAY_STATE_IDLE",n.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",n.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",n.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",n}({}),lo=function(n){return n.RELAY_OK="RELAY_OK",n.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",n.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",n.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",n}({}),_i=function(n){return n.High="high",n.Low="low",n.Audio="audio",n.Screen="screen",n.ScreenLow="screen_low",n}({}),_t=function(n){return n.DISCONNECT="disconnect",n.CONNECTION_STATE_CHANGE="connection-state-change",n.NETWORK_QUALITY="network-quality",n.STREAM_TYPE_CHANGE="stream-type-change",n.IS_P2P_DISCONNECTED="is-p2p-dis",n.DISCONNECT_P2P="dis-p2p",n.REQUEST_NEW_GATEWAY_LIST="req-gate-url",n.NEED_RENEW_SESSION="need-sid",n.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",n.JOIN_RESPONSE="join-response",n.RESET_CONNECTION_EVENTS="reset-connection-events",n.PRE_CONNECT_PC="pre-connect_pc",n.UPDATE_GATEWAY_CONFIG="update-gateway-config",n.VOS_FALLBACK="vos-fallback",n.VOS_FALLBACK_PROMISE="vos-fallback-promise",n.RESET_SIGNAL="reset-signal",n.DATACHANNEL_FAILBACK="datachannel-failback",n}({}),Rr=function(n){return n.P2P_DISCONNECTED="P2P_DISCONNECTED",n.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",n.TIMEOUT="TIMEOUT",n.UNKNOWN_REASON="UNKNOWN_REASON",n}({}),Xr=function(n){return n[n.Nothing=0]="Nothing",n[n.Audio=1]="Audio",n[n.LwoVideo=2]="LwoVideo",n[n.Video=4]="Video",n[n.Data=8]="Data",n[n.DataStream0=256]="DataStream0",n[n.DataStream1=512]="DataStream1",n[n.DataStream2=1024]="DataStream2",n[n.DataStream3=2048]="DataStream3",n[n.DataStream4=4096]="DataStream4",n[n.DataStream5=8192]="DataStream5",n[n.DataStream6=16384]="DataStream6",n[n.DataStream7=32768]="DataStream7",n}({}),gt=function(n){return n.CHINA="CHINA",n.ASIA="ASIA",n.NORTH_AMERICA="NORTH_AMERICA",n.EUROPE="EUROPE",n.JAPAN="JAPAN",n.INDIA="INDIA",n.KOREA="KOREA",n.HKMC="HKMC",n.US="US",n.OCEANIA="OCEANIA",n.SOUTH_AMERICA="SOUTH_AMERICA",n.AFRICA="AFRICA",n.OVERSEA="OVERSEA",n.GLOBAL="GLOBAL",n.EXTENSIONS="EXTENSIONS",n}({}),mi=[gt.AFRICA,gt.ASIA,gt.CHINA,gt.EUROPE,gt.GLOBAL,gt.INDIA,gt.JAPAN,gt.NORTH_AMERICA,gt.OCEANIA,gt.OVERSEA,gt.SOUTH_AMERICA],Zn=function(n){return n.CHINA="CN",n.ASIA="AS",n.NORTH_AMERICA="NA",n.EUROPE="EU",n.JAPAN="JP",n.INDIA="IN",n.KOREA="KR",n.HKMC="HK",n.US="US",n.OCEANIA="OC",n.SOUTH_AMERICA="SA",n.AFRICA="AF",n.OVERSEA="OVERSEA",n.GLOBAL="GLOBAL",n.EXTENSIONS="GLOBAL",n}({}),wn={CHINA:{},ASIA:{CODE:Zn.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:Zn.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:Zn.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:Zn.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:Zn.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:Zn.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:Zn.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:Zn.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:Zn.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:Zn.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:Zn.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:Zn.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:Zn.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};Qs&&(wn.CHINA={CODE:Zn.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let Aa=function(n){return n.UPDATE_BITRATE_LIMIT="update_bitrate_limit",n.UPDATE_CLIENT_ROLE_OPTIONS="update_client_role_options",n.UPDATE_REMOTE_VIDEO_STREAM_TYPE="update_remote_video_stream_type",n.FALLBACK_TO_HLS="fallback_to_hls",n.UPDATE_VOS_CONFIGURE="update_vos_configure",n}({});function Uc(n){return!!n&&!(!n.uplink||!n.id)&&n.uplink.max_bitrate!==void 0&&n.uplink.min_bitrate!==void 0}class HP extends Ki{constructor(e,t){super(),U(this,"onICEConnectionStateChange",void 0),U(this,"onConnectionStateChange",void 0),U(this,"onDTLSTransportStateChange",void 0),U(this,"onDTLSTransportError",void 0),U(this,"onICETransportStateChange",void 0),U(this,"onFirstAudioReceived",void 0),U(this,"onFirstVideoReceived",void 0),U(this,"onFirstAudioDecoded",void 0),U(this,"onFirstVideoDecoded",void 0),U(this,"onFirstVideoRender",void 0),U(this,"onFirstVideoBufferReady",void 0),U(this,"onFirstVideoDecodedTimeout",void 0),U(this,"onSelectedLocalCandidateChanged",void 0),U(this,"onSelectedRemoteCandidateChanged",void 0),U(this,"onICECandidateError",void 0),U(this,"getLocalVideoStats",void 0)}}class AT extends HP{constructor(e,t){super(e,t),U(this,"establishPromise",void 0)}}let ke=function(n){return n.VIDEO="video",n.AUDIO="audio",n}({}),be=function(n){return n.UDP_RELAY="udp_relay",n.UDP_TCP_RELAY="udp_tcp_relay",n.TCP_RELAY="tcp_relay",n.RELAY="relay",n}({}),Ir=function(n){return n[n.FIRST_CONNECTION=0]="FIRST_CONNECTION",n[n.UDP_TCP_RESTART=1]="UDP_TCP_RESTART",n[n.RELAY_RESTART=2]="RELAY_RESTART",n[n.TCP_RESTART=3]="TCP_RESTART",n[n.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",n[n.OLD_RESTART=11]="OLD_RESTART",n[n.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",n}({}),wl=["disconnected","failed"],Se=function(n){return n.LocalVideoTrack="videoTrack",n.LocalAudioTrack="audioTrack",n.LocalVideoLowTrack="videoLowTrack",n}({}),ue=function(n){return n.New="new",n.Connected="connected",n.Reconnecting="reconnecting",n.Disconnected="disconnected",n}({}),we=function(n){return n.AudioMetadata="audioMetadata",n.AudioPts="audioPts",n.StateChange="stateChange",n.IceConnectionStateChange="iceConnectionStateChange",n.RequestMuteLocal="requestMuteLocal",n.RequestUnmuteLocal="requestUnmuteLocal",n.RequestRePublish="requestRePublish",n.RequestRePublishDataChannel="requestRePublishDataChannel",n.RequestReSubscribe="requestReSubscribe",n.RequestUploadStats="requestUploadStats",n.RequestUpload="requestUpload",n.MediaReconnectStart="MediaReconnectStart",n.MediaReconnectEnd="MediaReconnectEnd",n.NeedSignalRTT="NeedSignalRTT",n.RequestRestartICE="RequestRestartIce",n.PeerConnectionStateChange="PeerConnectionStateChange",n.RequestReconnect="RequestReconnect",n.RequestReconnectPC="RequestReconnectPC",n.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",n.P2PLost="P2PLost",n.UpdateVideoEncoder="UpdateVideoEncoder",n.ConnectionTypeChange="ConnectionTypeChange",n.RequestLowStreamParameter="RequestLowStreamParameter",n.QueryClientConnectionState="QueryClientConnectionState",n.LocalCandidate="LocalCandidate",n.RequestP2PMuteLocal="requestP2PMuteLocal",n.RequestP2PUnPublish="RequestP2PUnPublish",n.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",n.RequestP2PMuteRemote="RequestP2PMuteRemote",n.RequestP2PRestartICE="RequestP2PRestartICE",n.FirstVideoPreRender="FirstVideoPreRender",n.FirstVideoBufferReady="FirstVideoBufferReady",n}({}),xe=function(n){return n.CONNECTING="CONNECTING",n.RECONNECTING="RECONNECTING",n.CONNECTED="CONNECTED",n.CLOSED="CLOSED",n}({}),Kn=function(n){return n[n.CONNECT_AP=0]="CONNECT_AP",n[n.AP_CONNECTED=1]="AP_CONNECTED",n[n.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",n[n.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",n[n.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",n[n.CONNECT_WORKER=5]="CONNECT_WORKER",n[n.WORKER_CONNECTED=6]="WORKER_CONNECTED",n[n.CLOSED=7]="CLOSED",n}({}),sr=function(n){return n.CONNECTION_STATE_CHANGE="connection-state-change",n.STATE_CHANGE="state-change",n.INSPECT_RESULT="inspect-result",n.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",n.REQUEST_NEW_WORKER_URL="request-new-worker-url",n}({}),br=function(n){return n.NETWORK_ERROR="NETWORK_ERROR",n.SERVER_ERROR="SERVER_ERROR",n.MULTI_IP="MULTI_IP",n.TIMEOUT="TIMEOUT",n.OFFLINE="OFFLINE",n.LEAVE="LEAVE",n.P2P_FAILED="P2P_FAILED",n.FALLBACK="FALLBACK",n}({}),gr=function(n){return n.CONNECTED="transmitter:connected",n.RECONNECTING="transmitter:reconnecting",n.WILL_RECONNECT="transmitter:will_reconnect",n.CLOSED="transmitter:closed",n.FAILED="transmitter:failed",n.ON_MESSAGE="transmitter:on_message",n.REQUEST_NEW_URLS="transmitter:request_new_urls",n.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",n.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",n.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",n.FAILBACK="transmitter:failback",n.PRE_CONNECT_PC="transmitter:pre_connect_pc",n}({}),$i=function(n){return n.CAMERA_CHANGED="camera-changed",n.MICROPHONE_CHANGED="microphone-changed",n.PLAYBACK_DEVICE_CHANGED="playback-device-changed",n.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",n.AUTOPLAY_FAILED="autoplay-failed",n.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",n.SECURITY_POLICY_VIOLATION="security-policy-violation",n}({}),$n=function(n){return n.CONNECTING="CONNECTING",n.RECONNECTING="RECONNECTING",n.CONNECTED="CONNECTED",n.CLOSED="CLOSED",n}({}),Yn=function(n){return n.CONNECTION_STATE_CHANGE="connection-state-change",n.STATE_CHANGE="state-change",n.INSPECT_RESULT="inspect-result",n.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",n.REQUEST_NEW_WORKER_URL="request-new-worker-url",n}({}),Os=function(n){return n[n.CONNECT_AP=0]="CONNECT_AP",n[n.AP_CONNECTED=1]="AP_CONNECTED",n[n.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",n[n.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",n[n.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",n[n.CONNECT_WORKER=5]="CONNECT_WORKER",n[n.WORKER_CONNECTED=6]="WORKER_CONNECTED",n[n.CLOSED=7]="CLOSED",n}({}),ar=function(n){return n.CALL="call",n.CANDIDATE="candidate",n.PUBLISH="publish",n.UNPUBLISH="unpublish",n.CONTROL="control",n.RESTART_ICE="restart_ice",n.ACK="ack",n.RESPONSE="response",n.JOIN="join",n.CHECK="check",n}({}),cr=function(n){return n.ABORT="abort",n}({}),sc=function(n){return n.MUTE_LOCAL_AUDIO="mute_local_audio",n.MUTE_LOCAL_VIDEO="mute_local_video",n.UNMUTE_LOCAL_AUDIO="unmute_local_audio",n.UNMUTE_LOCAL_VIDEO="unmute_local_video",n}({}),Bh=function(n){return n.P2P_TOKEN_TIMEOUT="p2p_token_timeout",n.P2P_TOKEN_CHANGED="p2p_token_changed",n}({}),pz={[Ae.ACCESS_POINT]:{[Lr.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[Lr.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[Lr.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[Lr.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[Lr.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[Lr.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[Lr.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[Lr.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[Lr.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[Lr.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[Lr.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[Lr.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[Lr.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[Lr.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[Lr.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[Lr.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[Lr.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[Lr.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[Ae.UNILBS]:{[ta.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[ta.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[ta.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[ta.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[ta.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[ta.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[ta.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[ta.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[ta.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[ta.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[ta.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[ta.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1},[ta.REQ_DOWNGRADE_FALLBACK]:{desc:"request downgrade fallback",retry:!1}},[Ae.STRING_UID_ALLOCATOR]:{[Qf.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[Qf.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[Qf.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function Zf(n){let e=pz[Math.floor(n/1e4)];if(!e)return{desc:"unknown error",retry:!1};let t=e[n%1e4];if(!t){if(Math.floor(n/1e4)===Ae.ACCESS_POINT){let i=n%1e4;if(i.toString()[0]==="1")return{desc:n.toString(),retry:!1};if(i.toString()[0]==="2")return{desc:n.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return t}let $f={[Fe.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[Fe.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[Fe.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[Fe.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[Fe.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[Fe.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[Fe.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[Fe.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[Fe.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[Fe.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[Fe.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[Fe.DATASTREAM2_NOT_AVAILABLE]:{desc:"DATASTREAM2_NOT_AVAILABLE",action:"quit"},[Fe.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[Fe.K_VOS_FALLBACK]:{desc:"K_VOS_FALLBACK",action:"tryNext"},[Fe.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[Fe.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[Fe.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[Fe.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[Fe.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[Fe.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[Fe.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[Fe.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[Fe.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[Fe.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[Fe.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[Fe.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[Fe.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[Fe.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[Fe.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[Fe.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[Fe.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[Fe.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[Fe.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[Fe.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[Fe.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[Fe.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[Fe.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[Fe.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[Fe.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[Fe.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[Fe.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[Fe.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[Fe.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Fe.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Fe.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[Fe.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[Fe.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[Fe.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[Fe.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[Fe.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[Fe.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[Fe.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[Fe.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[Fe.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[Fe.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[Fe.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[Fe.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[Fe.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[Fe.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[Fe.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[Fe.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[Fe.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[Fe.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[Fe.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[Fe.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function k_(n){return $f[n]||{desc:"UNKNOWN_ERROR_".concat(n),action:"failed"}}function jh(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function nC(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?jh(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):jh(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}function wT(n,e){if(typeof n=="string")return n;let{proxy:t,host:i,port:r}=n;if(e){let o=F("JOIN_GATEWAY_FALLBACK_PORT")||443;return o===443?"wss://".concat(i,"/ws/?p=").concat(Number(r)+150):"wss://".concat(i,":").concat(o,"/ws/?p=").concat(Number(r)+150)}return t?"wss://".concat(t,"/ws/?h=").concat(i,"&p=").concat(r):"wss://".concat(i,":").concat(r)}let KP=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,_z=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,fz=/wss:\/\/(.+):([0-9]+)\/?/,mz=/wss:\/\/(.[^\/]+)\/?/,Ez=0;class gz{constructor(e,t){U(this,"id",0),U(this,"store",void 0),U(this,"recordIndex",void 0),U(this,"websockets",[]),U(this,"try443PortDuration",2e3),U(this,"forceCloseWSDuration",5e3),U(this,"try443PortTimeout",null),U(this,"forceCloseTimeout",null),U(this,"isTry443PortFailed",!1),U(this,"isNormalPortFailed",!1),U(this,"useDoubleDomain",!1),U(this,"useProxy",!1),U(this,"startTime",Date.now()),this.id=++Ez,this.try443PortDuration=F("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=t}closeAllWebsockets(){this.websockets.forEach(e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout),this.forceCloseTimeout=null,this.try443PortTimeout=null}logger(){var e;let t=Date.now()-this.startTime;for(var i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];y.debug("[choose-best-ws ".concat((e=this.store)===null||e===void 0?void 0:e.clientId," ").concat(this.id,"] ").concat(t,"ms:"),...r)}createWebSocket(e,t,i){this.logger("createWebSocket:",e,{isTry443Port:t,hasTimeoutDetection:i});let r=F("GATEWAY_DOMAINS"),o=Date.now(),s=[],a=r.find(p=>{var f;return z(f=e.host).call(f,p)});a||(this.useDoubleDomain=!1);let c=[];if(this.useDoubleDomain)r.forEach(p=>{c.push(wT(nC(nC({},e),{},{host:e.host.replace(a,p)}),t))});else{let p=nC({},e);if(t&&a){let f=r.find(m=>m!==a);f&&(p.host=p.host.replace(a,f))}c.push(wT(p,t))}try{c.forEach(p=>{let f=new WebSocket(p);f.binaryType="arraybuffer",s.push(f),this.logger("ws is connecting:",f.url)})}catch(p){if(this.logger("ws create failed"),s.forEach(f=>f.close()),s.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,t,i);if(!t&&Number(e.port)!==443)return this.createWebSocket(e,!0,i);throw new H(L.WS_ERR,"init websocket failed! Error: ".concat(p.toString()))}let d=ZS();this.store&&this.store.recordJoinChannelService({urls:s.map(p=>p.url),service:"gateway"},this.recordIndex),s.forEach(p=>{p.onopen=()=>{this.logger("onopen: ws ".concat(p.url," open cost ").concat(Date.now()-o,"ms")),this.websockets.forEach(f=>{f!==p&&(f.onopen=null,f.onclose=null,f.onmessage=null,f.close(),this.logger("close backup websocket: ".concat(f.url)))}),this.websockets.length=0,d.resolve(p)},p.onclose=f=>{this.logger("onclose: ws ".concat(p.url," closed cost ").concat(Date.now()-o,"ms state: ").concat(p.readyState));let m=s.every(g=>g.readyState===WebSocket.CLOSED||g.readyState===WebSocket.CLOSING);this.logger("".concat(t?"443":"47xx"," websocket closed, all failed: ").concat(m)),m&&(t||this.isTry443PortFailed||this.useProxy)?(this.logger("onclose: all websocket is closed, ".concat(f.reason)),d.reject({code:f.code,reason:Rr.A_ROUND_WS_FAILED})):!t&&m&&!this.isNormalPortFailed&&this.try443PortTimeout&&(this.logger("all 47xx websocket is closed, try 443 port"),this.clearTimeout(),h()),t?this.isTry443PortFailed=m:this.isNormalPortFailed=m},p.onmessage=f=>this.logger("".concat(p.url," onmessage: ").concat(f.data))}),this.websockets.push(...s);let l=()=>{this.websockets.forEach(p=>p.readyState!==WebSocket.OPEN&&p.close())},h=()=>{if(d.isResolved)return l();Zt().os===pr.MAC_OS&&ji()&&l(),this.createWebSocket(e,!0,!0).then(p=>{d.resolve(p)}).catch(p=>{this.isNormalPortFailed&&d.reject(p),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",d.isResolved),this.forceCloseTimeout=null,l()},this.forceCloseWSDuration)};return i||(()=>{if(t||this.useProxy)return this.logger("add 5s timeout at ".concat(t?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(()=>{this.forceCloseTimeout=null,l()},this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{this.logger("2s timeout, isWebsocket created: ",d.isResolved),this.try443PortTimeout=null,h()},this.try443PortDuration)})(),d.promise}chooseBestWebsocket(e,t,i,r){return this.useDoubleDomain=!!t,typeof e=="string"&&(e=function(o){let s,a,c;return[,s,a,c]=o.match(KP)||[],s||([,a,c]=o.match(_z)||[]),a&&c||([,a,c]=o.match(fz)||[]),a&&c||([,a]=o.match(mz)||[]),a||y.warning("un-destructible url: ",o),{proxy:s,host:a,port:c||"443"}}(e)),this.recordIndex=r,this.useProxy=!!e.proxy,i&&this.useProxy&&(y.warn("cannot use 443 only when use proxy"),i=!1),this.createWebSocket(e,!!i,!1).finally(()=>this.clearTimeout())}}function JU(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}class YP extends Ki{get url(){return this.websocket&&this.websocket.url||this._websocketUrl}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var t;z(t=["tryNext","recover"]).call(t,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(Je.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(Je.CONNECTED):this._state==="closed"?this.emit(Je.CLOSED):this._state==="failed"&&this.emit(Je.FAILED))}resetReconnectCount(e){y.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2],r=arguments.length>3&&arguments[3]!==void 0&&arguments[3],o=arguments.length>4&&arguments[4]!==void 0&&arguments[4],s=arguments.length>5?arguments[5]:void 0;super(),U(this,"_websocketUrl",null),U(this,"connectionID",0),U(this,"currentURLIndex",0),U(this,"urls",[]),U(this,"_reconnectMode","tryNext"),U(this,"reconnectReason",void 0),U(this,"_initMutex",void 0),U(this,"name",void 0),U(this,"_state","closed"),U(this,"reconnectInterrupter",void 0),U(this,"websocket",void 0),U(this,"retryConfig",void 0),U(this,"reconnectCount",0),U(this,"forceCloseTimeout",5e3),U(this,"onlineReconnectListener",void 0),U(this,"useCompress",void 0),U(this,"tryDoubleDomain",!1),U(this,"use443PortOnly",!1),U(this,"wsInflateLength",0),U(this,"wsDeflateLength",0),U(this,"closeEstablishingWs",()=>{}),U(this,"store",void 0),U(this,"joinGatewayRecordIndex",void 0),this.store=s,this.name=e,this.retryConfig=function(h){for(var p=1;p<arguments.length;p++){var f=arguments[p]!=null?arguments[p]:{};p%2?JU(Object(f),!0).forEach(function(m){U(h,m,f[m])}):Object.getOwnPropertyDescriptors?Object.defineProperties(h,Object.getOwnPropertyDescriptors(f)):JU(Object(f)).forEach(function(m){Object.defineProperty(h,m,Object.getOwnPropertyDescriptor(f,m))})}return h}({},t),this.useCompress=i,this.tryDoubleDomain=r,this.use443PortOnly=o,this._initMutex=new mn("websocket",s?s.clientId:void 0);let{timeout:a,timeoutFactor:c}=t,d=Math.max(300,Math.floor(3*a/5)),l=Math.max(1.2,Math.floor(8*c)/10);Gi.ONLINE&&(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l),Wi.on(yn.NETWORK_STATE_CHANGE,(h,p)=>{h!==p&&(this.resetReconnectCount("network state change: ".concat(p," -> ").concat(h)),h===Gi.ONLINE?(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l):(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c))})}getConnection(){return this.websocket||void 0}async init(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,i=await this._initMutex.lock();this._reconnectMode="tryNext",this.forceCloseTimeout=t,this.urls=e,this.state="connecting";try{var r;let o=ZS(),s=this.urls[this.currentURLIndex];(r=this.store)===null||r===void 0||r.beforeConnect(),function(a){return!(aT()||F("USE_NEW_TOKEN")||!F("ENABLE_PREALLOC_PC")&&(a==null||!a.autoSubscribe||F("FORCE_DISABLE_AUTO_SUB")))}(this.store)&&this.emit(gr.PRE_CONNECT_PC),this.createWebSocketConnection(s).then(o.resolve).catch(o.reject),this.once(Je.CLOSED,()=>{o.reject(new O(L.WS_DISCONNECT))}),this.once(Je.CONNECTED,o.resolve),await o.promise}catch{}finally{i()}}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;let i=this.websocket;t?setTimeout(()=>i.close(),500):i.close(),this.websocket=void 0,this._websocketUrl=null}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,t){if(!this.websocket)return void y.warning("[".concat(this.name,"] can not reconnect, no websocket"));e!==void 0&&(this.reconnectMode=e),y.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(t)]},this.joinGatewayRecordIndex);let i=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),i&&i.bind(this.websocket)({code:9999,reason:t})}sendMessage(e){let t=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new O(L.WS_ABORT,"websocket is not ready");try{t||(e=JSON.stringify(e)),this.websocket.send(e)}catch(i){throw new O(L.WS_ERR,"send websocket message error"+i.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){let e=this.wsInflateLength,t=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:t}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var t;let i=ZS();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;let r=l=>{var h;(h=this.store)===null||h===void 0||h.signalChannelOpen(),y.debug("[".concat(this.name,"] websocket opened:"),l),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i.resolve()},o=async l=>{var h;if(y.debug("[".concat(this.name,"] websocket close ").concat((h=this.websocket)===null||h===void 0?void 0:h.url,", code: ").concat(l.code,", reason: ").concat(l.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)i.reject(new O(L.WS_DISCONNECT,"websocket close: ".concat(l.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=l.reason,this.state="reconnecting");let p=Xt(this,Je.WILL_RECONNECT,this.reconnectMode,l.reason)||this.reconnectMode,f=await this.reconnectWithAction(p);if(this.state==="closed")return void y.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!f)return i.reject(new O(L.WS_DISCONNECT,"websocket reconnect failed: ".concat(l.code))),this.close(!0);i.resolve()}},s=l=>{this.emit(Je.ON_MESSAGE,l)},a=l=>{y.warn("[".concat(this.connectionID,"] ws open error ").concat(l))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),F("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=F("GATEWAY_WSS_ADDRESS")),y.debug("[".concat(this.name,"] start connect, url:"),e);let c=(t=this.store)===null||t===void 0?void 0:t.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;this._websocketUrl=wT(e);let l=await this.chooseBestWebsocketConnection(e);this.websocket=l,r&&r(this.websocket.url),this.websocket.onclose=o,this.websocket.onmessage=s,this.websocket.onerror=a,(d=this.store)===null||d===void 0||d.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(l){let h=this.state==="closed",p=l instanceof O,f=p&&l.code===L.WS_ABORT,m=p&&l.code===L.WS_ERR,g=p?l.message:l&&(l.reason||l.toString());y.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(g)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:f?"aborted":"error",errors:[l]},c),h||m?(i.reject(h?new O(L.WS_DISCONNECT,"websocket is closed: ".concat(g)):new O(L.WS_ERR,"init websocket failed: ".concat(g))),m&&y.error("[".concat(this.name,"] init websocket failed: ").concat(g))):o&&o(l)}return i.promise}async reconnectWithAction(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;y.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||Wi.isOnline||!Wi.onlineWaiter||(this.onlineReconnectListener=Wi.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let i=!0;if(this.reconnectInterrupter=()=>i=!1,t){let s=yr(this.reconnectCount,this.retryConfig);y.debug("[".concat(this.name,"] wait ").concat(s,"ms to reconnect websocket, mode: ").concat(e)),await Z.race([fn(s),this.onlineReconnectListener||new Z(()=>{})])}if(this._state==="closed"||!i)return!1;this.reconnectCount+=1;let r=async(s,a)=>{this.emit(Je.RECONNECT_CREATE_CONNECTION,a),await this.createWebSocketConnection(s)};try{if(e==="retry")await r(this.urls[this.currentURLIndex],e);else if(e==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);y.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),await r(this.urls[this.currentURLIndex],e)}else e==="recover"&&(y.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.urls=await fr(this,Je.REQUEST_NEW_URLS),this.currentURLIndex=0,await r(this.urls[this.currentURLIndex],e))}catch(s){var o;y.error("[".concat(this.name,"] reconnect failed ").concat(s&&s.toString()));let a=s==null||(o=s.data)===null||o===void 0?void 0:o.desc;if(Array.isArray(a)){if(z(a).call(a,"dynamic key expired"))return this.emit(Je.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1;if(z(a).call(a,"request downgrade fallback"))return this.emit(Je.ON_FALLBACK),!1}return this.reconnectWithAction(e,t)}return!0}}class oC extends YP{constructor(e,t){super(e,t,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,t){let i=ZS(),r=function(s,a){return new gz(s,a)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{y.debug("[choose-best-ws] close establishing websockets"),r.closeAllWebsockets(),i.reject(new O(L.WS_ABORT,"choose best websocket aborted"))};let o=F("GATEWAY_DOMAINS");return y.debug("[choose-best-ws] currentDomain: ",e,", domains: ",o,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),r.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,t).then(i.resolve).catch(i.reject),i.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class M_ extends YP{constructor(e,t){super(e,t,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,t){return new Z((i,r)=>{let o=!1,s=[];this.closeEstablishingWs=()=>{y.debug("[choose-best-ws] close establishing websockets"),s.forEach(m=>{m.onclose=null,m.onopen=null,m.onmessage=null,m.close()}),r(new O(L.WS_ABORT,"choose best websocket aborted"))};let a=F("GATEWAY_DOMAINS"),c,d=e.indexOf("?h="),l=a.find(m=>d!==-1?z(e).call(e,m,d):z(e).call(e,m));y.debug("[choose-best-ws] currentDomain: ",l,", domains: ",a);let h=!this.tryDoubleDomain||!l;if(!h&&l){var p;let m=Date.now();try{a.forEach(g=>{let S=d===-1?e.replace(l,g):e.substr(0,d)+e.substr(d).replace(l,g),T=new WebSocket(S);T.binaryType="arraybuffer",s.push(T),y.debug("[choose-best-ws] ws is connecting:",T.url)})}catch{for(y.debug("[choose-best-ws] ws create failed, fallback to single url"),s.forEach(g=>g.close());s.length;)s.pop();h=!0}(p=this.store)===null||p===void 0||p.recordJoinChannelService({urls:s.map(g=>g.url),service:"gateway"},t),s.forEach(g=>{g.onopen=()=>{if(o)return;let S=Date.now()-m;y.debug("[choose-best-ws] ws open cost ".concat(S,"ms")),s.filter(T=>T!==g).forEach(T=>{y.debug("[choose-best-ws]close backup websocket: ".concat(T.url)),T.close()}),o=!0,i(g)},g.onclose=S=>{c=S,!o&&(s.find(T=>!(T.readyState===WebSocket.CLOSED||T.readyState===WebSocket.CLOSING))||(y.debug("[choose-best-ws] all websocket is closed"),o=!0,r(c)))},g.onmessage=S=>{y.debug("[choose-best-ws]".concat(g.url," onmessage: ").concat(S.data))}}),fn(this.forceCloseTimeout).then(()=>{s.forEach(g=>{g.readyState!==WebSocket.OPEN&&g.close()})})}if(h){var f;let m;y.debug("[choose-best-ws] use single url: ",e),(f=this.store)===null||f===void 0||f.recordJoinChannelService({urls:[e],service:"gateway"},t);try{m=new WebSocket(e),s.push(m),m.binaryType="arraybuffer"}catch(g){let S=new O(L.WS_ERR,"init websocket failed! Error: ".concat(g.toString()));return y.error("[".concat(this.name,"]").concat(S)),void r(S)}m.onopen=()=>{i(m)},m.onclose=g=>{r(g)},m.onmessage=g=>{y.debug("[choose-best-ws]".concat(m.url," onmessage: ").concat(g.data))},fn(this.forceCloseTimeout).then(()=>{m&&m.readyState!==WebSocket.OPEN&&m.close()})}}).then(i=>(this.closeEstablishingWs=void 0,i)).catch(i=>{throw this.closeEstablishingWs=void 0,i})}}class em extends Ki{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===ye.CONNECTED?this.emit(Ee.WS_CONNECTED):e===ye.RECONNECTING?this.emit(Ee.WS_RECONNECTING,this._websocketReconnectReason):e===ye.CLOSED&&this.emit(Ee.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),U(this,"__name__","AgoraRTCSignal"),U(this,"_disconnectedReason",void 0),U(this,"_websocketReconnectReason",void 0),U(this,"_connectionState",ye.CLOSED),U(this,"reconnectToken",void 0),U(this,"websocket",void 0),U(this,"openConnectionTime",void 0),U(this,"clientId",void 0),U(this,"lastMsgTime",Date.now()),U(this,"uploadCache",[]),U(this,"uploadCacheInterval",void 0),U(this,"rttRolling",new Lf(5)),U(this,"pingpongTimer",void 0),U(this,"wsInflateDataTimer",void 0),U(this,"pingpongTimeoutCount",0),U(this,"ortc",void 0),U(this,"joinResponse",void 0),U(this,"multiIpOption",void 0),U(this,"initError",void 0),U(this,"spec",void 0),U(this,"store",void 0),U(this,"onWebsocketMessage",i=>{if(i.data instanceof ArrayBuffer)return void this.emit(Ee.ON_BINARY_DATA,i.data);let r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){let o="res-@".concat(r._id);this.emit(o,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){if(this.emit(r._type,r._message),r._type===it.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===it.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(Gt.UID_BANNED);break;case 15:this.close(Gt.IP_BANNED);break;case 16:this.close(Gt.CHANNEL_BANNED)}if(r._type===it.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case Fe.ERR_LICENSE_MISSING:this.close(Gt.LICENSE_MISSING);break;case Fe.ERR_LICENSE_EXPIRED:this.close(Gt.LICENSE_EXPIRED);break;case Fe.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Gt.LICENSE_MINUTES_EXCEEDED);break;case Fe.ERR_LICENSE_PERIOD_INVALID:this.close(Gt.LICENSE_PERIOD_INVALID);break;case Fe.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Gt.LICENSE_MULTIPLE_SDK_SERVICE);break;case Fe.ERR_LICENSE_ILLEGAL:this.close(Gt.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new oC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,F("JOIN_GATEWAY_USE_DUAL_DOMAIN"),F("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===ye.CONNECTED&&this.reconnect("retry",Cn.OFFLINE)})}async request(e,t,i,r){let o=vt(6,""),s={_id:o,_type:e,_message:t},a=this.websocket.connectionID,c=()=>new Z((m,g)=>{if(this.connectionState===ye.CONNECTED)return m();let S=()=>{this.off(Ee.WS_CLOSED,T),m()},T=()=>{this.off(Ee.WS_CONNECTED,S),g(new H(L.WS_ABORT))};this.once(Ee.WS_CONNECTED,S),this.once(Ee.WS_CLOSED,T),e!==le.PUBLISH&&e!==le.PUBLISH_DATASTREAM&&e!==le.SUBSCRIBE&&e!==le.SUBSCRIBE_DATASTREAM&&e!==le.UNSUBSCRIBE&&e!==le.UNSUBSCRIBE_DATASTREAM&&e!==le.UNPUBLISH&&e!==le.UNPUBLISH_DATASTREAM&&e!==le.CONTROL&&e!==le.RESTART_ICE||this.once(Ee.DISCONNECT_P2P,()=>{g(new H(L.DISCONNECT_P2P))}),e!==le.PUBLISH&&e!==le.RESTART_ICE||this.once(Ee.ABORT_P2P_EXECUTION,()=>{g(new H(L.DISCONNECT_P2P))})});if(this.connectionState!==ye.CONNECTING&&this.connectionState!==ye.RECONNECTING||e===le.JOIN||e===le.REJOIN||await c(),this.websocket.sendMessage(s,!0),r)return;let d=new Z((m,g)=>{let S=!1,T=(b,D)=>{S=!0,m({isSuccess:b==="success",message:D||{}}),this.off(Ee.WS_CLOSED,C),this.off(Ee.WS_RECONNECTING,C),this.emit(Ee.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(o),T);let C=()=>{g(new H(L.WS_ABORT,"type: ".concat(e))),this.off(Ee.WS_CLOSED,C),this.off(Ee.WS_RECONNECTING,C),this.off("res-@".concat(o),T)};this.once(Ee.WS_CLOSED,C),this.once(Ee.WS_RECONNECTING,C),fn(F("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||S||(y.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(Ee.REQUEST_TIMEOUT,e,t))})}),l=null;try{l=await d}catch(m){if(this.connectionState===ye.CLOSED||e===le.LEAVE)throw new H(L.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?m.throw():e===le.JOIN||e===le.REJOIN?null:(await c(),await this.request(e,t))}if(l.isSuccess)return l.message;let h=Number(l.message.error_code||l.message.code),p=k_(h),f=new H(L.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(l.message.error_str),{code:h,data:l.message,desc:p.desc});return p.action==="success"?l.message:(y.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(h,", message: ").concat(p.desc,", action: ").concat(p.action)),h===Fe.ERR_TOO_MANY_BROADCASTERS?((e===le.JOIN||e===le.REJOIN)&&(this.initError=f,this.close()),f.throw()):p.action==="failed"?f.throw():p.action==="quit"?(this.initError=f,this.close(),f.throw()):(h===Fe.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,y.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Cn.MULTI_IP)):this.reconnect(p.action,Cn.SERVER_ERROR),e===le.JOIN||e===le.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new Z(i=>{let r=o=>{(!t||t(o))&&(this.off(e,r),i(o))};this.on(e,r)})}uploadWRTCStats(e){if(!this.store.sessionId)return void y.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let t={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(Be.WRTC_STATS,t)}upload(e,t){let i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch{let r=F("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>r&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==ye.CONNECTED)return;let o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},F("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){let i={_type:e,_message:t};this.websocket.sendMessage(i)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Z((t,i)=>{this.once(Ee.WS_CONNECTED,()=>t(this.joinResponse)),this.once(Ee.WS_CLOSED,r=>i(this.initError||new H(L.WS_ABORT,r))),this.connectionState=ye.CONNECTING,this.websocket.init(e).catch(i),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||Gt.LEAVE,this.connectionState=ye.CLOSED,y.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close()}async join(){if(!this.joinResponse){this.emit(Ee.ABORT_P2P_EXECUTION),this.store.signalConnected();let e=await fr(this,Ee.REQUEST_JOIN_INFO);this.store.joinReq();let t=await this.request(le.JOIN,e);if(this.ortc=e==null?void 0:e.ortc,this.store.joinRep(),!t)return this.emit(Ee.REPORT_JOIN_GATEWAY,Rr.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(Ee.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=ye.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new H(L.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");let e=co(this,Ee.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;let t=await this.request(le.REJOIN,e);return!!t&&(this.connectionState=ye.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach(i=>{this.emit(it.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(it.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(it.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(it.MUTE_AUDIO,{uid:i.uid}):this.emit(it.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(it.MUTE_VIDEO,{uid:i.uid}):this.emit(it.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(it.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(it.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(it.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(it.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(it.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})}),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}async downgradeCodec(e){if(!this.ortc)return!1;let t={downgrade_codec:e,ortc:this.ortc};return!!await this.request(le.DOWNGRADE_CODEC,t)}handleNotification(e){y.debug("[".concat(this.clientId,"] receive notification: "),e);let t=k_(e.code);if(e.code===28&&"detail"in e&&(y.info("[".concat(this.clientId,"] receive recover notification: "),e.detail),this.emit(Ee.RECOVER_NOTIFICATION,e.detail)),t.action!=="success"){if(t.action!=="failed")return t.action==="quit"?e.code===Fe.ERR_REPEAT_JOIN_CHANNEL&&F("IGNORE_UID_CHECK")?void this.close(Gt.UID_CONFLICT):(t.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Gt.UID_BANNED),void this.close()):e.code===Fe.K_VOS_FALLBACK&&"detail"in e?(y.info("[".concat(this.clientId,"] receive vos fallback notification: "),e.detail),e.detail==="FALLBACKCN"&&F("ENABLE_QUALITY_FALLBACK")?void fr(this,Ee.VOS_FALLBACK_PROMISE,e.detail).then(()=>{this.reconnect("recover",t.desc)}).catch(i=>{y.debug("[".concat(this.clientId,"] cancel vos fallback cn, error: "),i)}):e.detail==="fallback_hls"&&F("ENABLE_FALLBACK_TO_HLS")?(this.emit(Ee.VOS_FALLBACK,e.detail),void this.close(Gt.FALLBACK_TO_HLS)):this.reconnect(t.action,t.desc)):void this.reconnect(t.action,Cn.SERVER_ERROR);y.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let e=F("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(y.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>F("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Cn.TIMEOUT):this.request(le.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let i=Date.now()-t;this.rttRolling.add(i),F("REPORT_STATS")&&this.send(le.PING_BACK,{pingpongElapse:i})}).catch(i=>{})}handleWsInflateData(){let{wsInflateLength:e,wsDeflateLength:t}=this.websocket.getWsInflateData();e!==0&&t!==0&&this.upload(Be.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(Je.RECONNECT_CREATE_CONNECTION,e=>{this.emit(Ee.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(Je.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Je.CLOSED,()=>{this.connectionState=ye.CLOSED}),this.websocket.on(Je.FAILED,()=>{this._disconnectedReason=Gt.NETWORK_ERROR,this.connectionState=ye.CLOSED}),this.websocket.on(Je.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===ye.CONNECTED?this.connectionState=ye.RECONNECTING:this.connectionState=ye.CONNECTING}),this.websocket.on(Je.WILL_RECONNECT,(e,t,i)=>{let r=co(this,Ee.IS_P2P_DISCONNECTED),o=r||e!=="retry";r&&e==="retry"&&(y.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",t=Rr.P2P_DISCONNECTED),o&&(y.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(Ee.REPORT_JOIN_GATEWAY,t||Rr.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(Ee.DISCONNECT_P2P)),i(e)}),this.websocket.on(Je.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{y.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",Cn.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(Ee.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof H){if(e.code===L.UNEXPECTED_RESPONSE&&e.data.code===Fe.ERR_NO_AUTHORIZED)return this.initError=new H(L.TOKEN_EXPIRE,"dynamic key expired"),void this.close(Gt.TOKEN_EXPIRE);y.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Cn.SERVER_ERROR):(this.initError=e,this.close())}})}),this.websocket.on(Je.REQUEST_NEW_URLS,(e,t)=>{fr(this,Ee.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)}),this.websocket.on(Je.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(it.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(gr.PRE_CONNECT_PC,()=>{this.emit(Ee.PRE_CONNECT_PC)}),this.websocket.on(Je.ON_FALLBACK,()=>{F("ENABLE_FALLBACK_TO_HLS")&&this.emit(Ee.VOS_FALLBACK,"fallback_hls")})}}let QU=function(n){return n.NATIVE_RTC="native_rtc",n.NATIVE_RTM="native_rtm",n.WEB_RTC="web_rtc",n.WEB_RTM="web_rtm",n}({}),Wr=function(n){return n[n.CHOOSE_SERVER=11]="CHOOSE_SERVER",n[n.CLOUD_PROXY=18]="CLOUD_PROXY",n[n.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",n[n.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",n}({});function kr(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function bT(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?kr(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):kr(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}let tm=0;function wa(n){let e=F("TURN_DOMAINS");tm=(tm+1)%e.length;let t=e[tm]||"edge.agora.io";return n.match(/^[\.\:\d]+$/)?"".concat(n.replace(/[^\d]/g,"-"),".").concat(t):(y.debug("Cannot recognized as ip address: ".concat(n,", use as host2")),n)}function ia(n){try{let e=F("TURN_DOMAINS"),t=F("GATEWAY_DOMAINS").concat(e).find(i=>z(n).call(n,i));return t?n.split(".".concat(t))[0].replace(/-/g,"."):n}catch{return y.debug("serverUrlToIp error, fallback to url",n),n}}function im(n,e){n.addresses||(n.addresses=[]);let t=function(a,c){if(F("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return a.map(h=>{let{ip:p,port:f}=h;return{address:"".concat(p,":").concat(f)}});let d=F("GATEWAY_DOMAINS"),l=d[1]&&z(c).call(c,d[1])?1:0;return a.map(h=>{let{domain_prefix:p,port:f,ip:m}=h;if(p)return{address:"".concat(p,".").concat(d[l++%d.length],":").concat(f)};let g=/^[\.\:\d]+$/.test(m),S=g?"".concat(m.replace(/[^\d]/g,"-"),".").concat(d[l++%d.length],":").concat(f):"".concat(m,":").concat(f);return g||y.debug("Cannot recognized as ip address: ".concat(m,", use as host3")),{ip:m,port:f,address:S}})}(n.addresses,e),i=Array.isArray(n.detail)&&n.detail[18];if(i&&typeof i=="string"){let a=i.split(";");for(let c=0;c<a.length;c++){var r;let d=rr(r=a[c]).call(r);t[c]&&d&&(t[c].ip6=d)}}let o=n.detail&&n.detail.candidate,s;if(o){let[a,c]=o.split(":");a&&c&&(s={port:Number(c),ip:a,address:"".concat(a,":").concat(c)})}return{gatewayAddrs:t,apGatewayAddress:s,uid:n.uid,cid:n.cid,cert:n.cert,vid:n.detail&&n.detail[8],uni_lbs_ip:n.detail&&n.detail[1],res:n,csIp:n.detail&&n.detail[502]}}function Mo(n){return typeof n=="number"?n:n.exact||n.ideal||n.max||n.min||0}function qo(n){let e=n._encoderConfig;if(!e)return{};let t={resolution:e.width&&e.height?"".concat(Mo(e.width),"x").concat(Mo(e.height)):void 0,maxVideoBW:e.bitrateMax,minVideoBW:e.bitrateMin};return typeof e.frameRate=="number"?(t.maxFrameRate=e.frameRate,t.minFrameRate=e.frameRate):e.frameRate&&(t.maxFrameRate=e.frameRate.max||e.frameRate.ideal||e.frameRate.exact||e.frameRate.min,t.minFrameRate=e.frameRate.min||e.frameRate.ideal||e.frameRate.exact||e.frameRate.max),t}function OT(n){return n>=0&&n<.17?1:n>=.17&&n<.36?2:n>=.36&&n<.59?3:n>=.59&&n<=1?4:n>1?5:0}function Gh(n,e){let t,i,r;switch(e){case Wr.CHOOSE_SERVER:i=4096,r="choose server";break;case Wr.CLOUD_PROXY:i=1048576,r="proxy";break;case Wr.CLOUD_PROXY_5:i=4194304,r="proxy5";break;case Wr.CLOUD_PROXY_FALLBACK:i=4194310,r="proxy fallback";break;default:throw new H(L.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:n.detail&&n.detail[502],retry:!1})}if(n.response_body.forEach(o=>{o.buffer&&o.buffer.flag===i&&(t={code:o.buffer.code,addresses:(o.buffer.edges_services||[]).map(s=>bT(bT({},s),{},{ticket:o.buffer.cert})),server_ts:n.enter_ts,uid:o.buffer.uid,cid:o.buffer.cid,cname:o.buffer.cname,detail:bT(bT({},o.buffer.detail),n.detail),flag:o.buffer.flag,opid:n.opid,cert:o.buffer.cert})}),!t)throw new H(L.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(r," from multi unilbs response"),{csIp:n.detail&&n.detail[502]});return t}async function rm(n,e){return await Z.all(n.addresses.map(async t=>({address:wa(t.ip),tcpport:t.port,udpport:t.port,username:e&&F("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?e.toString():Yr.username,password:e&&F("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await Rv(e.toString()):Yr.password})))}function sC(n,e){let t=e.getMediaStreamTrack(!0).getSettings(),i=e.videoHeight||t.height,r=e.videoWidth||t.width;return i&&r?Math.max(Math.min(i,r)/Math.min(Mo(n.height),Mo(n.width)),1):(y.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function bl(n){let{candidateType:e,relayProtocol:t,type:i,address:r,port:o,protocol:s}=n,a={candidateType:e,relayProtocol:t,protocol:s};if(i!=="local-candidate"){let c=r.split(".");c.length>=4&&(c[1]="*",c[2]="*"),a.address=c.join("."),a.port=o}return a}function _s(n){let e=n.split(":"),t=n.split(/[-.]/),i=z(n).call(n,"-")?"-":".",r=n;return e.length>1?t.length>1?(t[1]="**",r=t[0]+i+"**:"+e[e.length-1]):r=e.length>2?e[0]+i+"**:"+e[e.length-1]:"**:"+e[e.length-1]:t.length>1&&(r=t[0]+i+"**"),r}function Hd(n,e){return n.getTransceivers().find(t=>t.sender.track===e||t.receiver.track===e)}function nm(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:F("SVC_MODE");if(F("ENABLE_SVC"))return function(e){return e in Ou}(n)?n:Ou.L1T3}let om={[ke.VIDEO]:[{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"},{key:"video-orientation",extensionName:"urn:3gpp:video-orientation"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"playout-delay",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"},{key:"video-content-type",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"},{key:"color-space",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/color-space"},{key:"video-timing",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"}],[ke.AUDIO]:[{key:"ssrc-audio-level",extensionName:"urn:ietf:params:rtp-hdrext:ssrc-audio-level"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}]};function zP(n){n.send&&(Vu(ke.VIDEO,n.send.videoExtensions),Vu(ke.AUDIO,n.send.audioExtensions)),n.recv&&(Vu(ke.VIDEO,n.recv.videoExtensions),Vu(ke.AUDIO,n.recv.audioExtensions)),n.sendrecv&&(Vu(ke.VIDEO,n.sendrecv.videoExtensions),Vu(ke.AUDIO,n.sendrecv.audioExtensions))}function qP(n,e){n.send&&(NT(ke.VIDEO,n.send.videoExtensions,e.send.videoExtensions),NT(ke.AUDIO,n.send.audioExtensions,e.send.audioExtensions)),n.recv&&(NT(ke.VIDEO,n.recv.videoExtensions,e.recv.videoExtensions),NT(ke.AUDIO,n.recv.audioExtensions,e.recv.audioExtensions))}function NT(n,e,t){e.forEach(i=>{var r;let o=om[n].find(a=>{var c;let{key:d}=a;return z(c=i.extensionName).call(c,d)});if(!o)return;let s=t.find(a=>{let{extensionName:c}=a;return z(c).call(c,o.key)});s&&z(r=s.extensionName).call(r,"gdpr_forbidden")&&(i.extensionName=s.extensionName)})}function Vu(n,e){e.forEach(t=>{var i;let r=om[n].find(o=>{var s;let{key:a}=o;return z(s=t.extensionName).call(s,a)});z(i=t.extensionName).call(i,"gdpr_forbidden")&&r&&(t.extensionName=r.extensionName)})}function U_(n){return n==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"||z(n).call(n,"abs-send-time")}function DT(n){return n==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"||z(n).call(n,"draft-holmer-rmcat-transport-wide-cc-extensions-01")}function PT(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function XP(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?PT(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):PT(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}function sm(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0,{filterRTX:r,filterVideoFec:o,filterAudioFec:s,filterAudioCodec:a,filterVideoCodec:c,unsupportedVideoUplinkCodec:d,unsupportedVideoDownlinkCodec:l}=e,{useXR:h}=t,p=[],f=[],m=[],g=[],S=!1,T=!1;if(Oo(n).mediaDescriptions.forEach(b=>{i&&i!==b.attributes.direction||(b.media.mediaType!=="video"||S||(f=b.attributes.payloads,g=b.attributes.extmaps,S=!0),b.media.mediaType!=="audio"||T||(p=b.attributes.payloads,m=b.attributes.extmaps,T=!0))}),!g||f.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!m||p.length===0)throw new Error("Cannot get audio capabilities from SDP.");if(f.forEach(b=>{var D;(D=b.rtpMap)!==null&&D!==void 0&&D.clockRate&&(b.rtpMap.clockRate=parseInt(b.rtpMap.clockRate)),h&&b.rtcpFeedbacks.push({type:"rrtr"})}),p.forEach(b=>{var D;(D=b.rtpMap)!==null&&D!==void 0&&D.clockRate&&(b.rtpMap.clockRate=parseInt(b.rtpMap.clockRate)),h&&b.rtcpFeedbacks.push({type:"rrtr"})}),r&&(p=p.filter(b=>{var D;return((D=b.rtpMap)===null||D===void 0?void 0:D.encodingName.toLowerCase())!=="rtx"}),f=f.filter(b=>{var D;return((D=b.rtpMap)===null||D===void 0?void 0:D.encodingName.toLowerCase())!=="rtx"})),o){let b=f.filter(k=>{var V;return/(red)|(ulpfec)|(flexfec)/i.test(((V=k.rtpMap)===null||V===void 0?void 0:V.encodingName)||"")}),D=Vc(b,f).map(k=>k.payloadType),x=[...b.map(k=>k.payloadType),...D];f=f.filter(k=>!z(x).call(x,k.payloadType))}if(s&&(p=p.filter(b=>{var D;return!/(red)|(ulpfec)|(flexfec)/i.test(((D=b.rtpMap)===null||D===void 0?void 0:D.encodingName)||"")})),a&&(a==null?void 0:a.length)>0&&(p=p.filter(b=>{var D;return z(a).call(a,((D=b.rtpMap)===null||D===void 0?void 0:D.encodingName.toLowerCase())||"")})),c&&(c==null?void 0:c.length)>0){let b=f.filter(D=>{var x;return z(c).call(c,((x=D.rtpMap)===null||x===void 0?void 0:x.encodingName.toLowerCase())||"")});f=b.concat(r?[]:Vc(b,f))}let C=F("UNSUPPORTED_VIDEO_CODEC");if(C&&C.length>0){let b=f.filter(k=>k.rtpMap&&z(C).call(C,k.rtpMap.encodingName.toLowerCase())),D=Vc(b,f),x=b.concat(D).map(k=>k.payloadType);f=f.filter(k=>!z(x).call(x,k.payloadType)),y.debug("unsupportedVideoCodec: ".concat(C,", toBeRemoved: ").concat(x))}if(d&&d.length>0&&i==="sendonly"){let b=f.filter(k=>k.rtpMap&&z(d).call(d,k.rtpMap.encodingName.toLowerCase())),D=Vc(b,f),x=b.concat(D).map(k=>k.payloadType);f=f.filter(k=>!z(x).call(x,k.payloadType)),y.debug("unsupportedVideoUplinkCodec: ".concat(d,", toBeRemoved: ").concat(x))}if(l&&l.length>0&&i==="recvonly"){let b=f.filter(k=>k.rtpMap&&z(l).call(l,k.rtpMap.encodingName.toLowerCase())),D=Vc(b,f),x=b.concat(D).map(k=>k.payloadType);f=f.filter(k=>!z(x).call(x,k.payloadType)),y.debug("unsupportedVideoDownlinkCodec: ".concat(l,", toBeRemoved: ").concat(x))}return{audioCodecs:p,videoCodecs:f,audioExtensions:m,videoExtensions:g}}function ba(n){let e=Oo(n),t,i;for(let r of e.mediaDescriptions){if(!t){let o=r.attributes.iceUfrag,s=r.attributes.icePwd;if(!o||!s)throw new Error("Cannot get iceUfrag or icePwd from SDP.");t={iceUfrag:o,icePwd:s}}if(!i){let o=r.attributes.fingerprints;o.length>0&&(i={fingerprints:o})}}if(!i&&e.attributes.fingerprints.length>0&&(i={fingerprints:e.attributes.fingerprints}),!i||!t)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:t,dtlsParameters:i}}function xc(n,e){let t=[],i=n.attributes.ssrcGroups.filter(s=>s.semantic==="FID"),r=n.attributes.ssrcGroups.find(s=>s.semantic==="SIM"),o=n.attributes.ssrcs;if(r)r.ssrcIds.forEach(s=>{var a;let c=(a=i.find(d=>d.ssrcIds[0]===s))===null||a===void 0?void 0:a.ssrcIds[1];t.push({ssrcId:s,rtx:e?c:void 0})});else if(i.length>0){let s=i[0].ssrcIds[0],a=i[0].ssrcIds[1];t.push({ssrcId:s,rtx:e?a:void 0})}else{if(o.length===0)throw new Error("No ssrcs found on local media description.");t.push({ssrcId:o[0].ssrcId})}return t}function aC(n,e,t){let{cname:i}=n,r=[];e&&(r=JP(e)),r.length===0&&(r=n.iceParameters.candidates.map(l=>({foundation:l.foundation,componentId:"1",transport:l.protocol,priority:l.priority.toString(),connectionAddress:l.ip,port:l.port.toString(),type:l.type,extension:{}})),y.debug("Using candidates from gateway."));let o={fingerprints:n.dtlsParameters.fingerprints.map(l=>({hashFunction:l.algorithm,fingerprint:l.fingerprint}))},s={iceUfrag:n.iceParameters.iceUfrag,icePwd:n.iceParameters.icePwd},a;switch(n.dtlsParameters.role){case"server":a="passive";break;case"client":a="active";break;case"auto":a="actpass"}let c=Ns(n.rtpCapabilities),d=[];return Array.isArray(t)&&t.length>0&&t.forEach(l=>{d.push({kind:ke.VIDEO,ssrcMsg:[{ssrcId:l.v,rtx:l.v_rtx}],mslabel:"".concat(l.v,"_").concat(l.a)},{kind:ke.AUDIO,ssrcMsg:[{ssrcId:l.a}],mslabel:"".concat(l.v,"_").concat(l.a)})}),{dtlsParameters:o,iceParameters:s,candidates:r,rtpCapabilities:c,setup:a,cname:i,preSSRCs:d}}function JP(n){let e=[];return n.ip&&typeof n.port=="number"&&(e=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:n.ip,port:n.port.toString(),type:"host",extension:{}}],y.debug("Using remote candidate from AP ".concat(_s(n.ip),":").concat(n.port)),n.ip6&&(e.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:n.ip6,port:n.port.toString(),type:"host",extension:{}}),y.debug("Using IPV6 remote candidate from AP ".concat(_s(n.ip6),":").concat(n.port)))),e}function am(n,e,t){let i=[],r=[];return n.forEach(o=>{let{ssrcId:s,rtx:a}=o,c=vt(8,"track-"),d={ssrcId:s,attributes:XP({label:c,mslabel:t=t||vt(10,""),msid:"".concat(t," ").concat(c)},e&&{cname:e})};if(i.push(d),a!==void 0){let l={ssrcId:a,attributes:XP({label:c,mslabel:t,msid:"".concat(t," ").concat(c)},e&&{cname:e})};i.push(l),r.push({semantic:"FID",ssrcIds:[s,a]})}}),n.length>1&&r.push({semantic:"SIM",ssrcIds:n.map(o=>{let{ssrcId:s}=o;return s})}),{ssrcs:i,ssrcGroups:r}}function Kd(n,e){e instanceof ri&&n.attributes.payloads.forEach(t=>{var i;let r=(i=t.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase();if(!r||["opus","pcmu","pcma","g722"].indexOf(r)===-1)return;t.fmtp||(t.fmtp={parameters:{}}),r==="opus"&&typeof F("OPUS_PTIME")=="number"?t.fmtp.parameters.ptime=F("OPUS_PTIME"):t.fmtp.parameters.minptime="10",t.fmtp.parameters.useinbandfec="1";let o=e._encoderConfig;o&&(r!=="pcmu"&&r!=="pcma"&&r!=="g722"&&(o.bitrate&&!ji()&&(t.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*o.bitrate))),o.sampleRate&&(t.fmtp.parameters.maxplaybackrate="".concat(o.sampleRate),t.fmtp.parameters["sprop-maxcapturerate"]="".concat(o.sampleRate)),o.stereo&&(t.fmtp.parameters.stereo="1",t.fmtp.parameters["sprop-stereo"]="1")),e instanceof Zi&&r==="opus"&&e._config.DTX&&(t.fmtp.parameters.usedtx="1"))})}function Fu(n){let e=n.attributes.unrecognized.findIndex(t=>t.attField==="x-google-flag"&&t.attValue==="conference");e!==-1&&n.attributes.unrecognized.splice(e,1)}function LT(n,e){var t;if(n.attributes.payloads.forEach(r=>{var o;((o=r.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())==="h264"&&r.fmtp&&r.fmtp.parameters&&F("ENABLE_UP_SPS_PPS")&&(r.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")}),!(e instanceof Jt&&e._encoderConfig&&e._hints.indexOf(Re.SCREEN_TRACK)===-1))return;let i=e._encoderConfig;ot().supportMinBitrate&&i.bitrateMin&&n.attributes.payloads.forEach(r=>{var o,s;z(o=["h264","h265","vp8","vp9","av1"]).call(o,((s=r.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-min-bitrate"]="".concat(i.bitrateMin))}),ot().supportMinBitrate&&!z(t=e._hints).call(t,Re.LOW_STREAM)&&i.bitrateMax&&n.attributes.payloads.forEach(r=>{var o,s;z(o=["h264","h265","vp8","vp9","av1"]).call(o,((s=r.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-start-bitrate"]="".concat(F("X_GOOGLE_START_BITRATE")||Math.floor(i.bitrateMax)))})}function cC(n){if(n.media.mediaType!=="video")return;let e=Zt();if(e.name!==pt.SAFARI&&e.os!==pr.IOS)return;let t=n.attributes.extmaps.findIndex(i=>/video-orientation/g.test(i.extensionName));t!==-1&&n.attributes.extmaps.splice(t,1)}function kT(n,e,t){if(!e)return;let i,r;if(n.media.mediaType==="video"?(i=t.videoExtensions,r=t.videoCodecs):(i=t.audioExtensions,r=t.audioCodecs),e.twcc===!0){let o=i.find(s=>DT(s.extensionName));if(o){let s=o.extensionName;n.attributes.extmaps.find(a=>DT(a.extensionName))||n.attributes.extmaps.push({entry:o.entry,extensionName:s}),function(a,c){return c.filter(d=>!!a.find(l=>l.payloadType===d.payloadType&&!!l.rtcpFeedbacks.find(h=>h.type==="transport-cc")))}(r,n.attributes.payloads).forEach(a=>{a.rtcpFeedbacks.find(c=>c.type==="transport-cc")||a.rtcpFeedbacks.push({type:"transport-cc"})})}}else if(e.twcc===!1){let o=n.attributes.extmaps.findIndex(s=>DT(s.extensionName));o!==-1&&n.attributes.extmaps.splice(o,1),n.attributes.payloads.forEach(s=>{let a=s.rtcpFeedbacks.findIndex(c=>c.type==="transport-cc");a!==-1&&s.rtcpFeedbacks.splice(a,1)})}if(e.remb===!0){let o=i.find(s=>U_(s.extensionName));if(o){let s=o.extensionName;n.attributes.extmaps.find(a=>a.extensionName===s)||n.attributes.extmaps.push({entry:o.entry,extensionName:s}),function(a,c){return c.filter(d=>!!a.find(l=>l.payloadType===d.payloadType&&!!l.rtcpFeedbacks.find(h=>h.type==="goog-remb")))}(r,n.attributes.payloads).forEach(a=>{a.rtcpFeedbacks.find(c=>c.type==="goog-remb")||a.rtcpFeedbacks.push({type:"goog-remb"})})}}else if(e.remb===!1){let o=n.attributes.extmaps.findIndex(s=>U_(s.extensionName));o!==-1&&n.attributes.extmaps.splice(o,1),n.attributes.payloads.forEach(s=>{let a=s.rtcpFeedbacks.findIndex(c=>c.type==="goog-remb");a!==-1&&s.rtcpFeedbacks.splice(a,1)})}}function cm(n,e,t){if(ji()||n.media.mediaType!=="video"||!(e instanceof Jt)||t!=="vp9"&&t!=="vp8"||t==="vp8"&&!F("SIMULCAST")||t==="vp9"&&F("ENABLE_SVC")||e._scalabilityMode===void 0||e._scalabilityMode.numSpatialLayers<=1)return;let i=t==="vp8"?2:e._scalabilityMode.numSpatialLayers,r=n.attributes.ssrcs[0],o=n.attributes.ssrcGroups.find(a=>a.semantic==="FID"&&a.ssrcIds[0]===r.ssrcId),s={semantic:"SIM",ssrcIds:[r.ssrcId]};for(let a=1;a<i;a++)n.attributes.ssrcs.push({ssrcId:r.ssrcId+a,attributes:Li(r.attributes)}),s.ssrcIds.push(r.ssrcId+a),o&&(n.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+a,attributes:Li(r.attributes)}),n.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[r.ssrcId+a,o.ssrcIds[1]+a]}));n.attributes.ssrcGroups.unshift(s)}async function dC(){try{let n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly",sendEncodings:[{scalabilityMode:Ou.L1T3}]});let e=await n.createOffer();if(!e.sdp)return void n.close();let t=Oo(e.sdp).mediaDescriptions[0];if(!t)return;let i=t.attributes.extmaps.find(r=>r.extensionName==="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension");return n.close(),i}catch{return}}async function lC(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},t=new RTCPeerConnection;t.addTransceiver("video",{direction:"sendonly"}),t.addTransceiver("audio",{direction:"sendonly"}),t.addTransceiver("video",{direction:"recvonly"}),t.addTransceiver("audio",{direction:"recvonly"});let i=(await t.createOffer()).sdp,{send:r,recv:o,sendrecv:s}=function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d=arguments.length>2?arguments[2]:void 0,l=sm(d,a,c,"sendonly"),h=sm(d,a,c,"recvonly"),p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},f={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},m={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(ac(l,h,"videoExtensions",p,f,m),ac(l,h,"videoCodecs",p,f,m),ac(l,h,"audioExtensions",p,f,m),ac(l,h,"audioCodecs",p,f,m),F("RAISE_H264_BASELINE_PRIORITY")){let g=[],S=[];if(m.videoCodecs.forEach((T,C)=>{var b;if(((b=T.rtpMap)===null||b===void 0?void 0:b.encodingName.toLocaleLowerCase())==="h264"){var D,x;let k=m.videoCodecs[C+1],V=k&&UT(T,k),W=(D=T.fmtp)===null||D===void 0?void 0:D.parameters["profile-level-id"],K=(x=T.fmtp)===null||x===void 0?void 0:x.parameters["packetization-mode"];!W||W!==F("FIRST_H264_PROFILE_LEVEL_ID")||F("FIRST_PACKETIZATION_MODE")&&K!==F("FIRST_PACKETIZATION_MODE")?V?S.push([T,k]):S.push([T]):V?g.push([T,k]):g.push([T])}}),g.length>0&&S.length>0){y.debug("raising H264 baseline profile priority"),m.videoCodecs.forEach((C,b)=>{var D;if(((D=C.rtpMap)===null||D===void 0?void 0:D.encodingName.toLocaleLowerCase())==="h264"){let x=UT(C,m.videoCodecs[b+1]),k=g.shift()||S.shift()||[];k.length>0&&(x?m.videoCodecs.splice(b,2,...k):m.videoCodecs.splice(b,1,...k))}});let T=f.videoCodecs.filter(C=>{var b,D;return((b=C.rtpMap)===null||b===void 0?void 0:b.encodingName.toLocaleLowerCase())==="h264"&&((D=C.fmtp)===null||D===void 0?void 0:D.parameters["profile-level-id"])!==F("FIRST_H264_PROFILE_LEVEL_ID")});if(T.length>0){let C=Vc(T,f.videoCodecs).map(D=>D.payloadType),b=[...T.map(D=>D.payloadType),...C];f.videoCodecs=f.videoCodecs.filter(D=>!z(b).call(b,D.payloadType))}F("FILTER_SEND_H264_BASELINE")&&(p.videoCodecs=p.videoCodecs.filter(C=>{var b,D;return!(((b=C.rtpMap)===null||b===void 0?void 0:b.encodingName.toLocaleLowerCase())==="h264"&&((D=C.fmtp)===null||D===void 0?void 0:D.parameters["profile-level-id"])!==F("FIRST_H264_PROFILE_LEVEL_ID"))}))}return{send:p,recv:f,sendrecv:m}}return{send:p,recv:f,sendrecv:m}}(n,e,i);try{t.close()}catch{}return{send:r,recv:o,sendrecv:s}}function uC(){let n={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},e=sm(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),t={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(ac(n,e,"videoExtensions",t,i,r),ac(n,e,"videoCodecs",t,i,r),ac(n,e,"audioExtensions",t,i,r),ac(n,e,"audioCodecs",t,i,r),F("RAISE_H264_BASELINE_PRIORITY")){let o=r.videoCodecs.findIndex(s=>s.rtpMap&&s.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&s.fmtp&&s.fmtp.parameters["profile-level-id"]==="42001f");if(o!==-1){let s=r.videoCodecs.findIndex(a=>a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(s<o){y.debug("raising H264 baseline profile priority");let a=r.videoCodecs[o];r.videoCodecs.splice(o,1),r.videoCodecs.splice(s,0,a)}s!==-1&&(i.videoCodecs=i.videoCodecs.filter(a=>!(a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&a.fmtp&&a.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:t,recv:i,sendrecv:r}}function ac(n,e,t,i,r,o){if(t==="videoExtensions"||t==="audioExtensions"){let s=[];return n[t].forEach(a=>{e[t].some((c,d)=>{if(a.entry===c.entry&&a.extensionName===c.extensionName)return s.push(d),!0})?o[t].push(a):i[t].push(a)}),void e[t].forEach((a,c)=>{s.indexOf(c)===-1&&r[t].push(a)})}if(t==="videoCodecs"||t==="audioCodecs"){let s=[];return n[t].forEach(a=>{e[t].some((c,d)=>{if(a.payloadType===c.payloadType&&JSON.stringify(a)===JSON.stringify(c))return s.push(d),!0})?o[t].push(a):i[t].push(a)}),void e[t].forEach((a,c)=>{s.indexOf(c)===-1&&r[t].push(a)})}}function Ns(n){let{send:e,recv:t,sendrecv:i}=n;if(!i){if(!e||!t)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:e,recv:t}}let r,o;return e?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...e.audioCodecs,...i.audioCodecs],r.videoCodecs=[...e.videoCodecs,...i.videoCodecs],r.audioExtensions=[...e.audioExtensions,...i.audioExtensions],r.videoExtensions=[...e.videoExtensions,...i.videoExtensions]):r=Li(i),t?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...t.audioCodecs,...i.audioCodecs],o.videoCodecs=[...t.videoCodecs,...i.videoCodecs],o.audioExtensions=[...t.audioExtensions,...i.audioExtensions],o.videoExtensions=[...t.videoExtensions,...i.videoExtensions]):o=Li(i),{send:r,recv:o}}function Ol(n){n.media.mediaType==="audio"&&n.attributes.payloads.filter(e=>{var t;return((t=e.rtpMap)===null||t===void 0?void 0:t.encodingName.toLowerCase())==="opus"}).forEach(e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"})}function Nl(n,e,t,i){let r=[];if(n===ke.VIDEO){if(F("H264_PROFILE_LEVEL_ID")&&i==="h264"&&(r=e.videoCodecs.filter(o=>{var s;return z(s=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(s,i)&&o&&o.fmtp&&o.fmtp.parameters["profile-level-id"]===F("H264_PROFILE_LEVEL_ID")})),!Array.isArray(r)||r.length===0){let o=[],s=[],a=[],c=[];if(t.videoCodecs.forEach(d=>{let l=d.rtpMap&&d.rtpMap.encodingName.toLowerCase()||"";z(l).call(l,i)?o.push(d):z(l).call(l,"vp9")?s.push(d):z(l).call(l,"vp8")?a.push(d):z(l).call(l,"h264")&&c.push(d)}),o.length===0){let d="";s.length!==0?(o=s,d="vp9"):a.length!==0?(o=a,d="vp8"):c.length!==0&&(o=c,d="h264"),y.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(d))}o.length!==0&&(r=e.videoCodecs.filter(d=>o.some(l=>l.payloadType===d.payloadType)))}if(r.length===0&&(y.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(e.videoCodecs[0].rtpMap&&e.videoCodecs[0].rtpMap.encodingName)),r=e.videoCodecs),F("USE_PUB_RTX")||F("USE_SUB_RTX")){let o=Vc(r,e.videoCodecs);r=[...r,...o]}}else{r=e.audioCodecs.filter(s=>{var a;return z(a=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(a,i)});let o=e.audioCodecs.filter(s=>{var a;return z(a=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(a,"red")});r.length===0&&(y.warning("codec ".concat(i," not included in rtpCapabilities, fallback to opus")),r=e.audioCodecs.filter(s=>{var a;return z(a=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(a,"opus")})),F("ENABLE_AUDIO_RED")&&o.length!==0&&(r=[...o,...r])}return r}function Vc(n,e){let t=n.map(i=>i.payloadType.toString());return e.filter(i=>i.rtpMap&&i.rtpMap.encodingName==="rtx"&&i.fmtp&&i.fmtp.parameters.apt&&z(t).call(t,i.fmtp&&i.fmtp.parameters.apt))}async function zn(n,e,t){let i=e.toString(),r=hC(i,"offer","remote","exchangeSDP");await n.setRemoteDescription({type:"offer",sdp:i});let o=await n.createAnswer();if(!o.sdp)throw new Error("cannot get answer sdp");let s=o.sdp;s=Xo(s,t||{}),r==null||r(s||""),await n.setLocalDescription({type:"answer",sdp:s})}function Xo(n,e,t){if(F("FORBID_MODIFY_LOCAL_OFFER_SDP"))return n;let i=Oo(n),{useXR:r}=e;return i.mediaDescriptions.forEach(o=>{var s;o.attributes.mid&&(Array.isArray(t)&&!z(t).call(t,o.attributes.mid)||(o.media.mediaType==="audio"&&Ol(o),o.media.mediaType==="video"&&function(a){a.media.mediaType==="video"&&F("ENABLE_DOWN_SPS_PPS")&&a.attributes.payloads.filter(c=>{var d;return((d=c.rtpMap)===null||d===void 0?void 0:d.encodingName.toLowerCase())==="h264"}).forEach(c=>{c.fmtp||(c.fmtp={parameters:{}}),c.fmtp.parameters["sps-pps-idr-in-keyframe"]="1"})}(o),r&&z(s=["audio","video"]).call(s,o.media.mediaType)&&o.attributes.payloads.forEach(a=>{a.rtcpFeedbacks.findIndex(c=>c.type==="rrtr")===-1&&a.rtcpFeedbacks.push({type:"rrtr"})})))}),sn(i)}function hC(n,e,t,i){if(F("SDP_LOGGING"))return y.upload("exchanging ".concat(t," ").concat(e," SDP during P2PConnection.").concat(i,`
`),n),e==="offer"?r=>{hC(r,"answer",t==="local"?"remote":"local",i)}:void 0}async function QP(n,e,t){try{var i;if(!ot().supportSetRtpSenderParameters||!function(c){return c==="vp9"||c==="av1"}(n)||!F("ENABLE_SVC"))return;let r={},o={},s=e.getParameters(),a=(i=s.encodings)===null||i===void 0?void 0:i[0];o.scalabilityMode=nm(t),a&&Object.assign(a,o),Object.assign(s,r),await e.setParameters(s),y.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(s.encodings)))}catch(r){y.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",r)}}function MT(n){let e=F("COMPATIBLE_SDP_EXTENSION");return!!(Array.isArray(e)&&e.length>0)&&e.some(t=>z(n).call(n,t))}function UT(n,e){try{var t;return((t=n.fmtp)===null||t===void 0?void 0:t.parameters.apt)===e.payloadType.toString()}catch{return!1}}function ZP(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function Ds(n,e){return typeof F(n)===e?F(n):void 0}function ra(){try{let n=F("EXPERIMENTS")||{};return typeof n=="string"||Array.isArray(n)?{}:function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?ZP(Object(i),!0).forEach(function(r){U(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ZP(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}({},n)}catch(n){return y.debug("handle gateway attributes failed: ",n),{}}}let ZU={};function Yd(n){(!(arguments.length>1&&arguments[1]!==void 0)||arguments[1])&&y.debug("install service ".concat(n.name)),ZU[n.name]=n}function go(n){let e=ZU[n];if(!e)throw new O(L.INVALID_OPERATION,"".concat(n," not found, please use AgoraRTC.use(").concat(n,"Service) to load it first"));return e}function Fc(n,e){return go("DataStream").create(n,e)}function xT(){return go("InterceptFrame").create()}function VT(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function Sn(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?VT(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):VT(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}let an=new Map;class $P extends Ki{get state(){return this._state}set state(e){if(e===this._state)return;let t=this._state;this._state=e,e==="DISCONNECTED"&&this._disconnectedReason?this.emit(_t.CONNECTION_STATE_CHANGE,e,t,this._disconnectedReason):this.emit(_t.CONNECTION_STATE_CHANGE,e,t)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){y.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,t){var i,r,o;super(),U(this,"store",void 0),U(this,"joinInfo",void 0),U(this,"key",void 0),U(this,"ntpOffset",0),U(this,"usingProxy",!1),U(this,"signal",void 0),U(this,"role",void 0),U(this,"isPreallocation",void 0),U(this,"isPreSub",void 0),U(this,"inChannelInfo",{joinAt:null,duration:0}),U(this,"spec",void 0),U(this,"_state","DISCONNECTED"),U(this,"_statsCollector",void 0),U(this,"_disconnectedReason",void 0),U(this,"isSignalRecover",!1),U(this,"hasChangeBGPAddress",!1),U(this,"trafficStatsInterval",void 0),U(this,"networkQualityInterval",void 0),U(this,"_joinGatewayStartTime",0),U(this,"_signalTimeout",!1),U(this,"_clientRoleOptions",void 0),U(this,"_isProactiveJoin",!1),this.store=e,this.spec=t,this.signal=this.store.useP2P?(i={spec:Sn(Sn({},t),{},{retryConfig:t.websocketRetryConfig}),store:e},(r=(o=go("P2PChannel")).createSubmodule)===null||r===void 0?void 0:r.call(o,i)):this.store.useDcSignal?function(s){return go("DataChannelSignal").create(s)}({spec:Sn(Sn({},t),{},{retryConfig:t.websocketRetryConfig}),store:e}):new em(Sn(Sn({},t),{},{retryConfig:t.websocketRetryConfig}),e),this._statsCollector=t.statsCollector,this.role=t.role||"audience",this._clientRoleOptions=t.clientRoleOptions,this.handleSignalEvents()}setUsingProxy(e){this.usingProxy=e}async join(e,t,i){if(this.store.useDcSignal){let l=!1;e.cloudProxyServer!=="disabled"?(y.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(e.cloudProxyServer,")")),l=!0):"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length>255||"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length<22?(y.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),l=!0):e.apResponse.addresses.some(h=>h.fingerprint)||F("FINGERPRINT")||(y.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),l=!0),l&&this.resetSignal()}this.store.joinGatewayStart(),e.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);let r=Date.now(),o=an.get(e.cname);if(o||(o=new Map,an.set(e.cname,o)),this._isProactiveJoin=!0,o.has(e.uid)){let l=new H(L.UID_CONFLICT);throw _e.joinGateway(e.sid,{lts:r,succ:!1,ec:l.code,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,isProxy:!!e.proxyServer||this.usingProxy,signalChannel:this.store.useDcSignal?"1":"0",preload:e.preload}),l}o.set(e.uid,!0),this.joinInfo=e,this.key=t;let s=0;this.joinGatewayStartTime=r;let a=e.proxyServer,c=this.store.useDcSignal?"datachannel":"websocket";try{y.debug("[".concat(this.store.clientId,"] use ").concat(c," join uid ").concat(s));let l=e.gatewayAddrs.map(p=>{let{address:f}=p,[m,g]=f.split(":"),S={host:m,port:g};return e.proxyServer&&(S.proxy=e.proxyServer),S}),h;h=this.store.useDcSignal?await this.signal.init(e.apResponse.addresses):await this.signal.init(l),s=h.uid,y.debug("[".concat(this.store.clientId,"] ").concat(c," join uid ").concat(s," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(l){var d;throw l.code===L.INIT_DATACHANNEL_TIMEOUT&&this.signal.__name__==="AgoraRTCSignal"||_e.joinGateway(e.sid,{lts:r,succ:!1,ec:((d=l.data)===null||d===void 0?void 0:d.desc)||l.code,errorMsg:l.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,isProxy:!!a||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:e.preload}),l&&l.code===L.INIT_DATACHANNEL_TIMEOUT?(y.warning("[".concat(this.store.clientId,"] User join datachannel failed"),l.toString()),this.resetSignal(),l):(y.error("[".concat(this.store.clientId,"] User join failed"),l.toString()),o.delete(e.uid),this.signal.close(),l)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),y.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(l=>{y.warning("[".concat(this.store.clientId,"] get traffic stats error"),l.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(_t.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(_t.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(_t.NETWORK_QUALITY,{uplinkNetworkQuality:OT(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:OT(this._statsCollector.trafficStats.B_dnq)}):this.emit(_t.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),s}async leave(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0],t=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){t!==Gt.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==ye.CONNECTED||await function(i,r){return r===1/0?i:Z.race([i,TU(r)])}(this.signal.request(le.LEAVE,void 0,!0),3e3)}catch(i){y.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),i)}this.signal.close(t),t!==Gt.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,t,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));let r={state:"offer",p2p_id:this.store.p2pId,ortc:t,mode:this.spec.mode,extend:F("PUB_EXTEND"),twcc:!!F("PUBLISH_TWCC"),rtx:!!F("USE_PUB_RTX")};try{return(await this.signal.request(le.PUBLISH,r,!0))._message}catch(o){if(i&&o.data&&o.data.code===Fe.ERR_PUBLISH_REQUEST_INVALID)return y.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),o.toString()),await this.tryUnpubBeforeRepub(e,t),this.publish(e,t,!1);throw o}}async publishDataChannel(e,t,i){var r;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));let o={stream_id:t.streamId,ordered:t.ordered?1:0,max_retrans_times:(r=t.maxRetransmits)!==null&&r!==void 0?r:10,channel_id:t.channelId,metadata:t.metadata};try{await this.signal.request(le.PUBLISH_DATASTREAM,o,!0)}catch(s){if(i&&s.data&&s.data.code===Fe.ERR_PUBLISH_REQUEST_INVALID)return y.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),s.toString()),await this.tryUnpubDataChannelBeforeRepub(e,t),this.publishDataChannel(e,t,!1);throw s}}async unpublish(e,t){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(le.UNPUBLISH,{stream_id:t,ortc:e},!0)}catch(i){y.warning("[".concat(this.store.clientId,"] unpublish warning: "),i)}}async unpublishDataChannel(e){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Z.all(e.map(t=>this.signal.request(le.UNPUBLISH_DATASTREAM,{channel_id:t},!0)))}catch(t){y.warning("unpublish datachannels warning: ",t)}}async presubscribe(e,t,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));let r={stream_id:e,stream_type:t,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!F("SUBSCRIBE_TWCC"),rtx:!!F("USE_SUB_RTX")||void 0,extend:F("SUB_EXTEND"),svc:Array.isArray(F("SVC"))&&F("SVC").length!==0?F("SVC"):void 0};try{return await this.signal.request(le.PRE_SUBSCRIBE,r,!0)}catch(o){if(i&&o.data&&o.data.code===Fe.ERR_SUBSCRIBE_REQUEST_INVALID)return y.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),o.toString()),this.presubscribe(e,t,!1);throw o}}async subscribe(e,t,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));let r={stream_id:e,stream_type:t.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!F("SUBSCRIBE_TWCC"),rtx:!!F("USE_SUB_RTX"),extend:F("SUB_EXTEND"),ssrcId:t.ssrcId,svc:Array.isArray(F("SVC"))&&F("SVC").length!==0?F("SVC"):void 0};try{return(await this.signal.request(le.SUBSCRIBE,r,!0))._message}catch(o){if(i&&o.data&&o.data.code===Fe.ERR_SUBSCRIBE_REQUEST_INVALID)return y.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),o.toString()),await this.tryUnsubBeforeResub(e,t),await this.subscribe(e,t,!1);throw o}}async subscribeDataChannel(e,t,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));let r={uid:e,stream_id:t.id,channel_id:t.datachannelId};try{return void await this.signal.request(le.SUBSCRIBE_DATASTREAM,r,!0)}catch(o){if(i&&o.data&&o.data.code===Fe.ERR_SUBSCRIBE_REQUEST_INVALID)return y.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),o.toString()),await this.tryUnsubDataChannelBeforeResub(e,t),await this.subscribeDataChannel(e,t,!1);throw o}}async subscribeAll(e,t){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));let i={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!F("USE_SUB_RTX"),twcc:!!F("SUBSCRIBE_TWCC"),svc:Array.isArray(F("SVC"))&&F("SVC").length!==0?F("SVC"):void 0};try{return await this.signal.request(le.SUBSCRIBE_STREAMS,i,!0)}catch(r){if(t&&r.data&&r.data.code===Fe.ERR_SUBSCRIBE_REQUEST_INVALID)return y.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),r.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw r}}async setVideoProfile(e){let t=function(i){if(!(i.bitrateMax&&i.bitrateMin&&i.frameRate&&i.height&&i.width))return;let r=i.frameRate,o=i.width,s=i.height,a=!0;return typeof r!="number"&&(r=r.exact||r.ideal||r.max||r.min||0,r||(a=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,o||(a=!1)),typeof s!="number"&&(s=s.exact||s.ideal||s.max||s.min||0,r||(a=!1)),a?{stream_type:0,width:o,height:s,fps:r,start_bps:1e3*i.bitrateMax,min_bps:1e3*i.bitrateMin,target_bps:1e3*i.bitrateMax}:void 0}(e);if(t)return this.signal.request(le.SET_VIDEO_PROFILE,t);y.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,t){try{await this.signal.request(le.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:t},!0)}catch(i){y.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),i)}}async unsubscribeDataChannel(e,t){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Z.all(e.map(i=>this.signal.request(le.UNSUBSCRIBE_DATASTREAM,{stream_id:i,uid:t},!0)))}catch(i){y.warning("unsubscribeDataChannel warning: ",i)}}async massUnsubscribe(e){try{await this.signal.request(le.UNSUBSCRIBE_STREAMS,e,!0)}catch(t){y.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),t)}}async reconnectPC(e){let{iceParameters:t,dtlsParameters:i,rtpCapabilities:r}=e;return{gatewayEstablishParams:await this.signal.request(le.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:t,dtlsParameters:i,rtpCapabilities:r}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(le.GATEWAY_INFO)}async renewToken(e){await this.signal.request(le.RENEW_TOKEN,e),this.key=e.token}updateClientRole(e,t){t&&(this._clientRoleOptions=Object.assign({},t)),F("CLIENT_ROLE_OPTIONS")&&(y.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(F("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," ")),this._clientRoleOptions=Object.assign({},F("CLIENT_ROLE_OPTIONS"))),this.role=e}async setClientRole(e,t){if(t&&(this._clientRoleOptions=Object.assign({},t)),F("CLIENT_ROLE_OPTIONS")&&(this._clientRoleOptions=Object.assign({},F("CLIENT_ROLE_OPTIONS")),y.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(F("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," "))),this.state!=="CONNECTED")return void(this.role=e);let i,r=0;e==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(i=this._clientRoleOptions.delay,r=1):r=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:r=0;let o=Object.assign({},t);delete o.delay,delete o.level,await this.signal.request(le.SET_CLIENT_ROLE,Sn(Sn({role:e,level:r,delay:i},o),{},{client_ts:Date.now()})),this.role=e}async setDualStreamMode(e,t,i){await this.signal.request(le.SET_DUAL_STREAM_MODE,{mode:e},i,t)}async setRemoteVideoStreamType(e,t){await this.signal.request(le.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:t})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(le.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,t){await this.signal.request(le.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:t})}async pickSVCLayer(e,t){await this.signal.request(le.PICK_SVC_LAYER,{stream_id:e,spatial_layer:t.spatialLayer,temporal_layer:t.temporalLayer})}async setRTM2Flag(e){await this.signal.request(le.SET_RTM2_FLAG,{rtm2_flag:e})}async sendExtensionMessage(e,t,i){if(this.store.useP2P)return this.signal.sendExtensionMessage(e,t,i)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),Sn({},this.inChannelInfo)}async setConfigure(e){if(e&&Array.isArray(e)&&e.length!==0)return this.signal.request(le.CONFIGURE,e)}async getGatewayVersion(){return(await this.signal.request(le.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){let e=an.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0),this.usingProxy=!1}updateTurnConfigFromSignal(){if(!this.joinInfo)return;let e=function(t){let i;return i=t.startsWith("dc")?t.match(/(dc\:\/\/)?([^:]+):(\d+)/):t.match(/(wss\:\/\/)?([^:]+):(\d+)/),i?{username:Yr.username,password:Yr.password,turnServerURL:i[2],tcpport:parseInt(i[3])+30,udpport:parseInt(i[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(Sn(Sn({},Yr),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;let e=await this.signal.request(le.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),e.ntp_offset!=null&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach(t=>{let i=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(r=>r.peer_uid===t.peer_uid);i&&i.B_st!==t.B_st&&Au(()=>{this.emit(_t.STREAM_TYPE_CHANGE,t.peer_uid,t.B_st)})}),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){var t,i,r,o;if(!this.joinInfo||!this.key)throw new H(L.UNEXPECTED_ERROR,"can not generate join message, no join info");let s=Object.assign({},this.joinInfo.apResponse),a=F("REPORT_APP_SCENARIO");if(typeof a!="string")try{a=JSON.stringify(a)}catch{a=void 0}var c;a&&a.length>128&&(a=void 0),this.store.hasStartJoinChannel=!0,this.store.isABTestSuccess||this.emit(_t.UPDATE_GATEWAY_CONFIG),c=this.store.clientId,z(Lc).call(Lc,c)||Lc.push(c);let d=kh(this.store),l=!((t=this.isPreallocation)===null||t===void 0||!t.call(this)),h=Wf(this.store),p=ra(),f=Dr(87)||pn()||Rl(117),m=(function(){let C=Zt();if(C.name!==pt.SAFARI||!C.browserVersion)return!1;let b=C.browserVersion.split(".");return Number(b[0])>18||Number(b[0])===18&&Number(b[1])>=4}()||wN(18,4,!1))&&mv(18,6,!0)&&this.spec.codec==="h264"&&F("ENABLE_ABSSENDTIME_AS_SENTTS"),g=!(((i=s.detail)===null||i===void 0?void 0:i[3])!=="CN"||!F("ENABLE_QUALITY_FALLBACK"))&&F("ENABLE_QUALITY_FALLBACK"),S=!!F("ENABLE_AP_MULTI_IP")&&((r=s.detail)===null||r===void 0?void 0:r[5])==="multi-ip",T=Sn({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:Js,browser:navigator.userAgent,process_id:F("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:S||this.hasChangeBGPAddress,ap_response:s,extend:F("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:a,attributes:{userAttributes:Sn(Sn({enableEncodedTransform:(!!F("ENABLE_AUDIO_METADATA")||!!F("ENABLE_AUDIO_PTS"))&&f||!!F("ENABLE_AUDIO_TOPN")&&_v(pt.CHROME,87,116)||void 0,enableAudioMetadata:!!F("ENABLE_AUDIO_METADATA")&&f,enableAudioPts:!!F("ENABLE_AUDIO_PTS")&&f,topnSmoothLevel:F("TOPN_SMOOTH_LEVEL"),topnNewSpeakerDelay:F("TOPN_NEW_SPEAKER_DELAY"),topnSwitchHoldMs:F("TOPN_SWITCH_HOLD_MS"),topnAudioGain:F("TOPN_AUDIO_GAIN"),enableNetworkQualityProbe:this.store.networkQualityProbe,enablePublishedUserList:F("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:F("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:Ds("SUBSCRIBE_AUDIO_FILTER_TOPN","number"),enablePublishAudioFilter:Ds("ENABLE_PUBLISH_AUDIO_FILTER","boolean"),enableUserLicenseCheck:Ds("ENABLE_USER_LICENSE_CHECK","boolean"),enableRTX:F("USE_PUB_RTX")===!0||F("USE_SUB_RTX")===!0||void 0,disableFEC:F("DISABLE_FEC"),enableNTPReport:!!F("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:h,enableFulllinkAvSync:!!F("ENABLE_FULL_LINK_AV_SYNC")||void 0,enableDataStream2:Ds("ENABLE_DATASTREAM_2","boolean"),enableAutFeedback:!!F("FORCE_ENABLE_AUT_CC")||!aT()&&(!!F("ENABLE_AUT_FEEDBACK")||void 0),rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!F("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:Ds("USE_XR","boolean"),enableLossbasedBwe:Ds("ENABLE_LOSSBASED_BWE","boolean"),enableAutCC:!!F("FORCE_ENABLE_AUT_CC")||!aT()&&(!!F("ENABLE_AUT_CC")||void 0),enableCCFallback:Ds("ENABLE_CC_FALLBACK","boolean"),enablePreallocPC:l,preSubNum:d?Ds("PRE_SUB_NUM","number"):void 0,enablePubTWCC:Ds("PUBLISH_TWCC","boolean"),enableSubTWCC:Ds("SUBSCRIBE_TWCC","boolean"),enablePubRTX:Ds("USE_PUB_RTX","boolean"),enableSubRTX:Ds("USE_SUB_RTX","boolean"),enableSubSVC:F("ENABLE_SVC")?F("ENABLE_SVC_DEFAULT_CODECS"):Array.isArray(F("SVC"))&&F("SVC").length!==0?F("SVC"):void 0,enableSvcExtended:F("ENABLE_SVC")&&Array.isArray(F("SVC_EXTENDED"))&&F("SVC_EXTENDED").length!==0?F("SVC_EXTENDED"):void 0,enableVosFallback:F("ENABLE_VOS_FALLBACK"),enableQualityFallback:g},p),{},{audioDuplicate:Ds("ENABLE_AUDIO_RED","boolean")?(o=Ds("AUDIO_DUPLICATE_NUM","number"))!==null&&o!==void 0?o:2:void 0,senttsUsesAbsSendTime:!!m||void 0,enableDualStreamFlag:Ds("ENABLE_DUAL_STREAM_FLAG","boolean")})},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(T.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(T.aes_mode=this.joinInfo.aesmode,F("ENCRYPT_AES")?(T.aes_secret=this.joinInfo.aespassword,T.aes_encrypt=!0):T.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(T.aes_salt=this.joinInfo.aessalt)),s.addresses[this.signal.websocket.currentURLIndex]&&(T.ap_response.ticket=s.addresses[this.signal.websocket.currentURLIndex].ticket,delete s.addresses),this.joinInfo.defaultVideoStream!==void 0&&(T.default_video_stream=this.joinInfo.defaultVideoStream),T}getRejoinMessage(){if(!this.joinInfo)throw new H(L.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(Ee.WS_RECONNECT_CREATE_CONNECTION,e=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(Ee.WS_RECONNECTING,e=>{this.joinInfo&&_e.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||Cn.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",_e.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(Ee.WS_CLOSED,e=>{let t;switch(e){case Gt.LEAVE:t=Cn.LEAVE;break;case Gt.UID_BANNED:case Gt.IP_BANNED:case Gt.CHANNEL_BANNED:case Gt.SERVER_ERROR:t=Cn.SERVER_ERROR;break;case Gt.FALLBACK:t=Cn.FALLBACK;break;case Gt.LICENSE_MISSING:case Gt.LICENSE_EXPIRED:case Gt.LICENSE_MINUTES_EXCEEDED:case Gt.LICENSE_PERIOD_INVALID:case Gt.LICENSE_MULTIPLE_SDK_SERVICE:case Gt.LICENSE_ILLEGAL:case Gt.TOKEN_EXPIRE:t=e;break;default:t=Cn.NETWORK_ERROR}y.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(t||"undefined -> "+Cn.NETWORK_ERROR)),this.joinInfo&&_e.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===Gt.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t}),this._disconnectedReason=e,e!==Gt.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(Ee.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo){if(this.role==="audience"){let e=F("CLIENT_ROLE_OPTIONS")||this._clientRoleOptions;e&&(e.level||e.delay)&&(y.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(e.level,", delay: ").concat(e.delay)),this.setClientRole(this.role,e))}if(_e.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:this.joinInfo.preload,isABTestSuccess:this.store.isABTestSuccess}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1){let e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void y.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));$e("EVENT_REPORT_DOMAIN",e[1]),$e("EVENT_REPORT_BACKUP_DOMAIN",e[1]),$e("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}}}),this.signal.on(it.ON_UPLINK_STATS,e=>{this._statsCollector.updateUplinkStats(e)}),this.signal.on(Ee.REQUEST_RECOVER,(e,t,i)=>{if(!this.joinInfo)return i(new H(L.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,fr(this,_t.REQUEST_NEW_GATEWAY_LIST).then(t).catch(i)}),this.signal.on(Ee.REQUEST_JOIN_INFO,async(e,t,i)=>{var r,o,s;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));let a=Li((r=this.joinInfo)===null||r===void 0?void 0:r.turnServer);if(F("NEW_TURN_MODE")&&a&&((o=this.joinInfo)===null||o===void 0?void 0:o.cloudProxyServer)==="disabled"){var c;let p=a.servers.map(g=>"turnServerURL"in g&&F("USE_TURN_IP")?Sn(Sn({},g),{},{turnServerURL:ia(g.turnServerURL)}):g),f=(c=a.serversFromGateway)===null||c===void 0?void 0:c.map(g=>F("USE_TURN_IP")?Sn(Sn({},g),{},{turnServerURL:ia(g.turnServerURL)}):g),m=this.signal.currentURLIndex;p.length>0&&(p=[p[m%p.length]],a.servers=p),Array.isArray(f)&&f.length>0&&(f=[f[0]],a.serversFromGateway=f),y.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(m))}let{iceParameters:d,dtlsParameters:l,rtpCapabilities:h}=await fr(this,_t.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:a,cloudProxyServer:(s=this.joinInfo)===null||s===void 0?void 0:s.cloudProxyServer});try{e(this.getJoinMessage({ortc:{iceParameters:d,dtlsParameters:l,rtpCapabilities:h,version:"2"}}))}catch(p){t(p)}}),this.signal.on(Ee.REQUEST_REJOIN_INFO,e=>{e(this.getRejoinMessage())}),this.signal.on(Ee.REPORT_JOIN_GATEWAY,(e,t)=>{if(!this.joinInfo)return;let i,r="";var o;e instanceof H?(i=((o=e.data)===null||o===void 0?void 0:o.desc)||e.code,r=e.message):i=e,_e.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:i,errorMsg:r,addr:t,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:this.joinInfo.preload})}),this.signal.on(Ee.IS_P2P_DISCONNECTED,e=>{e(co(this,_t.IS_P2P_DISCONNECTED))}),this.signal.on(Ee.DISCONNECT_P2P,()=>{this.emit(_t.DISCONNECT_P2P)}),this.signal.on(Ee.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(Ee.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(Ee.JOIN_RESPONSE,e=>{let t=this.getCurrentGatewayAddress();this.emit(_t.JOIN_RESPONSE,e,t)}),this.signal.on(Ee.PRE_CONNECT_PC,async(e,t)=>{if(this.joinInfo){var i,r;this.updateTurnConfigFromSignal();let s=this.getCurrentGatewayAddress(),a=Li((i=this.joinInfo)===null||i===void 0?void 0:i.turnServer);if(F("NEW_TURN_MODE")&&a&&((r=this.joinInfo)===null||r===void 0?void 0:r.cloudProxyServer)==="disabled"){var o;let d=a.servers.map(p=>"turnServerURL"in p&&F("USE_TURN_IP")?Sn(Sn({},p),{},{turnServerURL:ia(p.turnServerURL)}):p),l=(o=a.serversFromGateway)===null||o===void 0?void 0:o.map(p=>F("USE_TURN_IP")?Sn(Sn({},p),{},{turnServerURL:ia(p.turnServerURL)}):p),h=this.signal.currentURLIndex;d.length>0&&(d=[d[h%d.length]],a.servers=d),Array.isArray(l)&&l.length>0&&(l=[l[0]],a.serversFromGateway=l),y.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(h,",in pre pc"))}let c=F("FINGERPRINT")||this.joinInfo.apResponse.addresses[this.signal.currentURLIndex].fingerprint;if(s&&c){let d=JP(s);fr(this,_t.PRE_CONNECT_PC,{candidates:d,fingerprint:c,turnServer:a}).then(l=>{e==null||e(l)}).catch(t||(()=>{}))}}}),this.signal.on(Ee.RECOVER_NOTIFICATION,e=>{this.joinInfo&&typeof F("AP_REQUEST_DETAIL")=="string"&&(this.joinInfo.apRequestDetail="".concat(F("AP_REQUEST_DETAIL"),";").concat(e))}),this.signal.on(Ee.VOS_FALLBACK,e=>{this.emit(_t.VOS_FALLBACK,e)}),this.signal.on(Ee.DATACHANNEL_FAILBACK,e=>{y.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(_t.DATACHANNEL_FAILBACK)})}async tryUnsubBeforeResub(e,t){try{await this.signal.request(le.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[t]},!0)}catch(i){throw y.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),i),i}}async tryUnsubDataChannelBeforeResub(e,t){try{await this.signal.request(le.UNSUBSCRIBE,{stream_id:t.id},!0)}catch(i){throw y.warning("unsubscribe datachannel warning",i),i}}async tryUnpubBeforeRepub(e,t){try{await this.signal.request(le.UNPUBLISH,{stream_id:e,ortc:t},!0)}catch(i){throw y.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),i),i}}async tryUnpubDataChannelBeforeRepub(e,t){try{await this.signal.request(le.UNPUBLISH_DATASTREAM,{channnel_id:t.channelId},!0)}catch(i){throw y.warning("unpublish datastream warning: ",i),i}}async tryMassUnsubBeforeResub(e){let t={users:e.map(i=>({stream_id:i.stream_id,stream_type:i.stream_type}))};try{await this.signal.request(le.UNSUBSCRIBE_STREAMS,t,!0)}catch(i){throw y.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),i),i}}async muteLocal(e,t){let i={action:e.find(r=>r.stream_type===_i.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:t};try{await this.signal.request(le.CONTROL,i,!0,!0)}catch(r){throw y.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),r),r}}async unmuteLocal(e,t){let i={action:e.find(r=>r.stream_type===_i.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:t};try{await this.signal.request(le.CONTROL,i,!0,!0)}catch(r){throw y.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),r),r}}async muteRemote(e,t){let i={action:e===ke.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:t};try{await this.signal.request(le.CONTROL,i,!0,!0)}catch(r){throw y.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),r),r}}async unmuteRemote(e,t){let i={action:e===ke.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:t};try{await this.signal.request(le.CONTROL,i,!0,!0)}catch(r){throw y.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),r),r}}uploadWRTCStats(e){this.signal.uploadWRTCStats(e)}upload(e,t){this.signal.upload(e,t)}getSignalRTT(){return this.signal.rtt}async restartICE(e){let t={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(le.RESTART_ICE,t,!0)}catch(i){throw y.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),i),i}}reconnect(e,t){this.state==="CONNECTED"&&this.signal.reconnect(e||void 0,t||Cn.P2P_FAILED)}getCurrentGatewayAddress(){var e,t;if(!F("GATEWAY_WSS_ADDRESS"))return F("USE_CANDIDATE_FROM_AP_DETAIL")&&(e=this.joinInfo)!==null&&e!==void 0&&e.apGatewayAddress?(y.debug("[".concat(this.store.clientId,"] use candidate from ap detail, ").concat(JSON.stringify(this.joinInfo.apGatewayAddress))),this.joinInfo.apGatewayAddress):(t=this.joinInfo)!==null&&t!==void 0&&t.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(le.SET_PARAMETER,{enablePublishAudioFilter:e})}downgradeCodec(e){this.signal.downgradeCodec(e)}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(Gt.FALLBACK)),this.store.useDcSignal=!1,this.signal=new em(Sn(Sn({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(_t.RESET_SIGNAL)}}let pC=0,dm=0;function cc(n,e,t,i){return new Z((r,o)=>{e.timeout=e.timeout||F("HTTP_CONNECT_TIMEOUT"),e.responseType=e.responseType||"json",e.data&&!t?(e.data=JSON.stringify(e.data),pC+=xd(e.data)):t&&(e.data.size?pC+=e.data.size:e.data instanceof FormData?pC+=Vd(e.data):pC+=xd(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=n,Qi.request(e).then(s=>{typeof s.data=="string"?dm+=xd(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?dm+=s.data.byteLength:dm+=xd(JSON.stringify(s.data)),i&&r({data:s.data,headers:s.headers}),r(s.data)}).catch(s=>{Qi.isCancel(s)?o(new H(L.OPERATION_ABORTED,"cancel token canceled")):s.code==="ECONNABORTED"?o(new H(L.NETWORK_TIMEOUT,s.message)):s.response?o(new H(L.NETWORK_RESPONSE_ERROR,s.response.status)):o(new H(L.NETWORK_ERROR,s.message))})})}(function(){var n;function e(ae){var Y=0;return function(){return Y<ae.length?{done:!1,value:ae[Y++]}:{done:!0}}}var t=typeof Object.defineProperties=="function"?Object.defineProperty:function(ae,Y,ie){return ae==Array.prototype||ae==Object.prototype||(ae[Y]=ie.value),ae},i,r=function(ae){ae=[typeof globalThis=="object"&&globalThis,ae,typeof window=="object"&&window,typeof self=="object"&&self,typeof R=="object"&&R];for(var Y=0;Y<ae.length;++Y){var ie=ae[Y];if(ie&&ie.Math==Math)return ie}throw Error("Cannot find global object")}(this);function o(ae,Y){if(Y)e:{var ie=r;ae=ae.split(".");for(var Q=0;Q<ae.length-1;Q++){var w=ae[Q];if(!(w in ie))break e;ie=ie[w]}(Y=Y(Q=ie[ae=ae[ae.length-1]]))!=Q&&Y!=null&&t(ie,ae,{configurable:!0,writable:!0,value:Y})}}function s(ae){return(ae={next:ae})[Symbol.iterator]=function(){return this},ae}function a(ae){var Y=typeof Symbol<"u"&&Symbol.iterator&&ae[Symbol.iterator];return Y?Y.call(ae):{next:e(ae)}}if(o("Symbol",function(ae){function Y(w,v){this.A=w,t(this,"description",{configurable:!0,writable:!0,value:v})}if(ae)return ae;Y.prototype.toString=function(){return this.A};var ie="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",Q=0;return function w(v){if(this instanceof w)throw new TypeError("Symbol is not a constructor");return new Y(ie+(v||"")+"_"+Q++,v)}}),o("Symbol.iterator",function(ae){if(ae)return ae;ae=Symbol("Symbol.iterator");for(var Y="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),ie=0;ie<Y.length;ie++){var Q=r[Y[ie]];typeof Q=="function"&&typeof Q.prototype[ae]!="function"&&t(Q.prototype,ae,{configurable:!0,writable:!0,value:function(){return s(e(this))}})}return ae}),typeof Object.setPrototypeOf=="function")i=Object.setPrototypeOf;else{var c;e:{var d={};try{d.__proto__={a:!0},c=d.a;break e}catch{}c=!1}i=c?function(ae,Y){if(ae.__proto__=Y,ae.__proto__!==Y)throw new TypeError(ae+" is not extensible");return ae}:null}var l=i;function h(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function p(ae){if(ae.m)throw new TypeError("Generator is already running");ae.m=!0}function f(ae,Y){return ae.h=3,{value:Y}}function m(ae){this.g=new h,this.G=ae}function g(ae,Y,ie,Q){try{var w=Y.call(ae.g.j,ie);if(!(w instanceof Object))throw new TypeError("Iterator result "+w+" is not an object");if(!w.done)return ae.g.m=!1,w;var v=w.value}catch(N){return ae.g.j=null,ae.g.s(N),S(ae)}return ae.g.j=null,Q.call(ae.g,v),S(ae)}function S(ae){for(;ae.g.h;)try{var Y=ae.G(ae.g);if(Y)return ae.g.m=!1,{value:Y.value,done:!1}}catch(ie){ae.g.v=void 0,ae.g.s(ie)}if(ae.g.m=!1,ae.g.l){if(Y=ae.g.l,ae.g.l=null,Y.F)throw Y.D;return{value:Y.return,done:!0}}return{value:void 0,done:!0}}function T(ae){this.next=function(Y){return ae.o(Y)},this.throw=function(Y){return ae.s(Y)},this.return=function(Y){return function(ie,Q){p(ie.g);var w=ie.g.j;return w?g(ie,"return"in w?w.return:function(v){return{value:v,done:!0}},Q,ie.g.return):(ie.g.return(Q),S(ie))}(ae,Y)},this[Symbol.iterator]=function(){return this}}function C(ae,Y){return Y=new T(new m(Y)),l&&ae.prototype&&l(Y,ae.prototype),Y}if(h.prototype.o=function(ae){this.v=ae},h.prototype.s=function(ae){this.l={D:ae,F:!0},this.h=this.C||this.u},h.prototype.return=function(ae){this.l={return:ae},this.h=this.u},m.prototype.o=function(ae){return p(this.g),this.g.j?g(this,this.g.j.next,ae,this.g.o):(this.g.o(ae),S(this))},m.prototype.s=function(ae){return p(this.g),this.g.j?g(this,this.g.j.throw,ae,this.g.o):(this.g.s(ae),S(this))},o("Array.prototype.entries",function(ae){return ae||function(){return function(Y,ie){Y instanceof String&&(Y+="");var Q=0,w=!1,v={next:function(){if(!w&&Q<Y.length){var N=Q++;return{value:ie(N,Y[N]),done:!1}}return w=!0,{done:!0,value:void 0}}};return v[Symbol.iterator]=function(){return v},v}(this,function(Y,ie){return[Y,ie]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var b=function(ae,Y){for(var ie=0;ie<ae.length;ie++)Y(ae[ie])},D=function(ae){return ae.replace(/\r?\n|\r/g,`\r
`)},x=function(ae,Y,ie){return Y instanceof Blob?(ie=ie!==void 0?ie+"":typeof Y.name=="string"?Y.name:"blob",Y.name===ie&&Object.prototype.toString.call(Y)!=="[object Blob]"||(Y=new File([Y],ie)),[String(ae),Y]):[String(ae),String(Y)]},k=function(ae,Y){if(ae.length<Y)throw new TypeError(Y+" argument required, but only "+ae.length+" present.")},V=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,W=V.FormData,K=V.XMLHttpRequest&&V.XMLHttpRequest.prototype.send,J=V.Request&&V.fetch,se=V.navigator&&V.navigator.sendBeacon,Ne=V.Element&&V.Element.prototype,Ce=V.Symbol&&Symbol.toStringTag;Ce&&(Blob.prototype[Ce]||(Blob.prototype[Ce]="Blob"),"File"in V&&!File.prototype[Ce]&&(File.prototype[Ce]="File"));try{new File([],"")}catch{V.File=function(ae,Y,ie){return ae=new Blob(ae,ie||{}),Object.defineProperties(ae,{name:{value:Y},lastModified:{value:+(ie&&ie.lastModified!==void 0?new Date(ie.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),Ce&&Object.defineProperty(ae,Ce,{value:"File"}),ae}}var De=function(ae){return ae.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},Me=function(ae){this.i=[];var Y=this;ae&&b(ae.elements,function(ie){if(ie.name&&!ie.disabled&&ie.type!=="submit"&&ie.type!=="button"&&!ie.matches("form fieldset[disabled] *"))if(ie.type==="file"){var Q=ie.files&&ie.files.length?ie.files:[new File([],"",{type:"application/octet-stream"})];b(Q,function(w){Y.append(ie.name,w)})}else ie.type==="select-multiple"||ie.type==="select-one"?b(ie.options,function(w){!w.disabled&&w.selected&&Y.append(ie.name,w.value)}):ie.type==="checkbox"||ie.type==="radio"?ie.checked&&Y.append(ie.name,ie.value):(Q=ie.type==="textarea"?D(ie.value):ie.value,Y.append(ie.name,Q))})};if((n=Me.prototype).append=function(ae,Y,ie){k(arguments,2),this.i.push(x(ae,Y,ie))},n.delete=function(ae){k(arguments,1);var Y=[];ae=String(ae),b(this.i,function(ie){ie[0]!==ae&&Y.push(ie)}),this.i=Y},n.entries=function ae(){var Y,ie=this;return C(ae,function(Q){if(Q.h==1&&(Y=0),Q.h!=3)return Y<ie.i.length?Q=f(Q,ie.i[Y]):(Q.h=0,Q=void 0),Q;Y++,Q.h=2})},n.forEach=function(ae,Y){k(arguments,1);for(var ie=a(this),Q=ie.next();!Q.done;Q=ie.next()){var w=a(Q.value);Q=w.next().value,w=w.next().value,ae.call(Y,w,Q,this)}},n.get=function(ae){k(arguments,1);var Y=this.i;ae=String(ae);for(var ie=0;ie<Y.length;ie++)if(Y[ie][0]===ae)return Y[ie][1];return null},n.getAll=function(ae){k(arguments,1);var Y=[];return ae=String(ae),b(this.i,function(ie){ie[0]===ae&&Y.push(ie[1])}),Y},n.has=function(ae){k(arguments,1),ae=String(ae);for(var Y=0;Y<this.i.length;Y++)if(this.i[Y][0]===ae)return!0;return!1},n.keys=function ae(){var Y,ie,Q,w,v=this;return C(ae,function(N){if(N.h==1&&(Y=a(v),ie=Y.next()),N.h!=3)return ie.done?void(N.h=0):(Q=ie.value,w=a(Q),f(N,w.next().value));ie=Y.next(),N.h=2})},n.set=function(ae,Y,ie){k(arguments,2),ae=String(ae);var Q=[],w=x(ae,Y,ie),v=!0;b(this.i,function(N){N[0]===ae?v&&(v=!Q.push(w)):Q.push(N)}),v&&Q.push(w),this.i=Q},n.values=function ae(){var Y,ie,Q,w,v=this;return C(ae,function(N){if(N.h==1&&(Y=a(v),ie=Y.next()),N.h!=3)return ie.done?void(N.h=0):(Q=ie.value,(w=a(Q)).next(),f(N,w.next().value));ie=Y.next(),N.h=2})},Me.prototype._asNative=function(){for(var ae=new W,Y=a(this),ie=Y.next();!ie.done;ie=Y.next()){var Q=a(ie.value);ie=Q.next().value,Q=Q.next().value,ae.append(ie,Q)}return ae},Me.prototype._blob=function(){var ae="----formdata-polyfill-"+Math.random(),Y=[],ie="--"+ae+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(Q,w){return typeof Q=="string"?Y.push(ie+De(D(w))+`"\r
\r
`+D(Q)+`\r
`):Y.push(ie+De(D(w))+'"; filename="'+De(Q.name)+`"\r
Content-Type: `+(Q.type||"application/octet-stream")+`\r
\r
`,Q,`\r
`)}),Y.push("--"+ae+"--"),new Blob(Y,{type:"multipart/form-data; boundary="+ae})},Me.prototype[Symbol.iterator]=function(){return this.entries()},Me.prototype.toString=function(){return"[object FormData]"},Ne&&!Ne.matches&&(Ne.matches=Ne.matchesSelector||Ne.mozMatchesSelector||Ne.msMatchesSelector||Ne.oMatchesSelector||Ne.webkitMatchesSelector||function(ae){for(var Y=(ae=(this.document||this.ownerDocument).querySelectorAll(ae)).length;0<=--Y&&ae.item(Y)!==this;);return-1<Y}),Ce&&(Me.prototype[Ce]="FormData"),K){var et=V.XMLHttpRequest.prototype.setRequestHeader;V.XMLHttpRequest.prototype.setRequestHeader=function(ae,Y){et.call(this,ae,Y),ae.toLowerCase()==="content-type"&&(this.B=!0)},V.XMLHttpRequest.prototype.send=function(ae){ae instanceof Me?(ae=ae._blob(),this.B||this.setRequestHeader("Content-Type",ae.type),K.call(this,ae)):K.call(this,ae)}}J&&(V.fetch=function(ae,Y){return Y&&Y.body&&Y.body instanceof Me&&(Y.body=Y.body._blob()),J.call(this,ae,Y)}),se&&(V.navigator.sendBeacon=function(ae,Y){return Y instanceof Me&&(Y=Y._asNative()),se.call(this,ae,Y)}),V.FormData=Me}})();let na=()=>{let n=F("AREAS");return n.length===0&&n.push(gt.GLOBAL),un(n).call(n,(e,t,i)=>{let r=lm(t);return r?i===0?r:"".concat(e,",").concat(r):e},"")},lm=n=>n===gt.OVERSEA?"".concat(Zn.ASIA,",").concat(Zn.EUROPE,",").concat(Zn.AFRICA,",").concat(Zn.NORTH_AMERICA,",").concat(Zn.SOUTH_AMERICA,",").concat(Zn.OCEANIA):Zn[n],$U=n=>{let e={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return n.map(t=>{let i=wn[t],r=Object.keys(i);r&&r.map(o=>{o!=="CODE"&&(e[o]=e[o].concat(i[o]))})}),e},_C={GLOBAL:{ASIA:[gt.CHINA,gt.JAPAN,gt.INDIA,gt.KOREA,gt.HKMC],EUROPE:[],NORTH_AMERICA:[gt.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},x_=Object.keys(_C[gt.GLOBAL]),um=[gt.CHINA,gt.NORTH_AMERICA,gt.EUROPE,gt.ASIA,gt.JAPAN,gt.INDIA,gt.OCEANIA,gt.SOUTH_AMERICA,gt.AFRICA,gt.KOREA,gt.HKMC,gt.US],eL=function(n,e){let t=[];if(z(n).call(n,gt.GLOBAL)){let o=[gt.GLOBAL,gt.OVERSEA],s=Object.keys(wn);if(e===gt.GLOBAL)throw new H(L.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(e===gt.CHINA)t=[gt.OVERSEA];else if(r=e,z(x_).call(x_,r)){let a=(i=e,_C[gt.GLOBAL][i]||[]),c=[...o,e,...a];t=s.filter(d=>!z(c).call(c,d))}else if(function(a){let c=!1;return x_.forEach(d=>{var l;z(l=_C[gt.GLOBAL][d]).call(l,a)&&(c=!0)}),c}(e)){let a=function(d){let l;return x_.forEach(h=>{var p;z(p=_C[gt.GLOBAL][h]).call(p,d)&&(l=h)}),l}(e),c=[...o,a,e];t=s.filter(d=>!z(c).call(c,d))}else t=n;t=function(a){let c=[];return um.forEach(d=>{z(a).call(a,d)&&c.push(d)}),c.concat(a.filter(d=>!z(um).call(um,d)))}(t)}else t=n;var i,r;return t};function e2(n){var e,t;if(!n&&z(e=F("AREAS")).call(e,gt.EXTENSIONS))return y.debug("update area from ap : reset"),void fC(yT,!0);if(!z(t=F("AREAS")).call(t,gt.GLOBAL)||!n)return;let i=wn.EXTENSIONS;i&&(i={CODE:lm(gt.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(n,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(n,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(n,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(n,".agora.io"),"cds-ap-web-2-".concat(n,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(n,".agora.io"),"sua-ap-web-2-".concat(n,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(n,".agora.io"),"uap-ap-web-2-".concat(n,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(n,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(n,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(n,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(n,".agora.io")]},y.debug("update area from ap success: ".concat(n,",config is "),i),$e("AREAS",[gt.EXTENSIONS],!0),Object.keys(i).map(r=>{r==="LOG_UPLOAD_SERVER"||r==="EVENT_REPORT_DOMAIN"||r==="EVENT_REPORT_BACKUP_DOMAIN"||r==="PROXY_SERVER_TYPE3"?$e(r,i[r][0]):$e(r,i[r])}))}function fC(n){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],t=_e.reportApiInvoke(null,{name:Yi.SET_AREA,options:n,tag:ct.TRACER});try{let i=[];if(typeof n=="string"&&(i=[n]),Array.isArray(n)&&(n.forEach(o=>{if(!z(mi).call(mi,o))throw new H(L.INVALID_PARAMS,"invalid area code")}),i=n),Object.prototype.toString.call(n)==="[object Object]"){let{areaCode:o,excludedArea:s}=n;if(!o)throw new H(L.INVALID_PARAMS,"area code is needed");let a=o;typeof o=="string"&&(a=[o]),i=s?eL(a,s):a}if(!e){if(Zs.AREAS){let o=new H(L.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return t.onError(o),void y.warning("setArea is prohibited because of config-distribute")}if(z(i).call(i,gt.GLOBAL)&&F("AREAS")===gt.EXTENSIONS){let o=new H(L.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return t.onError(o),void y.warning("setArea is prohibited because of ap extensions")}}$e("AREAS",i,e);let r=$U(i);Object.keys(r).map(o=>{o==="LOG_UPLOAD_SERVER"||o==="EVENT_REPORT_DOMAIN"||o==="EVENT_REPORT_BACKUP_DOMAIN"||o==="PROXY_SERVER_TYPE3"?$e(o,r[o][0]):$e(o,r[o])}),y.debug("set area success:",i.join(","))}catch(i){throw t.onError(i),i}t.onSuccess()}function mC(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function zd(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?mC(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):mC(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}let Bc=1;function tL(n,e,t,i,r){Bc+=1;let o={sid:t.sid,command:"convergeAllocateEdge",uid:"666",appId:t.appId,ts:Math.floor(Date.now()/1e3),seq:Bc,requestId:Bc,version:Js,cname:t.cname},s={service_name:e,json_body:JSON.stringify(o)},a,c,d=n[0];return fa(async()=>{a=Date.now();let l=await cc(d,{data:s,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,l.code!==0){let f=new H(L.UNEXPECTED_RESPONSE,"live streaming ap error, code"+l.code,{retry:!0,responseTime:c});throw y.error(f.toString()),f}let h=JSON.parse(l.json_body);if(h.code!==200){let f=new H(L.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(h.code,", reason: ").concat(h.reason),{code:h.code,responseTime:c});throw y.error(f.toString()),f}if(!h.servers||h.servers.length===0){let f=new H(L.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:h.code,responseTime:c});throw y.error(f.toString()),f}let p=function(f,m){return{addressList:f.servers.map(g=>"wss://".concat(g.address.replace(/\./g,"-"),".").concat(F("WORKER_DOMAIN"),":").concat(g.wss,"?serviceName=").concat(encodeURIComponent(m))),workerToken:f.workerToken,vid:f.vid}}(h,e);return F("LIVE_STREAMING_ADDRESS")&&(p.addressList=F("LIVE_STREAMING_ADDRESS")instanceof Array?F("LIVE_STREAMING_ADDRESS"):[F("LIVE_STREAMING_ADDRESS")]),zd(zd({},p),{},{responseTime:c})},(l,h)=>(_e.apworkerEvent(t.sid,{success:!0,sc:200,serviceName:e,responseDetail:JSON.stringify(l.addressList),firstSuccess:h===0,responseTime:c,serverIp:n[h%n.length]}),!1),(l,h)=>(_e.apworkerEvent(t.sid,{success:!1,sc:l.data&&l.data.code||200,serviceName:e,responseTime:c,serverIp:n[h%n.length]}),!!(l.code!==L.OPERATION_ABORTED&&l.code!==L.UNEXPECTED_RESPONSE||l.data&&l.data.retry)&&(d=n[(h+1)%n.length],!0)),r)}let iL=1;function EC(n,e,t,i){let{url:r,areaCode:o}=n,{clientId:s,sid:a}=e,c=Date.now(),d,l=e.role,[h,p]=sL(e,o,[Wr.CHOOSE_SERVER]),f=Wi.networkState;return fa(async()=>{f&&Wi.networkState===Gi.OFFLINE&&Wi.onlineWaiter&&await Z.race([Wi.onlineWaiter,fn(i&&i.maxRetryTimeout||mr.maxRetryTimeout)]),f=Wi.networkState;let{data:m,headers:g}=await cc(r,{data:h,cancelToken:t,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);d=g.http3==="1"?1:-1,_e.reportResourceTiming(r,a),nL(m,r,e,c,[Wr.CHOOSE_SERVER],d);let S=Gh(m,Wr.CHOOSE_SERVER);return gC(S),im(S,r)},m=>(m&&_e.joinChooseServer(a,{role:l,lts:c,succ:!0,csAddr:r,opid:p,serverList:m.gatewayAddrs.map(g=>g.address),ec:null,cid:m.cid.toString(),uid:m.uid.toString(),csIp:m.csIp,unilbsServerIds:[Wr.CHOOSE_SERVER].toString(),isHttp3:d,corssRegionTagReq:e.apRequestDetail,corssRegionTagRes:m.res.detail&&m.res.detail[38],vid:m.vid}),!1),m=>m.code!==L.OPERATION_ABORTED&&(m.code===L.CAN_NOT_GET_GATEWAY_SERVER?m.data.retry:(_e.joinChooseServer(a,{role:l,lts:c,succ:!1,csAddr:r,serverList:null,opid:p,ec:m.code,csIp:m.data&&m.data.csIp,unilbsServerIds:[Wr.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:f}),isHttp3:d,corssRegionTagReq:e.apRequestDetail}),y.warning("[".concat(s||"sid-".concat(a.slice(0,6)),"] Choose server network error, retry"),m),!0)),i)}function rL(n,e,t,i){let r,{url:o,areaCode:s,serviceIds:a}=n,c=Date.now(),d=e.role,[l,h]=sL(e,s,a),p;return fa(async()=>{p&&Wi.networkState===Gi.OFFLINE&&Wi.onlineWaiter&&await Z.race([Wi.onlineWaiter,fn(i&&i.maxRetryTimeout||mr.maxRetryTimeout)]),p=Wi.networkState;let{data:f,headers:m}=await cc(o,{data:l,cancelToken:t,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r=m.http3==="1"?1:-1,_e.reportResourceTiming(o,e.sid),nL(f,o,e,c,a,r);let g=Gh(f,Wr.CHOOSE_SERVER),S=Gh(f,e.cloudProxyServer==="proxy5"?Wr.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?Wr.CLOUD_PROXY:Wr.CLOUD_PROXY_FALLBACK),T=performance.getEntriesByName(o),C=T[T.length-1],b;return C&&(b={name:C.name,protocol:"nextHopProtocol"in C?C.nextHopProtocol:"",dnscost:"domainLookupEnd"in C&&"domainLookupStart"in C&&typeof C.domainLookupEnd=="number"&&typeof C.domainLookupStart=="number"?C.domainLookupEnd-C.domainLookupStart:-1,tcpTlsCost:"connectEnd"in C&&"connectStart"in C&&typeof C.connectEnd=="number"&&typeof C.connectStart=="number"?C.connectEnd-C.connectStart:-1,reqCost:"requestStart"in C&&typeof C.requestStart=="number"&&"responseEnd"in C&&typeof C.responseEnd=="number"?C.responseEnd-C.requestStart:-1,handleCost:"leave_ts"in f&&"enter_ts"in f&&typeof f.leave_ts=="number"&&typeof f.enter_ts=="number"?f.leave_ts-f.enter_ts:-1}),gC(g),{gatewayInfo:im(g,o),proxyInfo:S,url:o,resourceTimingInfo:b}},f=>{var m;return f.gatewayInfo&&_e.joinChooseServer(e.sid,{role:d,lts:c,succ:!0,csAddr:o,serverList:f.gatewayInfo.gatewayAddrs.map(g=>g.address),ec:null,opid:h,cid:f.gatewayInfo.cid.toString(),uid:f.gatewayInfo.uid.toString(),csIp:f.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:r,corssRegionTagReq:e.apRequestDetail,corssRegionTagRes:f.gatewayInfo.res.detail&&f.gatewayInfo.res.detail[38],vid:(m=f.gatewayInfo)===null||m===void 0?void 0:m.vid,resourceTimingInfo:f.resourceTimingInfo?JSON.stringify(f.resourceTimingInfo):void 0}),f.proxyInfo&&_e.joinWebProxyAP(e.sid,{lts:c,sucess:1,apServerAddr:o,turnServerAddrList:f.proxyInfo.addresses.map(g=>g.ip).join(","),errorCode:null,eventType:e.cloudProxyServer,unilbsServerIds:a.toString()}),!1},f=>f.code!==L.OPERATION_ABORTED&&(f.code===L.CAN_NOT_GET_GATEWAY_SERVER?f.data.retry:(_e.joinWebProxyAP(e.sid,{lts:c,sucess:0,apServerAddr:o,turnServerAddrList:null,errorCode:f.code,eventType:e.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:p})}),y.warning("[".concat(e.clientId,"] multi unilbs network error, retry"),f),!0)),i)}let nL=(n,e,t,i,r,o)=>{let{sid:s,clientId:a,cloudProxyServer:c}=t,d=[],l=h=>{h.flag===4096?_e.joinChooseServer(s,{role:t.role,lts:i,succ:!1,csAddr:e,opid:n.opid,serverList:null,ec:h.error.message,csIp:h.error.data&&h.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:o,corssRegionTagReq:t.apRequestDetail}):h.flag!==1048576&&h.flag!==4194304&&h.flag!==4194310||_e.joinWebProxyAP(s,{lts:i,sucess:0,apServerAddr:e,turnServerAddrList:null,errorCode:h.error.code,eventType:c,unilbsServerIds:r.toString()})};if(n.response_body.forEach(h=>{let p=h.buffer.code;if(h.uri===23&&p===0&&!h.buffer.edges_services)if(h.buffer.flag===4194310)y.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),h.buffer.edges_services=[];else{let f={error:new H(L.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:F("NO_EDGES_RETRY"),csIp:n.detail[502]}),flag:h.buffer.flag};d.push(f),l(f)}if(p!==0){let f=Zf(p),m={error:new H(L.CAN_NOT_GET_GATEWAY_SERVER,f.desc,{desc:f.desc,retry:f.retry,csIp:n.detail[502]}),flag:h.buffer.flag};h.buffer.flag===4194310?y.warning(m.error.toString()):d.push(m),l(m)}}),d.length)throw y.warning("[".concat(a||"sid-".concat(s.slice(0,6)),"] multi unilbs ").concat(e," failed, ").concat(d.map(h=>"flag: ".concat(h.flag,", message: ").concat(h.error.message,", retry: ").concat(h.error.data.retry)).join(" | "))),new H(L.CAN_NOT_GET_GATEWAY_SERVER,d.map(h=>"flag: ".concat(h.flag,", message: ").concat(h.error.message)).join(" | "),{retry:!!d.find(h=>h.error.data.retry),csIp:n.detail[502],desc:[...new Set(d.map(h=>{var p;return h==null||(p=h.error)===null||p===void 0||(p=p.data)===null||p===void 0?void 0:p.desc}).filter(h=>!!h))]})},gC=n=>{var e,t,i,r;if(n.addresses&&n.addresses.length===0&&n.code===0)throw new H(L.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:n.detail&&n.detail[502]});if(F("AP_AREA")&&((i=n.detail)!==null&&i!==void 0&&i[23]&&typeof((r=n.detail)===null||r===void 0?void 0:r[23])=="string"?e2(n.detail[23].toLowerCase()):e2()),(e=n.detail)!==null&&e!==void 0&&e[19]&&typeof((t=n.detail)===null||t===void 0?void 0:t[19])=="string"){let s=n.detail[19],a=s==null?void 0:s.split(";");for(let c=0;c<a.length;c++){var o;let d=rr(o=a[c]).call(o);n.addresses[c]&&a&&(n.addresses[c].fingerprint=d)}}if(F("GATEWAY_ADDRESS")&&F("GATEWAY_ADDRESS").length>0){y.debug("assign gateway address to",F("GATEWAY_ADDRESS"));let s=F("GATEWAY_ADDRESS").map(a=>{var c,d;let l=(c=(d=n.addresses.find(h=>h.ip===a.ip&&h.port===a.port))===null||d===void 0?void 0:d.fingerprint)!==null&&c!==void 0?c:"";return{ip:a.ip,port:a.port,ticket:n.addresses[0]&&n.addresses[0].ticket,fingerprint:a.fingerprint||l}});n.addresses=s}},oL=(n,e)=>{if(n.response_body&&n.response_body.length){let t=n.response_body[0];if(t.buffer.code!==0){let i=Zf(t.buffer.code);throw new H(L.UPDATE_TICKET_FAILED,"[".concat(t.buffer.code,"]: ").concat(i.desc),{retry:i.retry})}return t.buffer.ticket}throw y.debug("update ticket request received ap response without response body:",e),new H(L.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},sL=(n,e,t)=>{let i=Math.floor(Math.random()*1e12),r=n.role==="host"?"1":n.role==="audience"?"2":void 0,o={appid:n.appId,client_ts:Date.now(),opid:i,sid:n.sid,request_bodies:[{uri:22,buffer:{cname:n.cname,detail:zd(zd(zd({6:n.stringUid,11:e,12:F("USE_NEW_TOKEN")?"1":void 0},r?{17:r}:{}),{},{22:e},n.apRequestDetail?{33:n.apRequestDetail}:{}),n.apRTM?{26:"RTM2"}:{}),key:n.token,service_ids:t,uid:n.uid||0}}]};o.request_bodies.forEach(a=>{n.multiIP&&n.multiIP.gateway_ip&&(a.buffer.detail[5]=JSON.stringify({vocs_ip:[n.multiIP.uni_lbs_ip],vos_ip:[n.multiIP.gateway_ip]}))});let s=new FormData;return s.append("request",JSON.stringify(o)),[s,i]},aL=(n,e)=>{let t=Math.floor(Math.random()*1e12),i={appid:n.appId,client_ts:Date.now(),opid:t,sid:n.sid,request_bodies:[{uri:28,buffer:{cname:n.cname,detail:{1:"",6:n.stringUid,12:"1"},token:n.token,service_ids:e,uid:n.uid||0,edges_services:n.apResponse.addresses.map(o=>({ip:o.ip,port:o.port}))}}]},r=new FormData;return r.append("request",JSON.stringify(i)),[r,t]},hm=0;function qd(n){return Z.all(n.map(e=>e.then(t=>{throw t},t=>t))).then(e=>{throw e},e=>e)}let Dl=async n=>{let{fragementLength:e,referenceList:t,asyncMapHandler:i,allFailedhandler:r,promisesCollector:o}=n,s=0,a=e,c,d=0,l=async()=>{let h=(()=>{let p=s*a,f=p+a;return t.slice(p,f).map(i)})();o&&o.push(...h);try{c=await qd(h)}catch(p){if(d+=a,s++,!(d>=t.length))return void await l();r(p)}h.forEach(p=>p.cancel())};return await l(),c},pm=async n=>{let{referenceList:e,asyncMapHandler:t,closeFn:i}=n,r=e.length,o=0,s=async()=>{let a=t(e.shift());try{return await a}catch(c){if(o++,o>=r||i!=null&&i(c))throw c;return s()}};return s()};async function t2(){if(typeof VideoDecoder>"u")return!0;let n,e=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,85,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,149,160,133,4,144,43,122,168,159,120,159,205,39,82,131,57,52,87,187,68,23,248,134,204,226,97,17,49,183,55,236,219,249,221,98,208,215,190,59,179,167,213,47,1,246,150,14,194,245,159,83,35,64,103,218,38,21,82,3,135,21,185,84,248,134],t=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,148,62,134,140,92,172,141,77,35,94,181,164,65,169,65,156,154,43,221,162,11,252,67,102,113,48,136,137,219,62,43,113,239,23,126,250,186,252,10,138,218,25,193,244,74,68,194,209,107,23,52,206,199,78,72,98,103,151,71,96,62,51,210,158,72,231,158],i=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,143,233,163,51,196,98,95,151,224,22,134,33,240,150,248,67,18,34,196,142,81,238,173,140,80,205,232,132,144,67,12,131,157,4,171,243,86,122,35,6,166,184,243,85,126,13,206,103,152,62,168,160,187,2,241,138,52,211,72,121,128,151,63,147,128,19,42],r=[18,0,50,138,1,48,192,64,253,248,65,17,67,192,32,0,16,0,0,0,0,0,0,0,195,12,48,144,64,32,0,209,75,61,9,204,25,115,79,226,115,63,63,208,70,210,220,153,126,241,237,37,107,195,153,1,99,112,230,189,209,169,130,10,11,22,167,215,159,205,197,7,183,162,26,48,254,141,134,103,32,16,235,45,1,15,18,119,169,110,206,251,51,115,202,60,148,1,46,39,109,25,28,86,168,15,77,211,239,2,58,43,146,26,230,184,81,48,140,226,226,250,222,146,171,133,164,13,188,180,64,122,142,146,32,208,238,170,193,35,53,44,225],o=[18,0,50,107,48,0,133,125,248,65,26,195,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,204,24,122,65,56,165,18,52,206,218,4,187,51,97,9,29,191,90,253,106,185,31,197,155,52,205,245,185,203,131,20,226,25,124,95,113,220,113,141,15,15,104,211,144,152,237,150,157,127,51,143,24,231,218,171,255,176,241,128,229,149,150,148,66,245,228,91,27,182,228,136,61,182,237,133,45,220,24,103,214,152],s=[18,0,50,122,48,1,9,253,248,65,26,67,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,198,182,231,242,220,235,163,140,12,36,36,166,46,132,210,4,71,23,218,132,27,30,17,45,244,79,31,243,195,136,100,169,76,88,142,85,204,217,121,168,29,163,198,17,251,223,73,12,212,244,139,123,151,179,75,216,96,208,136,40,229,42,59,149,10,116,228,85,99,93,221,108,255,140,248,20,30,167,122,109,206,164,108,197,110,251,23,243,133,160,63,13,207,177,12,128];return await new Z((a,c)=>{let d;(async function(){n&&n.state!=="closed"||await async function(){n=new VideoDecoder({output:h=>{h.close(),clearTimeout(d),a(!0)},error:h=>{clearTimeout(d),a(!1)}}),await n.configure({codec:"av01.0.05M.08",width:160,height:90})}();let l=[e,t,i,r,o,s];for(let h=0;h<l.length;h++){let p=new EncodedVideoChunk({type:h==0?"key":"delta",timestamp:33333*h,duration:33333,data:new Uint8Array(l[h])});try{await n.decode(p)}catch{return void a(!1)}}})(),d=setTimeout(()=>{a(!1)},5e3)})}async function SC(n,e,t,i){return{gatewayInfo:await async function(r,o,s,a){let c=null,d=[],l=async()=>{let p=F("WEBCS_DOMAIN").slice(0,F("AJAX_REQUEST_CONCURRENT")).map(g=>({url:r.proxyServer?"https://".concat(r.proxyServer,"/ap/?url=").concat(g+"/api/v2/transpond/webrtc?v=2"):"https://".concat(g,"/api/v2/transpond/webrtc?v=2"),areaCode:na()})),f=a.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(g=>g.url)}),m=await Dl({fragementLength:F("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:g=>(y.debug("[".concat(r.clientId,"] Connect to choose_server:"),g.url),EC(g,r,o,s)),allFailedhandler:g=>{throw a.recordJoinChannelService({endTs:Date.now(),status:"error",errors:g},f),g[0]},promisesCollector:d});return a.recordJoinChannelService({endTs:Date.now(),status:"success"},f),m},h=async()=>{if(await fn(1e3),c!==null)return c;let p=F("WEBCS_DOMAIN_BACKUP_LIST").map(g=>({url:r.proxyServer?"https://".concat(r.proxyServer,"/ap/?url=").concat(g+"/api/v2/transpond/webrtc?v=2"):"https://".concat(g,"/api/v2/transpond/webrtc?v=2"),areaCode:na()})),f=a.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(g=>g.url)}),m=await Dl({fragementLength:F("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:g=>(y.debug("[".concat(r.clientId,"] Connect to backup choose_server:"),g.url),EC(g,r,o,s)),allFailedhandler:g=>{throw a.recordJoinChannelService({endTs:Date.now(),status:"error",errors:g},f),g[0]},promisesCollector:d});return a.recordJoinChannelService({endTs:Date.now(),status:"success"},f),m};try{return c=await qd([l(),h()]),d.length&&d.forEach(p=>p.cancel&&typeof p.cancel=="function"&&p.cancel()),c}catch(p){throw p[0]}}(n,e,t,i)}}async function FT(n,e,t,i,r){let o=n.cloudProxyServer;if(o==="disabled"){if(n.useLocalAccessPoint)return await SC(n,e,t,r);if(F("JOIN_WITH_FALLBACK_MEDIA_PROXY")){let{gatewayInfo:p,proxyInfo:f}=await dL(n,e,t,r);if(n.turnServer&&n.turnServer.mode!=="auto")return{gatewayInfo:p};let m=f.map(g=>({turnServerURL:g.address,tcpport:g.tcpport||Yr.tcpport,udpport:g.udpport||Yr.udpport,username:g.username||Yr.username,password:g.password||Yr.password,forceturn:!1,security:!0}));if(r.useP2P){var s;let g=(s=n.uid)!==null&&s!==void 0?s:p.uid,S="glb:".concat(g.toString()),T=await Rv(S),C=f.map(b=>({turnServerURL:b.address,tcpport:b.tcpport||Yr.tcpport,udpport:b.udpport||Yr.udpport,username:S,password:T,forceturn:!1,security:!0}));m.push(...C)}return n.turnServer={mode:"manual",servers:m},{gatewayInfo:p}}return await SC(n,e,t,r)}let{proxyInfo:a,gatewayInfo:c}=await dL(n,e,t,r),d={gatewayInfo:c},l=a.map(p=>({turnServerURL:p.address,tcpport:o==="proxy3"?void 0:p.tcpport?p.tcpport:Yr.tcpport,udpport:o==="proxy4"?void 0:p.udpport?p.udpport:Yr.udpport,username:p.username||Yr.username,password:p.password||Yr.password,forceturn:o!=="proxy4",security:o==="proxy5"}));if(r.useP2P){var h;let p=(h=n.uid)!==null&&h!==void 0?h:c.uid,f="glb:".concat(p.toString()),m=await Rv(f),g=a.map(S=>({turnServerURL:S.address,tcpport:o==="proxy3"?void 0:S.tcpport||Yr.tcpport,udpport:o==="proxy4"?void 0:S.udpport||Yr.udpport,username:f,password:m,forceturn:o!=="proxy4",security:o==="proxy5"}));l.push(...g)}return n.turnServer={mode:"manual",servers:l},y.debug("[".concat(n.clientId,"] set proxy server: ").concat(n.proxyServer,", mode: ").concat(o)),d}async function cL(n,e,t,i,r){let o=F("ACCOUNT_REGISTER").slice(0,F("AJAX_REQUEST_CONCURRENT")),s=[];s=e.proxyServer?o.map(c=>"https://".concat(e.proxyServer,"/ap/?url=").concat(c+"/api/v1")):o.map(c=>"https://".concat(c,"/api/v1"));let a=r==null?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:s});try{let c=await async function(d,l,h,p,f){let m=Date.now(),g={sid:h.sid,opid:10,appid:h.appId,string_uid:l},S=d[0],T=await fa(()=>cc(S+"".concat(S.indexOf("?")===-1?"?":"&","action=stringuid"),{data:g,cancelToken:p,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(C,b)=>{if(C.code===0){if(C.uid<=0||C.uid>=Math.pow(2,32))throw y.error("Invalid Uint Uid ".concat(l," => ").concat(C.uid),C),_e.reqUserAccount(g.sid,{lts:m,success:!1,serverAddr:S,stringUid:g.string_uid,uid:C.uid,errorCode:L.INVALID_UINT_UID_FROM_STRING_UID,extend:g}),new H(L.INVALID_UINT_UID_FROM_STRING_UID);return _e.reqUserAccount(g.sid,{lts:m,success:!0,serverAddr:S,stringUid:g.string_uid,uid:C.uid,errorCode:null,extend:g}),!1}let D=Zf(C.code);return D.retry&&(S=d[(b+1)%d.length]),_e.reqUserAccount(g.sid,{lts:m,success:!1,serverAddr:S,stringUid:g.string_uid,uid:C.uid,errorCode:D.desc,extend:g}),D.retry},(C,b)=>C.code!==L.OPERATION_ABORTED&&(_e.reqUserAccount(g.sid,{lts:m,success:!1,serverAddr:S,stringUid:g.string_uid,uid:null,errorCode:C.code,extend:g}),S=d[(b+1)%d.length],!0),f);if(T.code!==0){let C=Zf(T.code);throw new H(L.UNEXPECTED_RESPONSE,C.desc)}return T}(s,n,e,t,i);return r==null||r.recordJoinChannelService({status:"success",endTs:Date.now()},a),c.uid}catch(c){throw r==null||r.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[c]},a),c}}async function i2(n,e,t){let i=F("ACCOUNT_REGISTER"),r=[];r=e.proxyServer?i.map(o=>"https://".concat(e.proxyServer,"/ap/?url=").concat(o+"/api/v1")):i.map(o=>"https://".concat(o,"/api/v1"));try{return await pm({referenceList:r,asyncMapHandler:o=>async function(s,a,c,d){let l=Date.now(),h={sid:c.sid,opid:10,appid:c.appId,string_uid:a};try{let p=await cc(s+"".concat(s.indexOf("?")===-1?"?":"&","action=stringuid"),{data:h,cancelToken:d,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(p.code!==0){let f=Zf(p.code);throw new H(L.UNEXPECTED_RESPONSE,"preload sua error:".concat(f.desc),f)}if(p.uid<=0||p.uid>=Math.pow(2,32))throw new H(L.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:l,url:s,req:h,uid:p.uid,elapse:Date.now()-l}}catch(p){throw p}}(o,n,e,t),closeFn:o=>o.code===L.OPERATION_ABORTED||o.code===L.UNEXPECTED_RESPONSE&&!o.data.retry})}catch(o){throw o}}async function Sz(n,e,t){let i=F("CDS_AP").slice(0,F("AJAX_REQUEST_CONCURRENT")).map(c=>n.proxyServer?"https://".concat(n.proxyServer,"/ap/?url=").concat(c+"/api/v1"):"https://".concat(c,"/api/v1?action=config")),r=i.map(c=>function(d,l,h,p){let f=Zt(),m={flag:64,cipher_method:0,features:zd(zd(zd(zd(zd({install_id:Nv(),device:f.name,system:f.os,system_general:navigator.userAgent,vendor:l.appId,version:Js,cname:l.cname,session_id:l.sid,proxyServer:l.proxyServer,sdk_type:QU.WEB_RTC,browser_name:f.name,browser_version:f.version,user_agent:navigator.userAgent,channel_name:l.cname},l.stringUid&&{string_uid:l.stringUid}),l.uid&&{uid:l.uid+""}),f.os&&{os_name:f.os}),f.osVersion&&{os_version:f.osVersion}),{},{detail:""})};return fa(()=>cc(d,{data:m,timeout:1e3,cancelToken:h,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,g=>g.code!==L.OPERATION_ABORTED,p)}(c,n,e,t)),o=null,s=null,a={};try{o=await qd(r)}catch(c){if(c.code===L.OPERATION_ABORTED)throw c;s=c}if(r.forEach(c=>c.cancel()),_e.reportApiInvoke(n.sid,{name:Yi.REQUEST_CONFIG_DISTRIBUTE,options:{error:s,res:o}}).onSuccess(),o&&o.test_tags)try{a=function(c){if(!c.test_tags)return{};let d=c.test_tags,l=Object.keys(d),h={};return l.forEach(p=>{var f;let m=rr(f=p.slice(4)).call(f),g=JSON.parse(d[p]),S=g[1];h[m]={tag:g[0]||"",value:S}}),h}(o)}catch{}return a}async function r2(n,e){let t=F("WEBCS_DOMAIN").concat(F("WEBCS_DOMAIN_BACKUP_LIST")).map(i=>({url:"https://".concat(i,"/api/v2/transpond/webrtc?v=2"),areaCode:na(),serviceIds:[Wr.CHOOSE_SERVER,Wr.CLOUD_PROXY_FALLBACK]}));try{return await pm({referenceList:t,asyncMapHandler:i=>async function(r,o,s){let a,{url:c,areaCode:d,serviceIds:l}=r,h=Date.now(),[p,f]=sL(o,d,l),m=Wi.networkState;try{m&&Wi.networkState===Gi.OFFLINE&&Wi.onlineWaiter&&await Z.race([Wi.onlineWaiter,fn(mr.maxRetryTimeout)]),m=Wi.networkState;let{data:g,headers:S}=await cc(c,{data:p,cancelToken:s,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);a=S.http3==="1"?1:-1,(b=>{let D=[];if(b.response_body.forEach(x=>{let k=x.buffer.code;if(x.uri===23&&k===0&&!x.buffer.edges_services)if(x.buffer.flag===4194310)x.buffer.edges_services=[];else{let V={error:new H(L.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:F("NO_EDGES_RETRY"),csIp:b.detail[502]}),flag:x.buffer.flag};D.push(V)}if(k!==0){let V=Zf(k),W={error:new H(L.CAN_NOT_GET_GATEWAY_SERVER,V.desc,{desc:V.desc,retry:V.retry,csIp:b.detail[502]}),flag:x.buffer.flag};x.buffer.flag===4194310?y.warning(W.error.toString()):D.push(W)}}),D.length)throw new H(L.CAN_NOT_GET_GATEWAY_SERVER,D.map(x=>"flag: ".concat(x.flag,", message: ").concat(x.error.message)).join(" | "),{retry:!!D.find(x=>x.error.data.retry),csIp:b.detail[502],desc:[...new Set(D.map(x=>{var k;return x==null||(k=x.error)===null||k===void 0||(k=k.data)===null||k===void 0?void 0:k.desc}).filter(x=>!!x))]})})(g);let T=Gh(g,Wr.CHOOSE_SERVER),C=Gh(g,Wr.CLOUD_PROXY_FALLBACK);return gC(T),{gatewayInfo:im(T,c),proxyInfo:C,opid:f,requestTime:h,url:c,isHttp3:a,elapse:Date.now()-h}}catch(g){throw g}}(i,n,e),closeFn:i=>i.code===L.OPERATION_ABORTED||i.code===L.CAN_NOT_GET_GATEWAY_SERVER&&!i.data.retry})}catch(i){throw i}}async function dL(n,e,t,i){let r=F("PROXY_SERVER_TYPE3"),o=(f,m,g)=>{let S=g||r;return Array.isArray(S)&&(S=m%2==0&&r[1]||r[0]),"https://".concat(S,"/ap/?url=").concat(f)},s=null,a=[],c=async()=>{let f=F("WEBCS_DOMAIN").slice(0,F("AJAX_REQUEST_CONCURRENT")).map((S,T)=>{let C;return C=n.cloudProxyServer==="disabled"&&n.proxyServer?o("".concat(S,"/api/v2/transpond/webrtc?v=2"),T,n.proxyServer):n.cloudProxyServer==="disabled"||n.cloudProxyServer==="fallback"?"https://".concat(S,"/api/v2/transpond/webrtc?v=2"):o("".concat(S,"/api/v2/transpond/webrtc?v=2"),T),{url:C,areaCode:na(),serviceIds:[Wr.CHOOSE_SERVER,n.cloudProxyServer==="proxy5"?Wr.CLOUD_PROXY_5:n.cloudProxyServer==="proxy3"||n.cloudProxyServer==="proxy4"?Wr.CLOUD_PROXY:Wr.CLOUD_PROXY_FALLBACK]}}),m=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:f.map(S=>S.url)}),g=await Dl({fragementLength:F("FRAGEMENT_LENGTH"),referenceList:f,asyncMapHandler:S=>(y.debug("[".concat(n.clientId,"] Connect to choose_server:"),S.url),rL(S,n,e,t)),allFailedhandler:S=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:S},m),S[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},m),g},d=async()=>{if(await fn(1e3),s!==null)return s;let f=F("WEBCS_DOMAIN_BACKUP_LIST").map((S,T)=>{let C;return C=n.cloudProxyServer==="disabled"&&n.proxyServer?o("".concat(S,"/api/v2/transpond/webrtc?v=2"),T,n.proxyServer):n.cloudProxyServer==="disabled"||n.cloudProxyServer==="fallback"?"https://".concat(S,"/api/v2/transpond/webrtc?v=2"):o("".concat(S,"/api/v2/transpond/webrtc?v=2"),T),{url:C,areaCode:na(),serviceIds:[Wr.CHOOSE_SERVER,n.cloudProxyServer==="proxy5"?Wr.CLOUD_PROXY_5:n.cloudProxyServer==="proxy3"||n.cloudProxyServer==="proxy4"?Wr.CLOUD_PROXY:Wr.CLOUD_PROXY_FALLBACK]}}),m=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:f.map(S=>S.url)}),g=await Dl({fragementLength:F("FRAGEMENT_LENGTH"),referenceList:f,asyncMapHandler:S=>(y.debug("[".concat(n.clientId,"] Connect to backup choose_server:"),S.url),rL(S,n,e,t)),allFailedhandler:S=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:S},m),S[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},m),g},l,h,p;try{({gatewayInfo:l,proxyInfo:h,url:p}=await qd([c(),d()]))}catch(f){throw f[0]}if(a.length&&a.forEach(f=>f.cancel&&typeof f.cancel=="function"&&f.cancel()),!l||!h)throw new H(L.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(n.apUrl=p,n.cloudProxyServer!=="disabled"&&Array.isArray(r)&&p){let f=/^https?:\/\/(.+?)(\/.*)?$/.exec(p)[1];z(r).call(r,f)&&(n.proxyServer=f,y.setProxyServer(f),_e.setProxyServer(f))}return s={gatewayInfo:l,proxyInfo:await rm(h,l.uid)},s}async function n2(n,e,t){let i=F("UAP_AP").slice(0,F("AJAX_REQUEST_CONCURRENT")).map(o=>n.proxyServer?"https://".concat(n.proxyServer,"/ap/?url=").concat(o+"/api/v1?action=uap"):"https://".concat(o,"/api/v1?action=uap")),r=i.map(o=>function(s,a,c,d){let l={command:"convergeAllocateEdge",sid:a.sid,appId:a.appId,token:a.token,ts:Date.now(),version:Js,cname:a.cname,uid:a.uid.toString(),requestId:iL,seq:iL};iL+=1;let h={service_name:"tele_channel",json_body:JSON.stringify(l)};return fa(async()=>{let p=await cc(s,{data:h,cancelToken:c,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(p.code!==0){let m=new H(L.UNEXPECTED_RESPONSE,"cross channel ap error, code"+p.code,{retry:!0});throw y.error(m.toString()),m}let f=JSON.parse(p.json_body);if(f.code!==200){let m=new H(L.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(f.code,", reason: ").concat(f.reason));throw y.error(m.toString()),m}if(!f.servers||f.servers.length===0){let m=new H(L.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw y.error(m.toString()),m}return{vid:f.vid,workerToken:f.workerToken,addressList:(F("CHANNEL_MEDIA_RELAY_SERVERS")||f.servers).map(m=>"wss://".concat(m.address.replace(/\./g,"-"),".").concat(F("WORKER_DOMAIN"),":").concat(m.wss))}},void 0,p=>!!(p.code!==L.OPERATION_ABORTED&&p.code!==L.UNEXPECTED_RESPONSE||p.data&&p.data.retry),d)}(o,n,e,t));try{let o=await qd(r);return r.forEach(s=>s.cancel()),o}catch(o){throw o[0]}}async function Tz(n,e,t){let i=null,r=[],o=async s=>{let a=F(s?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(c=>n.proxyServer?"https://".concat(n.proxyServer,"/ap/?url=").concat(c+"/api/v2/transpond/webrtc?v=2"):"https://".concat(c,"/api/v2/transpond/webrtc?v=2"));return s&&(await fn(1e3),i!==null)?i:await Dl({fragementLength:F("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:c=>(y.debug("[".concat(n.clientId,"] update ticket, Connect to ").concat(s?"backup":""," choose_server:"),c),function(d,l,h,p){let[f]=aL(l,[Wr.CHOOSE_SERVER]),m=Wi.networkState;return fa(async()=>{m&&Wi.networkState===Gi.OFFLINE&&Wi.onlineWaiter&&await Z.race([Wi.onlineWaiter,fn(p&&p.maxRetryTimeout||mr.maxRetryTimeout)]),m=Wi.networkState;let g=await cc(d,{data:f,cancelToken:h,headers:{"Content-Type":"multipart/form-data;"}},!0);return oL(g,d)},()=>!1,g=>g.code!==L.OPERATION_ABORTED&&(g.code===L.UPDATE_TICKET_FAILED?g.data.retry:(y.warning("[".concat(l.clientId,"] update ticket network error, retry"),g),!0)),p)}(c,n,e,t)),allFailedhandler:c=>{throw c[0]},promisesCollector:r})};try{return i=await qd([o(!1),o(!0)]),r.length&&r.forEach(s=>s.cancel&&typeof s.cancel=="function"&&s.cancel()),i}catch(s){throw s[0]}}function o2(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function TC(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?o2(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):o2(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}class lL extends Ki{get isSuccess(){return!!this.configs}constructor(e,t){super(),U(this,"configs",void 0),U(this,"store",void 0),U(this,"joinInfo",void 0),U(this,"cancelToken",void 0),U(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),U(this,"interval",void 0),U(this,"mutex",void 0),U(this,"mutableParamsRead",!1),U(this,"configCache",{}),U(this,"limit_bitrate",void 0),this.mutex=new mn("config-distribute",e),this.store=t}startGetConfigDistribute(e,t){this.joinInfo=e,this.cancelToken=t,this.interval&&this.stopGetConfigDistribute(),F("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},F("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.configs=void 0,this.limit_bitrate=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,_e.reportApiInvoke(null,{options:void 0,name:Yi.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:ct.TRACER}).onSuccess(JSON.stringify(Zs))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void y.debug("[config-distribute] get config distribute interrupted have no joininfo");let e,t=await this.mutex.lock();try{e=await Sz(this.joinInfo,this.cancelToken,this.retryConfig),y.debug("[config-distribute] get config distribute",JSON.stringify(e));let i=function(r){var o;let s=Ka(o=Object.keys(r).filter(d=>/^webrtc_ng_global_parameter/.test(d))).call(o);for(let d=0;d<s.length;d++)for(let l=s.length-1;l>d;l--){let h=s[l],p=r[h].value;if(typeof p.__priority=="number"){let f=p.__priority,m=s[l-1],g=r[m].value;if(typeof g.__priority=="number"){if(!(f>g.__priority))continue;{let S=h;s[l]=s[l-1],s[l-1]=S}}else{let S=h;s[l]=s[l-1],s[l-1]=S}}}let a=Date.now(),c={};return s.forEach(d=>{let l=r[d].value.__expires;l&&l<=a||(c[d]=r[d])}),c}(e);this.cacheGlobalParameterConfig(i),this.store.hasStartJoinChannel||(this.store.isABTestSuccess=!0),this.configs=i}catch(i){let r=new H(L.NETWORK_RESPONSE_ERROR,i);y.warning("[config-distribute] ".concat(r.toString()))}finally{t()}}getBitrateLimit(){return this.limit_bitrate||void 0}handleBitrateLimit(e){Uc(e)&&(this.limit_bitrate?this.limit_bitrate&&this.limit_bitrate.id!==e.id&&this.emit(Aa.UPDATE_BITRATE_LIMIT,e):this.emit(Aa.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.limit_bitrate&&TC({},this.limit_bitrate.low_stream_uplink)}handleABTestConfigDistribute(e){try{let t={},i=Object.keys(e),r=[];i.forEach(o=>{let s=e[o].value;t[o]=s;let a=s.__id;if(a&&this.configCache[o]&&this.configCache[o].__id===a)return;let c=s.__type,d=e[o].value,l=e[o].tag,h=0;c?c===B.REALTIME&&(h=1):Object.keys(d).some(p=>Object.prototype.hasOwnProperty.call(sT,p)||!Uu()&&Object.prototype.hasOwnProperty.call(En,p)?(h=1,!0):void 0),r.push({tag:l,isApplied:h,feature:o,params:JSON.stringify(s)})}),r.forEach(o=>{let{tag:s,feature:a,params:c,isApplied:d}=o;this.store.sessionId&&_e.abTest(this.store.sessionId,{intSucc:1,isApplied:d,tag:s,feature:a,params:c,cid:this.store.cid,uid:this.store.intUid})}),this.configCache=t}catch(t){y.debug("handleABTestConfigDistribute error",t)}}cacheGlobalParameterConfig(e){let t=function(r){let o={};return Object.keys(r).forEach(s=>{let a=r[s].value,c=a.__expires,d=a.__type;Object.keys(a).forEach(l=>{l==="__id"||l==="__type"||l==="__priority"||l==="__expires"||Object.prototype.hasOwnProperty.call(o,l)||(o[l]=TC(TC({value:a[l]},c&&{expires:c}),d&&{type:d}))})}),o}(e);try{var i;let r=(i=t.LIMIT_BITRATE)===null||i===void 0?void 0:i.value;delete t.LIMIT_BITRATE,r&&Uc(r)&&this.handleBitrateLimit(r),this.limit_bitrate=r,this.handleGlobalParameterConfig(t),this.handleABTestConfigDistribute(e),function(a){try{let c=Date.now();Object.keys(a).forEach(d=>{let{value:l,type:h,expires:p}=a[d];p&&p<=c||((h===B.REALTIME||Object.prototype.hasOwnProperty.call(sT,d))&&(Zs[d]=l,Si[d]=l,y.debug("Update realtime parameters from config distribute",d,l)),h||Uu()||!Object.prototype.hasOwnProperty.call(En,d)||(Zs[d]=l,Si[d]=l,y.debug("Update gateway parameters from config distribute",d,l)))})}catch(c){y.error("Error update config immediately: ".concat(a),c.message)}}(t);let o=JSON.stringify(t),s=window.btoa(o);window.localStorage.setItem("websdk_ng_global_parameter",s),y.debug("Caching global parameters ".concat(o))}catch(r){y.error("Error caching global parameters:",r.message)}}handleGlobalParameterConfig(e){try{let t=Date.now();Object.keys(e).forEach(i=>{switch(i){case"CLIENT_ROLE_OPTIONS":if(Object.prototype.hasOwnProperty.call(Si,i)){let{value:o,expires:s}=e[i];if(s&&s<=t)return;Dh(Si[i],o)||(Zs[i]=o,Si[i]=o,this.emit(Aa.UPDATE_CLIENT_ROLE_OPTIONS,o),y.debug("Updating client role options: ".concat(JSON.stringify(o))))}break;case"REMOTE_VIDEO_STREAM_TYPE":if(Object.prototype.hasOwnProperty.call(Si,i)){var r;let{value:o,expires:s}=e[i];if(s&&s<=t)return;typeof o=="number"&&z(r=[0,1,4,5,6,7,8,9]).call(r,o)&&(Zs[i]={value:o},Si[i]=o,this.emit(Aa.UPDATE_REMOTE_VIDEO_STREAM_TYPE,o),y.debug("Updating client remote stream type: ".concat(JSON.stringify(o))))}break;case"ENABLE_FORCE_HLS":if(Object.prototype.hasOwnProperty.call(Si,i)){let{value:o,expires:s}=e[i];if(s&&s<=t)return;Dh(Si[i],o)||(Zs[i]=o,Si[i]=o,this.emit(Aa.FALLBACK_TO_HLS,o),y.debug("Updating enable force hls: ".concat(JSON.stringify(o))))}break;case"VOS_CONFIGURE":if(Object.prototype.hasOwnProperty.call(Si,i)){let{value:o,expires:s}=e[i];if(s&&s<=t)return;Dh(Si[i],o)||(Zs[i]=o,Si[i]=o,this.emit(Aa.UPDATE_VOS_CONFIGURE,o),y.debug("Updating vos configure: ".concat(JSON.stringify(o))))}}})}catch(t){y.error("Error handling global parameter config:",t.message)}}}class Rz extends Ki{constructor(){super(...arguments),U(this,"resultStorage",new Map)}setLocalAudioStats(e,t,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(i,t)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(i,t))}setLocalVideoStats(e,t,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(i,t)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(i,t)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(i)),!t.muted&&this.record("VIDEO_ENCODE_FAILED",e,this.checResolutionSent(i))}setRemoteAudioStats(e,t){let i=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(t))}setRemoteVideoStats(e,t){let i=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(t))}record(e,t,i){if(F("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});let r=this.resultStorage.get(e);if(!r)return;r.result.push(i);let o=e==="VIDEO_ENCODE_FAILED"?F("ENCODE_EXCEPTION_TIMES"):5;if(r.result.length>=o){var s;let a=z(s=r.result).call(s,!0);r.isPrevNormal&&!a&&this.emit("exception",uL[e],e,t),!r.isPrevNormal&&a&&this.emit("exception",uL[e]+2e3,e+"_RECOVER",t),r.isPrevNormal=a,r.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&e.receiveLevel===0)}checkAudioInputLevel(e,t){return t instanceof rn&&!t.isActive||!!t.muted||e.sendVolumeLevel!==0}checkFramerateInput(e,t){let i=null;t._encoderConfig&&t._encoderConfig.frameRate&&(i=Mo(t._encoderConfig.frameRate));let r=e.captureFrameRate;return!i||!r||!(i>10&&r<5||i<10&&i>=5&&r<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checResolutionSent(e){var t;return!(!e.codecType||z(t=F("ENCODE_EXCEPTION_VALIDATE_CODEC")).call(t,e.codecType.toLocaleLowerCase()))||!e.captureFrameRate||e.sendFrameRate!==0||e.sendResolutionWidth!==0||e.sendResolutionHeight!==0}checkSendVideoBitrate(e,t){return!!t.muted||e.sendBitrate!==0}checkSendAudioBitrate(e,t){return t instanceof rn&&!t.isActive||!!t.muted||e.sendBitrate!==0}checkVideoDecode(e){return e.receiveBitrate===0||e.decodeFrameRate!==0}}let uL={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003,VIDEO_ENCODE_FAILED:2004},qn=new class{markSubscribeStart(n,e){performance.mark("agora-web-sdk/".concat(n,"/subscribe-").concat(e))}markPublishStart(n,e){performance.mark("agora-web-sdk/".concat(n,"/publish-").concat(e))}measureFromSubscribeStart(n,e){let t=performance.getEntriesByName("agora-web-sdk/".concat(n,"/subscribe-").concat(e));if(t.length>0){let i=t[t.length-1];return Math.round(performance.now()-i.startTime)}return 0}measureFromPublishStart(n,e){let t=performance.getEntriesByName("agora-web-sdk/".concat(n,"/publish-").concat(e));if(t.length>0){let i=t[t.length-1];return Math.round(performance.now()-i.startTime)}return 0}};function eo(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function Wh(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?eo(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):eo(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}class Xd{constructor(e){U(this,"store",void 0),U(this,"onStatsException",void 0),U(this,"onUploadPublishDuration",void 0),U(this,"onStatsChanged",void 0),U(this,"onVideoCodecChanged",void 0),U(this,"localStats",new Map),U(this,"remoteStats",new Map),U(this,"updateStatsInterval",void 0),U(this,"trafficStats",void 0),U(this,"trafficStatsPeerList",[]),U(this,"uplinkStats",void 0),U(this,"exceptionMonitor",void 0),U(this,"p2pChannel",void 0),U(this,"scalabilityMode",Ou.L1T1),U(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=e,this.exceptionMonitor=new Rz,this.exceptionMonitor.on("exception",(t,i,r)=>{this.onStatsException&&this.onStatsException(t,i,r)})}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(Se.LocalAudioTrack)||Wh({},ys)}getLocalVideoTrackStats(){return this.localStats.get(Se.LocalVideoTrack)||Wh({},cT)}getRemoteAudioTrackStats(e){let t=(o,s)=>{if(!this.trafficStats)return s;let a=this.trafficStats.peer_delay.find(c=>c.peer_uid===o);return a&&(s.publishDuration=a.B_ppad+(Date.now()-this.trafficStats.timestamp)),s},i={};if(e){var r;let o=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.audioStats;o&&(i[e]=t(e,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{audioStats:a}]=o;a&&(i[s]=t(s,a))});return i}getRemoteNetworkQualityStats(e){let t={};if(e){var i;let r=(i=this.remoteStats.get(e))===null||i===void 0?void 0:i.networkStats;r&&(t[e]=r)}else Array.from(this.remoteStats.entries()).forEach(r=>{let[o,{networkStats:s}]=r;s&&(t[o]=s)});return t}getNetworkQuality(){let e=0,t=0;return this.trafficStats&&(e=OT(this.trafficStats.B_unq),t=OT(this.trafficStats.B_dnq)),{uplinkNetworkQuality:e,downlinkNetworkQuality:t}}getRemoteVideoTrackStats(e){let t=(o,s)=>{if(!this.trafficStats)return s;let a=this.trafficStats.peer_delay.find(c=>c.peer_uid===o);return a&&(s.publishDuration=a.B_ppvd+(Date.now()-this.trafficStats.timestamp)),s},i={};if(e){var r;let o=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.videoStats;o&&(i[e]=t(e,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{videoStats:a}]=o;a&&(i[s]=t(s,a))});return i}getRTCStats(){let e=0,t=0,i=0,r=0,o=this.localStats.get(Se.LocalAudioTrack);o&&(e+=o.sendBytes,t+=o.sendBitrate);let s=this.localStats.get(Se.LocalVideoTrack);s&&(e+=s.sendBytes,t+=s.sendBitrate);let a=this.localStats.get(Se.LocalVideoLowTrack);a&&(e+=a.sendBytes,t+=a.sendBitrate),this.remoteStats.forEach(d=>{let{audioStats:l,videoStats:h}=d;l&&(i+=l.receiveBytes,r+=l.receiveBitrate),h&&(i+=h.receiveBytes,r+=h.receiveBitrate)});let c=1;return this.trafficStats&&(c+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:c,SendBitrate:t,SendBytes:e,RecvBytes:i,RecvBitrate:r,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter(t=>t.B_ppad!==void 0||t.B_ppvd!==void 0),e.peer_delay.filter(t=>this.trafficStatsPeerList.indexOf(t.peer_uid)===-1).forEach(t=>{var i;let r=(i=this.p2pChannel)===null||i===void 0?void 0:i.getRemoteMedia(t.peer_uid),o=r!=null&&r.videoSSRC?qn.measureFromSubscribeStart(this.store.clientId,r.videoSSRC):0,s=r!=null&&r.audioSSRC?qn.measureFromSubscribeStart(this.store.clientId,r.audioSSRC):0;t.B_ppad!==void 0&&t.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(t.peer_uid,t.B_ppad,t.B_ppvd,o>s?o:s),this.trafficStatsPeerList.push(t.peer_uid))}),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&y.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,t,i){if(!e)return!1;let r=!!i&&t.framesDecodeFreezeTime>i.framesDecodeFreezeTime,o=!i||t.framesDecodeCount>i.framesDecodeCount;return r||!o}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach(t=>{let[i,r]=t;switch(i){case Se.LocalVideoTrack:case Se.LocalVideoLowTrack:{let a=r,c=Wh({},cT),d=e.getStats(),l=e.getLocalMedia(i);if(d){let h=d.videoSend.find(p=>p.ssrc===(l==null?void 0:l.ssrcs[0].ssrcId));if(h){let p=e.getLocalVideoSize(),f=e.getEncoderConfig(Se.LocalVideoTrack);var o;(h.codec==="H264"||h.codec==="H265"||h.codec==="VP8"||h.codec==="VP9"||h.codec==="AV1X"||h.codec==="AV1")&&(c.codecType=h.codec,(a==null?void 0:a.codecType)!==h.codec&&((o=this.onVideoCodecChanged)===null||o===void 0||o.call(this,h.codec.toLocaleLowerCase()))),c.sendBytes=h.bytes,c.sendBitrate=a?8*Math.max(0,c.sendBytes-a.sendBytes):0,h.inputFrame?(c.captureFrameRate=h.inputFrame.frameRate,c.captureResolutionHeight=h.inputFrame.height,c.captureResolutionWidth=h.inputFrame.width):p&&(c.captureResolutionWidth=p.width,c.captureResolutionHeight=p.height),h.sentFrame?(c.sendFrameRate=h.sentFrame.frameRate,c.sendResolutionHeight=h.sentFrame.height,c.sendResolutionWidth=h.sentFrame.width):p&&(c.sendResolutionWidth=p.width,c.sendResolutionHeight=p.height),h.avgEncodeMs&&(c.encodeDelay=h.avgEncodeMs),f&&f.bitrateMax?c.targetSendBitrate=1e3*f.bitrateMax:h.targetBitrate&&(c.targetSendBitrate=h.targetBitrate),c.sendPackets=h.packets,c.sendPacketsLost=h.packetsLost,c.sendJitterMs=h.jitterMs,c.sendRttMs=h.rttMs,c.totalDuration=a?a.totalDuration+1:1,c.totalFreezeTime=a?a.totalFreezeTime:0,this.isLocalVideoFreeze(h)&&(c.totalFreezeTime+=1),h.scalabilityMode&&this.scalabilityMode!==h.scalabilityMode&&(y.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(h.scalabilityMode)),this.scalabilityMode=h.scalabilityMode)}this.trafficStats&&(c.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var s;this.localStats.set(i,c),((a==null?void 0:a.sendResolutionWidth)!==c.sendResolutionWidth||(a==null?void 0:a.sendResolutionHeight)!==c.sendResolutionHeight)&&((s=this.onStatsChanged)===null||s===void 0||s.call(this,"resolution",{width:c.sendResolutionWidth,height:c.sendResolutionHeight})),c&&l&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,l.track,c);break}case Se.LocalAudioTrack:{let a=r,c=Wh({},ys),d=e.getStats(),l=e.getLocalMedia(i);if(d){let h=d.audioSend.find(p=>p.ssrc===(l==null?void 0:l.ssrcs[0].ssrcId));if(h){if(h.codec!=="opus"&&h.codec!=="aac"&&h.codec!=="PCMU"&&h.codec!=="PCMA"&&h.codec!=="G722"||(c.codecType=h.codec),h.inputLevel)c.sendVolumeLevel=Math.round(32767*h.inputLevel);else{let p=e.getLocalAudioVolume();p&&(c.sendVolumeLevel=Math.round(32767*p))}c.sendBytes=h.bytes,c.sendPackets=h.packets,c.sendPacketsLost=h.packetsLost,c.sendJitterMs=h.jitterMs,c.sendRttMs=h.rttMs,c.sendBitrate=a?8*Math.max(0,c.sendBytes-a.sendBytes):0}}this.trafficStats&&(c.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(Se.LocalAudioTrack,c),c&&l&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,l.track,c);break}}})}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach(t=>{var i,r;let[o,{videoStats:s,audioStats:a,videoPcStats:c}]=t,d=a,l=s,h=c,p=Wh({},Mv),f=Wh({},DU),m=Wh({},NU),{audioTrack:g,videoTrack:S,audioSSRC:T,videoSSRC:C}=e.getRemoteMedia(o),b;b=this.store.useP2P?e.getStats(!0):e.getStats();let D=(i=b)===null||i===void 0?void 0:i.audioRecv.find(W=>W.ssrc===T),x=(r=b)===null||r===void 0?void 0:r.videoRecv.find(W=>W.ssrc===C),k=this.trafficStats&&this.trafficStats.peer_delay.find(W=>W.peer_uid===o);if(D&&(D.codec!=="opus"&&D.codec!=="aac"&&D.codec!=="PCMU"&&D.codec!=="PCMA"&&D.codec!=="G722"||(p.codecType=D.codec),D.outputLevel?p.receiveLevel=Math.round(32767*D.outputLevel):g&&(p.receiveLevel=Math.round(32767*g.getVolumeLevel())),p.receiveBytes=D.bytes,p.receivePackets=D.packets,p.receivePacketsLost=D.packetsLost,p.receivePacketsDiscarded=D.packetsDiscarded,p.packetLossRate=p.receivePacketsLost/(p.receivePackets+p.receivePacketsLost),p.receiveBitrate=d?8*Math.max(0,p.receiveBytes-d.receiveBytes):0,p.totalDuration=d?d.totalDuration+1:1,p.totalFreezeTime=d?d.totalFreezeTime:0,p.freezeRate=p.totalFreezeTime/p.totalDuration,p.receiveDelay=D.jitterBufferMs,p.totalDuration>10&&Xd.isRemoteAudioFreeze(g)&&(p.totalFreezeTime+=1)),x){var V;x.codec!=="H264"&&x.codec!=="H265"&&x.codec!=="VP8"&&x.codec!=="VP9"&&x.codec!=="AV1X"&&x.codec!=="AV1"||(f.codecType=x.codec),f.receiveBytes=x.bytes,f.receiveBitrate=l?8*Math.max(0,f.receiveBytes-l.receiveBytes):0,f.decodeFrameRate=x.decodeFrameRate<0?0:x.decodeFrameRate,f.renderFrameRate=x.decodeFrameRate<0?0:x.decodeFrameRate,x.outputFrame&&(f.renderFrameRate=x.outputFrame.frameRate),x.receivedFrame?(f.receiveFrameRate=x.receivedFrame.frameRate,f.receiveResolutionHeight=x.receivedFrame.height,f.receiveResolutionWidth=x.receivedFrame.width):S&&(f.receiveResolutionHeight=S._videoHeight||0,f.receiveResolutionWidth=S._videoWidth||0),x.framesRateFirefox!==void 0&&(f.receiveFrameRate=Math.round(x.framesRateFirefox)),f.receivePackets=x.packets,f.receivePacketsLost=x.packetsLost,f.packetLossRate=f.receivePacketsLost/(f.receivePackets+f.receivePacketsLost);let W=l?l.totalFreezeTime:0,K=l?l.totalDuration:0;f.totalDuration=l?l.totalDuration+1:1,f.totalFreezeTime=(V=x.totalFreezesDuration)!==null&&V!==void 0?V:W||0,f.receiveDelay=x.jitterBufferMs||0;let J=!!C&&e.getRemoteVideoIsReady(C);x.totalFreezesDuration===void 0&&S&&J&&Xd.isRemoteVideoFreeze(S,x,h)&&(f.totalFreezeTime+=1),f.freezeRate=Math.max(0,Math.min((f.totalFreezeTime-W)/(f.totalDuration-K),1))}k&&(p.end2EndDelay=k.B_ad,f.end2EndDelay=k.B_vd,p.transportDelay=k.B_ed,f.transportDelay=k.B_ed,p.currentPacketLossRate=k.B_ealr4/100,f.currentPacketLossRate=k.B_evlr4/100,m.uplinkNetworkQuality=k.B_punq?k.B_punq:0,m.downlinkNetworkQuality=k.B_pdnq?k.B_pdnq:0),this.remoteStats.set(o,{audioStats:p,videoStats:f,videoPcStats:x,networkStats:m}),g&&this.exceptionMonitor.setRemoteAudioStats(g,p),S&&this.exceptionMonitor.setRemoteVideoStats(S,f)})}}class _m{constructor(){U(this,"destChannelMediaInfos",new Map),U(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(e){qr(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){qr(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){ht(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function hL(n){if(!(n instanceof _m))return new H(L.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();let e=n.getSrcChannelMediaInfo(),t=n.getDestChannelMediaInfo();if(!e)return new H(L.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(t.size===0)return new H(L.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class Bu{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,t){U(this,"uid",void 0),U(this,"_uintid",void 0),U(this,"_trust_in_room_",!0),U(this,"_trust_audio_enabled_state_",!0),U(this,"_trust_video_enabled_state_",!0),U(this,"_trust_audio_mute_state_",!0),U(this,"_trust_video_mute_state_",!0),U(this,"_audio_muted_",!1),U(this,"_video_muted_",!1),U(this,"_audio_enabled_",!0),U(this,"_video_enabled_",!0),U(this,"_audio_added_",!1),U(this,"_video_added_",!1),U(this,"_is_pre_created",!1),U(this,"_video_pre_subscribed",!1),U(this,"_audio_pre_subscribed",!1),U(this,"_trust_video_stream_added_state_",!0),U(this,"_trust_audio_stream_added_state_",!0),U(this,"_audioTrack",void 0),U(this,"_videoTrack",void 0),U(this,"_dataChannels",[]),U(this,"_audioSSRC",void 0),U(this,"_videoSSRC",void 0),U(this,"_audioOrtc",void 0),U(this,"_videoOrtc",void 0),U(this,"_cname",void 0),U(this,"_rtxSsrcId",void 0),U(this,"_videoMid",void 0),U(this,"_audioMid",void 0),this.uid=e,this._uintid=t}}function ju(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function RC(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ju(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):ju(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}let pL=n=>`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1 2
a=msid-semantic: WMS
a=ice-lite`.concat(n?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:2
`),vC="9",fm=2e4,mm=4e4,BT=class{get localCapabilities(){return Li(this._localCapabilities)}get rtpCapabilities(){return Li(this._rtpCapabilities)}get candidates(){return Li(this._candidates)}get iceParameters(){return Li(this._iceParameters)}get dtlsParameters(){return Li(this._dtlsParameters)}constructor(n){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],t=arguments.length>2&&arguments[2]!==void 0&&arguments[2],i=arguments.length>3&&arguments[3]!==void 0&&arguments[3];U(this,"sessionDesc",void 0),U(this,"_localCapabilities",void 0),U(this,"_rtpCapabilities",void 0),U(this,"_candidates",void 0),U(this,"_originCandidates",void 0),U(this,"_iceParameters",void 0),U(this,"_isUseExtmapAllowMixed",void 0),U(this,"_isUseLocalCodecs",void 0),U(this,"_isUseDataChannel",void 0),U(this,"_dtlsParameters",void 0),U(this,"setup",void 0),U(this,"currentMidIndex",void 0),U(this,"cname",void 0),U(this,"useLocalCodecsMids",[]),U(this,"preloadSsrcs",[]),U(this,"firefoxSsrcMidMap",new Map),this._isUseExtmapAllowMixed=e,this._isUseLocalCodecs=t,this._isUseDataChannel=i,n=Li(n);let{iceParameters:r,dtlsParameters:o,candidates:s,rtpCapabilities:a,setup:c,localCapabilities:d,cname:l}=n;this._rtpCapabilities=a,this._candidates=s,this._originCandidates=Li(s),this._iceParameters=r,this._dtlsParameters=o,this._localCapabilities=d,this.setup=c,this.cname=l,[this.sessionDesc]=this.updateRemoteRTPCapabilities(a),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}checkPreloadSsrcs(n){return n.length===this.preloadSsrcs.length&&n.every(e=>{var t;return z(t=this.preloadSsrcs).call(t,e)})}preloadRemoteMedia(n){let e=0,t=[],i=[];for(;n>0;){let r=[RC({ssrcId:mm+e},F("USE_SUB_RTX")?{rtx:mm+e+1}:{})],o="".concat(mm+e,"_").concat(fm+e),{ssrcs:s,ssrcGroups:a}=am(r,this.cname,F("SYNC_GROUP")?o:void 0),c=this.preCreateOrRecycleSendMedia("video",s,a,void 0),d=[{ssrcId:fm+e}],l="".concat(mm+e,"_").concat(fm+e),{ssrcs:h,ssrcGroups:p}=am(d,this.cname,F("SYNC_GROUP")?l:void 0),f=this.preCreateOrRecycleSendMedia("audio",h,p,void 0);n--,e+=2,t.push(c,f),i.push(s[0].ssrcId,h[0].ssrcId)}return this.useLocalCodecsMids.push(...t),this.preloadSsrcs=i,{mids:t,preSSRCs:i,isAvailable:!0}}preCreateOrRecycleSendMedia(n,e,t,i){let r=this.rtpCapabilities.send.videoCodecs,o=this._isUseLocalCodecs||r.length===0?this.localCapabilities.recv:this.rtpCapabilities.send;y.debug("create or recycle send media without remote rtp capabilities, ssrcs ",e[0].ssrcId);let s=n===ke.VIDEO?o.videoCodecs:o.audioCodecs,a=n===ke.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;let c="".concat(this.currentMidIndex),d={media:{mediaType:n,port:vC,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.map(l=>l.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:t,rtcpFeedbackWildcards:[],payloads:s,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};return d=this.mungSendMediaDesc(d,i),this.sessionDesc.mediaDescriptions.push(d),this.updateBundleMids(),c}toString(){return sn(this.sessionDesc)}send(n,e,t,i){let{ssrcs:r,ssrcGroups:o}=am(e,this.cname,F("SYNC_GROUP")?t:void 0),s=this.findPreloadMediaDesc(r);if(s){if(ji()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,s.attributes.mid),i&&(i.twcc||i.remb)){let a=this.sessionDesc.mediaDescriptions.indexOf(s);return this.sessionDesc.mediaDescriptions[a]=this.mungSendMediaDesc(s,i),{mid:s.attributes.mid,needExchangeSDP:!0}}return{mid:s.attributes.mid,needExchangeSDP:!1}}{let a=this.findAvailableMediaIndex(n,r),c;return a===-1||a===1&&(Cr()||function(){let d=Zt();return!(d.name!==pt.CHROME||!d.osVersion)&&Number(d.version)<=90}()||Dr(143)||Tl(143)||F("RESERVE_MID_1_MLINE")||F("ENABLE_ENCODED_TRANSFORM")&&wc())||a===0&&!function(d){let l=Zt();return!(l.name!==pt.FIREFOX||!l.osVersion)&&Number(l.version)===d}(138)&&F("USE_SUB_RTX")||Ah()?(c=this.createOrRecycleSendMedia(n,r,o,"sendonly",i),this.updateBundleMids()):(c=Li(this.sessionDesc.mediaDescriptions[a]),c.attributes.direction="sendonly",c.attributes.ssrcs=r,c.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[a]=this.mungSendMediaDesc(c,i)),ji()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,c.attributes.mid),{mid:c.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){let{mediaDesc:n,needExchangeSDP:e}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:n.attributes.mid,needExchangeSDP:e}}batchSend(n){let e=n.map(r=>{let{kind:o,ssrcMsg:s,mslabel:a}=r;return this.send(o,s,a)}),t=[],i=!1;return e.forEach(r=>{let{mid:o,needExchangeSDP:s}=r;s&&(i=!0),t.push(o)}),{mids:t,needExchangeSDP:i}}stopSending(n){let e=this.sessionDesc.mediaDescriptions.filter(t=>t.attributes.mid&&n.indexOf(t.attributes.mid)!==-1);if(e.length!==n.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach(t=>{t.attributes.mid==="0"||ji()||Ah()?t.attributes.ssrcs=[]:(t.attributes.ssrcs=[],t.attributes.direction="inactive",t.media.port="0")}),this.updateBundleMids()}mute(n){let e=this.sessionDesc.mediaDescriptions.find(t=>t.attributes.mid===n);if(!e)throw new Error("mediaDescription not found with ".concat(n," in remote SDP when calling RemoteSDP.mute."));e.attributes.direction="inactive"}unmute(n){let e=this.sessionDesc.mediaDescriptions.find(t=>t.attributes.mid===n);if(!e)throw new Error("mediaDescription not found with ".concat(n," in remote SDP when calling RemoteSDP.unmute."));e.attributes.direction="sendonly"}muteRemote(n){let e=this.sessionDesc.mediaDescriptions.filter(t=>z(n).call(n,t.attributes.mid||""));if(e.length!==n.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(t=>{t.attributes.direction="inactive"})}unmuteRemote(n){let e=this.sessionDesc.mediaDescriptions.filter(t=>z(n).call(n,t.attributes.mid||""));if(e.length!==n.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(t=>{t.attributes.direction="recvonly"})}receive(n,e,t,i){n.forEach((r,o)=>{this.createOrRecycleRecvMedia(r,[],"recvonly",e,t,i[o])}),this.updateBundleMids()}stopReceiving(n){let e=this.sessionDesc.mediaDescriptions.filter(t=>n.indexOf(t.attributes.mid)!==-1);if(e.length!==n.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach(t=>{t.media.port="0",t.attributes.direction="inactive"}),this.updateBundleMids()}updateRemoteRTPCapabilities(n){let e=this.sessionDesc||Oo((t=this._isUseExtmapAllowMixed,this._isUseDataChannel?pL(t):`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite`.concat(t?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`)));var t;this._rtpCapabilities=n;let i=!1,r=this.rtpCapabilities.send,o=this.localCapabilities.send,s=this.localCapabilities.recv,a=s.videoCodecs,c=s.audioCodecs,d=s.videoExtensions,l=s.audioExtensions;for(let m of e.mediaDescriptions){var h;if(m.attributes.direction!=="sendonly"||typeof m.attributes.mid!="string"||!z(h=this.useLocalCodecsMids).call(h,m.attributes.mid)){if(i=!0,m.attributes.iceUfrag=this._iceParameters.iceUfrag,m.attributes.icePwd=this._iceParameters.icePwd,m.attributes.fingerprints=this._dtlsParameters.fingerprints,m.attributes.candidates=this._candidates,m.attributes.setup=this.setup,m.media.mediaType==="application"&&(m.attributes.sctpPort="5000"),m.media.mediaType==="video")if(this._isUseLocalCodecs&&m.attributes.direction==="sendonly"){var p;m.media.fmts=a.map(S=>S.payloadType.toString(10)),m.attributes.payloads=a,m.attributes.extmaps=d;let g=m.attributes.mid;typeof g!="string"||z(p=this.useLocalCodecsMids).call(p,g)||this.useLocalCodecsMids.push(g)}else if(r.videoCodecs.length===0){let g=o.videoCodecs.filter(S=>{var T,C;return(T=S.rtpMap)===null||T===void 0?void 0:z(C=T.encodingName.toLowerCase()).call(C,"vp8")});g.length===0&&g.push(o.videoCodecs[0]),m.media.fmts=g.map(S=>S.payloadType.toString(10)),m.attributes.payloads=g,m.attributes.extmaps=[]}else m.media.fmts=r.videoCodecs.map(g=>g.payloadType.toString(10)),m.attributes.payloads=r.videoCodecs,m.attributes.extmaps=r.videoExtensions;if(m.media.mediaType==="audio")if(this._isUseLocalCodecs&&m.attributes.direction==="sendonly"){var f;m.media.fmts=c.map(S=>S.payloadType.toString(10)),m.attributes.payloads=c,m.attributes.extmaps=l;let g=m.attributes.mid;typeof g!="string"||z(f=this.useLocalCodecsMids).call(f,g)||this.useLocalCodecsMids.push(g)}else if(r.audioCodecs.length===0){let g=o.audioCodecs.filter(S=>{var T,C;return(T=S.rtpMap)===null||T===void 0?void 0:z(C=T.encodingName.toLowerCase()).call(C,"opus")})||[o.audioCodecs[0]];m.media.fmts=g.map(S=>S.payloadType.toString(10)),m.attributes.payloads=g,m.attributes.extmaps=[]}else m.media.fmts=r.audioCodecs.map(g=>g.payloadType.toString(10)),m.attributes.payloads=r.audioCodecs,m.attributes.extmaps=r.audioExtensions,Ol(m)}}return this.sessionDesc=e,this.currentMidIndex=e.mediaDescriptions.length-1,[this.sessionDesc,i]}updateCandidates(n){let e=this._originCandidates.filter(i=>i.transport==="udp"),t=[];if(e.forEach(i=>{t.push(RC(RC({},i),{},{foundation:"tcpcandidate",priority:Number(i.priority)-1+"",transport:"tcp",port:Number(i.port)+90+""}))}),e.length!==0){switch(n){case be.TCP_RELAY:this._candidates=t;break;case be.UDP_TCP_RELAY:case be.RELAY:this._candidates=[...e,...t];break;default:this._candidates=e}for(let i of this.sessionDesc.mediaDescriptions)i.attributes.candidates=this.candidates}}restartICE(n){n=Li(n),this._iceParameters=n,this.sessionDesc.mediaDescriptions.forEach(e=>{e.attributes.iceUfrag=n.iceUfrag,e.attributes.icePwd=n.icePwd})}predictReceivingMids(n){let e=[];for(let t=0;t<n;t++)e.push((this.currentMidIndex+t+1).toString(10));return e}findAvailableMediaIndex(n,e){return this.sessionDesc.mediaDescriptions.findIndex(t=>{let i=t.media.mediaType===n&&t.media.port!=="0"&&(t.attributes.direction==="sendonly"||t.attributes.direction==="sendrecv")&&t.attributes.ssrcs.length===0;if(ji()){if(i){let r=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(r||t.attributes.mid!=="0"&&t.attributes.mid!=="1")||!(!r||r!==t.attributes.mid)}return!1}return i})}createOrRecycleDataChannel(){for(let t of this.sessionDesc.mediaDescriptions)if(t.media.mediaType==="application")return{mediaDesc:t,needExchangeSDP:!1};this.currentMidIndex+=1;let n="".concat(this.currentMidIndex),e={media:{mediaType:"application",port:vC,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(n),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(e),{mediaDesc:e,needExchangeSDP:!0}}createOrRecycleRecvMedia(n,e,t,i,r,o){let s=n._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=Nl(s,a,this.localCapabilities.send,s===ke.VIDEO?i:r),d=s===ke.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;let l="".concat(this.currentMidIndex),h={media:{mediaType:s,port:vC,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map(f=>f.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:t,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};h=this.mungRecvMediaDsec(h,n,o);let p=this.findFirstClosedMedia(s);if(p){let f=this.sessionDesc.mediaDescriptions.indexOf(p);this.sessionDesc.mediaDescriptions[f]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}updateRemoteDtlsParameters(n){let e=new Set(this._dtlsParameters.fingerprints.map(r=>r.fingerprint)),t=new Set(n.map(r=>r.fingerprint)),i=!1;e.size!==t.size&&(i=!0);for(let r of e)t.has(r)||(i=!0);return i}updateRemoteCodec(n,e,t){let i=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(h=>h.rtpMap&&h.rtpMap.encodingName.toLowerCase()||"").filter(h=>{var p;return z(p=Object.keys(tt)).call(p,h)}))],r=new Set(e);if(i.every(h=>r.has(h)))return y.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(e)),!1;let o=this._rtpCapabilities.recv.videoCodecs.filter(h=>e.some(p=>{var f;return z(f=h.rtpMap&&h.rtpMap.encodingName.toLowerCase()||"").call(f,p)}));if(o.length===0)return y.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(i," codecs: ").concat(e)),!1;let s=[...new Set(o.map(h=>h.rtpMap&&h.rtpMap.encodingName.toLowerCase()||""))],a;if(y.debug("updateRemoteCodec, from ".concat(i," to ").concat(s)),n.length===0)a=this.sessionDesc.mediaDescriptions.filter(h=>h.media.mediaType==="video"&&h.attributes.direction==="recvonly");else if(a=this.sessionDesc.mediaDescriptions.filter(h=>h.attributes.mid&&h.media.mediaType==="video"&&z(n).call(n,h.attributes.mid)&&h.attributes.direction==="recvonly"),a.length!==n.length)return y.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(n,", codecs: ").concat(e)),!1;if(F("USE_PUB_RTX")||F("USE_SUB_RTX")){let h=Vc(o,this.rtpCapabilities.recv.videoCodecs);o.push(...h)}this._rtpCapabilities.recv.videoCodecs=o;let c=this.localCapabilities.send,d=this.rtpCapabilities.recv,l=Nl(ke.VIDEO,d,c,t);return a.forEach(h=>{let p=l.map(f=>f.payloadType.toString(10));y.debug("updateRemoteCodec mid: ".concat(h.attributes.mid,", from"),h.attributes.payloads,"to",l),h.attributes.payloads=l,h.media.fmts=p}),y.debug("updateRemoteCodec success, mids: ".concat(n,", codecs: ").concat(e,", remote recv: ").concat(this._rtpCapabilities.recv.videoCodecs.length,", remote send: ").concat(this._rtpCapabilities.send.videoCodecs.length)),!0}createOrRecycleSendMedia(n,e,t,i,r){let o=this.rtpCapabilities.send.videoCodecs,s=this._isUseLocalCodecs||o.length===0?this.localCapabilities.recv:this.rtpCapabilities.send,a=n===ke.VIDEO?s.videoCodecs:s.audioCodecs,c=n===ke.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;let d="".concat(this.currentMidIndex),l={media:{mediaType:n,port:vC,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:t,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungSendMediaDesc(l,r);let h=this.findFirstClosedMedia(n);if(h){let p=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[p]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(n=>n.media.port!=="0").map(n=>n.attributes.mid)}mungRecvMediaDsec(n,e,t){let i=Li(n);return Fu(i),Kd(i,e),LT(i,e),cC(i),kT(i,t,this.localCapabilities.send),i}mungSendMediaDesc(n,e){let t=Li(n);return t.attributes&&t.attributes.payloads&&Array.isArray(t.attributes.payloads)&&t.attributes.payloads.length>0&&t.attributes.payloads.forEach(i=>{i.rtpMap&&i.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&F("ENABLE_DOWN_SPS_PPS")&&(i.fmtp&&i.fmtp.parameters||(i.fmtp={parameters:{}}),i.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")}),kT(t,e,this.localCapabilities.recv),Ol(t),t}updateRecvMedia(n,e){let t=this.sessionDesc.mediaDescriptions.findIndex(i=>i.attributes.mid===n);if(t!==-1){let i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[t],e);this.sessionDesc.mediaDescriptions[t]=i}}bumpMid(n){this.currentMidIndex+=n}findFirstClosedMedia(n){return this.sessionDesc.mediaDescriptions.find(e=>ji()?e.media.port==="0"&&e.media.mediaType===n:e.media.port==="0")}findPreloadMediaDesc(n){return this.sessionDesc.mediaDescriptions.find(e=>{var t;return((t=e.attributes)===null||t===void 0||(t=t.ssrcs[0])===null||t===void 0?void 0:t.ssrcId)===n[0].ssrcId})}getSSRC(n){var e;return(e=this.sessionDesc.mediaDescriptions.find(t=>t.attributes.mid===n))===null||e===void 0?void 0:e.attributes.ssrcs}};function _L(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function Pl(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?_L(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):_L(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}var Oa=function(n){return n[n.DOWN=0]="DOWN",n[n.UP=1]="UP",n}(Oa||{});let Gu=new Map;function jT(n,e,t,i){let{scale:r}=n;if(r===0&&i===Oa.UP||r>=e.length-1&&i===Oa.DOWN)return n;let o=Pl(Pl({},n),{},{scale:i===Oa.DOWN?++r:--r});switch(t){case"maintain-framerate":o=Pl(Pl({},o),e[r].motion);break;case"maintain-resolution":o=Pl(Pl({},o),e[r].detail);break;case"balanced":o=Pl(Pl({},o),e[r].balanced)}return o}function fL(n,e){if(e){let t={overUse:0,underUse:0,adaptationList:mL(e)};Gu.set(n,t)}else Gu.delete(n)}function mL(n){let e=Pl({},n),{bitrateMax:t,frameRate:i,scaleResolutionDownBy:r,bitrateMin:o}=e,{MIN_FRAME_RATE:s,MAX_THRESHOLD_FRAMERATE:a,MAX_SCALE:c,BITRATE_MIN_THRESHOLD:d,BITRATE_MAX_THRESHOLD:l,BWE_SCALE_UP_THRESHOLD:h,BWE_SCALE_DOWN_THRESHOLD:p,PERF_SCALE_DOWN_THRESHOLD:f,PERF_SCALE_UP_THRESHOLD:m,BALANCE_BITRATE_FACTOR:g,BALANCE_FRAMERATE_FACTOR:S,BALANCE_RESOLUTION_FACTOR:T,MOTION_RESOLUTION_FACTOR:C,MOTION_BITRATE_FACTOR:b,DETAIL_FRAMERATE_FACTOR:D,DETAIL_BITRATE_FACTOR:x}=Bf,k=Math.min(e.frameRate,a),V=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(p,1)*t),bwe_up:t,fps_down:Math.round(Math.pow(f,1)*k),fps_up:i},balanced:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:t,bitrateMin:o},motion:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:t,bitrateMin:o},detail:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:t,bitrateMin:o}}];for(let W=1;W<=c;W++){let K={bwe_up:Math.round(Math.pow(h,W)*t),bwe_down:Math.round(Math.pow(p,W+1)*t),fps_up:Math.round(Math.pow(m,W)*k),fps_down:Math.round(Math.pow(f,W+1)*k)},J={scaleResolutionDownBy:r/Math.pow(T,W),frameRate:Math.max(Math.round(Math.pow(S,W)*i),s),bitrateMax:Math.max(Math.round(Math.pow(g,W)*t),l),bitrateMin:Math.max(Math.round(Math.pow(g,W)*o),d)},se={scaleResolutionDownBy:r/Math.pow(C,W),frameRate:i,bitrateMax:Math.max(Math.round(Math.pow(b,W)*t),l),bitrateMin:Math.max(Math.round(Math.pow(b,W)*o),d)},Ne={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(D,W)*i),s),bitrateMax:Math.max(Math.round(Math.pow(x,W)*t),l),bitrateMin:Math.max(Math.round(Math.pow(x,W)*o),d)};V.push({scale:W,threshold:K,balanced:J,motion:se,detail:Ne})}return V}function s2(n,e,t,i,r,o){let s=Gu.get(n)||{overUse:0,underUse:0,adaptationList:mL(r)},{adaptationList:a}=s;Gu.set(n,s);let{OVERUSE_TIMES_THRESHOLD:c,UNDERUSE_TIMES_THRESHOLD:d}=Bf,{scale:l}=i,h,p;return typeof e=="number"&&e>0&&function(f,m,g,S){if(m>=g.length)return!1;let{threshold:{fps_down:T}}=g[m];return F("FORCE_AG_HIGH_FRAMERATE")&&S==="maintain-framerate"&&(T=g[0].threshold.fps_down),f<T}(e,l,a,o)&&(s.overUse++,p=xf.CPU,s.overUse>c)||typeof t=="number"&&t>0&&function(f,m,g){if(m>=g.length)return!1;let{threshold:{bwe_down:S}}=g[m];return f<S}(t,l,a)&&(s.overUse++,p=xf.BANDWIDTH,s.overUse>c)?(s.overUse=0,s.underUse=0,h=jT(i,a,o,Oa.DOWN),[h,p]):(typeof e=="number"&&e>0&&typeof t=="number"&&t>0&&function(f,m,g,S){if(m===0)return;let{threshold:{fps_up:T}}=g[m];return F("FORCE_AG_HIGH_FRAMERATE")&&S==="maintain-framerate"&&(T=g[1].threshold.fps_up),f>T}(e,l,a,o)&&function(f,m,g){if(m===0)return;let{threshold:{bwe_up:S}}=g[m];return f>S}(t,l,a)&&(s.underUse++,s.underUse>d&&(s.overUse=0,s.underUse=0,h=jT(i,a,o,Oa.UP),h.scale===0&&(p=xf.NONE))),[h,p])}function a2(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function CC(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?a2(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):a2(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}function yC(n){var e;return!!F("ENABLE_AG_ADAPTATION")&&!!(n instanceof yi||z(e=n._hints).call(e,Re.CUSTOM_TRACK))&&(!!F("FORCE_SUPPORT_AG_ADAPTATION")||!!(wN(14,0,!1)&&bN(17,4,!0)||fv(14)&&mv(17,4,!0)))}let GT=new Map;function WT(n,e,t,i,r,o){if(V_(n,t),r(e),i!=="balanced"&&i!=="maintain-framerate"&&i!=="maintain-resolution")return;let s=-1;fL(n,e);let a=window.setInterval(()=>{let d=GT.get(n);if(!F("ENABLE_AG_ADAPTATION")||!d)return V_(n,t),void r(e);let l=o();if(l.sendPackets>0&&l.OutgoingAvailableBandwidth>0){if(s===-1)return void(s=Date.now());if(Date.now()-s<1e3)return;let h=l.sendFrameRate,p=l.OutgoingAvailableBandwidth,[f,m]=s2(n,h,p,d.adaptationConfig,e,i);m&&(t.qualityLimitationReason=m),f&&d.adaptationConfig.scale!==f.scale&&(y.debug("[".concat(n,"] applyAdaptation: ").concat(t.qualityLimitationReason,`
           sendFps `).concat(h,", bwe ").concat(p,", switch from ").concat(d.adaptationConfig.scale," to ").concat(f.scale," ")),d.adaptationConfig=CC(CC({},d.adaptationConfig),f),r(f))}},F("CHECK_LOCAL_STATS_INTERVAL")),c=CC({},e);GT.set(n,{timer:a,adaptationConfig:c,originConfig:e,adaptationFunc:r}),y.debug("[".concat(n,"] start adaptation, originConfig: ").concat(JSON.stringify(e),", degradationPreference: ").concat(i))}function V_(n,e){let t=GT.get(n);if(t){let{timer:i}=t;window.clearTimeout(i),GT.delete(n)}e.qualityLimitationReason=xf.NONE,fL(n)}function Em(n,e){var t;let i;switch(e){case Se.LocalAudioTrack:i=_i.Audio;break;case Se.LocalVideoTrack:i=z(t=n._hints).call(t,Re.SCREEN_TRACK)?_i.Screen:_i.High;break;case Se.LocalVideoLowTrack:i=_i.Low}return i}function EL(n){let e=ot();if(n.some(t=>t._bypassWebAudio))throw new O(L.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!e.webAudioMediaStreamDest)throw new O(L.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function HT(n,e){EL(n);let t=new rn;return n.forEach(i=>t.addAudioTrack(i)),t}let gL=!ot().supportUnifiedPlan||F("CHROME_FORCE_PLAN_B")&&Ud();function KT(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(n.useDcSignal)return t={spec:e,store:n},go("DataChannelConnection").create(t);var t;return gL?function(i){return go("PlanBConnection").create(i)}({spec:e,store:n}):new bn(e,n)}function F_(n){return n&&(n.iceConnectionState==="disconnected"||n.iceConnectionState==="checking"||n.iceConnectionState==="failed")}function YT(n){try{if(n.iceServers)return!1;if(n.turnServer&&n.turnServer.mode!=="off"){if(bt(n.turnServer.servers))return!1;if(F("FORCE_TURN_TCP")||n.turnServer.servers.concat(n.turnServer.serversFromGateway||[]).some(e=>e.forceturn))return!0}return!1}catch{return!1}}var Qt;function $t(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function jc(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?$t(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):$t(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}let bn=(Qt=class NR extends AT{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return(e=(t=this.peerConnection.getReceivers()[0])===null||t===void 0||(t=t.transport)===null||t===void 0?void 0:t.state)!==null&&e!==void 0?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var t;return z(t=Object.keys(tt)).call(t,e)}))]}constructor(e,t){super(e,t),U(this,"id",vt(5,"connection-")),U(this,"store",void 0),U(this,"peerConnection",void 0),U(this,"forceTurn",!1),U(this,"remoteSDP",void 0),U(this,"initialOffer",void 0),U(this,"transportEventReceiver",void 0),U(this,"statsFilter",void 0),U(this,"extension",{useXR:F("USE_XR")}),U(this,"localCapabilities",void 0),U(this,"remoteCodecs",void 0),U(this,"localCandidateCount",0),U(this,"allCandidatesReceived",!1),U(this,"isPreallocation",!1),U(this,"isPreRender",!1),U(this,"preMediaMap",new Map),U(this,"dataStreamChannelMap",new Map),U(this,"establishPromise",void 0),U(this,"recoveredDataChannelIds",[]),U(this,"currentDataChannelId",1),U(this,"supportAV1RtpSpec",!1),U(this,"mutex",void 0),U(this,"qualityLimitationReason",xf.NONE),U(this,"isFirstConnected",!1),this.store=t,this.forceTurn=YT(e),this.mutex=new mn("P2PConnection-mutex",t.clientId),this.peerConnection=new RTCPeerConnection(NR.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.isFirstConnected=!1,this.statsFilter=Ov(this.peerConnection,F("STATS_UPDATE_INTERVAL"),void 0,ji()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,e.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(e){return this.preMediaMap.get(e)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(e,t){if(this.remoteCodecs=t,!this.remoteSDP)return void y.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(t));if(this.remoteSDP.updateRemoteCodec(e,t,this.store.codec)){let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);let o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}else y.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});let t=await this.peerConnection.createOffer();if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let i=ba(t.sdp),r=await lC({filterRTX:!F("USE_PUB_RTX")&&!F("USE_SUB_RTX"),filterVideoFec:F("FILTER_VIDEO_FEC"),filterAudioFec:F("FILTER_AUDIO_FEC"),filterVideoCodec:F("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:F("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:F("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=Ns(r),this.initialOffer=t,F("ENABLE_SVC")&&this.store.codec=="av1"){let s=await dC();var e;s&&(this.supportAV1RtpSpec=!0,(e=r.send)===null||e===void 0||e.videoExtensions.push(s))}let o;return t.sdp&&MT(t.sdp)&&(o=Li(r),zP(o)),jc(jc({},i),{},{rtpCapabilities:o||r,offerSDP:t.sdp})}catch(t){throw new O(L.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.initialOffer.sdp&&MT(this.initialOffer.sdp)&&qP(e.rtpCapabilities,this.localCapabilities),this.remoteSDP=new BT(jc(jc({},e),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!F("ENABLE_PRE_SUB_WITH_PRE_PC")||!F("PRE_USE_LOCAL_CODECS"))&&kh(this.store)),e.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);let t=this.remoteSDP.toString(),i=Xo(this.initialOffer.sdp,this.extension),r=this.logSDPExchange(i||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),r==null||r(t),await this.peerConnection.setRemoteDescription({type:"answer",sdp:t});let o=this.peerConnection.getTransceivers()[0];if(o!=null&&o.receiver&&this.tryBindTransportEvents(o.receiver),kh(this.store))if(e.preallocation&&F("ENABLE_PRE_SUB_WITH_PRE_PC")){let s=F("PRE_SUB_NUM"),{mids:a,preSSRCs:c}=this.remoteSDP.preloadRemoteMedia(s);await zn(this.peerConnection,this.remoteSDP,this.extension),y.debug("[".concat(this.store.clientId,"] [P2PConnection] preload media, in pre pc,add preload ssrcs ").concat(c)),this.presetMedia(a,c)}else{let{preSSRCs:s=[]}=e,a=s.map(d=>d.ssrcMsg[0].ssrcId);if(s.length===0)return;let{mids:c}=this.remoteSDP.batchSend(s.map(d=>Object.assign({},d)));await zn(this.peerConnection,this.remoteSDP,this.extension),y.debug("[P2PConnection.connect] preload media, after join, add preload ssrcs ".concat(a)),this.presetMedia(c,a)}}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(t.toString()))}}presetMedia(e,t){e.forEach((i,r)=>{this.peerConnection.getTransceivers().forEach(o=>{if(o.mid!=null&&i===o.mid&&o.receiver.track){let s=o.receiver.track,a;s.kind==="video"&&F("ENABLE_PRE_RENDER")&&(a=new pT({trackId:"track-".concat(s.kind,"-unknown-").concat(this.store.clientId,"_").concat(vt(5,""))},!0),a.updateVideoTrack(s),a.onFirstVideoFrameRender=()=>{var c;let d=this.preMediaMap.get(t[r]);d&&(d.firstVideoRender=Date.now()),(c=this.onFirstVideoRender)===null||c===void 0||c.call(this,t[r])},a.onVideoBufferReady=()=>{var c;(c=this.onFirstVideoBufferReady)===null||c===void 0||c.call(this,t[r])},a.play(this.store.sessionId||void 0),this.isPreRender=!0),this.preMediaMap.set(t[r],{mid:i,track:s,player:a,transceiver:o})}}),this.store.peerReceiver()})}checkDtlsParameters(e){return!!this.remoteSDP&&e.length>0&&this.remoteSDP.updateRemoteDtlsParameters(e)}async updateRemoteConnect(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");let t=!1,{rtpCapabilities:i}=e;if([,t]=this.remoteSDP.updateRemoteRTPCapabilities(i),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){let s=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);t=t||s}let{preSSRCs:r=[]}=e,o=r.map(s=>s.ssrcMsg[0].ssrcId);if(!this.remoteSDP.checkPreloadSsrcs(o)){let s=[],a=[];if(Array.from(this.preMediaMap.entries()).every(c=>{let[d,{mid:l,player:h,track:p}]=c;return s.push(l),a.push(d),this.preMediaMap.delete(d),h&&h.destroy(),!0}),s.length>0&&(this.remoteSDP.stopSending(s),await zn(this.peerConnection,this.remoteSDP,this.extension),y.warn("[P2PConnection.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(a)),_e.reportApiInvoke(this.store.sessionId,{name:Yi.PRELOAD_MEDIA_FAILED,options:[r,a],tag:ct.TRACER}).onSuccess()),r.length>0){let{mids:c}=this.remoteSDP.batchSend(r.map(d=>Object.assign({},d)));await zn(this.peerConnection,this.remoteSDP,this.extension),y.debug("[P2PConnection.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(o)),this.presetMedia(c,o)}}t?(await zn(this.peerConnection,this.remoteSDP,this.extension),y.debug("[P2PConnection] updateRemoteConnect by exchanging SDP.")):y.debug("[P2PConnection] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(t.toString()))}}send(e,t,i){var r=this;return wo(function*(){let o=yield St(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let s=[],a=nm();e.forEach(S=>{let T=r.peerConnection.addTransceiver(S._mediaStreamTrack,jc({direction:"sendonly"},S.trackMediaType==="video"&&r.supportAV1RtpSpec&&a?{sendEncodings:[{scalabilityMode:a}]}:{}));s.push(T),S._updateRtpTransceiver(T)}),ji()&&F("SIMULCAST")===!0&&(yield St(r.applySimulcastForFirefox(s,e)));let c=yield St(r.peerConnection.createOffer()),d=r.remoteSDP.predictReceivingMids(e.length),l=r.mungSendOfferSDP(c.sdp,e,d),h=Oo(l),p=d.map(S=>{let T=h.mediaDescriptions.find(C=>C.attributes.mid===S);if(!T)throw new Error("Cannot extract ssrc from mediaDescription.");return xc(T,F("USE_PUB_RTX"))}),f;try{f=yield p}catch(S){f=[],r.remoteSDP.receive(e,t,i,f);let T=r.remoteSDP.toString();throw yield St(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield St(r.peerConnection.setRemoteDescription({type:"answer",sdp:T})),yield St(r.stopSending(d,!0)),S}r.remoteSDP.receive(e,t,i,f);let m=r.remoteSDP.toString(),g=r.logSDPExchange(l,"offer","local","send");return yield St(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield St(r.applySimulcastEncodings(s,e)),yield St(r.applySendEncodings(s,e)),g==null||g(m),yield St(r.peerConnection.setRemoteDescription({type:"answer",sdp:m})),s.map((S,T)=>{let C=d[T];return{localSSRC:p[T],id:C,transceiver:S}})}catch(s){throw s instanceof O?s:new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o()}})()}async createDataChannels(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(e);if(i&&i.readyState==="open")y.debug("[P2PConnection] Channels are already available and can be reused directly.");else{let o=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof o!="number")throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:o,negotiated:!0,ordered:!1,maxRetransmits:F("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,i)}t.forEach(o=>{o._updateOriginDataChannel(i)});let{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){let o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});let s=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(s),y.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else y.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(i){throw i instanceof O?i:new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(e){try{let t=this.dataStreamChannelMap.get(e);return t&&(t.id&&this.recoveredDataChannelIds.push(t.id),t.close()),void this.dataStreamChannelMap.delete(e)}catch(t){throw t instanceof O?t:new O(L.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(t.toString()))}}async stopSending(e,t){let i=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");r.map(c=>{var d;V_(this.id+c.mid,this),c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});let o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);let a=this.remoteSDP.toString();s==null||s(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(e,t,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,t,i,r);s&&(await zn(this.peerConnection,this.remoteSDP,this.extension),y.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP.")));let a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o,transceiver:a}}catch(o){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");let{mids:t,needExchangeSDP:i}=this.remoteSDP.batchSend(e);return i&&(await zn(this.peerConnection,this.remoteSDP,this.extension),y.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),t.map(r=>{let o=this.peerConnection.getTransceivers().find(s=>s.mid===r);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:r,transceiver:o}})}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(t.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");e.forEach(o=>{Array.from(this.preMediaMap.entries()).some(s=>{let[a,{mid:c,player:d}]=s;if(c===o)return this.preMediaMap.delete(a),d&&d.destroy(),!0})}),this.remoteSDP.stopSending(e);let t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(t.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);let t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(t.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);let t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(t.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let t=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map(s=>{s.direction="inactive"});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);let o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(t.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let t=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map(async(s,a)=>{s.direction="sendonly"});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(e,this.remoteCodecs,this.store.codec);let o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(t.toString()))}}restartICE(e){var t=this;return wo(function*(){let i=yield St(t.mutex.lock("From P2PConnection.restartICE"));try{if(!t.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");let r=ot().supportPCSetConfiguration,o=F("FORCE_TURN_TCP")||t.forceTurn;if(e===be.RELAY&&!r)return;if(r&&!o){let h=e===be.RELAY?"relay":"all",p=t.peerConnection.getConfiguration();p.iceTransportPolicy!==h&&(y.debug("[".concat(t.store.clientId,"] restartICE change iceTransportPolicy from [").concat(p.iceTransportPolicy,"] to [").concat(h,"]")),p.iceTransportPolicy=h,t.peerConnection.setConfiguration(p))}t.remoteSDP.updateCandidates(e);let s=yield St(t.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let a=ba(s.sdp),{remoteIceParameters:c}=yield a.iceParameters;t.remoteSDP.restartICE(c);let d=t.remoteSDP.toString(),l=t.logSDPExchange(s.sdp||"","offer","local","restartICE");t.store.descriptionStart(),yield St(t.peerConnection.setLocalDescription(s)),l==null||l(d),yield St(t.peerConnection.setRemoteDescription({type:"answer",sdp:d}))}catch(r){y.warning("[".concat(t.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}})()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;let e=await this.mutex.lock("From P2PConnection.extendCandidate");try{this.remoteSDP.updateCandidates(be.TCP_RELAY),await zn(this.peerConnection,this.remoteSDP,this.extension)}catch(t){y.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),t)}finally{e()}}close(){var e;this.peerConnection.getTransceivers().forEach(t=>{V_(this.id+t.mid,this)}),this.preMediaMap.forEach(t=>{let{player:i}=t;i&&i.destroy()}),this.preMediaMap.clear(),this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return jc(jc({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);let o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s==null||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new O(L.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,t){let i=this.peerConnection.getTransceivers().filter(r=>r.mid===e);i.length===1&&(this.isVP8Simulcast(t)?ji()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){let i=this.peerConnection.getTransceivers().find(r=>r.mid===t);i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){let e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){let t=e[0].transport.iceTransport,{local:i,remote:r}=t.getSelectedCandidatePair();return{local:jc(jc({},Ea),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:jc(jc({},Ea),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=e=>{if(e&&(e.errorCode||e.errorText)){var t;let i="code: ".concat(e.errorCode,", message: ").concat(e.errorText),r=e.port?"local: ".concat(e.port):"",o=_s(e.url||"");y.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICECandidateError(").concat(i,"), url: ").concat(o||"",", host_candidate:").concat(r)),(t=this.onICECandidateError)===null||t===void 0||t.call(this,i)}},this.peerConnection.onicegatheringstatechange=e=>{e&&e.target&&"iceGatheringState"in e.target&&y.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(e.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,y.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,y.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},F("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){let t={iceServers:[]},i=e.cloudProxyServer||"disabled";return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&(bt(e.turnServer.servers)?t.iceServers=e.turnServer.servers:F("NEW_TURN_MODE")&&t.iceServers&&i==="disabled"?(F("USE_TURN_SERVER_OF_GATEWAY")?e.turnServer.serversFromGateway&&t.iceServers.push(...NR.newTurnServerConfigToIceServers(e.turnServer.serversFromGateway)):t.iceServers.push(...NR.newTurnServerConfigToIceServers(e.turnServer.servers)),F("NEW_FORCE_TURN")&&(t.iceTransportPolicy="relay")):e.turnServer.mode!=="off"&&(t.iceServers&&t.iceServers.push(...NR.turnServerConfigToIceServers(e.turnServer.servers)),F("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...NR.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),F("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(t.iceTransportPolicy="relay")}))),F("ENABLE_ENCODED_TRANSFORM")&&ot().supportWebRTCEncodedTransform&&(t.encodedInsertableStreams=!0),t}static turnServerConfigToIceServers(e){let t=[];return e.forEach(i=>{i.security?i.tcpport&&t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(wa(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!F("FORCE_TURN_TCP")&&t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),t}static newTurnServerConfigToIceServers(e){let t=[];return e.forEach(i=>{let r=F("NEW_TURN_MODE");r===1?t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}):r===2?t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}):r===3?t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(wa(i.turnServerURL),":443?transport=tcp")}):r===4&&(t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}),t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}),t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(wa(i.turnServerURL),":443?transport=tcp")}))}),t}tryBindTransportEvents(e){let t=e.transport;if(t){this.transportEventReceiver=e,t.onstatechange=()=>{var r;t!=null&&t.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,t.state))},t.onerror=r=>{var o;(o=this.onDTLSTransportError)===null||o===void 0||o.call(this,"error"in r?r.error:r)};let i=t.iceTransport;i&&(i.onstatechange=()=>{let r=t==null?void 0:t.iceTransport.state;var o;r&&((o=this.onICETransportStateChange)===null||o===void 0||o.call(this,r))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){let{local:r,remote:o}=i.getSelectedCandidatePair()||{};if(r&&o){let s=r.address+":"+r.port,a=o.address+":"+o.port;y.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(_s(s)),", remote ").concat(JSON.stringify(_s(a))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,t){var i,r;if(t||(t=this.peerConnection.getSenders().find(g=>g.track===e._mediaStreamTrack)),!t)return y.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return y.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!ot().supportSetRtpSenderParameters)return y.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let o={},s={};switch(e._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;case"balanced":o.degradationPreference="balanced"}let a=Hd(this.peerConnection,e._mediaStreamTrack),c=rD(e);if(yC(e)&&a&&t&&c&&this.getLocalVideoStats&&z(i=["vp8","vp9"]).call(i,this.store.codec)){var d;let g=o.degradationPreference||(z(d=e._hints).call(d,Re.CUSTOM_TRACK)?F("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");WT(this.id+a.mid,c,this,g,S=>{t&&this.updateAdaptation(t,S)},this.getLocalVideoStats.bind(this))}if(e._encoderConfig){var l;let{bitrateMax:g,frameRate:S,scaleResolutionDownBy:T}=e._encoderConfig;g&&(s.maxBitrate=1e3*g),(z(l=e._hints).call(l,Re.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(S&&(s.maxFramerate=Mo(S)),T&&T>=1&&(s.scaleResolutionDownBy=T))}let{maxFramerate:h}=F("ENCODER_CONFIG_LIMIT");if(h&&typeof h=="number"&&(s.maxFramerate=s.maxFramerate?Math.min(s.maxFramerate,h):h),F("DSCP_TYPE")&&Ud()){var p;let g=F("DSCP_TYPE");z(p=["very-low","low","medium","high"]).call(p,g)&&(s.networkPriority=g)}let f=t.getParameters(),m=(r=f.encodings)===null||r===void 0?void 0:r[0];ji()&&!m&&(o.encodings=[s]),m&&Object.assign(m,s),Object.assign(f,o),y.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(f.encodings))),await t.setParameters(f),await QP(this.store.codec,t,F("SVC_MODE"))}async updateAdaptation(e,t){var i,r;if(!e)return y.debug("[updateAdaptation] no rtpSender found");if(!ot().supportSetRtpSenderParameters)return y.debug("[updateAdaptation] Browser not support set rtp-sender parameters");let o={},{bitrateMax:s,frameRate:a,scaleResolutionDownBy:c}=t;s&&(o.maxBitrate=1e3*s),a&&(o.maxFramerate=Mo(a)),c&&c>=1&&z(i=["vp8","vp9"]).call(i,this.store.codec)&&(o.scaleResolutionDownBy=c);let d=e.getParameters(),l=(r=d.encodings)===null||r===void 0?void 0:r[0];l&&Object.assign(l,o),Object.assign(d,{});try{await e.setParameters(d),y.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(d.encodings)))}catch(h){!("transport"in e)||e.transport&&e.transport.state==="connected"?this.peerConnectionState!=="connected"?y.debug("[updateAdaptation] peerConnection not connected}"):y.debug("[updateAdaptation] updateRtpSenderEncodings failed",h):y.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(e,t){try{if(!ot().supportSetRtpSenderParameters||e.length!==t.length)return;for(let i=0;i<e.length;i++){let r=e[i],o=t[i];o instanceof Jt&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,r.sender)}}catch{y.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,i){if(F("FORBID_MODIFY_LOCAL_OFFER_SDP"))return e;let r=Oo(e);return t.forEach((o,s)=>{let a=i[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Kd(c,o),cm(c,o,this.store.codec))}),sn(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;(t=this.onFirstAudioReceived)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;(t=this.onFirstVideoReceived)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;(t=this.onFirstAudioDecoded)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;(t=this.onFirstVideoDecodedTimeout)===null||t===void 0||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let c=0;c<e.length;c++){var i,r,o,s,a;let d=e[c],l=t[c];if(l instanceof Jt&&!z(i=l._hints).call(i,Re.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=l._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=l._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){let h={},p={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};h.encodings=[{rid:"m",active:!0,maxBitrate:p.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:p.high}];let f=d.sender.getParameters();await d.sender.setParameters(Object.assign(f,h))}}}async applySimulcastEncodings(e,t){if(!ji()&&e.length===t.length)for(let i=0;i<e.length;i++){let r=t[i];if(r instanceof Jt&&this.isVP8Simulcast(r)){let o=e[i],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];let c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s))}}}isVP8Simulcast(e){var t,i,r,o,s;return!!(e instanceof Jt&&F("SIMULCAST")&&this.store.codec==="vp8"&&!z(t=e._hints).call(t,Re.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=e._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=e._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,t,i,r){if(F("SDP_LOGGING"))return y.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(t," SDP during P2PConnection.").concat(r,`
`),e),t==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;let t=this.remoteSDP.getSSRC(e);return t&&t.length!==0?t[0].ssrcId:void 0}setConfiguration(e){if(ot().supportPCSetConfiguration){let t=NR.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}e.isPreallocation&&(this.isPreallocation=!0)}},Oe(Qt.prototype,"updateRemoteRTPCapabilities",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"updateRemoteRTPCapabilities"),Qt.prototype),Oe(Qt.prototype,"connect",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"connect"),Qt.prototype),Oe(Qt.prototype,"updateRemoteConnect",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"updateRemoteConnect"),Qt.prototype),Oe(Qt.prototype,"createDataChannels",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"createDataChannels"),Qt.prototype),Oe(Qt.prototype,"receive",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"receive"),Qt.prototype),Oe(Qt.prototype,"batchReceive",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"batchReceive"),Qt.prototype),Oe(Qt.prototype,"stopReceiving",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"stopReceiving"),Qt.prototype),Oe(Qt.prototype,"muteRemote",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"muteRemote"),Qt.prototype),Oe(Qt.prototype,"unmuteRemote",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"unmuteRemote"),Qt.prototype),Oe(Qt.prototype,"muteLocal",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"muteLocal"),Qt.prototype),Oe(Qt.prototype,"unmuteLocal",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"unmuteLocal"),Qt.prototype),Oe(Qt.prototype,"close",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"close"),Qt.prototype),Oe(Qt.prototype,"updateEncoderConfig",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"updateEncoderConfig"),Qt.prototype),Oe(Qt.prototype,"updateSendParameters",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"updateSendParameters"),Qt.prototype),Oe(Qt.prototype,"replaceTrack",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"replaceTrack"),Qt.prototype),Oe(Qt.prototype,"updateAdaptation",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"updateAdaptation"),Qt.prototype),Oe(Qt.prototype,"getRemoteSSRC",[Mr],Object.getOwnPropertyDescriptor(Qt.prototype,"getRemoteSSRC"),Qt.prototype),Qt);function Mr(n,e,t){let i=n[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return t.value=async function(){let r=this.mutex,o=await r.lock("From P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},t}function Uo(n,e){let t=document.createElement("video"),i=document.createElement("canvas");t.setAttribute("style","display:none"),i.setAttribute("style","display:none"),t.setAttribute("muted",""),t.muted=!0,t.setAttribute("autoplay",""),t.autoplay=!0,t.setAttribute("playsinline",""),i.width=Mo(e.width),i.height=Mo(e.height);let r=Mo(e.framerate||15);document.body.append(t),document.body.append(i);let o=n._mediaStreamTrack;t.srcObject=new MediaStream([o]),t.play().catch(Fd);let s=i.getContext("2d");if(!s)throw new H(L.UNEXPECTED_ERROR,"can not get canvas context");let a=ot(),c=i.captureStream(a.supportRequestFrame?0:r).getVideoTracks()[0];c.canvas||(c.canvas=i),i.startCapture=()=>{if(!t)return i.stopCapture&&i.stopCapture();if(t.paused&&t.play(),t.videoHeight>2&&t.videoWidth>2){let l=t.videoWidth,h=t.videoHeight/l,p=i.width*h;Math.abs(p-i.height)>=2&&(y.debug("adjust low stream resolution","".concat(i.width,"x").concat(i.height," -> ").concat(i.width,"x").concat(p)),i.height=p)}s.drawImage(t,0,0,i.width,i.height),c.requestFrame&&c.requestFrame(),o!==n._mediaStreamTrack&&(o=n._mediaStreamTrack,t.srcObject=new MediaStream([o]))},i.stopCapture=dT(()=>i.startCapture&&i.startCapture(),r);let d=c.stop;return c.stop=()=>{d.call(c),t&&(t.remove(),t.srcObject=null,t=null),i&&(i.width=0,i.remove(),i.stopCapture&&i.stopCapture(),i.startCapture=void 0,i.stopCapture=void 0,i=null),y.debug("clean low stream renderer")},c}var IC=function(n){return n[n.Video_Send_Type=190]="Video_Send_Type",n}(IC||{}),Gc=function(n){return n[n.Video_Send_Qp_Sum=2143]="Video_Send_Qp_Sum",n[n.Video_Send_Freeze=2082]="Video_Send_Freeze",n[n.Video_Recv_Qp_Sum=2144]="Video_Recv_Qp_Sum",n[n.Video_Recv_Freeze=2084]="Video_Recv_Freeze",n[n.Video_Render_Freeze_Time=2109]="Video_Render_Freeze_Time",n[n.Video_Render_Freeze_Time_Render=2147]="Video_Render_Freeze_Time_Render",n[n.Video_Render_Freeze_Time_Render2=2223]="Video_Render_Freeze_Time_Render2",n[n.Audio_Recv_Freeze=2083]="Audio_Recv_Freeze",n}(Gc||{}),rt=function(n){return n[n.Video_Send_Retransmit=2062]="Video_Send_Retransmit",n[n.Video_Send_Target_Encoded=2064]="Video_Send_Target_Encoded",n[n.Video_Send_Actual_Encoded=2060]="Video_Send_Actual_Encoded",n[n.Video_Send_Transmit=2066]="Video_Send_Transmit",n[n.Video_Send_Bandwidth=2061]="Video_Send_Bandwidth",n[n.Video_Capture_Height=2033]="Video_Capture_Height",n[n.Video_Capture_Width=2035]="Video_Capture_Width",n[n.Video_Capture_Frame_Rate=2034]="Video_Capture_Frame_Rate",n[n.Video_Send_Low_Height=2073]="Video_Send_Low_Height",n[n.Video_Send_Low_Frame_Rate=2075]="Video_Send_Low_Frame_Rate",n[n.Video_Send_Low_Width=2077]="Video_Send_Low_Width",n[n.Video_Send_Low_Bitrate=2069]="Video_Send_Low_Bitrate",n[n.Video_Send_Low_Package_Lost=2070]="Video_Send_Low_Package_Lost",n[n.Video_Send_Low_Package_Rate=2071]="Video_Send_Low_Package_Rate",n[n.Video_Send_Frame_Rate=2002]="Video_Send_Frame_Rate",n[n.Video_Send_Width=2003]="Video_Send_Width",n[n.Video_Send_Height=2004]="Video_Send_Height",n[n.Video_Send_Disabled=2095]="Video_Send_Disabled",n[n.Video_Send_Adaptation=2032]="Video_Send_Adaptation",n[n.Video_Send_Player_Status=2128]="Video_Send_Player_Status",n[n.Video_Send_Nacks=2009]="Video_Send_Nacks",n[n.Video_Send_Plis=2010]="Video_Send_Plis",n[n.Video_Send_Firs=2011]="Video_Send_Firs",n[n.Video_Send_Avg_Encode=2007]="Video_Send_Avg_Encode",n[n.Video_Send_Huge_Frame_Sent=2174]="Video_Send_Huge_Frame_Sent",n[n.Video_Send_Bytes_Retransmit=2173]="Video_Send_Bytes_Retransmit",n[n.Video_Send_Packages_Retransmit=2172]="Video_Send_Packages_Retransmit",n[n.Video_Send_Key_Frames_Encoded=2207]="Video_Send_Key_Frames_Encoded",n[n.Video_Send_Bitrate=2012]="Video_Send_Bitrate",n[n.Video_Send_Package_Rate=2031]="Video_Send_Package_Rate",n[n.Video_Send_Package_Lost=2005]="Video_Send_Package_Lost",n[n.Audio_Capture_PCM_Level=2104]="Audio_Capture_PCM_Level",n[n.Audio_Send_Level=2038]="Audio_Send_Level",n[n.Audio_Send_Bitrate=2039]="Audio_Send_Bitrate",n[n.Audio_Send_Package_Rate=2040]="Audio_Send_Package_Rate",n[n.Audio_Send_AEC_Return_Loss=2041]="Audio_Send_AEC_Return_Loss",n[n.Audio_Send_AEC_Return_Loss_Enhancement=2042]="Audio_Send_AEC_Return_Loss_Enhancement",n[n.Audio_Send_Freeze=2081]="Audio_Send_Freeze",n[n.Audio_Send_Disabled=2096]="Audio_Send_Disabled",n[n.Audio_Send_Bytes_Retransmit=2179]="Audio_Send_Bytes_Retransmit",n[n.Audio_Send_Packages_Retransmit=2180]="Audio_Send_Packages_Retransmit",n[n.Video_Recv_Height=2019]="Video_Recv_Height",n[n.Video_Recv_Width=2018]="Video_Recv_Width",n[n.Video_Recv_Frame_Rate_Output=2155]="Video_Recv_Frame_Rate_Output",n[n.Video_Recv_Jitter_Buffer=2023]="Video_Recv_Jitter_Buffer",n[n.Video_Recv_Current_Delay=2024]="Video_Recv_Current_Delay",n[n.Video_Recv_Nacks=2026]="Video_Recv_Nacks",n[n.Video_Recv_Plis=2027]="Video_Recv_Plis",n[n.Video_Recv_Firs=2028]="Video_Recv_Firs",n[n.Video_Recv_Disabled=2101]="Video_Recv_Disabled",n[n.Video_Recv_Player_Status=2129]="Video_Recv_Player_Status",n[n.Video_Recv_I_Frame_Delay=2149]="Video_Recv_I_Frame_Delay",n[n.Video_Render_Frame_Rate_Render=2022]="Video_Render_Frame_Rate_Render",n[n.Video_Render_Freeze_Duration=2156]="Video_Render_Freeze_Duration",n[n.Audio_Render_Level=2043]="Audio_Render_Level",n[n.Audio_Render_Freeze_Time_80ms=2226]="Audio_Render_Freeze_Time_80ms",n[n.Audio_Render_Freeze_Time_200ms=2227]="Audio_Render_Freeze_Time_200ms",n[n.Audio_Render_Freeze_Samples_80ms=2228]="Audio_Render_Freeze_Samples_80ms",n[n.Audio_Render_Freeze_Samples_200ms=2229]="Audio_Render_Freeze_Samples_200ms",n[n.Audio_Recv_PCM_Level=2105]="Audio_Recv_PCM_Level",n[n.Audio_Recv_Disabled=2102]="Audio_Recv_Disabled",n[n.Audio_Recv_Jitter_Buffer=2054]="Audio_Recv_Jitter_Buffer",n[n.Audio_Recv_Current_Delay=2047]="Audio_Recv_Current_Delay",n[n.Audio_Recv_Player_Status=2130]="Audio_Recv_Player_Status",n[n.Audio_Recv_Bitrate=2044]="Audio_Recv_Bitrate",n[n.Audio_Recv_Concealed_Samples=2148]="Audio_Recv_Concealed_Samples",n[n.Audio_Recv_Total_Samples_Received=2224]="Audio_Recv_Total_Samples_Received",n}(rt||{}),He=function(n){return n[n.Video_Render_Frame_Rate_Decode=2021]="Video_Render_Frame_Rate_Decode",n[n.Video_Recv_Frame_Rate=2020]="Video_Recv_Frame_Rate",n[n.Video_Recv_Frame_Dropped=2181]="Video_Recv_Frame_Dropped",n[n.Video_Recv_Bytes_Retransmit=2175]="Video_Recv_Bytes_Retransmit",n[n.Video_Recv_Packages_Retransmit=2176]="Video_Recv_Packages_Retransmit",n[n.Video_Recv_Packages_Discarded=2198]="Video_Recv_Packages_Discarded",n[n.Video_Recv_Avg_Decode=2200]="Video_Recv_Avg_Decode",n[n.Video_Recv_Avg_Processing_Delay=2202]="Video_Recv_Avg_Processing_Delay",n[n.Video_Recv_Avg_Assembly_Time=2203]="Video_Recv_Avg_Assembly_Time",n[n.Video_Recv_Avg_Inter_Frame_Delay=2204]="Video_Recv_Avg_Inter_Frame_Delay",n[n.Video_Recv_Key_Frames_Decoded=2206]="Video_Recv_Key_Frames_Decoded",n[n.Video_Recv_Package_Lost=2014]="Video_Recv_Package_Lost",n[n.Video_Recv_Bitrate=2029]="Video_Recv_Bitrate",n[n.Video_Recv_Package_Rate=2078]="Video_Recv_Package_Rate",n[n.Audio_Recv_Jitter=2055]="Audio_Recv_Jitter",n[n.Audio_Recv_Bytes_Retransmit=2178]="Audio_Recv_Bytes_Retransmit",n[n.Audio_Recv_Packages_Retransmit=2177]="Audio_Recv_Packages_Retransmit",n[n.Audio_Recv_Packages_Discarded=2199]="Audio_Recv_Packages_Discarded",n[n.Audio_Recv_Avg_Processing_Delay=2201]="Audio_Recv_Avg_Processing_Delay",n[n.Audio_Recv_Package_Rate=2046]="Audio_Recv_Package_Rate",n[n.Audio_Recv_Package_Lost=2045]="Audio_Recv_Package_Lost",n[n.Audio_Recv_AV_Sync_TIME=2237]="Audio_Recv_AV_Sync_TIME",n}(He||{}),Ti=function(n){return n[n.RTT=2006]="RTT",n[n.CONN_TYPE=801]="CONN_TYPE",n[n.STATS_UPDATE_INTERVAL=2205]="STATS_UPDATE_INTERVAL",n}(Ti||{}),Jr=function(n){return n[n.RTC_PEER_CONNECTION_STATE=2219]="RTC_PEER_CONNECTION_STATE",n[n.PAGE_VISIBILITY=2233]="PAGE_VISIBILITY",n}(Jr||{}),Hh=function(n){return n[n.Transport_Send_Bitrate=2234]="Transport_Send_Bitrate",n[n.Transport_Recv_Bitrate=2235]="Transport_Recv_Bitrate",n}(Hh||{});let Wu=1e3,Ll=6,Kh=3,zT=Math.max(Ll,Kh,60);function Ze(n,e,t){t!=null&&Number.isFinite(t)&&(n[e]=Math.round(Math.max(0,t)))}function Qe(n){let e={[Ti.CONN_TYPE]:0,[Ti.RTT]:n.rtt,[Ti.STATS_UPDATE_INTERVAL]:n.updateInterval?Math.round(Math.max(0,n.updateInterval)):void 0};switch(n.selectedCandidatePair.localCandidate.candidateType){case"relay":{let t=n.selectedCandidatePair.localCandidate.relayProtocol;t==="udp"&&(e[Ti.CONN_TYPE]=1),t==="tcp"&&(e[Ti.CONN_TYPE]=3),t==="tls"&&(e[Ti.CONN_TYPE]=4);break}case"srflx":e[Ti.CONN_TYPE]=2;break;case"unknown":e[Ti.CONN_TYPE]=5;break;default:e[Ti.CONN_TYPE]=0}return e}function SL(n){let e=0;switch(n){case"none":e=0;break;case"cpu":e=1;break;case"bandwidth":e=2;break;case"other":e=3}return e}class TL extends Ki{constructor(e){super(),U(this,"store",void 0),U(this,"uploadWRTCStatsTimer",void 0),U(this,"uploadOutboundDenoiserStatsTimer",void 0),U(this,"uploadExtStatsTimer",void 0),U(this,"uploadExtUsageStatsTimer",void 0),U(this,"uploadInboundExtStatsTimer",void 0),U(this,"requestStats",void 0),U(this,"requestTransportStats",void 0),U(this,"requestLocalMedia",void 0),U(this,"requestRemoteMedia",void 0),U(this,"requestAllTracks",void 0),U(this,"requestVideoIsReady",void 0),U(this,"requestUploadStats",void 0),U(this,"requestUpload",void 0),U(this,"uploadOutboundStarted",!1),U(this,"uploadInboundStarted",!1),U(this,"uploadTransportStarted",!1),U(this,"uploadBaseStatsStarted",!1),U(this,"uploadExtensionUsageStarted",!1),U(this,"lastRecvStats",void 0),U(this,"lastSendStats",void 0),U(this,"lastRefRecvStats",void 0),U(this,"lastRefSendStats",void 0),U(this,"lastNormalRecvStats",void 0),U(this,"lastNormalSendStats",void 0),U(this,"lastExtendStats",{}),U(this,"needUploadStats",{}),U(this,"needUploadRenderFreezeTime",!0),U(this,"lastUploadCompensateTime",-1),U(this,"uploadCompensateDeltaTime",0),this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;let t=e%Kh==0,i=e%Ll==0,r=e%60==0,o,s;if(this.uploadTransportStarted&&(o=this.requestStats(),this.store.useP2P&&(s=this.requestStats(!0))),!o&&this.uploadOutboundStarted&&(o=this.requestStats()),!s&&this.uploadInboundStarted&&(s=this.requestStats(!0)),o||s){var a;let c={};if(this.uploadTransportStarted&&o){let l=this.getTransportStats(o,t?this.lastRefSendStats:void 0,s,t);l&&(c.misc=[l])}if(this.uploadOutboundStarted&&o){let l=this.getOutboundStats(o,i?this.lastNormalSendStats:void 0,t?this.lastRefSendStats:void 0,this.lastSendStats,r);l&&(c.outbound=[l])}if(this.uploadInboundStarted&&s){this.uploadCompensateStats(e);let l=this.getInboundStats(s,i?this.lastNormalRecvStats:void 0,t?this.lastRefRecvStats:void 0,this.lastRecvStats);l&&(c.inbound=l)}let d=(a=this.requestTransportStats)===null||a===void 0?void 0:a.call(this).connectState;if(d&&(Array.isArray(c.misc)?c.misc[0]&&c.misc[0].addition&&(c.misc[0].addition[Jr.RTC_PEER_CONNECTION_STATE]=Vf[d]):c.misc=[{addition:{[Jr.RTC_PEER_CONNECTION_STATE]:Vf[d]}}]),Eo.needUploadStats.length>0||i){let l=Eo.needUploadStats.shift()||(Eo.visibility==="visible"?1:0);Array.isArray(c.misc)?c.misc[0]&&c.misc[0].addition&&(c.misc[0].addition[Jr.PAGE_VISIBILITY]=l):c.misc=[{addition:{[Jr.PAGE_VISIBILITY]:l}}]}this.needUploadStats.sendType&&(Array.isArray(c.outbound)&&c.outbound[0]&&c.outbound[0].high&&(c.outbound[0].high[IC.Video_Send_Type]=this.needUploadStats.sendType),this.needUploadStats.sendType=void 0),this.requestUploadStats(c)}this.lastRecvStats=s,this.lastSendStats=o,i&&(this.lastNormalRecvStats=s,this.lastNormalSendStats=o),t&&(this.lastRefRecvStats=s,this.lastRefSendStats=o)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;this.uploadBaseStatsStarted=!0,Eo.startCollectStats();let e=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted){if(this.uploadBaseStatsStarted){var t,i;let r=(t=this.requestTransportStats)===null||t===void 0?void 0:t.call(this);return void(r&&((i=this.requestUploadStats)===null||i===void 0||i.call(this,{misc:[{addition:{[Jr.RTC_PEER_CONNECTION_STATE]:Vf[r.connectState]}}]})))}return this.stopUploadWRTCStats()}this.uploadWRTCStats(e),++e===zT+1&&(e=1)},Wu)}uploadCompensateStats(e){if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;let t=e%Kh==0&&this.needUploadRenderFreezeTime;if(!this.uploadInboundStarted||!t)return;if(this.lastUploadCompensateTime===-1)return void(this.lastUploadCompensateTime=Date.now());let i=Math.max(-6e3,Date.now()-this.lastUploadCompensateTime-6e3);if(this.uploadCompensateDeltaTime+=i,this.lastUploadCompensateTime=Date.now(),this.uploadCompensateDeltaTime<6e3)return;let r=Math.min(Math.floor(this.uploadCompensateDeltaTime/6e3),10);this.uploadCompensateDeltaTime-=6e3*r;let o=this.requestStats(!0);new Array(r).fill(0).forEach(()=>{if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;let s={};if(this.uploadInboundStarted&&o){let a=this.requestRemoteMedia()||[],c=[];a.forEach(d=>{let[l,h]=d,p={peer:l.uid};if(l._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(l._videoSSRC)&&h.has(ke.VIDEO)&&l.videoTrack){let f=function(m,g,S){if(!g.videoRecv.find(C=>C.ssrc===m))return;let T={};if(S&&S._player){let C=S._player,{renderFreezeAccTime2:b,videoElementStatus:D}=C;if(Eo.visibility==="visible"&&D===tn.PLAYING&&ot().supportRequestVideoFrameCallback){let x=Math.min(6e3,b);C.renderFreezeAccTime2=Math.max(0,b-x),Ze(T,Gc.Video_Render_Freeze_Time_Render2,x),F("USE_NEW_RENDER_FREEZE_TIME")&&Ze(T,Gc.Video_Render_Freeze_Time_Render,x)}}return T}(l._videoSSRC,o,l.videoTrack);f&&(p.video=f)}p.video&&c.push(p)}),c.length>0&&(s.inbound=c,this.requestUploadStats(s))}})}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0}getTransportStats(e,t,i,r){if(!this.requestStats)return;if(!r)return e.rtt==null?void 0:{addition:{[Ti.RTT]:e.rtt,[Ti.CONN_TYPE]:void 0,[Ti.STATS_UPDATE_INTERVAL]:e.updateInterval||void 0}};let o=Qe(e);if(this.store.useP2P){if(i){let s=Qe(i);o[Ti.CONN_TYPE]&&s[Ti.CONN_TYPE]&&(o[Ti.CONN_TYPE]+=s[Ti.CONN_TYPE]<<3)}o[Ti.CONN_TYPE]?o[Ti.CONN_TYPE]+=110:o[Ti.CONN_TYPE]=110}else{o[Ti.CONN_TYPE]?o[Ti.CONN_TYPE]+=100:o[Ti.CONN_TYPE]=100;let s=function(a,c){return c?[Math.ceil(8*(a.transport.bytesSent-c.transport.bytesSent)/(a.timestamp-c.timestamp)),Math.ceil(8*(a.transport.bytesReceived-c.transport.bytesReceived)/(a.timestamp-c.timestamp))]:[0,0]}(e,t);o[Hh.Transport_Send_Bitrate]=s[0],o[Hh.Transport_Recv_Bitrate]=s[1]}return{addition:o}}getOutboundStats(e,t,i,r,o){if(!this.requestUploadStats||!this.requestLocalMedia)return;let s=this.requestLocalMedia();if(!s||s.length===0)return;let a,c,d;return s.forEach(l=>{let[h,{track:p,ssrcs:f}]=l;switch(h){case Se.LocalVideoLowTrack:case Se.LocalVideoTrack:if(h===Se.LocalVideoTrack){var m;let g=function(b,D,x,k,V,W){let K=D.videoSend.find(Ce=>Ce.ssrc===b);if(!K)return;let J={},{sentFrame:se,inputFrame:Ne}=K;if(k&&(Ze(J,Gc.Video_Send_Qp_Sum,K.qpSumPerFrame),Ne&&se)){let Ce=Ne.frameRate,De=se.frameRate;J[Gc.Video_Send_Freeze]=function(Me,et){let ae=!0;return ae=!(Me<=5)&&(Me<=10?et<3:Me<=20?et<4:et<5),ae}(Ce,De)?1:0}if(V){switch(se&&(Ze(J,rt.Video_Send_Height,se.height),Ze(J,rt.Video_Send_Width,se.width),Ze(J,rt.Video_Send_Frame_Rate,se.frameRate)),J[rt.Video_Send_Disabled]=x._originMediaStreamTrack&&!x._originMediaStreamTrack.enabled||x._mediaStreamTrack&&!x._mediaStreamTrack.enabled?1:0,K.adaptionChangeReason){case"none":J[rt.Video_Send_Adaptation]=0;break;case"cpu":J[rt.Video_Send_Adaptation]=1;break;case"bandwidth":J[rt.Video_Send_Adaptation]=2;break;case"other":J[rt.Video_Send_Adaptation]=3}let Ce=0;K.adaptionChangeReason&&(Ce+=SL(K.adaptionChangeReason)),D.qualityLimitationReason&&(Ce+=SL(D.qualityLimitationReason)<<3),J[rt.Video_Send_Adaptation]=Ce,J[rt.Video_Send_Player_Status]=Dc[x._player?x._player.videoElementStatus:"uninit"],Ze(J,rt.Video_Send_Nacks,K.nacksCount),Ze(J,rt.Video_Send_Plis,K.plisCount),Ze(J,rt.Video_Send_Firs,K.firsCount),Ze(J,rt.Video_Send_Avg_Encode,K.avgEncodeMs),Ze(J,rt.Video_Send_Huge_Frame_Sent,K.hugeFramesSent),Ze(J,rt.Video_Send_Bytes_Retransmit,K.retransmittedBytesSent),Ze(J,rt.Video_Send_Packages_Retransmit,K.retransmittedPacketsSent),Ze(J,rt.Video_Send_Key_Frames_Encoded,K.keyFramesEncoded);let De=V.videoSend.find(Me=>Me.ssrc===b);if(De){let Me=Wu*Kh;De.timestamp&&K.timestamp&&(Me=K.timestamp-De.timestamp),De.packets!=null&&K.packets!=null&&Ze(J,rt.Video_Send_Package_Rate,1e3*(K.packets-De.packets)/Me),K.packetsLost!=null&&De.packetsLost!=null&&Ze(J,rt.Video_Send_Package_Lost,K.packetsLost-De.packetsLost),De.bytes!=null&&K.bytes!=null&&Ze(J,rt.Video_Send_Bitrate,8*(K.bytes-De.bytes)/Me)}}return J}(f[0].ssrcId,e,p,t,i),S=p.__className__==="CameraVideoTrack"?3:z(m=p._hints).call(m,Re.SCREEN_TRACK)?7:10;(this.lastExtendStats.sendType!==S||o)&&(this.needUploadStats={sendType:S},this.lastExtendStats.sendType=S);let T=p&&function(b,D,x,k){let V=D.videoSend.find(K=>K.ssrc===b);if(!V)return null;let W={};if(k){let K=V.inputFrame,J=K&&K.height||x.videoHeight||0,se=K&&K.width||x.videoWidth||0,Ne=K&&K.frameRate||0;Ze(W,rt.Video_Capture_Height,J),Ze(W,rt.Video_Capture_Width,se),Ze(W,rt.Video_Capture_Frame_Rate,Ne)}return W}(f[0].ssrcId,e,p,!!i),C=function(b,D){let x={};return D&&(Ze(x,rt.Video_Send_Retransmit,b.bitrate.retransmit),Ze(x,rt.Video_Send_Target_Encoded,b.bitrate.targetEncoded),Ze(x,rt.Video_Send_Actual_Encoded,b.bitrate.actualEncoded),Ze(x,rt.Video_Send_Transmit,b.bitrate.transmit),Ze(x,rt.Video_Send_Bandwidth,b.sendBandwidth)),x}(e,!!i);c=Object.assign({},g,T,C)}else d=function(g,S,T,C,b){let D=S.videoSend.find(k=>k.ssrc===g);if(!D)return;let x={};if(C){let k=D.sentFrame;k&&(Ze(x,rt.Video_Send_Low_Height,k.height),Ze(x,rt.Video_Send_Low_Width,k.width),Ze(x,rt.Video_Send_Low_Frame_Rate,k.frameRate));let V=C.videoSend.find(W=>W.ssrc===g);if(V){let W=Wu*Ll;V.timestamp&&D.timestamp&&(W=D.timestamp-V.timestamp),V.packets!=null&&D.packets!=null&&Ze(x,rt.Video_Send_Low_Package_Rate,1e3*(D.packets-V.packets)/W),D.packetsLost!=null&&V.packetsLost!=null&&Ze(x,rt.Video_Send_Low_Package_Lost,D.packetsLost-V.packetsLost),V.bytes!=null&&D.bytes!=null&&Ze(x,rt.Video_Send_Low_Bitrate,8*(D.bytes-V.bytes)/W)}}return x}(f[0].ssrcId,e,0,i);break;case Se.LocalAudioTrack:a=p&&function(g,S,T,C,b,D){let x=S.audioSend.find(V=>V.ssrc===g);if(!x)return;let k={};if(b){k[rt.Audio_Send_Disabled]=T._originMediaStreamTrack&&!T._originMediaStreamTrack.enabled||T._mediaStreamTrack&&!T._mediaStreamTrack.enabled?1:0;let V=100*T._source.getAccurateVolumeLevel(),W=x.inputLevel;if(W!=null){let J=Math.ceil(50*Math.log10(100*W+1));Ze(k,rt.Audio_Send_Level,J)}Ze(k,rt.Audio_Capture_PCM_Level,V),Ze(k,rt.Audio_Send_AEC_Return_Loss,x.aecReturnLoss),Ze(k,rt.Audio_Send_AEC_Return_Loss_Enhancement,x.aecReturnLossEnhancement),Ze(k,rt.Audio_Send_Bytes_Retransmit,x.retransmittedBytesSent),Ze(k,rt.Audio_Send_Packages_Retransmit,x.retransmittedPacketsSent),k[rt.Audio_Send_Freeze]=0;let K=b.audioSend.find(J=>J.ssrc===g);if(K){let J=Wu*Ll;K.timestamp&&x.timestamp&&(J=x.timestamp-K.timestamp),K.bytes!=null&&x.bytes!=null&&Ze(k,rt.Audio_Send_Bitrate,8*(x.bytes-K.bytes)/J),K.packets!=null&&x.packets!=null&&Ze(k,rt.Audio_Send_Package_Rate,1e3*(x.packets-K.packets)/J)}}return k}(f[0].ssrcId,e,p,0,i)}}),{high:c,low:d,audio:a}}getInboundStats(e,t,i,r){if(!this.requestRemoteMedia)return;let o=this.requestRemoteMedia()||[],s=[];return o.forEach(a=>{let[c,d]=a,l={peer:c.uid},h;if(d.has(ke.VIDEO)&&c.videoTrack){let p=c._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(c._videoSSRC)||!1,f=c.videoTrack?function(m,g,S,T,C,b,D,x){let k=g.videoRecv.find(De=>De.ssrc===m);if(!k)return;let V={},{receivedFrame:W,outputFrame:K,decodeFrameRate:J}=k;Ze(V,He.Video_Render_Frame_Rate_Decode,J),k.framesRateFirefox&&Ze(V,He.Video_Recv_Frame_Rate,k.framesRateFirefox),W&&Ze(V,He.Video_Recv_Frame_Rate,W.frameRate),Ze(V,He.Video_Recv_Frame_Dropped,k.framesDroppedCount),Ze(V,He.Video_Recv_Bytes_Retransmit,k.retransmittedBytesReceived),Ze(V,He.Video_Recv_Packages_Retransmit,k.retransmittedPacketsReceived),Ze(V,He.Video_Recv_Packages_Discarded,k.packetsDiscarded),Ze(V,He.Video_Recv_Avg_Decode,k.avgDecodeMs),Ze(V,He.Video_Recv_Avg_Processing_Delay,k.avgProcessingDelayMs),Ze(V,He.Video_Recv_Avg_Assembly_Time,k.avgFramesAssembledFromMultiplePacketsMs),Ze(V,He.Video_Recv_Avg_Inter_Frame_Delay,k.avgInterFrameDelayMs),Ze(V,He.Video_Recv_Key_Frames_Decoded,k.keyFramesDecoded);let se=x&&x.videoRecv.find(De=>De.ssrc===m);if(se){let De=g.timestamp-x.timestamp||Wu;k.packetsLost!=null&&se.packetsLost!=null&&Ze(V,He.Video_Recv_Package_Lost,k.packetsLost-se.packetsLost),se.bytes!=null&&k.bytes!=null&&Ze(V,He.Video_Recv_Bitrate,8*(k.bytes-se.bytes)/De),se.packets!=null&&k.packets!=null&&Ze(V,He.Video_Recv_Package_Rate,1e3*(k.packets-se.packets)/De)}let Ne=b&&b.videoRecv.find(De=>De.ssrc===m);if(Ne&&(Ze(V,Gc.Video_Recv_Qp_Sum,k.qpSumPerFrame),V[Gc.Video_Recv_Freeze]=T&&Xd.isRemoteVideoFreeze(S,k,Ne)?1:0),D){var Ce;let De=D.videoRecv.find(et=>et.ssrc===m);W?(Ze(V,rt.Video_Recv_Height,W.height),Ze(V,rt.Video_Recv_Width,W.width)):S&&(Ze(V,rt.Video_Recv_Height,S._videoHeight||0),Ze(V,rt.Video_Recv_Width,S._videoWidth||0)),K&&Ze(V,rt.Video_Recv_Frame_Rate_Output,K.frameRate);let Me=(Ce=S._player)===null||Ce===void 0?void 0:Ce.rendFrameRate.toFixed(0);if(Me&&Ze(V,rt.Video_Render_Frame_Rate_Render,+Me),Ze(V,rt.Video_Recv_Jitter_Buffer,k.jitterBufferMs),Ze(V,rt.Video_Recv_Current_Delay,k.currentDelayMs),Ze(V,rt.Video_Recv_Firs,k.firsCount),Ze(V,rt.Video_Recv_Nacks,k.nacksCount),Ze(V,rt.Video_Recv_Plis,k.plisCount),S){V[rt.Video_Recv_Disabled]=S._originMediaStreamTrack.enabled&&S._mediaStreamTrack.enabled?0:1;let et=S._player;if(et){let{freezeTimeCounterList:ae,renderFreezeAccTime:Y,renderFreezeAccTime2:ie,videoElementStatus:Q}=et;if(ae&&ae.length>0&&Ze(V,Gc.Video_Render_Freeze_Time,ae.splice(0,1)[0]),C&&Eo.visibility==="visible"&&Q===tn.PLAYING&&ot().supportRequestVideoFrameCallback){let w=Math.min(6e3,ie);et.renderFreezeAccTime2=Math.max(0,ie-w),Ze(V,Gc.Video_Render_Freeze_Time_Render2,w);let v=Math.min(6e3,Y);et.renderFreezeAccTime=Math.max(0,Y-v),Ze(V,Gc.Video_Render_Freeze_Time_Render,F("USE_NEW_RENDER_FREEZE_TIME")?w:v)}if(typeof k.totalFreezesDuration=="number"){let w=De&&De.totalFreezesDuration?k.totalFreezesDuration-De.totalFreezesDuration:k.totalFreezesDuration;Ze(V,rt.Video_Render_Freeze_Duration,1e3*w)}}}if(V[rt.Video_Recv_Player_Status]=Dc[S._player?S._player.videoElementStatus:"uninit"],De&&k.totalInterFrameDelay!==void 0&&k.totalSquaredInterFrameDelay!==void 0&&De.totalInterFrameDelay!==void 0&&De.totalSquaredInterFrameDelay!==void 0){let et=k.totalInterFrameDelay-De.totalInterFrameDelay,ae=k.totalSquaredInterFrameDelay-De.totalSquaredInterFrameDelay,Y=k.framesDecodeCount-De.framesDecodeCount,ie=et/Y*1e3,Q=Math.round(1e3*Math.sqrt((ae-Math.pow(et,2)/Y)/Y));!isNaN(Q)&&ie+Q>Math.max(3*ie,ie+150)&&(V[rt.Video_Recv_I_Frame_Delay]=Q)}}return V}(c._videoSSRC,e,c.videoTrack,p===!0,this.needUploadRenderFreezeTime,t,i,r):void 0;if(f&&(l.video=f),c.videoTrack){let m=e.videoRecv.find(g=>g.ssrc===c._videoSSRC);m&&m.estimatedPlayoutTimestamp&&(h=m.estimatedPlayoutTimestamp)}}if(d.has(ke.AUDIO)&&c.audioTrack){let p=c.audioTrack?function(f,m,g,S,T,C){let b=m.audioRecv.find(V=>V.ssrc===f);if(!b)return;let D={};Ze(D,He.Audio_Recv_Jitter,b.jitterMs),Ze(D,He.Audio_Recv_Bytes_Retransmit,b.retransmittedBytesReceived),Ze(D,He.Audio_Recv_Packages_Retransmit,b.retransmittedPacketsReceived),Ze(D,He.Audio_Recv_Packages_Discarded,b.packetsDiscarded),Ze(D,He.Audio_Recv_Avg_Processing_Delay,b.avgProcessingDelayMs);let x=C&&C.audioRecv.find(V=>V.ssrc===f);if(x){let V=Wu;b.packets!=null&&x.packets!=null&&Ze(D,He.Audio_Recv_Package_Rate,1e3*(b.packets-x.packets)/V),b.packetsLost!=null&&x.packetsLost!=null&&Ze(D,He.Audio_Recv_Package_Lost,b.packetsLost-x.packetsLost)}if(S){let{receivedFrames:V,droppedFrames:W}=b;V!=null&&W!=null&&(D[Gc.Audio_Recv_Freeze]=(k=V)===0||100*W/k>20?1:0)}var k;if(T){let V=100*g._source.getAccurateVolumeLevel(),W=b.outputLevel;if(W!=null){let J=Math.ceil(50*Math.log10(100*W+1));Ze(D,rt.Audio_Render_Level,J)}Ze(D,rt.Audio_Recv_PCM_Level,V),g&&(D[rt.Audio_Recv_Disabled]=g._originMediaStreamTrack.enabled&&g._mediaStreamTrack.enabled?0:1),Ze(D,rt.Audio_Recv_Jitter_Buffer,b.jitterBufferMs),Ze(D,rt.Audio_Recv_Current_Delay,b.jitterBufferMs),D[rt.Audio_Recv_Player_Status]=Dc[ko.getPlayerState(g.getTrackId())];let K=T.audioRecv.find(J=>J.ssrc===f);if(K){K.bytes!=null&&b.bytes!=null&&Ze(D,rt.Audio_Recv_Bitrate,8*(b.bytes-K.bytes)/(Wu*Kh));let J=b.concealedSamples-K.concealedSamples;J>0&&Ze(D,rt.Audio_Recv_Concealed_Samples,J);let se=b.totalSamplesReceived-K.totalSamplesReceived;se>0&&Ze(D,rt.Audio_Recv_Total_Samples_Received,se);let Ne=b.freezeSamples80-K.freezeSamples80;Ne>0&&Ze(D,rt.Audio_Render_Freeze_Samples_80ms,Ne);let Ce=b.freezeSamples200-K.freezeSamples200;Ce>0&&Ze(D,rt.Audio_Render_Freeze_Samples_200ms,Ce);let De=b.freezeMs80-K.freezeMs80;Ze(D,rt.Audio_Render_Freeze_Time_80ms,De<0?0:De);let Me=b.freezeMs200-K.freezeMs200;Ze(D,rt.Audio_Render_Freeze_Time_200ms,Me<0?0:Me)}}return D}(c._audioSSRC,e,c.audioTrack,t,i,r):void 0;if(p&&(l.audio=p),c.audioTrack&&h){let f=e.audioRecv.find(m=>m.ssrc===c._audioSSRC);if(f&&f.estimatedPlayoutTimestamp){let m=f.estimatedPlayoutTimestamp-h;l.audio?l.audio[He.Audio_Recv_AV_Sync_TIME]=m:l.audio={[He.Audio_Recv_AV_Sync_TIME]:m}}}}(l.video||l.audio)&&s.push(l)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,s}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;let e=(this.requestAllTracks()||[]).find(t=>t instanceof Zi);if(e&&e._external.getDenoiserStats){let t=e._external.getDenoiserStats();t&&this.requestUpload(Be.DENOISER_STATS,t)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(e=>{e.getProcessorStats().forEach(t=>{this.requestUpload&&this.requestUpload(t.type,t.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0,this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(e=>{let[t,i]=e;i.has(ke.VIDEO)&&t.videoTrack&&t.videoTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)}),i.has(ke.AUDIO)&&t.audioTrack&&t.audioTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0,this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=void 0)}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);let e=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{let t=Date.now(),i={connectionInterval:F("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:t},r=[],o=this.requestAllTracks&&this.requestAllTracks()||[];for(let d of o)!d.muted&&d.enabled&&(r=r.concat(await d.getProcessorUsage()));let s=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(let[d,l]of s)l.has(ke.VIDEO)&&d.videoTrack&&(r=r.concat(await d.videoTrack.getProcessorUsage())),l.has(ke.AUDIO)&&d.audioTrack&&(r=r.concat(await d.audioTrack.getProcessorUsage()));if(r.length===0)return;i.details=function(d,l){let h={};for(let{id:g,value:S,level:T,direction:C}of d){var p;let b=(p=l.get(g))!==null&&p!==void 0?p:0,D=S===2?b+F("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:b;var f,m;l.set(g,D),h[g]?(S===2&&(h[g].value=S),T>h[g].level&&(h[g].level=T),C==="remote"&&(h[g].remoteUidCount+=1),h[g].totalTs=(f=l.get(g))!==null&&f!==void 0?f:0):h[g]={value:S,level:T,remoteUidCount:C==="local"?0:1,totalTs:(m=l.get(g))!==null&&m!==void 0?m:0}}return Object.keys(h).map(g=>{let{level:S,value:T,totalTs:C}=h[g];return{id:g,level:S,value:T,totalTs:C}})}(r,e);let a=Date.now(),c=a>t?a:t+1;this.requestUpload&&this.requestUpload(Be.EXTENSION_USAGE_STATS,{usageStats:i,sendTs:c})},F("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}stopUploadBaseStats(){this.uploadBaseStatsStarted=!1,Eo.stopCollectStats()}}let c2=F("ICE_RESTART_INTERVAL"),AC=new Map,Hu=new Map,dc=[be.UDP_TCP_RELAY,be.TCP_RELAY,be.RELAY],kl=F("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&ot().supportPCSetConfiguration;function wC(n){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],t=AC.get(n.id);t&&(window.clearTimeout(t),AC.delete(n.id));let i=Hu.get(n.id);e&&i&&i.index===dc.length-1&&(y.debug("[".concat(n.id,"] reset ICE restart policy")),Hu.delete(n.id))}function RL(n,e,t){if(AC.size===0&&Hu.size===0&&(Array.isArray(F("RESTART_SEQUENCE"))&&F("RESTART_SEQUENCE").length>0&&!function(a,c){if(a.length!==c.length)return!1;for(let d=0;d<a.length;d+=1){let l=a[d];if(a.filter(h=>h===l).length!==c.filter(h=>h===l).length)return!1}return!0}(dc,F("RESTART_SEQUENCE"))&&(dc=F("RESTART_SEQUENCE").filter(a=>{var c;if(z(c=Object.values(be)).call(c,a))return!0}),y.debug("use reconnection policy from config distribution, queues: ".concat(dc.join(" => ")))),kl=F("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&ot().supportPCSetConfiguration),dc.length===0)return void t();let i,{index:r=0,type:o}=Hu.get(n.id)||{};if(kl&&o===be.RELAY)return void t();let s=o&&r>=dc.length-1;if(kl)o=be.RELAY;else{if(s)return void t();o?(r++,o=dc[r]):(o=dc[0],r=0)}y.debug("[".concat(n.id,"] choose ICE restart policy: ").concat(o,", index: ").concat(r)),e(o),Hu.set(n.id,{index:r,type:o}),i=window.setTimeout(()=>RL(n,e,t),c2),AC.set(n.id,i)}var Vt;function Ft(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function Jd(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ft(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):Ft(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}function Qd(n){var e,t,i,r=2;for(typeof Symbol<"u"&&(t=vu,i=Symbol.iterator);r--;){if(t&&(e=n[t])!=null)return e.call(n);if(i&&(e=n[i])!=null)return new qT(e.call(n));t="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function qT(n){function e(t){if(Object(t)!==t)return Z.reject(new TypeError(t+" is not an object."));var i=t.done;return Z.resolve(t.value).then(function(r){return{value:r,done:i}})}return qT=function(t){this.s=t,this.n=t.next},qT.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(t){var i=this.s.return;return i===void 0?Z.resolve({value:t,done:!0}):e(i.apply(this.s,arguments))},throw:function(t){var i=this.s.return;return i===void 0?Z.reject(t):e(i.apply(this.s,arguments))}},new qT(n)}let Ml=(Vt=class extends Ki{get state(){return this._state}set state(n){let e=this._state;this._state=n,this.emit(we.StateChange,e,this._state)}constructor(n,e){super(),U(this,"isPlanB",void 0),U(this,"store",void 0),U(this,"statsUploader",void 0),U(this,"connection",void 0),U(this,"localTrackMap",new Map),U(this,"remoteUserMap",new Map),U(this,"localDataChannels",[]),U(this,"remoteDataChannelMap",new Map),U(this,"pendingLocalTracks",[]),U(this,"pendingRemoteTracks",[]),U(this,"pendingLocalDataChannels",[]),U(this,"pendingRemoteDataChannels",[]),U(this,"statsCollector",void 0),U(this,"shouldForwardP2PCreation",void 0),U(this,"iceFailedCount",0),U(this,"dtlsFailedCount",0),U(this,"mutex",void 0),U(this,"_state",ue.Disconnected),U(this,"_pcStatsUploadType",F("NEW_ICE_RESTART")?Ir.FIRST_CONNECTION:Ir.OLD_FIRST_CONNECTION),U(this,"_isStartRestartIce",!1),U(this,"_restartTimer",void 0),U(this,"_isTryConnecting",!1),U(this,"_iceError",null),U(this,"_forceTurn",!1),U(this,"_isWaitPcToRePub",!1),U(this,"handleMuteLocalTrack",async(t,i,r)=>{let o=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==ue.Connected)return void r(new O(L.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));let s=this.filterTobeMutedTracks(t);if(s.length===0)return void i();let a=s.find(d=>d[0]==="videoLowTrack");if(a){let d=a[1];this.store.enableInstantMuteRestore?(d.track._originMediaStreamTrack.enabled=!1,y.info("[".concat(this.store.clientId,"] P2PChannel muteLocalLowTrack without close sender because enableInstantMuteRestore is true"))):d.track._originMediaStreamTrack.stop()}this.store.enableInstantMuteRestore?y.info("[".concat(this.store.clientId,"] P2PChannel muteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.muteLocal(s.map(d=>{let[,{id:l}]=d;return l}));let c=this.createMuteMessage(s);await yt(this,we.RequestMuteLocal,c),i()}catch(s){r(s)}finally{o()}}),U(this,"handleUnmuteLocalTrack",async(t,i,r)=>{let o=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==ue.Connected)return void r(new O(L.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));let s=this.filterTobeUnmutedTracks(t);if(s.length===0)return void i();let a=s.find(d=>d[0]==="videoLowTrack");if(a){let d=a[1];if(this.store.enableInstantMuteRestore)d.track._originMediaStreamTrack.enabled=!0,y.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalLowTrack without close sender because enableInstantMuteRestore is true"));else{if(d.track._originMediaStreamTrack.stop(),!F("DISABLE_DUAL_STREAM_USE_ENCODING")&&ot().supportDualStreamEncoding){let l=t._mediaStreamTrack.clone();d.track._mediaStreamTrack=l,d.track._originMediaStreamTrack=l}else{let l=Uo(t,co(this,we.RequestLowStreamParameter));d.track._mediaStreamTrack=l,d.track._originMediaStreamTrack=l}await new Z((l,h)=>{this.handleReplaceTrack(d.track,l,h,!0)})}}this.store.enableInstantMuteRestore?y.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.unmuteLocal(s.map(d=>{let[,{id:l}]=d;return l}));let c=this.createUnmuteMessage(s);await yt(this,we.RequestUnmuteLocal,c),i()}catch(s){r(s)}finally{o()}}),U(this,"handleUpdateVideoEncoder",async(t,i,r,o)=>{let s;o||(s=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoEncoder"));try{let c=this.localTrackMap.get(Se.LocalVideoTrack);if(!this.connection||!c||c.track!==t||this.state!==ue.Connected)return void i();let{id:d,track:l}=c;await this.connection.updateSendParameters(d,l),await this.connection.updateEncoderConfig(d,l),this.emit(we.UpdateVideoEncoder,l),i()}catch(c){r(c)}finally{var a;(a=s)===null||a===void 0||a()}}),U(this,"handleUpdateVideoSendParameters",async(t,i,r)=>{let o=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{let s=this.localTrackMap.get(Se.LocalVideoTrack);if(!this.connection||!s||s.track!==t||this.state!==ue.Connected)return void i();let{id:a,track:c}=s;await this.connection.updateSendParameters(a,c),i()}catch(s){r(s)}finally{o()}}),U(this,"handleReplaceMixingTrack",async(t,i,r,o)=>{if(!this.connection||this.state!==ue.Connected)return void i();let s=HT([t]),a;y.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(s.getTrackId(),"]")),typeof o=="boolean"&&o||(a=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(t,s),i()}catch(d){r(d)}finally{var c;(c=a)===null||c===void 0||c()}}),U(this,"handleReplaceTrack",async(t,i,r,o)=>{let s;y.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(t.getTrackId(),"]")),typeof o=="boolean"&&o||(s=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var a;let d=Array.from(this.localTrackMap.entries()).find(l=>{let[,{track:h}]=l;return t===h});if(!this.connection||!d||this.state!==ue.Connected)return void i();if(await((a=this.connection)===null||a===void 0?void 0:a.replaceTrack(t,d[1].id)),this.isPlanB){let l=d[1];l.id=t._mediaStreamTrack.id,this.localTrackMap.set(d[0],l)}if(d[0]===Se.LocalVideoTrack&&!F("DISABLE_DUAL_STREAM_USE_ENCODING")&&ot().supportDualStreamEncoding){let l=this.localTrackMap.get(Se.LocalVideoLowTrack);if(l){let h=t._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=h,l.track._originMediaStreamTrack=h,await new Z((p,f)=>{this.handleReplaceTrack(l.track,p,f,!0)})}}i()}catch(d){r(d)}finally{var c;(c=s)===null||c===void 0||c()}}),U(this,"handleGetRTCStats",t=>{t(this.statsCollector.getRTCStats())}),U(this,"handleGetLocalVideoStats",t=>{t(this.statsCollector.getLocalVideoTrackStats())}),U(this,"handleGetLocalAudioStats",t=>{t(this.statsCollector.getLocalAudioTrackStats())}),U(this,"handleGetRemoteVideoStats",t=>this.statsCollector.getRemoteVideoTrackStats(t.uid)[t.uid]),U(this,"handleGetRemoteAudioStats",t=>this.statsCollector.getRemoteAudioTrackStats(t.uid)[t.uid]),this.store=n,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new TL(this.store),this.bindStatsUploaderEvents(),this.mutex=new mn("P2PChannel-mutex",this.store.clientId),this.isPlanB=!ot().supportUnifiedPlan||F("CHROME_FORCE_PLAN_B")&&Ud(),this.shouldForwardP2PCreation=F("FORWARD_P2P_CREATION")&&ot().supportPCSetConfiguration&&NN(),this.shouldForwardP2PCreation&&(this.connection=KT(this.store),this.emit(we.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection))}async startP2PConnection(n,e){var t;this.state=ue.New,this._forceTurn=YT(n),y.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] forceTurn: ").concat(this._forceTurn));let i=this.shouldForwardP2PCreation&&((t=this.connection)===null||t===void 0?void 0:t.peerConnectionState)==="closed";if((!this.shouldForwardP2PCreation||i||e)&&((i||e)&&this.connection&&(y.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.resetConnection(this.connection)),this.connection=KT(this.store,n),this.emit(we.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),!this.connection)throw new O(L.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=F("NEW_ICE_RESTART")?Ir.FIRST_CONNECTION:Ir.OLD_FIRST_CONNECTION,this._isTryConnecting=!0,this._isStartRestartIce=!1,this._iceError=null,this.connection.setConfiguration(n),this.connection.establishPromise}async connect(n){if(!this.connection)throw new O(L.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");if(!this.isPreallocation()||this.state!==ue.Connected){this.store.peerConnectionStart();let e=await this.connection.connect(n);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=ue.Connected,e}if(this.connection instanceof bn&&this.connection.checkDtlsParameters(n.dtlsParameters.fingerprints))return y.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] dtls parameters mismatch, try next.")),_e.reportApiInvoke(this.store.sessionId,{name:Yi.MISMATCH_DTLS_PARAMETERS,options:[n.dtlsParameters.fingerprints],tag:ct.TRACER}).onSuccess(),void setTimeout(()=>{this.emit(we.RequestReconnect)});await this.connection.updateRemoteConnect(n)}updateRemoteRTPCapabilities(n){let e=Array.from(this.localTrackMap.entries()).filter(r=>{var o;let[s]=r;return z(o=[Se.LocalVideoLowTrack,Se.LocalVideoTrack]).call(o,s)}),t=e.map(r=>{let[,{id:o}]=r;return o}),i=e.map(r=>{let[o]=r;return o});if(this.connection instanceof bn||this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"){if(_e.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(i),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(n)}),!z(n).call(n,this.store.codec)){let r=["vp9","vp8","h264"].find(o=>z(n).call(n,o));r&&(this.store.codec=r,y.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(r,".")))}this.connection.updateRemoteRTPCapabilities(t,n)}}async getEstablishParams(){var n;return this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"&&this.connection.peerConnectionState!=="closed"||this.connection instanceof bn&&this.connection.peerConnectionState!=="closed"&&z(n=[ue.New,ue.Connected]).call(n,this.state)?this.connection.establishPromise:void 0}async publishDataChannel(n){if(!this.connection||this.state!==ue.Connected){if(this.state===ue.Disconnected)throw new O(L.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return n.forEach(t=>{var i;z(i=this.pendingLocalDataChannels).call(i,t)||this.pendingLocalDataChannels.push(t)}),[]}let e=this.filterTobePublishedDataChannels(n);return e.length===0?[]:(e.forEach(t=>{let i=Date.now();this.store.publish(t.id.toString(),"datachannel",i)}),await this.connection.createDataChannels(this.store.uid,e),e.forEach(t=>{this.localDataChannels.push(t);let i=Date.now();this.store.publish(t.id+"","datachannel",void 0,i)}),n.map(t=>({streamId:t.id,ordered:t.ordered,maxRetransmits:t.maxRetransmits,metadata:t.metadata,channelId:t._originDataChannelId})))}publish(n,e,t){var i=this;return wo(function*(){let r=yield St(i.mutex.lock("From P2PChannel.publish"));try{var o;let s=i.connection&&z(o=["disconnected","failed"]).call(o,i.connection.peerConnectionState);if(!i.connection||i.state!==ue.Connected||s){if(i.state===ue.Disconnected)throw new O(L.UNEXPECTED_ERROR,"PeerConnection already disconnected.");i.throwIfTrackTypeNotMatch(n);let c=n.filter(d=>i.pendingLocalTracks.indexOf(d)===-1);return i.pendingLocalTracks=i.pendingLocalTracks.concat(c),void(s&&(i._isWaitPcToRePub=!0))}i.store.pubId=i.store.pubId+1,qn.markPublishStart(i.store.clientId,i.store.pubId);let a=i.filterTobePublishedTracks(n,e,t);if(a.length===0)return void(yield St(i.tryToUnmuteAudio(n)));yield*Et(Qd(i.doPublish(i.connection,a)))}finally{r()}})()}doPublish(n,e){var t=this;return wo(function*(){e.forEach(p=>{let{track:f,type:m}=p,g=Date.now();t.store.publish(f.getTrackId(),m===Se.LocalAudioTrack?"audio":"video",g)}),t.bindLocalTrackEvents(e);let i=e.map(p=>{let{track:f}=p;return f}),r=yield St(n.send(i,t.store.codec,t.store.audioCodec)),o=(yield St(r.next())).value,s=t.createGatewayPublishMessage(e,o),a;try{a=yield s}catch(p){throw r.throw(p),(p==null?void 0:p.code)===L.WS_ABORT&&e.forEach(f=>{let{track:m}=f;t.pendingLocalTracks.indexOf(m)===-1&&t.pendingLocalTracks.push(m)}),t.unbindLocalTrackEvents(e),p}let c=t.mapPubResToRemoteConfig(s,a,i),d=(yield St(r.next(c))).value;if(t.state===ue.Disconnected)throw new O(L.UNEXPECTED_ERROR,"PeerConnection already disconnected.");F("ENABLE_VIDEO_SEI");let l=F("ENABLE_ENCODED_TRANSFORM"),h=F("ENABLE_AUDIO_METADATA");i.forEach(async p=>{let f=p.getRTCRtpTransceiver();if(!f||!l)return;let{interceptLocalVideoFrame:m,interceptLocalAudioFrame:g}=xT();p.trackMediaType===ke.VIDEO?await m(f.sender,p):p.trackMediaType===ke.AUDIO&&await g(f.sender,{metadata:h?()=>{let S=p.metadata.shift();return S&&S.value}:void 0})}),e.forEach(p=>{let{type:f}=p;t.statsCollector.addLocalStats(f)}),t.assignLocalTracks(e,d),t.statsUploader.startUploadOutboundStats(),e.forEach(p=>{let{track:f,type:m}=p,g=Date.now();t.store.publish(f.getTrackId(),m===Se.LocalAudioTrack?"audio":"video",void 0,g)})})()}async updateVideoStreamParameter(n,e){let t=this.localTrackMap.get(e);if(!t||!this.connection)return;if(!(t.track instanceof Jt))return y.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");let{track:i}=t,r=function(o,s){let a={};return o.height&&o.width&&(a.scaleResolutionDownBy=sC(o,s)),a.maxFramerate=o.framerate?Mo(o.framerate):void 0,a.maxBitrate=o.bitrate?1e3*o.bitrate:void 0,a}(n,i);if(i._encoderConfig||(i._encoderConfig={}),e!==Se.LocalVideoLowTrack||!F("DISABLE_DUAL_STREAM_USE_ENCODING")&&ot().supportDualStreamEncoding)r.scaleResolutionDownBy!=null&&(i._encoderConfig.scaleResolutionDownBy=r.scaleResolutionDownBy);else{let o=i._originMediaStreamTrack;if(!o.canvas)return y.warn("[".concat(i.getTrackId(),"] no canvas on track"));(function(s,a){let c=s.canvas;a.width&&(c.width=Mo(a.width)),a.height&&(c.height=Mo(a.height)),a.framerate&&(c.stopCapture&&c.stopCapture(),c.stopCapture=dT(()=>{!c.startCapture&&c.stopCapture&&c.stopCapture(),c.startCapture&&c.startCapture()},Mo(a.framerate)))})(o,n)}r.maxBitrate!=null&&(i._encoderConfig.bitrateMax=r.maxBitrate/1e3),r.maxFramerate!=null&&(i._encoderConfig.frameRate&&typeof i._encoderConfig.frameRate=="object"?i._encoderConfig.frameRate.max=r.maxFramerate:i._encoderConfig.frameRate={max:r.maxFramerate}),y.debug("[".concat(i.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(i._encoderConfig))),await this.connection.updateRtpSenderEncodings(i)}publishLowStream(n){var e=this;return wo(function*(){if(!e.connection||e.state!==ue.Connected)return;let t=yield St(e.mutex.lock("Locking from P2PChannel.publishLowStream"));try{let r=e.localTrackMap.get(Se.LocalVideoTrack);if(!r)throw new O(L.UNEXPECTED_ERROR,"Could not find high stream");if(e.localTrackMap.has(Se.LocalVideoLowTrack))throw new O(L.UNEXPECTED_ERROR,"[".concat(e.store.clientId,"] Can't publish low stream when stream already publish"));let o=[{track:e.getLowVideoTrack(r.track,n),type:Se.LocalVideoLowTrack}];if(yield*Et(Qd(e.doPublish(e.connection,o))),r.track.muted||!r.track.enabled){var i;let s=(i=e.localTrackMap.get(Se.LocalVideoLowTrack))===null||i===void 0?void 0:i.id;s!==void 0&&(yield St(e.connection.muteLocal([s])))}}finally{t()}})()}async republish(){this.pendingLocalTracks.length>0&&(y.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await fr(this,we.RequestRePublish,this.pendingLocalTracks),this.emit(we.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(y.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await fr(this,we.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[]),this._isWaitPcToRePub=!1}async reSubscribe(n){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){let{user:t,kind:i}=this.pendingRemoteTracks[e];(i!==ke.AUDIO||t._audio_added_&&t._audioSSRC)&&(i!==ke.VIDEO||t._video_added_&&t._videoSSRC)||this.pendingRemoteTracks.splice(e,1)}if(n)await fr(this,we.RequestReSubscribe,this.pendingRemoteTracks);else for(let{user:e,kind:t}of this.pendingRemoteTracks)await this.subscribe(e,t,t===ke.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach(e=>{let{user:t}=e;this.emit(we.MediaReconnectEnd,t.uid)}),this.pendingRemoteTracks=[]}async unpublish(n){if(!this.connection||this.state!==ue.Connected)return void n.forEach(i=>{let r=this.pendingLocalTracks.indexOf(i);r!==-1&&this.pendingLocalTracks.splice(r,1)});let e=this.filterTobeUnpublishedTracks(n);if(e.length===0)return;let t=e.find(i=>i[0]==="videoLowTrack");return t&&t[1].track.close(),this.doUnpublish(this.connection,e)}async unpublishDataChannel(n){if(!this.connection||this.state!==ue.Connected)return void n.forEach(t=>{let i=this.pendingLocalDataChannels.indexOf(t);i!==-1&&this.pendingLocalDataChannels.splice(i,1)});let e=this.filterTobeUnpublishedDataChannels(n);return e.length!==0?(e.forEach(t=>{let i=this.localDataChannels.indexOf(t);i!==-1&&this.localDataChannels.splice(i,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),e.map(t=>t.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==ue.Connected)return;let n=this.localTrackMap.get(Se.LocalVideoLowTrack);if(!n)return;n.track.close();let e=[[Se.LocalVideoLowTrack,n]];return this.doUnpublish(this.connection,e)}async doUnpublish(n,e){let t=this.createGatewayUnpublishMessage(e);return await n.stopSending(e.map(i=>{let[,{id:r}]=i;return r})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(i=>{let[r,{track:o}]=i;return{type:r,track:o}})),e.forEach(i=>{let[r]=i;this.statsCollector.removeLocalStats(r)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),t}async subscribeDataChannel(n,e){if(!this.connection||this.state!==ue.Connected)throw new O(L.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");let t=e.filter(i=>{var r;return!((r=this.remoteDataChannelMap.get(n))!==null&&r!==void 0&&r.get(i.id))});if(t.length!==0)return await this.connection.createDataChannels(n.uid,t),t.forEach(i=>{var r;this.remoteDataChannelMap.has(n)?(r=this.remoteDataChannelMap.get(n))===null||r===void 0||r.set(i.id,i):this.remoteDataChannelMap.set(n,new Map([[i.id,i]]));let o=this.pendingRemoteDataChannels.findIndex(s=>{let{user:a,id:c}=s;return a.uid===n.uid&&c===i.id});o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),t.map(i=>i.id)}async subscribe(n,e,t,i,r){var o;if(!this.connection||this.state!==ue.Connected)throw new O(L.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((o=this.remoteUserMap.get(n))!==null&&o!==void 0&&o.has(e))return;let s,a,c,d,l=this.connection.getPreMedia(t);if(l)y.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] preSSRCMap has ssrcId: ").concat(t,", no need to send sub to gateway.")),c=l.transceiver,s=l.track,a=l.mid,d=l.player,l.firstVideoRender&&this.store.firstVideoFrameDecoded(n.uid,{firstPreRender:l.firstVideoRender});else if(r){let f=r.find(g=>{let{stream_type:S}=g;return S===e});if(!f)throw new O(L.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(e," for user: ").concat(n.uid," because subscribe answer from gateway does not contain stream_type: ").concat(e,"."));let m=await this.connection.receive(e,f.ssrcs,String(n._uintid),f.attributes);(this.connection instanceof bn||"name"in this.connection&&this.connection.name==="DataChannelConnection")&&(c=m.transceiver),s=m.track,a=m.id}else{let f=await this.connection.receive(e,[{ssrcId:t,rtx:i}],String(n._uintid),void 0);(this.connection instanceof bn||"name"in this.connection&&this.connection.name==="DataChannelConnection")&&(c=f.transceiver),s=f.track,a=f.id}if(e===ke.AUDIO?(n._audioTrack?n._audioTrack._updateOriginMediaStreamTrack(s):(n._audioTrack=new Wd(s,n.uid,n._uintid,this.store),y.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(n._audioTrack.getTrackId()))),c&&n._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(n,n._audioTrack)):(n._videoTrack?n._videoTrack._updateOriginMediaStreamTrack(s):(n._videoTrack=new D_(s,n.uid,n._uintid,this.store,d),y.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(n._videoTrack.getTrackId())),n._videoTrack.once(Wo.PLAY_START,()=>{this.store.firstVideoFrameDecoded(n.uid,{playStart:Date.now()})}),n._videoTrack.once(Wo.PLAY_END,()=>{this.store.firstVideoFrameDecoded(n.uid,{playEnd:Date.now()}),this.reportVideoFirstFrameRender(n)}),d?n._videoTrack.once(Wo.FIRST_FRAME_RENDER,()=>{this.store.firstVideoFrameDecoded(n.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(n)}):n._videoTrack.once(Wo.FIRST_FRAME_DECODED,()=>{this.store.firstVideoFrameDecoded(n.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(n)})),c&&n._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(n,n._videoTrack)),c&&F("ENABLE_ENCODED_TRANSFORM")){let{interceptRemoteVideoFrame:f,interceptRemoteAudioFrame:m}=xT();e==ke.VIDEO?await f(c.receiver,{onSei:F("ENABLE_VIDEO_SEI")&&(g=>{var S;return(S=n._videoTrack)===null||S===void 0?void 0:S._onSei(g)}),onFirstFrame:g=>{var S;let T=Array.from(mo(S=this.remoteUserMap).call(S)).find(C=>C._videoSSRC===g.ssrc);T&&this.store.firstVideoFrameDecoded(T.uid,{firstReceivedEncodedFrame:Date.now(),frameType:g.type,rtpTimestamp:g.rtpTimestamp,framePayloadType:g.payloadType,frameDataLength:g.length,mimeType:g.mimeType})}}):e==ke.AUDIO&&await m(c.receiver,{enableTopn:!!F("ENABLE_AUDIO_TOPN"),enableMetadata:!!F("ENABLE_AUDIO_METADATA"),enablePts:!!F("ENABLE_AUDIO_PTS"),onMetadata:g=>{this.safeEmit(we.AudioMetadata,g)},onPts:g=>{this.safeEmit(we.AudioPts,g)}})}let h=this.remoteUserMap.get(n);h?h.set(e,a):this.remoteUserMap.set(n,new Map([[e,a]])),this.statsCollector.addRemoteStats(n.uid),this.statsUploader.startUploadInboundStats();let p=this.pendingRemoteTracks.findIndex(f=>{let{user:m,kind:g}=f;return m.uid===n.uid&&e===g});p!==-1&&(this.pendingRemoteTracks.splice(p,1),this.emit(we.MediaReconnectEnd,n.uid))}async massSubscribe(n){return this.massSubscribeNoLock(n)}async massSubscribeNoLock(n){if(!this.connection||this.state!==ue.Connected)throw new O(L.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");n=n.filter(r=>{var o;let{user:s,mediaType:a}=r;return!((o=this.remoteUserMap.get(s))!==null&&o!==void 0&&o.has(a))});let e=[],t=new Map;n.forEach(r=>{if(!this.connection)return;let o=this.connection.getPreMedia(r.ssrcId);if(o){let{track:s,mid:a,transceiver:c,player:d}=o;t.set(r.ssrcId,{track:s,id:a,transceiver:c,player:d})}else e.push(r)});let i=await this.connection.batchReceive(e.map(r=>{let{user:o,mediaType:s,ssrcId:a,rtxSsrcId:c}=r;return{kind:s,ssrcMsg:[{ssrcId:a,rtx:c}],mslabel:String(o._uintid)}}));e.forEach((r,o)=>{t.set(r.ssrcId,i[o])});for(let{user:r,mediaType:o,ssrcId:s}of n){let a=t.get(s);if(!a)return void y.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] cannot find ").concat(r.uid," subscribe data,").concat(o,", ").concat(s));let{track:c,id:d,transceiver:l,player:h}=a;if(l&&F("ENABLE_ENCODED_TRANSFORM")){let{interceptRemoteVideoFrame:m,interceptRemoteAudioFrame:g}=xT();o==ke.VIDEO?await m(l.receiver,{onSei:F("ENABLE_VIDEO_SEI")&&(S=>{var T;return(T=r._videoTrack)===null||T===void 0?void 0:T._onSei(S)}),onFirstFrame:S=>{var T;let C=Array.from(mo(T=this.remoteUserMap).call(T)).find(b=>b._videoSSRC===S.ssrc);C&&this.store.firstVideoFrameDecoded(C.uid,{firstReceivedEncodedFrame:Date.now(),frameType:S.type,rtpTimestamp:S.rtpTimestamp,framePayloadType:S.payloadType,frameDataLength:S.length,mimeType:S.mimeType})}}):o==ke.AUDIO&&await g(l.receiver,{enableTopn:!!F("ENABLE_AUDIO_TOPN"),enableMetadata:!!F("ENABLE_AUDIO_METADATA"),enablePts:!!F("ENABLE_AUDIO_PTS"),onMetadata:S=>{this.safeEmit(we.AudioMetadata,S)},onPts:S=>{this.safeEmit(we.AudioPts,S)}})}if(o===ke.AUDIO?(r._audioTrack?r._audioTrack._updateOriginMediaStreamTrack(c):(r._audioTrack=new Wd(c,r.uid,r._uintid,this.store),y.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(r._audioTrack.getTrackId()))),l&&r._audioTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(r,r._audioTrack)):(r._videoTrack?r._videoTrack._updateOriginMediaStreamTrack(c):(r._videoTrack=new D_(c,r.uid,r._uintid,this.store,h),y.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(r._videoTrack.getTrackId()))),l&&r._videoTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(r,r._videoTrack)),F("ENABLE_VIDEO_SEI")&&l){let{interceptRemoteVideoFrame:m,interceptRemoteAudioFrame:g}=xT();o==ke.VIDEO?await m(l.receiver,{onSei:S=>{var T;(T=r._videoTrack)===null||T===void 0||T._onSei(S)},onFirstFrame:S=>{var T;let C=Array.from(mo(T=this.remoteUserMap).call(T)).find(b=>b._videoSSRC===S.ssrc);C&&this.store.firstVideoFrameDecoded(C.uid,{firstReceivedEncodedFrame:Date.now(),frameType:S.type,rtpTimestamp:S.rtpTimestamp,framePayloadType:S.payloadType,frameDataLength:S.length,mimeType:S.mimeType})}}):o==ke.AUDIO&&await g(l.receiver)}let p=this.remoteUserMap.get(r);p?p.set(o,d):this.remoteUserMap.set(r,new Map([[o,d]])),this.statsCollector.addRemoteStats(r.uid),this.statsUploader.startUploadInboundStats();let f=this.pendingRemoteTracks.findIndex(m=>{let{user:g,kind:S}=m;return g.uid===r.uid&&o===S});f!==-1&&(this.pendingRemoteTracks.splice(f,1),this.emit(we.MediaReconnectEnd,r.uid))}}async unsubscribe(n,e,t){let i=this.pendingRemoteTracks.filter(s=>{let{user:a,kind:c}=s;return e!==void 0?a.uid===n.uid&&e===c:a.uid===n.uid});if(i.forEach(s=>{let a=this.pendingRemoteTracks.indexOf(s);this.pendingRemoteTracks.splice(a,1)}),this.connection&&this.state===ue.Connected||t||i.forEach(s=>{let{kind:a}=s;var c;if(a===ke.AUDIO)(c=n._audioTrack)===null||c===void 0||c._destroy(),n._audioTrack=void 0;else if(a===ke.VIDEO){var d;(d=n._videoTrack)===null||d===void 0||d._destroy(),n._videoTrack=void 0}}),!this.connection||this.state!==ue.Connected)return;let r=this.filterTobeUnSubscribedTracks(n,e);if(r.length===0)return;await this.connection.stopReceiving(r.map(s=>{let[,{id:a}]=s;return a}));let o=this.createUnsubscribeMessage(r);return this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),r.forEach(s=>{let[a,{kind:c}]=s;var d,l;if(c===ke.VIDEO&&a._videoSSRC&&((d=this.connection)===null||d===void 0||d.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),c===ke.VIDEO)this.unbindRemoteTrackEvents(a._videoTrack),t||((l=a._videoTrack)===null||l===void 0||l._destroy(),a._videoTrack=void 0);else if(c===ke.AUDIO){var h;this.unbindRemoteTrackEvents(a._audioTrack),!t&&((h=a._audioTrack)===null||h===void 0||h._destroy(),a._audioTrack=void 0)}}),o}async unsubscribeDataChannel(n,e){if(e.forEach(r=>{let o=this.pendingRemoteDataChannels.findIndex(s=>s.id===r.id);o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),!this.connection)return;let t=this.filterTobeUnSubscribedDataChannels(n,e);if(t.length===0)return;e.forEach(r=>{r._close()});let i=this.remoteDataChannelMap.get(n);return t.forEach(r=>{i&&i.delete(r.id)}),i&&i.size===0&&(this.remoteDataChannelMap.delete(n),await this.connection.stopDataChannels(n.uid)),t.map(r=>r.id)}async massUnsubscribe(n){return this.massUnsubscribeNoLock(n)}async massUnsubscribeNoLock(n){let e=[];for(let{user:r,mediaType:o}of n){let s=this.pendingRemoteTracks.filter(a=>{let{user:c,kind:d}=a;return o!==void 0?c.uid===r.uid&&o===d:c.uid===r.uid});s.forEach(a=>{let c=this.pendingRemoteTracks.indexOf(a);this.pendingRemoteTracks.splice(c,1)}),e=e.concat(s)}if(!this.connection||this.state!==ue.Connected)return void e.forEach(r=>{let{user:o,kind:s}=r;var a;if(s===ke.AUDIO)(a=o._audioTrack)===null||a===void 0||a._destroy(),o._audioTrack=void 0;else if(s===ke.VIDEO){var c;(c=o._videoTrack)===null||c===void 0||c._destroy(),o._videoTrack=void 0}});let t=un(n).call(n,(r,o)=>{let{user:s,mediaType:a}=o,c=this.filterTobeUnSubscribedTracks(s,a);return r.concat(c)},[]);if(t.length===0)return;await this.connection.stopReceiving(t.map(r=>{let[,{id:o}]=r;return o}));let i=this.createUnsubscribeAllMessage(t);return this.withdrawRemoteTracks(t),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),t.forEach(r=>{let[o,{kind:s}]=r;var a,c;if(s===ke.VIDEO&&o._videoSSRC&&((a=this.connection)===null||a===void 0||a.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),s===ke.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),(c=o._videoTrack)===null||c===void 0||c._destroy(),o._videoTrack=void 0;else if(s===ke.AUDIO){var d;this.unbindRemoteTrackEvents(o._audioTrack),(d=o._audioTrack)===null||d===void 0||d._destroy(),o._audioTrack=void 0}}),i}isPreSubScribe(n){return!this.connection||this.state!==ue.Connected?!1:!!this.connection.getPreMedia(n)}async muteRemote(n,e){if(!this.connection)return;let t=this.remoteUserMap.get(n);if(!t)return void y.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(n.uid,"."));if(!t.get(e))return void y.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(n.uid," media type ").concat(e,"."));let i=e===ke.VIDEO?n._videoSSRC:n._audioSSRC;i!==void 0&&this.connection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(n,e){return this.unmuteRemoteNoLock(n,e)}async unmuteRemoteNoLock(n,e){if(!this.connection)return;let t=this.remoteUserMap.get(n);if(!t)return void y.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(n.uid,"."));t.get(e)||y.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(n.uid," media type ").concat(e,"."))}addAudioMetadata(n){let e=this.localTrackMap.get(Se.LocalAudioTrack),t=e&&e.track;t&&t.metadata.push(n)}getAllTracks(n){let e=this.localTrackMap.get(Se.LocalAudioTrack);if((e==null?void 0:e.track)instanceof rn){let t=e.track;return Array.from(this.localTrackMap.entries()).filter(i=>{let[r]=i;return r!==Se.LocalAudioTrack}).filter(i=>{let[r]=i;return!(n&&r===Se.LocalVideoLowTrack)}).map(i=>{let[,{track:r}]=i;return r}).concat(t.trackList)}return Array.from(this.localTrackMap.entries()).filter(t=>{let[i]=t;return!(n&&i===Se.LocalVideoLowTrack)}).map(t=>{let[,{track:i}]=t;return i})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(n,e,t,i,r){if(n){let s=this.localTrackMap.get(Se.LocalAudioTrack),a=i?this.localTrackMap.get(Se.LocalVideoLowTrack):this.localTrackMap.get(Se.LocalVideoTrack);_e.publish(this.store.sessionId,{eventElapse:qn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:n,ec:e,audioName:s==null?void 0:s.track.getTrackLabel(),videoName:a==null?void 0:a.track.getTrackLabel(),screenshare:(a==null?void 0:a.track._hints.indexOf(Re.SCREEN_TRACK))!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;t||(t=[]);let s=t.find(c=>c instanceof ri),a=i?(o=this.localTrackMap.get(Se.LocalVideoTrack))===null||o===void 0?void 0:o.track:t.find(c=>c instanceof Jt);_e.publish(this.store.sessionId,{eventElapse:qn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:n,ec:e,audioName:s==null?void 0:s.getTrackLabel(),videoName:a==null?void 0:a.getTrackLabel(),screenshare:(a==null?void 0:a._hints.indexOf(Re.SCREEN_TRACK))!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(n,e,t,i){let r=i===ke.VIDEO?t._videoSSRC:t._audioSSRC;r&&_e.subscribe(this.store.sessionId,{succ:n,ec:e,video:i===ke.VIDEO,audio:i===ke.AUDIO,peerid:t.uid,subscribeRequestid:r,p2pid:this.store.p2pId,eventElapse:qn.measureFromSubscribeStart(this.store.clientId,r),preSsrc:this.isPreSubScribe(r)})}reset(){y.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new mn("P2PChannel-mutex",this.store.clientId),this.connection&&(this.resetConnection(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=KT(this.store),this.emit(we.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.statsUploader.stopUploadBaseStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();let n=this.localTrackMap.get(Se.LocalAudioTrack);if((n==null?void 0:n.track)instanceof rn){if(n.track.trackList.length>0){let e=n.track;n.track.trackList.forEach(t=>{e.removeAudioTrack(t)})}n.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=ue.Disconnected}getStats(){var n;return(n=this.connection)===null||n===void 0?void 0:n.getStats()}getRemoteVideoIsReady(n){var e;return((e=this.connection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(n))||!1}getLocalAudioVolume(){let n=this.localTrackMap.get(Se.LocalAudioTrack);if(n)return n.track.getVolumeLevel()}getLocalVideoSize(){let n=this.localTrackMap.get(Se.LocalVideoTrack);if(n)return{width:n.track.videoWidth||0,height:n.track.videoHeight||0}}getEncoderConfig(n){let e=this.localTrackMap.get(n);return e&&e.track instanceof Jt||e&&e.track instanceof ri?e.track._encoderConfig:void 0}getLocalMedia(n){return this.localTrackMap.get(n)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(n,e){if(!n)return this.remoteUserMap.size>0;let t=this.remoteUserMap.get(n);return!!t&&(!e||t.has(e))}async hasRemoteMediaWithLock(n,e){if(!n)return this.remoteUserMap.size>0;let t=this.remoteUserMap.get(n);return!!t&&(!e||t.has(e))}getRemoteMedia(n){var e;let t=Array.from(mo(e=this.remoteUserMap).call(e)).find(i=>i.uid===n);return t?{audioTrack:t.audioTrack,audioSSRC:t._audioSSRC,videoTrack:t.videoTrack,videoSSRC:t._videoSSRC}:{}}getAudioLevels(){let n=Array.from(this.remoteUserMap.entries()).map(t=>{let[i]=t;return{uid:i.uid,level:i.audioTrack?100*i.audioTrack._source.getAccurateVolumeLevel():0}}),e=this.localTrackMap.get(Se.LocalAudioTrack);return e&&n.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),n=Ka(n).call(n,(t,i)=>t.level-i.level),n}async disconnectForReconnect(){this.connection&&(y.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=ue.Reconnecting,F("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(n=>{let[e]=n;var t;e._videoTrack&&e._videoTrack._player&&((t=e._videoTrack._player.getVideoElement())===null||t===void 0||t.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())}),this.resetConnection(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=KT(this.store),this.emit(we.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(n=>{var e;let[t,{track:i}]=n;switch(t){case Se.LocalVideoTrack:z(e=i._hints).call(e,Re.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case Se.LocalAudioTrack:i instanceof rn?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case Se.LocalVideoLowTrack:}}),this.emit(we.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(n=>{let[e,t]=n;Array.from(mo(t).call(t)).forEach(i=>{this.setPendingRemoteMedia(e,i)}),this.emit(we.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(n=>{this.pendingLocalDataChannels.push(n)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(n=>{let[e,t]=n;Array.from(mo(t).call(t)).forEach(i=>{this.setPendingRemoteDataChannel(e,i)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),y.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(n,e){for(let t of this.pendingRemoteDataChannels){let{user:i,id:r}=t;if((n instanceof Bu?n.uid:n)===i.uid&&r===e)return!0}return!1}setPendingRemoteDataChannel(n,e){this.hasPendingRemoteDataChannel(n,e)||this.pendingRemoteDataChannels.push({user:n,id:e})}hasPendingRemoteMedia(n,e){for(let t of this.pendingRemoteTracks){let{user:i,kind:r}=t;if((n instanceof Bu?n.uid:n)===i.uid&&e===r)return!0}return!1}setPendingRemoteMedia(n,e){this.hasPendingRemoteMedia(n,e)||this.pendingRemoteTracks.push({user:n,kind:e})}restartICE(n){var e=this;return wo(function*(){if(!e.connection||e.state!==ue.Connected)return;let t=yield St(e.mutex.lock("From P2PChannel.restartICE")),i;try{i=yield St(e.connection.restartICE(n));let o=yield St(i.next());if(o.done)return;let s=o.value,a=yield s;switch(F_(e.connection)&&e.reportPCStats(Date.now(),!1,e._pcStatsUploadType),n){case be.UDP_TCP_RELAY:e._pcStatsUploadType=Ir.UDP_TCP_RESTART;break;case be.TCP_RELAY:e._pcStatsUploadType=Ir.TCP_RESTART;break;case be.RELAY:e._pcStatsUploadType=Ir.RELAY_RESTART;break;default:e._pcStatsUploadType=Ir.OLD_RESTART}e._isTryConnecting=!0,i.next(a)}catch(o){var r;(r=i)===null||r===void 0||r.throw(o)}finally{t()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;let n=this.connection.getStats(),e=this.localTrackMap.get(Se.LocalVideoTrack),t=this.localTrackMap.get(Se.LocalAudioTrack),i=n.videoSend.find(f=>f.ssrc===(e==null?void 0:e.ssrcs[0].ssrcId)),r=n.audioSend.find(f=>f.ssrc===(t==null?void 0:t.ssrcs[0].ssrcId));if(!i||!r)return 1;let o=Xt(this,we.NeedSignalRTT),s=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*n.sendPacketLossRate*.7/50+.3*d/1500,h=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,p=e==null?void 0:e.track;if(p&&p._encoderConfig&&p._hints.indexOf(Re.SCREEN_TRACK)===-1){let f=p._encoderConfig.bitrateMax,m=n.bitrate.actualEncoded;if(f&&m){let g=(1e3*f-m)/(1e3*f);return jU[g<.15?0:g<.3?1:g<.45?2:g<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.connection)return 0;let n=this.connection.getStats(),e=0;return Array.from(this.remoteUserMap.entries()).forEach(t=>{let[i]=t,r=i._audioSSRC,o=i._videoSSRC,s=n.audioRecv.find(m=>m.ssrc===r),a=n.videoRecv.find(m=>m.ssrc===o);if(!s&&!a)return void(e+=1);let c=Xt(this,we.NeedSignalRTT),d=n.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=s?s.jitterMs:void 0,p=n.recvPacketLossRate,f=.7*p*100/50+.3*l/1500;h&&(f=.6*p*100/50+.2*l/1500+.2*h/400),e+=f<.1?1:f<.17?2:f<.36?3:f<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(n){return new Z((e,t)=>{this.handleMuteLocalTrack(n,e,t)})}async replaceTrack(n,e){var t;if(y.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(n.getTrackId(),"] to [").concat(e.getTrackId(),"]")),!this.connection||this.state!==ue.Connected)return;let i=Array.from(this.localTrackMap.entries()).find(o=>{let[,{track:s}]=o;return n===s});if(!i)return;let r=i[0];if(n!==e&&(this.unbindLocalTrackEvents([{track:n,type:r}]),this.bindLocalTrackEvents([{track:e,type:r}]),i[1].track=e),await((t=this.connection)===null||t===void 0?void 0:t.replaceTrack(e,i[1].id)),this.isPlanB){let o=i[1];o.id=e._mediaStreamTrack.id,this.localTrackMap.set(r,o)}if(r===Se.LocalVideoTrack&&!F("DISABLE_DUAL_STREAM_USE_ENCODING")&&ot().supportDualStreamEncoding){let o=this.localTrackMap.get(Se.LocalVideoLowTrack);if(o){let s=n._mediaStreamTrack.clone();o.track._originMediaStreamTrack.stop(),o.track._mediaStreamTrack=s,o.track._originMediaStreamTrack=s,await new Z((a,c)=>{this.handleReplaceTrack(o.track,a,c,!0)})}}}filterTobePublishedTracks(n,e,t){let i=[],r=this.getAllTracks();n=Iu(n=n.filter(c=>r.indexOf(c)===-1));let o,s=!1,a=this.localTrackMap.get(Se.LocalAudioTrack);for(let c of n){if(c instanceof Jt&&(this.localTrackMap.has(Se.LocalVideoTrack)||s?new O(L.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:Se.LocalVideoTrack}),s=!0),e)){let d=this.getLowVideoTrack(c,t);i.push({track:d,type:Se.LocalVideoLowTrack})}if(c instanceof ri)if(a){let d=a.track;if(d instanceof rn)EL([c]),d.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0);else{let l=HT([d,c]);y.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(l.getTrackId(),"]")),this.replaceTrack(d,l)}}else o instanceof rn?(EL([c]),o.addAudioTrack(c)):o||!c._useAudioElement&&ot().webAudioMediaStreamDest&&!c._bypassWebAudio?o=HT(o?[c,o]:[c]):o=c}return o&&(y.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(o.getTrackId(),"]")),i.push({track:o,type:Se.LocalAudioTrack})),i}filterTobeUnpublishedTracks(n){let e=[],t=this.getAllTracks();n=Iu(n=n.filter(i=>t.indexOf(i)!==-1));for(let i of n){if(i instanceof ri){let r=this.localTrackMap.get(Se.LocalAudioTrack);if(!r)continue;r.track instanceof rn?(r.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),r.track.trackList.length===0&&(e.push([Se.LocalAudioTrack,r]),r.track.close())):e.push([Se.LocalAudioTrack,r])}if(i instanceof Jt){let r=this.localTrackMap.get(Se.LocalVideoTrack);if(!r)continue;e.push([Se.LocalVideoTrack,r]);let o=this.localTrackMap.get(Se.LocalVideoLowTrack);o&&e.push([Se.LocalVideoLowTrack,o])}}return e}filterTobePublishedDataChannels(n){return n=(n=Iu(n)).filter(e=>this.localDataChannels.findIndex(t=>t.id===e.id)===-1)}filterTobeUnpublishedDataChannels(n){return n=(n=(n=Iu(n)).filter(e=>this.localDataChannels.indexOf(e)!==-1)).filter(e=>e._originDataChannel)}bindLocalTrackEvents(n){n.forEach(e=>{let{track:t,type:i}=e;switch(i){case Se.LocalVideoTrack:t.addListener(Ue.GET_STATS,this.handleGetLocalVideoStats),t.addListener(Ue.GET_RTC_STATS,this.handleGetRTCStats),t.addListener(Ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Ue.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(Ue.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.addListener(Ue.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(Ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Se.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case Se.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(n,e){n instanceof rn?n.trackList.forEach(t=>{t.addListener(Ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Ue.GET_STATS,this.handleGetLocalAudioStats),t.addListener(Ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(n.addListener(Ue.GET_STATS,this.handleGetLocalAudioStats),n.addListener(Ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(Ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(Ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(Ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||(n.addListener(Ue.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(Ue.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(n){n||(n=Array.from(this.localTrackMap.entries()).map(e=>{let[t,{track:i}]=e;return{track:i,type:t}})),n.forEach(e=>{let{track:t,type:i}=e;switch(i){case Se.LocalVideoTrack:t.off(Ue.GET_STATS,this.handleGetLocalVideoStats),t.off(Ue.GET_RTC_STATS,this.handleGetRTCStats),t.off(Ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Ue.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(Ue.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.off(Ue.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(Ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Se.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case Se.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(n){n instanceof rn?n.trackList.forEach(e=>{e.off(Ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Ue.GET_STATS,this.handleGetLocalAudioStats),e.off(Ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(n.off(Ue.GET_STATS,this.handleGetLocalAudioStats),n.off(Ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(Ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(Ue.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(Ue.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),n.off(Ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(Ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(n,e){e instanceof D_&&e.addListener(Ue.GET_STATS,t=>{t(this.handleGetRemoteVideoStats(n))}),e instanceof Wd&&e.addListener(Ue.GET_STATS,t=>{t(this.handleGetRemoteAudioStats(n))})}unbindRemoteTrackEvents(n){n&&n.removeAllListeners(Ue.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(n=>{let[e,t]=n;t.has(ke.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),t.has(ke.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(n,e){return n.map((t,i)=>{var r;let o,s,{track:a,type:c}=t;switch(c){case Se.LocalAudioTrack:o=_i.Audio,s={dtx:a instanceof Zi&&a._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case Se.LocalVideoTrack:o=z(r=a._hints).call(r,Re.SCREEN_TRACK)?_i.Screen:_i.High,s=Jd(Jd({},qo(a)),{},{codec:this.store.codec,svc_mode:nm()});break;case Se.LocalVideoLowTrack:o=_i.Low,s=Jd(Jd({},qo(a)),{},{codec:this.store.codec,svc_mode:nm()})}return{stream_type:o,attributes:s,ssrcs:e[i]}})}createGatewayUnpublishMessage(n){return n.map(e=>{var t;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case Se.LocalVideoTrack:i=z(t=o._hints).call(t,Re.SCREEN_TRACK)?_i.Screen:_i.High;break;case Se.LocalAudioTrack:i=_i.Audio;break;case Se.LocalVideoLowTrack:i=_i.Low}return{stream_type:i,ssrcs:s,mid:a}})}assignLocalTracks(n,e){n.forEach((t,i)=>{let{track:r,type:o}=t;this.localTrackMap.set(o,{track:r,id:e[i].id,ssrcs:e[i].localSSRC})})}withdrawLocalTracks(n){n.forEach(e=>{let[t]=e;this.localTrackMap.delete(t)})}bindConnectionEvents(n){n.onConnectionStateChange=async e=>{if(y.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(e,")")),this.emit(we.PeerConnectionStateChange,e),e==="connecting"&&n instanceof bn&&!ji()&&F("FIRST_TCP_CANDIDATE")&&window.setTimeout(()=>{e==="connecting"&&n.extendCandidate()},F("FIRST_TCP_CANDIDATE_INTERVAL")),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(this._restartTimer&&(window.clearTimeout(this._restartTimer),this._restartTimer=void 0),n instanceof bn&&wC(n,!0),this._isTryConnecting&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isTryConnecting=!1,this._isStartRestartIce=!1,this._pcStatsUploadType=Ir.DISCONNECTED_OR_FAILED,Xt(this,we.QueryClientConnectionState)==="CONNECTED"&&this._isWaitPcToRePub)){let t=this.pendingLocalTracks.map(r=>r.getTrackId()),i=this.pendingLocalDataChannels.map(r=>"dc_".concat(r.id));_e.reportApiInvoke(this.store.sessionId,{name:Yi.REPUB_AFTER_PC_CONNECTED,options:t.concat(i),tag:ct.TRACER}).onSuccess(),this.republish()}if(F("NEW_ICE_RESTART")&&n instanceof bn&&!ji()&&!this._forceTurn&&!this.store.useDcSignal){if(z(wl).call(wl,e)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;let t=r=>{F_(n)&&(y.debug("[".concat(this.store.clientId,"] [P2PChannel] try to restartICE, type is ").concat(r)),Xt(this,we.QueryClientConnectionState)==="CONNECTED"&&this.emit(we.RequestRestartICE,r))},i=()=>{F_(n)&&(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),y.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(we.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())};return void(this._restartTimer=window.setTimeout(()=>{RL(n,t,i)},800))}}else{if(e==="disconnected"&&n.iceConnectionState==="disconnected")return setTimeout(()=>{n.iceConnectionState==="disconnected"&&F("ICE_RESTART")&&Xt(this,we.QueryClientConnectionState)==="CONNECTED"&&this.emit(we.RequestRestartICE)},800),void setTimeout(()=>{n.peerConnectionState==="disconnected"&&(y.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isTryConnecting=!1,setTimeout(()=>this.emit(we.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);e==="failed"&&(y.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),setTimeout(()=>this.emit(we.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},n.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),y.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),_e.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:ct.TRACER}).onSuccess(),this.emit(we.IceConnectionStateChange,e)},n.onICETransportStateChange=e=>{y.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},n.onDTLSTransportStateChange=e=>{y.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},n.onDTLSTransportError=e=>{y.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},n.onFirstAudioDecoded=e=>{var t;let i=Array.from(mo(t=this.remoteUserMap).call(t)).find(o=>o._audioSSRC===e);var r;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),(r=i.audioTrack)===null||r===void 0||r.emit(Wo.FIRST_FRAME_DECODED),_e.firstRemoteFrame(this.store.sessionId,en.FIRST_AUDIO_DECODE,Dt.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:qn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},n.onFirstAudioReceived=e=>{var t;let i=Array.from(mo(t=this.remoteUserMap).call(t)).find(r=>r._audioSSRC===e);i&&_e.firstRemoteFrame(this.store.sessionId,en.FIRST_AUDIO_RECEIVED,Dt.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:qn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},n.onFirstVideoDecoded=(e,t,i)=>{var r;let o=Array.from(mo(r=this.remoteUserMap).call(r)).find(s=>s._videoSSRC===e);o&&this.store.firstVideoFrameDecoded(o.uid,{firstDecoded:Date.now()}),this.reportVideoFirstFrameDecoded(e,t,i)},n.onFirstVideoRender=e=>{var t;let i=Array.from(mo(t=this.remoteUserMap).call(t)).find(r=>r._videoSSRC===e);i&&(this.store.firstVideoFrameDecoded(i.uid,{firstPreRender:Date.now()}),this.reportVideoFirstFrameRender(i),this.emit(we.FirstVideoPreRender,i.uid,e))},n.onFirstVideoReceived=e=>{var t;let i=Array.from(mo(t=this.remoteUserMap).call(t)).find(r=>r._videoSSRC===e);i&&(this.store.firstVideoFrameDecoded(i.uid,{firstReceived:Date.now()}),_e.firstRemoteFrame(this.store.sessionId,en.FIRST_VIDEO_RECEIVED,Dt.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:qn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},n.onFirstVideoBufferReady=e=>{var t;let i=Array.from(mo(t=this.remoteUserMap).call(t)).find(r=>r._videoSSRC===e);i&&this.emit(we.FirstVideoBufferReady,i.uid,e)},n.onSelectedLocalCandidateChanged=(e,t)=>{let i=e.candidateType==="relay",r=t.candidateType==="relay";t.candidateType!=="unknown"&&i===r||this.emit(we.ConnectionTypeChange,i),y.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(bl(t))," -> ").concat(JSON.stringify(bl(e)),")"))},n.onSelectedRemoteCandidateChanged=(e,t)=>{y.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(bl(t))," -> ").concat(JSON.stringify(bl(e)),")"))},n.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},n.getLocalVideoStats=()=>{let e=this.statsCollector.getLocalVideoTrackStats(),t=this.statsCollector.getRTCStats();return Jd(Jd({},e),t)},n.onICECandidateError=e=>{this._iceError=e}}fallbackConnection(){y.debug("[".concat(this.store.clientId,"] [P2PChannel] try to fallback connection")),this.state===ue.Connected?(y.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&this.resetConnection(this.connection),this.shouldForwardP2PCreation&&(this.connection=KT(this.store),this.emit(we.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)))}resetConnection(n){n instanceof bn&&function(e){Hu.delete(e.id),wC(e)}(n),n.close(),this.emit(we.PeerConnectionStateChange,"closed"),function(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.getLocalVideoStats=void 0}(n),this._isWaitPcToRePub=!1}filterTobeMutedTracks(n){let e=[];if(this.getAllTracks().indexOf(n)===-1)return e;let t=this.localTrackMap.get(Se.LocalAudioTrack);if(n instanceof ri&&(t==null?void 0:t.track)instanceof rn)return t.track.isActive||e.push([Se.LocalAudioTrack,t]),e;let i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return n===o});if(i&&(e.push(i),i[0]===Se.LocalVideoTrack)){let r=this.localTrackMap.get(Se.LocalVideoLowTrack);r&&e.push([Se.LocalVideoLowTrack,r])}return e}filterTobeUnmutedTracks(n){let e=[],t=this.localTrackMap.get(Se.LocalAudioTrack);if(n instanceof ri&&(t==null?void 0:t.track)instanceof rn)return t.track.isActive&&e.push([Se.LocalAudioTrack,t]),e;let i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return n===o});if(i)if(i[0]===Se.LocalVideoTrack){e.push(i);let r=this.localTrackMap.get(Se.LocalVideoLowTrack);r&&e.push([Se.LocalVideoLowTrack,r])}else e.push(i);return e}createMuteMessage(n){return n.map(e=>{var t;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case Se.LocalAudioTrack:i=_i.Audio;break;case Se.LocalVideoTrack:i=z(t=o._hints).call(t,Re.SCREEN_TRACK)?_i.Screen:_i.High;break;case Se.LocalVideoLowTrack:i=_i.Low}return{stream_type:i,ssrcs:s,mid:a}})}createUnmuteMessage(n){return n.map(e=>{var t;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case Se.LocalAudioTrack:i=_i.Audio;break;case Se.LocalVideoTrack:i=z(t=o._hints).call(t,Re.SCREEN_TRACK)?_i.Screen:_i.High;break;case Se.LocalVideoLowTrack:i=_i.Low}return{stream_type:i,ssrcs:s,mid:a}})}filterTobeUnSubscribedTracks(n,e){let t=[],i=this.remoteUserMap.get(n);if(!i)return t;if(e){let r=i.get(e);if(!r)return t;t.push([n,{kind:e,id:r}])}else Array.from(i.entries()).forEach(r=>{let[o,s]=r;t.push([n,{kind:o,id:s}])});return t}filterTobeUnSubscribedDataChannels(n,e){let t=[];return e.forEach(i=>{var r;(r=this.remoteDataChannelMap.get(n))!==null&&r!==void 0&&r.has(i.id)&&t.push(i)}),t}createUnsubscribeMessage(n){let e=[];return n.forEach(t=>{let[i,{kind:r,id:o}]=t;switch(r){case ke.VIDEO:return void(i._videoSSRC&&e.push({stream_type:ke.VIDEO,ssrcId:i._videoSSRC}));case ke.AUDIO:return void(i._audioSSRC&&e.push({stream_type:ke.AUDIO,ssrcId:i._audioSSRC}))}}),e}createUnsubscribeAllMessage(n){let e=new Map;return n.forEach(t=>{let[i,{kind:r}]=t;if(e.has(i)){let o=e.get(i);r===ke.VIDEO?o|=Xr.Video:o|=Xr.Audio,e.set(i,o)}else r===ke.VIDEO?e.set(i,Xr.Video):e.set(i,Xr.Audio)}),{users:Array.from(e.entries()).map(t=>{let[i,r]=t;return{stream_id:i.uid,stream_type:r}})}}withdrawRemoteTracks(n){n.forEach(e=>{let[t,{kind:i}]=e,r=this.remoteUserMap.get(t);r&&(r.delete(i),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(t))})}async updateBitrateLimit(n){let e=this.localTrackMap.get(Se.LocalVideoTrack),t=this.localTrackMap.get(Se.LocalVideoLowTrack);e&&(await e.track.setBitrateLimit(n.uplink),await new Z((i,r)=>{this.handleUpdateVideoEncoder(e.track,i,r,!0)})),t&&n.low_stream_uplink&&(await t.track.setBitrateLimit({max_bitrate:n.low_stream_uplink.bitrate,min_bitrate:n.low_stream_uplink.bitrate||0}),await new Z((i,r)=>{this.handleUpdateVideoEncoder(t.track,i,r,!0)}))}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}isPreallocation(){return!(!this.connection||!("name"in this.connection)||this.connection.name!=="DataChannelConnection"||this.connection.peerConnectionState==="closed")||this.connection instanceof bn&&this.connection.isPreallocation}isPreSub(){return(this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"&&this.connection.peerConnectionState!=="closed"||this.connection instanceof bn)&&this.connection.isPreSub()}isPreRender(){return this.connection instanceof bn&&this.connection.isPreRender}mapPubResToRemoteConfig(n,e,t){return n.map((i,r)=>{var o;let{stream_type:s}=i,a=(o=e.find(c=>{let{stream_type:d}=c;return s===d}))===null||o===void 0?void 0:o.attributes;if(a&&F("DISABLE_SCREEN_SHARE_REMB")){let c=t[r]._hints;(z(c).call(c,Re.SCREEN_TRACK)||z(c).call(c,Re.SCREEN_LOW_TRACK))&&(a.remb=!1,y.debug("disable remb for screen share, hints:",c))}return a})}async tryToUnmuteAudio(n){for(let t=0;t<n.length;t++)if(n[t]instanceof ri){var e;let i=this.filterTobeUnmutedTracks(n[t]);if(i.length===0)continue;await((e=this.connection)===null||e===void 0?void 0:e.unmuteLocal(i.map(o=>{let[,{id:s}]=o;return s})));let r=this.createUnmuteMessage(i);return void await yt(this,we.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=n=>{var e;return!((e=this.connection)===null||e===void 0||!e.getRemoteVideoIsReady(n))},this.statsUploader.requestUpload=(n,e)=>this.emit(we.RequestUpload,n,e),this.statsUploader.requestUploadStats=n=>this.emit(we.RequestUploadStats,n),this.statsUploader.requestAllTracks=()=>this.getAllTracks(),this.statsUploader.requestTransportStats=()=>{var n;return{connectState:((n=this.connection)===null||n===void 0?void 0:n.peerConnectionState)||"closed"}}}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await fn(yr(this.dtlsFailedCount,mr)),this.emit(we.RequestReconnect)}async reconnectP2P(){let n=Array.from(this.localTrackMap.entries()),e=this.createGatewayUnpublishMessage(n);Array.from(this.remoteUserMap.entries()),e.length>0&&await fr(this,we.RequestUnpublishForReconnectPC,e),this.disconnectForReconnect(),this.emit(we.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(Se.LocalVideoTrack)||this.pendingLocalTracks.some(n=>n instanceof Jt)}throwIfTrackTypeNotMatch(n){if(n.filter(e=>e instanceof Jt).length>1)throw new O(L.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(n.filter(e=>e instanceof ri).length>1&&(n.some(e=>e instanceof ri&&e._bypassWebAudio)||!ot().webAudioMediaStreamDest))throw new O(L.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(let e of n){if(e instanceof Jt&&this.pendingLocalTracks.some(t=>t instanceof Jt))throw new O(L.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof ri&&this.pendingLocalTracks.some(t=>t instanceof ri)&&(!ot().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(t=>t instanceof ri&&t._bypassWebAudio)))throw new O(L.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(n,e){var t;let i=!F("DISABLE_DUAL_STREAM_USE_ENCODING")&&ot().supportDualStreamEncoding,r=Jd(Jd({},{width:160,height:120,framerate:15,bitrate:50}),e),o;o=i?n._mediaStreamTrack.clone():Uo(n,r);let s=vt(8,"track-low-"),a=new Jt(o,Jd(Jd({},i&&{scaleResolutionDownBy:sC(r,n)}),{},{frameRate:r.framerate,bitrateMax:r.bitrate,bitrateMin:r.bitrate}),void 0,void 0,s);return a.on(b_.TRANSCEIVER_UPDATED,c=>{n._updateRtpTransceiver(c,ui.LOW_STREAM)}),a._hints.push(Re.LOW_STREAM),z(t=n._hints).call(t,Re.SCREEN_TRACK)&&a._hints.push(Re.SCREEN_LOW_TRACK),n.on("sei-to-send",c=>{a.emit("sei-to-send",c)}),n.addListener(Ue.NEED_CLOSE,()=>{a.close()}),a}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(n,e,t){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof bn){var r,o,s,a;let c=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:d,dtlsTransportState:l,peerConnectionState:h}=this.connection,{local:p,remote:f}=await this.connection.getSelectedCandidatePair();_e.pcStats(this.store.sessionId,{startTime:c,eventElapse:n-c||0,iceconnectionsate:d,dtlsstate:l,connectionstate:h,intSucc:e?1:2,error:this._iceError||i||"",selectedLocalCandidateProtocol:(r=p==null?void 0:p.protocol)!==null&&r!==void 0?r:"",selectedLocalCandidateType:(o=p.candidateType)!==null&&o!==void 0?o:"",selectedLocalCandidateAddress:"".concat(p.address,":").concat(p.port),selectedRemoteCandidateProtocol:(s=f.protocol)!==null&&s!==void 0?s:"",selectedRemoteCandidateType:(a=f.candidateType)!==null&&a!==void 0?a:"",selectedRemoteCandidateAddress:"".concat(f.address,":").concat(f.port),restartCnt:t,preallocation:this.connection.isPreallocation}),this._iceError=null}}reportVideoFirstFrameRender(n){let e=this.store.keyMetrics,t=e.firstVideoFrameDecoded.find(l=>l.userId===n.uid);if(!t)return;let{isInternalUpload:i,isExternalUpload:r}=t;if(i&&r)return;let{subscribeEnd:o,firstPreRender:s,peerPublishDuration:a,peerPubStatusMs:c}=t,{firstRender:d=0}=t;if(o&&(d||s)&&a&&c){t.isInternalUpload=!0;let{playEnd:l}=t;l&&(t.isExternalUpload=!0);let{firstPreRender:h=0}=t;d=h||d;let p=n.videoTrack,f={peer:n._uintid,width:(p==null?void 0:p._videoWidth)||0,height:(p==null?void 0:p._videoHeight)||0,ssrc:n._videoSSRC||0,p2pid:this.store.p2pId,peerPublishDuration:a,peerPubStatusMs:c,joinChannelStart:e.joinStart||0,preloadStart:e.preloadStart||0,preloadEnd:e.preloadEnd||0,apStart:e.requestAPStart||0,apEnd:e.requestAPEnd||0,suaEnd:e.requestSUAEnd||0,beforeConnect:e.beforeConnect||0,peerReceiver:e.peerReceiver||0,ice:e.iceConnectionEnd||0,pc:e.peerConnectionEnd||0,signalConnected:e.signalConnected||0,joinReq:e.joinReq||0,joinRes:e.joinRep||0,userJoinNotify:t.userJoinNotify||0,videoAddNotify:t.videoAddNotify||0,subscribeStart:t.subscribeStart||0,subscribeEnd:t.subscribeEnd||0,firstReceived:t.firstReceived||0,firstDecoded:t.firstDecoded||0,firstPreRender:h||0,firstRender:l?Math.max(d,l):Math.max(d,o),playStart:t.playStart||0,playEnd:t.playEnd||0,isPreSub:!(!n._videoSSRC||!this.isPreSubScribe(n._videoSSRC)),isPrePc:this.isPreallocation(),isPreInstantVideo:Wf(this.store),firstReceivedEncodedFrame:t.firstReceivedEncodedFrame||0,frameType:t.frameType||"",rtpTimestamp:t.rtpTimestamp||0,framePayloadType:t.framePayloadType||0,frameDataLength:t.frameDataLength||0,mimeType:t.mimeType||""};_e.firstXLAPeerFirstVideoFrame(this.store.sessionId,f)}}reportVideoFirstFrameDecoded(n,e,t,i){var r;let o=Array.from(mo(r=this.remoteUserMap).call(r)).find(s=>s._videoSSRC===n);if(o){i||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());let s=this.store.keyMetrics,a=s.subscribe.find(c=>c.userId===o.uid&&c.type==="video");_e.firstRemoteVideoDecode(this.store.sessionId,en.FIRST_VIDEO_DECODE,Dt.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:t,subscribeElapse:qn.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:(a==null?void 0:a.subscribeEnd)||0,subscriberStart:(a==null?void 0:a.subscribeStart)||0,videoAddNotify:(a==null?void 0:a.streamAdded)||0,state:i?1:0,firstFrame:(a==null?void 0:a.firstFrame)||0})}}async remoteMediaSsrcChanged(n,e,t){if(!this.connection)return!1;let i=this.remoteUserMap.get(n);if(!i)return!1;let r=i.get(e);if(!r)return!1;let o=await this.connection.getRemoteSSRC(r);return o!==void 0&&o!==t}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(n=>{let[e,{track:t}]=n;e===Se.LocalVideoLowTrack?t._updateRtpTransceiver(void 0,ui.LOW_STREAM):t._updateRtpTransceiver(void 0)})}},Oe(Vt.prototype,"startP2PConnection",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"startP2PConnection"),Vt.prototype),Oe(Vt.prototype,"connect",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"connect"),Vt.prototype),Oe(Vt.prototype,"updateRemoteRTPCapabilities",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"updateRemoteRTPCapabilities"),Vt.prototype),Oe(Vt.prototype,"publishDataChannel",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"publishDataChannel"),Vt.prototype),Oe(Vt.prototype,"unpublish",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"unpublish"),Vt.prototype),Oe(Vt.prototype,"unpublishDataChannel",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"unpublishDataChannel"),Vt.prototype),Oe(Vt.prototype,"unpublishLowStream",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"unpublishLowStream"),Vt.prototype),Oe(Vt.prototype,"subscribeDataChannel",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"subscribeDataChannel"),Vt.prototype),Oe(Vt.prototype,"subscribe",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"subscribe"),Vt.prototype),Oe(Vt.prototype,"massSubscribe",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"massSubscribe"),Vt.prototype),Oe(Vt.prototype,"unsubscribe",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"unsubscribe"),Vt.prototype),Oe(Vt.prototype,"unsubscribeDataChannel",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"unsubscribeDataChannel"),Vt.prototype),Oe(Vt.prototype,"massUnsubscribe",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"massUnsubscribe"),Vt.prototype),Oe(Vt.prototype,"muteRemote",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"muteRemote"),Vt.prototype),Oe(Vt.prototype,"unmuteRemote",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"unmuteRemote"),Vt.prototype),Oe(Vt.prototype,"hasRemoteMediaWithLock",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"hasRemoteMediaWithLock"),Vt.prototype),Oe(Vt.prototype,"disconnectForReconnect",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"disconnectForReconnect"),Vt.prototype),Oe(Vt.prototype,"updateBitrateLimit",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"updateBitrateLimit"),Vt.prototype),Oe(Vt.prototype,"remoteMediaSsrcChanged",[Tn],Object.getOwnPropertyDescriptor(Vt.prototype,"remoteMediaSsrcChanged"),Vt.prototype),Vt);function Tn(n,e,t){let i=n[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return t.value=async function(){let r=this.mutex,o=await r.lock("From P2PChannel.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},t}function So(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function vL(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?So(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):So(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}let d2=Date.now(),vz=20,CL=new Map,gm=new Map;async function XT(n){let e=CL.get(n),t=Array.isArray(e)&&e[e.length-1],i=gm.get(n);if(!t)return void(i.isSyncing=!1);let r={uid:t.uid,payload:t.payload};i.firstRecvTs===0&&(i.firstRecvTs=t.recvTs,i.firstSendTs=t.sendTs);let o=t.sendTs-i.firstSendTs,s=o-(Date.now()-i.firstRecvTs);s>0&&(i.firstRecvTs=Date.now()-o);let a=t.mediaDelay+s;a<=0?(e.pop(),yL(t.context,r),a=0):a=Math.min(a,vz),setTimeout(()=>e.length&&XT(n),a)}function yL(n,e){n.safeEmit(It.STREAM_MESSAGE,e.uid,e.payload),n.onStreamMessage&&n.onStreamMessage(e)}function l2(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,t=arguments.length>2?arguments[2]:void 0;if(!n.syncWithAudio)return yL(t,{uid:n.uid,payload:n.payload});let i="".concat(t.id,"-").concat(n.uid),r=CL.get(i)||[],o=r.findIndex(d=>n.sendTs>=d.sendTs),s=vL(vL({},n),{},{context:t,mediaDelay:e,recvTs:Date.now()});o===-1?r.push(s):r.splice(o,0,s),CL.set(i,r);let a=!1;var c;gm.has(i)?a=!((c=gm.get(i))===null||c===void 0||!c.isSyncing):gm.set(i,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||XT(i)}let Cz=Zt().name;function u2(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function IL(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?u2(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):u2(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}let B_="websdk_ng_cache_parameter",Sm=F("MAX_PRELOAD_ASYNC_LENGTH"),yz=1e4,j_=new Map,lc=[],Ku=null,JT=0,QT=0,Tm=new Map,ZT=new Uint8Array([241,141,127,212,103,139,200,225,251,157,127,139,143,2,22,163]),h2=function(n,e){let t=[],i=0,r=async()=>{let o=t.shift();o&&await o(),t.length>0&&i<e?r():i--};return async function(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];return new Z(async(c,d)=>{t.push(async()=>{try{let l=await n(...s);c(l)}catch(l){d(l)}}),i<e&&(i++,r())})}}(bL,Sm),AL=Qi.CancelToken.source();class wL{constructor(){U(this,"_audioContext",null)}createMuteAudioTrack(){this._audioContext=new AudioContext;let e=this._audioContext.sampleRate,t=10*e,i=this._audioContext.createBuffer(2,t,e),r=this._audioContext.createBufferSource();r.buffer=i;let o=this._audioContext.createMediaStreamDestination();return r.connect(o),r.start(),o.stream.getAudioTracks()[0]}close(){this._audioContext&&(this._audioContext.close(),this._audioContext=null)}}async function bL(n,e,t,i,r,o,s){try{if(!F("ENABLE_PRELOAD"))return;if(!ot().supportWebCrypto)return void wu(()=>{y.warn("Your browser does not support preloading, this feature  be run in a secure environment")},"preload_webcrypto_not_supported");if(!t&&t!==null)throw new O(L.INVALID_PARAMS,"Invalid token: ".concat(t,". If you don not use token, set it to null"));t&&_n(t,"token",1,2047),_n(n,"appid",1,2047),ht(e),i&&L_(i);let a=li();y.debug("preload channel ".concat(e,", uid is ").concat(i));let c={appId:n,cname:e,token:t||n,uid:typeof i!="string"?i:null,sid:a,proxyServer:r,role:s},d,l;typeof i=="string"?(c.stringUid=i,[l,d]=await Z.all([i2(i,{sid:a,appId:n},AL.token),r2(IL(IL({},c),{},{token:t||n,uid:0}),AL.token)]),c.uid=l.uid,d.gatewayInfo.uid=c.uid,d.gatewayInfo.res.uid=c.uid):(o&&(c.stringUid=o),d=await r2(c,AL.token));let h={sid:a,appId:n,cname:e,token:t||n,uid:c.stringUid||i,intUid:c.uid||d.gatewayInfo.uid,stringUid:c.stringUid,ts:Date.now(),sua:l,ap:d};await OC(h),JT++}catch(a){throw QT++,function(c){Ku||(Ku=window.setTimeout(()=>{let l="";Tm.forEach((h,p)=>{l+="".concat(p,": ").concat(h," ;")}),_e.reportApiInvoke(null,{name:Yi.PRELOAD,options:{success:JT,failed:QT,err:l}}).onError(c),JT=0,QT=0,Tm.clear(),Ku=null},yz));let d=Tm.get(c.code)||0;Tm.set(c.code,d+1)}(a),a}}async function $T(n){try{if(F("AP_REQUEST_DETAIL")||F("ENABLE_ROLE_SELECT_EDGE"))return;let e=bC(n);if(!e||n.cloudProxyServer!=="disabled")return;let t=await async function(i,r){try{let o=await window.crypto.subtle.importKey("raw",bu(r),"AES-GCM",!1,["decrypt"]),s=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:ZT},o,pa(i));return JSON.parse(window.atob(_a(new Uint8Array(s))))}catch{return}}(e,n.token||n.appId);if(!t||!function(i,r){return i.cname===r.cname&&i.appId===r.appId&&i.token===r.token?r.stringUid?i.stringUid===r.stringUid:typeof r.uid=="number"?i.uid===r.uid:i.uid==r.uid:!1}(t,n))return;if(t&&Date.now()-t.ts<F("AP_CACHE_LIFETIME"))return t}catch(e){y.warn("Error get preloadInfo",e.message)}}function bC(n){let e;try{if(e=NL(B_),!e)return;let t=JSON.parse(e),i=iR(n),r=function(s,a){for(let c=s.length-1;c>=0;c--)if(a(s[c]))return c;return-1}(t,s=>i in s);if(r===-1)return;let o=t.splice(r,1)[0];return tR(B_,JSON.stringify(t)),o[i]}catch(t){y.warn("Error delete preload info: ".concat(e),t.message),tR(B_,"")}}async function OC(n){let e;try{n.uid&&bC({appId:n.appId,cname:n.cname,token:n.token,uid:n.uid,stringUid:n.stringUid});let t=iR(n),i=await async function(o,s){try{let a=await window.crypto.subtle.importKey("raw",bu(s),"AES-GCM",!1,["encrypt"]),c=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:ZT},a,pa(window.btoa(JSON.stringify(o))));return _a(new Uint8Array(c))}catch{return}}(n,n.token||n.appId);if(!i)return;e=NL(B_);let r=e?JSON.parse(e):[];r.push({[t]:i}),r.length>F("AP_CACHE_NUM")&&r.shift(),tR(B_,JSON.stringify(r))}catch(t){y.warn("Error caching server parameters:",t.message),tR(B_,"")}}function eR(n){if(n){let e=j_.get(n);e&&(window.clearTimeout(e),e=null,j_.delete(n)),z(lc).call(lc,n)||n.cloudProxyServer!=="disabled"||lc.push(n)}if(j_.size<F("AP_CACHE_NUM")&&lc.length>0){let e=lc.shift();j_.set(e,window.setTimeout(async()=>{let{appId:t,cname:i,token:r,stringUid:o,uid:s,proxyServer:a,role:c}=e;try{await h2(t,i,r,s,a,o,c),j_.has(e)&&eR(e)}catch(d){y.warn("update preload failed",d.message),NC(e)}},F("AP_UPDATE_INTERVAL")))}}function NC(n){let e=lc.indexOf(n);e!==-1&&lc.splice(e,1);let t=j_.get(n);t&&(window.clearTimeout(t),t=null,j_.delete(n),eR())}function OL(n,e){let t=n.sua,i=n.ap;e&&t&&_e.reqUserAccount(n.sid,{lts:t.requestTime,elapse:t.elapse,success:!0,serverAddr:t.url,stringUid:e,uid:n.intUid,errorCode:null,extend:t.req}),_e.reportResourceTiming(n.ap.url,n.sid),_e.joinWebProxyAP(n.sid,{lts:i.requestTime,elapse:i.elapse,sucess:1,apServerAddr:i.url,turnServerAddrList:i.proxyInfo.addresses.map(r=>r.ip).join(","),eventType:"disabled",unilbsServerIds:[Wr.CHOOSE_SERVER,Wr.CLOUD_PROXY_FALLBACK].toString()}),_e.joinChooseServer(n.sid,{lts:i.requestTime,elapse:i.elapse,succ:!0,csAddr:i.url,opid:i.opid,serverList:i.gatewayInfo.gatewayAddrs.map(r=>r.address),ec:null,cid:i.gatewayInfo.cid.toString(),uid:i.gatewayInfo.uid.toString(),csIp:i.gatewayInfo.csIp,unilbsServerIds:[Wr.CHOOSE_SERVER].toString(),isHttp3:i.isHttp3})}function NL(n){return window.atob(window.localStorage.getItem(n)||"")}function tR(n,e){window.localStorage.setItem(n,window.btoa(e))}function iR(n){let e="".concat(n.appId,"_").concat(n.cname);return typeof n.uid=="string"&&(e+="_s_".concat(n.uid)),typeof n.uid=="number"&&(e+="_".concat(n.uid)),n.token&&(e+="_".concat(n.token)),Av(e)}function p2(n){let e=function(){let t=vm.pop();return t?(t.offset=t.limit=0,t):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(t,i){let r=t.appId;r!==void 0&&(vr(i,10),Yu(i,r));let o=t.cid;o!==void 0&&(vr(i,16),vr(i,o));let s=t.cname;s!==void 0&&(vr(i,26),Yu(i,s));let a=t.deviceId;a!==void 0&&(vr(i,34),Yu(i,a));let c=t.elapse;c!==void 0&&(vr(i,40),Yh(i,c));let d=t.fileSize;d!==void 0&&(vr(i,48),Yh(i,Rm(d)));let l=t.height;l!==void 0&&(vr(i,56),Yh(i,Rm(l)));let h=t.jpg;h!==void 0&&(vr(i,66),vr(i,h.length),LL(i,h));let p=t.networkType;p!==void 0&&(vr(i,72),Yh(i,Rm(p)));let f=t.osType;f!==void 0&&(vr(i,80),Yh(i,Rm(f)));let m=t.requestId;m!==void 0&&(vr(i,90),Yu(i,m));let g=t.sdkVersion;g!==void 0&&(vr(i,98),Yu(i,g));let S=t.sequence;S!==void 0&&(vr(i,104),Yh(i,Rm(S)));let T=t.sid;T!==void 0&&(vr(i,114),Yu(i,T));let C=t.timestamp;C!==void 0&&(vr(i,120),Yh(i,C));let b=t.uid;b!==void 0&&(vr(i,128),vr(i,b));let D=t.vid;D!==void 0&&(vr(i,136),vr(i,D));let x=t.width;x!==void 0&&(vr(i,144),Yh(i,Rm(x)));let k=t.service;k!==void 0&&(vr(i,152),vr(i,k));let V=t.callbackData;V!==void 0&&(vr(i,162),vr(i,V.length),LL(i,V));let W=t.ticket;W!==void 0&&(vr(i,170),Yu(i,W));let K=t.vendorConfigs;K!==void 0&&(vr(i,178),Yu(i,K))}(n,e),function(t){let i=t.bytes,r=t.limit;return i.length===r?i:i.subarray(0,r)}(e)}function Iz(n){return function(t){let i={};e:for(;!PL(t);){let r=Cm(t);switch(r>>>3){case 0:break e;case 1:i.code=Cm(t);break;case 2:i.msg=kL(t,Cm(t));break;case 3:i.requestId=kL(t,Cm(t));break;case 4:i.timestamp=Hr(t,!1);break;default:Az(t,7&r)}}return i}({bytes:e=n,offset:0,limit:e.length});var e}function Az(n,e){switch(e){case 0:for(;128&xo(n););break;case 2:DL(n,Cm(n));break;case 5:DL(n,4);break;case 1:DL(n,8);break;default:throw new Error("Unimplemented type: "+e)}}function Rm(n){return{low:n|=0,high:n>>31,unsigned:n>=0}}let vm=[];function DL(n,e){if(n.offset+e>n.limit)throw new Error("Skip past limit");n.offset+=e}function PL(n){return n.offset>=n.limit}function DC(n,e){let t=n.bytes,i=n.offset,r=n.limit,o=i+e;if(o>t.length){let s=new Uint8Array(2*o);s.set(t),n.bytes=s}return n.offset=o,o>r&&(n.limit=o),i}function rR(n,e){let t=n.offset;if(t+e>n.limit)throw new Error("Read past limit");return n.offset+=e,t}function LL(n,e){let t=DC(n,e.length);n.bytes.set(e,t)}function kL(n,e){let t=rR(n,e),i=String.fromCharCode,r=n.bytes,o="",s="";for(let a=0;a<e;a++){let c,d,l,h,p=r[a+t];128&p?(224&p)==192?a+1>=e?s+=o:(c=r[a+t+1],(192&c)!=128?s+=o:(h=(31&p)<<6|63&c,h<128?s+=o:(s+=i(h),a++))):(240&p)==224?a+2>=e?s+=o:(c=r[a+t+1],d=r[a+t+2],(49344&(c|d<<8))!=32896?s+=o:(h=(15&p)<<12|(63&c)<<6|63&d,h<2048||h>=55296&&h<=57343?s+=o:(s+=i(h),a+=2))):(248&p)==240?a+3>=e?s+=o:(c=r[a+t+1],d=r[a+t+2],l=r[a+t+3],(12632256&(c|d<<8|l<<16))!=8421504?s+=o:(h=(7&p)<<18|(63&c)<<12|(63&d)<<6|63&l,h<65536||h>1114111?s+=o:(h-=65536,s+=i(55296+(h>>10),56320+(1023&h)),a+=3))):s+=o:s+=i(p)}return s}function Yu(n,e){let t=e.length,i=0;for(let s=0;s<t;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<t&&(a=(a<<10)+e.charCodeAt(++s)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4}vr(n,i);let r=DC(n,i),o=n.bytes;for(let s=0;s<t;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<t&&(a=(a<<10)+e.charCodeAt(++s)-56613888),a<128?o[r++]=a:(a<2048?o[r++]=a>>6&31|192:(a<65536?o[r++]=a>>12&15|224:(o[r++]=a>>18&7|240,o[r++]=a>>12&63|128),o[r++]=a>>6&63|128),o[r++]=63&a|128)}}function xo(n){return n.bytes[rR(n,1)]}function uc(n,e){let t=DC(n,1);n.bytes[t]=e}function Cm(n){let e,t=0,i=0;do e=xo(n),t<32&&(i|=(127&e)<<t),t+=7;while(128&e);return i}function vr(n,e){for(e>>>=0;e>=128;)uc(n,127&e|128),e>>>=7;uc(n,e)}function Hr(n,e){let t,i=0,r=0,o=0;return t=xo(n),i=127&t,128&t&&(t=xo(n),i|=(127&t)<<7,128&t&&(t=xo(n),i|=(127&t)<<14,128&t&&(t=xo(n),i|=(127&t)<<21,128&t&&(t=xo(n),r=127&t,128&t&&(t=xo(n),r|=(127&t)<<7,128&t&&(t=xo(n),r|=(127&t)<<14,128&t&&(t=xo(n),r|=(127&t)<<21,128&t&&(t=xo(n),o=127&t,128&t&&(t=xo(n),o|=(127&t)<<7))))))))),{low:i|r<<28,high:r>>>4|o<<24,unsigned:e}}function Yh(n,e){let t=e.low>>>0,i=(e.low>>>28|e.high<<4)>>>0,r=e.high>>>24,o=r===0?i===0?t<16384?t<128?1:2:t<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,s=DC(n,o),a=n.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=o!==9?128|r:127&r;case 8:a[s+7]=o!==8?i>>>21|128:i>>>21&127;case 7:a[s+6]=o!==7?i>>>14|128:i>>>14&127;case 6:a[s+5]=o!==6?i>>>7|128:i>>>7&127;case 5:a[s+4]=o!==5?128|i:127&i;case 4:a[s+3]=o!==4?t>>>21|128:t>>>21&127;case 3:a[s+2]=o!==3?t>>>14|128:t>>>14&127;case 2:a[s+1]=o!==2?t>>>7|128:t>>>7&127;case 1:a[s]=o!==1?128|t:127&t}}let zu={},ML={},nR=4294967296,PC=nR*nR,wz=PC/2;f2(0,!0);let UL=f2(0),_2=ym(0,-2147483648,!1),bz=ym(-1,2147483647,!1);function f2(n,e){let t,i,r;return e?(r=0<=(n>>>=0)&&n<256)&&(i=ML[n],i)?i:(t=ym(n,0,!0),r&&(ML[n]=t),t):(r=-128<=(n|=0)&&n<128)&&(i=zu[n],i)?i:(t=ym(n,n<0?-1:0,!1),r&&(zu[n]=t),t)}function ym(n,e,t){return{low:0|n,high:0|e,unsigned:!!t}}function Im(n,e){if(isNaN(n))return UL;{if(n<=-9223372036854776e3)return _2;if(n+1>=wz)return bz}return n<0?UL:ym(n%nR|0,n/nR|0,e)}function xL(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}class LC extends Ki{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;let t=this._connectionState;this._connectionState=e,this.emit(Yn.CONNECTION_STATE_CHANGE,e,t)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(e){var t;super(),U(this,"name","AgoraRTCImageModeration"),U(this,"_connectionState",$n.CONNECTING),U(this,"_sequence",0),U(this,"_moderationStartTime",void 0),U(this,"_workerConnection",void 0),U(this,"_workerMessageLengthLimit",void 0),U(this,"_qualityRatio",void 0),U(this,"_connectInfo",void 0),U(this,"_cancelTokenSource",Qi.CancelToken.source()),U(this,"_retryConfig",void 0),U(this,"_moderationInterval",void 0),U(this,"_moderationTimer",null),U(this,"_moderationMode",1),U(this,"_quality",1),U(this,"_qualityTimer",null),U(this,"_ticket",void 0),U(this,"_moderationIntervalMinimum",void 0),U(this,"_uploadFailedNum",0),U(this,"_uploadNum",0),U(this,"_uploadTimer",null),U(this,"_extraInfo",void 0),U(this,"_vendor",""),U(this,"_encoder",new TextEncoder),U(this,"_moderationId",void 0),U(this,"inspectImage",()=>{if(this.connectionState!==$n.CONNECTED)throw new H(L.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===$n.CONNECTED?this.requestToInspectImage():y.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=vt(5,"image-moderation-"),this._workerMessageLengthLimit=F("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=F("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(t=e.interval)!==null&&t!==void 0?t:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=F("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new M_("worker-"+this._moderationId,mr),this.on(Yn.STATE_CHANGE,(i,r)=>{y.debug("[".concat(this._moderationId,"] Moderation operation :").concat(Os[i]," ").concat(r||""))}),this.handleWorkerEvents()}async init(e,t){this.emit(Yn.STATE_CHANGE,Os.CONNECT_AP),this._connectInfo=e;let i=this._cancelTokenSource.token;return this._retryConfig=t,new Z((r,o)=>{this.on(Yn.CONNECTION_STATE_CHANGE,(s,a)=>{s===$n.CONNECTED&&r()}),this.requestAP(e,i,t).then(s=>{this.connectWorker(s)}).catch(s=>{o(s)})})}updateConfig(e){var t;this._moderationInterval=(t=e.interval)!==null&&t!==void 0?t:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),y.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===$n.CONNECTED&&this.inspectImage()}async requestAP(e,t,i){let r=F("WEBCS_DOMAIN").map(c=>"https://".concat(c,"/api/v1")),o=await function(c,d,l,h){let{appId:p,areaCode:f,cname:m,sid:g,token:S,uid:T}=d;hm++;let C="moderation_plugin",b={service_name:C,json_body:JSON.stringify({appId:p,areaCode:f,cname:m,command:"allocateEdge",requestId:hm,seq:hm,sid:g,appToken:S,ts:Date.now(),uid:T+""})},D,x,k=c[0];return fa(async()=>{D=Date.now();let V=await cc(k,{data:b,cancelToken:l,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(x=Date.now()-D,V.code!==0){let se=new H(L.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+V.code,{retry:!0,responseTime:x});throw y.error(se.toString()),se}let W=JSON.parse(V.json_body);if(W.code!==200){let se=new H(L.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(W.code,", reason: ").concat(W.reason),{code:W.code,responseTime:x});throw y.error(se.toString()),se}if(!W.servers||!Array.isArray(W.servers)||W.servers.length===0){let se=new H(L.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:W.code,responseTime:x});throw y.error(se.toString()),se}if(!W.servers.some(se=>!!se.wss)){let se=new H(L.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:W.code,responseTime:x});throw y.error(se.toString()),se}let K=F("IMAGE_MODERATION_WORKER_WSS");if(K)return{addressList:[K],workerToken:W.workerToken,vid:W.vid,responseTime:x};let J=F("IMAGE_MODERATION_WORKER_HOST");return{addressList:W.servers.map(se=>{let{address:Ne,wss:Ce}=se;if(Ne&&Ce)return"wss://".concat(Ne.replace(/\./g,"-"),".").concat(J,":").concat(Ce,"/moderation")}).filter(se=>!!se),workerToken:W.workerToken,vid:W.vid,ticket:W.appTicket,responseTime:x}},(V,W)=>(_e.apworkerEvent(g,{success:!0,sc:200,serviceName:C,responseDetail:JSON.stringify(V.addressList),firstSuccess:W===0,responseTime:x,serverIp:c[W%c.length]}),!1),(V,W)=>(_e.apworkerEvent(g,{success:!1,sc:V.data&&V.data.code||200,serviceName:C,responseTime:x,serverIp:c[W%c.length]}),!!(V.code!==L.OPERATION_ABORTED&&V.code!==L.UNEXPECTED_RESPONSE||V.data&&V.data.retry)&&(k=c[(W+1)%c.length],!0)),h)}(r,e,t,i);this.emit(Yn.STATE_CHANGE,Os.AP_CONNECTED);let{addressList:s,ticket:a}=o;return this._ticket=a,s}async connectWorker(e){this.emit(Yn.STATE_CHANGE,Os.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(Je.CONNECTED,async()=>{this.emit(Yn.STATE_CHANGE,Os.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=$n.CONNECTED}),this._workerConnection.on(Je.CLOSED,()=>{this.connectionState=$n.CLOSED}),this._workerConnection.on(Je.FAILED,()=>{this.connectionState=$n.CLOSED}),this._workerConnection.on(Je.RECONNECTING,()=>{this.connectionState=this.connectionState===$n.CONNECTED?$n.RECONNECTING:$n.CONNECTING}),this._workerConnection.on(Je.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){let t=Iz(new Uint8Array(e.data));F("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&y.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(t)),this._uploadNum++,t.code===void 0||t.code===0||(this._uploadFailedNum++,y.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(t.code,", msg is ").concat(t.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{_e.reportApiInvoke(this._connectInfo.sid||null,{name:Yi.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,t.code],tag:ct.TRACER}).onError(new H(L.IMAGE_MODERATION_UPLOAD_FAILED,t.msg)),this._uploadTimer=null},F("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else y.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(Je.WILL_RECONNECT,(e,t,i)=>{e==="recover"&&i(e),i("tryNext")}),this._workerConnection.on(Je.REQUEST_NEW_URLS,(e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)})}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){let e=Xt(this,Yn.CLIENT_LOCAL_VIDEO_TRACK),t={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(F("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&y.debug("Only the track being played can be inspected"));this._sequence++;let i=await this.generateRequestData(e,t);this._workerConnection.sendMessage(i,!0,!0)}else F("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&y.debug("Only the track being published can be inspected")}async generateRequestData(e,t){let{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c}=t,d=Date.now(),l=await e.getCurrentFrameImage("image/jpeg",this.quality),h=await nD(l,i,r),p=this._sequence+"-"+o+"-"+c+"-"+d+"-"+vt(12,""),f={appId:i,cid:o,cname:r,deviceId:"",elapse:LC.intToLong(Number(d-this._moderationStartTime)),fileSize:l.buffer.byteLength,height:l.height,width:l.width,jpg:h,networkType:6,osType:7,requestId:p,sdkVersion:"4.24.2",sequence:this._sequence,sid:a,timestamp:Im(d),uid:c,vid:s,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete f.callbackData;let m=p2(f);if(m.byteLength<this._workerMessageLengthLimit){if(F("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){let g=function(S){for(var T=1;T<arguments.length;T++){var C=arguments[T]!=null?arguments[T]:{};T%2?xL(Object(C),!0).forEach(function(b){U(S,b,C[b])}):Object.getOwnPropertyDescriptors?Object.defineProperties(S,Object.getOwnPropertyDescriptors(C)):xL(Object(C)).forEach(function(b){Object.defineProperty(S,b,Object.getOwnPropertyDescriptor(C,b))})}return S}({},f);delete g.jpg,y.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(g))}return m}{let g=this.quality*this._qualityRatio;return this.quality=g,await this.generateRequestData(e,{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Qi.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=$n.CLOSED,this.emit(Yn.STATE_CHANGE,Os.CLOSED)}}function kC(n){if(Rt(n.interval,"interval",1e3,1/0),n&&n.extraInfo&&n.extraInfo.length>1024)throw new H(L.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(n&&n.vendor&&n.vendor.length>1024)throw new H(L.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}let m2={name:"ImageModeration",create:function(n){let{config:e}=n;return kC(e),new LC(e)}};var E2,VL,FL,BL,jL,GL,WL,HL,KL,YL,zL,qL,XL,JL,QL,ZL,$L,ek,tk,ik,rk,nk,ok,sk,ak,ck,dk,lk,uk,hk,pk,_k,fk,mk,Ek,gk,Sk,Tk,Rk,vk,Ck,yk,Pe;function Le(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function hc(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Le(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):Le(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}mn.setLogger(y);let Wc=(E2=Xe(),VL=Xe({argsMap:(n,e)=>{if(!Array.isArray(e)){if(!(e instanceof O_))return[e];e=[e]}return e.map(t=>t?Object(t).toString():"null")}}),FL=Xe({argsMap:(n,e)=>(e||(e=[]),Array.isArray(e)||e.trackMediaType!==Ho.DATA?(Array.isArray(e)||(e=[e]),e.map(t=>t.getTrackId())):[e.getChannelId()])}),BL=Xe({argsMap:(n,e,t,i)=>[typeof e=="object"?e.uid:e,t,i]}),jL=Xe({argsMap:(n,e,t)=>[e,t]}),GL=Xe({argsMap:(n,e)=>e.map(t=>{let{user:i,mediaType:r}=t;return[i==null?void 0:i.uid,r]})}),WL=Xe({argsMap:(n,e,t,i)=>[typeof e=="object"?e.uid:e,t,i]}),HL=Xe({argsMap:(n,e)=>e.map(t=>{let{user:i,mediaType:r}=t;return{uid:i==null?void 0:i.uid,mediaType:r}})}),KL=Xe(),YL=Xe(),zL=Xe(),qL=Xe(),XL=Xe(),JL=Xe(),QL=Xe(),ZL=Xe(),$L=Xe(),ek=Xe(),tk=Xe(),ik=Xe(),rk=Xe(),nk=Xe(),ok=Xe(),sk=Xe(),ak=Xe({argsMap:(n,e)=>[e]}),ck=Xe(),dk=Xe(),lk=Xe(),uk=Xe(),hk=Xe(),pk=Xe(),_k=Xe(),fk=Xe(),mk=Xe({argsMap:(n,e)=>(Array.isArray(e)||(e=[e]),[JSON.stringify(e)])}),Ek=Xe(),gk=Xe(),Sk=Xe(),Tk=Xe(),Rk=Xe(),vk=Xe(),Ck=Xe({reportResult:!0}),yk=Xe(),Pe=class extends Ki{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var n;return((n=this._config)===null||n===void 0?void 0:n.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(n,e){let t;if(super(),U(this,"store",void 0),U(this,"_uid",void 0),U(this,"_channelName",void 0),U(this,"_uintUid",void 0),U(this,"_users",[]),U(this,"_config",void 0),U(this,"_clientId",void 0),U(this,"_appId",void 0),U(this,"_sessionId",null),U(this,"_key",void 0),U(this,"_rtmConfig",{}),U(this,"_joinInfo",void 0),U(this,"_gateway",void 0),U(this,"_statsCollector",void 0),U(this,"_configDistribute",void 0),U(this,"_leaveMutex",void 0),U(this,"_publishMutex",void 0),U(this,"_renewTokenMutex",void 0),U(this,"_subscribeMutex",void 0),U(this,"_encryptionMode","none"),U(this,"_encryptionSecret",null),U(this,"_encryptionSalt",null),U(this,"_encryptDataStream",!1),U(this,"_encryptDataStreamKey",null),U(this,"_encryptDataStreamIv",null),U(this,"_proxyServer",void 0),U(this,"_turnServer",{servers:[],mode:"auto"}),U(this,"_cloudProxyServerMode","disabled"),U(this,"_isDualStreamEnabled",!1),U(this,"_defaultStreamFallbackType",void 0),U(this,"_lowStreamParameter",void 0),U(this,"_streamFallbackTypeCacheMap",new Map),U(this,"_remoteStreamTypeCacheMap",new Map),U(this,"_axiosCancelSource",Qi.CancelToken.source()),U(this,"_audioVolumeIndicationInterval",void 0),U(this,"_networkQualityInterval",void 0),U(this,"_userOfflineTimeout",void 0),U(this,"_streamRemovedTimeout",void 0),U(this,"_rteDetailInterval",void 0),U(this,"_liveTranscodeStreamingClient",void 0),U(this,"_liveRawStreamingClient",void 0),U(this,"_channelMediaRelayClient",void 0),U(this,"_networkQualitySensitivity","normal"),U(this,"_p2pChannel",void 0),U(this,"_useLocalAccessPoint",!1),U(this,"_setLocalAPVersion",void 0),U(this,"_joinAndNotLeaveYet",!1),U(this,"_numberOfJoinCount",0),U(this,"_joinResponse",null),U(this,"_remoteDefaultVideoStreamType",void 0),U(this,"_inspect",void 0),U(this,"_moderation",void 0),U(this,"_license",void 0),U(this,"_pendingPublishedUsers",[]),U(this,"ntpAlignErrorCount",0),U(this,"remoteInboundOffset",0),U(this,"_peerConnectionState",void 0),U(this,"_pendingRtpCapabilityChange",void 0),U(this,"_fallbackServerInfo",void 0),U(this,"_dualStreamMode",void 0),U(this,"_handleLocalTrackEnable",(r,o,s)=>{this.publish(r,!1).then(o).catch(s)}),U(this,"_handleLocalTrackDisable",(r,o,s)=>{this.unpublish(r).then(o).catch(s)}),U(this,"_handleUserOnline",r=>{if(F("BLOCK_LOCAL_CLIENT")&&kc(r.uid,this.channelName))return void y.debug("[".concat(r.uid,"] will be ignored in local"));this.isStringUID&&typeof r.uid!="string"&&y.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));let o=this._users.find(s=>s.uid===r.uid);if(o)o._trust_in_room_=!0,o._is_pre_created&&(o._is_pre_created=!1,this.safeEmit(It.USER_JOINED,o));else{let s=new Bu(r.uid,r.uint_id||r.uid);this._users.push(s),y.debug("[".concat(this._clientId,"] user online"),r.uid),this.store.firstVideoFrameDecoded(s.uid,{userJoinNotify:Date.now()}),this.safeEmit(It.USER_JOINED,s)}}),U(this,"_handleUserOffline",r=>{if(F("BLOCK_LOCAL_CLIENT")&&kc(r.uid,this.channelName))return;let o=this._users.find(s=>s.uid===r.uid);o&&(this._handleRemoveStream(r),this._handleRemoveDataChannels(r),o._audio_pre_subscribed||o._video_pre_subscribed?o._is_pre_created=!0:Cv(this._users,o),this._remoteStreamTypeCacheMap.delete(o.uid),this._streamFallbackTypeCacheMap.delete(o.uid),y.debug("[".concat(this._clientId,"] user offline"),r.uid,"reason:",r.reason),this.safeEmit(It.USER_LEAVED,o,r.reason))}),U(this,"_handleAddAudioOrVideoStream",(r,o,s,a,c,d,l,h)=>{if(F("BLOCK_LOCAL_CLIENT")&&kc(o,this.channelName))return;let p=this._users.find(g=>g.uid===o);if(!p)return void y.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));y.debug("[".concat(this._clientId,"] stream added with uid ").concat(o,", type ").concat(r)),this.store.subscribe(p.uid,r,void 0,void 0,void 0,Date.now()),r==="video"&&this.store.firstVideoFrameDecoded(p.uid,{videoAddNotify:Date.now()});let f=r==="audio"?p.hasAudio:p.hasVideo;p._uintid||(p._uintid=d||o),r==="audio"?p._trust_audio_stream_added_state_=!0:p._trust_video_stream_added_state_=!0,r==="audio"?(p._audio_added_=!0,s!==void 0&&(p._audioSSRC=s),a!==void 0&&(p._cname=a),l&&(p._audioOrtc=l)):(p._video_added_=!0,s!==void 0&&(p._videoSSRC=s),a!==void 0&&(p._cname=a),h!==void 0&&(p._rtxSsrcId=h),l&&(p._videoOrtc=l)),(r==="audio"?p.hasAudio:p.hasVideo)&&!f&&(y.info("[".concat(this._clientId,"] remote user ").concat(p.uid," published ").concat(r)),this.safeEmit(It.USER_PUBLISHED,p,r)),r==="video"?_e.onGatewayStream(this._sessionId,en.ON_ADD_VIDEO_STREAM,Dt.ON_ADD_VIDEO_STREAM,{peer:d||o,ssrc:p._videoSSRC}):_e.onGatewayStream(this._sessionId,en.ON_ADD_AUDIO_STREAM,Dt.ON_ADD_AUDIO_STREAM,{peer:d||o,ssrc:p._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(p,r,s).then(g=>{if(g&&(y.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(p.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Ml))return this._p2pChannel.unsubscribe(p,r,!0).then(()=>this._subscribe(p,r,!0).catch(S=>{y.error("[".concat(this._clientId,"] resubscribe error"),S.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(p,r)&&(y.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(p.uid," after reconnect.")),this._subscribe(p,r,!0).catch(g=>{y.error("[".concat(this._clientId,"] resubscribe error"),g.toString())}));let m=this._getEncodingName(c);r==="video"&&(m==="unknown"?this.safeEmit(It.AV1_DECODABLE_RESULT,!1):Cr()||Ht()||(m==null?void 0:m.toLocaleLowerCase())!==tt.av1||t2().then(g=>{F("FLS_ENABLE_AV1_DECODE_DETECT")&&this.safeEmit(It.AV1_DECODABLE_RESULT,g),g||this._gateway.downgradeCodec(m)}))}),U(this,"_handleRemoveStream",r=>{if(F("BLOCK_LOCAL_CLIENT")&&kc(r.uid,this.channelName))return;let o=this._users.find(a=>a.uid===r.uid);if(!o)return void y.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));y.debug("[".concat(this._clientId,"] stream removed with uid ").concat(r.uid));let s=()=>{};o.hasAudio&&o.hasVideo?s=()=>{y.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(It.USER_UNPUBLISHED,o,"audio"),y.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(It.USER_UNPUBLISHED,o,"video")}:o.hasVideo?s=()=>{y.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(It.USER_UNPUBLISHED,o,"video")}:o.hasAudio&&(s=()=>{y.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(It.USER_UNPUBLISHED,o,"audio")}),o._video_pre_subscribed||o._audio_pre_subscribed||(o._trust_audio_stream_added_state_=!0,o._trust_video_stream_added_state_=!0,o._audio_added_=!1,o._video_added_=!1,this._p2pChannel instanceof Ml&&this._p2pChannel.unsubscribe(o).then(a=>{if(a)return this._gateway.unsubscribe(a,o.uid)}),o._audioSSRC=void 0,o._videoSSRC=void 0,o._audioOrtc=void 0,o._videoOrtc=void 0,o._rtxSsrcId=void 0),_e.onGatewayStream(this._sessionId,en.ON_REMOVE_STREAM,Dt.ON_REMOVE_STREAM,{peer:r.uint_id||r.uid}),s()}),U(this,"_handleSetStreamLocalEnable",(r,o,s)=>{if(F("BLOCK_LOCAL_CLIENT")&&kc(o,this.channelName))return;let a=this._users.find(l=>l.uid===o);if(!a)return void y.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));y.debug("[".concat(this._clientId,"] local ").concat(r," ").concat(s?"enabled":"disabled"," with uid ").concat(o));let c=r==="audio"?a.hasAudio:a.hasVideo;if(r==="audio"){a._trust_audio_enabled_state_=!0;let l=a._audio_enabled_;if(a._audio_enabled_=s,a._audio_enabled_===l)return;{let h=a._audio_enabled_?"enable-local-audio":"disable-local-audio";y.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(o,", msg: ").concat(h)),this.safeEmit(It.USER_INFO_UPDATED,o,h)}}else{a._trust_video_enabled_state_=!0;let l=a._video_enabled_;if(a._video_enabled_=s,a._video_enabled_===l)return;{let h=a._video_enabled_?"enable-local-video":"disable-local-video";y.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(o,", msg: ").concat(h)),this.safeEmit(It.USER_INFO_UPDATED,o,h)}}let d=r==="audio"?a.hasAudio:a.hasVideo;return c!==d?!c&&d?(y.info("[".concat(this._clientId,"] remote user ").concat(o," published ").concat(r)),void this.safeEmit(It.USER_PUBLISHED,a,r)):(r==="video"&&a._videoTrack&&a._videoTrack._destroy(),r==="audio"&&a._audioTrack,this._p2pChannel.muteRemote(a,r),y.info("[".concat(this._clientId,"] remote user ").concat(o," unpublished ").concat(r)),void this.safeEmit(It.USER_UNPUBLISHED,a,r)):void 0}),U(this,"_handleMuteStream",(r,o,s)=>{if(F("BLOCK_LOCAL_CLIENT")&&kc(r,this.channelName))return;y.debug("[".concat(this._clientId,"] receive mute message"),r,o,s);let a=this._users.find(l=>l.uid===r);if(!a)return void y.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r));let c=o==="audio"?a.hasAudio:a.hasVideo;if(o==="audio"){a._trust_audio_mute_state_=!0;let l=a._audio_muted_;if(a._audio_muted_=s,a._audio_muted_===l)return;{let h=a._audio_muted_?"mute-audio":"unmute-audio";y.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(h)),this.safeEmit(It.USER_INFO_UPDATED,r,h)}}else{a._trust_video_mute_state_=!0;let l=a._video_muted_;if(a._video_muted_=s,a._video_muted_===l)return;{let h=a._video_muted_?"mute-video":"unmute-video";y.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(h)),this.safeEmit(It.USER_INFO_UPDATED,r,h)}}let d=o==="audio"?a.hasAudio:a.hasVideo;if(c!==d){if(!c&&d)return(o==="audio"?a._audioSSRC:a._videoSSRC)?(y.info("[".concat(this._clientId,"] remote user ").concat(r," published ").concat(o)),void this.safeEmit(It.USER_PUBLISHED,a,o)):void y.warning("[".concat(this._clientId,"] remote user ").concat(r," receive ").concat(o," unmute message  before add stream message, ").concat(o," SSRC doesn't exist yet."));o==="video"&&a._videoTrack&&!a._video_pre_subscribed&&a._videoTrack._destroy(),o==="audio"&&a._audioTrack,this._p2pChannel.muteRemote(a,o),y.info("[".concat(this._clientId,"] remote user ").concat(r," unpublished ").concat(o)),this.safeEmit(It.USER_UNPUBLISHED,a,o)}}),U(this,"_handleP2PLost",async r=>{y.debug("[".concat(this._clientId,"] receive p2p lost"),r),parseInt(r.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():y.warning("[".concat(this._clientId,"] P2PLost stream not found"),r)}),U(this,"_handleTokenWillExpire",()=>{y.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(It.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),U(this,"_handleBeforeUnload",r=>{r.type==="beforeunload"&&r.returnValue!==void 0&&r.returnValue!==""||(this.leave(),y.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),U(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(It.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});let r={downlinkNetworkQuality:0,uplinkNetworkQuality:0};r.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),r.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(It.NETWORK_QUALITY,r)}),U(this,"_handleP2PAddAudioOrVideoStream",(r,o,s,a)=>{let c=this._users.find(l=>l.uid===o);if(!c)return void y.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));y.debug("[".concat(this._clientId,"] stream added with uid ").concat(o,", type ").concat(r)),this.store.subscribe(c.uid,r,void 0,void 0,void 0,Date.now());let d=r==="audio"?c.hasAudio:c.hasVideo;r==="audio"?c._trust_audio_stream_added_state_=!0:c._trust_video_stream_added_state_=!0,r==="audio"?(c._audio_added_=!0,s!==void 0&&(c._audioSSRC=s),a!==void 0&&(c._audioMid=a)):(c._video_added_=!0,s!==void 0&&(c._videoSSRC=s),a!==void 0&&(c._videoMid=a)),(r==="audio"?c.hasAudio:c.hasVideo)&&!d&&(y.info("[".concat(this._clientId,"] remote user ").concat(c.uid," published ").concat(r)),this.safeEmit(It.USER_PUBLISHED,c,r)),this._p2pChannel.hasPendingRemoteMedia(c,r)&&(y.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(c.uid," after reconnect.")),this._subscribe(c,r,!0).catch(l=>{y.error("[".concat(this._clientId,"] resubscribe error"),l.toString())}))}),this._config=n,this._clientId=e||vt(5,"client-"),this.store=new class{constructor(r,o,s,a,c){at(this,"state",void 0),this.state={codec:r,audioCodec:o,mode:s,clientId:a,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,keyMetrics:{publish:[],subscribe:[],firstVideoFrameDecoded:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useP2P:!1,p2pTransport:Nu.Default,hasStartJoinChannel:!1,isABTestSuccess:!1,rteUrl:void 0,rteSid:void 0,autoSubscribe:!1,enableInstantMuteRestore:!1,networkQualityProbe:!1,useDcSignal:!!c}}dispatch(r){this.state=function(o,s){switch(s.type){case Ye.SET_SESSION_ID:return Te(Te({},o),{},{sessionId:s.sessionId});case Ye.SET_P2P_ID:return Te(Te({},o),{},{p2pId:s.p2pId});case Ye.SET_UID:return Te(Te({},o),{},{uid:s.uid});case Ye.SET_INT_UID:return Te(Te({},o),{},{intUid:s.intUid});case Ye.SET_PUB_ID:return Te(Te({},o),{},{pubId:s.pubId});case Ye.KEY_METRIC_CLIENT_CREATED:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{clientCreated:s.metric})});case Ye.KEY_METRIC_JOIN_START:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{joinStart:s.metric})});case Ye.KEY_METRIC_PRELOAD_START:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{preloadStart:s.metric})});case Ye.KEY_METRIC_PRELOAD_END:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{preloadEnd:s.metric})});case Ye.KEY_METRIC_JOIN_END:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{joinEnd:s.metric})});case Ye.KEY_METRIC_REQUEST_AP_START:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{requestAPStart:s.metric})});case Ye.KEY_METRIC_REQUEST_AP_END:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{requestAPEnd:s.metric})});case Ye.KEY_METRIC_REQUEST_SUA_END:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{requestSUAEnd:s.metric})});case Ye.KEY_METRIC_BEFORE_CONNECT:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{beforeConnect:s.metric})});case Ye.KEY_METRIC_PEER_RECEIVER:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{peerReceiver:s.metric})});case Ye.KEY_METRIC_SIGNAL_CONNECTED:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{signalConnected:s.metric})});case Ye.KEY_METRIC_JOIN_REQ:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{joinReq:s.metric})});case Ye.KEY_METRIC_JOIN_REP:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{joinRep:s.metric})});case Ye.KEY_METRIC_JOIN_GATEWAY_START:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{joinGatewayStart:s.metric})});case Ye.KEY_METRIC_JOIN_GATEWAY_END:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{joinGatewayEnd:s.metric})});case Ye.KEY_METRIC_PEER_CONNECTION_START:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{peerConnectionStart:s.metric})});case Ye.KEY_METRIC_PEER_CONNECTION_END:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{peerConnectionEnd:s.metric})});case Ye.KEY_METRIC_DESCRIPTION_START:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{descriptionStart:s.metric})});case Ye.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{signalChannelOpen:s.metric})});case Ye.KEY_METRIC_ICE_CONNECTION_END:return Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{iceConnectionEnd:s.metric})});case Ye.KEY_METRIC_PUBLISH:{let a=o.keyMetrics.publish,c=a.findIndex(d=>d.trackId===s.metric.trackId);return c!==-1?(a[c]=Te(Te({},a[c]),s.metric),Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{publish:[...a]})})):Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{publish:[...o.keyMetrics.publish,s.metric]})})}case Ye.KEY_METRIC_SUBSCRIBE:{let a=o.keyMetrics.subscribe,c=a.findIndex(d=>d.userId===s.metric.userId&&d.type===s.metric.type);return c!==-1?(a[c]=Te(Te({},a[c]),s.metric),Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{subscribe:[...a]})})):Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{subscribe:[...o.keyMetrics.subscribe,s.metric]})})}case Ye.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED:{let a=o.keyMetrics.firstVideoFrameDecoded,c=a.findIndex(d=>d.userId===s.metric.userId);return c!==-1?(a[c]=Te(Te({},a[c]),s.metric),Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{firstVideoFrameDecoded:[...a]})})):Te(Te({},o),{},{keyMetrics:Te(Te({},o.keyMetrics),{},{firstVideoFrameDecoded:[...o.keyMetrics.firstVideoFrameDecoded,s.metric]})})}case Ye.RESET_FIRST_VIDEO_FRAME_DECODED:return o.keyMetrics.firstVideoFrameDecoded=[],o;case Ye.SET_CLOUD_PROXY_SERVER_MODE:return o.cloudProxyServerMode=s.mode,o;case Ye.RECORD_JOIN_CHANNEL_SERVICE:return typeof s.index!="number"?o.joinChannelServiceRecords=[...o.joinChannelServiceRecords,s.record]:(o.joinChannelServiceRecords[s.index]=Te(Te({},o.joinChannelServiceRecords[s.index]),s.record),o.joinChannelServiceRecords=[...o.joinChannelServiceRecords]),o;case Ye.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return o.joinChannelServiceRecords=[],o;case Ye.RESET_KEY_METRICS:return o.keyMetrics={publish:[],subscribe:[],firstVideoFrameDecoded:[]},o;case Ye.SET_USE_P2P:return Te(Te({},o),{},{useP2P:s.val});case Ye.SET_TRANSPORT_TYPE:return Te(Te({},o),{},{p2pTransport:s.val});case Ye.SET_RTE_URL:return Te(Te({},o),{},{rteUrl:s.rteUrl});case Ye.SET_RTE_SID:return Te(Te({},o),{},{rteSid:s.rteSid});default:return o}}(this.state,r)}get useDcSignal(){return this.state.useDcSignal}set useDcSignal(r){this.state.useDcSignal=r}set autoSubscribe(r){this.state.autoSubscribe=r}get autoSubscribe(){return this.state.autoSubscribe}set enableInstantMuteRestore(r){this.state.enableInstantMuteRestore=r}get enableInstantMuteRestore(){return this.state.enableInstantMuteRestore}set networkQualityProbe(r){this.state.networkQualityProbe=r}get networkQualityProbe(){return this.state.networkQualityProbe}set sessionId(r){this.dispatch({type:Ye.SET_SESSION_ID,sessionId:r})}get sessionId(){return this.state.sessionId}set rteUrl(r){this.dispatch({type:Ye.SET_RTE_URL,rteUrl:r})}get rteUrl(){return this.state.rteUrl}set rteSid(r){this.dispatch({type:Ye.SET_RTE_SID,rteSid:r})}get rteSid(){return this.state.rteSid}set cid(r){this.state.cid=r}get cid(){return this.state.cid}set codec(r){this.state.codec=r}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(r){this.dispatch({type:Ye.SET_P2P_ID,p2pId:r})}get p2pId(){return this.state.p2pId}set dcId(r){this.dispatch({type:Ye.SET_DC_ID,dcId:r})}get dcId(){return this.state.dcId}set uid(r){this.dispatch({type:Ye.SET_UID,uid:r})}get uid(){return this.state.uid}set intUid(r){this.dispatch({type:Ye.SET_INT_UID,intUid:r})}get intUid(){return this.state.intUid}set pubId(r){this.dispatch({type:Ye.SET_PUB_ID,pubId:r})}get pubId(){return this.state.pubId}set cloudProxyServerMode(r){this.dispatch({type:Ye.SET_CLOUD_PROXY_SERVER_MODE,mode:r})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useP2P(r){this.dispatch({type:Ye.SET_USE_P2P,val:r})}get useP2P(){return this.state.useP2P}set p2pTransport(r){this.dispatch({type:Ye.SET_TRANSPORT_TYPE,val:r})}get p2pTransport(){return this.state.p2pTransport}set hasStartJoinChannel(r){this.state.hasStartJoinChannel=r}get hasStartJoinChannel(){return this.state.hasStartJoinChannel}set isABTestSuccess(r){this.state.isABTestSuccess=r}get isABTestSuccess(){return this.state.isABTestSuccess}clientCreated(){this.dispatch({type:Ye.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:Ye.KEY_METRIC_JOIN_START,metric:Date.now()})}preloadStart(){this.dispatch({type:Ye.KEY_METRIC_PRELOAD_START,metric:Date.now()})}preloadEnd(){this.dispatch({type:Ye.KEY_METRIC_PRELOAD_END,metric:Date.now()})}joinEnd(){this.dispatch({type:Ye.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:Ye.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:Ye.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}requestSUAEnd(){this.dispatch({type:Ye.KEY_METRIC_REQUEST_SUA_END,metric:Date.now()})}beforeConnect(){this.dispatch({type:Ye.KEY_METRIC_BEFORE_CONNECT,metric:Date.now()})}peerReceiver(){this.dispatch({type:Ye.KEY_METRIC_PEER_RECEIVER,metric:Date.now()})}signalConnected(){this.dispatch({type:Ye.KEY_METRIC_SIGNAL_CONNECTED,metric:Date.now()})}joinReq(){this.dispatch({type:Ye.KEY_METRIC_JOIN_REQ,metric:Date.now()})}joinRep(){this.dispatch({type:Ye.KEY_METRIC_JOIN_REP,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:Ye.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:Ye.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:Ye.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:Ye.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}firstVideoFrameDecoded(r,o){this.dispatch({type:Ye.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED,metric:Te({userId:r},o)})}descriptionStart(){this.dispatch({type:Ye.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:Ye.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:Ye.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(r,o,s,a){this.dispatch({type:Ye.KEY_METRIC_PUBLISH,metric:Te(Te({trackId:r,type:o},s&&{publishStart:s}),a&&{publishEnd:a})})}subscribe(r,o,s,a,c,d,l){this.dispatch({type:Ye.KEY_METRIC_SUBSCRIBE,metric:Te(Te(Te(Te(Te({userId:r,type:o},s&&{subscribeStart:s}),a&&{subscribeEnd:a}),c&&{firstFrame:c}),d&&{streamAdded:d}),l&&{firstDecoded:l})})}massSubscribe(r,o,s,a){r.forEach(c=>{this.dispatch({type:Ye.KEY_METRIC_SUBSCRIBE,metric:Te(Te(Te({userId:c.userId,type:c.type},o&&{subscribeStart:o}),s&&{subscribeEnd:s}),a&&{firstFrame:a})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(r,o){r.service==="gateway"&&Array.isArray(r.urls)&&(r.urls=r.urls.map(s=>s.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof o!="number"?(this.dispatch({type:Ye.RECORD_JOIN_CHANNEL_SERVICE,record:Te(Te({},r),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(o<0||o>=this.state.joinChannelServiceRecords.length||this.dispatch({type:Ye.RECORD_JOIN_CHANNEL_SERVICE,record:r,index:o}),o)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:Ye.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:Ye.RESET_KEY_METRICS})}resetFirstVideoFrameDecoded(){this.dispatch({type:Ye.RESET_FIRST_VIDEO_FRAME_DECODED})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}}(n.codec,n.audioCodec,n.mode,this._clientId,F("SIGNAL_CHANNEL")===1),this._leaveMutex=new mn("client-leave",this._clientId),this._publishMutex=new mn("client-publish",this._clientId),this._renewTokenMutex=new mn("client-renewtoken",this._clientId),this._subscribeMutex=new mn("client-subscribe",this._clientId),this.store.clientCreated(),n.proxyServer&&this.setProxyServer(n.proxyServer,!0),n.turnServer&&this.setTurnServer(n.turnServer,!0),y.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(Js," build: ").concat(oT,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),n.clientRoleOptions)try{Oh(n.clientRoleOptions),t=Object.assign({},n.clientRoleOptions)}catch(r){y.warning("[".concat(this._clientId,"] ").concat(r.toString()))}var i;this._statsCollector=new Xd(this.store),this._statsCollector.onStatsException=(r,o,s)=>{y.warn("[".concat(this._clientId,"] receive exception msg, code: ").concat(r,", msg: ").concat(o,", uid: ").concat(s)),r===uL.VIDEO_ENCODE_FAILED&&this.localTracks.forEach(a=>{a instanceof yi&&F("ENABLE_ENCODE_EXCEPTION")&&a.findClosestProfile()}),this.safeEmit(It.EXCEPTION,{code:r,msg:o,uid:s})},this._statsCollector.onUploadPublishDuration=(r,o,s,a)=>{let c=this._users.find(d=>d.uid===r);c&&(this.store.keyMetrics&&(this.store.firstVideoFrameDecoded(c.uid,{peerPublishDuration:s,peerPubStatusMs:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(c)),_e.peerPublishStatus(this._sessionId,{subscribeElapse:a,audioPublishDuration:o,videoPublishDuration:s,peer:c._uintid}))},this._statsCollector.onVideoCodecChanged=r=>{if(F("VIDEO_STANDARD_BITRATE_VERSION")&&(r==="av1"||r==="h265"||r==="h264")){let o=this.localTracks.find(s=>s instanceof Jt);o&&o._saveEncodeBitrateRatio!==1&&o.setSaveEncodeBitrateRatio(r==="h264"?F("BASELINE_MORE_H264_BITRATE_RATIO"):void 0)}},this.store.useP2P=n.mode==="p2p",this._gateway=new $P(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:n.websocketRetryConfig||mr,httpRetryConfig:n.httpRetryConfig||mr,forceWaitGatewayResponse:n.forceWaitGatewayResponse===void 0||n.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:n.role,clientRoleOptions:t}),this._configDistribute=new lL(this._clientId,this.store),this.store.useP2P?(this._p2pChannel=(i={store:this.store,statsCollector:this._statsCollector},go("P2PChannel").create(i)),this._handleP2PEvents()):this._p2pChannel=new Ml(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(n,e,t,i,r){let o=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],s=arguments.length>6&&arguments[6]!==void 0&&arguments[6];$e("JOIN_GATEWAY_USE_443PORT_ONLY",o),$e("JOIN_GATEWAY_USE_DUAL_DOMAIN",s);let a=this._gateway.signal.websocket;return a instanceof oC&&(a.use443PortOnly=o,a.tryDoubleDomain=s),async function(c,d,l){Ih.get(c)||Ih.set(c,[]),v_.get(c)||v_.set(c,d),ec.get(c)||ec.set(c,0);let h=Ih.get(c),p=v_.get(c);if(!h||!p)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(ec.get(c)===p){let T=ZS();h.push(T),await T.promise}ec.set(c,ec.get(c)+1);for(var f=arguments.length,m=new Array(f>3?f-3:0),g=3;g<f;g++)m[g-3]=arguments[g];let S=await l(...m);return ec.set(c,ec.get(c)-1),ec.get(c)===p-1&&h.length>0&&(h[0].resolve(),h.shift()),ec.get(c)===0&&(Ih.set(c,[]),v_.set(c,0),ec.set(c,0)),S}("client.join",F("JOIN_MAX_CONCURRENCY"),this.join.bind(this),n,e,t,i,r)}async join(n,e,t,i,r){let o=++this._numberOfJoinCount;this.store.joinStart(),i&&(this.store.uid=i);let s=(ma||ma||(ma=(window.location.protocol.split(":")[0]||"").toUpperCase(),ma))==="HTTPS",a=CU()?window.isSecureContext:"Browser Not Support";(!CU()&&!s||!window.isSecureContext)&&y.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser");let c;_e.setAppId(n);try{if(!t&&t!==null)throw new H(L.INVALID_PARAMS,"Invalid token: ".concat(t,". If you don not use token, set it to null"));if(t&&_n(t,"token",1,2047),_n(n,"appid",1,2047),ht(e),i&&L_(i),r)if(typeof r=="string")_n(r,"optionalInfo",1,256),c=r;else{if(typeof r!="object")throw new H(L.INVALID_PARAMS,"Invalid options: options is not a string or object");{let{autoSubscribe:S,enableInstantMuteRestore:T,networkQualityProbe:C}=r;S&&(oe(S,"autoSubscribe"),y.info("[".concat(this._clientId,"] join: autoSubscribe: ").concat(S)),this.store.autoSubscribe=S),T&&(oe(T,"enableInstantMuteRestore"),y.info("[".concat(this._clientId,"] join: enableInstantMuteRestore: ").concat(T)),this.store.enableInstantMuteRestore=T),C&&(oe(C,"networkQualityProbe"),y.info("[".concat(this._clientId,"] join: networkQualityProbe: ").concat(C)),this.store.networkQualityProbe=C)}}}catch(S){throw _e.reportApiInvoke(li(),{name:Yi.JOIN,options:[n,e,t,i],states:{isHttps:s,isSecureContext:a},tag:ct.TRACER}).onError(S),S}if(this._leaveMutex.isLocked&&(y.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),y.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){let S=new H(L.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw _e.reportApiInvoke(li(),{name:Yi.JOIN,options:[n,e,t,i],states:{isHttps:s,isSecureContext:a},tag:ct.TRACER}).onError(S),S}this._gateway.state="CONNECTING",this.store.preloadStart();let d=await $T({appId:n,cname:e,uid:i,stringUid:typeof i=="string"?i:void 0,token:t||n,cloudProxyServer:this._cloudProxyServerMode});if(this.store.preloadEnd(),!this._joinAndNotLeaveYet)throw new H(L.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));let l=(d==null?void 0:d.sid)||li();y.info("[".concat(this._clientId,"] start join channel ").concat(e,", join number: ").concat(o)),this._sessionId||(this._sessionId=l,this.store.sessionId=this._sessionId);let h=_e.reportApiInvoke(this._sessionId,{id:this._clientId,name:Yi.JOIN,options:[n,e,t,i],states:{isHttps:s,isSecureContext:a},tag:ct.TRACER}),p=hc(hc(hc({},this._rtmConfig),{},{role:this.role,clientId:this._clientId,appId:n,sid:this._sessionId,cname:e,uid:typeof i!="string"?i:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:t||n,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:c,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!d},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType}),{},{apRequestDetail:F("AP_REQUEST_DETAIL")||void 0});if(this._useLocalAccessPoint&&(p.setLocalAPVersion=this._setLocalAPVersion),typeof i=="string"&&(p.stringUid=i,this._uintUid?(p.uid=this._uintUid,this._uintUid=void 0):p.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(p.aesmode=this._encryptionMode,p.aespassword=await(async S=>{let T=function(x){let k=window.atob(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),V=new Uint8Array(new ArrayBuffer(k.length));for(let W=0;W<k.length;W+=1)V[W]=k.charCodeAt(W);return V}(),C=await window.crypto.subtle.importKey("spki",T,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),b=Sv(S),D=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},C,b);return function(x){let k="";for(let V=0;V<x.length;V+=1)k+=String.fromCharCode(x[V]);return window.btoa(k)}(new Uint8Array(D))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new H(L.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(p.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){let S=new TextEncoder,T=F("USE_PURE_ENCRYPTION_MASTER_KEY")?S.encode(p.appId+this._encryptionSecret+this._encryptionSecret):S.encode(p.appId+p.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(C,b,D){let x=await window.crypto.subtle.importKey("raw",b,"PBKDF2",!1,["deriveBits","deriveKey"]),k=C==="aes-128-gcm2"?128:256,V=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:AU,hash:"SHA-256",salt:D},x,k+IU);return new Uint8Array(V).subarray(k/8)}(this._encryptionMode,T,pa(this._encryptionSalt)),this._encryptDataStreamKey=await async function(C,b,D){let x=await window.crypto.subtle.importKey("raw",b,"PBKDF2",!1,["deriveBits","deriveKey"]),k=C==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:AU,hash:"SHA-256",salt:D},x,{name:"AES-GCM",length:k},!0,["encrypt","decrypt"])}(this._encryptionMode,T,pa(this._encryptionSalt))}else a?y.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):y.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,y.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:e,appId:n,stringUid:p.stringUid});let f=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&f===this._sessionId&&_e.joinChannelTimeout(this._sessionId,5)},5e3);try{var m;let S,T=p.cloudProxyServer;if(z(m=["proxy3","proxy4","proxy5"]).call(m,T)){let k=F("PROXY_SERVER_TYPE3");Array.isArray(k)?p.proxyServer=k[0]:p.proxyServer=k}if(_e.setProxyServer(p.proxyServer),y.setProxyServer(p.proxyServer),this.store.requestAPStart(),d){if(y.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(p.stringUid?", ".concat(p.stringUid," => ").concat(d.intUid):""," ")),p.stringUid&&!p.uid&&(p.uid=d.intUid),S={gatewayInfo:d.ap.gatewayInfo},F("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&p.turnServer.mode==="auto")if(d.ap.proxyInfo.addresses.length===0)y.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{let k=(await rm(d.ap.proxyInfo,d.ap.gatewayInfo.uid)).map(V=>({turnServerURL:V.address,tcpport:V.tcpport||Yr.tcpport,udpport:V.udpport||Yr.udpport,username:V.username||Yr.username,password:V.password||Yr.password,forceturn:!1,security:!0}));p.turnServer={mode:"manual",servers:k}}OL(d,p.stringUid)}else{if(p.stringUid&&!p.uid){let k;[k,S]=await Z.all([cL(p.stringUid,p,this._axiosCancelSource.token,this._config.httpRetryConfig||mr,this.store).finally(()=>{this.store.requestSUAEnd()}),FT(p,this._axiosCancelSource.token,this._config.httpRetryConfig||mr,!0,this.store).finally(()=>{this.store.requestAPEnd()})]),y.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(p.stringUid," => ").concat(k)),p.uid=k,S.gatewayInfo.uid=k,S.gatewayInfo.res.uid=k}else S=await FT(p,this._axiosCancelSource.token,this._config.httpRetryConfig||mr,!0,this.store);if(!this._joinAndNotLeaveYet)throw new H(L.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(p,this._axiosCancelSource.token),this._configDistribute.on(Aa.UPDATE_BITRATE_LIMIT,k=>{this._p2pChannel.updateBitrateLimit(k)}),this._configDistribute.on(Aa.UPDATE_CLIENT_ROLE_OPTIONS,k=>{this._setClientRoleOptions(k)}),this._configDistribute.on(Aa.UPDATE_REMOTE_VIDEO_STREAM_TYPE,k=>{var V;z(V=[0,1,4,5,6,7,8,9]).call(V,k)&&(this.remoteUsers.forEach(W=>{this._remoteStreamTypeCacheMap.get(W.uid)!==k&&this.setRemoteVideoStreamType(W.uid,k)}),this.setRemoteDefaultVideoStreamType(k))}),this._configDistribute.on(Aa.FALLBACK_TO_HLS,k=>{k&&this.safeEmit(It.FALLBACK_TO_HLS,At.CONFIG)}),this._configDistribute.on(Aa.UPDATE_VOS_CONFIGURE,k=>{this._gateway.setConfigure(k).catch(V=>{y.debug("[".concat(this._clientId,"] auto set vos config failed"),V)})})},0),this._key=t||n;let C=S.gatewayInfo,b=p.uid?p.uid:C.uid;this._joinInfo=hc(hc({},p),{},{cid:C.cid,uid:b,vid:C.vid,apResponse:C.res,apGatewayAddress:C.apGatewayAddress,uni_lbs_ip:C.uni_lbs_ip,gatewayAddrs:C.gatewayAddrs}),this.store.intUid=b,this.store.cid=C.cid;let D=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new H(L.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));h.onSuccess(D),this._appId=n,this._channelName=p.cname,this._uid=D,this.store.uid=D,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),!Cr()&&this.store.useDcSignal?(window.addEventListener("beforeunload",this._handleBeforeUnload),window.addEventListener("pagehide",this._handleBeforeUnload)):window.addEventListener(Cr()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()},0);let x=p.stringUid?"string uid: ".concat(p.stringUid,",uid: ").concat(p.uid):"uid: ".concat(this._uid);return y.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(e,",").concat(x)),setTimeout(()=>{y.startUpload()},5e3),this.store.joinEnd(),g=this,z(Vh).call(Vh,g)||Vh.push(g),this._cloudProxyServerMode==="disabled"&&ot().supportWebCrypto&&F("ENABLE_PRELOAD")&&eR(this._joinInfo),this._rteDetailInterval&&(window.clearInterval(this._rteDetailInterval),this._rteDetailInterval=void 0),this._sessionId&&_e.reportRteDetail(this._sessionId),this._rteDetailInterval=window.setInterval(()=>{this._sessionId&&_e.reportRteDetail(this._sessionId)},F("RTE_DETAIL_REPORT_INTERVAL")||6e4),D}catch(S){let T=Array.isArray(S)?S[0]:S;throw T&&T.code===L.OPERATION_ABORTED?y.warning("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),T):y.error("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),T),T.code!==L.OPERATION_ABORTED&&this._numberOfJoinCount===o&&(this._gateway.state="DISCONNECTED",this._reset()),h.onError(T),T}var g}async _joinGateway(){if(!this._joinInfo||!this._key)throw new H(L.INVALID_OPERATION);try{return await this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!F("JOIN_WITH_FALLBACK_SIGNAL_PROXY")))}catch(n){if(n.code===L.INIT_DATACHANNEL_TIMEOUT){if(this._gateway.leave(!0,Gt.FALLBACK),y.debug("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new H(L.INVALID_OPERATION);return _e.reportApiInvoke(this._sessionId,{name:Yi.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:ct.TRACER}).onSuccess(),await this._joinGateway()}throw n}}async leave(){y.info("[".concat(this._clientId,"] Leaving channel"));let n=()=>{!Cr()&&this.store.useDcSignal?(window.addEventListener("beforeunload",this._handleBeforeUnload),window.addEventListener("pagehide",this._handleBeforeUnload)):window.addEventListener(Cr()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(t){let i=Vh.indexOf(t);i!==-1&&Vh.splice(i,1)}(this),this._statsCollector.stopUpdateStats()};this.store.useDcSignal||n();let e=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return y.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void e();await this._gateway.leave(this.connectionState!=="CONNECTED",Gt.LEAVE),y.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),e(),this.store.useDcSignal&&n()}async publish(n){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(n)){if(!(n instanceof O_))return this._publishDataChannel(n);n=[n]}if(n.length===0)throw new H(L.INVALID_PARAMS,"param list is empty");let t=n;if(this._gateway.role==="audience")throw new H(L.INVALID_OPERATION,"audience can not publish stream");for(let r of t){if(!(r instanceof O_))throw new H(L.INVALID_PARAMS,"parameter is not local track");if(!r._enabled&&e)throw new H(L.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(r.getTrackId()))}y.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(t.map(r=>"".concat(r.getTrackId()," "))));let i=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),e&&t.forEach(r=>{let o=this._configDistribute.getBitrateLimit();r instanceof Jt&&o&&r.setBitrateLimit(o.uplink)});try{await this._publishHighStream(t),y.info("[".concat(this._clientId,"] Publish success, id ").concat(t.map(r=>"".concat(r.getTrackId()," "))))}catch(r){throw y.error("[".concat(this._clientId,"] publish error"),r.toString()),r}finally{i()}}async _publishDataChannel(n){if(n==null)throw new H(L.INVALID_PARAMS,"parameter is not local track or datachannel config, config is ".concat(JSON.stringify(n)));Rt(n.id,"id",0,65535,!0),oe(n.ordered,"ordered"),_n(n.metadata,"metadata",0,512),y.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(n.id));let e=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(r=>r.id===n.id)!==-1)throw new H(L.INVALID_PARAMS,"Invalid id: ".concat(n.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new H(L.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&F("FORCE_TURN")&&!F("TURN_ENABLE_TCP")&&!F("TURN_ENABLE_UDP"))throw new H(L.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");let t=function(r){return Fc(r,!1)}(n),i=await this._p2pChannel.publishDataChannel([t]);if(i.length>0){if(typeof t._originDataChannelId!="number")throw y.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new H(L.CREATE_DATACHANNEL_ERROR);try{await Z.all(i.map(r=>this._uid&&this._gateway.publishDataChannel(this._uid,r,!0))),await t._waitTillOpen()}catch(r){if(r.code!==L.DISCONNECT_P2P)throw r}}return y.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(t.id)),t}catch(t){throw y.error("[".concat(this._clientId,"] publish datachannels error"),t.toString()),t}finally{e()}}async unpublish(n){if(!this._joinInfo||this._uid===void 0)throw new H(L.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let e=[];if(n)if(Array.isArray(n))e=n;else{if(!(n instanceof O_))return this._unpublishDataChannel([n]);e=[n]}else this.store.useP2P||await this._unpublishDataChannel(),e=this._p2pChannel.getAllTracks(!0);y.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(e.map(i=>"".concat(i.getTrackId()," "))," "));let t=await this._publishMutex.lock();try{if(this.store.useP2P){let i=await this._p2pChannel.unpublish(e);i&&await this._gateway.sendExtensionMessage(ar.UNPUBLISH,{unpubMsg:i},!0)}else{let i=await this._p2pChannel.unpublish(e);i&&await this._gateway.unpublish(i,this._uid),y.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(e.map(r=>"".concat(r.getTrackId()))))}}catch(i){throw y.error("[".concat(this._clientId,"] unpublish error"),i.toString()),i}finally{t&&t()}}async _unpublishDataChannel(n){n!==void 0&&n.length!==0||(n=this._p2pChannel.getAllDataChannels()),y.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(n.map(t=>"".concat(t.id," "))," "));let e=await this._publishMutex.lock();try{let t=await this._p2pChannel.unpublishDataChannel(n);t&&await this._gateway.unpublishDataChannel(t),y.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(n.map(i=>"".concat(i.id))))}catch(t){throw y.error("[".concat(this._clientId,"] unpublish dataChannel error"),t.toString()),t}finally{e&&e()}}async subscribe(n,e,t){if(!(n instanceof Bu)){let i=this.remoteUsers.find(r=>r.uid===n);if(!i)throw new H(L.INVALID_REMOTE_USER,"user is not in the channel");n=i}return e==="datachannel"?this._subscribeDataChannel(n,t):this._subscribe(n,e)}async presubscribe(n,e){if(xi(e,"mediaType",["audio","video"]),this.store.useP2P)throw new H(L.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new H(L.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));let t=e===ke.AUDIO,i=e===ke.VIDEO,r=await this._subscribeMutex.lock();try{let{ssrcId:o,ortc:s,rtxSsrcId:a,cname:c,uint_id:d}=await this._gateway.presubscribe(n,e,!0);if(o==null)throw new H(L.UNEXPECTED_RESPONSE,"no ssrc id");let l=this._users.find(p=>p.uid===n);l||(l=new Bu(n,d||n),l._is_pre_created=!0,this._users.push(l)),c&&(l._cname=c),l._uintid||(l._uintid=d||n),t&&(l._audioSSRC=o,l._audio_pre_subscribed=!0,s&&(l._audioOrtc=s)),i&&(l._videoSSRC=o,l._video_pre_subscribed=!0,s&&(l._videoOrtc=s),a!=null&&(l._rtxSsrcId=a)),y.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(o)),await this._p2pChannel.subscribe(l,e,o,a,s);let h=t?l._audioTrack:l._videoTrack;if(!h)throw new H(L.UNEXPECTED_ERROR,"can not find remote track in user");return t&&(l._trust_audio_stream_added_state_=!0,l._audio_added_=!0),i&&(l._trust_video_stream_added_state_=!0,l._video_added_=!0),h}catch(o){throw y.error("[".concat(this._clientId,"] presub user ").concat(n," error"),o),o}finally{r()}}async _subscribeDataChannel(n,e){var t;if(Rt(e,"channelId",0,65535,!0),!this._joinInfo)throw new H(L.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(s=>s===n))throw y.error("[".concat(this._clientId,"] can not subscribe ").concat(n.uid,", this user is not in the channel")),new H(L.INVALID_REMOTE_USER,"user is not in the channel");if(!n.hasAudio&&!n.hasVideo&&n._dataChannels.length===0)throw y.error("[".concat(this._clientId,"] can not subscribe ").concat(n.uid,", user is not published")),new H(L.INVALID_REMOTE_USER,"user is not published");let i=(t=n._dataChannels)===null||t===void 0?void 0:t.find(s=>s.id===e);if(!i)throw y.error("[".concat(this._clientId,"] can not subscribe ").concat(n.uid," with mediaType datachannel, remote datachannel is not published")),new H(L.REMOTE_USER_IS_NOT_PUBLISHED);let r=await this._subscribeMutex.lock();y.info("[".concat(this._clientId,"] subscribe user ").concat(n.uid,", mediaType: datachannel"));try{let s=await this._p2pChannel.subscribeDataChannel(n,[i]);if(s&&z(s).call(s,i.id))try{var o;if(typeof i._originDataChannelId!="number")throw y.error("[".concat(this._clientId,"] can not subscribe ").concat(n.uid," with mediaType datachannel, cannot get RTCDatachannel")),new H(L.CREATE_DATACHANNEL_ERROR);let a={id:i.id,datachannelId:i._originDataChannelId,ordered:i.ordered,maxRetransmits:i.maxRetransmits,metadata:(o=i.metadata)!==null&&o!==void 0?o:""};await this._gateway.subscribeDataChannel(n.uid,a,!0),await i._waitTillOpen()}catch(a){if((a==null?void 0:a.code)!==L.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(n,[i]),a;await this._p2pChannel.unsubscribeDataChannel(n,[i]),this._p2pChannel.setPendingRemoteDataChannel(n,i.id)}return y.info("[".concat(this._clientId,"] subscribe success user ").concat(n.uid,", mediaType: datachannel")),i}finally{r()}}async _p2pSubscribe(n,e,t){if(xi(e,"mediaType",["audio","video"]),!this._joinInfo)throw new H(L.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(r=>r===n)){let r=new H(L.INVALID_REMOTE_USER,"user is not in the channel");throw y.error("[".concat(this._clientId,"] can not subscribe ").concat(n.uid,", this user is not in the channel")),r}if(!n.hasAudio&&!n.hasVideo){let r=new H(L.INVALID_REMOTE_USER,"user is not published");throw y.error("[".concat(this._clientId,"] can not subscribe ").concat(n.uid,", user is not published")),r}if(!t&&(e==="audio"&&!n.hasAudio||e==="video"&&!n.hasVideo)){let r=new H(L.REMOTE_USER_IS_NOT_PUBLISHED);throw y.error("[".concat(this._clientId,"] can not subscribe ").concat(n.uid," with mediaType ").concat(e,", remote track is not published")),r}let i=await this._subscribeMutex.lock();y.info("[".concat(this._clientId,"] subscribe user ").concat(n.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(n,e))await this._p2pChannel.unmuteRemote(n,e);else try{let o=e==="audio"?n._audioSSRC:n._videoSSRC,s=e==="audio"?n._audioMid:n._videoMid;this.store.subscribe(n.uid,e,Date.now()),this.store.useP2P&&await this._p2pChannel.subscribe(n,e,o,s)}catch(o){throw o}y.info("[".concat(this._clientId,"] subscribe success user ").concat(n.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType!==void 0&&this.setStreamFallbackOption(n.uid,this._defaultStreamFallbackType).catch(o=>{y.warning("[".concat(this._clientId,"] auto set fallback failed"),o)});let r=e==="audio"?n._audioTrack:n._videoTrack;if(!r)throw new H(L.UNEXPECTED_ERROR,"can not find remote track in user object");return r}catch(r){throw y.error("[".concat(this._clientId,"] subscribe user ").concat(n.uid," error"),r),r}finally{i()}}async _subscribe(n,e,t){if(this.store.useP2P)return this._p2pSubscribe(n,e);if(xi(e,"mediaType",["audio","video"]),!this._joinInfo)throw new H(L.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(c=>c===n)){let c=new H(L.INVALID_REMOTE_USER,"user is not in the channel");throw y.error("[".concat(this._clientId,"] can not subscribe ").concat(n.uid,", this user is not in the channel")),c}if(!n.hasAudio&&!n.hasVideo){let c=new H(L.INVALID_REMOTE_USER,"user is not published");throw y.error("[".concat(this._clientId,"] can not subscribe ").concat(n.uid,", user is not published")),c}if(!(t||(e!=="audio"||n.hasAudio&&n._audioSSRC!==void 0)&&(e!=="video"||n.hasVideo&&n._videoSSRC!==void 0))){let c=new H(L.REMOTE_USER_IS_NOT_PUBLISHED);throw y.error("[".concat(this._clientId,"] can not subscribe ").concat(n.uid," with mediaType ").concat(e,", remote track is not published")),c}let i=e==="audio"?n._audioSSRC:n._videoSSRC,r=e==="audio"?n._audioOrtc:n._videoOrtc,o=e==="video"?n._rtxSsrcId:void 0,s={stream_type:e==="audio"?ke.AUDIO:ke.VIDEO,ssrcId:i};e==="video"&&this.store.firstVideoFrameDecoded(n.uid,{subscribeStart:Date.now()});let a=await this._subscribeMutex.lock();y.info("[".concat(this._clientId,"] subscribe user ").concat(n.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(n,e))await this._p2pChannel.unmuteRemote(n,e);else try{let d=e==="audio"?n._audioSSRC:n._videoSSRC;d!==void 0&&d!==i&&(i=d,r=e==="audio"?n._audioOrtc:n._videoOrtc,o=e==="video"?n._rtxSsrcId:void 0,s={stream_type:e==="audio"?ke.AUDIO:ke.VIDEO,ssrcId:i}),qn.markSubscribeStart(this.store.clientId,i),this.store.subscribe(n.uid,e,Date.now()),await this._p2pChannel.subscribe(n,e,i,o,r);try{this._p2pChannel.isPreSubScribe(i)||await this._gateway.subscribe(n.uid,s,!0)}catch(l){if((l==null?void 0:l.code)!==L.WS_ABORT)throw await this._p2pChannel.unsubscribe(n,e),l;await this._p2pChannel.unsubscribe(n,e,!0),this._p2pChannel.setPendingRemoteMedia(n,e)}this.store.subscribe(n.uid,e,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,n,e)}catch(d){throw this._p2pChannel.reportSubscribeEvent(!1,d==null?void 0:d.code,n,e),d}y.info("[".concat(this._clientId,"] subscribe success user ").concat(n.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType!==void 0&&this.setStreamFallbackOption(n.uid,this._defaultStreamFallbackType).catch(d=>{y.warning("[".concat(this._clientId,"] auto set fallback failed"),d)});let c=e==="audio"?n._audioTrack:n._videoTrack;if(!c)throw new H(L.UNEXPECTED_ERROR,"can not find remote track in user object");return e==="video"&&(this.store.firstVideoFrameDecoded(n.uid,{subscribeEnd:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(n)),c}catch(c){throw y.error("[".concat(this._clientId,"] subscribe user ").concat(n.uid," error"),c),c}finally{a()}}async massSubscribe(n){if(Ar(n,"subscribeList"),!this._joinInfo)throw new H(L.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));let e=Date.now(),t=new Map,i=await this._subscribeMutex.lock();y.info("[".concat(this._clientId,"]start massSubscribe user ").concat(n.map(a=>{let{user:c,mediaType:d}=a;return"user: ".concat(c==null?void 0:c.uid,", mediaType: ").concat(d)}).join("; ")));let r=(n=[...n]).map(a=>{let{user:c,mediaType:d}=a;return{user:c,mediaType:d}}),o=await this._p2pChannel.globalLock();try{var s;for(let c=n.length-1;c>=0;c--){let d=n[c],{user:l,mediaType:h}=d;if(xi(h,"mediaType",["audio","video"]),!l){let m=new H(L.INVALID_PARAMS,"user property does not exist in subscribeList item");throw y.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),m}if(!this._users.find(m=>m===l)){let m=new H(L.INVALID_REMOTE_USER,"user is not in the channel");y.error("[".concat(this._clientId,"] can not massSubscribe ").concat(l.uid,", this user is not in the channel")),r[c].error=m,n.splice(c,1);continue}if(h==="audio"&&(!l.hasAudio||l._audioSSRC===void 0)||h==="video"&&(!l.hasVideo||l._videoSSRC===void 0)){let m=new H(L.REMOTE_USER_IS_NOT_PUBLISHED);y.error("[".concat(this._clientId,"] can not subscribe ").concat(l.uid," with mediaType ").concat(h,", remote user is not published")),r[c].error=m,n.splice(c,1);continue}let p=Xr.Video|Xr.LwoVideo,f=t.get(l);if(f){if(h==="video"?f&p:f&Xr.Audio){n.splice(c,1),y.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(l.uid,", mediaType:").concat(h," twice"));continue}t.set(l,f|(h==="video"?p:Xr.Audio))}else t.set(l,h==="video"?p:Xr.Audio)}for(let c=n.length-1;c>=0;c--){let d=n[c],{user:l,mediaType:h}=d,p=Xr.Video|Xr.LwoVideo;if(this._p2pChannel.hasRemoteMedia(l,h)){await this._p2pChannel.unmuteRemoteNoLock(l,h);let f=t.get(l);t.set(l,h==="video"?f^p:f^Xr.Audio),n.splice(c,1)}}this.store.massSubscribe(n.map(c=>({userId:c.user.uid,type:c.mediaType})),e);let a=un(s=Array.from(t.entries())).call(s,(c,d)=>{let[l,h]=d;if(h===0)return c;let p={stream_id:l.uid,stream_type:h};return h&Xr.Audio&&(p.audio_ssrc=l._audioSSRC),h&Xr.Video&&(p.video_ssrc=l._videoSSRC),c.push(p),c},[]);try{n.length>0&&await this._p2pChannel.massSubscribeNoLock(n.map(d=>{let{user:l,mediaType:h}=d;return{user:l,mediaType:h,ssrcId:h===ke.VIDEO?l._videoSSRC:l._audioSSRC,rtxSsrcId:h===ke.VIDEO?l._rtxSsrcId:void 0}}));let c=new Map;if(a=a.filter(d=>d.video_ssrc&&!this._p2pChannel.isPreSubScribe(d.video_ssrc)||d.audio_ssrc&&!this._p2pChannel.isPreSubScribe(d.audio_ssrc)||!d.video_ssrc&&!d.audio_ssrc),a.length>0){let d=await this._gateway.subscribeAll(a,!0);((d==null?void 0:d.users)||[]).forEach(l=>{let{stream_id:h,video_error_code:p,audio_error_code:f,error_code:m}=l;(p||f||m)&&c.set(h,{video_error_code:p,audio_error_code:f,error_code:m})})}if(Array.from(c.entries()).length>0){let d=[];Array.from(c.entries()).forEach(l=>{let[h,p]=l,f=this.remoteUsers.find(m=>m.uid===h);if(f){let m;p.error_code||p.video_error_code&&p.audio_error_code?m=void 0:p.video_error_code?m=ke.VIDEO:p.audio_error_code&&(m=ke.AUDIO),d.push({user:f,mediaType:m})}}),d.length>0&&await this._p2pChannel.massUnsubscribeNoLock(d)}for(let d of r){let l=c.get(d.user.uid);if(l){let h=l.error_code||d.mediaType==="audio"&&l.audio_error_code||d.mediaType==="video"&&l.video_error_code;if(h){let p=k_(h);y.error("user:".concat(d.user.uid," mediaType:").concat(d.mediaType," has massSubscribe error ").concat(p.desc)),d.error=new H(L.SUBSCRIBE_FAILED,"code ".concat(h,": ").concat(p.desc))}}d.error||(d.mediaType==="video"?d.track=d.user.videoTrack:d.track=d.user.audioTrack)}return this.store.massSubscribe(r.filter(d=>!d.error).map(d=>({userId:d.user.uid,type:d.mediaType})),void 0,Date.now()),r.forEach(d=>{var l;_e.subscribe(this.store.sessionId,{succ:!!d.error,ec:((l=d.error)===null||l===void 0?void 0:l.code)||null,video:d.mediaType===ke.VIDEO,audio:d.mediaType===ke.AUDIO,peerid:d.user.uid,subscribeRequestid:d.mediaType===ke.VIDEO?d.user._videoSSRC:d.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-e),preSsrc:this._p2pChannel.isPreSubScribe(d.user._videoSSRC)},!0)}),y.info("[".concat(this._clientId,"] massSubscribe success ").concat(n.map(d=>{let{user:l,mediaType:h}=d;return"user: ".concat(l==null?void 0:l.uid,", mediaType: ").concat(h)}).join("; "))),r}catch(c){throw await this._p2pChannel.massUnsubscribeNoLock(n),c}}finally{o(),i()}}async unsubscribe(n,e,t){if(!(n instanceof Bu)){let r=this.remoteUsers.find(o=>o.uid===n);if(!r)throw new H(L.INVALID_REMOTE_USER,"user is not in the channel");n=r}if(e||this.store.useP2P){if(e==="datachannel")return this._unsubscribeDataChannel(n,t)}else await this._unsubscribeDataChannel(n,t);if(e&&xi(e,"mediaType",["audio","video"]),!this._joinInfo)throw new H(L.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(r=>r===n)){let r=new H(L.INVALID_REMOTE_USER,"user is not in the channel");throw y.error("[".concat(this._clientId,"] can not unsubscribe ").concat(n.uid,", user is not in the channel")),r}y.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(n.uid,", mediaType: ").concat(e));let i=await this._subscribeMutex.lock();try{if(this.store.useP2P)await this._p2pChannel.unsubscribe(n,e);else{let r=await this._p2pChannel.unsubscribe(n,e);r&&await this._gateway.unsubscribe(r,n.uid),e&&e!=="audio"||(n._audio_pre_subscribed=!1),e&&e!=="video"||(n._video_pre_subscribed=!1),n._is_pre_created&&Cv(this._users,n),y.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(n.uid,", mediaType: ").concat(e))}}catch(r){if(r.code===L.DISCONNECT_P2P)return void y.warning("disconnecting p2p, abort unsubscribe request.");throw y.error("[".concat(this._clientId,"] unsubscribe user ").concat(n.uid," error"),r.toString()),r}finally{i()}}async _unsubscribeDataChannel(n,e){if(e&&Rt(e,"id",0,65535,!0),!this._joinInfo)throw new H(L.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(i=>i===n)){let i=new H(L.INVALID_REMOTE_USER,"user is not in the channel");throw y.error("[".concat(this._clientId,"] can not unsubscribe ").concat(n.uid,", user is not in the channel")),i}let t;if(typeof e=="number"){let i=n._dataChannels.find(r=>r.id===e);i&&(t=[i])}else t=n._dataChannels;if(t===void 0){let i=new H(L.REMOTE_USER_IS_NOT_PUBLISHED);throw y.error("[".concat(this._clientId,"] can not unsubscribe ").concat(n.uid," with channelId ").concat(e,", remote datachannel is not published")),i}y.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(n.uid,", mediaType: datachannel, ids: ").concat(t.map(i=>i.id)));try{let i=await this._p2pChannel.unsubscribeDataChannel(n,t);i&&await this._gateway.unsubscribeDataChannel(i,n.uid),y.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(n.uid,", mediaType: datachannel, ids: ").concat(i))}catch(i){if(i.code===L.DISCONNECT_P2P)return void y.warning("disconnecting p2p, abort unsubscribe request.");throw y.error("[".concat(this._clientId,"] unsubscribe user ").concat(n.uid," error"),i.toString()),i}}async massUnsubscribe(n){if(Ar(n,"unsubscribeList"),!this._joinInfo)throw new H(L.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");y.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(n.map(t=>{let{user:i,mediaType:r}=t;return"user: ".concat(i==null?void 0:i.uid,", mediaType: ").concat(r,";")}).join())),n=[...n];let e=new Map;for(let t=n.length-1;t>=0;t--){let{user:i,mediaType:r}=n[t];if(!i){let s=new H(L.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw y.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),s}if(xi(r,"mediaType",["video","audio",void 0]),!this._users.find(s=>s===i)){y.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(i.uid,", user is not in the channel")),n.splice(t,1);continue}let o=Xr.Video|Xr.LwoVideo;if(e.has(i)){let s=e.get(i),a;switch(r){case"video":a=s&o;break;case"audio":a=s&Xr.Audio;break;default:a=s&(Xr.Audio|o)}if(a){y.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(i.uid,",mediaType:").concat(r," twice.")),n.splice(t,1);continue}r?r==="audio"?e.set(i,s|Xr.Audio):r==="video"&&e.set(i,s|o):e.set(i,s|Xr.Audio|o)}else r?r==="audio"?e.set(i,Xr.Audio):r==="video"&&e.set(i,o):e.set(i,Xr.Audio|o)}try{let t=await this._p2pChannel.massUnsubscribe(n);t&&await this._gateway.massUnsubscribe(t),y.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(n.map(i=>{let{user:r,mediaType:o}=i;return"user: ".concat(r==null?void 0:r.uid,", mediaType: ").concat(o,";")}).join()))}catch(t){if(t.code===L.DISCONNECT_P2P)return void y.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw y.error("[".concat(this._clientId,"] massUnsubscribe error"),t.toString()),t}}async setLowStreamParameter(n){(function(t){if(!t)throw new O(L.INVALID_PARAMS);Pi(t.width)||Ai(t.width,"streamParameter.width"),Pi(t.height)||Ai(t.height,"streamParameter.height"),Pi(t.framerate)||Ai(t.framerate,"streamParameter.framerate"),Pi(t.bitrate)||Rt(t.bitrate,"streamParameter.bitrate")})(n),(!n.width&&n.height||n.width&&!n.height)&&y.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),y.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(n));let e=this._configDistribute.getLowStreamConfigDistribute();if(e&&e.bitrate&&n.bitrate&&e.bitrate<n.bitrate&&(n.bitrate=e.bitrate),this._lowStreamParameter=n,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(n,Se.LocalVideoLowTrack)}async setDualStreamMode(n,e){xi(n,"mode",[0,1,-1]);try{switch(e&&await this.setLowStreamParameter(e),this._dualStreamMode=n,this._joinInfo?this._gateway.setDualStreamMode(n).catch(t=>{y.warning("[".concat(this._clientId,"] set dual stream mode failed"),t.toString())}):y.debug("[".concat(this._clientId,"] haven't joined yet, cache dual stream mode ").concat(n)),n){case I_.AUTO_SIMULCAST_STREAM:y.info("[".concat(this._clientId,"] set dual stream mode to ").concat(n));break;case I_.DISABLE_SIMULCAST_STREM:return this.disableDualStream();case I_.ENABLE_SIMULCAST_STREAM:return this.enableDualStream()}}catch(t){throw y.error("[".concat(this._clientId,"] set dual stream mode error"),t.toString()),t}}async enableDualStream(){if(!ot().supportDualStream)throw _e.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new H(L.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new H(L.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(n){throw _e.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),n}this._isDualStreamEnabled=!0,this._dualStreamMode=I_.ENABLE_SIMULCAST_STREAM,this._joinInfo&&this._gateway.setDualStreamMode(this._dualStreamMode,!0,!0).catch(n=>{y.debug("[".concat(this._clientId,"] try to inform gateway to set dual stream mode to ").concat(this._dualStreamMode," ,but failed"),n.toString())}),_e.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),y.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)return this._isDualStreamEnabled=!1,void y.info("[".concat(this._clientId,"] disable dual stream before join"));if(this._p2pChannel.getLocalMedia(Se.LocalVideoLowTrack))try{let n=await this._p2pChannel.unpublishLowStream();n&&await this._gateway.unpublish(n,this._joinInfo.stringUid||this._joinInfo.uid)}catch(n){throw _e.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),n}this._isDualStreamEnabled=!1,this._dualStreamMode=I_.DISABLE_SIMULCAST_STREM,this._joinInfo&&this._gateway.setDualStreamMode(this._dualStreamMode,!0,!0).catch(n=>{y.debug("[".concat(this._clientId,"] try to inform gateway to set dual stream mode to ").concat(this._dualStreamMode," ,but failed"),n.toString())}),_e.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),y.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(n,e){if(function(i){xi(i,"role",["audience","host"])}(n),e&&Oh(e),this.mode==="rtc"||this.mode==="p2p")throw y.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new H(L.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(e&&e.level&&n==="host")throw new H(L.INVALID_OPERATION,"host mode can not set audience latency level");if(n==="audience"&&this._p2pChannel.hasLocalMedia())throw new H(L.INVALID_OPERATION,"can not set client role to audience when publishing stream");let t=this._config.role;if(this._joinInfo&&(this._joinInfo.role=n),n!==t&&F("ENABLE_ROLE_SELECT_EDGE")?(this._gateway.updateClientRole(n,e),this._config.role=n,this._gateway.reconnect("recover",Cn.REGIONAL_DISTRIBUTION)):(await this._gateway.setClientRole(n,e),this._config.role=n),y.info("[".concat(this._clientId,"] set client role to ").concat(n,", level: ").concat(e&&e.level)),t==="audience"&&n!=="audience"&&this._pendingRtpCapabilityChange&&this._p2pChannel instanceof Ml){let{video_codec:i}=this._pendingRtpCapabilityChange;this._p2pChannel.updateRemoteRTPCapabilities(i.map(r=>r.toLowerCase()).filter(r=>{var o;return z(o=Object.keys(tt)).call(o,r)}))}}async _setClientRoleOptions(n){if(this.mode==="rtc"||this.mode==="p2p"||this._config.role!=="audience"||this._p2pChannel.hasLocalMedia())return;let e=!1;try{n&&Oh(n),await this._gateway.setClientRole(this._config.role,n),e=!0}catch{}finally{y.info("[".concat(this._clientId,"] set client role options ").concat(e?"succeed":"failed",", options is ").concat(n))}}getRemoteInboundOffset(){var n;let e=(n=this._p2pChannel.getStats())===null||n===void 0?void 0:n.audioSend[0];if(!e||!e.timestamp)return 0;let t=e.timestamp-Date.now();return Math.abs(t)>1e3+e.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?t:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(n,e){if(_n(n,"proxyServer"),!e){if(this.connectionState!=="DISCONNECTED")throw new H(L.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new H(L.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=n,_e.setProxyServer(this._proxyServer),y.setProxyServer(this._proxyServer),y.info("[".concat(this._clientId,"] Set proxy server ").concat(e?"by initialize call":""," success."))}setTurnServer(n,e){if(Array.isArray(n)||(n=[n]),!e){if(this.connectionState!=="DISCONNECTED")throw new H(L.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new H(L.INVALID_OPERATION,"You have already set the proxy")}if(bt(n))return this._turnServer={servers:n,mode:"original-manual"},void y.info("[".concat(this._clientId,"] Set original turnserver ").concat(e?"by initialize call":""," success: ").concat(n.map(t=>t.urls).join(","),"."));n.forEach(t=>bh(t)),this._turnServer={servers:n,mode:"manual"},y.info("[".concat(this._clientId,"] Set turnserver ").concat(e?"by initialize call":""," success."))}setLicense(n){if(this.connectionState!=="DISCONNECTED")throw new H(L.INVALID_OPERATION,"you should set license before join channel");if(_n(n,"license",32,32),!/^[A-Za-z\d]+$/.test(n))throw new H(L.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=n,y.info("[".concat(this._clientId,"] set license success"),n)}startProxyServer(n){if(this.connectionState!=="DISCONNECTED")throw new H(L.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new H(L.INVALID_OPERATION,"You have already set the proxy");let e=[3,4,5],t;switch(n===void 0&&(n=3),n){case 1:case 2:throw new H(L.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:t="proxy3";break;case 4:t="proxy4";break;case 5:t="proxy5";break;default:throw new H(L.INVALID_PARAMS,"proxy server mode must be ".concat(e.join("|")))}this._cloudProxyServerMode=t,this.store.cloudProxyServerMode=t,y.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new H(L.INVALID_OPERATION,"Stop proxy server after leave channel");_e.setProxyServer(),y.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",y.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(n){if(!n.accessPoints)throw new H(L.INVALID_PARAMS,"accessPoints is required.");Ar(n.accessPoints.serverList,"accessPoints.serverList"),_n(n.accessPoints.domain,"accessPoints.domain");let e=(p,f)=>{Rt(p,f,0,65535,!0)},t=443;if(n.accessPoints.port&&(e(n.accessPoints.port,"accessPoints.port"),t=n.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new H(L.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");F("CLOSE_AFB_FOR_LOCAL_AP")&&($e("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),$e("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));let i=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,r=n.accessPoints.domain,o=n.accessPoints.serverList.map(p=>i.test(p)?"".concat(p.replace(/\./g,"-"),".").concat(r):p),s=o.map(p=>"".concat(p,":").concat(t));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,$e("WEBCS_DOMAIN",s),$e("WEBCS_DOMAIN_BACKUP_LIST",s),$e("GATEWAY_DOMAINS",[r]),n.report&&n.report.hostname&&Array.isArray(n.report.hostname)&&n.report.hostname.length?(Ar(n.report.hostname,"report.hostname"),$e("EVENT_REPORT_DOMAIN",n.report.hostname[0]),$e("EVENT_REPORT_BACKUP_DOMAIN",n.report.hostname[1]||n.report.hostname[0])):($e("EVENT_REPORT_DOMAIN",o[0]),$e("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let a=6443;n.report&&n.report.port&&(e(n.report.port,"report.port"),a=n.report.port),$e("STATS_COLLECTOR_PORT",a),n.report?$e("ENABLE_EVENT_REPORT",!0):$e("ENABLE_EVENT_REPORT",!1);let c="";n.log&&n.log.hostname&&Array.isArray(n.log.hostname)&&n.log.hostname.length?(Ar(n.log.hostname,"log.hostname"),c=n.log.hostname[0]):c=o[0];let d=6444;n.log&&n.log.port&&(e(n.log.port,"log.port"),d=n.log.port),$e("LOG_UPLOAD_SERVER","".concat(c,":").concat(d));let l=[];n.cds&&n.cds.hostname&&Array.isArray(n.cds.hostname)&&n.cds.hostname.length?(Ar(n.cds.hostname,"cds.hostname"),l=n.cds.hostname):l=o;let h=443;n.cds&&n.cds.port&&(e(n.cds.port,"cds.port"),h=n.cds.port),$e("CDS_AP",l.map(p=>"".concat(p,":").concat(h))),n.cds?$e("ENABLE_CONFIG_DISTRIBUTE",!0):$e("ENABLE_CONFIG_DISTRIBUTE",!1),y.info("set local access point v2 success")}setLocalAccessPoints(n,e){if(Ar(n,"serverList"),_n(e,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new H(L.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");let t=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;n=n.map(i=>t.test(i)?"".concat(i.replace(/\./g,"-"),".").concat(e):i),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,$e("WEBCS_DOMAIN",n),$e("WEBCS_DOMAIN_BACKUP_LIST",n),$e("GATEWAY_DOMAINS",[e]),$e("EVENT_REPORT_DOMAIN",n[0]),$e("EVENT_REPORT_BACKUP_DOMAIN",n[1]||n[0]),$e("LOG_UPLOAD_SERVER","".concat(n[0],":6444")),y.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(n){if(xi(n,"streamType",[0,1,4,5,6,7,8,9]),this._remoteDefaultVideoStreamType=n,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(n),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw y.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else y.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(n))}async setRemoteVideoStreamType(n,e){xi(e,"streamType",[0,1,4,5,6,7,8,9]);try{await this._gateway.setRemoteVideoStreamType(n,e),setTimeout(()=>{let t=this._users.find(i=>i.uid===n);t&&t.videoTrack&&t.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(t){throw y.error("[".concat(this._clientId,"] set remote video stream type error"),t.toString()),t}y.info("[".concat(this._clientId,"] set remote ").concat(n," video stream type to ").concat(e)),this._remoteStreamTypeCacheMap.set(n,e)}async setStreamFallbackOption(n,e){xi(e,"fallbackType",[0,1,2,3,4,5,6,7,8]);try{await this._gateway.setStreamFallbackOption(n,e)}catch(t){throw y.error("[".concat(this._clientId,"] set stream fallback option"),t.toString()),t}y.info("[".concat(this._clientId,"] set remote ").concat(n," stream fallback type to ").concat(e)),this._streamFallbackTypeCacheMap.set(n,e)}setEncryptionConfig(n,e,t,i){(function(o){xi(o,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(n),_n(e,"secret");let r=["aes-128-gcm2","aes-256-gcm2"];if(z(r).call(r,n)){if(!t||!(t instanceof Uint8Array&&t.length===32))throw new H(L.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(t)throw new H(L.INVALID_PARAMS,"current encrypt mode does not need salt");if(i){if(oe(i,"encryptDataStream"),!z(r).call(r,n))throw new H(L.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(e)||y.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=n,this._encryptionSecret=e,t&&(this._encryptionSalt=_a(t))}async renewToken(n){if(_n(n,"token",1,2047),!this._key||!this._joinInfo)throw new H(L.INVALID_OPERATION,"renewToken should not be called before user join");let e=this._key;this._key=n,this._joinInfo&&(this._joinInfo.token=n);let t=await this._renewTokenMutex.lock();try{if(F("USE_NEW_TOKEN")){y.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));let i=await Tz(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||mr);y.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:n,ticket:i})}else y.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:n});y.debug("[".concat(this._clientId,"] renewToken success"))}catch(i){throw this._key=e,this._joinInfo.token=e,y.error("[".concat(this._clientId,"] renewToken failed"),i.toString()),i}finally{t()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?y.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{let n=this._p2pChannel.getAudioLevels();this.safeEmit(It.VOLUME_INDICATOR,n)},F("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){let n=this._statsCollector.getRTCStats(),e=this._gateway.getInChannelInfo();return n.Duration=Math.round(e.duration/1e3),n}async startLiveStreaming(n,e){if(!e){if(this.codec!=="h264")throw new H(L.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new H(L.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(n)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(n))throw new H(L.LIVE_STREAMING_TASK_CONFLICT);let t=e?Mc.TRANSCODE:Mc.RAW;return this._createLiveStreamingClient(t).startLiveStreamingTask(n,t)}setLiveTranscoding(n){return this._createLiveStreamingClient(Mc.TRANSCODE).setTranscodingConfig(n)}async stopLiveStreaming(n){let e=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(t=>t&&t.hasUrl(n));if(!e.length)throw new H(L.INVALID_PARAMS,"can not find live streaming url to stop");await Z.all(e.map(t=>t&&t.stopLiveStreamingTask(n)))}async startChannelMediaRelay(n){hL(n),await this._createChannelMediaRelayClient().startChannelMediaRelay(n)}async updateChannelMediaRelay(n){hL(n),await this._createChannelMediaRelayClient().updateChannelMediaRelay(n)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendAudioMetadata(n){this._p2pChannel instanceof Ml&&this._p2pChannel.addAudioMetadata(n)}async sendStreamMessage(n){var e;let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new H(L.INVALID_OPERATION,"can not send data stream, not joined");if((typeof n=="string"||n instanceof Uint8Array)&&(n={payload:n}),typeof n.payload=="string"){let r=new TextEncoder;n.payload=r.encode(n.payload)}let i=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&z(e=["aes-128-gcm2","aes-256-gcm2"]).call(e,this._encryptionMode)&&(i=!0,n.payload=await async function(r,o,s){var a;let c=un(a=Array.from(s)).call(a,(g,S)=>g+S,0),d={serverTs:0,seq:jf++,length:s.length,checkSum:c},l=new Uint8Array(Iv(c,2)),h=new ArrayBuffer(w_),p=new DataView(h);p.setUint32(0,d.serverTs),p.setUint16(4,d.seq),p.setUint16(6,d.length),p.setUint16(8,d.checkSum);let f=16-s.length%16;s=kN(s,new Uint8Array(f));let m=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r,tagLength:Ph,additionalData:l},o,s);return kN(new Uint8Array(h),new Uint8Array(m))}(this._encryptDataStreamIv,this._encryptDataStreamKey,n.payload)),new Blob([n.payload]).size>1024)throw new H(L.INVALID_PARAMS,i?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(le.DATA_STREAM,{payload:_a(n.payload),syncWithAudio:n.syncWithAudio,sendTs:Date.now()-d2},!t)}sendMetadata(n){if(!this._joinInfo)throw new H(L.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([n]).size>1024)throw new H(L.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(le.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:_a(n)})}async sendCustomReportMessage(n){if(Array.isArray(n)||(n=[n]),n.forEach(OU),!this._joinInfo)throw new H(L.INVALID_OPERATION,"can not send custom report, not joined");await _e.sendCustomReportMessage(this._joinInfo.sid,n)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){let n=this._statsCollector.getRemoteNetworkQualityStats();if(F("DELETE_NEQ_AFTER_USER_LEAVE")){let e=this._users.map(t=>t.uid+"");Object.keys(n).forEach(t=>{z(e).call(e,t)||delete n[t]})}return n}getNetworkQuality(){return this._statsCollector.getNetworkQuality()}async pickSVCLayer(n,e){xi(e.spatialLayer,"spatialLayer",[0,1,2,3]),xi(e.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(n,e)}catch(t){throw y.error("[".concat(this._clientId,"] pick SVC layer failed"),t.toString()),t}}async setRTMConfig(n){let{apRTM:e=!1,rtmFlag:t}=n;if(oe(e,"apRTM"),Rt(t,"rtmFlag",0),this._rtmConfig.apRTM=e,this._rtmConfig.rtmFlag=t,y.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(n)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=e,this._joinInfo.rtmFlag=t,this._gateway.setRTM2Flag(t)}_reset(){if(y.debug("[".concat(this._clientId,"] reset client")),function(n){let e=Lc.indexOf(n);e!==-1&&Lc.splice(e,1)}(this._clientId),this.store.hasStartJoinChannel=!1,this.store.isABTestSuccess=!1,this.store.autoSubscribe=!1,this._pendingRtpCapabilityChange=void 0,this._axiosCancelSource.cancel(),this._axiosCancelSource=Qi.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&NC(this._joinInfo),this._rteDetailInterval&&(window.clearInterval(this._rteDetailInterval),this._rteDetailInterval=void 0,this._sessionId&&_e.reportRteDetail(this._sessionId)),this._fallbackServerInfo=void 0,this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId&&_e.removeSid(this._sessionId),this._sessionId=null,this.store.sessionId=null,this.store.resetFirstVideoFrameDecoded(),this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(n=>{n._audioTrack&&n._audioTrack._destroy(),n._videoTrack&&n._videoTrack._destroy(),n._dataChannels&&(n._dataChannels.forEach(e=>e._close()),n._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new mn("client-publish",this._clientId),this._subscribeMutex=new mn("client-subscribe",this._clientId),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(n,e){var t;let i=n||li();n?y.debug("[".concat(this._clientId,"] new Session ").concat(i)):y.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(i));let r=n?"":this._sessionId||"";this._sessionId=i,this.store.sessionId=i,_e.addSid(i);let o={lts:new Date().getTime(),mode:this.mode,buildFormat:1,stringUid:(e==null?void 0:e.stringUid)||((t=this._joinInfo)===null||t===void 0?void 0:t.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:r,clientRole:this.role==="audience"?2:1,rteUrl:this.store.rteUrl,rteSid:this.store.rteSid};_e.sessionInit(this._sessionId,hc({cname:e.channel,appid:e.appId},o)),this._joinInfo&&(this._joinInfo.sid=i),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=i)}async _publishHighStream(n){if(!this._joinInfo||this._uid===void 0)throw new H(L.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&F("FORCE_TURN")&&!F("TURN_ENABLE_TCP")&&!F("TURN_ENABLE_UDP"))throw new H(L.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");y.debug("[".concat(this._clientId,"] publish high stream"));try{let t=await this._p2pChannel.publish(n,this._isDualStreamEnabled,this._lowStreamParameter);if(this.store.useP2P){let i=(await t.next()).value;if(i){try{await this._gateway.sendExtensionMessage(ar.PUBLISH,i,!0)}catch(r){throw t.throw(r),r}await t.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{let i=(await t.next()).value;if(i){var e;let r;try{r=await this._gateway.publish(this._uid,i,!0)}catch(o){if(o.code!==L.DISCONNECT_P2P)throw t.throw(o),o}await t.next(((e=r)===null||e===void 0?void 0:e.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(let r of n)r instanceof Jt&&r._encoderConfig&&this._gateway.setVideoProfile(r._encoderConfig).catch(o=>{y.debug("[".concat(this._clientId,"] stop setVideoProfile, because websocket is closed"))}),!r.muted&&r.enabled||await this._p2pChannel.muteLocalTrack(r)}}catch(t){if(this._p2pChannel.reportPublishEvent(!1,t==null?void 0:t.code,n),(t==null?void 0:t.code)===L.WS_ABORT)return;throw t}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new H(L.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new H(L.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));y.debug("[".concat(this._clientId,"] publish low stream"));let n=this._configDistribute.getLowStreamConfigDistribute();n&&n.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&n.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=n.bitrate));try{let t=await this._p2pChannel.publishLowStream(this._lowStreamParameter),i=(await t.next()).value;if(i){var e;let r;try{r=await this._gateway.publish(this._uid,i,!0)}catch(o){if(o.code!==L.DISCONNECT_P2P)throw t.throw(o),o}t.next(((e=r)===null||e===void 0?void 0:e.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(t){if(this._p2pChannel.reportPublishEvent(!1,t==null?void 0:t.code,void 0,!0),(t==null?void 0:t.code)===L.WS_ABORT)return;throw t}}_createLiveStreamingClient(n){let e=()=>{if(!this._joinInfo||!this._appId)return new H(L.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();let t=(i={joinInfo:this._joinInfo,appId:this._appId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig},go("LiveStreaming").create(i));var i;return t.onLiveStreamError=(r,o)=>{_e.reportApiInvoke(this._sessionId,{name:Yi.ON_LIVE_STREAM_ERROR,options:[r,o],tag:ct.TRACER}).onSuccess(),this.safeEmit(It.LIVE_STREAMING_ERROR,r,o)},t.onLiveStreamWarning=(r,o)=>{_e.reportApiInvoke(this._sessionId,{name:Yi.ON_LIVE_STREAM_WARNING,options:[r,o],tag:ct.TRACER}).onSuccess(),this.safeEmit(It.LIVE_STREAMING_WARNING,r,o)},t.on(Al.REQUEST_WORKER_MANAGER_LIST,(r,o,s)=>{if(!this._joinInfo)return s(new H(L.INVALID_OPERATION,"can not find join info to get worker manager"));(async function(a,c,d,l){let h=F("UAP_AP").slice(0,F("AJAX_REQUEST_CONCURRENT")).map(p=>c.proxyServer?"https://".concat(c.proxyServer,"/ap/?url=").concat(p+"/api/v1?action=uap"):"https://".concat(p,"/api/v1?action=uap"));return await tL(h,a,c,d,l)})(r,this._joinInfo,this._axiosCancelSource.token,mr).then(o).catch(s)}),t};return n===Mc.RAW?(this._liveRawStreamingClient=this._liveRawStreamingClient||e(),this._liveRawStreamingClient):(this._liveTranscodeStreamingClient=this._liveTranscodeStreamingClient||e(),this._liveTranscodeStreamingClient)}_createChannelMediaRelayClient(){if(!this._joinInfo)return new H(L.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){let{sendResolutionWidth:e,sendResolutionHeight:t}=this.getLocalVideoStats(),i=(n={joinInfo:this._joinInfo,clientId:this._clientId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig,resolution:{width:e,height:t}},go("ChannelMediaRelay").create(n));i.on("state",r=>{r===An.RELAY_STATE_FAILURE&&i&&i.dispose(),this.safeEmit(It.CHANNEL_MEDIA_RELAY_STATE,r)}),i.on("event",r=>{this.safeEmit(It.CHANNEL_MEDIA_RELAY_EVENT,r)}),this._channelMediaRelayClient=i,this._statsCollector.onStatsChanged=(r,o)=>{var s;r==="resolution"&&((s=this._channelMediaRelayClient)===null||s===void 0||s.setVideoProfile(o))}}var n;return this._channelMediaRelayClient}_handleUpdateDataChannel(n,e){let{added:t,deleted:i}=n,r=[];if(e){let o=[];this._users.forEach(s=>{s._dataChannels.forEach(a=>{t.every(c=>c.uid!==s._uintid||c.stream_id!==a.id)&&o.push({uid:s._uintid,stream_id:a.id,ordered:a.ordered,max_retrans_times:a.maxRetransmits,metadata:a.metadata})})}),o.length>0&&this._handleUpdateDataChannel({added:[],deleted:o})}Array.isArray(t)&&t.length>0&&t.forEach(o=>{let{uid:s,stream_id:a,ordered:c,max_retrans_times:d,metadata:l}=o,h=this._users.find(p=>p._uintid===s);if(!h)return void y.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(y.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(s)),z(r).call(r,h)||r.push(h),h._uintid||(h._uintid=s),h._dataChannels.findIndex(p=>p.id===o.stream_id)===-1){let p={id:a,ordered:!!c,maxRetransmits:d,metadata:l},f=function(m){return Fc(m,!0)}(p);h._dataChannels.push(f),y.info("[".concat(this._clientId,"] remote user ").concat(h.uid," published datachannel")),e||this.safeEmit(It.USER_PUBLISHED,h,"datachannel",p)}this._p2pChannel.hasPendingRemoteDataChannel(h,o.stream_id)&&(y.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(h.uid," after reconnect.")),this._subscribeDataChannel(h,o.stream_id).catch(p=>{y.error("[".concat(this._clientId,"] resubscribe datachannel error"),p.toString())}))}),e&&(this.safeEmit(It.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(i)&&i.length>0&&i.forEach(o=>{let{uid:s,stream_id:a}=o,c=this._users.find(l=>l._uintid===s);if(!c)return void y.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));let d=c._dataChannels.find(l=>l.id===o.stream_id);d&&(y.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(s)),this._p2pChannel.unsubscribeDataChannel(c,[d]).then(l=>{if(c._dataChannels=c._dataChannels.filter(h=>h!==d),l)return this._gateway.unsubscribeDataChannel(l,c.uid)}),y.info("[".concat(this._clientId,"] remote user ").concat(s," unpublished datachannel ,id:").concat(d.id)),this.safeEmit(It.USER_UNPUBLISHED,c,"datachannel",d._config))})}_getEncodingName(n){var e,t;if(!this._joinResponse)return;let i=(e=this._joinResponse.ortc.rtpCapabilities.sendrecv)===null||e===void 0?void 0:e.videoCodecs;if(!i)return;for(let a of i){var r;if(a.payloadType===n)return a==null||(r=a.rtpMap)===null||r===void 0?void 0:r.encodingName}let o=(t=this._joinResponse.ortc.rtpCapabilities.recv)===null||t===void 0?void 0:t.videoCodecs;if(o)for(let a of o){var s;if(a.payloadType===n)return a==null||(s=a.rtpMap)===null||s===void 0?void 0:s.encodingName}return n===0?"unknown":void 0}_handleRemoveDataChannels(n){let e=this._users.find(t=>t.uid===n.uid);if(e){if(e._dataChannels!==void 0&&e._dataChannels.length>0){y.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(n.uid));let t=()=>{y.info("[".concat(this._clientId,"] remote user ").concat(e.uid," unpublished datachannel")),e._dataChannels.forEach(i=>{this.safeEmit(It.USER_UNPUBLISHED,e,"datachannel",i._config)})};this._p2pChannel.unsubscribeDataChannel(e,e._dataChannels).then(i=>{if(i)return this._gateway.unsubscribeDataChannel(i,e.uid)}),t()}}else y.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(_t.UPDATE_GATEWAY_CONFIG,()=>{(function(){let n;try{n=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void y.error("Error loading sdk config",e.message)}if(n)try{let e=JSON.parse(window.atob(n)),t=Date.now();Object.keys(e).forEach(i=>{let{value:r,type:o,expires:s}=e[i];s&&s<=t||o||Uu()||!Object.prototype.hasOwnProperty.call(En,i)||(Zs[i]=r,Si[i]=r,y.debug("Update gateway parameters from config distribute",i,r))})}catch(e){y.error("Error update config from local cache",e.message)}})()}),this._gateway.on(_t.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(_t.CONNECTION_STATE_CHANGE,(n,e,t)=>{var i;if(t===Gt.FALLBACK)return;let r=()=>{this.safeEmit(It.CONNECTION_STATE_CHANGE,n,e,t)};if(_e.reportApiInvoke(this._sessionId||((i=this._gateway.joinInfo)===null||i===void 0?void 0:i.sid)||null,{name:Yi.CONNECTION_STATE_CHANGE,options:[n,e,t],tag:ct.TRACER}).onSuccess(JSON.stringify({cur:n,prev:e,reason:t})),y.info("[".concat(this._clientId,"] signal connection state change: ").concat(e," -> ").concat(n)),n==="DISCONNECTED")return this._reset(),void r();if(n==="RECONNECTING")this._users.forEach(s=>{s._trust_in_room_=!1,s._trust_audio_enabled_state_=!1,s._trust_video_enabled_state_=!1,s._trust_audio_mute_state_=!1,s._trust_video_mute_state_=!1,s._trust_audio_stream_added_state_=!1,s._trust_video_stream_added_state_=!1,s._is_pre_created||(s._audio_pre_subscribed||(s._audioSSRC=void 0,s._audioOrtc=void 0),s._video_pre_subscribed||(s._videoSSRC=void 0,s._videoOrtc=void 0,s._rtxSsrcId=void 0),s._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(n==="CONNECTED"){var o;this._streamFallbackTypeCacheMap.forEach((s,a)=>{this._gateway.setStreamFallbackOption(a,s).catch(c=>{y.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),c)})}),this._remoteStreamTypeCacheMap.forEach((s,a)=>{this._gateway.setRemoteVideoStreamType(a,s).catch(c=>{y.warning("[".concat(this._clientId,"] auto set remote stream type failed"),c)})}),F("VOS_CONFIGURE")&&Array.isArray(F("VOS_CONFIGURE"))&&F("VOS_CONFIGURE").length>0&&(this._gateway.setConfigure(F("VOS_CONFIGURE")).catch(s=>{y.debug("[".concat(this._clientId,"] auto set vos config failed"),s)}),y.debug("[".concat(this._clientId,"] ws connected auto set vos config"))),this._remoteDefaultVideoStreamType!==void 0&&((o=this._joinInfo)===null||o===void 0?void 0:o.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{y.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(s=>{y.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(s))}),this._dualStreamMode&&this._gateway.setDualStreamMode(this._dualStreamMode).catch(s=>{y.warning("[".concat(this._clientId,"] auto set dual stream mode failed"),s)}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(s=>!s._trust_in_room_).forEach(s=>{y.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(s.uid)),this._handleUserOffline({uid:s.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(s=>{s._trust_audio_mute_state_||(y.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(s.uid)),this._handleMuteStream(s.uid,ke.AUDIO,!1)),s._trust_video_mute_state_||(y.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(s.uid)),this._handleMuteStream(s.uid,ke.VIDEO,!1)),s._trust_audio_enabled_state_||(y.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(s.uid)),this._handleSetStreamLocalEnable("audio",s.uid,!0)),s._trust_video_enabled_state_||(y.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(s.uid)),this._handleSetStreamLocalEnable("video",s.uid,!0)),s._trust_video_stream_added_state_||(y.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(s.uid)),this._handleResetAddStream(s,"video")),s._trust_audio_stream_added_state_||(y.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(s.uid)),this._handleResetAddStream(s,"audio")),s._video_added_||s._audio_added_||(y.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(s.uid)),this._handleRemoveStream({uid:s.uid,uint_id:s._uintid}))}))},1e3))}r()}),this._gateway.on(_t.REQUEST_NEW_GATEWAY_LIST,async(n,e)=>{if(!this._joinInfo)return e(new H(L.UNEXPECTED_ERROR,"can not recover, no join info"));try{let t;if(this._fallbackServerInfo)t=this._fallbackServerInfo,this._fallbackServerInfo=void 0,this._joinInfo.preload=!1,_e.reportApiInvoke(this._sessionId,{name:Yi.VOS_FALLBACK_CN,options:{cur:t.gatewayInfo.gatewayAddrs,prev:this._joinInfo.gatewayAddrs,is_done:!0},tag:ct.TRACER}).onSuccess(),y.info("[".concat(this._clientId,"] use fallback cn server info"));else{let r=await $T(hc(hc({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));r?(t=r.ap,OL(r),this._joinInfo.preload=!0):(t=await SC(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||mr,this.store),this._joinInfo.preload=!1)}this._joinInfo&&(this._joinInfo.apResponse=t.gatewayInfo.res,this._joinInfo.gatewayAddrs=t.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=t.gatewayInfo.uni_lbs_ip);let i=[];t.gatewayInfo.gatewayAddrs.forEach(r=>{let{address:o}=r,[s,a]=o.split(":");this._joinInfo&&this._joinInfo.proxyServer?i.push({proxy:this._joinInfo.proxyServer,host:s,port:a}):i.push({host:s,port:a})}),n(i)}catch(t){e(t)}}),this._gateway.on(_t.NETWORK_QUALITY,n=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(It.NETWORK_QUALITY,n)}),this._gateway.on(_t.STREAM_TYPE_CHANGE,(n,e)=>{this.safeEmit(It.STREAM_TYPE_CHANGED,n,e),_e.reportApiInvoke(this._sessionId,{name:Yi.STREAM_TYPE_CHANGE,options:[n,e],tag:ct.TRACER}).onSuccess(JSON.stringify({uid:n,streamType:e}))}),this._gateway.isPreSub=()=>"isPreSub"in this._p2pChannel&&this._p2pChannel.isPreSub(),this._gateway.isPreallocation=()=>"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation(),this._gateway.on(_t.IS_P2P_DISCONNECTED,n=>{this._p2pChannel.isP2PDisconnected()?n(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?n(!1):n(!0)}),this._gateway.on(_t.REQUEST_P2P_CONNECTION_PARAMS,async(n,e,t)=>{try{let i=await this._p2pChannel.getEstablishParams();i&&"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation()||(i=await this._p2pChannel.startP2PConnection(n)),e(i)}catch(i){t(i)}}),this._gateway.on(_t.JOIN_RESPONSE,(n,e)=>{if(this.store.useP2P)return;let t;this._joinResponse=n,n.attributes?t=n.attributes.userAttributes.preSubSsrcs:y.debug("no attributes in joinResponse");let i=aC(n.ortc,e,t);this._p2pChannel.connect(i)}),this._gateway.on(_t.PRE_CONNECT_PC,async(n,e,t)=>{let{candidates:i,fingerprint:r,turnServer:o}=n;if(this._joinInfo&&i.length>0&&!this._p2pChannel.isPlanB){let{cert:a,cid:c}=this._joinInfo.apResponse,d="".concat(c,"_").concat(a);if(d.length<4||d.length>256)return void y.debug("[".concat(this._clientId,"] ufrag length is not valid, length: ").concat(d.length));await this._p2pChannel.startP2PConnection({turnServer:o,cloudProxyServer:this._joinInfo.cloudProxyServer,isPreallocation:!0});try{var s;e(await this._p2pChannel.connect({iceParameters:{iceUfrag:"".concat(c,"_").concat(a),icePwd:"".concat(c,"_").concat(a)},dtlsParameters:{fingerprints:[{hashFunction:"sha-256",fingerprint:(s=F("FINGERPRINT"))!==null&&s!==void 0?s:r}]},candidates:i,rtpCapabilities:{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},setup:"active",cname:"o/i14u9pJrxRKAsu",preallocation:!0}))}catch(l){l.code&&l.code===L.EXCHANGE_SDP_FAILED&&await this._p2pChannel.startP2PConnection({turnServer:o,cloudProxyServer:this._joinInfo.cloudProxyServer},!0),t(l)}}}),this._gateway.on(_t.VOS_FALLBACK,n=>{n==="fallback_hls"&&this.safeEmit(It.FALLBACK_TO_HLS,At.VOSERROR)}),this._gateway.on(_t.RESET_SIGNAL,()=>{this._p2pChannel instanceof Ml&&this._p2pChannel.fallbackConnection(),this._handleGatewaySignalEvents()}),this._gateway.on(_t.DATACHANNEL_FAILBACK,()=>{_e.reportApiInvoke(this._sessionId,{name:Yi.DATACHANNEL_FAILBACK,options:{},tag:ct.TRACER}).onSuccess(),this._joinGateway()})}_handleGatewaySignalEvents(){this._gateway.signal.on(it.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(it.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(it.ON_ADD_AUDIO_STREAM,n=>this._handleAddAudioOrVideoStream("audio",n.uid,n.ssrcId,n.cname,n.pt,n.uint_id,n.ortc)),this._gateway.signal.on(it.ON_ADD_VIDEO_STREAM,n=>this._handleAddAudioOrVideoStream("video",n.uid,n.ssrcId,n.cname,n.pt,n.uint_id,n.ortc,n.rtxSsrcId)),this._gateway.signal.on(it.ON_REMOTE_DATASTREAM_UPDATE,n=>{this._handleUpdateDataChannel(n)}),this._gateway.signal.on(it.ON_REMOTE_FULL_DATASTREAM_INFO,n=>{this._handleUpdateDataChannel({added:n.datastreams||[],deleted:[]},!0)}),this._gateway.signal.on(it.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(it.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(it.MUTE_AUDIO,n=>this._handleMuteStream(n.uid,ke.AUDIO,!0)),this._gateway.signal.on(it.UNMUTE_AUDIO,n=>this._handleMuteStream(n.uid,ke.AUDIO,!1)),this._gateway.signal.on(it.MUTE_VIDEO,n=>this._handleMuteStream(n.uid,ke.VIDEO,!0)),this._gateway.signal.on(it.UNMUTE_VIDEO,n=>this._handleMuteStream(n.uid,ke.VIDEO,!1)),this._gateway.signal.on(it.RECEIVE_METADATA,n=>{let e=pa(n.metadata);this.safeEmit(It.RECEIVE_METADATA,n.uid,e)}),this._gateway.signal.on(it.ON_DATA_STREAM,async n=>{var e;if(!n)return;let t=pa(n.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&z(e=["aes-128-gcm2","aes-256-gcm2"]).call(e,this._encryptionMode)){if(n.payload.length<w_)throw new H(L.UNEXPECTED_RESPONSE,"payload length ".concat(n.payload.length," is less than header length ").concat(w_));t=await async function(r,o,s){let a=s.subarray(0,w_),c=a.slice(8,w_),d=(c[0]<<8)+c[1],l=(a[6]<<8)+a[7],h=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:r,tagLength:Ph,additionalData:new Uint8Array(Iv(d,2))},o,s.subarray(w_));return new Uint8Array(h).subarray(0,l)}(this._encryptDataStreamIv,this._encryptDataStreamKey,t)}let i=0;if(n.ordered||n.syncWithAudio){let r=this._p2pChannel.getStats(),o=this.remoteUsers.find(a=>a.uid===n.uid),s=r==null?void 0:r.audioRecv.find(a=>a.ssrc===(o==null?void 0:o._audioSSRC));i=s==null?void 0:s.jitterBufferMs}(i==null||Number.isNaN(i))&&(i=0),l2(hc(hc({},n),{},{payload:t}),i,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(it.ON_CRYPT_ERROR,()=>{wu(()=>{y.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(It.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(it.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(it.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{y.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,Gt.TOKEN_EXPIRE),this.safeEmit(It.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(it.ON_STREAM_FALLBACK_UPDATE,n=>{y.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(n.stream_id,", attr: ").concat(n.stream_type)),this.safeEmit(It.STREAM_FALLBACK,n.stream_id,n.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(it.ENABLE_MULTI_STREAM,n=>{this._dualStreamMode===I_.AUTO_SIMULCAST_STREAM&&this.enableDualStream().catch(e=>{y.debug("[".concat(this._clientId,"] set dual stream mode error"),e.toString())})}),this._gateway.signal.on(it.ON_PUBLISH_STREAM,n=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:n.proxy})),y.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(n))))}),this._gateway.signal.on(it.ENABLE_LOCAL_VIDEO,n=>{this._handleSetStreamLocalEnable("video",n.uid,!0)}),this._gateway.signal.on(it.DISABLE_LOCAL_VIDEO,n=>{this._handleSetStreamLocalEnable("video",n.uid,!1)}),this._gateway.signal.on(Ee.REQUEST_TIMEOUT,(n,e)=>{if(this._joinInfo)switch(n){case le.PUBLISH:{if(!e)return;let r=e.ortc;if(r){var t,i;let o=r.some(c=>{let{stream_type:d}=c;return d===_i.Audio}),s=r.some(c=>{let{stream_type:d}=c;return d!==_i.Audio}),a=r.some(c=>{let{stream_type:d}=c;return d===_i.Screen||d===_i.ScreenLow});e.state==="offer"&&_e.publish(this._joinInfo.sid,{eventElapse:qn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:L.TIMEOUT,audio:o,video:s,p2pid:e.p2p_id,publishRequestid:this.store.pubId,screenshare:a,audioName:o?(t=r.find(c=>{let{stream_type:d}=c;return d===_i.Audio}))===null||t===void 0||(t=t.ssrcs[0])===null||t===void 0?void 0:t.ssrcId.toString():void 0,videoName:s?(i=r.find(c=>{let{stream_type:d}=c;return d!==_i.Audio}))===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId.toString():void 0})}break}case le.SUBSCRIBE:e&&_e.subscribe(this._joinInfo.sid,{succ:!1,ec:L.TIMEOUT,audio:e.stream_type===ke.AUDIO,video:e.stream_type===ke.VIDEO,peerid:e.stream_id,subscribeRequestid:e.ssrcId,p2pid:this.store.p2pId,eventElapse:qn.measureFromSubscribeStart(this.store.clientId,e.ssrcId),preSsrc:this._p2pChannel.isPreSubScribe(e.ssrcId)})}}),this._gateway.signal.on(it.ON_P2P_OK,n=>{this.uid,this._uid}),this._gateway.signal.on(it.ON_PUBLISHED_USER_LIST,n=>{if(n==null||!n.users)return;F("BLOCK_LOCAL_CLIENT")&&(n.users=n.users.filter(i=>!kc(i.string_id||i.stream_id,this.channelName)));let e=[],t=[];for(let i of n.users){let r=this._users.find(l=>l._uintid===i.stream_id);r?r._trust_in_room_=!0:(r=new Bu(i.string_id||i.stream_id,i.stream_id),this._users.push(r),this.store.firstVideoFrameDecoded(r.uid,{userJoinNotify:Date.now()}),this.getListeners(It.PUBLISHED_USER_LIST).length===0&&(y.debug("[".concat(this._clientId,"] user online"),i.stream_id),this.safeEmit(It.USER_JOINED,r)));let o=Xr.Audio&i.stream_type,s=(Xr.Video|Xr.LwoVideo)&i.stream_type,a=(65280&i.stream_type)!=0,c=o&&r.hasAudio,d=s&&r.hasVideo;s&&(r._trust_video_stream_added_state_=!0,r._video_added_=!0,r._videoSSRC=i.video_ssrc,r._rtxSsrcId=i.video_rtx),o&&(r._trust_audio_stream_added_state_=!0,r._audio_added_=!0,r._audioSSRC=i.audio_ssrc),o&&!c&&this.getListeners(It.PUBLISHED_USER_LIST).length===0&&(y.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published audio")),this.safeEmit(It.USER_PUBLISHED,r,"audio")),s&&!d&&this.getListeners(It.PUBLISHED_USER_LIST).length===0&&(y.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published video")),this.safeEmit(It.USER_PUBLISHED,r,"video")),(o&&!c||s&&!d||a)&&e.push(r),s&&this._p2pChannel.hasPendingRemoteMedia(r,"video")&&t.push({user:r,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(r,"audio")&&t.push({user:r,mediaType:"audio"})}t.length>0&&(y.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(t.map(i=>"user: ".concat(i.user.uid,", mediaType: ").concat(i.mediaType)).join("; ")," ")),this.massSubscribe(t).catch(i=>{y.error("[".concat(this._clientId,"] mass resubscribe error"),i.toString())})),this.getListeners(It.PUBLISHED_USER_LIST).length>0?F("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=e:(y.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(e.map(i=>i.uid).join(", "))),this.safeEmit(It.PUBLISHED_USER_LIST,e)):y.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(e.map(i=>i.uid).join(", ")))}),this._gateway.signal.on(it.ON_RTP_CAPABILITY_CHANGE,n=>{let{video_codec:e}=n;if(this._p2pChannel instanceof Ml){if(this.role==="audience"&&F("UPDATE_RTP_CAP_IN_HOST"))return this._pendingRtpCapabilityChange=n,void y.debug("[".concat(this._clientId,"] no need to change rtp capability because of audience, params: ").concat(JSON.stringify(n)));this._p2pChannel.updateRemoteRTPCapabilities(e.map(t=>t.toLowerCase()).filter(t=>{var i;return z(i=Object.keys(tt)).call(i,t)}))}}),this._gateway.signal.on(Ee.VOS_FALLBACK_PROMISE,async(n,e,t)=>{if(n==="FALLBACKCN"&&F("ENABLE_QUALITY_FALLBACK")){if(!this._joinInfo)return t(new H(L.UNEXPECTED_ERROR,"can not recover, no join info"));y.info("[".concat(this._clientId,"] try fallback to cn, start request new server info"));let r=this._joinInfo.apRequestDetail;try{this._joinInfo.apRequestDetail=n;let o=await SC(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||mr,this.store);if(F("QUALITY_FALLBACK_REHEARSAL"))return _e.reportApiInvoke(this._sessionId,{name:Yi.VOS_FALLBACK_CN,options:{cur:o.gatewayInfo.gatewayAddrs,prev:this._joinInfo.gatewayAddrs,is_done:!1},tag:ct.TRACER}).onSuccess(),this._joinInfo.apRequestDetail=r,void t();this._fallbackServerInfo=o,e()}catch(o){var i;let s=o==null||(i=o.data)===null||i===void 0?void 0:i.desc;F("QUALITY_FALLBACK_REHEARSAL")?(_e.reportApiInvoke(this._sessionId,{name:Yi.VOS_FALLBACK_CN,options:{cur:"failed, errorReason: "+s||"unknown",prev:this._joinInfo.gatewayAddrs,is_done:!1},tag:ct.TRACER}).onSuccess(),this._joinInfo.apRequestDetail=r):Array.isArray(s)&&z(s).call(s,"request downgrade fallback")&&this.safeEmit(It.FALLBACK_TO_HLS,At.AP_ERROR),t(o)}}else t()})}_handleP2PEvents(){this._gateway.signal.on(it.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(ar.PUBLISH,(n,e,t)=>{let{uid:i}=n;n.forEach(r=>{let{kind:o,ssrcs:s,mid:a,isMuted:c}=r;this._handleP2PAddAudioOrVideoStream(o,i,s[0].ssrcId,a);let d=this._users.find(l=>l.uid===i);return d&&this.store.useP2P?this._p2pChannel.mockSubscribe(d,o,s[0].ssrcId,a).then(()=>{e()}).catch(t):e(),this._handleMuteStream(i,o,!!c)})}),this._gateway.signal.on(ar.CALL,async(n,e,t)=>{if(this.store.useP2P)try{var i;e(await this._p2pChannel.startP2P({turnServer:(i=this._joinInfo)===null||i===void 0?void 0:i.turnServer},n))}catch(r){t(r)}}),this._gateway.signal.on(Ee.P2P_CONNECTION,async n=>{this.store.useP2P&&(await this._p2pChannel).p2pConnect(n)}),this._gateway.signal.on(ar.UNPUBLISH,async(n,e,t)=>{if(this.store.useP2P){let{unpubMsg:i,uid:r}=n,o=this._users.find(s=>s.uid===r);if(!o)return y.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r)),void e();try{i.forEach(async s=>{let{stream_type:a}=s,c=a===_i.Audio?ke.AUDIO:ke.VIDEO;await this._p2pChannel.unsubscribe(o,c),this._handleMuteStream(r,c,!0)}),e()}catch(s){t(s)}}}),this._gateway.signal.on(ar.CONTROL,async(n,e)=>{let{action:t}=n;switch(t){case sc.MUTE_LOCAL_VIDEO:this._handleMuteStream(e,ke.VIDEO,!0);break;case sc.MUTE_LOCAL_AUDIO:this._handleMuteStream(e,ke.AUDIO,!0);break;case sc.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",e),this._handleMuteStream(e,ke.VIDEO,!1);break;case sc.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",e),this._handleMuteStream(e,ke.AUDIO,!1)}}),this._gateway.signal.on(ar.RESTART_ICE,async(n,e,t)=>{if(this.store.useP2P)try{let{direction:i,iceParameter:r}=n;i!==Ke.SEND_ONLY||r?e(await this._p2pChannel.restartICE(i,r)):(this._p2pChannel.handleDisconnect(i),e())}catch(i){t(i)}}),this._gateway.signal.on(ar.CANDIDATE,n=>{if(this.store.useP2P){let{candidate:e,direction:t}=n;this._p2pChannel.addRemoteCandidate(e,t)}}),this._p2pChannel.on(we.RequestP2PRestartICE,async(n,e,t)=>{try{let{direction:i}=n;e(await this._gateway.sendExtensionMessage(ar.RESTART_ICE,n,i===Ke.SEND_ONLY))}catch(i){t(i)}}),this._p2pChannel.on(we.LocalCandidate,n=>{this._gateway.sendExtensionMessage(ar.CANDIDATE,JSON.stringify(n),!0)}),this._p2pChannel.on(we.RequestP2PMuteLocal,async(n,e,t)=>{try{await this._gateway.sendExtensionMessage(ar.CONTROL,n,!0),e()}catch(i){t(i)}}),this._p2pChannel.on(we.RequestP2PUnmuteRemote,async(n,e,t)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(n,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(i){i.code===L.DISCONNECT_P2P?e():t(i)}else e()}),this._p2pChannel.on(we.RequestP2PMuteRemote,async(n,e,t)=>{if(this._joinInfo)try{await this._gateway.muteRemote(n,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(i){i.code===L.DISCONNECT_P2P?e():t(i)}else e()}),this._p2pChannel.on(we.StateChange,(n,e)=>{e===ue.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(we.PeerConnectionStateChange,n=>{let e=this._peerConnectionState;n!==e&&(this.safeEmit(It.PEERCONNECTION_STATE_CHANGE,n,e),this._peerConnectionState=n)}),this._p2pChannel.on(we.RequestMuteLocal,async(n,e,t)=>{if(this._joinInfo)try{await this._gateway.muteLocal(n,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(i){i.code===L.DISCONNECT_P2P?e():t(i)}else e()}),this._p2pChannel.on(we.RequestUnmuteLocal,async(n,e,t)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(n,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(i){i.code===L.DISCONNECT_P2P?e():t(i)}else e()}),this._p2pChannel.on(we.RequestRePublish,(n,e,t)=>{this.publish(n,!1).then(e).catch(t)}),this._p2pChannel.on(we.RequestRePublishDataChannel,(n,e,t)=>{Z.all(n.map(async i=>{let r=await this._p2pChannel.publishDataChannel([i]);try{r.forEach(o=>{this._uid&&this._gateway.publishDataChannel(this._uid,o,!0)})}catch(o){if(o.code!==L.DISCONNECT_P2P)throw o}})).then(e).catch(t)}),this._p2pChannel.on(we.RequestReSubscribe,async(n,e,t)=>{try{for(let{user:i,kind:r}of n)r===ke.VIDEO?await this.subscribe(i,"video"):await this.subscribe(i,"audio");e()}catch(i){t(i)}}),this._p2pChannel.on(we.RequestUpload,(n,e)=>{this._gateway.upload(n,e)}),this._p2pChannel.on(we.RequestUploadStats,n=>{this._gateway.uploadWRTCStats(n)}),this._p2pChannel.on(we.MediaReconnectStart,n=>{this.safeEmit(It.MEDIA_RECONNECT_START,n)}),this._p2pChannel.on(we.MediaReconnectEnd,n=>{this.safeEmit(It.MEDIA_RECONNECT_END,n)}),this._p2pChannel.on(we.NeedSignalRTT,n=>{n(this._gateway.getSignalRTT())}),this._p2pChannel.on(we.RequestRestartICE,async n=>{if(this.store.useP2P)return;let e=await this._p2pChannel.restartICE(n),t=await e.next();if(t.done)return;let i=t.value,r;try{r=await this._gateway.restartICE({iceParameters:i})}catch(s){return void e.throw(s)}let{iceParameters:o}=function(s){let a=s.iceParameters;return{iceParameters:{iceUfrag:a.iceUfrag,icePwd:a.icePwd}}}(r);await e.next({remoteIceParameters:o})}),this._p2pChannel.on(we.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(we.RequestReconnectPC,async()=>{var n;let{iceParameters:e,dtlsParameters:t,rtpCapabilities:i}=await this._p2pChannel.startP2PConnection({turnServer:(n=this._joinInfo)===null||n===void 0?void 0:n.turnServer}),{gatewayEstablishParams:r,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:e,dtlsParameters:t,rtpCapabilities:i}),s=aC(r,o);await this._p2pChannel.connect(s),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(we.RequestUnpublishForReconnectPC,async(n,e,t)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(n,this._uid),e()):t()}),this._p2pChannel.on(we.P2PLost,()=>{this.safeEmit(It.P2P_LOST,this.store.uid)}),this._p2pChannel.on(we.UpdateVideoEncoder,n=>{n._encoderConfig&&this._gateway.setVideoProfile(n._encoderConfig)}),this._p2pChannel.on(we.ConnectionTypeChange,n=>{this.safeEmit(It.IS_USING_CLOUD_PROXY,n),this._gateway.setUsingProxy(n)}),this._p2pChannel.on(we.FirstVideoBufferReady,(n,e)=>{this.safeEmit(It.FIRST_VIDEO_BUFFER_READY,n,e)}),this._p2pChannel.on(we.FirstVideoPreRender,(n,e)=>{this.safeEmit(It.FIRST_VIDEO_PRE_RENDER,n,e)}),this._p2pChannel.on(we.RequestLowStreamParameter,n=>{n(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(we.QueryClientConnectionState,n=>{n(this.connectionState)}),this._p2pChannel.on(we.AudioMetadata,n=>{this.safeEmit(It.AUDIO_METADATA,n)}),this._p2pChannel.on(we.AudioPts,n=>{this.safeEmit(It.AUDIO_PTS,Number(n))})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(n){if(!this._joinInfo||this.connectionState!=="CONNECTED")throw new H(L.INVALID_OPERATION,"[".concat(this._clientId,"] can not create content inspect, please join channel first"));if(this._inspect)throw new H(L.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));try{let t=(e={config:n},go("ContentInspect").create(e));this._inspect=t,this.handleVideoInspectEvents(t);let{appId:i,cname:r,sid:o,token:s,uid:a,cid:c,vid:d}=this._joinInfo;await t.init({appId:i,areaCode:"",cname:r,sid:o,token:s,uid:a,cid:c,vid:d?Number(d):0},mr)}catch(t){throw Array.isArray(t)?t[0]:t}var e}handleVideoInspectEvents(n){n.on(sr.CONNECTION_STATE_CHANGE,(e,t)=>{if(this.safeEmit(It.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,e,t),t===xe.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(It.CONTENT_INSPECT_ERROR,new H(L.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));n.inspectImage()}}),n.on(sr.INSPECT_RESULT,(e,t)=>{var i;if((t==null?void 0:t.code)===L.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return y.debug("Stop inspect content because that has left channel"),this==null||(i=this._inspect)===null||i===void 0||i.close(),void(this._inspect=void 0);this.safeEmit(It.CONTENT_INSPECT_RESULT,e,t)}),n.on(sr.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(t=>t.trackMediaType==="video")[0])})}async disableContentInspect(){if(!this._inspect)throw new H(L.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(n){throw Array.isArray(n)?n[0]:n}}async setImageModeration(n,e){if(oe(n,"enabled"),n){if(!e)throw new H(L.INVALID_PARAMS,"config is required");if(kC(e),!this._joinInfo)throw new H(L.INVALID_OPERATION,"can not create image moderation, please join channel first");try{if(this._moderation)this._moderation.updateConfig(e);else{let i=(t={config:e},go("ImageModeration").create(t));this._moderation=i,this.handleImageModerationEvents(i);let{appId:r,cname:o,sid:s,token:a,uid:c,cid:d,vid:l}=this._joinInfo;await i.init({appId:r,areaCode:"",cname:o,sid:s,token:a,uid:c,cid:d,vid:l?Number(l):0},mr)}}catch(i){throw Array.isArray(i)?i[0]:i}}else{var t;if(!this._moderation)throw new H(L.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(i){throw Array.isArray(i)?i[0]:i}}}handleImageModerationEvents(n){n.on(Yn.CONNECTION_STATE_CHANGE,(e,t)=>{if(this.safeEmit(It.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,e,t),e===$n.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new H(L.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");n.inspectImage()}}),n.on(Yn.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(t=>t.trackMediaType==="video")[0])})}setP2PTransport(n){if(function(e){xi(e,"transport",["default","auto","relay","sd-rtn"])}(n),this.mode!=="p2p")throw new H(L.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=n,y.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(n))}getJoinChannelServiceRecords(){return y.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(n){oe(n,"enabled"),$e("ENABLE_PUBLISH_AUDIO_FILTER",n),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(n)}_setRteInfo(n,e){this.store.rteUrl=n,this.store.rteSid=e}_isPreRender(){return"isPreRender"in this._p2pChannel&&this._p2pChannel.isPreRender()}_handleResetAddStream(n,e){switch(e){case"audio":n._audio_added_=!1,n._trust_audio_stream_added_state_=!0;break;case"video":n._video_added_=!1,n._trust_video_stream_added_state_=!0}}},Oe(Pe.prototype,"leave",[E2],Object.getOwnPropertyDescriptor(Pe.prototype,"leave"),Pe.prototype),Oe(Pe.prototype,"publish",[VL],Object.getOwnPropertyDescriptor(Pe.prototype,"publish"),Pe.prototype),Oe(Pe.prototype,"unpublish",[FL],Object.getOwnPropertyDescriptor(Pe.prototype,"unpublish"),Pe.prototype),Oe(Pe.prototype,"subscribe",[BL],Object.getOwnPropertyDescriptor(Pe.prototype,"subscribe"),Pe.prototype),Oe(Pe.prototype,"presubscribe",[jL],Object.getOwnPropertyDescriptor(Pe.prototype,"presubscribe"),Pe.prototype),Oe(Pe.prototype,"massSubscribe",[GL],Object.getOwnPropertyDescriptor(Pe.prototype,"massSubscribe"),Pe.prototype),Oe(Pe.prototype,"unsubscribe",[WL],Object.getOwnPropertyDescriptor(Pe.prototype,"unsubscribe"),Pe.prototype),Oe(Pe.prototype,"massUnsubscribe",[HL],Object.getOwnPropertyDescriptor(Pe.prototype,"massUnsubscribe"),Pe.prototype),Oe(Pe.prototype,"setLowStreamParameter",[KL],Object.getOwnPropertyDescriptor(Pe.prototype,"setLowStreamParameter"),Pe.prototype),Oe(Pe.prototype,"setDualStreamMode",[YL],Object.getOwnPropertyDescriptor(Pe.prototype,"setDualStreamMode"),Pe.prototype),Oe(Pe.prototype,"enableDualStream",[zL],Object.getOwnPropertyDescriptor(Pe.prototype,"enableDualStream"),Pe.prototype),Oe(Pe.prototype,"disableDualStream",[qL],Object.getOwnPropertyDescriptor(Pe.prototype,"disableDualStream"),Pe.prototype),Oe(Pe.prototype,"setClientRole",[XL],Object.getOwnPropertyDescriptor(Pe.prototype,"setClientRole"),Pe.prototype),Oe(Pe.prototype,"_setClientRoleOptions",[JL],Object.getOwnPropertyDescriptor(Pe.prototype,"_setClientRoleOptions"),Pe.prototype),Oe(Pe.prototype,"setProxyServer",[QL],Object.getOwnPropertyDescriptor(Pe.prototype,"setProxyServer"),Pe.prototype),Oe(Pe.prototype,"setTurnServer",[ZL],Object.getOwnPropertyDescriptor(Pe.prototype,"setTurnServer"),Pe.prototype),Oe(Pe.prototype,"setLicense",[$L],Object.getOwnPropertyDescriptor(Pe.prototype,"setLicense"),Pe.prototype),Oe(Pe.prototype,"startProxyServer",[ek],Object.getOwnPropertyDescriptor(Pe.prototype,"startProxyServer"),Pe.prototype),Oe(Pe.prototype,"stopProxyServer",[tk],Object.getOwnPropertyDescriptor(Pe.prototype,"stopProxyServer"),Pe.prototype),Oe(Pe.prototype,"setLocalAccessPointsV2",[ik],Object.getOwnPropertyDescriptor(Pe.prototype,"setLocalAccessPointsV2"),Pe.prototype),Oe(Pe.prototype,"setLocalAccessPoints",[rk],Object.getOwnPropertyDescriptor(Pe.prototype,"setLocalAccessPoints"),Pe.prototype),Oe(Pe.prototype,"setRemoteDefaultVideoStreamType",[nk],Object.getOwnPropertyDescriptor(Pe.prototype,"setRemoteDefaultVideoStreamType"),Pe.prototype),Oe(Pe.prototype,"setRemoteVideoStreamType",[ok],Object.getOwnPropertyDescriptor(Pe.prototype,"setRemoteVideoStreamType"),Pe.prototype),Oe(Pe.prototype,"setStreamFallbackOption",[sk],Object.getOwnPropertyDescriptor(Pe.prototype,"setStreamFallbackOption"),Pe.prototype),Oe(Pe.prototype,"setEncryptionConfig",[ak],Object.getOwnPropertyDescriptor(Pe.prototype,"setEncryptionConfig"),Pe.prototype),Oe(Pe.prototype,"renewToken",[ck],Object.getOwnPropertyDescriptor(Pe.prototype,"renewToken"),Pe.prototype),Oe(Pe.prototype,"enableAudioVolumeIndicator",[dk],Object.getOwnPropertyDescriptor(Pe.prototype,"enableAudioVolumeIndicator"),Pe.prototype),Oe(Pe.prototype,"startLiveStreaming",[lk],Object.getOwnPropertyDescriptor(Pe.prototype,"startLiveStreaming"),Pe.prototype),Oe(Pe.prototype,"setLiveTranscoding",[uk],Object.getOwnPropertyDescriptor(Pe.prototype,"setLiveTranscoding"),Pe.prototype),Oe(Pe.prototype,"stopLiveStreaming",[hk],Object.getOwnPropertyDescriptor(Pe.prototype,"stopLiveStreaming"),Pe.prototype),Oe(Pe.prototype,"startChannelMediaRelay",[pk],Object.getOwnPropertyDescriptor(Pe.prototype,"startChannelMediaRelay"),Pe.prototype),Oe(Pe.prototype,"updateChannelMediaRelay",[_k],Object.getOwnPropertyDescriptor(Pe.prototype,"updateChannelMediaRelay"),Pe.prototype),Oe(Pe.prototype,"stopChannelMediaRelay",[fk],Object.getOwnPropertyDescriptor(Pe.prototype,"stopChannelMediaRelay"),Pe.prototype),Oe(Pe.prototype,"sendCustomReportMessage",[mk],Object.getOwnPropertyDescriptor(Pe.prototype,"sendCustomReportMessage"),Pe.prototype),Oe(Pe.prototype,"pickSVCLayer",[Ek],Object.getOwnPropertyDescriptor(Pe.prototype,"pickSVCLayer"),Pe.prototype),Oe(Pe.prototype,"setRTMConfig",[gk],Object.getOwnPropertyDescriptor(Pe.prototype,"setRTMConfig"),Pe.prototype),Oe(Pe.prototype,"enableContentInspect",[Sk],Object.getOwnPropertyDescriptor(Pe.prototype,"enableContentInspect"),Pe.prototype),Oe(Pe.prototype,"disableContentInspect",[Tk],Object.getOwnPropertyDescriptor(Pe.prototype,"disableContentInspect"),Pe.prototype),Oe(Pe.prototype,"setImageModeration",[Rk],Object.getOwnPropertyDescriptor(Pe.prototype,"setImageModeration"),Pe.prototype),Oe(Pe.prototype,"setP2PTransport",[vk],Object.getOwnPropertyDescriptor(Pe.prototype,"setP2PTransport"),Pe.prototype),Oe(Pe.prototype,"getJoinChannelServiceRecords",[Ck],Object.getOwnPropertyDescriptor(Pe.prototype,"getJoinChannelServiceRecords"),Pe.prototype),Oe(Pe.prototype,"setPublishAudioFilterEnabled",[yk],Object.getOwnPropertyDescriptor(Pe.prototype,"setPublishAudioFilterEnabled"),Pe.prototype),Pe);function g2(){var n;let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"},t=vt(5,"client-"),i=_e.reportApiInvoke(null,{id:t,name:Yi.CREATE_CLIENT,options:[e],tag:ct.TRACER});try{(function(r){xi(r.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),xi(r.mode,"config.mode",["rtc","live","p2p"]),r.audioCodec!==void 0&&xi(r.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),r.proxyServer!==void 0&&_n(r.proxyServer,"config.proxyServer",1,1e4),r.turnServer!==void 0&&bh(r.turnServer),r.httpRetryConfig!==void 0&&bi(r.httpRetryConfig),r.websocketRetryConfig!==void 0&&bi(r.websocketRetryConfig)})(e)}catch(r){throw i.onError(r),r}return(bN(16,0,!0)||mv(16,0,!0))&&(e.codec==="vp9"&&(e.codec="vp8",y.debug("browser not support vp9, force use vp8")),$e("UNSUPPORTED_VIDEO_CODEC",["vp9"])),e.audioCodec===void 0&&(e.audioCodec="opus"),i.onSuccess(),new Wc(hc(hc({forceWaitGatewayResponse:!0},e),{},{role:z(n=["rtc","p2p"]).call(n,e.mode)?"host":e.role||"audience"}),t)}function S2(){let n=!1,e=Zt();return(e.name===pt.CHROME&&Number(e.version)>=58&&(Ac.engine.name!=="WebKit"||function(){let t=Zt();if(tT()){if(t.os===pr.MAC_OS)return!0;if(t.os===pr.IOS){let i=Ac.os.version&&Ac.os.version.split(".");if(i&&Number(i[0])===14&&i[1]&&Number(i[1])>=3||i&&Number(i[0])>14)return!0}}return!1}())||e.name===pt.FIREFOX&&Number(e.version)>=56||e.name===pt.OPERA&&Number(e.version)>=45||e.name===pt.SAFARI&&Number(e.version)>=11||e.name==="WebKit"&&(Ht()||ic())&&e.osVersion&&Number(e.osVersion.split(".")[0])>=11||rc()||Zt().name===pt.QQ)&&(n=!0),n}class oR{constructor(e,t){U(this,"id",0),U(this,"element",void 0),U(this,"peerPair",void 0),U(this,"context",void 0),U(this,"audioPlayerElement",void 0),U(this,"audioTrack",void 0),oR.count+=1,this.id=oR.count,this.element=e,this.context=t}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{let t=document.createElement("audio");t.srcObject=new MediaStream([e.track]),t.play(),this.audioPlayerElement=t}}async switchSdp(){if(!this.peerPair)return;let e=async(i,r)=>{let o=r==="offer"?await i.createOffer():await i.createAnswer();return await i.setLocalDescription(o),i.iceGatheringState==="complete"?i.localDescription:new Z(s=>{i.onicegatheringstatechange=()=>{i.iceGatheringState==="complete"&&s(i.localDescription)}})},t=async(i,r)=>await i.setRemoteDescription(r);try{let i=await e(this.peerPair[0],"offer");await t(this.peerPair[1],i);let r=await e(this.peerPair[1],"answer");await t(this.peerPair[0],r)}catch(i){throw new H(L.LOCAL_AEC_ERROR,i.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let t;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),t=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(e).connect(t)}catch(r){throw new H(L.LOCAL_AEC_ERROR,r.toString()).print()}if(!t)throw new H(L.LOCAL_AEC_ERROR,"no dest node when local aec").print();let i=t.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();let e=this.element,t=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(t),await this.switchSdp()}close(){y.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(e=>{e.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}var Am,sR;U(oR,"count",0);let MC=window.AudioContext||window.webkitAudioContext,Oz=new(Am=Xe({report:_e}),Oe((sR=class{constructor(){U(this,"units",[]),U(this,"context",void 0)}processExternalMediaAEC(n){if(!this._doesEnvironmentNeedAEC())return y.debug("the system does not need to process local aec"),-1;this.context||(this.context=new MC);let e=this.units.find(t=>t&&t.getElement()===n);return e||(e=new oR(n,this.context),this.units.push(e)),e.startEchoCancellation(),y.debug("start processing local audio echo cancellation, id is",e.id),e.id}_doesEnvironmentNeedAEC(){return Zt().name!==pt.SAFARI}}).prototype,"processExternalMediaAEC",[Am],Object.getOwnPropertyDescriptor(sR.prototype,"processExternalMediaAEC"),sR.prototype),sR);function T2(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function Ik(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?T2(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):T2(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}let UC=window||document;function xC(n){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!UC)return;let t=Kr._cspEventHandlerPointer;if(t&&e)return void console.error(t,e);let i=r=>{if(!(r&&r.blockedURI&&(Kr.onSecurityPolicyViolation||Kr.getListeners($i.SECURITY_POLICY_VIOLATION).length>0)))return;let o=r.blockedURI;F("CSP_DETECTED_HOSTNAME_LIST").some(s=>z(o).call(o,s))&&(Kr.onSecurityPolicyViolation&&typeof Kr.onSecurityPolicyViolation=="function"&&Kr.onSecurityPolicyViolation(r),Kr.getListeners($i.SECURITY_POLICY_VIOLATION).length>0&&Kr.safeEmit($i.SECURITY_POLICY_VIOLATION,r))};t&&UC.removeEventListener("securitypolicyviolation",t),(e||n&&typeof n=="function"||Kr.getListeners($i.SECURITY_POLICY_VIOLATION).length>0)&&UC.addEventListener("securitypolicyviolation",i),Kr._cspEventHandlerPointer=i}var R2=me,Nz=gS,v2=RegExp.prototype,C2=function(n){return n===v2||R2(v2,n)?Nz(n):n.flags},Vo=A(C2);function On(n){let e=n.length;for(;--e>=0;)n[e]=0}let zh=256,VC=286,wm=30,qu=15,G_=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),bm=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),FC=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),y2=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ul=new Array(576);On(Ul);let pc=new Array(60);On(pc);let Xu=new Array(512);On(Xu);let Ju=new Array(256);On(Ju);let W_=new Array(29);On(W_);let Om=new Array(wm);function Nm(n,e,t,i,r){this.static_tree=n,this.extra_bits=e,this.extra_base=t,this.elems=i,this.max_length=r,this.has_stree=n&&n.length}let BC,Ak,wk;function jC(n,e){this.dyn_tree=n,this.max_code=0,this.stat_desc=e}On(Om);let GC=n=>n<256?Xu[n]:Xu[256+(n>>>7)],Dm=(n,e)=>{n.pending_buf[n.pending++]=255&e,n.pending_buf[n.pending++]=e>>>8&255},Jo=(n,e,t)=>{n.bi_valid>16-t?(n.bi_buf|=e<<n.bi_valid&65535,Dm(n,n.bi_buf),n.bi_buf=e>>16-n.bi_valid,n.bi_valid+=t-16):(n.bi_buf|=e<<n.bi_valid&65535,n.bi_valid+=t)},Xn=(n,e,t)=>{Jo(n,t[2*e],t[2*e+1])},Zd=(n,e)=>{let t=0;do t|=1&n,n>>>=1,t<<=1;while(--e>0);return t>>>1},bk=(n,e,t)=>{let i=new Array(16),r,o,s=0;for(r=1;r<=qu;r++)s=s+t[r-1]<<1,i[r]=s;for(o=0;o<=e;o++){let a=n[2*o+1];a!==0&&(n[2*o]=Zd(i[a]++,a))}},Ok=n=>{let e;for(e=0;e<VC;e++)n.dyn_ltree[2*e]=0;for(e=0;e<wm;e++)n.dyn_dtree[2*e]=0;for(e=0;e<19;e++)n.bl_tree[2*e]=0;n.dyn_ltree[512]=1,n.opt_len=n.static_len=0,n.sym_next=n.matches=0},Nk=n=>{n.bi_valid>8?Dm(n,n.bi_buf):n.bi_valid>0&&(n.pending_buf[n.pending++]=n.bi_buf),n.bi_buf=0,n.bi_valid=0},Dk=(n,e,t,i)=>{let r=2*e,o=2*t;return n[r]<n[o]||n[r]===n[o]&&i[e]<=i[t]},WC=(n,e,t)=>{let i=n.heap[t],r=t<<1;for(;r<=n.heap_len&&(r<n.heap_len&&Dk(e,n.heap[r+1],n.heap[r],n.depth)&&r++,!Dk(e,i,n.heap[r],n.depth));)n.heap[t]=n.heap[r],t=r,r<<=1;n.heap[t]=i},HC=(n,e,t)=>{let i,r,o,s,a=0;if(n.sym_next!==0)do i=255&n.pending_buf[n.sym_buf+a++],i+=(255&n.pending_buf[n.sym_buf+a++])<<8,r=n.pending_buf[n.sym_buf+a++],i===0?Xn(n,r,e):(o=Ju[r],Xn(n,o+zh+1,e),s=G_[o],s!==0&&(r-=W_[o],Jo(n,r,s)),i--,o=GC(i),Xn(n,o,t),s=bm[o],s!==0&&(i-=Om[o],Jo(n,i,s)));while(a<n.sym_next);Xn(n,256,e)},KC=(n,e)=>{let t=e.dyn_tree,i=e.stat_desc.static_tree,r=e.stat_desc.has_stree,o=e.stat_desc.elems,s,a,c,d=-1;for(n.heap_len=0,n.heap_max=573,s=0;s<o;s++)t[2*s]!==0?(n.heap[++n.heap_len]=d=s,n.depth[s]=0):t[2*s+1]=0;for(;n.heap_len<2;)c=n.heap[++n.heap_len]=d<2?++d:0,t[2*c]=1,n.depth[c]=0,n.opt_len--,r&&(n.static_len-=i[2*c+1]);for(e.max_code=d,s=n.heap_len>>1;s>=1;s--)WC(n,t,s);c=o;do s=n.heap[1],n.heap[1]=n.heap[n.heap_len--],WC(n,t,1),a=n.heap[1],n.heap[--n.heap_max]=s,n.heap[--n.heap_max]=a,t[2*c]=t[2*s]+t[2*a],n.depth[c]=(n.depth[s]>=n.depth[a]?n.depth[s]:n.depth[a])+1,t[2*s+1]=t[2*a+1]=c,n.heap[1]=c++,WC(n,t,1);while(n.heap_len>=2);n.heap[--n.heap_max]=n.heap[1],((l,h)=>{let p=h.dyn_tree,f=h.max_code,m=h.stat_desc.static_tree,g=h.stat_desc.has_stree,S=h.stat_desc.extra_bits,T=h.stat_desc.extra_base,C=h.stat_desc.max_length,b,D,x,k,V,W,K=0;for(k=0;k<=qu;k++)l.bl_count[k]=0;for(p[2*l.heap[l.heap_max]+1]=0,b=l.heap_max+1;b<573;b++)D=l.heap[b],k=p[2*p[2*D+1]+1]+1,k>C&&(k=C,K++),p[2*D+1]=k,D>f||(l.bl_count[k]++,V=0,D>=T&&(V=S[D-T]),W=p[2*D],l.opt_len+=W*(k+V),g&&(l.static_len+=W*(m[2*D+1]+V)));if(K!==0){do{for(k=C-1;l.bl_count[k]===0;)k--;l.bl_count[k]--,l.bl_count[k+1]+=2,l.bl_count[C]--,K-=2}while(K>0);for(k=C;k!==0;k--)for(D=l.bl_count[k];D!==0;)x=l.heap[--b],x>f||(p[2*x+1]!==k&&(l.opt_len+=(k-p[2*x+1])*p[2*x],p[2*x+1]=k),D--)}})(n,e),bk(t,d,n.bl_count)},YC=(n,e,t)=>{let i,r,o=-1,s=e[1],a=0,c=7,d=4;for(s===0&&(c=138,d=3),e[2*(t+1)+1]=65535,i=0;i<=t;i++)r=s,s=e[2*(i+1)+1],++a<c&&r===s||(a<d?n.bl_tree[2*r]+=a:r!==0?(r!==o&&n.bl_tree[2*r]++,n.bl_tree[32]++):a<=10?n.bl_tree[34]++:n.bl_tree[36]++,a=0,o=r,s===0?(c=138,d=3):r===s?(c=6,d=3):(c=7,d=4))},Pk=(n,e,t)=>{let i,r,o=-1,s=e[1],a=0,c=7,d=4;for(s===0&&(c=138,d=3),i=0;i<=t;i++)if(r=s,s=e[2*(i+1)+1],!(++a<c&&r===s)){if(a<d)do Xn(n,r,n.bl_tree);while(--a!=0);else r!==0?(r!==o&&(Xn(n,r,n.bl_tree),a--),Xn(n,16,n.bl_tree),Jo(n,a-3,2)):a<=10?(Xn(n,17,n.bl_tree),Jo(n,a-3,3)):(Xn(n,18,n.bl_tree),Jo(n,a-11,7));a=0,o=r,s===0?(c=138,d=3):r===s?(c=6,d=3):(c=7,d=4)}},Lk=!1,kk=(n,e,t,i)=>{Jo(n,0+(i?1:0),3),Nk(n),Dm(n,t),Dm(n,~t),t&&n.pending_buf.set(n.window.subarray(e,e+t),n.pending),n.pending+=t};var I2=n=>{Lk||((()=>{let e,t,i,r,o,s=new Array(16);for(i=0,r=0;r<28;r++)for(W_[r]=i,e=0;e<1<<G_[r];e++)Ju[i++]=r;for(Ju[i-1]=r,o=0,r=0;r<16;r++)for(Om[r]=o,e=0;e<1<<bm[r];e++)Xu[o++]=r;for(o>>=7;r<wm;r++)for(Om[r]=o<<7,e=0;e<1<<bm[r]-7;e++)Xu[256+o++]=r;for(t=0;t<=qu;t++)s[t]=0;for(e=0;e<=143;)Ul[2*e+1]=8,e++,s[8]++;for(;e<=255;)Ul[2*e+1]=9,e++,s[9]++;for(;e<=279;)Ul[2*e+1]=7,e++,s[7]++;for(;e<=287;)Ul[2*e+1]=8,e++,s[8]++;for(bk(Ul,287,s),e=0;e<wm;e++)pc[2*e+1]=5,pc[2*e]=Zd(e,5);BC=new Nm(Ul,G_,257,VC,qu),Ak=new Nm(pc,bm,0,wm,qu),wk=new Nm(new Array(0),FC,0,19,7)})(),Lk=!0),n.l_desc=new jC(n.dyn_ltree,BC),n.d_desc=new jC(n.dyn_dtree,Ak),n.bl_desc=new jC(n.bl_tree,wk),n.bi_buf=0,n.bi_valid=0,Ok(n)},Dz=(n,e,t,i)=>{let r,o,s=0;n.level>0?(n.strm.data_type===2&&(n.strm.data_type=(a=>{let c,d=4093624447;for(c=0;c<=31;c++,d>>>=1)if(1&d&&a.dyn_ltree[2*c]!==0)return 0;if(a.dyn_ltree[18]!==0||a.dyn_ltree[20]!==0||a.dyn_ltree[26]!==0)return 1;for(c=32;c<zh;c++)if(a.dyn_ltree[2*c]!==0)return 1;return 0})(n)),KC(n,n.l_desc),KC(n,n.d_desc),s=(a=>{let c;for(YC(a,a.dyn_ltree,a.l_desc.max_code),YC(a,a.dyn_dtree,a.d_desc.max_code),KC(a,a.bl_desc),c=18;c>=3&&a.bl_tree[2*y2[c]+1]===0;c--);return a.opt_len+=3*(c+1)+5+5+4,c})(n),r=n.opt_len+3+7>>>3,o=n.static_len+3+7>>>3,o<=r&&(r=o)):r=o=t+5,t+4<=r&&e!==-1?kk(n,e,t,i):n.strategy===4||o===r?(Jo(n,2+(i?1:0),3),HC(n,Ul,pc)):(Jo(n,4+(i?1:0),3),((a,c,d,l)=>{let h;for(Jo(a,c-257,5),Jo(a,d-1,5),Jo(a,l-4,4),h=0;h<l;h++)Jo(a,a.bl_tree[2*y2[h]+1],3);Pk(a,a.dyn_ltree,c-1),Pk(a,a.dyn_dtree,d-1)})(n,n.l_desc.max_code+1,n.d_desc.max_code+1,s+1),HC(n,n.dyn_ltree,n.dyn_dtree)),Ok(n),i&&Nk(n)},Pz=(n,e,t)=>(n.pending_buf[n.sym_buf+n.sym_next++]=e,n.pending_buf[n.sym_buf+n.sym_next++]=e>>8,n.pending_buf[n.sym_buf+n.sym_next++]=t,e===0?n.dyn_ltree[2*t]++:(n.matches++,e--,n.dyn_ltree[2*(Ju[t]+zh+1)]++,n.dyn_dtree[2*GC(e)]++),n.sym_next===n.sym_end),Lz=n=>{Jo(n,2,3),Xn(n,256,Ul),(e=>{e.bi_valid===16?(Dm(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(n)},kz={_tr_init:I2,_tr_stored_block:kk,_tr_flush_block:Dz,_tr_tally:Pz,_tr_align:Lz},aR=(n,e,t,i)=>{let r=65535&n|0,o=n>>>16&65535|0,s=0;for(;t!==0;){s=t>2e3?2e3:t,t-=s;do r=r+e[i++]|0,o=o+r|0;while(--s);r%=65521,o%=65521}return r|o<<16|0};let cR=new Uint32Array((()=>{let n,e=[];for(var t=0;t<256;t++){n=t;for(var i=0;i<8;i++)n=1&n?3988292384^n>>>1:n>>>1;e[t]=n}return e})());var Qo=(n,e,t,i)=>{let r=cR,o=i+t;n^=-1;for(let s=i;s<o;s++)n=n>>>8^r[255&(n^e[s])];return-1^n},Nn={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},xl={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_UNKNOWN:2,Z_DEFLATED:8};let{_tr_init:zC,_tr_stored_block:Mk,_tr_flush_block:Uk,_tr_tally:qh,_tr_align:Xh}=kz,{Z_NO_FLUSH:Jh,Z_PARTIAL_FLUSH:Qh,Z_FULL_FLUSH:Mz,Z_FINISH:Hc,Z_BLOCK:_c,Z_OK:Zo,Z_STREAM_END:$o,Z_STREAM_ERROR:$d,Z_DATA_ERROR:Vl,Z_BUF_ERROR:xk,Z_DEFAULT_COMPRESSION:Vk,Z_FILTERED:Uz,Z_HUFFMAN_ONLY:qC,Z_RLE:XC,Z_FIXED:xz,Z_DEFAULT_STRATEGY:Vz,Z_UNKNOWN:Fz,Z_DEFLATED:JC}=xl,Pm=286,Fk=30,Bz=19,jz=2*Pm+1,Gz=15,H_=258,Ps=262,oa=42,Kc=113,el=666,tl=(n,e)=>(n.msg=Nn[e],e),Zh=n=>2*n-(n>4?9:0),Qu=n=>{let e=n.length;for(;--e>=0;)n[e]=0},$h=n=>{let e,t,i,r=n.w_size;e=n.hash_size,i=e;do t=n.head[--i],n.head[i]=t>=r?t-r:0;while(--e);e=r,i=e;do t=n.prev[--i],n.prev[i]=t>=r?t-r:0;while(--e)},ep=(n,e,t)=>(e<<n.hash_shift^t)&n.hash_mask,To=n=>{let e=n.state,t=e.pending;t>n.avail_out&&(t=n.avail_out),t!==0&&(n.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+t),n.next_out),n.next_out+=t,e.pending_out+=t,n.total_out+=t,n.avail_out-=t,e.pending-=t,e.pending===0&&(e.pending_out=0))},Rn=(n,e)=>{Uk(n,n.block_start>=0?n.block_start:-1,n.strstart-n.block_start,e),n.block_start=n.strstart,To(n.strm)},Oi=(n,e)=>{n.pending_buf[n.pending++]=e},dr=(n,e)=>{n.pending_buf[n.pending++]=e>>>8&255,n.pending_buf[n.pending++]=255&e},K_=(n,e,t,i)=>{let r=n.avail_in;return r>i&&(r=i),r===0?0:(n.avail_in-=r,e.set(n.input.subarray(n.next_in,n.next_in+r),t),n.state.wrap===1?n.adler=aR(n.adler,e,r,t):n.state.wrap===2&&(n.adler=Qo(n.adler,e,r,t)),n.next_in+=r,n.total_in+=r,r)},QC=(n,e)=>{let t,i,r=n.max_chain_length,o=n.strstart,s=n.prev_length,a=n.nice_match,c=n.strstart>n.w_size-Ps?n.strstart-(n.w_size-Ps):0,d=n.window,l=n.w_mask,h=n.prev,p=n.strstart+H_,f=d[o+s-1],m=d[o+s];n.prev_length>=n.good_match&&(r>>=2),a>n.lookahead&&(a=n.lookahead);do if(t=e,d[t+s]===m&&d[t+s-1]===f&&d[t]===d[o]&&d[++t]===d[o+1]){o+=2,t++;do;while(d[++o]===d[++t]&&d[++o]===d[++t]&&d[++o]===d[++t]&&d[++o]===d[++t]&&d[++o]===d[++t]&&d[++o]===d[++t]&&d[++o]===d[++t]&&d[++o]===d[++t]&&o<p);if(i=H_-(p-o),o=p-H_,i>s){if(n.match_start=e,s=i,i>=a)break;f=d[o+s-1],m=d[o+s]}}while((e=h[e&l])>c&&--r!=0);return s<=n.lookahead?s:n.lookahead},Y_=n=>{let e=n.w_size,t,i,r;do{if(i=n.window_size-n.lookahead-n.strstart,n.strstart>=e+(e-Ps)&&(n.window.set(n.window.subarray(e,e+e-i),0),n.match_start-=e,n.strstart-=e,n.block_start-=e,n.insert>n.strstart&&(n.insert=n.strstart),$h(n),i+=e),n.strm.avail_in===0)break;if(t=K_(n.strm,n.window,n.strstart+n.lookahead,i),n.lookahead+=t,n.lookahead+n.insert>=3)for(r=n.strstart-n.insert,n.ins_h=n.window[r],n.ins_h=ep(n,n.ins_h,n.window[r+1]);n.insert&&(n.ins_h=ep(n,n.ins_h,n.window[r+3-1]),n.prev[r&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=r,r++,n.insert--,!(n.lookahead+n.insert<3)););}while(n.lookahead<Ps&&n.strm.avail_in!==0)},z_=(n,e)=>{let t,i,r,o=n.pending_buf_size-5>n.w_size?n.w_size:n.pending_buf_size-5,s=0,a=n.strm.avail_in;do{if(t=65535,r=n.bi_valid+42>>3,n.strm.avail_out<r||(r=n.strm.avail_out-r,i=n.strstart-n.block_start,t>i+n.strm.avail_in&&(t=i+n.strm.avail_in),t>r&&(t=r),t<o&&(t===0&&e!==Hc||e===Jh||t!==i+n.strm.avail_in)))break;s=e===Hc&&t===i+n.strm.avail_in?1:0,Mk(n,0,0,s),n.pending_buf[n.pending-4]=t,n.pending_buf[n.pending-3]=t>>8,n.pending_buf[n.pending-2]=~t,n.pending_buf[n.pending-1]=~t>>8,To(n.strm),i&&(i>t&&(i=t),n.strm.output.set(n.window.subarray(n.block_start,n.block_start+i),n.strm.next_out),n.strm.next_out+=i,n.strm.avail_out-=i,n.strm.total_out+=i,n.block_start+=i,t-=i),t&&(K_(n.strm,n.strm.output,n.strm.next_out,t),n.strm.next_out+=t,n.strm.avail_out-=t,n.strm.total_out+=t)}while(s===0);return a-=n.strm.avail_in,a&&(a>=n.w_size?(n.matches=2,n.window.set(n.strm.input.subarray(n.strm.next_in-n.w_size,n.strm.next_in),0),n.strstart=n.w_size,n.insert=n.strstart):(n.window_size-n.strstart<=a&&(n.strstart-=n.w_size,n.window.set(n.window.subarray(n.w_size,n.w_size+n.strstart),0),n.matches<2&&n.matches++,n.insert>n.strstart&&(n.insert=n.strstart)),n.window.set(n.strm.input.subarray(n.strm.next_in-a,n.strm.next_in),n.strstart),n.strstart+=a,n.insert+=a>n.w_size-n.insert?n.w_size-n.insert:a),n.block_start=n.strstart),n.high_water<n.strstart&&(n.high_water=n.strstart),s?4:e!==Jh&&e!==Hc&&n.strm.avail_in===0&&n.strstart===n.block_start?2:(r=n.window_size-n.strstart,n.strm.avail_in>r&&n.block_start>=n.w_size&&(n.block_start-=n.w_size,n.strstart-=n.w_size,n.window.set(n.window.subarray(n.w_size,n.w_size+n.strstart),0),n.matches<2&&n.matches++,r+=n.w_size,n.insert>n.strstart&&(n.insert=n.strstart)),r>n.strm.avail_in&&(r=n.strm.avail_in),r&&(K_(n.strm,n.window,n.strstart,r),n.strstart+=r,n.insert+=r>n.w_size-n.insert?n.w_size-n.insert:r),n.high_water<n.strstart&&(n.high_water=n.strstart),r=n.bi_valid+42>>3,r=n.pending_buf_size-r>65535?65535:n.pending_buf_size-r,o=r>n.w_size?n.w_size:r,i=n.strstart-n.block_start,(i>=o||(i||e===Hc)&&e!==Jh&&n.strm.avail_in===0&&i<=r)&&(t=i>r?r:i,s=e===Hc&&n.strm.avail_in===0&&t===i?1:0,Mk(n,n.block_start,t,s),n.block_start+=t,To(n.strm)),s?3:1)},ZC=(n,e)=>{let t,i;for(;;){if(n.lookahead<Ps){if(Y_(n),n.lookahead<Ps&&e===Jh)return 1;if(n.lookahead===0)break}if(t=0,n.lookahead>=3&&(n.ins_h=ep(n,n.ins_h,n.window[n.strstart+3-1]),t=n.prev[n.strstart&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=n.strstart),t!==0&&n.strstart-t<=n.w_size-Ps&&(n.match_length=QC(n,t)),n.match_length>=3)if(i=qh(n,n.strstart-n.match_start,n.match_length-3),n.lookahead-=n.match_length,n.match_length<=n.max_lazy_match&&n.lookahead>=3){n.match_length--;do n.strstart++,n.ins_h=ep(n,n.ins_h,n.window[n.strstart+3-1]),t=n.prev[n.strstart&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=n.strstart;while(--n.match_length!=0);n.strstart++}else n.strstart+=n.match_length,n.match_length=0,n.ins_h=n.window[n.strstart],n.ins_h=ep(n,n.ins_h,n.window[n.strstart+1]);else i=qh(n,0,n.window[n.strstart]),n.lookahead--,n.strstart++;if(i&&(Rn(n,!1),n.strm.avail_out===0))return 1}return n.insert=n.strstart<2?n.strstart:2,e===Hc?(Rn(n,!0),n.strm.avail_out===0?3:4):n.sym_next&&(Rn(n,!1),n.strm.avail_out===0)?1:2},tp=(n,e)=>{let t,i,r;for(;;){if(n.lookahead<Ps){if(Y_(n),n.lookahead<Ps&&e===Jh)return 1;if(n.lookahead===0)break}if(t=0,n.lookahead>=3&&(n.ins_h=ep(n,n.ins_h,n.window[n.strstart+3-1]),t=n.prev[n.strstart&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=n.strstart),n.prev_length=n.match_length,n.prev_match=n.match_start,n.match_length=2,t!==0&&n.prev_length<n.max_lazy_match&&n.strstart-t<=n.w_size-Ps&&(n.match_length=QC(n,t),n.match_length<=5&&(n.strategy===Uz||n.match_length===3&&n.strstart-n.match_start>4096)&&(n.match_length=2)),n.prev_length>=3&&n.match_length<=n.prev_length){r=n.strstart+n.lookahead-3,i=qh(n,n.strstart-1-n.prev_match,n.prev_length-3),n.lookahead-=n.prev_length-1,n.prev_length-=2;do++n.strstart<=r&&(n.ins_h=ep(n,n.ins_h,n.window[n.strstart+3-1]),t=n.prev[n.strstart&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=n.strstart);while(--n.prev_length!=0);if(n.match_available=0,n.match_length=2,n.strstart++,i&&(Rn(n,!1),n.strm.avail_out===0))return 1}else if(n.match_available){if(i=qh(n,0,n.window[n.strstart-1]),i&&Rn(n,!1),n.strstart++,n.lookahead--,n.strm.avail_out===0)return 1}else n.match_available=1,n.strstart++,n.lookahead--}return n.match_available&&(i=qh(n,0,n.window[n.strstart-1]),n.match_available=0),n.insert=n.strstart<2?n.strstart:2,e===Hc?(Rn(n,!0),n.strm.avail_out===0?3:4):n.sym_next&&(Rn(n,!1),n.strm.avail_out===0)?1:2};function sa(n,e,t,i,r){this.good_length=n,this.max_lazy=e,this.nice_length=t,this.max_chain=i,this.func=r}let Na=[new sa(0,0,0,0,z_),new sa(4,4,8,4,ZC),new sa(4,5,16,8,ZC),new sa(4,6,32,32,ZC),new sa(4,4,16,16,tp),new sa(8,16,32,32,tp),new sa(8,16,128,128,tp),new sa(8,32,128,256,tp),new sa(32,128,258,1024,tp),new sa(32,258,258,4096,tp)];function dR(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=JC,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*jz),this.dyn_dtree=new Uint16Array(2*(2*Fk+1)),this.bl_tree=new Uint16Array(2*(2*Bz+1)),Qu(this.dyn_ltree),Qu(this.dyn_dtree),Qu(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(Gz+1),this.heap=new Uint16Array(2*Pm+1),Qu(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*Pm+1),Qu(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}let lR=n=>{if(!n)return 1;let e=n.state;return!e||e.strm!==n||e.status!==oa&&e.status!==57&&e.status!==69&&e.status!==73&&e.status!==91&&e.status!==103&&e.status!==Kc&&e.status!==el?1:0},Lm=n=>{if(lR(n))return tl(n,$d);n.total_in=n.total_out=0,n.data_type=Fz;let e=n.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap===2?57:e.wrap?oa:Kc,n.adler=e.wrap===2?0:1,e.last_flush=-2,zC(e),Zo},Bk=n=>{let e=Lm(n);return e===Zo&&(t=>{t.window_size=2*t.w_size,Qu(t.head),t.max_lazy_match=Na[t.level].max_lazy,t.good_match=Na[t.level].good_length,t.nice_match=Na[t.level].nice_length,t.max_chain_length=Na[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=2,t.match_available=0,t.ins_h=0})(n.state),e},jk=(n,e,t,i,r,o)=>{if(!n)return $d;let s=1;if(e===Vk&&(e=6),i<0?(s=0,i=-i):i>15&&(s=2,i-=16),r<1||r>9||t!==JC||i<8||i>15||e<0||e>9||o<0||o>xz||i===8&&s!==1)return tl(n,$d);i===8&&(i=9);let a=new dR;return n.state=a,a.strm=n,a.status=oa,a.wrap=s,a.gzhead=null,a.w_bits=i,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=r+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<r+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=e,a.strategy=o,a.method=t,Bk(n)};var A2=(n,e)=>{if(lR(n)||e>_c||e<0)return n?tl(n,$d):$d;let t=n.state;if(!n.output||n.avail_in!==0&&!n.input||t.status===el&&e!==Hc)return tl(n,n.avail_out===0?xk:$d);let i=t.last_flush;if(t.last_flush=e,t.pending!==0){if(To(n),n.avail_out===0)return t.last_flush=-1,Zo}else if(n.avail_in===0&&Zh(e)<=Zh(i)&&e!==Hc)return tl(n,xk);if(t.status===el&&n.avail_in!==0)return tl(n,xk);if(t.status===oa&&t.wrap===0&&(t.status=Kc),t.status===oa){let r=JC+(t.w_bits-8<<4)<<8,o=-1;if(o=t.strategy>=qC||t.level<2?0:t.level<6?1:t.level===6?2:3,r|=o<<6,t.strstart!==0&&(r|=32),r+=31-r%31,dr(t,r),t.strstart!==0&&(dr(t,n.adler>>>16),dr(t,65535&n.adler)),n.adler=1,t.status=Kc,To(n),t.pending!==0)return t.last_flush=-1,Zo}if(t.status===57){if(n.adler=0,Oi(t,31),Oi(t,139),Oi(t,8),t.gzhead)Oi(t,(t.gzhead.text?1:0)+(t.gzhead.hcrc?2:0)+(t.gzhead.extra?4:0)+(t.gzhead.name?8:0)+(t.gzhead.comment?16:0)),Oi(t,255&t.gzhead.time),Oi(t,t.gzhead.time>>8&255),Oi(t,t.gzhead.time>>16&255),Oi(t,t.gzhead.time>>24&255),Oi(t,t.level===9?2:t.strategy>=qC||t.level<2?4:0),Oi(t,255&t.gzhead.os),t.gzhead.extra&&t.gzhead.extra.length&&(Oi(t,255&t.gzhead.extra.length),Oi(t,t.gzhead.extra.length>>8&255)),t.gzhead.hcrc&&(n.adler=Qo(n.adler,t.pending_buf,t.pending,0)),t.gzindex=0,t.status=69;else if(Oi(t,0),Oi(t,0),Oi(t,0),Oi(t,0),Oi(t,0),Oi(t,t.level===9?2:t.strategy>=qC||t.level<2?4:0),Oi(t,3),t.status=Kc,To(n),t.pending!==0)return t.last_flush=-1,Zo}if(t.status===69){if(t.gzhead.extra){let r=t.pending,o=(65535&t.gzhead.extra.length)-t.gzindex;for(;t.pending+o>t.pending_buf_size;){let a=t.pending_buf_size-t.pending;if(t.pending_buf.set(t.gzhead.extra.subarray(t.gzindex,t.gzindex+a),t.pending),t.pending=t.pending_buf_size,t.gzhead.hcrc&&t.pending>r&&(n.adler=Qo(n.adler,t.pending_buf,t.pending-r,r)),t.gzindex+=a,To(n),t.pending!==0)return t.last_flush=-1,Zo;r=0,o-=a}let s=new Uint8Array(t.gzhead.extra);t.pending_buf.set(s.subarray(t.gzindex,t.gzindex+o),t.pending),t.pending+=o,t.gzhead.hcrc&&t.pending>r&&(n.adler=Qo(n.adler,t.pending_buf,t.pending-r,r)),t.gzindex=0}t.status=73}if(t.status===73){if(t.gzhead.name){let r,o=t.pending;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>o&&(n.adler=Qo(n.adler,t.pending_buf,t.pending-o,o)),To(n),t.pending!==0)return t.last_flush=-1,Zo;o=0}r=t.gzindex<t.gzhead.name.length?255&t.gzhead.name.charCodeAt(t.gzindex++):0,Oi(t,r)}while(r!==0);t.gzhead.hcrc&&t.pending>o&&(n.adler=Qo(n.adler,t.pending_buf,t.pending-o,o)),t.gzindex=0}t.status=91}if(t.status===91){if(t.gzhead.comment){let r,o=t.pending;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>o&&(n.adler=Qo(n.adler,t.pending_buf,t.pending-o,o)),To(n),t.pending!==0)return t.last_flush=-1,Zo;o=0}r=t.gzindex<t.gzhead.comment.length?255&t.gzhead.comment.charCodeAt(t.gzindex++):0,Oi(t,r)}while(r!==0);t.gzhead.hcrc&&t.pending>o&&(n.adler=Qo(n.adler,t.pending_buf,t.pending-o,o))}t.status=103}if(t.status===103){if(t.gzhead.hcrc){if(t.pending+2>t.pending_buf_size&&(To(n),t.pending!==0))return t.last_flush=-1,Zo;Oi(t,255&n.adler),Oi(t,n.adler>>8&255),n.adler=0}if(t.status=Kc,To(n),t.pending!==0)return t.last_flush=-1,Zo}if(n.avail_in!==0||t.lookahead!==0||e!==Jh&&t.status!==el){let r=t.level===0?z_(t,e):t.strategy===qC?((o,s)=>{let a;for(;;){if(o.lookahead===0&&(Y_(o),o.lookahead===0)){if(s===Jh)return 1;break}if(o.match_length=0,a=qh(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++,a&&(Rn(o,!1),o.strm.avail_out===0))return 1}return o.insert=0,s===Hc?(Rn(o,!0),o.strm.avail_out===0?3:4):o.sym_next&&(Rn(o,!1),o.strm.avail_out===0)?1:2})(t,e):t.strategy===XC?((o,s)=>{let a,c,d,l,h=o.window;for(;;){if(o.lookahead<=H_){if(Y_(o),o.lookahead<=H_&&s===Jh)return 1;if(o.lookahead===0)break}if(o.match_length=0,o.lookahead>=3&&o.strstart>0&&(d=o.strstart-1,c=h[d],c===h[++d]&&c===h[++d]&&c===h[++d])){l=o.strstart+H_;do;while(c===h[++d]&&c===h[++d]&&c===h[++d]&&c===h[++d]&&c===h[++d]&&c===h[++d]&&c===h[++d]&&c===h[++d]&&d<l);o.match_length=H_-(l-d),o.match_length>o.lookahead&&(o.match_length=o.lookahead)}if(o.match_length>=3?(a=qh(o,1,o.match_length-3),o.lookahead-=o.match_length,o.strstart+=o.match_length,o.match_length=0):(a=qh(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++),a&&(Rn(o,!1),o.strm.avail_out===0))return 1}return o.insert=0,s===Hc?(Rn(o,!0),o.strm.avail_out===0?3:4):o.sym_next&&(Rn(o,!1),o.strm.avail_out===0)?1:2})(t,e):Na[t.level].func(t,e);if(r!==3&&r!==4||(t.status=el),r===1||r===3)return n.avail_out===0&&(t.last_flush=-1),Zo;if(r===2&&(e===Qh?Xh(t):e!==_c&&(Mk(t,0,0,!1),e===Mz&&(Qu(t.head),t.lookahead===0&&(t.strstart=0,t.block_start=0,t.insert=0))),To(n),n.avail_out===0))return t.last_flush=-1,Zo}return e!==Hc?Zo:t.wrap<=0?$o:(t.wrap===2?(Oi(t,255&n.adler),Oi(t,n.adler>>8&255),Oi(t,n.adler>>16&255),Oi(t,n.adler>>24&255),Oi(t,255&n.total_in),Oi(t,n.total_in>>8&255),Oi(t,n.total_in>>16&255),Oi(t,n.total_in>>24&255)):(dr(t,n.adler>>>16),dr(t,65535&n.adler)),To(n),t.wrap>0&&(t.wrap=-t.wrap),t.pending!==0?Zo:$o)},Wz=(n,e)=>{let t=e.length;if(lR(n))return $d;let i=n.state,r=i.wrap;if(r===2||r===1&&i.status!==oa||i.lookahead)return $d;if(r===1&&(n.adler=aR(n.adler,e,t,0)),i.wrap=0,t>=i.w_size){r===0&&(Qu(i.head),i.strstart=0,i.block_start=0,i.insert=0);let c=new Uint8Array(i.w_size);c.set(e.subarray(t-i.w_size,t),0),e=c,t=i.w_size}let o=n.avail_in,s=n.next_in,a=n.input;for(n.avail_in=t,n.next_in=0,n.input=e,Y_(i);i.lookahead>=3;){let c=i.strstart,d=i.lookahead-2;do i.ins_h=ep(i,i.ins_h,i.window[c+3-1]),i.prev[c&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=c,c++;while(--d);i.strstart=c,i.lookahead=2,Y_(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,n.next_in=s,n.input=a,n.avail_in=o,i.wrap=r,Zo},uR={deflateInit:(n,e)=>jk(n,e,JC,15,8,Vz),deflateInit2:jk,deflateReset:Bk,deflateResetKeep:Lm,deflateSetHeader:(n,e)=>lR(n)||n.state.wrap!==2?$d:(n.state.gzhead=e,Zo),deflate:A2,deflateEnd:n=>{if(lR(n))return $d;let e=n.state.status;return n.state=null,e===Kc?tl(n,Vl):Zo},deflateSetDictionary:Wz,deflateInfo:"pako deflate (from Nodeca project)"};let hR=(n,e)=>Object.prototype.hasOwnProperty.call(n,e);var $C={assign:function(n){let e=Array.prototype.slice.call(arguments,1);for(;e.length;){let t=e.shift();if(t){if(typeof t!="object")throw new TypeError(t+"must be non-object");for(let i in t)hR(t,i)&&(n[i]=t[i])}}return n},flattenChunks:n=>{let e=0;for(let i=0,r=n.length;i<r;i++)e+=n[i].length;let t=new Uint8Array(e);for(let i=0,r=0,o=n.length;i<o;i++){let s=n[i];t.set(s,r),r+=s.length}return t}};let pR=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{pR=!1}let km=new Uint8Array(256);for(let n=0;n<256;n++)km[n]=n>=252?6:n>=248?5:n>=240?4:n>=224?3:n>=192?2:1;km[254]=km[254]=1;var Zu={string2buf:n=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(n);let e,t,i,r,o,s=n.length,a=0;for(r=0;r<s;r++)t=n.charCodeAt(r),(64512&t)==55296&&r+1<s&&(i=n.charCodeAt(r+1),(64512&i)==56320&&(t=65536+(t-55296<<10)+(i-56320),r++)),a+=t<128?1:t<2048?2:t<65536?3:4;for(e=new Uint8Array(a),o=0,r=0;o<a;r++)t=n.charCodeAt(r),(64512&t)==55296&&r+1<s&&(i=n.charCodeAt(r+1),(64512&i)==56320&&(t=65536+(t-55296<<10)+(i-56320),r++)),t<128?e[o++]=t:t<2048?(e[o++]=192|t>>>6,e[o++]=128|63&t):t<65536?(e[o++]=224|t>>>12,e[o++]=128|t>>>6&63,e[o++]=128|63&t):(e[o++]=240|t>>>18,e[o++]=128|t>>>12&63,e[o++]=128|t>>>6&63,e[o++]=128|63&t);return e},buf2string:(n,e)=>{let t=e||n.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(n.subarray(0,e));let i,r,o=new Array(2*t);for(r=0,i=0;i<t;){let s=n[i++];if(s<128){o[r++]=s;continue}let a=km[s];if(a>4)o[r++]=65533,i+=a-1;else{for(s&=a===2?31:a===3?15:7;a>1&&i<t;)s=s<<6|63&n[i++],a--;a>1?o[r++]=65533:s<65536?o[r++]=s:(s-=65536,o[r++]=55296|s>>10&1023,o[r++]=56320|1023&s)}}return((s,a)=>{if(a<65534&&s.subarray&&pR)return String.fromCharCode.apply(null,s.length===a?s:s.subarray(0,a));let c="";for(let d=0;d<a;d++)c+=String.fromCharCode(s[d]);return c})(o,r)},utf8border:(n,e)=>{(e=e||n.length)>n.length&&(e=n.length);let t=e-1;for(;t>=0&&(192&n[t])==128;)t--;return t<0||t===0?e:t+km[n[t]]>e?t:e}},Mm=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};let Gk=Object.prototype.toString,{Z_NO_FLUSH:w2,Z_SYNC_FLUSH:Hz,Z_FULL_FLUSH:Kz,Z_FINISH:Yz,Z_OK:ey,Z_STREAM_END:ty,Z_DEFAULT_COMPRESSION:zz,Z_DEFAULT_STRATEGY:qz,Z_DEFLATED:Xz}=xl;function iy(n){this.options=$C.assign({level:zz,method:Xz,chunkSize:16384,windowBits:15,memLevel:8,strategy:qz},n||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Mm,this.strm.avail_out=0;let t=uR.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(t!==ey)throw new Error(Nn[t]);if(e.header&&uR.deflateSetHeader(this.strm,e.header),e.dictionary){let i;if(i=typeof e.dictionary=="string"?Zu.string2buf(e.dictionary):Gk.call(e.dictionary)==="[object ArrayBuffer]"?new Uint8Array(e.dictionary):e.dictionary,t=uR.deflateSetDictionary(this.strm,i),t!==ey)throw new Error(Nn[t]);this._dict_set=!0}}function _R(n,e){let t=new iy(e);if(t.push(n,!0),t.err)throw t.msg||Nn[t.err];return t.result}iy.prototype.push=function(n,e){let t=this.strm,i=this.options.chunkSize,r,o;if(this.ended)return!1;for(o=e===~~e?e:e===!0?Yz:w2,typeof n=="string"?t.input=Zu.string2buf(n):Gk.call(n)==="[object ArrayBuffer]"?t.input=new Uint8Array(n):t.input=n,t.next_in=0,t.avail_in=t.input.length;;)if(t.avail_out===0&&(t.output=new Uint8Array(i),t.next_out=0,t.avail_out=i),(o===Hz||o===Kz)&&t.avail_out<=6)this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;else{if(r=uR.deflate(t,o),r===ty)return t.next_out>0&&this.onData(t.output.subarray(0,t.next_out)),r=uR.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===ey;if(t.avail_out!==0){if(o>0&&t.next_out>0)this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;else if(t.avail_in===0)break}else this.onData(t.output)}return!0},iy.prototype.onData=function(n){this.chunks.push(n)},iy.prototype.onEnd=function(n){n===ey&&(this.result=$C.flattenChunks(this.chunks)),this.chunks=[],this.err=n,this.msg=this.strm.msg};var b2={deflate:_R,deflateRaw:function(n,e){return(e=e||{}).raw=!0,_R(n,e)}};let ry=16209;var ny=function(n,e){let t,i,r,o,s,a,c,d,l,h,p,f,m,g,S,T,C,b,D,x,k,V,W,K,J=n.state;t=n.next_in,W=n.input,i=t+(n.avail_in-5),r=n.next_out,K=n.output,o=r-(e-n.avail_out),s=r+(n.avail_out-257),a=J.dmax,c=J.wsize,d=J.whave,l=J.wnext,h=J.window,p=J.hold,f=J.bits,m=J.lencode,g=J.distcode,S=(1<<J.lenbits)-1,T=(1<<J.distbits)-1;e:do{f<15&&(p+=W[t++]<<f,f+=8,p+=W[t++]<<f,f+=8),C=m[p&S];t:for(;;){if(b=C>>>24,p>>>=b,f-=b,b=C>>>16&255,b===0)K[r++]=65535&C;else{if(!(16&b)){if(!(64&b)){C=m[(65535&C)+(p&(1<<b)-1)];continue t}if(32&b){J.mode=16191;break e}n.msg="invalid literal/length code",J.mode=ry;break e}D=65535&C,b&=15,b&&(f<b&&(p+=W[t++]<<f,f+=8),D+=p&(1<<b)-1,p>>>=b,f-=b),f<15&&(p+=W[t++]<<f,f+=8,p+=W[t++]<<f,f+=8),C=g[p&T];i:for(;;){if(b=C>>>24,p>>>=b,f-=b,b=C>>>16&255,!(16&b)){if(!(64&b)){C=g[(65535&C)+(p&(1<<b)-1)];continue i}n.msg="invalid distance code",J.mode=ry;break e}if(x=65535&C,b&=15,f<b&&(p+=W[t++]<<f,f+=8,f<b&&(p+=W[t++]<<f,f+=8)),x+=p&(1<<b)-1,x>a){n.msg="invalid distance too far back",J.mode=ry;break e}if(p>>>=b,f-=b,b=r-o,x>b){if(b=x-b,b>d&&J.sane){n.msg="invalid distance too far back",J.mode=ry;break e}if(k=0,V=h,l===0){if(k+=c-b,b<D){D-=b;do K[r++]=h[k++];while(--b);k=r-x,V=K}}else if(l<b){if(k+=c+l-b,b-=l,b<D){D-=b;do K[r++]=h[k++];while(--b);if(k=0,l<D){b=l,D-=b;do K[r++]=h[k++];while(--b);k=r-x,V=K}}}else if(k+=l-b,b<D){D-=b;do K[r++]=h[k++];while(--b);k=r-x,V=K}for(;D>2;)K[r++]=V[k++],K[r++]=V[k++],K[r++]=V[k++],D-=3;D&&(K[r++]=V[k++],D>1&&(K[r++]=V[k++]))}else{k=r-x;do K[r++]=K[k++],K[r++]=K[k++],K[r++]=K[k++],D-=3;while(D>2);D&&(K[r++]=K[k++],D>1&&(K[r++]=K[k++]))}break}}break}}while(t<i&&r<s);D=f>>3,t-=D,f-=D<<3,p&=(1<<f)-1,n.next_in=t,n.next_out=r,n.avail_in=t<i?i-t+5:5-(t-i),n.avail_out=r<s?s-r+257:257-(r-s),J.hold=p,J.bits=f};let oy=15,sy=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),Jz=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),Qz=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),Zz=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var fR=(n,e,t,i,r,o,s,a)=>{let c=a.bits,d,l,h,p,f,m,g=0,S=0,T=0,C=0,b=0,D=0,x=0,k=0,V=0,W=0,K=null,J=new Uint16Array(16),se=new Uint16Array(16),Ne,Ce,De,Me=null;for(g=0;g<=oy;g++)J[g]=0;for(S=0;S<i;S++)J[e[t+S]]++;for(b=c,C=oy;C>=1&&J[C]===0;C--);if(b>C&&(b=C),C===0)return r[o++]=20971520,r[o++]=20971520,a.bits=1,0;for(T=1;T<C&&J[T]===0;T++);for(b<T&&(b=T),k=1,g=1;g<=oy;g++)if(k<<=1,k-=J[g],k<0)return-1;if(k>0&&(n===0||C!==1))return-1;for(se[1]=0,g=1;g<oy;g++)se[g+1]=se[g]+J[g];for(S=0;S<i;S++)e[t+S]!==0&&(s[se[e[t+S]]++]=S);if(n===0?(K=Me=s,m=20):n===1?(K=sy,Me=Jz,m=257):(K=Qz,Me=Zz,m=0),W=0,S=0,g=T,f=o,D=b,x=0,h=-1,V=1<<b,p=V-1,n===1&&V>852||n===2&&V>592)return 1;for(;;){Ne=g-x,s[S]+1<m?(Ce=0,De=s[S]):s[S]>=m?(Ce=Me[s[S]-m],De=K[s[S]-m]):(Ce=96,De=0),d=1<<g-x,l=1<<D,T=l;do l-=d,r[f+(W>>x)+l]=Ne<<24|Ce<<16|De|0;while(l!==0);for(d=1<<g-1;W&d;)d>>=1;if(d!==0?(W&=d-1,W+=d):W=0,S++,--J[g]==0){if(g===C)break;g=e[t+s[S]]}if(g>b&&(W&p)!==h){for(x===0&&(x=b),f+=T,D=g-x,k=1<<D;D+x<C&&(k-=J[D+x],!(k<=0));)D++,k<<=1;if(V+=1<<D,n===1&&V>852||n===2&&V>592)return 1;h=W&p,r[h]=b<<24|D<<16|f-o|0}}return W!==0&&(r[f+W]=g-x<<24|64<<16|0),a.bits=b,0};let{Z_FINISH:Um,Z_BLOCK:O2,Z_TREES:ay,Z_OK:Fl,Z_STREAM_END:q_,Z_NEED_DICT:$z,Z_STREAM_ERROR:Yc,Z_DATA_ERROR:fc,Z_MEM_ERROR:Wk,Z_BUF_ERROR:N2,Z_DEFLATED:D2}=xl,mR=16180,X_=16190,zc=16191,il=16192,ER=16194,xm=16199,J_=16200,Vm=16206,cn=16209,vn=n=>(n>>>24&255)+(n>>>8&65280)+((65280&n)<<8)+((255&n)<<24);function P2(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}let Q_=n=>{if(!n)return 1;let e=n.state;return!e||e.strm!==n||e.mode<mR||e.mode>16211?1:0},ip=n=>{if(Q_(n))return Yc;let e=n.state;return n.total_in=n.total_out=e.total=0,n.msg="",e.wrap&&(n.adler=1&e.wrap),e.mode=mR,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,Fl},Hk=n=>{if(Q_(n))return Yc;let e=n.state;return e.wsize=0,e.whave=0,e.wnext=0,ip(n)},Kk=(n,e)=>{let t;if(Q_(n))return Yc;let i=n.state;return e<0?(t=0,e=-e):(t=5+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?Yc:(i.window!==null&&i.wbits!==e&&(i.window=null),i.wrap=t,i.wbits=e,Hk(n))},Yk=(n,e)=>{if(!n)return Yc;let t=new P2;n.state=t,t.strm=n,t.window=null,t.mode=mR;let i=Kk(n,e);return i!==Fl&&(n.state=null),i},cy,gR,dy=!0,L2=n=>{if(dy){cy=new Int32Array(512),gR=new Int32Array(32);let e=0;for(;e<144;)n.lens[e++]=8;for(;e<256;)n.lens[e++]=9;for(;e<280;)n.lens[e++]=7;for(;e<288;)n.lens[e++]=8;for(fR(1,n.lens,0,288,cy,0,n.work,{bits:9}),e=0;e<32;)n.lens[e++]=5;fR(2,n.lens,0,32,gR,0,n.work,{bits:5}),dy=!1}n.lencode=cy,n.lenbits=9,n.distcode=gR,n.distbits=5},k2=(n,e,t,i)=>{let r,o=n.state;return o.window===null&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),i>=o.wsize?(o.window.set(e.subarray(t-o.wsize,t),0),o.wnext=0,o.whave=o.wsize):(r=o.wsize-o.wnext,r>i&&(r=i),o.window.set(e.subarray(t-i,t-i+r),o.wnext),(i-=r)?(o.window.set(e.subarray(t-i,t),0),o.wnext=i,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0};var M2=(n,e)=>{let t,i,r,o,s,a,c,d,l,h,p,f,m,g,S,T,C,b,D,x,k,V,W=0,K=new Uint8Array(4),J,se,Ne=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Q_(n)||!n.output||!n.input&&n.avail_in!==0)return Yc;t=n.state,t.mode===zc&&(t.mode=il),s=n.next_out,r=n.output,c=n.avail_out,o=n.next_in,i=n.input,a=n.avail_in,d=t.hold,l=t.bits,h=a,p=c,V=Fl;e:for(;;)switch(t.mode){case mR:if(t.wrap===0){t.mode=il;break}for(;l<16;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(2&t.wrap&&d===35615){t.wbits===0&&(t.wbits=15),t.check=0,K[0]=255&d,K[1]=d>>>8&255,t.check=Qo(t.check,K,2,0),d=0,l=0,t.mode=16181;break}if(t.head&&(t.head.done=!1),!(1&t.wrap)||(((255&d)<<8)+(d>>8))%31){n.msg="incorrect header check",t.mode=cn;break}if((15&d)!==D2){n.msg="unknown compression method",t.mode=cn;break}if(d>>>=4,l-=4,k=8+(15&d),t.wbits===0&&(t.wbits=k),k>15||k>t.wbits){n.msg="invalid window size",t.mode=cn;break}t.dmax=1<<t.wbits,t.flags=0,n.adler=t.check=1,t.mode=512&d?16189:zc,d=0,l=0;break;case 16181:for(;l<16;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(t.flags=d,(255&Vo(t))!==D2){n.msg="unknown compression method",t.mode=cn;break}if(57344&Vo(t)){n.msg="unknown header flags set",t.mode=cn;break}t.head&&(t.head.text=d>>8&1),512&Vo(t)&&4&t.wrap&&(K[0]=255&d,K[1]=d>>>8&255,t.check=Qo(t.check,K,2,0)),d=0,l=0,t.mode=16182;case 16182:for(;l<32;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}t.head&&(t.head.time=d),512&Vo(t)&&4&t.wrap&&(K[0]=255&d,K[1]=d>>>8&255,K[2]=d>>>16&255,K[3]=d>>>24&255,t.check=Qo(t.check,K,4,0)),d=0,l=0,t.mode=16183;case 16183:for(;l<16;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}t.head&&(t.head.xflags=255&d,t.head.os=d>>8),512&Vo(t)&&4&t.wrap&&(K[0]=255&d,K[1]=d>>>8&255,t.check=Qo(t.check,K,2,0)),d=0,l=0,t.mode=16184;case 16184:if(1024&Vo(t)){for(;l<16;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}t.length=d,t.head&&(t.head.extra_len=d),512&Vo(t)&&4&t.wrap&&(K[0]=255&d,K[1]=d>>>8&255,t.check=Qo(t.check,K,2,0)),d=0,l=0}else t.head&&(t.head.extra=null);t.mode=16185;case 16185:if(1024&Vo(t)&&(f=t.length,f>a&&(f=a),f&&(t.head&&(k=t.head.extra_len-t.length,t.head.extra||(t.head.extra=new Uint8Array(t.head.extra_len)),t.head.extra.set(i.subarray(o,o+f),k)),512&Vo(t)&&4&t.wrap&&(t.check=Qo(t.check,i,f,o)),a-=f,o+=f,t.length-=f),t.length))break e;t.length=0,t.mode=16186;case 16186:if(2048&Vo(t)){if(a===0)break e;f=0;do k=i[o+f++],t.head&&k&&t.length<65536&&(t.head.name+=String.fromCharCode(k));while(k&&f<a);if(512&Vo(t)&&4&t.wrap&&(t.check=Qo(t.check,i,f,o)),a-=f,o+=f,k)break e}else t.head&&(t.head.name=null);t.length=0,t.mode=16187;case 16187:if(4096&Vo(t)){if(a===0)break e;f=0;do k=i[o+f++],t.head&&k&&t.length<65536&&(t.head.comment+=String.fromCharCode(k));while(k&&f<a);if(512&Vo(t)&&4&t.wrap&&(t.check=Qo(t.check,i,f,o)),a-=f,o+=f,k)break e}else t.head&&(t.head.comment=null);t.mode=16188;case 16188:if(512&Vo(t)){for(;l<16;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(4&t.wrap&&d!==(65535&t.check)){n.msg="header crc mismatch",t.mode=cn;break}d=0,l=0}t.head&&(t.head.hcrc=Vo(t)>>9&1,t.head.done=!0),n.adler=t.check=0,t.mode=zc;break;case 16189:for(;l<32;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}n.adler=t.check=vn(d),d=0,l=0,t.mode=X_;case X_:if(t.havedict===0)return n.next_out=s,n.avail_out=c,n.next_in=o,n.avail_in=a,t.hold=d,t.bits=l,$z;n.adler=t.check=1,t.mode=zc;case zc:if(e===O2||e===ay)break e;case il:if(t.last){d>>>=7&l,l-=7&l,t.mode=Vm;break}for(;l<3;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}switch(t.last=1&d,d>>>=1,l-=1,3&d){case 0:t.mode=16193;break;case 1:if(L2(t),t.mode=xm,e===ay){d>>>=2,l-=2;break e}break;case 2:t.mode=16196;break;case 3:n.msg="invalid block type",t.mode=cn}d>>>=2,l-=2;break;case 16193:for(d>>>=7&l,l-=7&l;l<32;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if((65535&d)!=(d>>>16^65535)){n.msg="invalid stored block lengths",t.mode=cn;break}if(t.length=65535&d,d=0,l=0,t.mode=ER,e===ay)break e;case ER:t.mode=16195;case 16195:if(f=t.length,f){if(f>a&&(f=a),f>c&&(f=c),f===0)break e;r.set(i.subarray(o,o+f),s),a-=f,o+=f,c-=f,s+=f,t.length-=f;break}t.mode=zc;break;case 16196:for(;l<14;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(t.nlen=257+(31&d),d>>>=5,l-=5,t.ndist=1+(31&d),d>>>=5,l-=5,t.ncode=4+(15&d),d>>>=4,l-=4,t.nlen>286||t.ndist>30){n.msg="too many length or distance symbols",t.mode=cn;break}t.have=0,t.mode=16197;case 16197:for(;t.have<t.ncode;){for(;l<3;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}t.lens[Ne[t.have++]]=7&d,d>>>=3,l-=3}for(;t.have<19;)t.lens[Ne[t.have++]]=0;if(t.lencode=t.lendyn,t.lenbits=7,J={bits:t.lenbits},V=fR(0,t.lens,0,19,t.lencode,0,t.work,J),t.lenbits=J.bits,V){n.msg="invalid code lengths set",t.mode=cn;break}t.have=0,t.mode=16198;case 16198:for(;t.have<t.nlen+t.ndist;){for(;W=t.lencode[d&(1<<t.lenbits)-1],S=W>>>24,T=W>>>16&255,C=65535&W,!(S<=l);){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(C<16)d>>>=S,l-=S,t.lens[t.have++]=C;else{if(C===16){for(se=S+2;l<se;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(d>>>=S,l-=S,t.have===0){n.msg="invalid bit length repeat",t.mode=cn;break}k=t.lens[t.have-1],f=3+(3&d),d>>>=2,l-=2}else if(C===17){for(se=S+3;l<se;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}d>>>=S,l-=S,k=0,f=3+(7&d),d>>>=3,l-=3}else{for(se=S+7;l<se;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}d>>>=S,l-=S,k=0,f=11+(127&d),d>>>=7,l-=7}if(t.have+f>t.nlen+t.ndist){n.msg="invalid bit length repeat",t.mode=cn;break}for(;f--;)t.lens[t.have++]=k}}if(t.mode===cn)break;if(t.lens[256]===0){n.msg="invalid code -- missing end-of-block",t.mode=cn;break}if(t.lenbits=9,J={bits:t.lenbits},V=fR(1,t.lens,0,t.nlen,t.lencode,0,t.work,J),t.lenbits=J.bits,V){n.msg="invalid literal/lengths set",t.mode=cn;break}if(t.distbits=6,t.distcode=t.distdyn,J={bits:t.distbits},V=fR(2,t.lens,t.nlen,t.ndist,t.distcode,0,t.work,J),t.distbits=J.bits,V){n.msg="invalid distances set",t.mode=cn;break}if(t.mode=xm,e===ay)break e;case xm:t.mode=J_;case J_:if(a>=6&&c>=258){n.next_out=s,n.avail_out=c,n.next_in=o,n.avail_in=a,t.hold=d,t.bits=l,ny(n,p),s=n.next_out,r=n.output,c=n.avail_out,o=n.next_in,i=n.input,a=n.avail_in,d=t.hold,l=t.bits,t.mode===zc&&(t.back=-1);break}for(t.back=0;W=t.lencode[d&(1<<t.lenbits)-1],S=W>>>24,T=W>>>16&255,C=65535&W,!(S<=l);){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(T&&!(240&T)){for(b=S,D=T,x=C;W=t.lencode[x+((d&(1<<b+D)-1)>>b)],S=W>>>24,T=W>>>16&255,C=65535&W,!(b+S<=l);){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}d>>>=b,l-=b,t.back+=b}if(d>>>=S,l-=S,t.back+=S,t.length=C,T===0){t.mode=16205;break}if(32&T){t.back=-1,t.mode=zc;break}if(64&T){n.msg="invalid literal/length code",t.mode=cn;break}t.extra=15&T,t.mode=16201;case 16201:if(t.extra){for(se=t.extra;l<se;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}t.length+=d&(1<<t.extra)-1,d>>>=t.extra,l-=t.extra,t.back+=t.extra}t.was=t.length,t.mode=16202;case 16202:for(;W=t.distcode[d&(1<<t.distbits)-1],S=W>>>24,T=W>>>16&255,C=65535&W,!(S<=l);){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(!(240&T)){for(b=S,D=T,x=C;W=t.distcode[x+((d&(1<<b+D)-1)>>b)],S=W>>>24,T=W>>>16&255,C=65535&W,!(b+S<=l);){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}d>>>=b,l-=b,t.back+=b}if(d>>>=S,l-=S,t.back+=S,64&T){n.msg="invalid distance code",t.mode=cn;break}t.offset=C,t.extra=15&T,t.mode=16203;case 16203:if(t.extra){for(se=t.extra;l<se;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}t.offset+=d&(1<<t.extra)-1,d>>>=t.extra,l-=t.extra,t.back+=t.extra}if(t.offset>t.dmax){n.msg="invalid distance too far back",t.mode=cn;break}t.mode=16204;case 16204:if(c===0)break e;if(f=p-c,t.offset>f){if(f=t.offset-f,f>t.whave&&t.sane){n.msg="invalid distance too far back",t.mode=cn;break}f>t.wnext?(f-=t.wnext,m=t.wsize-f):m=t.wnext-f,f>t.length&&(f=t.length),g=t.window}else g=r,m=s-t.offset,f=t.length;f>c&&(f=c),c-=f,t.length-=f;do r[s++]=g[m++];while(--f);t.length===0&&(t.mode=J_);break;case 16205:if(c===0)break e;r[s++]=t.length,c--,t.mode=J_;break;case Vm:if(t.wrap){for(;l<32;){if(a===0)break e;a--,d|=i[o++]<<l,l+=8}if(p-=c,n.total_out+=p,t.total+=p,4&t.wrap&&p&&(n.adler=t.check=Vo(t)?Qo(t.check,r,p,s-p):aR(t.check,r,p,s-p)),p=c,4&t.wrap&&(Vo(t)?d:vn(d))!==t.check){n.msg="incorrect data check",t.mode=cn;break}d=0,l=0}t.mode=16207;case 16207:if(t.wrap&&Vo(t)){for(;l<32;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(4&t.wrap&&d!==(4294967295&t.total)){n.msg="incorrect length check",t.mode=cn;break}d=0,l=0}t.mode=16208;case 16208:V=q_;break e;case cn:V=fc;break e;case 16210:return Wk;default:return Yc}return n.next_out=s,n.avail_out=c,n.next_in=o,n.avail_in=a,t.hold=d,t.bits=l,(t.wsize||p!==n.avail_out&&t.mode<cn&&(t.mode<Vm||e!==Um))&&k2(n,n.output,n.next_out,p-n.avail_out),h-=n.avail_in,p-=n.avail_out,n.total_in+=h,n.total_out+=p,t.total+=p,4&t.wrap&&p&&(n.adler=t.check=Vo(t)?Qo(t.check,r,p,n.next_out-p):aR(t.check,r,p,n.next_out-p)),n.data_type=t.bits+(t.last?64:0)+(t.mode===zc?128:0)+(t.mode===xm||t.mode===ER?256:0),(h===0&&p===0||e===Um)&&V===Fl&&(V=N2),V},$u={inflateReset:Hk,inflateReset2:Kk,inflateResetKeep:ip,inflateInit:n=>Yk(n,15),inflateInit2:Yk,inflate:M2,inflateEnd:n=>{if(Q_(n))return Yc;let e=n.state;return e.window&&(e.window=null),n.state=null,Fl},inflateGetHeader:(n,e)=>{if(Q_(n))return Yc;let t=n.state;return 2&t.wrap?(t.head=e,e.done=!1,Fl):Yc},inflateSetDictionary:(n,e)=>{let t=e.length,i,r,o;return Q_(n)?Yc:(i=n.state,i.wrap!==0&&i.mode!==X_?Yc:i.mode===X_&&(r=1,r=aR(r,e,t,0),r!==i.check)?fc:(o=k2(n,e,t,t),o?(i.mode=16210,Wk):(i.havedict=1,Fl)))},inflateInfo:"pako inflate (from Nodeca project)"},eh=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};let U2=Object.prototype.toString,{Z_NO_FLUSH:x2,Z_FINISH:e9,Z_OK:SR,Z_STREAM_END:Z_,Z_NEED_DICT:TR,Z_STREAM_ERROR:zk,Z_DATA_ERROR:V2,Z_MEM_ERROR:F2}=xl;function ly(n){this.options=$C.assign({chunkSize:65536,windowBits:15,to:""},n||{});let e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||n&&n.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&!(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Mm,this.strm.avail_out=0;let t=$u.inflateInit2(this.strm,e.windowBits);if(t!==SR)throw new Error(Nn[t]);if(this.header=new eh,$u.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=Zu.string2buf(e.dictionary):U2.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(t=$u.inflateSetDictionary(this.strm,e.dictionary),t!==SR)))throw new Error(Nn[t])}function RR(n,e){let t=new ly(e);if(t.push(n),t.err)throw t.msg||Nn[t.err];return t.result}ly.prototype.push=function(n,e){let t=this.strm,i=this.options.chunkSize,r=this.options.dictionary,o,s,a;if(this.ended)return!1;for(s=e===~~e?e:e===!0?e9:x2,U2.call(n)==="[object ArrayBuffer]"?t.input=new Uint8Array(n):t.input=n,t.next_in=0,t.avail_in=t.input.length;;){for(t.avail_out===0&&(t.output=new Uint8Array(i),t.next_out=0,t.avail_out=i),o=$u.inflate(t,s),o===TR&&r&&(o=$u.inflateSetDictionary(t,r),o===SR?o=$u.inflate(t,s):o===V2&&(o=TR));t.avail_in>0&&o===Z_&&t.state.wrap>0&&n[t.next_in]!==0;)$u.inflateReset(t),o=$u.inflate(t,s);switch(o){case zk:case V2:case TR:case F2:return this.onEnd(o),this.ended=!0,!1}if(a=t.avail_out,t.next_out&&(t.avail_out===0||o===Z_))if(this.options.to==="string"){let c=Zu.utf8border(t.output,t.next_out),d=t.next_out-c,l=Zu.buf2string(t.output,c);t.next_out=d,t.avail_out=i-d,d&&t.output.set(t.output.subarray(c,c+d),0),this.onData(l)}else this.onData(t.output.length===t.next_out?t.output:t.output.subarray(0,t.next_out));if(o!==SR||a!==0){if(o===Z_)return o=$u.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(t.avail_in===0)break}}return!0},ly.prototype.onData=function(n){this.chunks.push(n)},ly.prototype.onEnd=function(n){n===SR&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=$C.flattenChunks(this.chunks)),this.chunks=[],this.err=n,this.msg=this.strm.msg};var B2={inflate:RR,inflateRaw:function(n,e){return(e=e||{}).raw=!0,RR(n,e)}};let{deflate:t9,deflateRaw:i9}=b2,{inflate:r9,inflateRaw:n9}=B2;var o9=t9,s9=i9,a9=r9,c9=n9,j2=function(n){return n[n.ONE_BYTE=0]="ONE_BYTE",n[n.TWO_BYTE=1]="TWO_BYTE",n}(j2||{});class G2{constructor(){U(this,"_sequence",0),U(this,"_startTime",Date.now()),U(this,"isUseOneByte",!0)}get startTime(){let e=Date.now()-this._startTime;return e<Math.pow(2,16)?e:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(e){let t={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:e};if(e.byteLength>128){let a=new Uint8Array(4);a.set([1,0,0,0]);let c={id:0,length:4,data:a.buffer},d={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[c]};t.commonPacketHeader.extension=1,t.extension=d,t.payload=this.compress(e),t.commonPacketHeader.length=8+(t.extension.length+2)+t.payload.byteLength}else t.commonPacketHeader.length=8+t.payload.byteLength;F("SHOW_DATASTREAM2_LOG")&&y.debug("send data header: ".concat(JSON.stringify(t.commonPacketHeader)));let i=new ArrayBuffer(t.commonPacketHeader.length),r=new Uint8Array(i),o=new DataView(i),s=0;if(o.setUint16(s,t.commonPacketHeader.extension<<15|t.commonPacketHeader.reserved<<14|t.commonPacketHeader.length,!0),s+=2,o.setUint32(s,t.commonPacketHeader.sequence,!0),s+=4,o.setUint16(s,t.commonStreamHeader,!0),s+=2,t.extension){let a=this.serializeExtension(t.extension);r.set(new Uint8Array(a),s),s+=a.byteLength}if(r.set(new Uint8Array(t.payload),s),s+=t.payload.byteLength,s!==t.commonPacketHeader.length)throw Error("serialize error!");return i}deserialize(e){if(e.byteLength<4)return new ArrayBuffer(0);let t=new DataView(e),i=0,r=t.getUint16(i,!0);i+=2;let o={length:16383&r,reserved:(16384&r)>>14,extension:(32768&r)>>15,sequence:t.getUint16(i+2,!0)<<16|t.getUint16(i,!0)},s,a;if(i+=4,F("SHOW_DATASTREAM2_LOG")&&y.debug("receive data header: ".concat(JSON.stringify(o))),t.getUint16(i,!0),i+=2,o.extension){a=this.deserializeExtension(e.slice(i)),i+=2+a.length,s=e.slice(i);let c=!1;if(a.datas.length>0){let d=a.datas.find(l=>l.id===0);d&&(c=(1&new DataView(d.data).getUint32(0,!0))==1)}s=c?this.decompress(s):s}else s=e.slice(8);return s}serializeExtension(e){let{profile:t,length:i,datas:r}=e,o=new ArrayBuffer(i+2),s=new Uint8Array(o),a=new DataView(o),c=0;if(a.setUint8(c++,t),a.setUint8(c++,i),r.forEach(d=>{t?(a.setUint8(c++,d.id),a.setUint8(c++,d.length),s.set(new Uint8Array(d.data),c),c+=d.data.byteLength):(a.setUint8(c++,d.id|d.length<<4),s.set(new Uint8Array(d.data),c),c+=d.data.byteLength)}),c!==i+2)throw Error("serialize extension error, is ".concat(c,"!==").concat(i+2));return o}deserializeExtension(e){let t=new DataView(e),i=0,r=t.getUint8(i);i++;let o=t.getUint8(i);i++;let s=r===j2.TWO_BYTE,a=[],c=new DataView(e,2),d=0;for(;d<o;){let l=0,h=0,p=new ArrayBuffer(0);s?(l=c.getUint8(d),d++,h=c.getUint8(d),d++):(l=15&c.getUint8(d),h=c.getUint8(d)>>4,d++),h>0&&(p=c.buffer.slice(d+2,d+2+h),d+=p.byteLength),a.push({id:l,length:h,data:p})}if(d!==o)throw Error("parse error");return{profile:r,length:o,datas:a}}decompress(e){return a9(new Uint8Array(e))}compress(e){return o9(new Uint8Array(e))}}let d9={name:"DataStream",create:(n,e)=>{let t=e?new xU(n):new KY(n);return t.useDataStream(new G2),t}};class l9 extends Ki{constructor(e,t,i){super(),U(this,"ws",void 0),U(this,"requestId",1),U(this,"heartBeatTimer",void 0),U(this,"joinInfo",void 0),U(this,"clientId",void 0),U(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),U(this,"onClose",r=>{this.emit("close"),this.dispose()}),U(this,"onMessage",r=>{let o=JSON.parse(r.data);if(!o||o.command!=="serverResponse"||!o.requestId)return o&&o.command==="serverStatus"&&o.serverStatus&&o.serverStatus.command?(this.emit("status",o.serverStatus),void this.emit(o.serverStatus.command,o.serverStatus)):void 0;this.emit("req_".concat(o.requestId),o)}),this.joinInfo=e,this.clientId=t,this.ws=new M_("cross-channel-".concat(this.clientId),i),this.ws.on(Je.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(Je.CONNECTED,this.onOpen),this.ws.on(Je.ON_MESSAGE,this.onMessage),this.ws.on(Je.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(e){let t=this.requestId++;return e.requestId=t,e.seq=t,this.ws.sendMessage(e),t}waitStatus(e){return new Z((t,i)=>{let r=window.setTimeout(()=>{i(new H(L.TIMEOUT,"wait status timeout, status: ".concat(e)))},5e3);this.once(e,o=>{window.clearTimeout(r),o.state&&o.state!==0?i(new H(L.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):t(void 0)}),this.once("dispose",()=>{window.clearTimeout(r),i(new H(L.WS_ABORT))})})}async request(e){if(this.ws.state==="closed")throw new H(L.WS_DISCONNECT);let t=()=>new Z((s,a)=>{this.ws.once(Je.CLOSED,()=>a(new H(L.WS_ABORT))),this.ws.once(Je.CONNECTED,s)});this.ws.state!=="connected"&&await t();let i=this.sendMessage(e),r=new Z((s,a)=>{let c=()=>{a(new H(L.WS_ABORT))};this.ws.once(Je.RECONNECTING,c),this.ws.once(Je.CLOSED,c),this.once("req_".concat(i),s),fn(3e3).then(()=>{this.removeAllListeners("req_".concat(i)),this.ws.off(Je.RECONNECTING,c),this.ws.off(Je.CLOSED,c),a(new H(L.TIMEOUT,"cross channel ws request timeout"))})}),o=await r;if(!o||o.code!==200)throw new H(L.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(o)));return o}async connect(e){this.ws.removeAllListeners(Je.REQUEST_NEW_URLS),this.ws.on(Je.REQUEST_NEW_URLS,t=>{t(e)}),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){let t=this.requestId++;return e.requestId=t,this.ws.sendMessage(e),t}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class u9 extends Ki{set state(e){e!==this._state&&(e!==An.RELAY_STATE_FAILURE&&(this.errorCode=lo.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,t,i,r,o){super(),U(this,"joinInfo",void 0),U(this,"sid",void 0),U(this,"clientId",void 0),U(this,"cancelToken",Qi.CancelToken.source()),U(this,"workerToken",void 0),U(this,"requestId",0),U(this,"signal",void 0),U(this,"prevChannelMediaConfig",void 0),U(this,"httpRetryConfig",void 0),U(this,"_resolution",void 0),U(this,"_state",An.RELAY_STATE_IDLE),U(this,"errorCode",lo.RELAY_OK),U(this,"onStatus",s=>{y.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(s))),s&&s.command&&(s.command==="onAudioPacketReceived"&&this.emit("event",gn.PACKET_RECEIVED_AUDIO_FROM_SRC),s.command==="onVideoPacketReceived"&&this.emit("event",gn.PACKET_RECEIVED_VIDEO_FROM_SRC),s.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=lo.SRC_TOKEN_EXPIRED,this.state=An.RELAY_STATE_FAILURE),s.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=lo.DEST_TOKEN_EXPIRED,this.state=An.RELAY_STATE_FAILURE))}),U(this,"onReconnect",async()=>{y.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",gn.NETWORK_DISCONNECTED),this.state=An.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(s=>{this.state!==An.RELAY_STATE_IDLE&&(y.error("auto restart channel media relay failed",s.toString()),this.errorCode=lo.SERVER_CONNECTION_LOST,this.state=An.RELAY_STATE_FAILURE)})}),this.joinInfo=e,this.clientId=t,this.sid=li(),this.signal=new l9(this.joinInfo,this.clientId,i),this.httpRetryConfig=r,this._resolution=o}async startChannelMediaRelay(e){if(this.state!==An.RELAY_STATE_IDLE)throw new H(L.INVALID_OPERATION);this.state=An.RELAY_STATE_CONNECTING,await this.connect(),y.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(t){throw t.data&&t.data.serverResponse&&t.data.serverResponse.command==="SetSourceChannel"?new H(L.CROSS_CHANNEL_FAILED_JOIN_SRC):t.data&&t.data.serverResponse&&t.serverResponse.command==="SetDestChannelStatus"?new H(L.CROSS_CHANNEL_FAILED_JOIN_DEST):t.data&&t.data.serverResponse&&t.serverResponse.command==="StartPacketTransfer"?new H(L.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):t}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==An.RELAY_STATE_RUNNING)throw new H(L.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(e){if(this._resolution=e,this.state!==An.RELAY_STATE_RUNNING)throw new H(L.INVALID_OPERATION);let t=this.genMessage(zo.SetVideoProfile);await this.signal.request(t),y.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),y.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=An.RELAY_STATE_IDLE,this.dispose()}dispose(){y.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=Qi.CancelToken.source(),this.state=An.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){let e=await n2(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",gn.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){let t=this.genMessage(zo.SetSdkProfile,e);await this.signal.request(t),y.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));let i=this.genMessage(zo.SetSourceChannel,e);await this.signal.request(i),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",gn.PACKET_JOINED_SRC_CHANNEL),y.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));let r=this.genMessage(zo.SetSourceUserId,e);await this.signal.request(r),y.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));let o=this.genMessage(zo.SetDestChannel,e);await this.signal.request(o),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",gn.PACKET_JOINED_DEST_CHANNEL),y.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));let s=this.genMessage(zo.StartPacketTransfer,e);await this.signal.request(s),this.emit("event",gn.PACKET_SENT_TO_DEST_CHANNEL),this.state=An.RELAY_STATE_RUNNING,y.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(e){let t=this.genMessage(zo.UpdateDestChannel,e);await this.signal.request(t),this.emit("event",gn.PACKET_UPDATE_DEST_CHANNEL),y.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){let e=this.genMessage(zo.StopPacketTransfer);await this.signal.request(e),y.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,t){let i=[],r=[],o=[];this.requestId+=1;let s={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:Js,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};s.sdkVersion==="4.24.2"&&(s.sdkVersion="0.0.1");let a=null,c=null;switch(e){case zo.SetSdkProfile:return s.clientRequest={command:"SetSdkProfile",type:"multi_channel"},s;case zo.SetSourceChannel:if(c=t&&t.getSrcChannelMediaInfo(),!c)throw new H(L.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceChannel",uid:"0",channelName:c.channelName,token:c.token||this.joinInfo.appId},s;case zo.SetSourceUserId:if(c=t&&t.getSrcChannelMediaInfo(),!c)throw new H(L.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceUserId",uid:c.uid+""},s;case zo.SetDestChannel:if(a=t&&t.getDestChannelMediaInfo(),!a)throw new H(L.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{i.push(d.channelName),r.push(d.uid+""),o.push(d.token||this.joinInfo.appId)}),s.clientRequest={command:"SetDestChannel",channelName:i,uid:r,token:o},s;case zo.StartPacketTransfer:return s.clientRequest={command:"StartPacketTransfer"},s;case zo.Reconnect:return s.clientRequest={command:"Reconnect"},s;case zo.StopPacketTransfer:return s.clientRequest={command:"StopPacketTransfer"},s;case zo.UpdateDestChannel:if(a=t&&t.getDestChannelMediaInfo(),!a)throw new H(L.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{i.push(d.channelName),r.push(d.uid+""),o.push(d.token||this.joinInfo.appId)}),s.clientRequest={command:"UpdateDestChannel",channelName:i,uid:r,token:o},s;case zo.SetVideoProfile:s.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return s}}let h9={name:"ChannelMediaRelay",create:function(n){return new u9(n.joinInfo,n.clientId,n.websocketRetryConfig||mr,n.httpRetryConfig||mr,n.resolution)}};function W2(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function Fm(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?W2(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):W2(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}class vR extends Ki{constructor(e,t,i,r){super(),U(this,"spec",void 0),U(this,"token",void 0),U(this,"websocket",void 0),U(this,"pingpongTimer",void 0),U(this,"reconnectMode","retry"),U(this,"serviceMode",void 0),U(this,"reqId",0),U(this,"commandReqId",0),U(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),U(this,"handleWebSocketMessage",o=>{if(!o.data)return;let s=JSON.parse(o.data);s.requestId?this.emit("@".concat(s.requestId,"-").concat(s.sid),s):(_e.workerEvent(this.spec.sid,{actionType:"status",serverCode:s.code,workerType:this.serviceMode===Mc.TRANSCODE?1:2}),this.emit(Fh.PUBLISH_STREAM_STATUS,s))}),this.spec=t,this.token=e,this.serviceMode=r,this.websocket=new M_("live-streaming",i),this.websocket.on(Je.CONNECTED,this.handleWebSocketOpen),this.websocket.on(Je.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(Je.REQUEST_NEW_URLS,(o,s)=>{fr(this,Fh.REQUEST_NEW_ADDRESS).then(o).catch(s)}),this.websocket.on(Je.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(e){return this.websocket.init(e)}async request(e,t,i,r){this.reqId+=1,e==="request"&&(this.commandReqId+=1);let o=this.commandReqId,s=this.reqId;if(!s||!this.websocket)throw new H(L.UNEXPECTED_ERROR);let a=Fm({command:e,sdkVersion:Js==="4.24.2"?"0.0.1":Js,seq:s,requestId:s,allocate:i,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},t);if(this.websocket.state==="closed")throw new H(L.WS_DISCONNECT);let c=()=>new Z((p,f)=>{this.websocket.once(Je.CLOSED,()=>f(new H(L.WS_ABORT))),this.websocket.once(Je.CONNECTED,p)});this.websocket.state!=="connected"&&await c(),a.clientRequest&&(a.clientRequest.workerToken=this.token);let d=new Z((p,f)=>{let m=()=>{f(new H(L.WS_ABORT))};this.websocket.once(Je.RECONNECTING,m),this.websocket.once(Je.CLOSED,m),this.once("@".concat(s,"-").concat(this.spec.sid),g=>{p(g)})});r&&_e.workerEvent(this.spec.sid,Fm(Fm({},r),{},{requestId:o,actionType:"request",payload:JSON.stringify(t.clientRequest),serverCode:0,code:0}));let l=Date.now();this.websocket.sendMessage(a);let h=null;try{h=await d}catch(p){if(this.websocket.state==="closed")throw p;return await c(),await this.request(e,t,i)}return r&&_e.workerEvent(this.spec.sid,Fm(Fm({},r),{},{requestId:o,actionType:"response",payload:JSON.stringify(h.serverResponse),serverCode:h.code,success:h.code===200,responseTime:Date.now()-l})),h.code!==200&&this.handleResponseError(h),h}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){let e=Js==="4.24.2"?"0.0.1":Js;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case Gr.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void y.warning("live stream response already exists stream");case Gr.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case Gr.LIVE_STREAM_RESPONSE_BAD_STREAM:case Gr.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new H(L.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case Gr.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(e.serverResponse.command==="UnpublishStream")return;throw new H(L.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Gr.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new H(L.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case Gr.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{let t=new H(L.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(Fh.WARNING,t,e.serverResponse.url)}case Gr.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{let t=new H(L.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(Fh.WARNING,t,e.serverResponse.url)}case Gr.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new H(L.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Gr.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new H(L.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case Gr.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{let t=new H(L.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(Fh.WARNING,t,e.serverResponse.url)}case Gr.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new H(L.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case Gr.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new H(L.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case Gr.LIVE_STREAM_RESPONSE_WORKER_LOST:case Gr.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(e.serverResponse.command==="UnpublishStream")return;throw new H(L.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Gr.ERROR_FAIL_SEND_MESSAGE:if(e.serverResponse.command==="UnpublishStream")return;if(e.serverResponse.command==="UpdateTranscoding"||e.serverResponse.command==="ControlStream")return new H(L.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new H(L.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Gr.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Gr.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Gr.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Gr.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new H(L.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(Fd)},6e3)}}function H2(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function fs(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?H2(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):H2(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}class Ls extends Ki{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:mr,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:mr;super(),U(this,"onLiveStreamWarning",void 0),U(this,"onLiveStreamError",void 0),U(this,"spec",void 0),U(this,"retryTimeout",1e4),U(this,"connection",void 0),U(this,"httpRetryConfig",void 0),U(this,"wsRetryConfig",void 0),U(this,"streamingTasks",new Map),U(this,"isStartingStreamingTask",!1),U(this,"taskMutex",new mn("live-streaming")),U(this,"cancelToken",Qi.CancelToken.source()),U(this,"transcodingConfig",void 0),U(this,"uapResponse",void 0),U(this,"lastTaskId",1),U(this,"statusError",new Map),this.spec=e,this.httpRetryConfig=i,this.wsRetryConfig=t}async setTranscodingConfig(e){let t=fs(fs({},WP),e);t.videoCodecProfile!==66&&t.videoCodecProfile!==77&&t.videoCodecProfile!==100&&(y.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(t.videoCodecProfile," -> 100")),t.videoCodecProfile=100),t.transcodingUsers||(t.transcodingUsers=t.userConfigs),t.transcodingUsers&&(t.transcodingUsers=t.transcodingUsers.map(s=>fs(fs(fs({},xu),s),{},{zOrder:s.zOrder?s.zOrder+1:1}))),function(s){Pi(s.width)||Rt(s.width,"config.width",0,1e4),Pi(s.height)||Rt(s.height,"config.height",0,1e4),Pi(s.videoBitrate)||Rt(s.videoBitrate,"config.videoBitrate",1,1e6),Pi(s.videoFrameRate)||Rt(s.videoFrameRate,"config.videoFrameRate"),Pi(s.lowLatency)||oe(s.lowLatency,"config.lowLatency"),Pi(s.audioSampleRate)||xi(s.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),Pi(s.audioBitrate)||Rt(s.audioBitrate,"config.audioBitrate",1,128),Pi(s.audioChannels)||xi(s.audioChannels,"config.audioChannels",[1,2,3,4,5]),Pi(s.videoGop)||Rt(s.videoGop,"config.videoGop"),Pi(s.videoCodecProfile)||xi(s.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),Pi(s.userCount)||Rt(s.userCount,"config.userCount",0,17),Pi(s.backgroundColor)||Rt(s.backgroundColor,"config.backgroundColor",0,16777215),Pi(s.userConfigExtraInfo)||_n(s.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),s.transcodingUsers&&!Pi(s.transcodingUsers)&&(Ar(s.transcodingUsers,"config.transcodingUsers"),s.transcodingUsers.forEach((a,c)=>{L_(a.uid),Pi(a.x)||Rt(a.x,"transcodingUser[".concat(c,"].x"),0,1e4),Pi(a.y)||Rt(a.y,"transcodingUser[".concat(c,"].y"),0,1e4),Pi(a.width)||Rt(a.width,"transcodingUser[".concat(c,"].width"),0,1e4),Pi(a.height)||Rt(a.height,"transcodingUser[".concat(c,"].height"),0,1e4),Pi(a.zOrder)||Rt(a.zOrder-1,"transcodingUser[".concat(c,"].zOrder"),0,100),Pi(a.alpha)||Rt(a.alpha,"transcodingUser[".concat(c,"].alpha"),0,1,!1)})),Pi(s.watermark)||IT(s.watermark,"watermark"),Pi(s.backgroundImage)||IT(s.backgroundImage,"backgroundImage"),s.images&&!Pi(s.images)&&(Ar(s.images,"config.images"),s.images.forEach((a,c)=>{IT(a,"images[".concat(c,"]"))}))}(t);let i=[];t.images&&i.push(...t.images.map(s=>fs(fs(fs({},GP),s),{},{zOrder:255}))),t.backgroundImage&&(i.push(fs(fs(fs({},GP),t.backgroundImage),{},{zOrder:0})),delete t.backgroundImage),t.watermark&&(i.push(fs(fs(fs({},GP),t.watermark),{},{zOrder:255})),delete t.watermark),t.images=i,t.transcodingUsers&&(t.userConfigs=t.transcodingUsers.map(s=>fs({},s)),t.userCount=t.transcodingUsers.length,delete t.transcodingUsers);let r=(t.userConfigs||[]).map(s=>typeof s.uid=="number"?Z.resolve(s.uid):cL(s.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await Z.all(r)).forEach((s,a)=>{t.userConfigs&&t.userConfigs[a]&&(t.userConfigs[a].uid=s)}),this.transcodingConfig=t,this.connection)try{var o;let s=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(Vr(o=this.streamingTasks).call(o)).map(a=>a.taskId).join("#")});y.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(s.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(s){if(!s.data||!s.data.retry)throw s;s.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(a=>{y.warning("[".concat(this.spec.clientId,"] live streaming receive error"),s.toString(),"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,s).then(()=>{y.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(a.url," success"))}).catch(c=>{y.error("[".concat(this.spec.clientId,"] live streaming republish failed"),a.url,c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)})})}}async startLiveStreamingTask(e,t,i){if(!this.transcodingConfig&&t===Mc.TRANSCODE)throw new H(L.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let r={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};y.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(t));let o=await this.taskMutex.lock();if(!this.connection&&i)return void o();if(this.streamingTasks.get(e)&&!i)return o(),new H(L.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(t))}catch(a){throw o(),a}switch(t){case Mc.TRANSCODE:r.transcodingConfig=fs({},this.transcodingConfig)}this.uapResponse&&this.uapResponse.vid&&(r.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;let s=this.lastTaskId++;try{let a=new Z((d,l)=>{fn(this.retryTimeout).then(()=>{if(i)return l(i);let h=this.statusError.get(e);return h?(this.statusError.delete(e),l(h)):void 0})}),c=await Z.race([this.connection.request("request",{clientRequest:r},!0,{url:e,command:"PublishStream",workerType:t===Mc.TRANSCODE?1:2,requestByUser:!i,tid:s.toString()}),a]);this.isStartingStreamingTask=!1,y.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(c.code)),this.streamingTasks.set(e,{clientRequest:r,mode:t,url:e,taskId:s}),o()}catch(a){if(o(),this.isStartingStreamingTask=!1,!a.data||!a.data.retry||i)throw a;return a.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,t,a)):await this.startLiveStreamingTask(e,t,a)}}stopLiveStreamingTask(e){return new Z((t,i)=>{let r=this.streamingTasks.get(e);if(!r||!this.connection)return new H(L.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();let o=r.mode;r.abortTask=()=>{y.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),t()},this.connection.request("request",{clientRequest:{command:"UnpublishStream",url:r.url}},!1,{url:e,command:"UnPublishStream",workerType:o===Mc.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(s=>{y.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(s.code)),this.streamingTasks.delete(e),this.streamingTasks.size===0&&(this.connection&&this.connection.close(),this.connection=void 0),t()}).catch(i)})}resetAllTask(){var e;let t=Array.from(Vr(e=this.streamingTasks).call(e));this.terminate();for(let i of t)this.startLiveStreamingTask(i.url,i.mode).catch(r=>{this.onLiveStreamError&&this.onLiveStreamError(i.url,r)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=Qi.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new H(L.UNEXPECTED_ERROR,"live streaming connection has already connected");let t=await fr(this,Al.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=t,this.connection=new vR(t.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(Fh.WARNING,(i,r)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(r,i)),this.connection.on(Fh.PUBLISH_STREAM_STATUS,i=>this.handlePublishStreamServer(i)),this.connection.on(Fh.REQUEST_NEW_ADDRESS,(i,r)=>{if(!this.connection)return r(new H(L.UNEXPECTED_ERROR,"can not get new live streaming address list"));fr(this,Al.REQUEST_WORKER_MANAGER_LIST,e).then(o=>{this.uapResponse=o,i(o.addressList)}).catch(r)}),await this.connection.init(t.addressList),this.connection}handlePublishStreamServer(e){let t=e.serverStatus&&e.serverStatus.url||"empty_url",i=this.streamingTasks.get(t),r=e.reason;switch(e.code){case Gr.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Gr.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Gr.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Gr.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{let s=new H(L.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(i)return y.error(s.toString()),this.onLiveStreamError&&this.onLiveStreamError(t,s);if(!this.isStartingStreamingTask)return;this.statusError.set(t,s)}case Gr.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{let s=new H(L.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,r);return this.onLiveStreamWarning&&this.onLiveStreamWarning(t,s)}case Gr.LIVE_STREAM_RESPONSE_WORKER_LOST:case Gr.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var o;if(!this.connection)return;this.connection.tryNextAddress();let s=Array.from(Vr(o=this.streamingTasks).call(o));for(let a of s)a.abortTask?a.abortTask():(y.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,new H(L.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then(()=>{y.debug("[".concat(this.spec.clientId,"] republish live stream success"),a.url)}).catch(c=>{y.error(c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)}));return}}}hasUrl(e){return this.streamingTasks.has(e)}}let p9={name:"LiveStreaming",create:function(n){return new Ls(n.joinInfo,n.websocketRetryConfig||mr,n.httpRetryConfig||mr)}};function _9(n){let e=Xk();return function(t,i){let r=t.appId;r!==void 0&&(ni(i,10),rl(i,r));let o=t.cid;o!==void 0&&(ni(i,16),ni(i,o));let s=t.cname;s!==void 0&&(ni(i,26),rl(i,s));let a=t.deviceId;a!==void 0&&(ni(i,34),rl(i,a));let c=t.elapse;c!==void 0&&(ni(i,40),hi(i,c));let d=t.fileSize;d!==void 0&&(ni(i,48),hi(i,uo(d)));let l=t.height;l!==void 0&&(ni(i,56),hi(i,uo(l)));let h=t.jpg;h!==void 0&&(ni(i,66),ni(i,h.length),function(et,ae){let Y=ef(et,ae.length);et.bytes.set(ae,Y)}(i,h));let p=t.networkType;p!==void 0&&(ni(i,72),hi(i,uo(p)));let f=t.osType;f!==void 0&&(ni(i,80),hi(i,uo(f)));let m=t.requestId;m!==void 0&&(ni(i,90),rl(i,m));let g=t.sdkVersion;g!==void 0&&(ni(i,98),rl(i,g));let S=t.sequence;S!==void 0&&(ni(i,104),hi(i,uo(S)));let T=t.sid;T!==void 0&&(ni(i,114),rl(i,T));let C=t.timestamp;C!==void 0&&(ni(i,120),hi(i,C));let b=t.uid;b!==void 0&&(ni(i,128),ni(i,b));let D=t.vid;D!==void 0&&(ni(i,136),ni(i,D));let x=t.width;x!==void 0&&(ni(i,144),hi(i,uo(x)));let k=t.service;k!==void 0&&(ni(i,152),ni(i,k));let V=t.callbackData;V!==void 0&&(ni(i,162),rl(i,V));let W=t.jpgEncryption;W!==void 0&&(ni(i,168),ni(i,W));let K=t.requestType;K!==void 0&&(ni(i,176),ni(i,K));let J=t.scorePorn;J!==void 0&&(ni(i,185),CR(i,J));let se=t.scoreSexy;se!==void 0&&(ni(i,193),CR(i,se));let Ne=t.scoreNeutral;Ne!==void 0&&(ni(i,201),CR(i,Ne));let Ce=t.scene;Ce!==void 0&&(ni(i,208),ni(i,Ce));let De=t.ossFilePrefix;De!==void 0&&(ni(i,218),rl(i,De));let Me=t.serviceVendor;if(Me!==void 0)for(let et of Me){ni(i,226);let ae=Xk();E9(et,ae),ni(i,ae.limit),Bl(i,ae),z2(ae)}}(n,e),function(t){let i=t.bytes,r=t.limit;return i.length===r?i:i.subarray(0,r)}(e)}function f9(n){return function(t){let i={};e:for(;!uy(t);){let r=qc(t);switch(r>>>3){case 0:break e;case 1:i.code=qc(t);break;case 2:i.msg=hy(t,qc(t));break;case 3:{let o=g9(t);i.data=m9(t),t.limit=o;break}default:K2(t,7&r)}}return i}({bytes:e=n,offset:0,limit:e.length});var e}function m9(n){let e={};e:for(;!uy(n);){let t=qc(n);switch(t>>>3){case 0:break e;case 1:e.requestId=hy(n,qc(n));break;case 2:e.requestType=qc(n)>>>0;break;case 3:e.scorePorn=py(n);break;case 4:e.scoreSexy=py(n);break;case 5:e.scoreNeutral=py(n);break;case 6:e.requestScene=qc(n)>>>0;break;case 7:e.scene=qc(n)>>>0;break;default:K2(n,7&t)}}return e}function E9(n,e){let t=n.service;t!==void 0&&(ni(e,8),ni(e,t));let i=n.vendor;i!==void 0&&(ni(e,16),ni(e,i));let r=n.token;r!==void 0&&(ni(e,26),rl(e,r));let o=n.callbackUrl;o!==void 0&&(ni(e,34),rl(e,o))}function g9(n){let e=qc(n),t=n.limit;return n.limit=n.offset+e,t}function K2(n,e){switch(e){case 0:for(;128&q2(n););break;case 2:Jk(n,qc(n));break;case 5:Jk(n,4);break;case 1:Jk(n,8);break;default:throw new Error("Unimplemented type: "+e)}}let Y2=new Float32Array(1);new Uint8Array(Y2.buffer);let qk=new Float64Array(1),es=new Uint8Array(qk.buffer);function uo(n){return{low:n|=0,high:n>>31,unsigned:n>=0}}let $_=[];function Xk(){let n=$_.pop();return n?(n.offset=n.limit=0,n):{bytes:new Uint8Array(64),offset:0,limit:0}}function z2(n){$_.push(n)}function Jk(n,e){if(n.offset+e>n.limit)throw new Error("Skip past limit");n.offset+=e}function uy(n){return n.offset>=n.limit}function ef(n,e){let t=n.bytes,i=n.offset,r=n.limit,o=i+e;if(o>t.length){let s=new Uint8Array(2*o);s.set(t),n.bytes=s}return n.offset=o,o>r&&(n.limit=o),i}function rp(n,e){let t=n.offset;if(t+e>n.limit)throw new Error("Read past limit");return n.offset+=e,t}function hy(n,e){let t=rp(n,e),i=String.fromCharCode,r=n.bytes,o="",s="";for(let a=0;a<e;a++){let c,d,l,h,p=r[a+t];128&p?(224&p)==192?a+1>=e?s+=o:(c=r[a+t+1],(192&c)!=128?s+=o:(h=(31&p)<<6|63&c,h<128?s+=o:(s+=i(h),a++))):(240&p)==224?a+2>=e?s+=o:(c=r[a+t+1],d=r[a+t+2],(49344&(c|d<<8))!=32896?s+=o:(h=(15&p)<<12|(63&c)<<6|63&d,h<2048||h>=55296&&h<=57343?s+=o:(s+=i(h),a+=2))):(248&p)==240?a+3>=e?s+=o:(c=r[a+t+1],d=r[a+t+2],l=r[a+t+3],(12632256&(c|d<<8|l<<16))!=8421504?s+=o:(h=(7&p)<<18|(63&c)<<12|(63&d)<<6|63&l,h<65536||h>1114111?s+=o:(h-=65536,s+=i(55296+(h>>10),56320+(1023&h)),a+=3))):s+=o:s+=i(p)}return s}function rl(n,e){let t=e.length,i=0;for(let s=0;s<t;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<t&&(a=(a<<10)+e.charCodeAt(++s)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4}ni(n,i);let r=ef(n,i),o=n.bytes;for(let s=0;s<t;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<t&&(a=(a<<10)+e.charCodeAt(++s)-56613888),a<128?o[r++]=a:(a<2048?o[r++]=a>>6&31|192:(a<65536?o[r++]=a>>12&15|224:(o[r++]=a>>18&7|240,o[r++]=a>>12&63|128),o[r++]=a>>6&63|128),o[r++]=63&a|128)}}function Bl(n,e){let t=ef(n,e.limit),i=n.bytes,r=e.bytes;for(let o=0,s=e.limit;o<s;o++)i[o+t]=r[o]}function q2(n){return n.bytes[rp(n,1)]}function Qk(n,e){let t=ef(n,1);n.bytes[t]=e}function py(n){let e=rp(n,8),t=n.bytes;return es[0]=t[e++],es[1]=t[e++],es[2]=t[e++],es[3]=t[e++],es[4]=t[e++],es[5]=t[e++],es[6]=t[e++],es[7]=t[e++],qk[0]}function CR(n,e){let t=ef(n,8),i=n.bytes;qk[0]=e,i[t++]=es[0],i[t++]=es[1],i[t++]=es[2],i[t++]=es[3],i[t++]=es[4],i[t++]=es[5],i[t++]=es[6],i[t++]=es[7]}function qc(n){let e,t=0,i=0;do e=q2(n),t<32&&(i|=(127&e)<<t),t+=7;while(128&e);return i}function ni(n,e){for(e>>>=0;e>=128;)Qk(n,127&e|128),e>>>=7;Qk(n,e)}function hi(n,e){let t=e.low>>>0,i=(e.low>>>28|e.high<<4)>>>0,r=e.high>>>24,o=r===0?i===0?t<16384?t<128?1:2:t<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,s=ef(n,o),a=n.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=o!==9?128|r:127&r;case 8:a[s+7]=o!==8?i>>>21|128:i>>>21&127;case 7:a[s+6]=o!==7?i>>>14|128:i>>>14&127;case 6:a[s+5]=o!==6?i>>>7|128:i>>>7&127;case 5:a[s+4]=o!==5?128|i:127&i;case 4:a[s+3]=o!==4?t>>>21|128:t>>>21&127;case 3:a[s+2]=o!==3?t>>>14|128:t>>>14&127;case 2:a[s+1]=o!==2?t>>>7|128:t>>>7&127;case 1:a[s]=o!==1?128|t:127&t}}function th(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}let X2=new Map([["moderation",1],["supervise",2]]);class S9 extends Ki{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;let t=this._connectionState;this._connectionState=e,this.emit(sr.CONNECTION_STATE_CHANGE,t,e)}get inspectType(){return this._inspectType}set inspectType(e){var t;this._inspectMode=un(t=e.map(i=>X2.get(i)||0)).call(t,(i,r)=>i+r),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(e){super(),U(this,"name","AgoraRTCVideoContentInspect"),U(this,"_connectionState",xe.CONNECTING),U(this,"_innerConnectionState",void 0),U(this,"sequence",0),U(this,"inspectStartTime",void 0),U(this,"workerManagerConnection",void 0),U(this,"workerConnection",void 0),U(this,"workerMessageLengthLimit",void 0),U(this,"inspectIntervalMinimum",void 0),U(this,"qualityRatio",void 0),U(this,"_connectInfo",void 0),U(this,"_cancelTokenSource",Qi.CancelToken.source()),U(this,"_retryConfig",void 0),U(this,"wmSequence",0),U(this,"inspectInterval",void 0),U(this,"inspectTimer",null),U(this,"ossFilePrefix",void 0),U(this,"extraInfo",void 0),U(this,"_inspectType",void 0),U(this,"_inspectMode",void 0),U(this,"_quality",1),U(this,"qualityTimer",null),U(this,"_inspectId",void 0),U(this,"_needWorkUrlOnly",!1),U(this,"inspectImage",()=>{if(this.connectionState!==xe.CONNECTED)throw new H(L.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===xe.CONNECTED?this.requestToInspectImage():y.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=vt(5,"inspect-"),this.workerMessageLengthLimit=F("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=F("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=F("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new M_("worker-manager-"+this._inspectId,mr),this.on(sr.STATE_CHANGE,(t,i)=>{this._innerConnectionState=t,y.debug("[".concat(this._inspectId,"] Inspect operation :").concat(Kn[t]," ").concat(i||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new M_("worker-"+this._inspectId,mr),this.handleWorkerEvents()}async init(e,t){this.emit(sr.STATE_CHANGE,Kn.CONNECT_AP),this._connectInfo=e;let i=this._cancelTokenSource.token;return this._retryConfig=t,new Z((r,o)=>{this.on(sr.CONNECTION_STATE_CHANGE,(s,a)=>{a===xe.CONNECTED&&r()}),this.requestAP(e,i,t).then(s=>{this.connectWorkerManager(s)}).catch(s=>{o(s)})})}async requestAP(e,t,i){let r=F("WEBCS_DOMAIN").map(a=>"https://".concat(a,"/api/v1")),o=await function(a,c,d,l){let{appId:h,areaCode:p,cname:f,sid:m,token:g,uid:S}=c;hm++;let T="image_moderation_api",C={service_name:T,json_body:JSON.stringify({appId:h,areaCode:p,cname:f,command:"allocateEdge",requestId:hm,seq:hm,sid:m,token:g,ts:Date.now(),uid:S+""})},b,D,x=a[0];return fa(async()=>{b=Date.now();let k=await cc(x,{data:C,cancelToken:d,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(D=Date.now()-b,k.code!==0){let se=new H(L.UNEXPECTED_RESPONSE,"image inspect ap error, code"+k.code,{retry:!0,responseTime:D});throw y.error(se.toString()),se}let V=JSON.parse(k.json_body);if(V.code!==200){let se=new H(L.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(V.code,", reason: ").concat(V.reason),{code:V.code,responseTime:D});throw y.error(se.toString()),se}if(!V.servers||!Array.isArray(V.servers)||V.servers.length===0){let se=new H(L.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:V.code,responseTime:D});throw y.error(se.toString()),se}let W=F("VIDEO_INSPECT_WORKER_MANAGER_WSS");if(W)return{addressList:[W],workerToken:V.workerToken,vid:V.vid,responseTime:D};let K=F("VIDEO_INSPECT_WORKER_MANAGER_HOST"),J=F("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:V.servers.map(se=>{let{address:Ne,wss:Ce}=se;if(Ne&&Ce)return"wss://".concat(Ne.replace(/\./g,"-"),".").concat(K,":").concat(J||Ce)}).filter(se=>!!se),workerToken:V.workerToken,vid:V.vid,responseTime:D}},(k,V)=>(_e.apworkerEvent(m,{success:!0,sc:200,serviceName:T,responseDetail:JSON.stringify(k.addressList),firstSuccess:V===0,responseTime:D,serverIp:a[V%a.length]}),!1),(k,V)=>(_e.apworkerEvent(m,{success:!1,sc:k.data&&k.data.code||200,serviceName:T,responseTime:D,serverIp:a[V%a.length]}),!!(k.code!==L.OPERATION_ABORTED&&k.code!==L.UNEXPECTED_RESPONSE||k.data&&k.data.retry)&&(x=a[(V+1)%a.length],!0)),l)}(r,e,t,i);this.emit(sr.STATE_CHANGE,Kn.AP_CONNECTED);let{addressList:s}=o;return this.wmSequence++,s}async connectWorkerManager(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=t,this.emit(sr.STATE_CHANGE,Kn.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(Je.CONNECTED,async()=>{this.emit(sr.STATE_CHANGE,Kn.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.24.2",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(Je.CLOSED,()=>{this._innerConnectionState<Kn.GET_WORKER_MANAGER_RESPONSE&&y.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(Je.FAILED,()=>{this._innerConnectionState<Kn.GET_WORKER_MANAGER_RESPONSE&&y.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(Je.RECONNECTING,()=>{this._innerConnectionState<Kn.GET_WORKER_MANAGER_RESPONSE&&y.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(Je.ON_MESSAGE,async e=>{this.emit(sr.STATE_CHANGE,Kn.GET_WORKER_MANAGER_RESPONSE);let t=this.workerManagerConnection.url;this.workerManagerConnection.close();let i=JSON.parse(e.data);if(i.code!==200)throw y.error("[".concat(this._inspectId,"] Unexpected code ").concat(i.code," from worker manager")),new H(L.UNEXPECTED_RESPONSE,"response code of worker is unexpected",i);if(!(i.serverResponse&&i.serverResponse.portWss&&t))throw y.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(i))),new H(L.UNEXPECTED_RESPONSE,"response content of worker is unexpected",i);{let r=F("VIDEO_INSPECT_WORKER_PORT")||i.serverResponse.portWss,o=t.replace(/:\d+\/?$/,":".concat(r));this.emit(sr.STATE_CHANGE,Kn.CONNECT_WORKER,o),this._needWorkUrlOnly?this.emit(sr.REQUEST_NEW_WORKER_URL,o):await this.connectWorker(o)}}),this.workerManagerConnection.on(Je.WILL_RECONNECT,(e,t,i)=>{i(e)}),this.workerManagerConnection.on(Je.REQUEST_NEW_URLS,(e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)})}handleWorkerEvents(){this.workerConnection.on(Je.CONNECTED,async()=>{this.emit(sr.STATE_CHANGE,Kn.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=xe.CONNECTED}),this.workerConnection.on(Je.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){let i=f9(new Uint8Array(e.data));if(F("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&y.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(i)),i.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(sr.INSPECT_RESULT,void 0,void 0);if(i.data&&i.data.scorePorn&&i.data.scoreSexy&&i.data.scoreNeutral){var t;let r={porn:i.data.scorePorn,sexy:i.data.scoreSexy,neutral:i.data.scoreNeutral},o=un(t=Object.keys(r)).call(t,(a,c)=>r[a]>r[c]?a:c,"porn"),s=Object.keys(r).find(a=>a===o);this.emit(sr.INSPECT_RESULT,s)}else this.emit(sr.INSPECT_RESULT,void 0,new H(L.UNEXPECTED_RESPONSE,i.code+"","There is an unexpected data on message"))}else this.emit(sr.INSPECT_RESULT,void 0,new H(L.UNEXPECTED_RESPONSE,i.code+"",i.msg))}else y.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(sr.INSPECT_RESULT,void 0,new H(L.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(Je.CLOSED,()=>{this.connectionState=xe.CLOSED}),this.workerConnection.on(Je.FAILED,()=>{this.connectionState=xe.CLOSED}),this.workerConnection.on(Je.RECONNECTING,()=>{this.connectionState=this.connectionState===xe.CONNECTED?xe.RECONNECTING:xe.CONNECTING}),this.workerConnection.on(Je.WILL_RECONNECT,(e,t,i)=>{e==="recover"&&i(e),i("tryNext")}),this.workerConnection.on(Je.REQUEST_NEW_URLS,(e,t)=>{this.workerManagerConnection.close(),this.once(sr.REQUEST_NEW_WORKER_URL,i=>{e([i])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(i=>{this.connectWorkerManager(i,!0)}).catch(i=>{t(i)})})}async requestToInspectImage(){this.sequence++;let e=Xt(this,sr.CLIENT_LOCAL_VIDEO_TRACK),t={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(sr.INSPECT_RESULT,void 0,new H(L.INVALID_OPERATION,"Only the track being played can be inspected"));let i=await this.generateRequestData(e,t);this.workerConnection.sendMessage(i,!0,!0)}else this.emit(sr.INSPECT_RESULT,void 0,new H(L.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,t){let{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c}=t,d=Date.now(),l=await e.getCurrentFrameImage("image/jpeg",this.quality),h=await nD(l,i,r),p=this.sequence+"-"+o+"-"+c+"-"+d+"-"+vt(12,""),f={appId:i,cid:o,cname:r,deviceId:"",elapse:(m=Number(d-this.inspectStartTime),{low:m|=0,high:m>>31,unsigned:m>=0}),fileSize:h.byteLength,jpgEncryption:2,height:l.height,width:l.width,jpg:h,networkType:6,osType:7,requestId:p,sdkVersion:"4.24.2",sequence:this.sequence,sid:a,timestamp:Im(d),uid:c,vid:s,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};var m;this.extraInfo===void 0&&delete f.callbackData,this.ossFilePrefix===void 0&&delete f.ossFilePrefix;let g=_9(f);if(g.byteLength<this.workerMessageLengthLimit){if(F("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){let S=function(T){for(var C=1;C<arguments.length;C++){var b=arguments[C]!=null?arguments[C]:{};C%2?th(Object(b),!0).forEach(function(D){U(T,D,b[D])}):Object.getOwnPropertyDescriptors?Object.defineProperties(T,Object.getOwnPropertyDescriptors(b)):th(Object(b)).forEach(function(D){Object.defineProperty(T,D,Object.getOwnPropertyDescriptor(b,D))})}return T}({},f);delete S.jpg,y.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(S))}return g}{let S=this.quality*this.qualityRatio;return this.quality=S,await this.generateRequestData(e,{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Qi.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=xe.CLOSED,this.emit(sr.STATE_CHANGE,Kn.CLOSED)}}let T9={name:"ContentInspect",create:function(n){let{config:e}=n;return function(t){if(!t)throw new H(L.INVALID_PARAMS,"inspectConfig is necessary.");if(!t.inspectType||!Array.isArray(t.inspectType))throw new H(L.INVALID_PARAMS,"inspectConfig.inspectType is necessary and is an instance of Array.");{let i=[...new Set(t.inspectType)];i.forEach(r=>{var o;if(!z(o=["supervise","moderation"]).call(o,r))throw new H(L.INVALID_PARAMS,"".concat(r," is not a valid inspect type."))}),t.inspectType=i}if(t&&t.extraInfo&&t.extraInfo.length>1024)throw new H(L.INVALID_PARAMS,"inspectConfig.extraInfo length cannot exceed 1024 bytes")}(e),new S9(e)}};var J2=A(Qr.Object.getOwnPropertySymbols),Q2=qe,R9=CE.indexOf,v9=_p,Zk=Ri([].indexOf),_y=!!Zk&&1/Zk([1],1,-0)<0;Q2({target:"Array",proto:!0,forced:_y||!v9("indexOf")},{indexOf:function(n){var e=arguments.length>1?arguments[1]:void 0;return _y?Zk(this,n,e)||0:R9(this,n,e)}});var Z2=ln("Array","indexOf"),C9=me,y9=Z2,$k=Array.prototype,e1=function(n){var e=n.indexOf;return n===$k||C9($k,n)&&e===$k.indexOf?y9:e},$2=A(e1);function ex(n,e){if(n==null)return{};var t,i,r=function(s,a){if(s==null)return{};var c={};for(var d in s)if({}.hasOwnProperty.call(s,d)){if($2(a).call(a,d)!==-1)continue;c[d]=s[d]}return c}(n,e);if(J2){var o=J2(n);for(i=0;i<o.length;i++)t=o[i],$2(e).call(e,t)===-1&&{}.propertyIsEnumerable.call(n,t)&&(r[t]=n[t])}return r}let tx=class{get localCapabilities(){return Li(this._localCapabilities)}get rtpCapabilities(){return Li(this._rtpCapabilities)}get candidates(){return Li(this._candidates)}get iceParameters(){return Li(this._iceParameters)}get dtlsParameters(){return Li(this._dtlsParameters)}constructor(n){U(this,"sessionDesc",void 0),U(this,"_localCapabilities",void 0),U(this,"_rtpCapabilities",void 0),U(this,"_candidates",void 0),U(this,"_iceParameters",void 0),U(this,"_dtlsParameters",void 0),U(this,"setup",void 0),U(this,"currentMidIndex",void 0),U(this,"cname","o/i14u9pJrxRKAsu"),U(this,"firefoxSsrcMidMap",new Map),n=Li(n);let{remoteIceParameters:e,remoteDtlsParameters:t,candidates:i,remoteRTPCapabilities:r,localCapabilities:o,direction:s,setup:a,videoCodec:c,audioCodec:d}=n,l;this.setup=a,l=s===Ke.RECEIVE_ONLY?Oo(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):Oo(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=r,this._candidates=i,this._iceParameters=e,this._dtlsParameters=t,this._localCapabilities=o;let h=s===Ke.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,p=s===Ke.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,f=s===Ke.RECEIVE_ONLY?r.send.videoCodecs:Nl(ke.VIDEO,h,p,c),m=s===Ke.RECEIVE_ONLY?r.send.audioCodecs:Nl(ke.AUDIO,h,p,d);for(let g of l.mediaDescriptions)g.attributes.iceUfrag=e.iceUfrag,g.attributes.icePwd=e.icePwd,g.attributes.fingerprints=t.fingerprints,g.attributes.candidates=i,g.attributes.setup=this.setup,g.media.mediaType==="application"&&(g.attributes.sctpPort="5000"),g.media.mediaType==="video"&&(g.media.fmts=f.map(S=>S.payloadType.toString(10)),g.attributes.payloads=f,g.attributes.extmaps=h.videoExtensions),g.media.mediaType==="audio"&&(g.media.fmts=m.map(S=>S.payloadType.toString(10)),g.attributes.payloads=m,g.attributes.extmaps=h.audioExtensions,Ol(g));this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return sn(this.sessionDesc)}hasMid(n){return Array.isArray(n)?n.every(e=>this.hasMid(e)):this.sessionDesc.mediaDescriptions.some(e=>e.attributes.mid===n)}send(n,e,t,i,r){t=t.replace(/ /g,"-");let{ssrcs:o,ssrcGroups:s}=am(e,this.cname,F("SYNC_GROUP")?t:void 0),a=this.findPreloadMediaDesc(o);if(a){if(ji()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){let c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{let c=this.findAvailableMediaIndex(n,o,i),d;return c===-1?(d=this.createOrRecycleSendMedia(n,o,s,"sendonly",i,r),this.updateBundleMids()):(d=Li(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=o,d.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),ji()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,d.attributes.mid),{needExchangeSDP:!0,mid:d.attributes.mid}}}stopSending(n){let e=this.sessionDesc.mediaDescriptions.filter(t=>t.attributes.mid&&n.indexOf(t.attributes.mid)!==-1);if(e.length!==n.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach(t=>{t.attributes.ssrcs=[]}),this.updateBundleMids()}receive(n,e,t){let i=[];return n.forEach(r=>{let o=r._mediaStreamTrack.kind,s=this.findAvailableRecvMediaIndex(o),a,c=!1;s===-1?(c=!0,a=this.createOrRecycleRecvMedia(r,[],"recvonly",e,t),this.updateBundleMids()):(a=Li(this.sessionDesc.mediaDescriptions[s]),a.attributes.direction="recvonly"),i.push({mid:a.attributes.mid,needCreateTransceiver:c})}),i}stopReceiving(n){let e=this.sessionDesc.mediaDescriptions.filter(t=>n.indexOf(t.attributes.mid)!==-1);if(e.length!==n.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach(t=>{t.media.port="0",t.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(n){let{foundation:e,protocol:t,address:i,port:r,type:o,relatedAddress:s,relatedPort:a,priority:c}=new RTCIceCandidate(n),d={foundation:e??"",componentId:"1",transport:t??"",priority:c?c+"":"",connectionAddress:i??"",port:r?r+"":"",type:o?o+"":"",relAddr:s??"",relPort:a?a+"":"",extension:{}};this.candidates.some(l=>l.priority===d.priority&&l.connectionAddress===d.connectionAddress&&l.port===d.port)||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach(l=>{l.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(n,e,t,i,r){let o=n._mediaStreamTrack.kind,s=this.rtpCapabilities.recv,a=Nl(o,s,this.localCapabilities.send,o===ke.AUDIO?r:i),c=o===ke.VIDEO?s.videoExtensions:s.audioExtensions,d="".concat(++this.currentMidIndex),l={media:{mediaType:o,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:t,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungRecvMediaDsec(l,n);let h=this.findFirstClosedMedia(o);if(h){let p=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[p]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}muteRemote(n){let e=this.sessionDesc.mediaDescriptions.filter(t=>z(n).call(n,t.attributes.mid||""));if(e.length!==n.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(t=>{t.attributes.direction="inactive"})}unmuteRemote(n){let e=this.sessionDesc.mediaDescriptions.filter(t=>z(n).call(n,t.attributes.mid||""));if(e.length!==n.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(t=>{t.attributes.direction="recvonly"})}findAvailableMediaIndex(n,e,t){return this.sessionDesc.mediaDescriptions.findIndex(i=>{let r=i.media.mediaType===n&&i.media.port!=="0"&&(i.attributes.direction==="sendonly"||i.attributes.direction==="sendrecv")&&i.attributes.ssrcs.length===0;if(ji()){if(r){let o=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(o||i.attributes.mid!=="0"&&i.attributes.mid!=="1")||!(!o||o!==i.attributes.mid)}return!1}return r&&i.attributes.mid===t})}findAvailableRecvMediaIndex(n){return this.sessionDesc.mediaDescriptions.findIndex(e=>{let t=e.media.mediaType===n&&e.media.port!=="0"&&(e.attributes.direction==="recvonly"||e.attributes.direction==="sendrecv");return e.attributes.mid!=="0"&&e.attributes.mid!=="1"&&t})}predictReceivingMids(n){let e=[];for(let t=0;t<n;t++)e.push((this.currentMidIndex+t+1).toString(10));return e}restartICE(n){n=Li(n),this._iceParameters=n,this.sessionDesc.mediaDescriptions.forEach(e=>{e.attributes.iceUfrag=n.iceUfrag,e.attributes.icePwd=n.icePwd})}createOrRecycleSendMedia(n,e,t,i,r,o){let s=this.rtpCapabilities.send,a=n===ke.VIDEO?s.videoCodecs:s.audioCodecs,c=n===ke.VIDEO?s.videoExtensions:s.audioExtensions;ji()&&(r="".concat(++this.currentMidIndex));let d={media:{mediaType:n,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(h=>h.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:t,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:r}};d=this.mungSendMediaDesc(d,o);let l=this.findFirstClosedMedia(n);if(l){let h=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[h]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(n,e,t){let i=Li(n);return Fu(i),Kd(i,e),LT(i,e),cC(i),kT(i,t,this.localCapabilities.send),i}mungSendMediaDesc(n,e){let t=Li(n);return kT(t,e,this.localCapabilities.recv),Ol(t),t}updateRecvMedia(n,e){let t=this.sessionDesc.mediaDescriptions.findIndex(i=>i.attributes.mid===n);if(t!==-1){let i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[t],e);this.sessionDesc.mediaDescriptions[t]=i}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(n=>n.media.port!=="0").map(n=>n.attributes.mid)}findPreloadMediaDesc(n){return this.sessionDesc.mediaDescriptions.find(e=>{var t;return((t=e.attributes)===null||t===void 0||(t=t.ssrcs[0])===null||t===void 0?void 0:t.ssrcId)===n[0].ssrcId})}findFirstClosedMedia(n){return this.sessionDesc.mediaDescriptions.find(e=>ji()?e.media.port==="0"&&e.media.mediaType===n:e.media.port==="0")}},ix=["sdp"];var zi;function Hi(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function ih(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Hi(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):Hi(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}let rh=(zi=class Ry extends HP{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return(e=(t=this.peerConnection.getReceivers()[0])===null||t===void 0||(t=t.transport)===null||t===void 0?void 0:t.state)!==null&&e!==void 0?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(e,t,i){super(e,t),U(this,"direction",void 0),U(this,"name",void 0),U(this,"store",void 0),U(this,"spec",void 0),U(this,"peerConnection",void 0),U(this,"initialOffer",void 0),U(this,"transport",void 0),U(this,"statsFilter",void 0),U(this,"localCandidateCount",0),U(this,"_isInRestartIce",!1),U(this,"mutex",void 0),U(this,"onLocalCandidate",void 0),U(this,"remoteSDP",void 0),U(this,"pendingCandidates",[]),U(this,"localCapabilities",void 0),U(this,"isReady",!1),U(this,"restartCnt",0),U(this,"curTurnServerIndex",0),this.store=t,this.spec=e,this.mutex=new mn("P2PConnection-mutex",t.clientId),this.peerConnection=new RTCPeerConnection(Ry.resolvePCConfiguration(e,t.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=i??Ke.SEND_ONLY,this.name=this.direction===Ke.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=Ov(this.peerConnection,F("STATS_UPDATE_INTERVAL"),void 0,ji()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{let t=await lC();if(this.localCapabilities=Ns(t),e){let{sdp:i}=e,r=ex(e,ix),o=function(){let l={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},h=sm(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},f={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},m={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(ac(h,l,"videoExtensions",p,f,m),ac(h,l,"videoCodecs",p,f,m),ac(h,l,"audioExtensions",p,f,m),ac(h,l,"audioCodecs",p,f,m),F("RAISE_H264_BASELINE_PRIORITY")){let g=m.videoCodecs.findIndex(S=>S.rtpMap&&S.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&S.fmtp&&S.fmtp.parameters["profile-level-id"]==="42001f");if(g!==-1){let S=m.videoCodecs.findIndex(T=>T.rtpMap&&T.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(S<g){y.debug("raising H264 baseline profile priority");let T=m.videoCodecs[g];m.videoCodecs.splice(g,1),m.videoCodecs.splice(S,0,T)}S!==-1&&F("FILTER_SEND_H264_BASELINE")&&(p.videoCodecs=p.videoCodecs.filter(T=>!(T.rtpMap&&T.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&T.fmtp&&T.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:p,recv:f,sendrecv:m}}({},{},i);this.remoteSDP=new tx({remoteIceParameters:r.iceParameters,remoteDtlsParameters:r.dtlsParameters,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;let s=await this.peerConnection.createAnswer();if(!s.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");let a=ba(s.sdp);await this.peerConnection.setLocalDescription(s);let c=await uC({},{},s.sdp);this.localCapabilities=Ns(c);let d=this.peerConnection.getTransceivers()[0];return d!=null&&d.receiver&&d.receiver.transport&&this.tryBindTransportEvents(d.receiver.transport),ih(ih({},a),{},{sdp:s.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});let i=await this.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let r=ba(i.sdp);return this.initialOffer=i,ih(ih({},r),{},{sdp:i.sdp})}}catch(t){throw new O(L.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);let{sdp:t,iceParameters:i,dtlsParameters:r}=e,o=await uC({},{},t);this.remoteSDP=new tx({remoteIceParameters:i,remoteDtlsParameters:r,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});let s=this.peerConnection.getTransceivers()[0];s!=null&&s.sender&&s.sender.transport&&this.tryBindTransportEvents(s.sender.transport)}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(t.toString()))}}async addRemoteCandidate(e){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(t=>{this.peerConnection.addIceCandidate(t)}),this.pendingCandidates=[])}catch(t){throw new O(L.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(t.toString()))}}send(e,t,i){var r=this;return wo(function*(){let o=yield St(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let s=[],a=r.remoteSDP.receive(e,t,i);e.forEach((S,T)=>{if(a[T].needCreateTransceiver){let C=r.peerConnection.addTransceiver(S._mediaStreamTrack,{direction:"sendonly"});s.push(C),S._updateRtpTransceiver(C)}else{let C=r.peerConnection.getTransceivers().find(b=>b.mid===a[T].mid);if(!C)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(a[T].mid));s.push(C),S._updateRtpTransceiver(C)}}),ji()&&F("SIMULCAST")===!0&&(yield St(r.applySimulcastForFirefox(s,e)));let c=a.map(S=>S.mid),d=yield St(r.peerConnection.createOffer()),l=r.mungSendOfferSDP(d.sdp,e,c),h=Oo(l),p=c.map(S=>{let T=h.mediaDescriptions.find(C=>C.attributes.mid===S);if(!T)throw new Error("Cannot extract ssrc from mediaDescription.");return xc(T,F("USE_PUB_RTX"))}),f=s.map((S,T)=>{let C=c[T];return{localSSRC:p[T],id:C}});yield St(r.peerConnection.setLocalDescription({type:"offer",sdp:l}));try{yield f}catch(S){let T=r.remoteSDP.toString();throw yield St(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield St(r.peerConnection.setRemoteDescription({type:"answer",sdp:T})),yield St(r.stopSending(c,!0)),S}yield St(r.applySimulcastEncodings(s,e)),yield St(r.applySendEncodings(s,e));let m=r.remoteSDP.toString(),g=r.logSDPExchange(l,"offer","local","send");return g==null||g(m),yield St(r.setRemoteDescription({type:"answer",sdp:m})),s.map((S,T)=>{let C=c[T];return{localSSRC:p[T],id:C}})}catch(s){throw s instanceof O?s:new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o()}})()}async stopSending(e,t){let i=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length (".concat(r.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));r.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});let o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);let a=this.remoteSDP.toString();s==null||s(a),await this.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(e,t,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,t,i,r);if(s){let c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:c});let l=await this.peerConnection.createAnswer(),h=this.mungReceiveAnswerSDP(l.sdp,o,e);d==null||d(h||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:h}),y.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else y.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));let a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a||a.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,mid:a.mid,transceiver:a}}catch(o){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async mockReceive(e,t,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,t,i,r);if(s){let a=this.remoteSDP.toString(),c=this.logSDPExchange(a,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:a});let d=await this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(d.sdp,o,e);c==null||c(l||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:l}),y.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else y.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(o){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);let t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:t});let r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(t.toString()))}}async restartICE(e){try{if(this.store.p2pTransport===Nu.Auto&&(this.store.p2pTransport=Nu.SdRtn,ot().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Ry.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,ot().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Ry.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!e){this.restartCnt++,this.isReady=!1;let t=await this.peerConnection.createOffer({iceRestart:!0});if(!t.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let{iceParameters:i}=ba(t.sdp);return this.store.descriptionStart(),this.direction===Ke.SEND_ONLY&&await this.peerConnection.setLocalDescription(t),i}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(e),this.store.descriptionStart(),this.direction===Ke.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});let t=await this.peerConnection.createAnswer();if(!t.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");let{iceParameters:i}=ba(t.sdp);return await this.peerConnection.setLocalDescription(t),i}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(t.toString()))}}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);let o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s==null||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new O(L.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,t){let i=this.peerConnection.getTransceivers().filter(r=>r.mid===e);i.length===1&&(this.isVP8Simulcast(t)?ji()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){let i=this.peerConnection.getTransceivers().find(r=>r.mid===t);i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){let e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){let t=e[0].transport.iceTransport,{local:i,remote:r}=t.getSelectedCandidatePair();return{local:ih(ih({},Ea),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:ih(ih({},Ea),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e,t;z(e=["connected","completed"]).call(e,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{if(e.candidate){var t;e.candidate.candidate&&((t=this.onLocalCandidate)===null||t===void 0||t.call(this,e.candidate.toJSON())),this.localCandidateCount+=1}else y.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,r={iceServers:[]};var o;return e.iceServers?r.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(bt(e.turnServer.servers)?r.iceServers=e.turnServer.servers:(r.iceServers&&r.iceServers.push(...Ry.turnServerConfigToIceServers(e.turnServer.servers,t,i)),F("USE_TURN_SERVER_OF_GATEWAY")&&r.iceServers&&e.turnServer.serversFromGateway&&r.iceServers.push(...Ry.turnServerConfigToIceServers(e.turnServer.serversFromGateway,t,i)),z(o=[Nu.Relay,Nu.SdRtn]).call(o,t)&&(r.iceTransportPolicy="relay"),F("FORCE_TURN_TCP")?r.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(s=>{s.forceturn&&(r.iceTransportPolicy="relay")}))),F("ENABLE_ENCODED_TRANSFORM")&&ot().supportWebRTCEncodedTransform&&(r.encodedInsertableStreams=!0),y.debug("P2PConnection p2pTransport is ".concat(t)),r}static turnServerConfigToIceServers(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,r=[],o=e.filter(a=>a.tcpport);y.debug("P2PConnection turnServers is ".concat(o,", current index is ").concat(i));let s=o.length>i?o[i]:o[0];switch(t){case Nu.SdRtn:let a=e.filter(d=>{var l;return z(l=d.username).call(l,"glb:")&&d.turnServerURL==d.turnServerURL}),c=a.length>i?a[i]:a[0];c&&(r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turn:".concat(wa(c.turnServerURL),":").concat(c.tcpport,"?transport=udp")}),r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turns:".concat(wa(c.turnServerURL),":").concat(c.tcpport,"?transport=tcp")}));break;case Nu.Relay:s&&(r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(s.turnServerURL,":").concat(s.tcpport,"?transport=udp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(wa(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}));break;default:s&&(r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(s.turnServerURL,":").concat(s.tcpport,"?transport=udp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(wa(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"stun:".concat(s.turnServerURL,":").concat(s.tcpport)}))}return r}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var i;e!=null&&e.state&&((i=this.onDTLSTransportStateChange)===null||i===void 0||i.call(this,e.state))},e.onerror=i=>{var r;(r=this.onDTLSTransportError)===null||r===void 0||r.call(this,"error"in i?i.error:i)};let t=e.iceTransport;t&&(t.onstatechange=()=>{let i=e==null?void 0:e.iceTransport.state;var r;i&&((r=this.onICETransportStateChange)===null||r===void 0||r.call(this,i))},t.getSelectedCandidatePair&&(t.onselectedcandidatepairchange=()=>{if(t.getSelectedCandidatePair()){let{local:i,remote:r}=t.getSelectedCandidatePair()||{};if(i&&r){let o=i.address+":"+i.port,s=r.address+":"+r.port;y.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(_s(o)),", remote ").concat(JSON.stringify(_s(s))))}}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,t){var i;if(t||(t=this.peerConnection.getSenders().find(l=>l.track===e._mediaStreamTrack)),!t)return y.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return y.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!ot().supportSetRtpSenderParameters)return y.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let r={},o={};switch(e._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(e._encoderConfig){var s;let{bitrateMax:l,frameRate:h,scaleResolutionDownBy:p}=e._encoderConfig;l&&(o.maxBitrate=1e3*l),z(s=e._hints).call(s,Re.LOW_STREAM)&&(h&&(o.maxFramerate=Mo(h)),p&&p>=1&&(o.scaleResolutionDownBy=p))}if(F("DSCP_TYPE")&&Ud()){var a;let l=F("DSCP_TYPE");z(a=["very-low","low","medium","high"]).call(a,l)&&(o.networkPriority=l)}let c=t.getParameters(),d=(i=c.encodings)===null||i===void 0?void 0:i[0];ji()&&!d&&(r.encodings=[o]),d&&Object.assign(d,o),Object.assign(c,r),y.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await t.setParameters(c)}async applySendEncodings(e,t){try{if(!ot().supportSetRtpSenderParameters||e.length!==t.length)return;for(let i=0;i<e.length;i++){let r=e[i],o=t[i];o instanceof Jt&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,r.sender)}}catch{y.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,i){let r=Oo(e);return t.forEach((o,s)=>{let a=i[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Kd(c,o),cm(c,o,this.store.codec))}),sn(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;(t=this.onFirstAudioReceived)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;(t=this.onFirstVideoReceived)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;(t=this.onFirstAudioDecoded)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;(t=this.onFirstVideoDecodedTimeout)===null||t===void 0||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let c=0;c<e.length;c++){var i,r,o,s,a;let d=e[c],l=t[c];if(l instanceof Jt&&!z(i=l._hints).call(i,Re.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=l._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=l._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){let h={},p={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};h.encodings=[{rid:"m",active:!0,maxBitrate:p.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:p.high}];let f=d.sender.getParameters();await d.sender.setParameters(Object.assign(f,h))}}}async applySimulcastEncodings(e,t){if(!ji()&&e.length===t.length)for(let i=0;i<e.length;i++){let r=t[i];if(r instanceof Jt&&this.isVP8Simulcast(r)){let o=e[i],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];let c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s))}}}isVP8Simulcast(e){var t,i,r,o,s;return!!(e instanceof Jt&&F("SIMULCAST")&&this.store.codec==="vp8"&&!z(t=e._hints).call(t,Re.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=e._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=e._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,t,i,r){if(F("SDP_LOGGING"))return y.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(t," SDP during P2PConnection.").concat(r,`
`),e),t==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r)}:void 0}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let t=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map(s=>{s.direction="inactive"});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);let o=this.remoteSDP.toString();r==null||r(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(t.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let t=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map(async s=>{s.direction="sendonly"});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);let o=this.remoteSDP.toString();r==null||r(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(t.toString()))}}async getRemoteSSRC(e,t){var i;if(t=t??((i=this.currentRemoteDescription)===null||i===void 0?void 0:i.sdp)){var r;let o=(r=Oo(t).mediaDescriptions.find(s=>s.attributes.mid===e))===null||r===void 0?void 0:r.attributes.ssrcs;return o==null?void 0:o[0].ssrcId}}async setRemoteDescription(e){var t;await this.peerConnection.setRemoteDescription(e),z(t=["connected","completed"]).call(t,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(e,t,i){let r=Oo(e),o=r.mediaDescriptions.find(s=>s.attributes.mid===t);return o&&i===ke.AUDIO&&o.media.mediaType==="audio"&&Ol(o),sn(r)}},Oe(zi.prototype,"establish",[mc],Object.getOwnPropertyDescriptor(zi.prototype,"establish"),zi.prototype),Oe(zi.prototype,"connect",[mc],Object.getOwnPropertyDescriptor(zi.prototype,"connect"),zi.prototype),Oe(zi.prototype,"receive",[mc],Object.getOwnPropertyDescriptor(zi.prototype,"receive"),zi.prototype),Oe(zi.prototype,"mockReceive",[mc],Object.getOwnPropertyDescriptor(zi.prototype,"mockReceive"),zi.prototype),Oe(zi.prototype,"stopReceiving",[mc],Object.getOwnPropertyDescriptor(zi.prototype,"stopReceiving"),zi.prototype),Oe(zi.prototype,"restartICE",[mc],Object.getOwnPropertyDescriptor(zi.prototype,"restartICE"),zi.prototype),Oe(zi.prototype,"close",[mc],Object.getOwnPropertyDescriptor(zi.prototype,"close"),zi.prototype),Oe(zi.prototype,"updateEncoderConfig",[mc],Object.getOwnPropertyDescriptor(zi.prototype,"updateEncoderConfig"),zi.prototype),Oe(zi.prototype,"updateSendParameters",[mc],Object.getOwnPropertyDescriptor(zi.prototype,"updateSendParameters"),zi.prototype),Oe(zi.prototype,"replaceTrack",[mc],Object.getOwnPropertyDescriptor(zi.prototype,"replaceTrack"),zi.prototype),Oe(zi.prototype,"muteLocal",[mc],Object.getOwnPropertyDescriptor(zi.prototype,"muteLocal"),zi.prototype),Oe(zi.prototype,"unmuteLocal",[mc],Object.getOwnPropertyDescriptor(zi.prototype,"unmuteLocal"),zi.prototype),zi);function mc(n,e,t){let i=n[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return t.value=async function(){let r=this.mutex,o=await r.lock("From P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},t}let to=function(n){return n.SEND_ONLY="SEND_ONLY",n.RECEIVE_ONLY="RECEIVE_ONLY",n}({});var Xc,t1,i1,r1,n1,o1,s1,a1,c1,d1,l1,er;function tr(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function yR(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?tr(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):tr(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}let fy=(Xc=nl(to.SEND_ONLY),t1=nl(to.SEND_ONLY),i1=nl(),r1=nl(to.RECEIVE_ONLY),n1=nl(to.RECEIVE_ONLY),o1=nl(to.RECEIVE_ONLY),s1=nl(to.RECEIVE_ONLY),a1=nl(to.RECEIVE_ONLY),c1=nl(to.RECEIVE_ONLY),d1=nl(),l1=nl(to.RECEIVE_ONLY),er=class extends Ki{get state(){return this._state}set state(n){let e=this._state;this._state=n,this.emit(we.StateChange,e,this._state)}constructor(n,e){super(),U(this,"isPlanB",!1),U(this,"store",void 0),U(this,"statsUploader",void 0),U(this,"sendConnection",void 0),U(this,"recvConnection",void 0),U(this,"localTrackMap",new Map),U(this,"remoteUserMap",new Map),U(this,"localDataChannels",[]),U(this,"pendingLocalTracks",[]),U(this,"pendingRemoteTracks",[]),U(this,"statsCollector",void 0),U(this,"dtlsFailedCount",0),U(this,"sendMutex",void 0),U(this,"recvMutex",void 0),U(this,"_state",ue.Disconnected),U(this,"_restartStates",["disconnected","failed"]),U(this,"reconnectInterval",void 0),U(this,"uploadUnplinkStarted",!1),U(this,"uploadDownlinkStarted",!1),U(this,"uplinkStateUploadInterval",void 0),U(this,"downlinkStatsUploadInterval",void 0),U(this,"handleMuteLocalTrack",async(t,i,r)=>{let o=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==ue.Connected)return void r(new O(L.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));let c=this.filterTobeMutedTracks(t);if(c.length===0)return void i();let d=c.find(f=>f[0]==="videoLowTrack");d&&d[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(c.map(f=>{let[,{id:m}]=f;return m}));let l=!1;var s,a;t.trackMediaType==="video"?l=!((s=this.localTrackMap.get(Se.LocalAudioTrack))===null||s===void 0||!s.track._muted):l=((a=this.localTrackMap.get(Se.LocalVideoTrack))===null||a===void 0?void 0:a.id)===void 0;let h=this.createMuteMessage(c);await yt(this,we.RequestMuteLocal,h);let p=t.trackMediaType==="video"?sc.MUTE_LOCAL_VIDEO:sc.MUTE_LOCAL_AUDIO;await yt(this,we.RequestP2PMuteLocal,{action:p,message:h,isMuteAll:l}),i()}catch(c){r(c)}finally{o()}}),U(this,"handleUnmuteLocalTrack",async(t,i,r)=>{let o=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==ue.Connected)return void r(new O(L.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));let s=this.filterTobeUnmutedTracks(t);if(s.length===0)return void i();await this.sendConnection.unmuteLocal(s.map(d=>{let[,{id:l}]=d;return l}));let a=this.createUnmuteMessage(s),c=t.trackMediaType==="video"?sc.UNMUTE_LOCAL_VIDEO:sc.UNMUTE_LOCAL_AUDIO;await yt(this,we.RequestP2PMuteLocal,{action:c,message:a}),i()}catch(s){r(s)}finally{o()}}),U(this,"handleUpdateVideoEncoder",async(t,i,r,o)=>{let s;typeof o=="boolean"&&o||(s=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoEncoder"));try{let c=this.localTrackMap.get(Se.LocalVideoTrack);if(!this.sendConnection||!c||c.track!==t||this.state!==ue.Connected)return void i();let{id:d,track:l}=c;d&&(await this.sendConnection.updateSendParameters(d,l),await this.sendConnection.updateEncoderConfig(d,l),this.emit(we.UpdateVideoEncoder,l)),i()}catch(c){r(c)}finally{var a;(a=s)===null||a===void 0||a()}}),U(this,"handleUpdateVideoSendParameters",async(t,i,r)=>{let o=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{let s=this.localTrackMap.get(Se.LocalVideoTrack);if(!this.sendConnection||!s||s.track!==t||this.state!==ue.Connected)return void i();let{id:a,track:c}=s;a&&await this.sendConnection.updateSendParameters(a,c),i()}catch(s){r(s)}finally{o()}}),U(this,"handleReplaceTrack",async(t,i,r,o)=>{let s;y.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(t.getTrackId(),"]")),typeof o=="boolean"&&o||(s=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var a;let d=Array.from(this.localTrackMap.entries()).find(l=>{let[,{track:h}]=l;return t===h});if(!this.sendConnection||!d||d[1].id===void 0||this.state!==ue.Connected)return void i();if(await((a=this.sendConnection)===null||a===void 0?void 0:a.replaceTrack(t,d[1].id)),d[0]===Se.LocalVideoTrack&&ot().supportDualStreamEncoding){let l=this.localTrackMap.get(Se.LocalVideoLowTrack);if(l){let h=t._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=h,l.track._originMediaStreamTrack=h,await new Z((p,f)=>{this.handleReplaceTrack(l.track,p,f,!0)})}}i()}catch(d){r(d)}finally{var c;(c=s)===null||c===void 0||c()}}),U(this,"handleGetLocalVideoStats",t=>{t(this.statsCollector.getLocalVideoTrackStats())}),U(this,"handleGetLocalAudioStats",t=>{t(this.statsCollector.getLocalAudioTrackStats())}),U(this,"handleGetRemoteVideoStats",t=>this.statsCollector.getRemoteVideoTrackStats(t.uid)[t.uid]),U(this,"handleGetRemoteAudioStats",t=>this.statsCollector.getRemoteAudioTrackStats(t.uid)[t.uid]),this.store=n,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new TL(n),this.bindStatsUploaderEvents(),this.sendMutex=new mn("P2PChannel2-send-mutex",n.clientId),this.recvMutex=new mn("P2PChannel2-recv-mutex",n.clientId),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(t=>{t&&(t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="failed"||this.handleDisconnect(t.direction))})},F("ICE_RESTART_INTERVAL"))}async startP2PConnection(n,e){throw new O(L.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(n){throw new O(L.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(n,e){let t;try{if(e){this.recvConnection&&(y.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),t=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new rh(n,this.store,Ke.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);let i=await this.recvConnection.establish(e);return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}{this.state=ue.New,this.sendConnection&&(y.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),t=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new rh(n,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);let i=await this.sendConnection.establish();return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}}finally{t&&t()}}async p2pConnect(n){if(!this.sendConnection)throw new O(L.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(n),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=ue.Connected}async addRemoteCandidate(n,e){if(e===Ke.RECEIVE_ONLY){if(!this.sendConnection)throw new O(L.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(n)}else{if(!this.recvConnection)throw new O(L.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(n)}}publish(n,e,t){var i=this;return wo(function*(){let r=yield St(i.sendMutex.lock("From P2PChannel.publish"));try{if(!i.sendConnection||i.state!==ue.Connected){i.throwIfTrackTypeNotMatch(n);let d=n.filter(l=>i.pendingLocalTracks.indexOf(l)===-1);return void(i.pendingLocalTracks=i.pendingLocalTracks.concat(d))}i.store.pubId=i.store.pubId+1,qn.markPublishStart(i.store.clientId,i.store.pubId);let o=i.filterTobePublishedTracks(n,e,t);if(o.length===0)return void(yield St(i.tryToUnmuteAudio(n)));o.forEach(d=>{let{track:l,type:h}=d,p=Date.now();i.store.publish(l.getTrackId(),h===Se.LocalAudioTrack?"audio":"video",p)}),i.bindLocalTrackEvents(o);let s=yield St(i.sendConnection.send(o.map(d=>{let{track:l}=d;return l}),i.store.codec,i.store.audioCodec)),a=(yield St(s.next())).value,c=i.createGatewayPublishMessage(o,a);try{yield c}catch(d){throw s.throw(d),(d==null?void 0:d.code)===L.WS_ABORT&&o.forEach(l=>{let{track:h}=l;i.pendingLocalTracks.indexOf(h)===-1&&i.pendingLocalTracks.push(h)}),i.unbindLocalTrackEvents(o),d}yield St(s.next()),o.forEach(d=>{let{type:l}=d;i.statsCollector.addLocalStats(l)}),i.statsUploader.startUploadOutboundStats(),i.assignLocalTracks(o,a),o.forEach(d=>{let{track:l,type:h}=d,p=Date.now();i.store.publish(l.getTrackId(),h===Se.LocalAudioTrack?"audio":"video",void 0,p)}),i.startUploadUplinkState()}finally{r()}})()}async unpublish(n){if(!this.sendConnection||this.state!==ue.Connected)return void(n.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(r=>!z(n).call(n,r)));let e=this.filterTobeUnpublishedTracks(n);if(e.length===0)return;let t=e.find(r=>r[0]==="videoLowTrack");t&&t[1].track.close();let i=this.createGatewayUnpublishMessage(e);if(await this.sendConnection.stopSending(e.map(r=>{let[,{id:o}]=r;return o})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(r=>{let[o,{track:s}]=r;return{type:o,track:s}})),e.forEach(r=>{let[o]=r;this.statsCollector.removeLocalStats(o)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===ue.Connected)return t&&t[1].track.close(),i;n.forEach(r=>{let o=this.pendingLocalTracks.indexOf(r);o!==-1&&this.pendingLocalTracks.splice(o,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);let n=()=>{let e=[],t=[];Array.from(this.localTrackMap.entries()).forEach(i=>{let[r,{track:o,ssrcs:s}]=i,a={stream_type:Em(o,r),ssrcs:s};o._muted||!o._enabled?e.push(a):t.push(a)}),e.length>0&&e.forEach(i=>{yt(this,we.RequestMuteLocal,[i])}),t.length>0&&t.forEach(i=>{yt(this,we.RequestUnmuteLocal,[i])})};n(),this.uplinkStateUploadInterval=window.setInterval(()=>{n()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(n){return wo(function*(){throw new O(L.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(y.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await fr(this,we.RequestRePublish,this.pendingLocalTracks),this.emit(we.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new O(L.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(n,e,t,i){var r;if(!this.recvConnection)throw new O(L.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((r=this.remoteUserMap.get(n))!==null&&r!==void 0&&r.has(e))return;let{track:o,mid:s,transceiver:a}=await this.recvConnection.receive(e,[{ssrcId:t}],String(n.uid),i);e===ke.AUDIO?(n._audioTrack?n._audioTrack._updateOriginMediaStreamTrack(o):(n._audioTrack=new Wd(o,n.uid,n._uintid,this.store),y.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(n._audioTrack.getTrackId()))),a&&n._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(n,n._audioTrack)):(n._videoSSRC=t,n._videoTrack?n._videoTrack._updateOriginMediaStreamTrack(o):(n._videoTrack=new D_(o,n.uid,n._uintid,this.store),y.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(n._videoTrack.getTrackId()))),a&&n._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(n,n._videoTrack));let c=this.remoteUserMap.get(n);c?c.set(e,s):this.remoteUserMap.set(n,new Map([[e,s]])),this.statsCollector.addRemoteStats(n.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();let d=this.pendingRemoteTracks.findIndex(l=>{let{user:h,kind:p}=l;return h.uid===n.uid&&e===p});d!==-1&&(this.pendingRemoteTracks.splice(d,1),this.emit(we.MediaReconnectEnd,n.uid))}async mockSubscribe(n,e,t,i){if(!this.recvConnection)throw new O(L.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(e,[{ssrcId:t}],String(n.uid),i)}async unsubscribe(n,e,t){let i=this.pendingRemoteTracks.filter(o=>{let{user:s,kind:a}=o;return e!==void 0?s.uid===n.uid&&e===a:s.uid===n.uid});if(i.forEach(o=>{let s=this.pendingRemoteTracks.indexOf(o);this.pendingRemoteTracks.splice(s,1)}),this.recvConnection||t||i.forEach(o=>{let{kind:s}=o;var a;if(s===ke.AUDIO)(a=n._audioTrack)===null||a===void 0||a._destroy(),n._audioTrack=void 0;else if(s===ke.VIDEO){var c;(c=n._videoTrack)===null||c===void 0||c._destroy(),n._videoTrack=void 0}}),!this.recvConnection)return;let r=this.filterTobeUnSubscribedTracks(n,e);r.length!==0&&(await this.recvConnection.stopReceiving(r.map(o=>{let[,{id:s}]=o;return s})),this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),r.forEach(o=>{let[s,{kind:a}]=o;var c,d;if(a===ke.VIDEO&&s._videoSSRC&&((c=this.recvConnection)===null||c===void 0||c.setStatsRemoteVideoIsReady(s._videoSSRC,!1)),a===ke.VIDEO)this.unbindRemoteTrackEvents(s._videoTrack),t||((d=s._videoTrack)===null||d===void 0||d._destroy(),s._videoTrack=void 0);else if(a===ke.AUDIO){var l;this.unbindRemoteTrackEvents(s._audioTrack),!t&&((l=s._audioTrack)===null||l===void 0||l._destroy(),s._audioTrack=void 0)}}),r.forEach(o=>{let[,{kind:s}]=o;yt(this,we.RequestP2PMuteRemote,s)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);let n=()=>Array.from(this.remoteUserMap.entries()).forEach(e=>{let[,t]=e;[ke.VIDEO,ke.AUDIO].forEach(i=>{t.has(i)?yt(this,we.RequestP2PUnmuteRemote,i):yt(this,we.RequestP2PMuteRemote,i)})});n(),this.downlinkStatsUploadInterval=window.setInterval(()=>{n()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(n){throw new O(L.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(n){throw new O(L.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(n){throw new O(L.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(n){throw new O(L.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(n,e){if(!this.recvConnection)return;let t=this.remoteUserMap.get(n);if(!t)return void y.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(n.uid,"."));if(!t.get(e))return void y.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(n.uid," media type ").concat(e,"."));let i=e===ke.VIDEO?n._videoSSRC:n._audioSSRC;i!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(n,e){return this.unmuteRemoteNoLock(n,e)}async unmuteRemoteNoLock(n,e){if(!this.recvConnection)return;let t=this.remoteUserMap.get(n);if(!t)return void y.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(n.uid,"."));t.get(e)||y.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(n.uid," media type ").concat(e,"."))}getAllTracks(n){let e=this.localTrackMap.get(Se.LocalAudioTrack);if((e==null?void 0:e.track)instanceof rn){let t=e.track;return Array.from(this.localTrackMap.entries()).filter(i=>{let[r]=i;return r!==Se.LocalAudioTrack}).filter(i=>{let[r]=i;return!(n&&r===Se.LocalVideoLowTrack)}).map(i=>{let[,{track:r}]=i;return r}).concat(t.trackList)}return Array.from(this.localTrackMap.entries()).filter(t=>{let[i]=t;return!(n&&i===Se.LocalVideoLowTrack)}).map(t=>{let[,{track:i}]=t;return i})}reportPublishEvent(n,e,t,i,r){if(n){let s=this.localTrackMap.get(Se.LocalAudioTrack),a=i?this.localTrackMap.get(Se.LocalVideoLowTrack):this.localTrackMap.get(Se.LocalVideoTrack);_e.publish(this.store.sessionId,{eventElapse:qn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:n,ec:e,audioName:s==null?void 0:s.track.getTrackLabel(),videoName:a==null?void 0:a.track.getTrackLabel(),screenshare:(a==null?void 0:a.track._hints.indexOf(Re.SCREEN_TRACK))!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;t||(t=[]);let s=t.find(c=>c instanceof ri),a=i?(o=this.localTrackMap.get(Se.LocalVideoTrack))===null||o===void 0?void 0:o.track:t.find(c=>c instanceof Jt);_e.publish(this.store.sessionId,{eventElapse:qn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:n,ec:e,audioName:s==null?void 0:s.getTrackLabel(),videoName:a==null?void 0:a.getTrackLabel(),screenshare:(a==null?void 0:a._hints.indexOf(Re.SCREEN_TRACK))!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(n,e,t,i){let r=i===ke.VIDEO?t._videoSSRC:t._audioSSRC;r&&_e.subscribe(this.store.sessionId,{succ:n,ec:e,video:i===ke.VIDEO,audio:i===ke.AUDIO,peerid:t.uid,subscribeRequestid:i===ke.VIDEO?t._videoSSRC:t._audioSSRC,p2pid:this.store.p2pId,eventElapse:qn.measureFromSubscribeStart(this.store.clientId,r)})}reset(){y.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new mn("P2PChannel2-send-mutex",this.store.clientId),this.sendMutex=new mn("P2PChannel2-recv-mutex",this.store.clientId),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();let n=this.localTrackMap.get(Se.LocalAudioTrack);if((n==null?void 0:n.track)instanceof rn){if(n.track.trackList.length>0){let e=n.track;n.track.trackList.forEach(t=>{e.removeAudioTrack(t)})}n.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=ue.Disconnected}getStats(n){var e,t;return n?(t=this.recvConnection)===null||t===void 0?void 0:t.getStats():(e=this.sendConnection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(n){var e;return((e=this.recvConnection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(n))||!1}getLocalAudioVolume(){let n=this.localTrackMap.get(Se.LocalAudioTrack);if(n)return n.track.getVolumeLevel()}getLocalVideoSize(){let n=this.localTrackMap.get(Se.LocalVideoTrack);if(n)return{width:n.track.videoWidth||0,height:n.track.videoHeight||0}}getEncoderConfig(n){let e=this.localTrackMap.get(n);return e&&e.track instanceof Jt||e&&e.track instanceof ri?e.track._encoderConfig:void 0}getLocalMedia(n){return this.localTrackMap.get(n)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(n,e){if(!n)return this.remoteUserMap.size>0;let t=this.remoteUserMap.get(n);return!!t&&(!e||t.has(e))}async hasRemoteMediaWithLock(n,e){if(!n)return this.remoteUserMap.size>0;let t=this.remoteUserMap.get(n);return!!t&&(!e||t.has(e))}getRemoteMedia(n){var e;let t=Array.from(mo(e=this.remoteUserMap).call(e)).find(i=>i.uid===n);return t?{audioTrack:t.audioTrack,audioSSRC:t._audioSSRC,videoTrack:t.videoTrack,videoSSRC:t._videoSSRC}:{}}getAudioLevels(){let n=Array.from(this.remoteUserMap.entries()).map(t=>{let[i]=t;return{uid:i.uid,level:i.audioTrack?100*i.audioTrack._source.getAccurateVolumeLevel():0}}),e=this.localTrackMap.get(Se.LocalAudioTrack);return e&&n.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),n=Ka(n).call(n,(t,i)=>t.level-i.level),n}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(y.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=ue.Reconnecting,F("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(n=>{let[e]=n;var t;e._videoTrack&&e._videoTrack._player&&((t=e._videoTrack._player.getVideoElement())===null||t===void 0||t.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(n=>{var e;let[t,{track:i}]=n;switch(t){case Se.LocalVideoTrack:z(e=i._hints).call(e,Re.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case Se.LocalAudioTrack:i instanceof rn?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case Se.LocalVideoLowTrack:}}),this.emit(we.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(n=>{let[e,t]=n;Array.from(mo(t).call(t)).forEach(i=>{this.setPendingRemoteMedia(e,i)}),this.emit(we.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),y.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(n,e){for(let t of this.pendingRemoteTracks){let{user:i,kind:r}=t;if((n instanceof Bu?n.uid:n)===i.uid&&e===r)return!0}return!1}setPendingRemoteMedia(n,e){this.hasPendingRemoteMedia(n,e)||this.pendingRemoteTracks.push({user:n,kind:e})}async restartICE(n,e){let t,i;if(n===Ke.SEND_ONLY){if(!this.sendConnection)throw new O(L.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");t=await this.sendMutex.lock("From P2PChannel.restartICE"),i=this.sendConnection}else{if(!this.recvConnection)throw new O(L.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");t=await this.recvMutex.lock("From P2PChannel.restartICE"),i=this.recvConnection}try{if(e){let r=await i.restartICE(e);return i.isInRestartIce=!1,r}{let r=await i.restartICE();if(r){let o=await fr(this,we.RequestP2PRestartICE,{direction:Ke.RECEIVE_ONLY,iceParameter:r});await i.restartICE(o),i.isInRestartIce=!1}}}finally{t()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;let n=this.sendConnection.getStats(),e=this.localTrackMap.get(Se.LocalVideoTrack),t=this.localTrackMap.get(Se.LocalAudioTrack),i=n.videoSend.find(f=>{var m;return f.ssrc===(e==null||(m=e.ssrcs)===null||m===void 0?void 0:m[0].ssrcId)}),r=n.audioSend.find(f=>{var m;return f.ssrc===(t==null||(m=t.ssrcs)===null||m===void 0?void 0:m[0].ssrcId)});if(!i||!r)return 1;let o=Xt(this,we.NeedSignalRTT),s=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*n.sendPacketLossRate*.7/50+.3*d/1500,h=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,p=e==null?void 0:e.track;if(p&&p._encoderConfig&&p._hints.indexOf(Re.SCREEN_TRACK)===-1){let f=p._encoderConfig.bitrateMax,m=n.bitrate.actualEncoded;if(f&&m){let g=(1e3*f-m)/(1e3*f);return jU[g<.15?0:g<.3?1:g<.45?2:g<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;let n=this.recvConnection.getStats(),e=0;return Array.from(this.remoteUserMap.entries()).forEach(t=>{let[i]=t,r=i._audioSSRC,o=i._videoSSRC,s=n.audioRecv.find(m=>m.ssrc===r),a=n.videoRecv.find(m=>m.ssrc===o);if(!s&&!a)return void(e+=1);let c=Xt(this,we.NeedSignalRTT),d=n.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=s?s.jitterMs:void 0,p=n.recvPacketLossRate,f=.7*p*100/50+.3*l/1500;h&&(f=.6*p*100/50+.2*l/1500+.2*h/400),e+=f<.1?1:f<.17?2:f<.36?3:f<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(n){return new Z((e,t)=>{this.handleMuteLocalTrack(n,e,t)})}filterTobePublishedTracks(n,e,t){let i=[],r=ot(),o=this.getAllTracks();n=Iu(n=n.filter(c=>o.indexOf(c)===-1));let s=!1,a=!1;for(let c of n){if(c instanceof Jt&&(this.localTrackMap.has(Se.LocalVideoTrack)||s?new O(L.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:Se.LocalVideoTrack}),s=!0),e)){let d=this.getLowVideoTrack(c,t);i.push({track:d,type:Se.LocalVideoLowTrack})}if(c instanceof ri){let d=this.localTrackMap.get(Se.LocalAudioTrack);if(d){if(!(d.track instanceof rn))throw new O(L.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new O(L.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");d.track.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0)}else if(a){let l=i.find(h=>{let{type:p}=h;return p===Se.LocalAudioTrack});if(!(l.track instanceof rn))throw new O(L.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new O(L.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");l.track.addAudioTrack(c)}else{if(!r.webAudioMediaStreamDest||c instanceof rn||c._bypassWebAudio)i.push({track:c,type:Se.LocalAudioTrack});else{let l=new rn;l.addAudioTrack(c),i.push({track:l,type:Se.LocalAudioTrack})}a=!0}}}return i}filterTobeUnpublishedTracks(n){let e=[],t=this.getAllTracks();n=Iu(n=n.filter(i=>t.indexOf(i)!==-1));for(let i of n){if(i instanceof ri){let r=this.localTrackMap.get(Se.LocalAudioTrack);if(!r)continue;r.track instanceof rn?(r.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),r.track.trackList.length===0&&(e.push([Se.LocalAudioTrack,r]),r.track.close())):e.push([Se.LocalAudioTrack,r])}if(i instanceof Jt){let r=this.localTrackMap.get(Se.LocalVideoTrack);if(!r)continue;e.push([Se.LocalVideoTrack,r]);let o=this.localTrackMap.get(Se.LocalVideoLowTrack);o&&e.push([Se.LocalVideoLowTrack,o])}}return e}bindLocalTrackEvents(n){n.forEach(e=>{let{track:t,type:i}=e;switch(i){case Se.LocalVideoTrack:t.addListener(Ue.GET_STATS,this.handleGetLocalVideoStats),t.addListener(Ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Ue.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(Ue.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.addListener(Ue.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(Ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Se.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case Se.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(n,e){n instanceof rn?n.trackList.forEach(t=>{t.addListener(Ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Ue.GET_STATS,this.handleGetLocalAudioStats),t.addListener(Ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(n.addListener(Ue.GET_STATS,this.handleGetLocalAudioStats),n.addListener(Ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(Ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(Ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(Ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||n.addListener(Ue.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(n){n||(n=Array.from(this.localTrackMap.entries()).map(e=>{let[t,{track:i}]=e;return{track:i,type:t}})),n.forEach(e=>{let{track:t,type:i}=e;switch(i){case Se.LocalVideoTrack:t.off(Ue.GET_STATS,this.handleGetLocalVideoStats),t.off(Ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Ue.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(Ue.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.off(Ue.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(Ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Se.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case Se.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(n){n instanceof rn?n.trackList.forEach(e=>{e.off(Ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Ue.GET_STATS,this.handleGetLocalAudioStats),e.off(Ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(n.off(Ue.GET_STATS,this.handleGetLocalAudioStats),n.off(Ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(Ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(Ue.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(Ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(Ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(n,e){e instanceof D_&&e.addListener(Ue.GET_STATS,t=>{t(this.handleGetRemoteVideoStats(n))}),e instanceof Wd&&e.addListener(Ue.GET_STATS,t=>{t(this.handleGetRemoteAudioStats(n))})}unbindRemoteTrackEvents(n){n&&n.removeAllListeners(Ue.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(n=>{let[e,t]=n;t.has(ke.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),t.has(ke.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(n,e){return n.map((t,i)=>{var r;let o,{track:s,type:a}=t;switch(a){case Se.LocalAudioTrack:o=_i.Audio;break;case Se.LocalVideoTrack:o=z(r=s._hints).call(r,Re.SCREEN_TRACK)?_i.Screen:_i.High;break;case Se.LocalVideoLowTrack:o=_i.Low}return{kind:a===Se.LocalAudioTrack?ke.AUDIO:ke.VIDEO,stream_type:o,mid:e[i].id,ssrcs:e[i].localSSRC,isMuted:s.muted||!s.enabled}})}createGatewayUnpublishMessage(n){return n.map(e=>{var t;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case Se.LocalVideoTrack:i=z(t=o._hints).call(t,Re.SCREEN_TRACK)?_i.Screen:_i.High;break;case Se.LocalAudioTrack:i=_i.Audio;break;case Se.LocalVideoLowTrack:i=_i.Low}return{stream_type:i,ssrcs:s,mid:a}})}assignLocalTracks(n,e){n.forEach((t,i)=>{let{track:r,type:o}=t;this.localTrackMap.set(o,{track:r,id:e[i].id,ssrcs:e[i].localSSRC})})}withdrawLocalTracks(n){n.forEach(e=>{let[t]=e;this.localTrackMap.delete(t)})}bindConnectionEvents(n){n.onConnectionStateChange=async e=>{var t;y.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(n.name,".onConnectionStateChange(").concat(e,")")),this.emit(we.PeerConnectionStateChange,e),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(n.isInRestartIce=!1),z(t=this._restartStates).call(t,e)&&!n.isInRestartIce&&(e==="disconnected"&&await fn(800),n.iceConnectionState!=="disconnected"&&n.iceConnectionState!=="failed"||this.handleDisconnect(n.direction))},n.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),y.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),_e.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:ct.TRACER}).onSuccess(),this.emit(we.IceConnectionStateChange,e)},n.onICETransportStateChange=e=>{y.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},n.onDTLSTransportStateChange=e=>{y.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},n.onDTLSTransportError=e=>{y.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},n.onFirstAudioDecoded=e=>{var t;let i=Array.from(mo(t=this.remoteUserMap).call(t)).find(o=>o._audioSSRC===e);var r;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),(r=i.audioTrack)===null||r===void 0||r.emit(Wo.FIRST_FRAME_DECODED),_e.firstRemoteFrame(this.store.sessionId,en.FIRST_AUDIO_DECODE,Dt.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:qn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},n.onFirstAudioReceived=e=>{var t;let i=Array.from(mo(t=this.remoteUserMap).call(t)).find(r=>r._audioSSRC===e);i&&_e.firstRemoteFrame(this.store.sessionId,en.FIRST_AUDIO_RECEIVED,Dt.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:qn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},n.onFirstVideoDecoded=(e,t,i)=>{this.reportVideoFirstFrameDecoded(e,t,i)},n.onFirstVideoReceived=e=>{var t;let i=Array.from(mo(t=this.remoteUserMap).call(t)).find(r=>r._videoSSRC===e);i&&_e.firstRemoteFrame(this.store.sessionId,en.FIRST_VIDEO_RECEIVED,Dt.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:qn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},n.onSelectedLocalCandidateChanged=(e,t)=>{let i=e.candidateType==="relay",r=t.candidateType==="relay";t.candidateType!=="unknown"&&i===r||this.emit(we.ConnectionTypeChange,i),y.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(bl(t))," -> ").concat(JSON.stringify(bl(e)),")"))},n.onSelectedRemoteCandidateChanged=(e,t)=>{y.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(bl(t))," -> ").concat(JSON.stringify(bl(e)),")"))},n.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},n.onLocalCandidate=e=>{this.emit(we.LocalCandidate,{candidate:e,direction:n.direction})}}unbindConnectionEvents(n){n.onConnectionStateChange=void 0,n.onICEConnectionStateChange=void 0,n.onICETransportStateChange=void 0,n.onDTLSTransportStateChange=void 0,n.onDTLSTransportError=void 0,n.onFirstAudioDecoded=void 0,n.onFirstAudioReceived=void 0,n.onFirstVideoDecoded=void 0,n.onFirstVideoReceived=void 0,n.onSelectedLocalCandidateChanged=void 0,n.onSelectedRemoteCandidateChanged=void 0,n.onFirstVideoDecodedTimeout=void 0,n.onLocalCandidate=void 0}async handleDisconnect(n){let e=n===Ke.SEND_ONLY?this.sendConnection:this.recvConnection;e&&!e.isInRestartIce&&(e.isInRestartIce=!0,y.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(e.name,"] start use restartICE")),n===Ke.SEND_ONLY?this.restartICE(n):fr(this,we.RequestP2PRestartICE,{direction:Ke.SEND_ONLY}))}filterTobeMutedTracks(n){let e=[];if(this.getAllTracks().indexOf(n)===-1)return e;let t=this.localTrackMap.get(Se.LocalAudioTrack);if(n instanceof ri&&(t==null?void 0:t.track)instanceof rn)return t.track.isActive||e.push([Se.LocalAudioTrack,t]),e;let i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return n===o});if(i&&(e.push(i),i[0]===Se.LocalVideoTrack)){let r=this.localTrackMap.get(Se.LocalVideoLowTrack);r&&e.push([Se.LocalVideoLowTrack,r])}return e}filterTobeUnmutedTracks(n){let e=[],t=this.localTrackMap.get(Se.LocalAudioTrack);if(n instanceof ri&&(t==null?void 0:t.track)instanceof rn)return t.track.isActive&&e.push([Se.LocalAudioTrack,t]),e;let i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return n===o});if(i)if(i[0]===Se.LocalVideoTrack){e.push(i);let r=this.localTrackMap.get(Se.LocalVideoLowTrack);r&&e.push([Se.LocalVideoLowTrack,r])}else e.push(i);return e}createMuteMessage(n){return n.map(e=>{var t;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case Se.LocalAudioTrack:i=_i.Audio;break;case Se.LocalVideoTrack:i=z(t=o._hints).call(t,Re.SCREEN_TRACK)?_i.Screen:_i.High;break;case Se.LocalVideoLowTrack:i=_i.Low}return{stream_type:i,ssrcs:s,mid:a}})}createUnmuteMessage(n){return n.map(e=>{var t;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case Se.LocalAudioTrack:i=_i.Audio;break;case Se.LocalVideoTrack:i=z(t=o._hints).call(t,Re.SCREEN_TRACK)?_i.Screen:_i.High;break;case Se.LocalVideoLowTrack:i=_i.Low}return{stream_type:i,ssrcs:s,mid:a}})}filterTobeUnSubscribedTracks(n,e){let t=[],i=this.remoteUserMap.get(n);if(!i)return t;if(e){let r=i.get(e);if(!r)return t;t.push([n,{kind:e,id:r}])}else Array.from(i.entries()).forEach(r=>{let[o,s]=r;t.push([n,{kind:o,id:s}])});return t}createUnsubscribeMessage(n){let e=[];return n.forEach(t=>{let[i,{kind:r,id:o}]=t;switch(r){case ke.VIDEO:return void(i._videoSSRC&&e.push({stream_type:ke.VIDEO,ssrcId:i._videoSSRC}));case ke.AUDIO:return void(i._audioSSRC&&e.push({stream_type:ke.AUDIO,ssrcId:i._audioSSRC}))}}),e}withdrawRemoteTracks(n){n.forEach(e=>{let[t,{kind:i}]=e,r=this.remoteUserMap.get(t);r&&(r.delete(i),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(t))})}async updateBitrateLimit(n){let e=this.localTrackMap.get(Se.LocalVideoTrack),t=this.localTrackMap.get(Se.LocalVideoLowTrack);e&&(await e.track.setBitrateLimit(n.uplink),await new Z((i,r)=>{this.handleUpdateVideoEncoder(e.track,i,r,!0)})),t&&n.low_stream_uplink&&(await t.track.setBitrateLimit({max_bitrate:n.low_stream_uplink.bitrate,min_bitrate:n.low_stream_uplink.bitrate||0}),await new Z((i,r)=>{this.handleUpdateVideoEncoder(t.track,i,r,!0)}))}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){let n=this.sendConnection.peerConnectionState,e=this.recvConnection.peerConnectionState;return n!=="connected"&&e!=="connected"}return!0}async tryToUnmuteAudio(n){for(let e=0;e<n.length;e++)if(n[e]instanceof ri){let t=this.filterTobeUnmutedTracks(n[e]);if(t.length===0)continue;let i=this.createUnmuteMessage(t);return void await yt(this,we.RequestUnmuteLocal,i)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=n=>this.getStats(n),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(n=>{let[,{ssrcs:e}]=n;return!!e}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=n=>{var e;return!((e=this.recvConnection)===null||e===void 0||!e.getRemoteVideoIsReady(n))},this.statsUploader.requestUpload=(n,e)=>this.emit(we.RequestUpload,n,e),this.statsUploader.requestUploadStats=n=>this.emit(we.RequestUploadStats,n),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await fn(yr(this.dtlsFailedCount,mr)),this.emit(we.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(Se.LocalVideoTrack)||this.pendingLocalTracks.some(n=>n instanceof Jt)}throwIfTrackTypeNotMatch(n){if(n.filter(e=>e instanceof Jt).length>1)throw new O(L.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(n.filter(e=>e instanceof ri).length>1&&(n.some(e=>e instanceof ri&&e._bypassWebAudio)||!ot().webAudioMediaStreamDest))throw new O(L.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(let e of n){if(e instanceof Jt&&this.pendingLocalTracks.some(t=>t instanceof Jt))throw new O(L.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof ri&&this.pendingLocalTracks.some(t=>t instanceof ri)&&(!ot().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(t=>t instanceof ri&&t._bypassWebAudio)))throw new O(L.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(n,e){let t=!F("DISABLE_DUAL_STREAM_USE_ENCODING")&&ot().supportDualStreamEncoding,i=yR(yR({},{width:160,height:120,framerate:15,bitrate:50}),e),r;r=t?n._mediaStreamTrack.clone():Uo(n,i);let o=vt(8,"track-low-"),s=new Jt(r,yR(yR({},t&&{scaleResolutionDownBy:sC(i,n)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,o);return s.on(b_.TRANSCEIVER_UPDATED,a=>{n._updateRtpTransceiver(a,ui.LOW_STREAM)}),s._hints.push(Re.LOW_STREAM),n.addListener(Ue.NEED_CLOSE,()=>{s.close()}),s}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(n,e,t,i){var r;let o=Array.from(mo(r=this.remoteUserMap).call(r)).find(s=>s._videoSSRC===n);if(o){i||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());let s=this.store.keyMetrics,a=s.subscribe.find(c=>c.userId===o.uid&&c.type==="video");_e.firstRemoteVideoDecode(this.store.sessionId,en.FIRST_VIDEO_DECODE,Dt.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:t,subscribeElapse:qn.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:(a==null?void 0:a.subscribeEnd)||0,subscriberStart:(a==null?void 0:a.subscribeStart)||0,videoAddNotify:(a==null?void 0:a.streamAdded)||0,state:i?1:0})}}async remoteMediaSsrcChanged(n,e,t){if(!this.recvConnection)return!1;let i=this.remoteUserMap.get(n);if(!i)return!1;let r=i.get(e);if(!r)return!1;let o=await this.recvConnection.getRemoteSSRC(r);return o!==void 0&&o!==t}isPreSubScribe(n){return!1}async publishDataChannel(n){throw new O(L.NOT_SUPPORTED)}async unpublishDataChannel(n){throw new O(L.NOT_SUPPORTED)}async subscribeDataChannel(n,e){throw new O(L.NOT_SUPPORTED)}async unsubscribeDataChannel(n,e){throw new O(L.NOT_SUPPORTED)}hasPendingRemoteDataChannel(n,e){throw new O(L.NOT_SUPPORTED)}setPendingRemoteDataChannel(n,e){throw new O(L.NOT_SUPPORTED)}async preConnect(n){throw new O(L.NOT_SUPPORTED)}getEstablishParams(){throw new O(L.NOT_SUPPORTED)}async reSubscribe(n){throw new O(L.NOT_SUPPORTED)}reportVideoFirstFrameRender(n){}async updateVideoStreamParameter(n,e){throw new O(L.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(n=>{let[e,{track:t}]=n;e===Se.LocalVideoLowTrack?t._updateRtpTransceiver(void 0,ui.LOW_STREAM):t._updateRtpTransceiver(void 0)})}},Oe(er.prototype,"p2pConnect",[Xc],Object.getOwnPropertyDescriptor(er.prototype,"p2pConnect"),er.prototype),Oe(er.prototype,"unpublish",[t1],Object.getOwnPropertyDescriptor(er.prototype,"unpublish"),er.prototype),Oe(er.prototype,"unpublishLowStream",[i1],Object.getOwnPropertyDescriptor(er.prototype,"unpublishLowStream"),er.prototype),Oe(er.prototype,"subscribe",[r1],Object.getOwnPropertyDescriptor(er.prototype,"subscribe"),er.prototype),Oe(er.prototype,"mockSubscribe",[n1],Object.getOwnPropertyDescriptor(er.prototype,"mockSubscribe"),er.prototype),Oe(er.prototype,"unsubscribe",[o1],Object.getOwnPropertyDescriptor(er.prototype,"unsubscribe"),er.prototype),Oe(er.prototype,"muteRemote",[s1],Object.getOwnPropertyDescriptor(er.prototype,"muteRemote"),er.prototype),Oe(er.prototype,"unmuteRemote",[a1],Object.getOwnPropertyDescriptor(er.prototype,"unmuteRemote"),er.prototype),Oe(er.prototype,"hasRemoteMediaWithLock",[c1],Object.getOwnPropertyDescriptor(er.prototype,"hasRemoteMediaWithLock"),er.prototype),Oe(er.prototype,"disconnectForReconnect",[d1],Object.getOwnPropertyDescriptor(er.prototype,"disconnectForReconnect"),er.prototype),Oe(er.prototype,"remoteMediaSsrcChanged",[l1],Object.getOwnPropertyDescriptor(er.prototype,"remoteMediaSsrcChanged"),er.prototype),er);function nl(n){return function(e,t,i){let r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];switch(n){case to.SEND_ONLY:{let c=await this.sendMutex.lock("From P2PChannel2.".concat(t));try{return await r.apply(this,s)}finally{c()}}case to.RECEIVE_ONLY:{let c=await this.recvMutex.lock("From P2PChannel2.".concat(t));try{return await r.apply(this,s)}finally{c()}}default:{let c=await this.sendMutex.lock("From P2PChannel2.".concat(t)),d=await this.recvMutex.lock("From P2PChannel2.".concat(t));try{return await r.apply(this,s)}finally{c(),d()}}}},i}}class ms extends Ki{constructor(e,t){super(),U(this,"signal",void 0),U(this,"token",void 0),U(this,"tokenTimeout",void 0),U(this,"tokenInterval",void 0),U(this,"_sequence",0),U(this,"userMap",new Map),U(this,"encoder",new TextEncoder),this.signal=e,this.token=t;let i=()=>{this.signal.connectionState===ye.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(i,1e3):this.tokenInterval=window.setTimeout(i,3*F("P2P_TOKEN_INTERVAL"))};i()}async send(e,t,i,r,o){var s;if(this.userMap.size===0)return;let a=Array.from(Vr(s=this.userMap).call(s))[0].token;typeof t!="string"&&(t=JSON.stringify(t)),r=r??vt(6,""),o=o??this._sequence++;let c={_id:r,_type:e,_seq:o,_message:t,token:"".concat(this.token,"_").concat(a)};F("SHOW_P2P_LOG")&&y.debug("send message",c,"noNeedResponse : ".concat(i)),this.splitMessage(JSON.stringify(c)).forEach(l=>{this.signal.request(le.DATA_STREAM,{payload:_a(this.encoder.encode(l))})});let d=new Z((l,h)=>{let p=window.setTimeout(()=>{this.off("res-@".concat(r,"_ack"),f),this.off("res-@".concat(r),g),this.off(cr.ABORT,m),y.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(r)),this.userMap.size===0?h(new O(L.INVALID_REMOTE_USER)):h(new O(L.TIMEOUT))},F("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),f=()=>{p&&window.clearTimeout(p),this.off(cr.ABORT,m),i&&l()},m=()=>{p&&window.clearTimeout(p),this.off("res-@".concat(r,"_ack"),f),this.off("res-@".concat(r),g),h(new O(L.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(r)))};this.once(cr.ABORT,m),this.once("res-@".concat(r,"_ack"),f);let g=(T,C)=>{S=!0,p&&window.clearTimeout(p),this.off("res-@".concat(r,"_ack"),f),this.off(cr.ABORT,m),T==="success"?l(C):h(new O(L.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(r)))},S=!1;i||(this.once("res-@".concat(r),g),fn(F("SIGNAL_REQUEST_TIMEOUT")).then(()=>{S||y.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(r,", ").concat(c))}))});try{return await d}catch(l){if(l.code===L.TIMEOUT)return await this.send(e,t,i,r,o);throw l}}onMessage(e){var t;let{_uid:i}=e,r,o=this.userMap.get(i);if(o)r=o.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==ar.CHECK)return;let{token:d}=e;r=new Map,o={uid:i,isStart:!0,token:d,splitMessageMap:r,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(i,o),this.signal.emit(it.ON_USER_ONLINE,{uid:i}),this.handleUserOnline()}if("id"in e&&"total"in e){var s;let{id:d,total:l}=e,h=(s=r.get(d))!==null&&s!==void 0?s:[];if(h.push(e),r.has(d)||r.set(d,h),h.length!==l)return;{let p=Ka(h).call(h,(f,m)=>f.index-m.index).map(f=>f.payload).join("");r.delete(d),(e=JSON.parse(p))._uid=i}}let{_type:a,token:c}=e;if(z(t=[ar.ACK,ar.CHECK]).call(t,a))return a===ar.CHECK&&this.handleCheckToken(o,c),void this.receiveMessage(e);c==="".concat(o.token,"_").concat(this.token)?this.handleReceivedMessage(e):y.debug('Receive unexpected message", '.concat(c,", cur_token: ").concat(o.token,"_").concat(this.token),e)}check(){let e={_id:vt(6,""),token:this.token,_type:ar.CHECK};F("SHOW_P2P_LOG")&&y.debug("send message",e),this.signal.request(le.DATA_STREAM,{payload:_a(this.encoder.encode(JSON.stringify(e)))})}ack(e){let t={_id:e,_type:ar.ACK,token:this.token};F("SHOW_P2P_LOG")&&y.debug("send message",t),this.signal.request(le.DATA_STREAM,{payload:_a(this.encoder.encode(JSON.stringify(t)))})}response(e,t,i){this.send(ar.RESPONSE,JSON.stringify({success:!i,message:t}),!0,e)}handleReceivedMessage(e){let t=()=>{this.userMap.forEach(d=>{let{receivedMessagesMap:l,nextExpectedSequenceNumber:h}=d;for(;l.has(h);){let p=l.get(h);l.delete(h),this.receiveMessage(p),d.nextExpectedSequenceNumber++}})};if(!e)return void t();let{_uid:i,_seq:r}=e,o=this.userMap.get(i),{receivedMessagesMap:s,isStart:a,nextExpectedSequenceNumber:c}=o;if(r<c)return this.ack(e._id),void y.debug("[external-signal] receive old message, seq: ".concat(r,", ").concat(e._message));s.set(r,e),a&&r===c&&(this.receiveMessage(e),s.delete(c),o.nextExpectedSequenceNumber++,t())}receiveMessage(e){let{_id:t,_type:i,_message:r,_uid:o}=e;if(F("SHOW_P2P_LOG")&&y.debug("receive message",e),t){let s;switch(e._type!==ar.ACK&&(r&&(s=JSON.parse(r)),this.ack(e._id)),e._type){case ar.CANDIDATE:case ar.CONTROL:this.signal.emit(i,s,o);break;case ar.PUBLISH:case ar.UNPUBLISH:case ar.RESTART_ICE:case ar.CALL:s.uid=o,fr(this.signal,i,s).then(a=>{this.response(e._id,a)}).catch(()=>{this.response(e._id,void 0,!0)});break;case ar.ACK:this.getListeners("res-@".concat(t,"_ack")).length>0&&this.emit("res-@".concat(t,"_ack"));break;case ar.RESPONSE:{let{success:a,message:c}=s;this.emit("res-@".concat(t),a?"success":"failed",c);break}}}}splitMessage(e){if(e.length<ms.MAX_MESSAGE_SIZE)return[e];let t=[],{remoteToken:i}=JSON.parse(e),r=vt(6,""),o=0,s=800,a=Math.ceil(e.length/s);for(;e.length>0;){o++;let c={id:r,index:o,total:a,payload:e.slice(0,s),token:"".concat(this.token,"_").concat(i)};JSON.stringify(c).length>ms.MAX_MESSAGE_SIZE?s-=50:(t.push(c),e=e.slice(s))}return t.map(c=>JSON.stringify(c))}handleCheckToken(e,t){return e.token!==t?(y.debug("token changed, from ".concat(e.token," to ").concat(t)),this.reset(e.uid,t),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{y.debug("token timeout, ".concat(t)),this.reset(e.uid)},F("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){let e=await fr(this.signal,ar.CALL,void 0),t=await this.send(ar.CALL,e);this.signal.emit(Ee.P2P_CONNECTION,t,!0)}async reset(e,t){let i=this.userMap.get(e);i&&(this.emit(cr.ABORT),this.signal.emit(it.ON_USER_OFFLINE,{uid:i.uid,reason:Bh.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),t||(y.debug("change local token from ".concat(t," to ").concat(t)),this.token=vt(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(cr.ABORT)}}U(ms,"MAX_SIZE",1),U(ms,"MAX_MESSAGE_SIZE",1024);class tf extends Ki{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===ye.CONNECTED?this.emit(Ee.WS_CONNECTED):e===ye.RECONNECTING?this.emit(Ee.WS_RECONNECTING,this._websocketReconnectReason):e===ye.CLOSED&&this.emit(Ee.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),U(this,"__name__","P2PSignal"),U(this,"_disconnectedReason",void 0),U(this,"_websocketReconnectReason",void 0),U(this,"_connectionState",ye.CLOSED),U(this,"reconnectToken",void 0),U(this,"p2pToken",void 0),U(this,"websocket",void 0),U(this,"openConnectionTime",void 0),U(this,"clientId",void 0),U(this,"lastMsgTime",Date.now()),U(this,"uploadCache",[]),U(this,"uploadCacheInterval",void 0),U(this,"rttRolling",new Lf(5)),U(this,"pingpongTimer",void 0),U(this,"pingpongTimeoutCount",0),U(this,"joinResponse",void 0),U(this,"multiIpOption",void 0),U(this,"initError",void 0),U(this,"spec",void 0),U(this,"store",void 0),U(this,"_external_signal",void 0),U(this,"onWebsocketMessage",i=>{if(i.data instanceof ArrayBuffer)return void this.emit(Ee.ON_BINARY_DATA,i.data);let r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){let o="res-@".concat(r._id);this.emit(o,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){switch(r._type){case it.ON_DATA_STREAM:return void this.handleDataStream(r._message);case it.MUTE_AUDIO:case it.MUTE_VIDEO:case it.ON_P2P_LOST:case it.ON_USER_ONLINE:return;case it.ON_USER_OFFLINE:let{uid:o}=r._message;return y.debug("[".concat(this.clientId,"] user-offline uid: ").concat(o)),void this._external_signal.reset(o)}if(this.emit(r._type,r._message),r._type===it.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===it.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(Gt.UID_BANNED);break;case 15:this.close(Gt.IP_BANNED);break;case 16:this.close(Gt.CHANNEL_BANNED)}if(r._type===it.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case Fe.ERR_LICENSE_MISSING:this.close(Gt.LICENSE_MISSING);break;case Fe.ERR_LICENSE_EXPIRED:this.close(Gt.LICENSE_EXPIRED);break;case Fe.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Gt.LICENSE_MINUTES_EXCEEDED);break;case Fe.ERR_LICENSE_PERIOD_INVALID:this.close(Gt.LICENSE_PERIOD_INVALID);break;case Fe.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Gt.LICENSE_MULTIPLE_SDK_SERVICE);break;case Fe.ERR_LICENSE_ILLEGAL:this.close(Gt.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new oC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,F("JOIN_GATEWAY_USE_DUAL_DOMAIN"),F("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===ye.CONNECTED&&this.reconnect("retry",Cn.OFFLINE)}),this.p2pToken=vt(6,""),this._external_signal=new ms(this,this.p2pToken)}async request(e,t,i,r){let o=vt(6,""),s={_id:o,_type:e,_message:t},a=this.websocket.connectionID,c=()=>new Z((m,g)=>{if(this.connectionState===ye.CONNECTED)return m();let S=()=>{this.off(Ee.WS_CLOSED,T),m()},T=()=>{this.off(Ee.WS_CONNECTED,S),g(new O(L.WS_ABORT))};this.once(Ee.WS_CONNECTED,S),this.once(Ee.WS_CLOSED,T)});if(this.connectionState!==ye.CONNECTING&&this.connectionState!==ye.RECONNECTING||e===le.JOIN||e===le.REJOIN||await c(),this.websocket.sendMessage(s,!0),r)return;let d=new Z((m,g)=>{let S=!1,T=(b,D)=>{S=!0,m({isSuccess:b==="success",message:D||{}}),this.off(Ee.WS_CLOSED,C),this.off(Ee.WS_RECONNECTING,C),this.emit(Ee.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(o),T);let C=()=>{g(new O(L.WS_ABORT,"type: ".concat(e))),this.off(Ee.WS_CLOSED,C),this.off(Ee.WS_RECONNECTING,C),this.off("res-@".concat(o),T)};this.once(Ee.WS_CLOSED,C),this.once(Ee.WS_RECONNECTING,C),fn(F("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||S||(y.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(Ee.REQUEST_TIMEOUT,e,t))})}),l=null;try{l=await d}catch(m){if(this.connectionState===ye.CLOSED||e===le.LEAVE)throw new O(L.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?m.throw():e===le.JOIN||e===le.REJOIN?null:(await c(),await this.request(e,t))}if(l.isSuccess)return l.message;let h=Number(l.message.error_code||l.message.code),p=k_(h),f=new O(L.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(l.message.error_str),{code:h,data:l.message,desc:p.desc});return p.action==="success"?l.message:(y.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(h,", message: ").concat(p.desc,", action: ").concat(p.action)),h===Fe.ERR_TOO_MANY_BROADCASTERS?((e===le.JOIN||e===le.REJOIN)&&(this.initError=f,this.close()),f.throw()):p.action==="failed"?f.throw():p.action==="quit"?(this.initError=f,this.close(),f.throw()):(h===Fe.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,y.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Cn.MULTI_IP)):this.reconnect(p.action,Cn.SERVER_ERROR),e===le.JOIN||e===le.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new Z(i=>{let r=o=>{(!t||t(o))&&(this.off(e,r),i(o))};this.on(e,r)})}uploadWRTCStats(e){if(!this.store.sessionId)return void y.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let t={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(Be.WRTC_STATS,t)}upload(e,t){let i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch{let r=F("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>r&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==ye.CONNECTED)return;let o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},F("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){let i={_type:e,_message:t};this.websocket.sendMessage(i)}async sendExtensionMessage(e,t,i){return await this._external_signal.send(e,t,i)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Z((t,i)=>{this.once(Ee.WS_CONNECTED,()=>t(this.joinResponse)),this.once(Ee.WS_CLOSED,()=>i(this.initError||new O(L.WS_ABORT))),this.connectionState=ye.CONNECTING,this.websocket.init(e).catch(i)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||Gt.LEAVE,this.connectionState=ye.CLOSED,y.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=vt(6,""),this._external_signal.clear(),this._external_signal=new ms(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(Ee.ABORT_P2P_EXECUTION);let e=await fr(this,Ee.REQUEST_JOIN_INFO),t=await this.request(le.JOIN,e);if(!t)return this.emit(Ee.REPORT_JOIN_GATEWAY,L.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(Ee.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=ye.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}async downgradeCodec(e){return!1}handleDataStream(e){try{var t;let i=pa(e.payload),r=new TextDecoder().decode(i),o=JSON.parse(r);"total"in o&&"id"in o||z(t=Object.values(ar)).call(t,o._type)?(o._uid=e.uid,this._external_signal.onMessage(o)):this.emit(it.ON_DATA_STREAM,e)}catch{this.emit(it.ON_DATA_STREAM,e)}}handleNotification(e){y.debug("[".concat(this.clientId,"] receive notification: "),e);let t=k_(e.code);if(t.action!=="success"){if(t.action!=="failed")return t.action==="quit"?e.code===Fe.ERR_REPEAT_JOIN_CHANNEL&&F("IGNORE_UID_CHECK")?void this.close(Gt.UID_CONFLICT):(t.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Gt.UID_BANNED),void this.close()):void this.reconnect(t.action,Cn.SERVER_ERROR);y.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let e=F("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(y.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>F("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Cn.TIMEOUT):this.request(le.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let i=Date.now()-t;this.rttRolling.add(i),F("REPORT_STATS")&&this.send(le.PING_BACK,{pingpongElapse:i})}).catch(i=>{})}handleWebsocketEvents(){this.websocket.on(Je.RECONNECT_CREATE_CONNECTION,e=>{this.emit(Ee.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(Je.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Je.CLOSED,()=>{this.connectionState=ye.CLOSED}),this.websocket.on(Je.FAILED,()=>{this._disconnectedReason=Gt.NETWORK_ERROR,this.connectionState=ye.CLOSED}),this.websocket.on(Je.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===ye.CONNECTED?this.connectionState=ye.RECONNECTING:this.connectionState=ye.CONNECTING}),this.websocket.on(Je.WILL_RECONNECT,(e,t,i)=>{e!=="retry"?(y.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0):y.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),i(e)}),this.websocket.on(Je.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(e=>{if(this.emit(Ee.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof O&&e.code===L.UNEXPECTED_RESPONSE&&e.data.code===Fe.ERR_NO_AUTHORIZED)return y.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Cn.SERVER_ERROR);y.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Cn.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(Je.REQUEST_NEW_URLS,(e,t)=>{fr(this,Ee.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)}),this.websocket.on(Je.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(it.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}let I9={name:"P2PChannel",create:function(n){let{store:e,statsCollector:t}=n;return new fy(e,t)},createSubmodule:function(n){let{store:e,spec:t}=n;return new tf(t,e)}};function rx(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function u1(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?rx(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):rx(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}class nx{constructor(e){U(this,"sessionDesc",void 0),U(this,"localCapabilities",void 0),U(this,"rtpCapabilities",void 0),U(this,"candidates",void 0),U(this,"_originCandidates",void 0),U(this,"iceParameters",void 0),U(this,"dtlsParameters",void 0),U(this,"setup",void 0),U(this,"currentMidIndex",void 0),U(this,"cname",void 0),e=Li(e);let{iceParameters:t,dtlsParameters:i,candidates:r,rtpCapabilities:o,setup:s,localCapabilities:a,sdkCodec:c,cname:d}=e,l=Oo(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=o,this.candidates=r,this._originCandidates=Li(r),this.iceParameters=t,this.dtlsParameters=i,this.setup=s,this.localCapabilities=a,this.cname=d;for(let h=0;h<l.mediaDescriptions.length;h++){let p=l.mediaDescriptions[h];if(p.attributes.iceUfrag=t.iceUfrag,p.attributes.icePwd=t.icePwd,p.attributes.fingerprints=i.fingerprints,p.attributes.candidates=r,p.attributes.setup=s,p.media.mediaType==="video"){p.media.fmts=o.videoCodecs.map(g=>g.payloadType.toString(10));let f=o.videoCodecs.filter(g=>{var S,T;return(S=g.rtpMap)===null||S===void 0?void 0:z(T=S.encodingName.toLowerCase()).call(T,c)}),m=o.videoCodecs.filter(g=>!z(f).call(f,g));p.attributes.payloads=[...f,...m],p.attributes.extmaps=o.videoExtensions}p.media.mediaType==="audio"&&(p.media.fmts=o.audioCodecs.map(f=>f.payloadType.toString(10)),p.attributes.payloads=o.audioCodecs,p.attributes.extmaps=o.audioExtensions),l.mediaDescriptions[h]=this.mungMediaDesc(p)}this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return sn(this.sessionDesc)}send(e,t,i){let{ssrcs:r,ssrcGroups:o}=am(t,this.cname),s=this.sessionDesc.mediaDescriptions.find(d=>e===ke.VIDEO?d.media.mediaType==="video":d.media.mediaType==="audio"),a=r[0].attributes.label,c=r[0].attributes.mslabel;return s.attributes.ssrcs=s.attributes.ssrcs.concat(r),s.attributes.ssrcGroups=s.attributes.ssrcGroups.concat(o),{id:a,mslabel:c}}batchSend(e){return e.map(t=>{let{kind:i,ssrcMsg:r}=t;return this.send(i,r,void 0)})}stopSending(e){this.sessionDesc.mediaDescriptions.forEach(t=>{let i=[],r=[],o=[];t.attributes.ssrcs.forEach(s=>{z(e).call(e,s.attributes.label||"")?o.push(s):i.push(s)}),t.attributes.ssrcGroups.forEach(s=>{var a;z(a=o.map(c=>c.ssrcId)).call(a,s.ssrcIds[0])||r.push(s)}),t.attributes.ssrcs=i,t.attributes.ssrcGroups=r})}mute(e){let t=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===e);if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){let t=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===e);if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}receive(e,t,i){e.forEach((r,o)=>{let s=r._mediaStreamTrack,a=this.sessionDesc.mediaDescriptions.findIndex(d=>d.attributes.mid===s.kind),c=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[a],r);this.sessionDesc.mediaDescriptions[a]=c})}stopReceiving(e){}updateCandidates(e){let t=this._originCandidates.filter(r=>r.transport==="udp"),i=[];if(t.forEach(r=>{i.push(u1(u1({},r),{},{foundation:"tcpcandidate",priority:Number(r.priority)-1+"",transport:"tcp",port:Number(r.port)+90+""}))}),t.length!==0){switch(e){case be.TCP_RELAY:this.candidates=i;break;case be.UDP_TCP_RELAY:case be.RELAY:this.candidates=[...t,...i];break;default:this.candidates=t}for(let r of this.sessionDesc.mediaDescriptions)r.attributes.candidates=this.candidates}}restartICE(e){e=Li(e),this.iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd})}predictReceivingMids(e){let t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}mungRecvMediaDsec(e,t){let i=Li(e);return Kd(i,t),LT(i,t),i}updateRecvMedia(e,t){let i=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===e);if(i!==-1){let r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=r}}bumpMid(e){this.currentMidIndex+=e}updateTrackLabel(e,t,i){let r=this.sessionDesc.mediaDescriptions.find(s=>e===ke.VIDEO?s.attributes.mid==="video":s.attributes.mid==="audio");if(r){let s=r.attributes.ssrcs.find(a=>a.attributes.label===t);var o;s&&(s.attributes.label=i,(o=s.attributes.msid)===null||o===void 0||o.replace(t,i))}}mungMediaDesc(e){let t=Li(e);return Fu(t),function(i){let r=i.attributes.extmaps.find(o=>DT(o.extensionName));r&&i.attributes.extmaps.splice(i.attributes.extmaps.indexOf(r),1),i.attributes.payloads.forEach(o=>{let s=o.rtcpFeedbacks.findIndex(a=>a.type==="transport-cc");s!==-1&&o.rtcpFeedbacks.splice(s,1)})}(t),t}getSSRC(e){for(let t of this.sessionDesc.mediaDescriptions)for(let i of t.attributes.ssrcs)if(i.attributes.label===e)return[i]}}var Ui;function Di(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function IR(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Di(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):Di(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}let my=(Ui=class w1 extends AT{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var t;return z(t=Object.keys(tt)).call(t,e)}))]}constructor(e,t){super(e,t),U(this,"store",void 0),U(this,"peerConnection",void 0),U(this,"remoteSDP",void 0),U(this,"initialOffer",void 0),U(this,"statsFilter",void 0),U(this,"useRTX",!1),U(this,"localCapabilities",void 0),U(this,"localCandidateCount",0),U(this,"allCandidatesReceived",!1),U(this,"establishPromise",void 0),U(this,"mutex",void 0),this.store=t,this.mutex=new mn("P2PConnection-mutex",t.clientId),this.peerConnection=new RTCPeerConnection(w1.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=Ov(this.peerConnection,F("STATS_UPDATE_INTERVAL"),void 0,ji()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{let e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let t=ba(e.sdp),i=sm(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:F("FILTER_VIDEO_FEC"),filterAudioFec:F("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=i,this.initialOffer=e,IR(IR({},t),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:e.sdp})}catch(e){throw new O(L.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async updateRemoteConnect(){}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new nx(IR(IR({},e),{},{rtpCapabilities:e.rtpCapabilities.send,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec}));let t=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:t})}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(t.toString()))}}async updateRemoteRTPCapabilities(e,t){throw new O(L.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}getPreMedia(e){}send(e,t){var i=this;return wo(function*(){let r=yield St(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let o=e.map(p=>i.peerConnection.addTrack(p._mediaStreamTrack)),s=yield St(i.peerConnection.createOffer()),a=Oo(s.sdp),c=e.map(p=>{let f=p._mediaStreamTrack,m=a.mediaDescriptions.find(g=>g.attributes.mid===f.kind);if(!m)throw new Error("Cannot extract ssrc from mediaDescription.");return function(g,S,T){let C=g.attributes.ssrcs.filter(D=>D.attributes.label===S),b=g.attributes.ssrcGroups;if(C.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(b&&C.length>1){let D=b.find(x=>x.ssrcIds.indexOf(C[0].ssrcId)!==-1);return D?[{ssrcId:D.ssrcIds[0],rtx:T?D.ssrcIds[1]:void 0}]:[{ssrcId:C[0].ssrcId}]}return[{ssrcId:C[0].ssrcId}]}(m,f.id,i.useRTX)}),d;try{d=yield c}catch(p){throw o.forEach(f=>{Cr()&&f.replaceTrack(null),i.peerConnection.removeTrack(f)}),p}let l=i.mungSendOfferSDP(s.sdp,e);i.remoteSDP.receive(e,t,d);let h=i.remoteSDP.toString();return yield St(i.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield St(i.applySendEncodings(o,e)),yield St(i.peerConnection.setRemoteDescription({type:"answer",sdp:h})),e.map((p,f)=>{let m=p._mediaStreamTrack.id;return{localSSRC:c[f],id:m}})}catch(o){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{r()}})()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let t=this.peerConnection.getSenders().filter(o=>{var s;return e.indexOf(((s=o.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map(o=>{Cr()&&o.replaceTrack(null),this.peerConnection.removeTrack(o)});let i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);let r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(t.toString()))}}async receive(e,t,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{id:o,mslabel:s}=this.remoteSDP.send(e,t,r),a=new Z((l,h)=>{let p=setTimeout(()=>{h(new Error("Cannot receive track, id: ".concat(o)))},1e4),f=m=>{let g=Zt();if((g.name==="Safari"&&Number(g.version)===11||Ht())&&m.track.id!==o&&m.streams[0].id===s){var S;let T=m.streams[0].getTracks()[0];return(S=this.remoteSDP)===null||S===void 0||S.updateTrackLabel(e,o,m.track.id),this.peerConnection.removeEventListener("track",f),clearTimeout(p),void l(T)}if(m.track.id===o)return this.peerConnection.removeEventListener("track",f),clearTimeout(p),void l(m.track)};this.peerConnection.addEventListener("track",f)}),c=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});let d=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(d),{track:await a,id:o}}catch(o){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);let t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(t.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let t=this.peerConnection.getSenders().filter(i=>{var r;return e.indexOf(((r=i.track)===null||r===void 0?void 0:r.id)||"")!==-1});if(t.length!==e.length)throw new Error("sender' length doesn't match mids' length.");t.map(i=>{if(Cr()&&i.track)i.track.enabled=!1;else{let r=i.getParameters();r.encodings.forEach(o=>o.active=!1),i.setParameters(r)}})}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(t.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let t=this.peerConnection.getSenders().filter(o=>{var s;return e.indexOf(((s=o.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(t.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");t.map(async o=>{if(Cr()&&o.track)o.track.enabled=!0;else{let s=o.getParameters();s.encodings.forEach(a=>a.active=!0),await o.setParameters(s)}});let i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);let r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(t.toString()))}}restartICE(e){var t=this;return wo(function*(){let i=yield St(t.mutex.lock("From P2PConnection.restartICE"));try{if(!t.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");let r=ot().supportPCSetConfiguration;if(e===be.RELAY&&!r)return;if(r){let d=t.peerConnection.getConfiguration(),l=e===be.RELAY?"relay":"all";d.iceTransportPolicy!==l&&(y.debug("[".concat(t.store.clientId,"] restartICE change iceTransportPolicy from [").concat(d.iceTransportPolicy,"] to [").concat(l,"]")),d.iceTransportPolicy=l,t.peerConnection.setConfiguration(d))}e!==be.RELAY&&t.remoteSDP.updateCandidates(e);let o=yield St(t.peerConnection.createOffer({iceRestart:!0}));if(!o.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let s=ba(o.sdp),{remoteIceParameters:a}=yield s.iceParameters;t.remoteSDP.restartICE(a);let c=t.remoteSDP.toString();yield St(t.peerConnection.setLocalDescription(o)),yield St(t.peerConnection.setRemoteDescription({type:"answer",sdp:c}))}catch(r){y.warning("[".concat(t.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}})()}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[t]);this.remoteSDP.updateRecvMedia(t._mediaStreamTrack.kind,t);let o=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new O(L.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,t){let i=this.peerConnection.getSenders().filter(r=>{var o;return((o=r.track)===null||o===void 0?void 0:o.id)===e});i.length===1&&await this.applySendEncodings(i,[t])}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){let i=this.peerConnection.getSenders().find(r=>{var o;return((o=r.track)===null||o===void 0?void 0:o.id)===t});i&&await i.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,t){throw new O(L.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new O(L.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,y.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,y.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},F("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){let t={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(bt(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...w1.turnServerConfigToIceServers(e.turnServer.servers)),F("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...w1.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(t.iceTransportPolicy="relay")}))),t}static turnServerConfigToIceServers(e){let t=[];return e.forEach(i=>{i.security?i.tcpport&&t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),t}async updateRtpSenderEncodings(e,t){var i;if(t||(t=this.peerConnection.getSenders().find(d=>{var l;return((l=d.track)===null||l===void 0?void 0:l.id)===e._mediaStreamTrack.id})),!t)return y.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!ot().supportSetRtpSenderParameters)return y.warn("Browser not support set rtp-sender parameters");let r={},o={};if(e instanceof Jt)switch(e._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(F("DSCP_TYPE")&&Ud()){var s;let d=F("DSCP_TYPE");z(s=["very-low","low","medium","high"]).call(s,d)&&(o.networkPriority=d)}let a=t.getParameters(),c=(i=a.encodings)===null||i===void 0?void 0:i[0];c&&Object.assign(c,o),Object.assign(a,r),y.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await t.setParameters(a)}async applySendEncodings(e,t){try{if(!ot().supportSetRtpSenderParameters||e.length!==t.length)return;for(let i=0;i<e.length;i++){let r=e[i],o=t[i];r&&o&&await this.updateRtpSenderEncodings(o,r)}}catch{y.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t){let i=Oo(e);return t.forEach((r,o)=>{let s=r._mediaStreamTrack,a=i.mediaDescriptions.find(c=>c.attributes.mid===s.kind);a&&Kd(a,r)}),sn(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;(t=this.onFirstAudioReceived)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;(t=this.onFirstVideoReceived)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;(t=this.onFirstAudioDecoded)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");let t=this.remoteSDP.batchSend(e).map((o,s)=>{let{id:a,mslabel:c}=o,{kind:d}=e[s];return new Z((l,h)=>{let p=setTimeout(()=>{h(new Error("Cannot receive track, id: ".concat(a)))},1e4),f=m=>{let g=Zt();if(g.name==="Safari"&&Number(g.version)===11&&m.track.id!==a&&m.streams[0].id===c){var S;let T=m.streams[0].getTracks()[0];return(S=this.remoteSDP)===null||S===void 0||S.updateTrackLabel(d,a,m.track.id),this.peerConnection.removeEventListener("track",f),clearTimeout(p),void l({track:T,id:a})}if(m.track.id===a)return this.peerConnection.removeEventListener("track",f),clearTimeout(p),void l({track:m.track,id:a})};this.peerConnection.addEventListener("track",f)})}),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let r=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(r),await Z.all(t)}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(t.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;let t=this.remoteSDP.getSSRC(e);return t==null?void 0:t[0].ssrcId}setConfiguration(e){if(ot().supportPCSetConfiguration){let t=w1.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}}},Oe(Ui.prototype,"connect",[Ec],Object.getOwnPropertyDescriptor(Ui.prototype,"connect"),Ui.prototype),Oe(Ui.prototype,"stopSending",[Ec],Object.getOwnPropertyDescriptor(Ui.prototype,"stopSending"),Ui.prototype),Oe(Ui.prototype,"receive",[Ec],Object.getOwnPropertyDescriptor(Ui.prototype,"receive"),Ui.prototype),Oe(Ui.prototype,"stopReceiving",[Ec],Object.getOwnPropertyDescriptor(Ui.prototype,"stopReceiving"),Ui.prototype),Oe(Ui.prototype,"muteRemote",[Ec],Object.getOwnPropertyDescriptor(Ui.prototype,"muteRemote"),Ui.prototype),Oe(Ui.prototype,"unmuteRemote",[Ec],Object.getOwnPropertyDescriptor(Ui.prototype,"unmuteRemote"),Ui.prototype),Oe(Ui.prototype,"muteLocal",[Ec],Object.getOwnPropertyDescriptor(Ui.prototype,"muteLocal"),Ui.prototype),Oe(Ui.prototype,"unmuteLocal",[Ec],Object.getOwnPropertyDescriptor(Ui.prototype,"unmuteLocal"),Ui.prototype),Oe(Ui.prototype,"close",[Ec],Object.getOwnPropertyDescriptor(Ui.prototype,"close"),Ui.prototype),Oe(Ui.prototype,"updateEncoderConfig",[Ec],Object.getOwnPropertyDescriptor(Ui.prototype,"updateEncoderConfig"),Ui.prototype),Oe(Ui.prototype,"updateSendParameters",[Ec],Object.getOwnPropertyDescriptor(Ui.prototype,"updateSendParameters"),Ui.prototype),Oe(Ui.prototype,"replaceTrack",[Ec],Object.getOwnPropertyDescriptor(Ui.prototype,"replaceTrack"),Ui.prototype),Oe(Ui.prototype,"getRemoteSSRC",[Ec],Object.getOwnPropertyDescriptor(Ui.prototype,"getRemoteSSRC"),Ui.prototype),Ui);function Ec(n,e,t){let i=n[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return t.value=async function(){let r=this.mutex,o=await r.lock("Locking from P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},t}let gc={name:"PlanBConnection",create:function(n){let{store:e,spec:t}=n;return new my(t,e)}},A9={interceptLocalAudioFrame:async function(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!ot().supportWebRTCEncodedTransform)return void y.warning("browser not support audio encoded transform");if(zf.has(n)||!n.track)return;let t={track:n.track};if(wc()){if(!n.createEncodedStreams)return void y.warning("browser not support createEncodedStreams() API");let r=null;try{r=n.createEncodedStreams()}catch(s){return void y.error("create audio-encoded-streams error",s&&s.message)}let o=new TransformStream({transform(s,a){t.controller||(t.controller=a),n.track&&n.track.id!==t.track.id&&(y.debug("audio track changed: ".concat(t.track.id," => ").concat(n.track.id)),t.track.removeEventListener("ended",i),t.track=n.track,t.track.addEventListener("ended",i));let c=e.metadata&&e.metadata();c?function(d,l){let{chunk:h,controller:p}=l,f=ku.METADATA;h.data=function(m,g,S){let T=S.byteLength,C=T+gT+Zv,b=Qv+ET+C,D=new ArrayBuffer(m.byteLength+b),x=new DataView(D);x.setUint8(0,mT),x.setUint16(1,C),x.setUint8(3,g),x.setUint16(4,T);for(let V=0;V<T;V++)x.setUint8(6+V,S[V]);let k=new Uint8Array(x.buffer);return k.set(new Uint8Array(m),b),k.buffer}(h.data,f,d),p.enqueue(h)}(c,{chunk:s,controller:a}):a.enqueue(s)}});r.readable.pipeThrough(o).pipeTo(r.writable)}else if(Cr()){if(typeof RTCRtpScriptTransform>"u")return void y.warning("browser not support RTCRtpScriptTransform");let r=Jv(),o=new MessageChannel;await new Z(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});let s=new RTCRtpScriptTransform(r,{name:"audio-metadata-tx",port:o.port2},[o.port2]);n.transform=s,await new Z(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),o.port1.onmessage=a=>{var c;if(a.data.transformed&&n.track&&((c=n.track)===null||c===void 0?void 0:c.id)!==t.track.id)y.debug("audio track changed: ".concat(t.track.id," => ").concat(n.track.id)),t.track.removeEventListener("ended",i),t.track=n.track,t.track.addEventListener("ended",i);else if(a.data.getMetadata){let d=e.metadata&&e.metadata();d&&o.port1.postMessage({metadata:d})}},t.worker=r}function i(){if(n.track){if(this.id!==n.track.id)return;n.track.removeEventListener("ended",i)}let r=zf.get(n);if(r){zf.delete(n);try{var o,s;(o=r.controller)===null||o===void 0||o.terminate(),(s=r.worker)===null||s===void 0||s.terminate()}catch(a){y.warning(a&&a.message)}}}zf.set(n,t),n.track.addEventListener("ended",i)},interceptRemoteAudioFrame:async function(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!ot().supportWebRTCEncodedTransform)return void y.warning("browser not support audio encoded transform");if(RT.has(n))return;let t={track:n.track,onMetadata:e.onMetadata,onPts:e.onPts};if(wc()&&!Ht()){if(!n.createEncodedStreams)return void y.warning("browser not support createEncodedStreams() API");_v(pt.CHROME,87,116)||(e.enableTopn=!1);let r=null;try{r=n.createEncodedStreams()}catch(s){return void y.error("create audio-encoded-streams error",s&&s.message)}let o=new TransformStream({transform(s,a){t.controller||(t.controller=a),n.track&&n.track.id!==t.track.id&&(y.debug("audio track changed: ".concat(t.track.id," => ").concat(n.track.id)),t.track.removeEventListener("ended",i),t.track=n.track,t.track.addEventListener("ended",i)),e.enableTopn?function(c,d,l){var h;let p=yl(new DataView(d.data));if(!p)return l.enqueue(d);let f=c.track.id;iC.set(f,c.track);let m=(h=p.tlv.find(D=>D.tag===ku.AUDIO_LEVEL))===null||h===void 0?void 0:h.value,g=0;typeof m=="number"&&(g=127-m);let S=Math.round(Math.pow(10,g/60)-1),{selected:T,speaker:C}=function(D,x){let k=Jf.get(D);if(k||(k=function(V){let W=new FU;return Jf.set(V,W),bs||(bs=new DP(F("TOPN_SILENCE_THRESHOLD")||500),bs.on("ActiveSpeakerChanged",K=>{K!=null&&(ya=K)})),bs.addSpeakers([W]),W}(D)),Jf.size<=ST)return{selected:!0,speaker:k};if(!bs)throw new Error("no active speaker detector");return bs.levelChanged(k.id,x),Uh=bs.loudest.map(V=>V.id),ya&&!z(Uh).call(Uh,ya)&&Uh.length>=ST&&Uh.pop(),{selected:z(Uh).call(Uh,k.id)||k.id===ya,speaker:k}}(c,S),b=function(D,x,k){let V=ps.get(D)||new eC(D,x);return V.score=k,ps.set(D,V),function(W){if(Ia.set(W,!0),!tC)return void(tC=Date.now());let K=Date.now();K-tC>1e3&&(Ia.get(W)?Ia.set(W,!1):(TT(W),Ia.delete(W)),tC=K)}(D),V}(f,c.track,C.energyScore);b.addSample(T),b.active&&(d.data=p.frame.buffer,l.enqueue(d))}(n,s,a):e.enableMetadata||e.enablePts?function(c,d,l,h){let p=new DataView(c.data),f=p.getUint8(0),m;if(128&f&&f!==71){let T=function(C){if(C.byteLength<=0)return[];let b=[],D=0;for(;D<C.byteLength;){let k=(128&C.getUint8(D))>>7,V=127&C.getUint8(D);if(!(k&&D+4<=C.byteLength)){D++;break}{let W=C.getUint32(D,!1),K=(16776192&W)>>10,J=1023&W;b.push({pt:V,ts_offset:K,length:J,data:new Uint8Array}),D+=4}}let x=C.byteLength-D;for(let k of b){if(k.length>x)return console.warn("Broken red payload"),[];k.length>0&&(k.data=new Uint8Array(C.buffer,C.byteOffset+D,k.length),D+=k.length,x-=k.length)}if(x>0){let k={pt:b.length>0?b[b.length-1].pt:0,ts_offset:0,length:x,data:new Uint8Array(C.buffer,C.byteOffset+D,x)};b.push(k)}return b}(p);if(T.length>0){let C=function(b){let D=0;for(let V=0;V<b.length;V++)D+=V<b.length-1?4:1,D+=b[V].length;let x=new Uint8Array(D),k=0;for(let V=0;V<b.length;V++)if(V<b.length-1){let W=(2147483648|(127&b[V].pt)<<24|(262143&b[V].ts_offset)<<10|1023&b[V].length)>>>0;x[k++]=W>>24&255,x[k++]=W>>16&255,x[k++]=W>>8&255,x[k++]=255&W}else x[k++]=127&b[V].pt;for(let V of b)x.set(V.data,k),k+=V.length;return x}(T.map(b=>{let D=new Uint8Array(b.length);D.set(b.data);let x=yl(new DataView(D.buffer));return x!=null&&x.frame&&(b.data=x==null?void 0:x.frame),m=x,b}));c.data=C.buffer}}else m=yl(p),m&&(c.data=m.frame.buffer);if(d.enqueue(c),!m)return;let g=m.tlv.find(T=>T.tag===ku.METADATA);g&&l&&g.value instanceof Uint8Array&&l(g.value);let S=m.tlv.find(T=>T.tag===ku.AUDIO_64_BIT_PTS);S&&h&&S.value instanceof Uint8Array&&S.value.length==8&&h(new DataView(S.value.buffer).getBigUint64(0,!0))}(s,a,e.onMetadata,e.onPts):a.enqueue(s)}});r.readable.pipeThrough(o).pipeTo(r.writable)}else{if(typeof RTCRtpScriptTransform>"u")return void y.warning("browser not support RTCRtpScriptTransform");let r=Jv(),o=new MessageChannel;await new Z(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});let s=new RTCRtpScriptTransform(r,{name:"audio-metadata-rx",port:o.port2},[o.port2]);n.transform=s,await new Z(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),o.port1.onmessage=a=>{var c;a.data.transformed&&n.track&&((c=n.track)===null||c===void 0?void 0:c.id)!==t.track.id?(y.debug("audio track changed: ".concat(t.track.id," => ").concat(n.track.id)),t.track.removeEventListener("ended",i),t.track=n.track,t.track.addEventListener("ended",i)):a.data.metadata&&t.onMetadata?t.onMetadata(a.data.metadata):a.data.pts&&t.onPts&&t.onPts(a.data.pts)},t.worker=r}function i(){n.track.removeEventListener("ended",i),function(r){let o=RT.get(r);if(o){(function(c){let d=Jf.get(c);d&&(Jf.delete(c),bs&&(bs.removeSpeakers([d]),Jf.size===0&&(bs.destroy(),bs=null)))})(r),TT(r.track.id),RT.delete(r);try{var s,a;(s=o.controller)===null||s===void 0||s.terminate(),(a=o.worker)===null||a===void 0||a.terminate()}catch(c){y.warning(c&&c.message)}}}(n)}RT.set(n,t),n.track.addEventListener("ended",i)},interceptLocalVideoFrame:async function(n,e){if(!ot().supportWebRTCEncodedTransform)return void y.warning("browser not support video encoded transform");if(CT.has(n)||!n.track)return;let t={track:n.track};if(wc()){if(!n.createEncodedStreams)return void y.warning("browser not support createEncodedStreams() API");let r=null;try{r=n.createEncodedStreams()}catch(a){return void y.error("create video-encoded-streams error",a&&a.message)}let o=[];e.on("sei-to-send",a=>{o.push(a)});let s=new TransformStream({transform(a,c){t.controller||(t.controller=c),n.track&&n.track.id!==t.track.id&&(y.debug("video track changed: ".concat(t.track.id," => ").concat(n.track.id)),t.track.removeEventListener("ended",i),t.track=n.track,t.track.addEventListener("ended",i));let d=kP(new Uint8Array(a.data)),l=o.shift();if(l){let h=function(p,f,m){switch(m){case PP:return function(g,S){let T=LP(S),C=T.length,b=Math.floor(C/255),D=C%255,x=new Uint8Array(6+b+1+C+g.byteLength);x[0]=0,x[1]=0,x[2]=0,x[3]=1,x[4]=6,x[5]=101;let k=0;for(;k<b;)x[6+k]=255,k++;return x[6+k]=D,k++,x.set(T,6+k),x.set(new Uint8Array(g),6+k+C),x.buffer}(p,f);case vT:return function(g,S){let T=LP(S),C=T.length,b=Math.floor(C/255),D=C%255,x=new Uint8Array(7+b+1+C+1+g.byteLength);x[0]=0,x[1]=0,x[2]=0,x[3]=1,x[4]=78,x[5]=1,x[6]=101;let k=0;for(;k<b;)x[7+k]=255,k++;return x[7+k]=D,k++,x.set(T,7+k),k+=C,x[7+k]=128,k++,x.set(new Uint8Array(g),7+k),x.buffer}(p,f);default:return null}}(a.data,l,d);h&&(a.data=h)}c.enqueue(a)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else{if(!Cr())return;{if(typeof RTCRtpScriptTransform>"u")return void y.warning("browser not support RTCRtpScriptTransform");let r=Jv(),o=new MessageChannel;await new Z(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});let s=new RTCRtpScriptTransform(r,{name:"sei-tx",port:o.port2},[o.port2]);n.transform=s,await new Z(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),e.on("sei-to-send",a=>{o.port1.postMessage({sei:a})}),o.port1.onmessage=a=>{var c;a.data.transformed&&n.track&&((c=n.track)===null||c===void 0?void 0:c.id)!==t.track.id&&(y.debug("video track changed: ".concat(t.track.id," => ").concat(n.track.id)),t.track.removeEventListener("ended",i),t.track=n.track,t.track.addEventListener("ended",i))},t.worker=r}}function i(){if(n.track){if(this.id!==n.track.id)return;n.track.removeEventListener("ended",i)}let r=CT.get(n);if(r){CT.delete(n);try{var o,s;(o=r.controller)===null||o===void 0||o.terminate(),(s=r.worker)===null||s===void 0||s.terminate()}catch(a){y.warning(a&&a.message)}}}CT.set(n,t),n.track.addEventListener("ended",i)},interceptRemoteVideoFrame:async function(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!ot().supportWebRTCEncodedTransform)return void y.warning("browser not support video encoded transform");if(!n.track)return;if(xh.has(n)){let r=xh.get(n);return void(r&&(r.onSei=e.onSei))}let t={track:n.track,onSei:e.onSei};if(wc()){if(!n.createEncodedStreams)return void y.warning("browser not support createEncodedStreams() API");let r=null;try{r=n.createEncodedStreams()}catch(s){return void y.error("create video-encoded-streams error",s&&s.message)}let o=new TransformStream({transform(s,a){if(t.controller||(t.controller=a),!t.firstFrameInfo){var c;let l=s.getMetadata()||{};t.firstFrameInfo=ki({type:s.type,rtpTimestamp:s.timestamp,payloadType:l.payloadType||0,ssrc:l.synchronizationSource||0,length:s.data.byteLength},"mimeType"in l?{mimeType:l.mimeType}:{}),(c=e.onFirstFrame)===null||c===void 0||c.call(e,t.firstFrameInfo)}n.track&&n.track.id!==t.track.id&&(y.debug("video track changed: ".concat(t.track.id," => ").concat(n.track.id)),t.track.removeEventListener("ended",i),t.track=n.track,t.track.addEventListener("ended",i));let d=function(l,h){switch(h){case PP:return function(p){let f=new DataView(p.data),m=0;for(;m+4<p.data.byteLength;){if(f.getUint8(m+0)===0&&f.getUint8(m+1)===0&&f.getUint8(m+2)===0&&f.getUint8(m+3)===1&&f.getUint8(m+4)===6){let g=m+6,S=0,T=0;for(;(T=f.getUint8(g++))===255;)S+=255;S+=T;let C=rC(p.data,g,S);return new Uint8Array(C)}m++}return null}(l);case vT:return function(p){let f=new DataView(p.data),m=0;for(;m+5<p.data.byteLength;){if(f.getUint8(m+0)===0&&f.getUint8(m+1)===0&&f.getUint8(m+2)===0&&f.getUint8(m+3)===1&&f.getUint8(m+4)===78&&f.getUint8(m+5)===1&&f.getUint8(m+6)===101){let g=m+7,S=0,T=0;for(;(T=f.getUint8(g++))===255;)S+=255;S+=T;let C=rC(p.data,g,S);return new Uint8Array(C)}m++}return null}(l);default:return null}}(s,kP(new Uint8Array(s.data)));d&&t.onSei&&t.onSei(d),a.enqueue(s)}});r.readable.pipeThrough(o).pipeTo(r.writable)}else if(Cr()){if(typeof RTCRtpScriptTransform>"u")return void y.warning("browser not support RTCRtpScriptTransform");let r=Jv(),o=new MessageChannel;await new Z(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});let s=new RTCRtpScriptTransform(r,{name:"sei-rx",port:o.port2},[o.port2]);n.transform=s,await new Z(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),o.port1.onmessage=a=>{var c;if(a.data.transformed&&n.track&&((c=n.track)===null||c===void 0?void 0:c.id)!==t.track.id)y.debug("video track changed: ".concat(t.track.id," => ").concat(n.track.id)),t.track.removeEventListener("ended",i),t.track=n.track,t.track.addEventListener("ended",i);else if(a.data.sei&&t.onSei)t.onSei(a.data.sei);else if(a.data.firstFrameInfo&&e.onFirstFrame){var d;(d=e.onFirstFrame)===null||d===void 0||d.call(e,a.data.firstFrameInfo)}},t.worker=r}function i(){if(n.track){if(this.id!==n.track.id)return;n.track.removeEventListener("ended",i)}(function(r){let o=xh.get(r);if(o){xh.delete(r);try{var s,a;(s=o.controller)===null||s===void 0||s.terminate(),(a=o.worker)===null||a===void 0||a.terminate()}catch(c){y.warning(c&&c.message)}}})(n)}xh.set(n,t),n.track.addEventListener("ended",i)}},w9={name:"InterceptFrame",create:()=>A9};var oi;function ei(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}function Jc(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ei(Object(t),!0).forEach(function(i){U(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):ei(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}let ol=(oi=class vy extends AT{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return(e=(t=this.peerConnection.getReceivers()[0])===null||t===void 0||(t=t.transport)===null||t===void 0?void 0:t.state)!==null&&e!==void 0?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var t;return z(t=Object.keys(tt)).call(t,e)}))]}constructor(e,t,i){super(e,t),U(this,"id",vt(5,"connection-")),U(this,"store",void 0),U(this,"peerConnection",void 0),U(this,"forceTurn",!1),U(this,"remoteSDP",void 0),U(this,"initialOffer",void 0),U(this,"transportEventReceiver",void 0),U(this,"statsFilter",void 0),U(this,"extension",{useXR:F("USE_XR")}),U(this,"localCapabilities",void 0),U(this,"remoteCodecs",void 0),U(this,"localCandidateCount",0),U(this,"allCandidatesReceived",!1),U(this,"isPreallocation",!1),U(this,"preMediaMap",new Map),U(this,"dataStreamChannelMap",new Map),U(this,"establishPromise",void 0),U(this,"recoveredDataChannelIds",[]),U(this,"currentDataChannelId",1),U(this,"supportAV1RtpSpec",!1),U(this,"mutex",void 0),U(this,"qualityLimitationReason",xf.NONE),U(this,"isFirstConnected",!1),this.store=t,this.forceTurn=YT(e),this.mutex=new mn("NVConnectionExtension-mutex",t.clientId),this.peerConnection=i,this.isFirstConnected=!1,this.statsFilter=Ov(this.peerConnection,F("STATS_UPDATE_INTERVAL"),void 0,ji()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,e.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(e){return this.preMediaMap.get(e)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(e,t){if(this.remoteCodecs=t,!this.remoteSDP)return void y.debug("[NVConnectionExtension] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(t));if(this.remoteSDP.updateRemoteCodec(e,t,this.store.codec)){let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);let o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}else y.debug("[NVConnectionExtension] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});let t=await this.peerConnection.createOffer();if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let i=ba(t.sdp),r=await lC({filterRTX:!F("USE_PUB_RTX")&&!F("USE_SUB_RTX"),filterVideoFec:F("FILTER_VIDEO_FEC"),filterAudioFec:F("FILTER_AUDIO_FEC"),filterVideoCodec:F("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:F("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:F("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=Ns(r),this.initialOffer=t,F("ENABLE_SVC")&&this.store.codec=="av1"){let s=await dC();var e;s&&(this.supportAV1RtpSpec=!0,(e=r.send)===null||e===void 0||e.videoExtensions.push(s))}let o;return t.sdp&&MT(t.sdp)&&(o=Li(r),zP(o)),Jc(Jc({},i),{},{rtpCapabilities:o||r,offerSDP:t.sdp})}catch(t){throw new O(L.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnectionExtension without initial offer.");this.initialOffer.sdp&&MT(this.initialOffer.sdp)&&qP(e.rtpCapabilities,this.localCapabilities),this.remoteSDP=new BT(Jc(Jc({},e),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!F("ENABLE_PRE_SUB_WITH_PRE_PC")||!F("PRE_USE_LOCAL_CODECS"))&&kh(this.store),!0),e.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);let t=this.remoteSDP.toString(),i=Xo(this.initialOffer.sdp,this.extension),r=this.logSDPExchange(i||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),r==null||r(t),await this.peerConnection.setRemoteDescription({type:"answer",sdp:t});let o=this.peerConnection.getTransceivers()[0];if(o!=null&&o.receiver&&this.tryBindTransportEvents(o.receiver),kh(this.store))if(e.preallocation&&F("ENABLE_PRE_SUB_WITH_PRE_PC")){let s=F("PRE_SUB_NUM"),{mids:a,preSSRCs:c}=this.remoteSDP.preloadRemoteMedia(s);await zn(this.peerConnection,this.remoteSDP,this.extension),y.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] preload media, in pre pc,add preload ssrcs ").concat(c)),this.presetMedia(a,c)}else{let{preSSRCs:s=[]}=e,a=s.map(d=>d.ssrcMsg[0].ssrcId);if(s.length===0)return;let{mids:c}=this.remoteSDP.batchSend(s.map(d=>Object.assign({},d)));await zn(this.peerConnection,this.remoteSDP,this.extension),y.debug("[NVConnectionExtension.connect] preload media, after join, add preload ssrcs ".concat(a)),this.presetMedia(c,a)}}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"NVConnectionExtension.connect failed; ".concat(t.toString()))}}presetMedia(e,t){e.forEach((i,r)=>{this.peerConnection.getTransceivers().forEach(o=>{if(o.mid!=null&&i===o.mid&&o.receiver.track){let s=o.receiver.track,a;s.kind==="video"&&F("ENABLE_PRE_RENDER")&&(a=new pT({trackId:"track-".concat(s.kind,"-unknown-").concat(this.store.clientId,"_").concat(vt(5,""))},!0),a.updateVideoTrack(s),a.onFirstVideoFrameRender=()=>{var c;let d=this.preMediaMap.get(t[r]);d&&(d.firstVideoRender=Date.now()),(c=this.onFirstVideoRender)===null||c===void 0||c.call(this,t[r])},a.onVideoBufferReady=()=>{var c;(c=this.onFirstVideoBufferReady)===null||c===void 0||c.call(this,t[r])},a.play(this.store.sessionId||void 0)),this.preMediaMap.set(t[r],{mid:i,track:s,player:a,transceiver:o})}}),this.store.peerReceiver()})}checkDtlsParameters(e){return!!this.remoteSDP&&e.length>0&&this.remoteSDP.updateRemoteDtlsParameters(e)}async updateRemoteConnect(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateRemoteConnect before remote SDP created");let t=!1,{rtpCapabilities:i}=e;if([,t]=this.remoteSDP.updateRemoteRTPCapabilities(i),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){let s=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);t=t||s}let{preSSRCs:r=[]}=e,o=r.map(s=>s.ssrcMsg[0].ssrcId);if(!this.remoteSDP.checkPreloadSsrcs(o)){let s=[],a=[];if(Array.from(this.preMediaMap.entries()).every(c=>{let[d,{mid:l,player:h,track:p}]=c;return s.push(l),a.push(d),this.preMediaMap.delete(d),h&&h.destroy(),!0}),s.length>0&&(this.remoteSDP.stopSending(s),await zn(this.peerConnection,this.remoteSDP,this.extension),y.warn("[NVConnectionExtension.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(a)),_e.reportApiInvoke(this.store.sessionId,{name:Yi.PRELOAD_MEDIA_FAILED,options:[r,a],tag:ct.TRACER}).onSuccess()),r.length>0){let{mids:c}=this.remoteSDP.batchSend(r.map(d=>Object.assign({},d)));await zn(this.peerConnection,this.remoteSDP,this.extension),y.debug("[NVConnectionExtension.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(o)),this.presetMedia(c,o)}}t?(await zn(this.peerConnection,this.remoteSDP,this.extension),y.debug("[NVConnectionExtension] updateRemoteConnect by exchanging SDP.")):y.debug("[NVConnectionExtension] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"NVConnectionExtension.updateRemoteConnect failed; ".concat(t.toString()))}}send(e,t,i){var r=this;return wo(function*(){let o=yield St(r.mutex.lock("From NVConnectionExtension.send"));try{if(!r.remoteSDP)throw new Error("Cannot call NVConnectionExtension.send before remote SDP created");let s=[],a=nm();e.forEach(S=>{let T=r.peerConnection.addTransceiver(S._mediaStreamTrack,Jc({direction:"sendonly"},S.trackMediaType==="video"&&r.supportAV1RtpSpec&&a?{sendEncodings:[{scalabilityMode:a}]}:{}));s.push(T),S._updateRtpTransceiver(T)}),ji()&&F("SIMULCAST")===!0&&(yield St(r.applySimulcastForFirefox(s,e)));let c=yield St(r.peerConnection.createOffer()),d=r.remoteSDP.predictReceivingMids(e.length),l=r.mungSendOfferSDP(c.sdp,e,d),h=Oo(l),p=d.map(S=>{let T=h.mediaDescriptions.find(C=>C.attributes.mid===S);if(!T)throw new Error("Cannot extract ssrc from mediaDescription.");return xc(T,F("USE_PUB_RTX"))}),f;try{f=yield p}catch(S){f=[],r.remoteSDP.receive(e,t,i,f);let T=r.remoteSDP.toString();throw yield St(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield St(r.peerConnection.setRemoteDescription({type:"answer",sdp:T})),yield St(r.stopSending(d,!0)),S}r.remoteSDP.receive(e,t,i,f);let m=r.remoteSDP.toString(),g=r.logSDPExchange(l,"offer","local","send");return yield St(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield St(r.applySimulcastEncodings(s,e)),yield St(r.applySendEncodings(s,e)),g==null||g(m),yield St(r.peerConnection.setRemoteDescription({type:"answer",sdp:m})),s.map((S,T)=>{let C=d[T];return{localSSRC:p[T],id:C,transceiver:S}})}catch(s){throw s instanceof O?s:new O(L.EXCHANGE_SDP_FAILED,"NVConnectionExtension.send failed; ".concat(s.toString()))}finally{o()}})()}async createDataChannels(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(e);if(i&&i.readyState==="open")y.debug("[NVConnectionExtension] Channels are already available and can be reused directly.");else{let o=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof o!="number")throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:o,negotiated:!0,ordered:!1,maxRetransmits:F("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,i)}t.forEach(o=>{o._updateOriginDataChannel(i)});let{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){let o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});let s=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(s),y.debug("[NVConnectionExtension] createDataChannels by exchanging SDP.")}else y.debug("[NVConnectionExtension] createDataChannels no need to exchange SDP.");return}catch(i){throw i instanceof O?i:new O(L.EXCHANGE_SDP_FAILED,"NVConnectionExtension.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(e){try{let t=this.dataStreamChannelMap.get(e);return t&&(t.id&&this.recoveredDataChannelIds.push(t.id),t.close()),void this.dataStreamChannelMap.delete(e)}catch(t){throw t instanceof O?t:new O(L.DATACHANNEL_FAILED,"NVConnectionExtension.stopDataChannels failed; ".concat(t.toString()))}}async stopSending(e,t){let i=t?void 0:await this.mutex.lock("From NVConnectionExtension.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopSending before remote SDP created");let r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVConnectionExtension.stopSending.");r.map(c=>{var d;V_(this.id+c.mid,this),c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});let o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);let a=this.remoteSDP.toString();s==null||s(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new O(L.EXCHANGE_SDP_FAILED,"NVConnectionExtension.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(e,t,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.receive ".concat(e," before remoteSDP created."));let{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,t,i,r);s&&(await zn(this.peerConnection,this.remoteSDP,this.extension),y.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] receive ").concat(e," by exchanging SDP.")));let a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o,transceiver:a}}catch(o){throw new O(L.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(o.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.batchReceive before remoteSDP created.");let{mids:t,needExchangeSDP:i}=this.remoteSDP.batchSend(e);return i&&(await zn(this.peerConnection,this.remoteSDP,this.extension),y.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] batchReceive by exchanging SDP."))),t.map(r=>{let o=this.peerConnection.getTransceivers().find(s=>s.mid===r);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:r,transceiver:o}})}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(t.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopReceiving before remote SDP created.");e.forEach(o=>{Array.from(this.preMediaMap.entries()).some(s=>{let[a,{mid:c,player:d}]=s;if(c===o)return this.preMediaMap.delete(a),d&&d.destroy(),!0})}),this.remoteSDP.stopSending(e);let t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"NVConnectionExtension stopReceiving failed; ".concat(t.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);let t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteRemote failed; ".concat(t.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);let t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteRemote failed; ".concat(t.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteLocal before remote SDP created.");let t=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map(s=>{s.direction="inactive"});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);let o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteLocal failed; ".concat(t.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteLocal before remote SDP created.");let t=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map(async(s,a)=>{s.direction="sendonly"});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(e,this.remoteCodecs,this.store.codec);let o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(t){throw new O(L.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteLocal failed; ".concat(t.toString()))}}restartICE(e){var t=this;return wo(function*(){let i=yield St(t.mutex.lock("From NVConnectionExtension.restartICE"));try{if(!t.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");let r=ot().supportPCSetConfiguration,o=F("FORCE_TURN_TCP")||t.forceTurn;if(e===be.RELAY&&!r)return;if(r&&!o){let h=e===be.RELAY?"relay":"all",p=t.peerConnection.getConfiguration();p.iceTransportPolicy!==h&&(y.debug("[".concat(t.store.clientId,"] restartICE change iceTransportPolicy from [").concat(p.iceTransportPolicy,"] to [").concat(h,"]")),p.iceTransportPolicy=h,t.peerConnection.setConfiguration(p))}t.remoteSDP.updateCandidates(e);let s=yield St(t.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let a=ba(s.sdp),{remoteIceParameters:c}=yield a.iceParameters;t.remoteSDP.restartICE(c);let d=t.remoteSDP.toString(),l=t.logSDPExchange(s.sdp||"","offer","local","restartICE");t.store.descriptionStart(),yield St(t.peerConnection.setLocalDescription(s)),l==null||l(d),yield St(t.peerConnection.setRemoteDescription({type:"answer",sdp:d}))}catch(r){y.warning("[".concat(t.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}})()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;let e=await this.mutex.lock("From NVConnectionExtension.extendCandidate");try{this.remoteSDP.updateCandidates(be.TCP_RELAY),await zn(this.peerConnection,this.remoteSDP,this.extension)}catch(t){y.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),t)}finally{e()}}close(){var e;this.peerConnection.getTransceivers().forEach(t=>{V_(this.id+t.mid,this)}),this.preMediaMap.forEach(t=>{let{player:i}=t;i&&i.destroy()}),this.preMediaMap.clear(),this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return Jc(Jc({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateEncoderConfig before remote SDP created.");let i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);let o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s==null||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new O(L.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,t){let i=this.peerConnection.getTransceivers().filter(r=>r.mid===e);i.length===1&&(this.isVP8Simulcast(t)?ji()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){let i=this.peerConnection.getTransceivers().find(r=>r.mid===t);i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){let e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){let t=e[0].transport.iceTransport,{local:i,remote:r}=t.getSelectedCandidatePair();return{local:Jc(Jc({},Ea),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:Jc(Jc({},Ea),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=e=>{if(e&&(e.errorCode||e.errorText)){var t;let i="code: ".concat(e.errorCode,", message: ").concat(e.errorText),r=e.port?"local: ".concat(e.port):"",o=_s(e.url||"");y.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: NVConnectionExtension.onICECandidateError(").concat(i,"), url: ").concat(o||"",", host_candidate:").concat(r)),(t=this.onICECandidateError)===null||t===void 0||t.call(this,i)}},this.peerConnection.onicegatheringstatechange=e=>{e&&e.target&&"iceGatheringState"in e.target&&y.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(e.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,y.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,y.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},F("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){let t={iceServers:[]},i=e.cloudProxyServer||"disabled";return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&(bt(e.turnServer.servers)?t.iceServers=e.turnServer.servers:F("NEW_TURN_MODE")&&t.iceServers&&i==="disabled"?(F("USE_TURN_SERVER_OF_GATEWAY")?e.turnServer.serversFromGateway&&t.iceServers.push(...vy.newTurnServerConfigToIceServers(e.turnServer.serversFromGateway)):t.iceServers.push(...vy.newTurnServerConfigToIceServers(e.turnServer.servers)),F("NEW_FORCE_TURN")&&(t.iceTransportPolicy="relay")):e.turnServer.mode!=="off"&&(t.iceServers&&t.iceServers.push(...vy.turnServerConfigToIceServers(e.turnServer.servers)),F("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...vy.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),F("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(t.iceTransportPolicy="relay")}))),F("ENABLE_ENCODED_TRANSFORM")&&ot().supportWebRTCEncodedTransform&&(t.encodedInsertableStreams=!0),t}static turnServerConfigToIceServers(e){let t=[];return e.forEach(i=>{i.security?i.tcpport&&t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(wa(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!F("FORCE_TURN_TCP")&&t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),t}static newTurnServerConfigToIceServers(e){let t=[];return e.forEach(i=>{let r=F("NEW_TURN_MODE");r===1?t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}):r===2?t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}):r===3?t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(wa(i.turnServerURL),":443?transport=tcp")}):r===4&&(t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}),t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}),t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(wa(i.turnServerURL),":443?transport=tcp")}))}),t}tryBindTransportEvents(e){let t=e.transport;if(t){this.transportEventReceiver=e,t.onstatechange=()=>{var r;t!=null&&t.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,t.state))},t.onerror=r=>{var o;(o=this.onDTLSTransportError)===null||o===void 0||o.call(this,"error"in r?r.error:r)};let i=t.iceTransport;i&&(i.onstatechange=()=>{let r=t==null?void 0:t.iceTransport.state;var o;r&&((o=this.onICETransportStateChange)===null||o===void 0||o.call(this,r))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){let{local:r,remote:o}=i.getSelectedCandidatePair()||{};if(r&&o){let s=r.address+":"+r.port,a=o.address+":"+o.port;y.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(_s(s)),", remote ").concat(JSON.stringify(_s(a))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,t){var i,r;if(t||(t=this.peerConnection.getSenders().find(g=>g.track===e._mediaStreamTrack)),!t)return y.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return y.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!ot().supportSetRtpSenderParameters)return y.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let o={},s={};switch(e._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;case"balanced":o.degradationPreference="balanced"}let a=Hd(this.peerConnection,e._mediaStreamTrack),c=rD(e);if(yC(e)&&a&&t&&c&&this.getLocalVideoStats&&z(i=["vp8","vp9"]).call(i,this.store.codec)){var d;let g=o.degradationPreference||(z(d=e._hints).call(d,Re.CUSTOM_TRACK)?F("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");WT(this.id+a.mid,c,this,g,S=>{t&&this.updateAdaptation(t,S)},this.getLocalVideoStats.bind(this))}if(e._encoderConfig){var l;let{bitrateMax:g,frameRate:S,scaleResolutionDownBy:T}=e._encoderConfig;g&&(s.maxBitrate=1e3*g),(z(l=e._hints).call(l,Re.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(S&&(s.maxFramerate=Mo(S)),T&&T>=1&&(s.scaleResolutionDownBy=T))}let{maxFramerate:h}=F("ENCODER_CONFIG_LIMIT");if(h&&typeof h=="number"&&(s.maxFramerate=s.maxFramerate?Math.min(s.maxFramerate,h):h),F("DSCP_TYPE")&&Ud()){var p;let g=F("DSCP_TYPE");z(p=["very-low","low","medium","high"]).call(p,g)&&(s.networkPriority=g)}let f=t.getParameters(),m=(r=f.encodings)===null||r===void 0?void 0:r[0];ji()&&!m&&(o.encodings=[s]),m&&Object.assign(m,s),Object.assign(f,o),y.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(f.encodings))),await t.setParameters(f),await QP(this.store.codec,t,F("SVC_MODE"))}async updateAdaptation(e,t){var i,r;if(!e)return y.debug("[updateAdaptation] no rtpSender found");if(!ot().supportSetRtpSenderParameters)return y.debug("[updateAdaptation] Browser not support set rtp-sender parameters");let o={},{bitrateMax:s,frameRate:a,scaleResolutionDownBy:c}=t;s&&(o.maxBitrate=1e3*s),a&&(o.maxFramerate=Mo(a)),c&&c>=1&&z(i=["vp8","vp9"]).call(i,this.store.codec)&&(o.scaleResolutionDownBy=c);let d=e.getParameters(),l=(r=d.encodings)===null||r===void 0?void 0:r[0];l&&Object.assign(l,o),Object.assign(d,{});try{await e.setParameters(d),y.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(d.encodings)))}catch(h){!("transport"in e)||e.transport&&e.transport.state==="connected"?this.peerConnectionState!=="connected"?y.debug("[updateAdaptation] peerConnection not connected}"):y.debug("[updateAdaptation] updateRtpSenderEncodings failed",h):y.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(e,t){try{if(!ot().supportSetRtpSenderParameters||e.length!==t.length)return;for(let i=0;i<e.length;i++){let r=e[i],o=t[i];o instanceof Jt&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,r.sender)}}catch{y.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,i){let r=Oo(e);return t.forEach((o,s)=>{let a=i[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Kd(c,o),cm(c,o,this.store.codec))}),sn(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;(t=this.onFirstAudioReceived)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;(t=this.onFirstVideoReceived)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;(t=this.onFirstAudioDecoded)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;(t=this.onFirstVideoDecodedTimeout)===null||t===void 0||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let c=0;c<e.length;c++){var i,r,o,s,a;let d=e[c],l=t[c];if(l instanceof Jt&&!z(i=l._hints).call(i,Re.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=l._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=l._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){let h={},p={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};h.encodings=[{rid:"m",active:!0,maxBitrate:p.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:p.high}];let f=d.sender.getParameters();await d.sender.setParameters(Object.assign(f,h))}}}async applySimulcastEncodings(e,t){if(!ji()&&e.length===t.length)for(let i=0;i<e.length;i++){let r=t[i];if(r instanceof Jt&&this.isVP8Simulcast(r)){let o=e[i],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];let c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s))}}}isVP8Simulcast(e){var t,i,r,o,s;return!!(e instanceof Jt&&F("SIMULCAST")&&this.store.codec==="vp8"&&!z(t=e._hints).call(t,Re.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=e._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=e._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,t,i,r){if(F("SDP_LOGGING"))return y.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(t," SDP during NVConnectionExtension.").concat(r,`
`),e),t==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;let t=this.remoteSDP.getSSRC(e);return t&&t.length!==0?t[0].ssrcId:void 0}setConfiguration(e){if(ot().supportPCSetConfiguration){let t=vy.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}e.isPreallocation&&(this.isPreallocation=!0)}},Oe(oi.prototype,"updateRemoteRTPCapabilities",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"updateRemoteRTPCapabilities"),oi.prototype),Oe(oi.prototype,"connect",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"connect"),oi.prototype),Oe(oi.prototype,"updateRemoteConnect",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"updateRemoteConnect"),oi.prototype),Oe(oi.prototype,"createDataChannels",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"createDataChannels"),oi.prototype),Oe(oi.prototype,"receive",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"receive"),oi.prototype),Oe(oi.prototype,"batchReceive",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"batchReceive"),oi.prototype),Oe(oi.prototype,"stopReceiving",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"stopReceiving"),oi.prototype),Oe(oi.prototype,"muteRemote",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"muteRemote"),oi.prototype),Oe(oi.prototype,"unmuteRemote",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"unmuteRemote"),oi.prototype),Oe(oi.prototype,"muteLocal",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"muteLocal"),oi.prototype),Oe(oi.prototype,"unmuteLocal",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"unmuteLocal"),oi.prototype),Oe(oi.prototype,"close",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"close"),oi.prototype),Oe(oi.prototype,"updateEncoderConfig",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"updateEncoderConfig"),oi.prototype),Oe(oi.prototype,"updateSendParameters",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"updateSendParameters"),oi.prototype),Oe(oi.prototype,"replaceTrack",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"replaceTrack"),oi.prototype),Oe(oi.prototype,"updateAdaptation",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"updateAdaptation"),oi.prototype),Oe(oi.prototype,"getRemoteSSRC",[Es],Object.getOwnPropertyDescriptor(oi.prototype,"getRemoteSSRC"),oi.prototype),oi);function Es(n,e,t){let i=n[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return t.value=async function(){let r=this.mutex,o=await r.lock("From NVConnectionExtension.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},t}var Bt;function Ii(n){var e,t,i,r=2;for(typeof Symbol<"u"&&(t=vu,i=Symbol.iterator);r--;){if(t&&(e=n[t])!=null)return e.call(n);if(i&&(e=n[i])!=null)return new AR(e.call(n));t="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function AR(n){function e(t){if(Object(t)!==t)return Z.reject(new TypeError(t+" is not an object."));var i=t.done;return Z.resolve(t.value).then(function(r){return{value:r,done:i}})}return AR=function(t){this.s=t,this.n=t.next},AR.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(t){var i=this.s.return;return i===void 0?Z.resolve({value:t,done:!0}):e(i.apply(this.s,arguments))},throw:function(t){var i=this.s.return;return i===void 0?Z.reject(t):e(i.apply(this.s,arguments))}},new AR(n)}let Ey=(Bt=class Bx extends AT{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(e,t){super(e,t),U(this,"name","DataChannelConnection"),U(this,"store",void 0),U(this,"peerConnection",void 0),U(this,"cname",void 0),U(this,"mutex",new mn("DataChannelConnection-mutex")),U(this,"dataChannel",void 0),U(this,"_p2pConnection",void 0),U(this,"establishPromise",void 0),U(this,"_nvMedia",void 0),this.store=t,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(Bx.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new ol(e,t,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}getPreMedia(e){var t;return(t=this._p2pConnection)===null||t===void 0?void 0:t.getPreMedia(e)}isPreSub(){var e,t;return(e=(t=this._p2pConnection)===null||t===void 0?void 0:t.isPreSub())!==null&&e!==void 0&&e}async establish(){return await this._p2pConnection.establish()}getP2PConnectionParams(){return this._p2pConnection.establishPromise}updateRtpSenderEncodings(e){return this._p2pConnection.updateRtpSenderEncodings(e)}async connect(e){return this.cname=e.cname,await this._p2pConnection.connect(e),await new Z((t,i)=>{let r=setTimeout(()=>{this.closeSignal(),i(new H(L.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(e.candidates))))},F("DC_CONNECTION_TIMEOUT"));this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(r),void t()},this.dataChannel.onerror=o=>{this.closeSignal(),i(o)},this.dataChannel.addEventListener("close",()=>{i(new H(L.DATACHANNEL_CONNECTION_TIMEOUT))})}),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(e,t){return this._p2pConnection.updateRemoteRTPCapabilities(e,t)}send(e,t,i){var r=this;return wo(function*(){let o=yield St(r.mutex.lock("From DataChannelConnection.send"));try{return yield*Et(Ii(r._p2pConnection.send(e,t,i)))}finally{o()}})()}async stopSending(e,t){return this._p2pConnection.stopSending(e,t)}async createDataChannels(e,t){return this._p2pConnection.createDataChannels(e,t)}async stopDataChannels(e){return this._p2pConnection.stopDataChannels(e)}async receive(e,t,i,r){return this._nvMedia?(y.debug("[DataChannelConnection] receive ".concat(e," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(e,t,this.cname)):(y.debug("[DataChannelConnection] receive ".concat(e," by WebRTC.")),await this._p2pConnection.receive(e,t,i,r))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(e){var t=this;return wo(function*(){return yield*Et(Ii(t._p2pConnection.restartICE(e)))})()}close(){var e;(e=this._nvMedia)===null||e===void 0||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var t;return(t=this._nvMedia)===null||t===void 0||t.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,t){return await this._p2pConnection.updateEncoderConfig(e,t)}async updateSendParameters(e,t){return await this._p2pConnection.updateSendParameters(e,t)}setStatsRemoteVideoIsReady(e,t){this._p2pConnection.setStatsRemoteVideoIsReady(e,t)}async replaceTrack(e,t){return await this._p2pConnection.replaceTrack(e,t)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(e,t,i,r){if(F("SDP_LOGGING"))return y.upload("exchanging ".concat(i," ").concat(t," SDP during DataChannelConnection.").concat(r,`
`),e),t==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r)}:void 0}static resolvePCConfiguration(e){let t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(bt(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...Bx.turnServerConfigToIceServers(e.turnServer.servers)),F("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...Bx.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),F("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(t.iceTransportPolicy="relay")}))),F("ENABLE_ENCODED_TRANSFORM")&&ot().supportWebRTCEncodedTransform&&(t.encodedInsertableStreams=!0),t}static turnServerConfigToIceServers(e){let t=[];return e.forEach(i=>{i.security?i.tcpport&&t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(wa(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!F("FORCE_TURN_TCP")&&t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&t.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),t}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var t;return(t=this.onICEConnectionStateChange)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var t;return(t=this.onConnectionStateChange)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var t;return(t=this.onDTLSTransportStateChange)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var t;return(t=this.onDTLSTransportError)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var t;return(t=this.onICETransportStateChange)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var t;return(t=this.onFirstAudioReceived)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var t;return(t=this.onFirstVideoReceived)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var t;return(t=this.onFirstAudioDecoded)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoRender=e=>{var t;return(t=this.onFirstVideoRender)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoBufferReady=e=>{var t;return(t=this.onFirstVideoBufferReady)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,t,i)=>{var r;return(r=this.onFirstVideoDecoded)===null||r===void 0?void 0:r.call(this,e,t,i)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var t;return(t=this.onFirstVideoDecodedTimeout)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,t)=>{var i;return(i=this.onSelectedLocalCandidateChanged)===null||i===void 0?void 0:i.call(this,e,t)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,t)=>{var i;return(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0?void 0:i.call(this,e,t)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}},Oe(Bt.prototype,"connect",[Da],Object.getOwnPropertyDescriptor(Bt.prototype,"connect"),Bt.prototype),Oe(Bt.prototype,"updateRemoteRTPCapabilities",[Da],Object.getOwnPropertyDescriptor(Bt.prototype,"updateRemoteRTPCapabilities"),Bt.prototype),Oe(Bt.prototype,"createDataChannels",[Da],Object.getOwnPropertyDescriptor(Bt.prototype,"createDataChannels"),Bt.prototype),Oe(Bt.prototype,"receive",[Da],Object.getOwnPropertyDescriptor(Bt.prototype,"receive"),Bt.prototype),Oe(Bt.prototype,"stopReceiving",[Da],Object.getOwnPropertyDescriptor(Bt.prototype,"stopReceiving"),Bt.prototype),Oe(Bt.prototype,"muteRemote",[Da],Object.getOwnPropertyDescriptor(Bt.prototype,"muteRemote"),Bt.prototype),Oe(Bt.prototype,"unmuteRemote",[Da],Object.getOwnPropertyDescriptor(Bt.prototype,"unmuteRemote"),Bt.prototype),Oe(Bt.prototype,"muteLocal",[Da],Object.getOwnPropertyDescriptor(Bt.prototype,"muteLocal"),Bt.prototype),Oe(Bt.prototype,"unmuteLocal",[Da],Object.getOwnPropertyDescriptor(Bt.prototype,"unmuteLocal"),Bt.prototype),Oe(Bt.prototype,"close",[Da],Object.getOwnPropertyDescriptor(Bt.prototype,"close"),Bt.prototype),Oe(Bt.prototype,"updateEncoderConfig",[Da],Object.getOwnPropertyDescriptor(Bt.prototype,"updateEncoderConfig"),Bt.prototype),Oe(Bt.prototype,"updateSendParameters",[Da],Object.getOwnPropertyDescriptor(Bt.prototype,"updateSendParameters"),Bt.prototype),Oe(Bt.prototype,"replaceTrack",[Da],Object.getOwnPropertyDescriptor(Bt.prototype,"replaceTrack"),Bt.prototype),Oe(Bt.prototype,"getRemoteSSRC",[Da],Object.getOwnPropertyDescriptor(Bt.prototype,"getRemoteSSRC"),Bt.prototype),Bt);function Da(n,e,t){let i=n[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return t.value=async function(){let r=this.mutex,o=await r.lock("From DataChannelConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},t}function aa(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),t.push.apply(t,i)}return t}class ox extends Ki{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var t;z(t=["tryNext","recover"]).call(t,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(gr.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(gr.CONNECTED):this._state==="closed"?this.emit(gr.CLOSED):this._state==="failed"&&this.emit(gr.FAILED))}constructor(e,t,i,r){super(),U(this,"connectionID",0),U(this,"currentURLIndex",0),U(this,"reconnectReason",void 0),U(this,"_reconnectMode","tryNext"),U(this,"_initMutex",void 0),U(this,"_name",void 0),U(this,"_state","closed"),U(this,"_reconnectInterrupter",void 0),U(this,"_url",void 0),U(this,"_retryConfig",void 0),U(this,"_reconnectCount",0),U(this,"_forceCloseTimeout",5e3),U(this,"_onlineReconnectListener",void 0),U(this,"_closeEstablishingTransmitter",()=>{}),U(this,"_store",void 0),U(this,"_joinChannelServiceRecordIndex",void 0),U(this,"_transmitter",void 0),U(this,"_useCompress",void 0),U(this,"_inflateLength",0),U(this,"_deflateLength",0),this._store=r,this._name=e,this._retryConfig=function(o){for(var s=1;s<arguments.length;s++){var a=arguments[s]!=null?arguments[s]:{};s%2?aa(Object(a),!0).forEach(function(c){U(o,c,a[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(a)):aa(Object(a)).forEach(function(c){Object.defineProperty(o,c,Object.getOwnPropertyDescriptor(a,c))})}return o}({},t),this._useCompress=i}resetReconnectCount(e){y.debug("".concat(this._name," reset reconnect count, reason: ").concat(e)),this._reconnectCount=0}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;let i=this._transmitter;t?setTimeout(()=>i.close(),500):i.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(e,t){if(!this._transmitter)return void y.warning("[".concat(this._name,"] can not reconnect, no websocket"));var i;e!==void 0&&(this.reconnectMode=e),y.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((i=this._store)===null||i===void 0||i.recordJoinChannelService({status:"error",errors:[new Error(t)]},this._joinChannelServiceRecordIndex));let r=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),r&&r.bind(this._transmitter)({code:9999,reason:t})}getInflateData(){let e=this._inflateLength,t=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:t}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}let sl=function(n){return n[n.Default=0]="Default",n[n.Ack=1]="Ack",n}({});class al{constructor(e,t,i){U(this,"version",1),U(this,"initialRTO",void 0),U(this,"maxBatchAckCount",void 0),U(this,"maxRTO",void 0),U(this,"initialRTT",void 0),U(this,"ID",void 0),U(this,"rtt",void 0),U(this,"packetNumber",1),U(this,"rtoRatioMap",new Map),U(this,"timeoutMap",new Map),U(this,"unorderedPacketQueue",[]),U(this,"batchAckPacketQueue",[]),U(this,"lastOrderedPacketNumber",0),U(this,"batchAckTimer",void 0),U(this,"sendImpl",void 0),U(this,"receiveImpl",void 0),this.sendImpl=e,this.receiveImpl=t,this.ID=vt(7,"transmitter-"),this.initialRTO=(i==null?void 0:i.initialRTO)!==void 0?i.initialRTO:F("TRANSMITTER_INITIAL_RTO"),this.initialRTT=(i==null?void 0:i.initialRTT)!==void 0?i.initialRTT:F("TRANSMITTER_INITIAL_RTT"),this.rtt=(i==null?void 0:i.initialRTT)!==void 0?i.initialRTT:F("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=(i==null?void 0:i.maxBatchAckCount)!==void 0?i.maxBatchAckCount:F("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=(i==null?void 0:i.maxRTO)!==void 0?i.maxRTO:F("TRANSMITTER_MAX_RTO")}packetize(e,t){return{type:sl.Default,version:this.version,packetNumber:t,payload:e}}serialize(e){switch(e.type){case sl.Default:{let t;typeof e.payload=="string"?t=new TextEncoder().encode(e.payload):t=e.payload;let i=new ArrayBuffer(t.length+15),r=new DataView(i);return r.setUint16(0,e.version),r.setUint8(2,e.type),r.setUint32(3,e.packetNumber),PN(r,7,BigInt(e.sendTs)),new Uint8Array(r.buffer).set(t,15),i}case sl.Ack:{let t=new ArrayBuffer(16),i=new DataView(t);return i.setUint16(0,e.version),i.setUint8(2,e.type),i.setUint32(3,e.maxAckPacketNumber),i.setUint8(7,e.shift),PN(i,8,BigInt(e.ackSendTs)),t}}}deserialize(e){let t=new DataView(e),i=t.getUint16(0),r=t.getUint8(2);switch(r){case sl.Default:{let o=t.getUint32(3),s=DN(t,7),a=e.slice(15),c=new Uint8Array(a);return{version:i,type:r,packetNumber:o,sendTs:Number(s),payload:c}}case sl.Ack:{let o=t.getUint32(3),s=t.getUint8(7),a=DN(t,8);return{version:i,type:r,maxAckPacketNumber:o,shift:s,ackSendTs:Number(a)}}default:throw y.error("[".concat(this.ID,"] Unrecognized packet type ").concat(r)),new Error("Unrecognized packet type ".concat(r))}}sendMessage(e){F("DC_DEBUG_LOG")&&typeof e=="string"&&y.debug("[".concat(this.ID,"] sending message packet"),JSON.parse(e));let t=this.packetize(e,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;let i=this.calculateRTO(t),r=window.setTimeout(()=>{this.resendMessage(t)},i);this.timeoutMap.set(t.packetNumber,r),this.sendPacket(t)}onData(e){let t=this.deserialize(e);t.type===sl.Default?this.ack(t):t.type===sl.Ack&&(this.updateRTT(t,Math.round(performance.now())),this.clearRTO(t))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach(e=>{let[t,i]=e;window.clearTimeout(i)}),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(e){let t=this.calculateRTO(e),i=window.setTimeout(()=>{F("DC_DEBUG_LOG")&&typeof e.payload=="string"&&y.debug("[".concat(this.ID,"] resending message packet"),JSON.parse(e.payload),"timeout: ".concat(t)),this.resendMessage(e)},t);this.timeoutMap.set(e.packetNumber,i),this.sendPacket(e)}calculateRTO(e){let t=this.rtoRatioMap.get(e.packetNumber);if(t===void 0)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{let i=9*this.rtt/8*t;return this.rtoRatioMap.set(e.packetNumber,t+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(e,t){let i=e.ackSendTs;this.rtt=this.rtt*(7/8)+(t-i-this.rtt)/8}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout(()=>{this.batchAck()},this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){let t=this.unorderedPacketQueue[0];if(!t){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(t.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(e.packetNumber<=this.lastOrderedPacketNumber){let t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:sl.Ack,version:this.version};F("DC_DEBUG_LOG")&&y.debug("[".concat(this.ID,"] sending ack packet"),t,"packetNumber: ".concat(e.packetNumber)),this.sendPacket(t)}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;let t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:sl.Ack,version:this.version};F("DC_DEBUG_LOG")&&y.debug("[".concat(this.ID,"] sending ack packet"),t,"packetNumber: ".concat(e.packetNumber)),this.sendPacket(t)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;let e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:sl.Ack,version:this.version};F("DC_DEBUG_LOG")&&y.debug("[".concat(this.ID,"] sending batch ack packet"),e,"shift: ".concat(this.batchAckPacketQueue.length-1)),this.sendPacket(e),this.batchAckPacketQueue=[]}sendPacket(e){e.type===sl.Default&&(e.sendTs=Math.round(performance.now()));let t=this.serialize(e);this.sendImpl(t)}clearRTO(e){for(let t=e.maxAckPacketNumber-e.shift;t<=e.maxAckPacketNumber;t++){let i=this.timeoutMap.get(t);i!==void 0&&window.clearTimeout(i),this.timeoutMap.delete(t),this.rtoRatioMap.delete(t)}}}class sx extends ox{constructor(e,t){super(e,t,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),U(this,"_initMutex",void 0),U(this,"_reconnectInterrupter",void 0),U(this,"_url",void 0),U(this,"_transmitter",void 0),U(this,"_addresses",void 0),U(this,"_reliableTransmission",void 0),U(this,"_textEncoder",void 0),U(this,"_textDecoder",void 0),this._textEncoder=new TextEncoder,this._textDecoder=new TextDecoder,this._initMutex=new mn("datachannel");let{timeout:i,timeoutFactor:r}=t,o=Math.max(300,Math.floor(3*i/5)),s=Math.max(1.2,Math.floor(8*r)/10);Gi.ONLINE&&(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=s),Wi.on(yn.NETWORK_STATE_CHANGE,(a,c)=>{a!==c&&(this.resetReconnectCount("network state change: ".concat(c," -> ").concat(a)),a===Gi.ONLINE?(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=s):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=r))})}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=t;let i=(r,o)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex(a=>a.fingerprint||F("FINGERPRINT"));let s=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(s).then(r).catch(o),this.once(gr.CLOSED,()=>o(new H(L.WS_DISCONNECT))),this.once(gr.CONNECTED,()=>r())};return this._initMutex.lock().then(r=>new Z((o,s)=>{i(o,s)}).then(()=>{r()}).catch(()=>{r()}))}async sendMessage(e){let t=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new H(L.WS_ABORT,"datachannel is not ready");try{t||(e=JSON.stringify(e));let i=this._textEncoder.encode(e),r=s9(i,{raw:!0});this._reliableTransmission.sendMessage(r)}catch(i){throw new H(L.WS_ERR,"send datachannel signal message error"+i.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){let t=JSON.stringify(e);return{compressed:t,compressedLength:t.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(e){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(e.ip,":").concat(e.port),new Z((t,i)=>{var r;let o=()=>{y.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="recover",this.state="connected",this.resetReconnectCount("opened"),t()},s=async l=>{var h;if((h=this._closeEstablishingTransmitter)===null||h===void 0||h.call(this),y.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(l.code,", reason: ").concat(l.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=l.reason,this.state="reconnecting");let p=Xt(this,gr.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,f=await this.reconnectWithAction(p);if(this.state==="closed")return void y.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!f)return i(new H(L.WS_DISCONNECT,"datachannel reconnect failed: ".concat(l.code))),void this.close(!0);t()}else i(new H(L.WS_DISCONNECT,"datachannel close: ".concat(l.code))),this.close()},a=async l=>{try{var h;(h=this._reliableTransmission)===null||h===void 0||h.onData(l.data)}catch(p){console.log(p)}};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),y.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(e)));let c=(r=this._store)===null||r===void 0?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),d=Date.now();fr(this,gr.TO_CONNECT_DATACHANNEL).then(l=>{var h,p;if(!l)throw new Error("transmissonInfo not exist yet");let{transmitter:f,close:m}=l;this._transmitter=f,(h=this._store)===null||h===void 0||h.signalChannelOpen();let g=Date.now()-d;y.debug("[choose dc] dc open cost ".concat(g,"ms")),this._reliableTransmission=new al(S=>{var T;this._transmitter&&this._transmitter.readyState==="open"&&((T=this._transmitter)===null||T===void 0||T.send(S))},S=>{if(typeof S=="string")this.emit(gr.ON_MESSAGE,S);else{let T=c9(S,{raw:!0}).buffer,C=this._textDecoder.decode(T);this.emit(gr.ON_MESSAGE,C)}}),this._closeEstablishingTransmitter=()=>{var S;(S=this._reliableTransmission)===null||S===void 0||S.close(),this._reliableTransmission=void 0,m()},o&&o(),f.onclose=s,f.onmessage=a,(p=this._store)===null||p===void 0||p.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this._joinChannelServiceRecordIndex=c}).catch(l=>{var h;if((h=this._store)===null||h===void 0||h.recordJoinChannelService({endTs:Date.now(),status:l instanceof H&&l.code===L.WS_ABORT?"aborted":"error",errors:[l]},c),this.state!=="closed"){if(l instanceof H&&l.code===L.WS_ERR){let p=new H(L.WS_ERR,"init datachannel failed! Error: ".concat(l.toString()));return y.error("[".concat(this._name,"]").concat(p)),void i(p)}s&&s(l)}else i(new H(L.WS_DISCONNECT,"datachannel is closed: ".concat(l.toString())))})})}async reconnectWithAction(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||Wi.networkState!==Gi.OFFLINE||(this._onlineReconnectListener=Wi.onlineWaiter&&Wi.onlineWaiter.then(()=>{this._onlineReconnectListener=void 0}));let i=!0;if(this._reconnectInterrupter=()=>{i=!1},t){let a=yr(this._reconnectCount,this._retryConfig);y.debug("[".concat(this._name,"] wait ").concat(a,"ms to reconnect datachannel, mode: ").concat(e)),await Z.race([fn(a),this._onlineReconnectListener||new Z(()=>{})])}if(this.state==="closed"||!i)return!1;this._reconnectCount+=1;let r=async(a,c)=>{this.emit(gr.RECONNECT_CREATE_CONNECTION,c),await this.createTransmitterConnection(a)};try{if(e==="retry"){let a=this._addresses[this.currentURLIndex];await r(a,e)}else if(e==="tryNext"){this.currentURLIndex+=1;for(let c=this.currentURLIndex;c<this._addresses.length;c++){if(this._addresses[c].fingerprint||F("FINGERPRINT")){this.currentURLIndex=c;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return y.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);y.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));let a=this._addresses[this.currentURLIndex];await r(a,e)}else e==="recover"&&(y.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(gr.FAILBACK));return!0}catch(a){var o,s;return y.error("[".concat(this._name,"] reconnect failed"),a.toString()),a!=null&&(o=a.data)!==null&&o!==void 0&&o.desc&&Array.isArray(a.data.desc)&&a.data.desc.length&&z(s=a.data.desc).call(s,"dynamic key expired")?(this.emit(gr.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,t)}}}class ax extends Ki{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===ye.CONNECTED?this.emit(Ee.WS_CONNECTED):e===ye.RECONNECTING?this.emit(Ee.WS_RECONNECTING,this._websocketReconnectReason):e===ye.CLOSED&&this.emit(Ee.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}processPendingNotifications(){this.pendingNotifications.length!==0&&(y.debug("[".concat(this.clientId,"] processing ").concat(this.pendingNotifications.length," pending notifications")),this.pendingNotifications.forEach(e=>{let{type:t,message:i}=e;this.emit(t,i),t===it.ON_NOTIFICATION&&this.handleNotification(i),t===it.ON_USER_BANNED&&this.handleUserBanned(i)}),this.pendingNotifications=[])}handleUserBanned(e){switch(e.error_code){case 14:this.close(Gt.UID_BANNED);break;case 15:this.close(Gt.IP_BANNED);break;case 16:this.close(Gt.CHANNEL_BANNED)}}constructor(e,t){super(),U(this,"__name__","DataChannelSignal"),U(this,"_disconnectedReason",void 0),U(this,"_websocketReconnectReason",void 0),U(this,"_connectionState",ye.CLOSED),U(this,"reconnectToken",void 0),U(this,"websocket",void 0),U(this,"openConnectionTime",void 0),U(this,"clientId",void 0),U(this,"lastMsgTime",Date.now()),U(this,"uploadCache",[]),U(this,"uploadCacheInterval",void 0),U(this,"rttRolling",new Lf(5)),U(this,"pingpongTimer",void 0),U(this,"inflateDataTimer",void 0),U(this,"pingpongTimeoutCount",0),U(this,"ortc",void 0),U(this,"joinResponse",void 0),U(this,"multiIpOption",void 0),U(this,"initError",void 0),U(this,"spec",void 0),U(this,"store",void 0),U(this,"isJoining",!1),U(this,"pendingNotifications",[]),U(this,"onWebsocketMessage",i=>{if(i instanceof ArrayBuffer)return void this.emit(Ee.ON_BINARY_DATA,i);let r=JSON.parse(i);if(F("DC_DEBUG_LOG")&&y.debug("[datachannel-signal] received packet",r),this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){let o="res-@".concat(r._id);this.emit(o,r._result,r._message)}else Object.prototype.hasOwnProperty.call(r,"_type")&&(this.isJoining?r._type===it.ON_NOTIFICATION||r._type===it.ON_USER_BANNED?(this.emit(r._type,r._message),r._type===it.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===it.ON_USER_BANNED&&this.handleUserBanned(r._message)):(this.pendingNotifications.push({type:r._type,message:r._message}),y.debug("[".concat(this.clientId,"] cached notification during join: ").concat(r._type))):(this.emit(r._type,r._message),r._type===it.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===it.ON_USER_BANNED&&this.handleUserBanned(r._message)))}),this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new sx("gateway-".concat(this.clientId),this.spec.retryConfig,!0,t),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===ye.CONNECTED&&this.reconnect("retry",br.OFFLINE)})}async request(e,t,i,r){let o=vt(6,""),s={_id:o,_type:e,_message:t},a=this.websocket.connectionID,c=()=>new Z((m,g)=>{if(this.connectionState===ye.CONNECTED)return m();let S=()=>{this.off(Ee.WS_CLOSED,T),m()},T=()=>{this.off(Ee.WS_CONNECTED,S),g(new H(L.WS_ABORT))};this.once(Ee.WS_CONNECTED,S),this.once(Ee.WS_CLOSED,T),e!==le.PUBLISH&&e!==le.SUBSCRIBE&&e!==le.UNSUBSCRIBE&&e!==le.UNPUBLISH&&e!==le.CONTROL&&e!==le.RESTART_ICE||this.once(Ee.DISCONNECT_P2P,()=>{g(new H(L.DISCONNECT_P2P))}),e!==le.PUBLISH&&e!==le.RESTART_ICE||this.once(Ee.ABORT_P2P_EXECUTION,()=>{g(new H(L.DISCONNECT_P2P))})});if(this.connectionState!==ye.CONNECTING&&this.connectionState!==ye.RECONNECTING||e===le.JOIN||e===le.REJOIN||await c(),e===le.LEAVE&&(this.websocket.unbindDcCloseEventListener(),r=!0),F("DC_DEBUG_LOG")&&y.debug("[datachannel-signal] sendMessage",s),await this.websocket.sendMessage(s,!0,!1),r)return;let d=new Z((m,g)=>{let S=!1,T=(b,D)=>{S=!0,m({isSuccess:b==="success",message:D||{}}),this.off(Ee.WS_CLOSED,C),this.off(Ee.WS_RECONNECTING,C),this.emit(Ee.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(o),T);let C=()=>{g(new H(L.WS_ABORT,"type: ".concat(e))),this.off(Ee.WS_CLOSED,C),this.off(Ee.WS_RECONNECTING,C),this.off("res-@".concat(o),T)};this.once(Ee.WS_CLOSED,C),this.once(Ee.WS_RECONNECTING,C),fn(F("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||S||(y.warning("dc request timeout, type: ".concat(e)),this.emit(Ee.REQUEST_TIMEOUT,e,t))})}),l=null;try{l=await d}catch(m){if(this.connectionState===ye.CLOSED||e===le.LEAVE)throw new H(L.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?m.throw():e===le.JOIN||e===le.REJOIN?null:(await c(),await this.request(e,t))}if(l.isSuccess)return l.message;let h=Number(l.message.error_code||l.message.code),p=k_(h),f=new H(L.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(l.message.error_str),{code:h,data:l.message});return p.action==="success"?l.message:(y.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(h,", message: ").concat(p.desc,", action: ").concat(p.action)),h===Fe.ERR_TOO_MANY_BROADCASTERS?((e===le.JOIN||e===le.REJOIN)&&(this.initError=f,this.close()),f.throw()):p.action==="failed"?f.throw():p.action==="quit"?(this.initError=f,this.close(),f.throw()):(h===Fe.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,y.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",br.MULTI_IP)):this.reconnect(p.action,br.SERVER_ERROR),e===le.JOIN||e===le.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new Z(i=>{let r=o=>{(!t||t(o))&&(this.off(e,r),i(o))};this.on(e,r)})}uploadWRTCStats(e){if(!this.store.sessionId)return void y.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let t={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(Be.WRTC_STATS,t)}upload(e,t){let i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch{let r=F("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>r&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==ye.CONNECTED)return;let o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},F("UPLOAD_CACHE_INTERVAL")||2e3))}}async send(e,t){let i={_type:e,_message:t};await this.websocket.sendMessage(i)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Z((t,i)=>{this.once(Ee.WS_CONNECTED,()=>t(this.joinResponse)),this.once(Ee.WS_CLOSED,()=>i(this.initError||new H(L.WS_ABORT))),this.connectionState=ye.CONNECTING,this.websocket.init(e).catch(i),this.websocket.once(gr.FAILBACK,()=>{i(new H(L.INIT_DATACHANNEL_TIMEOUT))}),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval(()=>{this.handleInflateData()},2e4),setTimeout(()=>{this.openConnectionTime===void 0&&(y.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),i(new H(L.INIT_DATACHANNEL_TIMEOUT)))},F("DC_JOIN_WITH_FAILBACK"))})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this.isJoining=!1,this.pendingNotifications=[],this._disconnectedReason=e||Gt.LEAVE,this.connectionState=ye.CLOSED,y.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),e===Gt.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new sx("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),F("DC_PINGPONG_INTERVAL")),!this.joinResponse){this.emit(Ee.ABORT_P2P_EXECUTION),this.store.signalConnected();let e=await fr(this,Ee.REQUEST_JOIN_INFO);this.store.joinReq(),this.isJoining=!0,this.pendingNotifications=[];let t=await this.request(le.JOIN,e);if(this.store.joinRep(),this.ortc=e==null?void 0:e.ortc,!t)return this.emit(Ee.REPORT_JOIN_GATEWAY,L.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(Ee.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=ye.CONNECTED,this.isJoining=!1,this.processPendingNotifications(),!0}async rejoin(){if(!this.reconnectToken)throw new H(L.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");let e=co(this,Ee.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;let t=await this.request(le.REJOIN,e);return!!t&&(this.connectionState=ye.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),F("DC_PINGPONG_INTERVAL")),t.peers&&t.peers.forEach(i=>{this.emit(it.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(it.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(it.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(it.MUTE_AUDIO,{uid:i.uid}):this.emit(it.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(it.MUTE_VIDEO,{uid:i.uid}):this.emit(it.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(it.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(it.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(it.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(it.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(it.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})}),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}async downgradeCodec(e){if(!this.ortc)return!1;let t={downgrade_codec:e,ortc:this.ortc};return!!await this.request(le.DOWNGRADE_CODEC,t)}handleNotification(e){y.debug("[".concat(this.clientId,"] receive notification: "),e);let t=k_(e.code);if(t.action!=="success"){if(t.action!=="failed")return t.action==="quit"?(t.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Gt.UID_BANNED),void this.close()):void this.reconnect(t.action,br.SERVER_ERROR);y.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1,F("DC_DEBUG_LOG")&&console.debug("[datachannel-signal] pingpongTimeoutCount: ".concat(this.pingpongTimeoutCount));let e=F("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(y.warning("[datachannel-signal] PINGPONG Timeout. Last Socket Message: ".concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>F("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("recover",br.FALLBACK):this.request(le.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let i=Date.now()-t;this.rttRolling.add(i),F("REPORT_STATS")&&this.send(le.PING_BACK,{pingpongElapse:i})}).catch(i=>{})}handleInflateData(){let{inflateLength:e,deflateLength:t}=this.websocket.getInflateData();e!==0&&t!==0&&this.upload(Be.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(gr.RECONNECT_CREATE_CONNECTION,e=>{this.emit(Ee.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(gr.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(gr.CLOSED,()=>{this.connectionState=ye.CLOSED}),this.websocket.on(gr.FAILED,()=>{this._disconnectedReason=Gt.NETWORK_ERROR,this.connectionState=ye.CLOSED}),this.websocket.on(gr.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===ye.CONNECTED?this.connectionState=ye.RECONNECTING:this.connectionState=ye.CONNECTING}),this.websocket.on(gr.WILL_RECONNECT,(e,t)=>{if(co(this,Ee.IS_P2P_DISCONNECTED)&&e==="retry")return y.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(Ee.NEED_RENEW_SESSION),this.emit(Ee.DISCONNECT_P2P),t("tryNext");e!=="retry"&&(y.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(Ee.NEED_RENEW_SESSION),this.emit(Ee.DISCONNECT_P2P)),t(e)}),this.websocket.on(gr.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{y.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",br.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(Ee.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof H&&e.code===L.UNEXPECTED_RESPONSE&&e.data.code===Fe.ERR_NO_AUTHORIZED)return y.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",br.SERVER_ERROR);y.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",br.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(gr.REQUEST_NEW_URLS,(e,t)=>{fr(this,Ee.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)}),this.websocket.on(gr.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(it.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(gr.TO_CONNECT_DATACHANNEL,(e,t)=>{fr(this,Ee.PRE_CONNECT_PC).then(e).catch(t)}),this.websocket.on(gr.FAILBACK,()=>{this.openConnectionTime!==void 0&&this.emit(Ee.DATACHANNEL_FAILBACK)})}}let b9={name:"DataChannelConnection",create:function(n){let{store:e,spec:t}=n;return new Ey(t,e)}},O9={name:"DataChannelSignal",create:function(n){let{store:e,spec:t}=n;return new ax(t,e)}};Nv(),$e("PROCESS_ID","process-".concat(vt(8,""),"-").concat(vt(4,""),"-").concat(vt(4,""),"-").concat(vt(4,""),"-").concat(vt(12,""))),function(){let n;try{n=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void y.error("Error loading sdk config",e.message)}if(n)try{let e=JSON.parse(window.atob(n)),t=Date.now();y.debug("Loading global parameters from cache",e),Object.keys(e).forEach(i=>{if(Object.prototype.hasOwnProperty.call(Si,i)){let{value:r,expires:o}=e[i];if(o&&o<=t)return;Zs[i]=r,Si[i]=r}})}catch(e){y.error("Error loading mutableParamsCache: ".concat(n),e.message)}}(),Array.isArray(Zs.AREAS)&&Zs.AREAS.length>0&&fC(Zs.AREAS,!0);let cx=(n,e,t)=>{y.debug("setParameter key:".concat(n,", value:").concat(JSON.stringify(e))),$e(n,e,t)};Yd(h9,!1),Yd(p9,!1),Yd(m2,!1),Yd(T9,!1),Yd(d9,!1),Yd(I9,!1),Yd(gc,!1),Yd(w9,!1),Yd(b9,!1),Yd(O9,!1);let Kr=function(n){let e=new Ki,t=n,i={getListeners:e.getListeners.bind(e),on:(r,o)=>(function(s,a){s===$i.SECURITY_POLICY_VIOLATION&&xC(a,!0)}(r,o),e.on.bind(e)(r,o)),addListener:e.addListener.bind(e),once:e.once.bind(e),off:e.off.bind(e),removeAllListeners:e.removeAllListeners.bind(e),emit:e.emit.bind(e),safeEmit:e.safeEmit.bind(e)};return Ik(Ik({},t),i)}({__TRACK_LIST__:Cl,VERSION:Js,BUILD:oT,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:cx,getParameter:F,getSupportedCodec:async function(){let n={audio:[],video:[]};try{let e=new RTCPeerConnection,t=await async function(i){let r;return ot().supportUnifiedPlan?(i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"}),r=(await i.createOffer()).sdp):r=(await i.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,r}(e);if(!t)return n;e.close(),e=null,n=function(i){let r={video:[],audio:[]};return i.match(/ VP8/i)&&r.video.push("VP8"),i.match(/ VP9/i)&&r.video.push("VP9"),i.match(/ AV1/i)&&r.video.push("AV1"),i.match(/ H264/i)&&r.video.push("H264"),i.match(/ H265/i)&&r.video.push("H265"),i.match(/ opus/i)&&r.audio.push("OPUS"),i.match(/ PCMU/i)&&r.audio.push("PCMU"),i.match(/ PCMA/i)&&r.audio.push("PCMA"),i.match(/ G722/i)&&r.audio.push("G722"),r}(t)}catch(e){throw new H(L.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return n},checkSystemRequirements:function(){let n=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0],e=_e.reportApiInvoke(null,{name:Yi.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:ct.TRACER}),t=function(){let o=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0],s=!1;try{let a=window.RTCPeerConnection,c=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,d=window.WebSocket;s=!(!a||!d),o&&!c&&(s=!1),s&&ha()&&bc(75)&&new a().close()}catch(a){y.error("check system requirement failed: ",a),s=!1}return s}(n),i=S2();y.debug("checkSystemRequirements, api:",t,"browser",i);let r=t&&i;return e.onSuccess(r),F("IGNORE_RTC_DEVICE_CHECK")?t:r},getDevices:function(n){return Po.enumerateDevices(!0,!0,n)},getMicrophones:function(n){return Po.getRecordingDevices(n)},getCameras:function(n){return Po.getCamerasDevices(n)},getElectronScreenSources:LU,getPlaybackDevices:function(n){return Po.getSpeakers(n)},createClient:g2,createCameraVideoTrack:async function(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=F("CAMERA_CAPTURE_CONFIG"),t=vt(8,"track-cam-"),i=_e.reportApiInvoke(null,{id:t,tag:ct.TRACER,name:Yi.CREATE_CAM_VIDEO_TRACK,options:[ki({},n),e]});e&&(n.encoderConfig=e);let r=lT(n),o=null;y.info("start create camera video track with config",JSON.stringify(n),"trackId",t);try{o=(await $s({video:r},t)).getVideoTracks()[0]||null}catch(a){throw i.onError(a),a}if(!o){let a=new O(L.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(a),a.throw(y)}if(n.optimizationMode&&qv(t,o,n,Oc(n.encoderConfig)),F("USE_STANDARD_BITRATE_DEFAULT")){let a=Oc(n.encoderConfig);n.encoderConfig=a,delete a.bitrateMax,delete a.bitrateMin}let s=new yi(o,n,r,n.scalabiltyMode?Hf(n.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},n.optimizationMode,t);return i.onSuccess(s.getTrackId()),y.info("create camera video success, trackId:",t),s},createCustomVideoTrack:function(n){let e=vt(8,"track-cus-"),t=_e.reportApiInvoke(null,{id:e,tag:ct.TRACER,name:Yi.CREATE_CUSTOM_VIDEO_TRACK,options:[n]});F("USE_STANDARD_BITRATE_DEFAULT")&&(delete n.bitrateMax,delete n.bitrateMin);let i=new Jt(n.mediaStreamTrack,{width:n.width,height:n.height,frameRate:n.frameRate,bitrateMax:n.bitrateMax,bitrateMin:n.bitrateMin},n.scalabiltyMode?Hf(n.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},n.optimizationMode,e,[Re.CUSTOM_TRACK]);return t.onSuccess(i.getTrackId()),y.info("create custom video track success with config",n,"trackId",i.getTrackId()),i},createScreenVideoTrack:async function(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable",t=typeof e=="object"?function(p){let f=uT(p);return YN()&&p.suppressLocalAudioPlayback&&(f.suppressLocalAudioPlayback=p.suppressLocalAudioPlayback),zN()&&p.restrictOwnAudio&&(f.restrictOwnAudio=!0),f}(e):void 0;t&&(e="auto");let i=vt(8,"track-scr-v-"),r=_e.reportApiInvoke(null,{id:i,tag:ct.TRACER,name:Yi.CREATE_SCREEN_VIDEO_TRACK,options:[ki({},n),e]});n.encoderConfig?typeof n.encoderConfig=="string"||n.encoderConfig.width&&n.encoderConfig.height||(n.encoderConfig.width={max:1920},n.encoderConfig.height={max:1080}):n.encoderConfig="1080p_2";let o=function(p){let f={};p.screenSourceType&&(f.mediaSource=p.screenSourceType),p.extensionId&&wc()&&(f.extensionId=p.extensionId);let{displaySurface:m,selfBrowserSurface:g,surfaceSwitching:S,systemAudio:T,preferCurrentTab:C,windowAudio:b,monitorTypeSurfaces:D}=p;(Dr(107)||Tl(107)||Cu(93))&&(m&&(xi(m,"displaySurface",["browser","window","monitor"]),f.displaySurface=m),g?(xi(g,"selfBrowserSurface",["exclude","include"]),f.selfBrowserSurface=g):f.selfBrowserSurface="include",S&&(xi(S,"surfaceSwitching",["exclude","include"]),f.surfaceSwitching=S)),(Dr(105)||Tl(105)||Cu(91))&&T&&(xi(T,"systemAudio",["exclude","include"]),f.systemAudio=T),(Dr(94)||Tl(94)||Cu(80))&&C&&(f.preferCurrentTab=!0),(Dr(141)||Tl(141)||Cu(125))&&b&&(xi(b,"windowAudio",["exclude","system"]),f.windowAudio=b),(Dr(119)||Tl(119)||Cu(105))&&D&&(xi(D,"monitorTypeSurfaces",["exclude","include"]),f.monitorTypeSurfaces=D),p.electronScreenSourceId&&(f.sourceId=p.electronScreenSourceId);let x=p.encoderConfig?Ta(p.encoderConfig):null;return f.mandatory={chromeMediaSource:"desktop",maxWidth:x?x.width:void 0,maxHeight:x?x.height:void 0},x&&(x.frameRate&&(typeof x.frameRate=="number"?(f.mandatory.maxFrameRate=x.frameRate,f.mandatory.minFrameRate=x.frameRate):(f.mandatory.maxFrameRate=x.frameRate.max||x.frameRate.ideal||x.frameRate.exact||void 0,f.mandatory.minFrameRate=x.frameRate.min||x.frameRate.ideal||x.frameRate.exact||void 0),f.frameRate=x.frameRate),x.width&&(f.width=x.width),x.height&&(f.height=x.height)),f}(n),s=null,a=null,c=ot();if(!c.supportShareAudio&&e==="enable"){let p=new O(L.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return r.onError(p),p.throw(y)}y.info("start create screen video track with config",n,"withAudio",e,"trackId",i);let d=c.supportShareAudio&&e!=="disable";try{let p=await $s({screen:o,screenAudio:d?t||!0:void 0},i);s=p.getVideoTracks()[0]||null,a=p.getAudioTracks()[0]||null}catch(p){throw r.onError(p),p}if(!s){let p=new O(L.UNEXPECTED_ERROR,"can not find track in media stream");return r.onError(p),p.throw(y)}if(!a&&e==="enable"){s&&s.stop();let p=new O(L.SHARE_AUDIO_NOT_ALLOWED);return r.onError(p),p.throw(y)}n.optimizationMode||(n.optimizationMode="detail"),n.optimizationMode&&(qv(i,s,n,n.encoderConfig&&Ta(n.encoderConfig)||void 0),n.encoderConfig&&typeof n.encoderConfig!="string"&&(n.encoderConfig.bitrateMin=n.encoderConfig.bitrateMax));let l=new Jt(s,n.encoderConfig?Ta(n.encoderConfig):{},n.scalabiltyMode?Hf(n.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},n.optimizationMode,i,[Re.SCREEN_TRACK]);if(!a)return r.onSuccess(l.getTrackId()),y.info("create screen video track success","video:",l.getTrackId()),l;let h=new ri(a,void 0,vt(8,"track-scr-a-"),!1);return r.onSuccess([l.getTrackId(),h.getTrackId()]),y.info("create screen video track success","video:",l.getTrackId(),"audio:",h.getTrackId()),[l,h]},createMicrophoneAndCameraTracks:async function(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},t=F("CAMERA_CAPTURE_CONFIG"),i=vt(8,"track-mic-"),r=vt(8,"track-cam-"),o=_e.reportApiInvoke(null,{id:"".concat(i,"-").concat(r),tag:ct.TRACER,name:Yi.CREATE_MIC_AND_CAM_TRACKS,options:[n,e,t]});t&&(e.encoderConfig=t);let s=lT(e),a=iD(n),c=null,d=null;y.info("start create camera video track(".concat(r,") and microphone audio track(").concat(i,") with config, audio: ").concat(JSON.stringify(n),", video: ").concat(JSON.stringify(e)));try{let p=await $s({audio:a,video:s},"".concat(i,"-").concat(r));c=p.getAudioTracks()[0],d=p.getVideoTracks()[0]}catch(p){throw o.onError(p),p}if(!c||!d){let p=new O(L.UNEXPECTED_ERROR,"can not find tracks in media stream");return o.onError(p),p.throw(y)}if(e.optimizationMode&&qv(r,d,e,Oc(e.encoderConfig)),F("USE_STANDARD_BITRATE_DEFAULT")){let p=Oc(e.encoderConfig);e.encoderConfig=p,delete p.bitrateMax,delete p.bitrateMin}let l=new Zi(c,n,a,i),h=new yi(d,e,s,e.scalabiltyMode?Hf(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,r);return o.onSuccess([l.getTrackId(),h.getTrackId()]),y.info("create camera video track(".concat(r,") and microphone audio track(").concat(i,") success")),[l,h]},createMicrophoneAudioTrack:async function(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=vt(8,"track-mic-"),t=_e.reportApiInvoke(null,{id:e,tag:ct.TRACER,name:Yi.CREATE_MIC_AUDIO_TRACK,options:[n]}),i=iD(n),r=null;y.info("start create microphone audio track with config",JSON.stringify(n),"trackId",e);try{r=(await $s({audio:i},e)).getAudioTracks()[0]||null}catch(s){throw t.onError(s),s}if(!r){let s=new O(L.UNEXPECTED_ERROR,"can not find track in media stream");return t.onError(s),s.throw(y)}let o=new Zi(r,n,i,e);return t.onSuccess(o.getTrackId()),y.info("create microphone audio track success, trackId:",e),o},createCustomAudioTrack:fT,createBufferSourceAudioTrack:async function(n){var e;let{cacheOnlineFile:t,encoderConfig:i}=n,{source:r}=n,o={source:r instanceof AudioBuffer?"AudioBuffer":r instanceof File?(e=File.name)!==null&&e!==void 0?e:"File":r,cacheOnlineFile:t,encoderConfig:i},s=vt(8,"track-buf-"),a=_e.reportApiInvoke(null,{id:s,tag:ct.TRACER,name:Yi.CREATE_BUFFER_AUDIO_TRACK,options:[o]});if(F("DISABLE_WEBAUDIO"))throw new O(L.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");y.info("start create buffer source audio track with config",JSON.stringify(o),"trackId",s);let c=r;if(!(r instanceof AudioBuffer))try{r=await async function(h,p){let f=null;if(typeof h=="string"){let g=UU.get(h);if(g)return y.debug("use cached audio resource: ",h),g;try{f=(await fa(()=>Qi.get(h,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(S){throw new O(L.FETCH_AUDIO_FILE_FAILED,S.toString())}}else f=await new Z((g,S)=>{let T=new FileReader;T.onload=C=>{C.target?g(C.target.result):S(new O(L.READ_LOCAL_AUDIO_FILE_ERROR))},T.onerror=()=>{S(new O(L.READ_LOCAL_AUDIO_FILE_ERROR))},T.readAsArrayBuffer(h)});let m=await function(g){let S=Ei();return new Z((T,C)=>{S.decodeAudioData(g,b=>{T(b)},b=>{C(new O(L.DECODE_AUDIO_FILE_FAILED,b.toString()))})})}(f);return typeof h=="string"&&p&&UU.set(h,m),m}(r,t)}catch(h){return a.onError(h),h.throw(y)}let d=new nn(r),l=new hT(c,d,i?kv(i):{},s);return y.info("create buffer source audio track success, trackId:",s),a.onSuccess(l.getTrackId()),l},setAppType:function(n){if(y.debug("setAppType: ".concat(n)),!(Number.isInteger(n)&&n>=0))throw y.debug("Invalid appType"),new H(L.INVALID_PARAMS,"invalid app type",n);$e("APP_TYPE",Math.floor(n))},setLogLevel:function(n){y.setLogLevel(n)},enableLogUpload:function(){F("USE_NEW_LOG")?$e("UPLOAD_LOG",!0):y.enableLogUpload()},disableLogUpload:function(){F("USE_NEW_LOG")?$e("UPLOAD_LOG",!1):y.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new _m},checkAudioTrackIsActive:async function(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,t=_e.reportApiInvoke(null,{tag:ct.TRACER,name:Yi.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[e]});if(!(n instanceof ri||n instanceof Wd)){let c=new H(L.INVALID_TRACK,"the parameter is not a audio track");return t.onError(c),c.throw()}e&&e<1e3&&(e=1e3);let i=n instanceof ri?n.getTrackLabel():"remote_track",r=n.getVolumeLevel(),o=r,s=r,a=Date.now();return new Z(c=>{let d=setInterval(()=>{let l=n.getVolumeLevel();o=l>o?l:o,s=l<s?l:s;let h=o-s>1e-4,p=Date.now()-a;if(h||p>e){clearInterval(d);let f=h,m={duration:p,deviceLabel:i,maxVolumeLevel:o,result:f};y.info("[track-".concat(n.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(m))),t.onSuccess(m),c(f)}},200)})},checkVideoTrackIsActive:async function(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,t=_e.reportApiInvoke(null,{tag:ct.TRACER,name:Yi.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[e]});if(!(n instanceof Jt||n instanceof D_)){let h=new H(L.INVALID_TRACK,"the parameter is not a video track");return t.onError(h),h.throw()}e&&e<1e3&&(e=1e3);let i=n instanceof Jt?n.getTrackLabel():"remote_track",r=n.getMediaStreamTrack(!0),o=document.createElement("video");o.style.width="1px",o.style.height="1px",o.setAttribute("muted",""),o.muted=!0,o.setAttribute("playsinline",""),o.controls=!1,(Cr()||tT())&&(o.style.opacity="0.01",o.style.position="fixed",o.style.left="0",o.style.top="0",document.body.appendChild(o)),o.srcObject=new MediaStream([r]),o.play();let s=document.createElement("canvas");s.width=160,s.height=120;let a=0,c=0;try{let h=Date.now();a=await function(p,f,m,g){let S,T=0,C=null;return new Z((b,D)=>{function x(){T>g&&S&&(S(),b(T));let k=m.getContext("2d");if(!k){let K=new H(L.UNEXPECTED_ERROR,"can not get canvas 2d context.");return y.error(K.toString()),void D(K)}k.drawImage(p,0,0,160,120);let V=k.getImageData(0,0,m.width,m.height),W=Math.floor(V.data.length/3);if(C){for(let K=0;K<W;K+=3)if(V.data[K]!==C[K])return T+=1,void(C=V.data);C=V.data}else C=V.data}setTimeout(()=>{S&&(S(),b(T))},f),S=dT(()=>{x()},30)})}(o,e,s,4),c=Date.now()-h}catch(h){throw t.onError(h),h}Cz===pt.SAFARI&&(o.pause(),o.remove()),o.srcObject=null;let d=a>4,l={duration:c,changedPicNum:a,deviceLabel:i,result:d};return y.info("[track-".concat(n.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(l))),t.onSuccess(l),d},setArea:fC,audioElementPlayCenter:ko,resumeAudioContext:function(){return ko.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(n){Oz.processExternalMediaAEC(n)},registerExtensions:function(n){let e=F("PLUGIN_INFO")||[];n.forEach(t=>{"name"in t&&!z(e).call(e,t.name)&&e.push(t.name);let i=t;i.__registered__=!0,i.logger.hookLog=y.extLog,i.reporter.hookApiInvoke=_e.extApiInvoke,i.parameters&&Object.keys(i.parameters).forEach(r=>{i.parameters[r]=F(r)})}),cx("PLUGIN_INFO",e)},ChannelMediaRelayError:lo,ChannelMediaRelayEvent:gn,ChannelMediaRelayState:An,RemoteStreamFallbackType:HY,RemoteStreamType:Kf,ConnectionDisconnectedReason:Gt,AudienceLatencyLevelType:SU,AREAS:gt,preload:async function(n,e,t,i){return bL(n,e,t,i)},startLastmileProbeTest:async function(n,e,t,i){let r={state:"unavailable"};await bL(n,e,t,i);let o=await $T({appId:n,cname:e,token:t||n,uid:i,cloudProxyServer:"disabled"});if(!o)return r;await OC(o);let s,a=g2({mode:"rtc",codec:"vp8"});try{s=await a.join(n,e,t,i,{networkQualityProbe:!0})}catch{return r}let c=new wL,d=c.createMuteAudioTrack(),l=await fT({mediaStreamTrack:d});await a.publish([l]);let[h,p,f]=await new Z((b,D)=>{let x=setTimeout(()=>{clearTimeout(x),b([!0,null,"audio"])},5e3);a.on("user-published",async(k,V)=>{k.uid===s&&(clearTimeout(x),b([!1,k,V]))})});if(h||!p)return await a.unpublish([l]),await a.leave(),l.close(),c.close(),r;await a.subscribe(p,f),await new Z((b,D)=>{let x=setTimeout(()=>{clearTimeout(x),b(null)},5e3)});let m=a.getRTCStats(),g=a.getLocalAudioStats(),S=m.RTT,T=g.sendJitterMs,C=g.currentPacketLossRate;return r={state:"complete",rtt:S,packetLossRate:C,jitter:T,networkQuality:((b,D,x)=>{let k=1;if(x>0){let se=Math.log(100*x)/Math.log(2)+1;se=Math.min(5,Math.max(0,se)),k=1-se/5}let V=1;if(b>0){let se=Math.log(b/40)/Math.log(2)+1;se=Math.min(5,Math.max(0,se)),V=1-se/5}let W=1;if(D>0){let se=Math.log(D/10)/Math.log(2.5)+1;se=Math.min(5,Math.max(0,se)),W=1-se/5}let K=.5*k+.3*V+.2*W,J=0;return J=K>=.8?1:K>=.6?2:K>=.4?3:K>=.2?4:5,J})(S,T,C)},await a.unsubscribe(p),await a.unpublish([l]),await a.leave(),l.close(),c.close(),await OC(o),r}});return Object.defineProperties(Kr,{onAudioAutoplayFailed:{get:()=>Lo.onAudioAutoplayFailed,set:n=>{Lo.onAudioAutoplayFailed=n}},onAutoplayFailed:{get:()=>Lo.onAutoplayFailed,set:n=>{Lo.onAutoplayFailed=n}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>Kr._onSecurityPolicyViolation,set(n){Kr._onSecurityPolicyViolation=n,xC(n)}},__CLIENT_LIST__:{get:()=>F("SHOW_GLOBAL_CLIENT_LIST")?Vh:[]}}),Po.on(Bd.CAMERA_DEVICE_CHANGED,n=>{y.info("camera device changed",JSON.stringify(n)),Kr.onCameraChanged&&Kr.onCameraChanged(n),Kr.safeEmit($i.CAMERA_CHANGED,n)}),Po.on(Bd.RECORDING_DEVICE_CHANGED,n=>{y.info("microphone device changed",JSON.stringify(n)),Kr.onMicrophoneChanged&&Kr.onMicrophoneChanged(n),Kr.safeEmit($i.MICROPHONE_CHANGED,n)}),Po.on(Bd.PLAYOUT_DEVICE_CHANGED,n=>{y.debug("playout device changed",JSON.stringify(n)),Kr.onPlaybackDeviceChanged&&Kr.onPlaybackDeviceChanged(n),Kr.safeEmit($i.PLAYBACK_DEVICE_CHANGED,n)}),ko.onAutoplayFailed=()=>{y.info("detect audio element autoplay failed"),Lo.onAudioAutoplayFailed&&Lo.onAudioAutoplayFailed()},Yt.on("autoplay-failed",()=>{y.info("detect webaudio autoplay failed"),Lo.onAudioAutoplayFailed&&Lo.onAudioAutoplayFailed(),Kr.safeEmit($i.AUTOPLAY_FAILED)}),Yt.on(In.STATE_CHANGE,(n,e)=>{y.info("audio context state changed: ".concat(e," => ").concat(n)),Kr.onAudioContextStateChanged&&Kr.onAudioContextStateChanged(n,e),Kr.safeEmit($i.AUDIO_CONTEXT_STATE_CHANGED,n,e)}),Wi.on(yn.NETWORK_STATE_CHANGE,(n,e)=>{y.info("[network-indicator] network state changed, ".concat(e," => ").concat(n))}),window&&(window.__ARTC__=Kr),Kr})}),yZ={};yte(yZ,{AgoraRTCProvider:()=>wZ,AgoraRTCReactError:()=>Rc,AgoraRTCScreenShareProvider:()=>Mte,LocalAudioTrack:()=>LZ,LocalUser:()=>$te,LocalVideoTrack:()=>UZ,RemoteAudioTrack:()=>VZ,RemoteUser:()=>eie,RemoteVideoTrack:()=>FZ,TrackBoundary:()=>Jte,VERSION:()=>rie,default:()=>nie,useAutoPlayAudioTrack:()=>zX,useAutoPlayVideoTrack:()=>YX,useClientEvent:()=>Pte,useConnectionState:()=>xte,useCurrentUID:()=>Vte,useIsConnected:()=>Qy,useJoin:()=>OZ,useLocalCameraTrack:()=>Hte,useLocalMicrophoneTrack:()=>DZ,useLocalScreenTrack:()=>qte,useNetworkQuality:()=>Fte,usePublish:()=>NZ,useRTCClient:()=>fh,useRTCScreenShareClient:()=>Ute,useRemoteAudioTracks:()=>Kte,useRemoteUserTrack:()=>qq,useRemoteUsers:()=>PZ,useRemoteVideoTracks:()=>Yte,useTrackEvent:()=>Lte,useVolumeLevel:()=>jte});var Ate=WR(HR());function Ua(u,_,E){return u.on(_,E),()=>u.off(_,E)}function wte(u){try{return u()}catch(_){console.error(_)}}function KR(u){return()=>u.forEach(wte)}function bte(u,_){let E=setInterval(u,_);return()=>clearInterval(E)}function wV(u,_){let E=setTimeout(u,_);return()=>clearTimeout(E)}function HX(){let u,_,E;function R(){if(_){let de=_;_=void 0,de()}}async function A(){if(E){let de=E;E=void 0;try{await de()}catch(Ie){console.error(Ie)}}}async function P(de){u=!0,await A();try{E=await de()}catch(Ie){console.error(Ie)}u=!1,R()}async function G(){u=!0,await A(),u=!1,R()}function q(de){u?_=()=>P(de):P(de)}function ee(){u?_=G:G()}return{run:q,dispose:ee}}var bV=typeof document<"u"?st.useLayoutEffect:st.useEffect;function Ote(u){return u!=null&&typeof u.then=="function"}function sE(){let u=st.useRef(!1);return st.useEffect(()=>(u.current=!1,()=>{u.current=!0}),[]),u}function Nte(){let u=sE();function _(E,R){return new Promise(async(A,P)=>{try{let G=await E;u.current||A(G)}catch(G){u.current?R&&R(G):P(G)}})}return st.useCallback(_,[u])}function IZ(u){let _=Nte(),[E,R]=st.useState();return bV(()=>{Ote(u)?_(u).then(R):R(u)},[u,_]),E}function YR(u,_){let E=st.useRef();st.useEffect(()=>{let{run:R,dispose:A}=E.current||(E.current=HX());return R(u),A},_)}function Dte(u,_){let E=u.split("."),R=_.split("."),A=Math.max(E.length,R.length);for(let P=0;P<A;P++){let G=parseInt(E[P]||"0"),q=parseInt(R[P]||"0");if(G>q)return 1;if(G<q)return-1}return 0}function Pte(u,_,E){let R=st.useRef(E);bV(()=>{R.current=E},[E]),st.useEffect(()=>{if(u)return Ua(u,_,(...A)=>{R.current&&R.current(...A)})},[_,u])}function Lte(u,_,E){let R=st.useRef(E);bV(()=>{R.current=E},[E]),st.useEffect(()=>{if(u)return Ua(u,_,(...A)=>{R.current&&R.current(...A)})},[_,u])}var AZ=st.createContext(null);function wZ({client:u,children:_}){return Ct.jsx(AZ.Provider,{value:u,children:_})}function kte(u){let _=st.useContext(AZ);return u||_}function fh(u){let _=kte(u);if(!_)throw new Error("Agora RTC client not found. Should be wrapped in <AgoraRTCProvider value={client} />");return _}var bZ=st.createContext(null);function Mte({client:u,children:_}){return Ct.jsx(bZ.Provider,{value:u,children:_})}function Ute(u){let _=st.useContext(bZ);return u||_}function xte(u){let _=fh(u),[E,R]=st.useState(_?_.connectionState:"DISCONNECTED");return st.useEffect(()=>{if(_){R(_.connectionState);let A;return KR([Ua(_,"connection-state-change",P=>{A==null||A(),P==="CONNECTED"?A=wV(()=>R(P),0):R(P)}),()=>A==null?void 0:A()])}else R("DISCONNECTED")},[_]),E}function Qy(u){let _=fh(u),[E,R]=st.useState(_?_.connectionState==="CONNECTED":!1);return st.useEffect(()=>{if(_){R(_.connectionState==="CONNECTED");let A;return KR([Ua(_,"connection-state-change",P=>{A==null||A(),A=wV(()=>R(P==="CONNECTED"),0)}),()=>A==null?void 0:A()])}else R(!1)},[_]),E}function Vte(u){let _=fh(u),[E,R]=st.useState(_==null?void 0:_.uid);return st.useEffect(()=>{if(_)return Ua(_,"connection-state-change",A=>{if(A==="CONNECTED")return wV(()=>R(_.uid),0);A==="DISCONNECTED"&&R(void 0)})},[_]),E}var Rc=class extends Error{constructor(_,E){var u=(...Nre)=>(super(...Nre),p1(this,"rtcMethod"),p1(this,"rtcError"),p1(this,"name","AgoraRTCReactException"),this);u(typeof E=="string"?E:E.message),this.rtcMethod=_,this.rtcError=E}log(_){console[_](this)}};function OZ(u,_=!0,E){let R=fh(E),A=Qy(E),P=st.useRef(),[G,q]=st.useState(!1),[ee,de]=st.useState(0),[Ie,he]=st.useState(null),me=sE();return YR(async()=>{if(me.current||(he(null),de(0),q(!1)),_&&R){try{me.current||q(!0);let{appid:ve,channel:ge,token:Ge,uid:pe}=typeof u=="function"?await u():u,ce=await R.join(ve,ge,Ge,pe);me.current||de(ce)}catch(ve){console.error(ve),me.current||he(new Rc("IAgoraRTCClient.join",ve))}me.current||q(!1);let je=P.current||(P.current=HX());return KR([()=>{je.dispose()},()=>{je.run(()=>R.unpublish(R.localTracks))},()=>{for(let ve of R.localTracks)ve.isPlaying&&ve.stop(),ve.close();je.run(()=>R.leave())}])}},[_,E]),{data:ee,isLoading:G,isConnected:A,error:Ie}}var nJ=()=>({uplinkNetworkQuality:0,downlinkNetworkQuality:0,delay:0});function Fte(u){let _=fh(u),[E,R]=st.useState(nJ);return st.useEffect(()=>{if(_)return Ua(_,"network-quality",A=>R({uplinkNetworkQuality:A.uplinkNetworkQuality,downlinkNetworkQuality:A.downlinkNetworkQuality,delay:_.getRTCStats().RTT??0}));R(nJ())},[_]),E}var Bte=WR(HR());function NZ(u,_=!0,E){let R=fh(E),A=Qy(E),P=st.useRef([]),[G,q]=st.useState(!1),[ee,de]=st.useState(null),Ie=sE();return YR(async()=>{if(Ie.current||(q(!1),de(null)),!R||!A||!_)return;let he=u.filter(Boolean),me=ge=>{let Ge=Dte(Bte.default.VERSION,"4.18.2")>=0;return Ge||new Rc("usePublish","please check your agora-rtc-sdk-ng version in package.json, it's recommend upgrade to >= 4.18.2").log("warn"),Ge?R.mode!=="live"||R.role!=="audience":!0},je=ge=>P.current.some(Ge=>Ge&&Ge.getTrackId()===ge.getTrackId()),ve=ge=>me()&&ge.enabled&&_&&!je(ge);for(let ge=0;ge<he.length;ge++){let Ge=he[ge];if(Ge&&ve(Ge)){await R.unpublish(P.current.filter(pe=>(pe==null?void 0:pe.trackMediaType)===Ge.trackMediaType));try{Ie.current||q(!0),await R.publish(Ge)}catch(pe){console.error(pe),Ie.current||de(new Rc("IAgoraRTCClient.publish",pe))}Ie.current||q(!1)}}P.current=he},[A,_,R,u]),{isLoading:G,error:ee}}function jte(u){let[_,E]=st.useState(0);return st.useEffect(()=>{if(u)return bte(()=>{E(u.getVolumeLevel())},1e3)},[u]),_}var Gte=WR(HR());function DZ(u=!0,_={ANS:!0,AEC:!0}){let[E,R]=st.useState(null),[A,P]=st.useState(!1),[G,q]=st.useState(null),ee=sE();return YR(async()=>{if(ee.current||(P(!1),q(null)),u&&!E){try{ee.current||P(!0);let de=await Gte.default.createMicrophoneAudioTrack(_);ee.current||R(de)}catch(de){console.error(de),ee.current||q(new Rc("IAgoraRTC.createMicrophoneAudioTrack",de))}ee.current||P(!1)}},[u]),{localMicrophoneTrack:E,isLoading:A,error:G}}var Wte=WR(HR());function Hte(u=!0,_){let[E,R]=st.useState(null),[A,P]=st.useState(!1),[G,q]=st.useState(null),ee=sE();return YR(async()=>{if(ee.current||(P(!1),q(null)),u&&!E){try{ee.current||P(!0);let de=await Wte.default.createCameraVideoTrack(_);ee.current||R(de)}catch(de){console.error(de),ee.current||q(new Rc("IAgoraRTC.createCameraVideoTrack",de))}ee.current||P(!1)}},[u]),{localCameraTrack:E,isLoading:A,error:G}}function Kte(u,_){let E=fh(_),[R,A]=st.useState([]),P=Qy(),G=st.useRef([]),[q,ee]=st.useState(!1),[de,Ie]=st.useState(null),he=sE();return YR(async()=>{if(he.current||Ie(null),!Array.isArray(u)||!P)return;let me=async ge=>{if(!ge.audioTrack&&u.some(({uid:Ge})=>ge.uid===Ge)){try{he.current||ee(!0),await E.subscribe(ge,"audio")}catch(Ge){console.error(Ge),he.current||Ie(new Rc("IAgoraRTCClient.subscribe",Ge))}ge.audioTrack&&!G.current.some(Ge=>Ge.getUserId()===ge.uid)&&G.current.push(ge.audioTrack),G.current=G.current.map(Ge=>ge.audioTrack&&Ge.getUserId()===ge.uid&&Ge.getTrackId()!==ge.audioTrack.getTrackId()?ge.audioTrack:Ge),he.current||(A([...G.current]),ee(!1))}},je=async ge=>{if(u.some(({uid:Ge})=>ge.uid===Ge)){he.current||(G.current=G.current.filter(Ge=>Ge.getUserId()!==ge.uid),A([...G.current]));try{he.current||ee(!0),await E.unsubscribe(ge,"audio")}catch(Ge){console.error(Ge),he.current||Ie(new Rc("IAgoraRTCClient.unsubscribe",Ge))}he.current||ee(!1)}};u.map(ge=>{!ge.audioTrack&&ge.hasAudio&&me(ge)});let ve=[];for(let ge=0;ge<G.current.length;ge++){let Ge=G.current[ge];if(!u.some(pe=>pe.uid===Ge.getUserId())){let pe=E.remoteUsers.find(ce=>ce.uid===Ge.getUserId());pe&&ve.push({user:pe,mediaType:"audio"}),G.current.splice(ge,1),ge--}}if(ve.length>0){try{he.current||ee(!0),await E.massUnsubscribe(ve)}catch(ge){console.error(ge),he.current||Ie(new Rc("IAgoraRTCClient.massUnsubscribe",ge))}he.current||(A(G.current.slice()),ee(!1))}return KR([Ua(E,"user-published",(ge,Ge)=>{u.find(pe=>pe.uid===ge.uid)&&Ge==="audio"&&me(ge)}),Ua(E,"user-unpublished",(ge,Ge)=>{u.find(pe=>pe.uid===ge.uid)&&Ge==="audio"&&je(ge)})])},[P,E,u]),{audioTracks:R,isLoading:q,error:de}}function Yte(u,_){let E=fh(_),[R,A]=st.useState([]),P=Qy(),G=st.useRef([]),[q,ee]=st.useState(!1),[de,Ie]=st.useState(null),he=sE();return YR(async()=>{if(he.current||Ie(null),!Array.isArray(u)||!P)return;let me=async ge=>{if(!ge.videoTrack&&u.some(({uid:Ge})=>ge.uid===Ge)){try{he.current||ee(!0),await E.subscribe(ge,"video")}catch(Ge){console.error(Ge),he.current||Ie(new Rc("IAgoraRTCClient.subscribe",Ge))}ge.videoTrack&&!G.current.some(Ge=>Ge.getUserId()===ge.uid)&&G.current.push(ge.videoTrack),G.current=G.current.map(Ge=>ge.videoTrack&&Ge.getUserId()===ge.uid&&Ge.getTrackId()!==ge.videoTrack.getTrackId()?ge.videoTrack:Ge),he.current||(A([...G.current]),ee(!1))}},je=async ge=>{if(u.some(({uid:Ge})=>ge.uid===Ge)){he.current||(G.current=G.current.filter(Ge=>Ge.getUserId()!==ge.uid),A([...G.current]));try{he.current||ee(!0),await E.unsubscribe(ge,"video")}catch(Ge){console.error(Ge),he.current||Ie(new Rc("IAgoraRTCClient.unsubscribe",Ge))}he.current||ee(!1)}};u.map(ge=>{!ge.videoTrack&&ge.hasVideo&&me(ge)});let ve=[];for(let ge=0;ge<G.current.length;ge++){let Ge=G.current[ge];if(!u.some(pe=>pe.uid===Ge.getUserId())){let pe=E.remoteUsers.find(ce=>ce.uid===Ge.getUserId());pe&&ve.push({user:pe,mediaType:"video"}),G.current.splice(ge,1),ge--}}if(ve.length>0){try{he.current||ee(!0),await E.massUnsubscribe(ve)}catch(ge){console.error(ge),he.current||Ie(new Rc("IAgoraRTCClient.massUnsubscribe",ge))}he.current||(A(G.current.slice()),ee(!1))}return KR([Ua(E,"user-published",(ge,Ge)=>{u.find(pe=>pe.uid===ge.uid)&&Ge==="video"&&me(ge)}),Ua(E,"user-unpublished",(ge,Ge)=>{u.find(pe=>pe.uid===ge.uid)&&Ge==="video"&&je(ge)})])},[P,E,u]),{videoTracks:R,isLoading:q,error:de}}function qq(u,_,E){let R=fh(E),A=_==="audio"?"audioTrack":"videoTrack",[P,G]=st.useState(u&&u[A]),q=Qy(),ee=st.useRef(),[de,Ie]=st.useState(!1),[he,me]=st.useState(null);return st.useEffect(()=>{if(!u||!q)return;let je=!1;je||me(null);let ve=_==="audio"?"hasAudio":"hasVideo",ge=u.uid,Ge=async(fe,We)=>{if(fe[A]&&R.remoteUsers.some(({uid:lt})=>fe.uid===lt))try{je||Ie(!0),await R.unsubscribe(fe,We)}catch(lt){je||me(new Rc("IAgoraRTCClient.unsubscribe",lt)),console.error(lt)}je||(G(void 0),Ie(!1))},pe=async(fe,We)=>{try{!fe[A]&&R.remoteUsers.some(({uid:lt})=>fe.uid===lt)&&(je||Ie(!0),await R.subscribe(fe,We)),je||G(fe[A])}catch(lt){je||me(new Rc("IAgoraRTCClient.subscribe",lt)),console.error(lt)}je||Ie(!1)},ce=ee.current||(ee.current=HX());return!u[A]&&u[ve]?ce.run(()=>pe(u,_)):G(u[A]),KR([()=>{je=!0,ce.dispose()},Ua(R,"user-published",(fe,We)=>{fe.uid===ge&&We===_&&ce.run(()=>pe(fe,_))}),Ua(R,"user-unpublished",(fe,We)=>{fe.uid===ge&&We===_&&ce.run(()=>Ge(fe,_))})])},[q,R,u,_,A]),{track:P,isLoading:de,error:he}}function PZ(u){let _=fh(u),[E,R]=st.useState(_?_.remoteUsers:[]);return st.useEffect(()=>{if(_){let A=()=>R(_.remoteUsers.slice());return KR([Ua(_,"user-joined",A),Ua(_,"user-left",A),Ua(_,"user-published",A),Ua(_,"user-unpublished",A)])}},[_]),E}var zte=WR(HR());function qte(u=!0,_,E){let[R,A]=st.useState(null),[P,G]=st.useState(!1),[q,ee]=st.useState(null),de=sE();return YR(async()=>{if(de.current||(G(!1),ee(null)),u&&!R){try{de.current||G(!0);let Ie=await zte.default.createScreenVideoTrack(_,E);de.current||A(Ie)}catch(Ie){console.error(Ie),de.current||ee(new Rc("IAgoraRTC.createScreenVideoTrack",Ie))}de.current||G(!1)}},[u]),{screenTrack:R,isLoading:P,error:q}}function Xte(){let u=new Map,_=1500;return{onMount:E=>{let R=u.get(E);R&&(R(),u.delete(E))},onUnmount:E=>{let R=u.get(E);R&&R(),u.set(E,wV(()=>{E.isPlaying&&E.stop(),u.delete(E)},_))},dispose:()=>{for(let[E,R]of u)E.isPlaying&&E.stop(),R&&R();u.clear()}}}var KX=st.createContext(void 0);function Jte({children:u}){let[_]=st.useState(Xte);return st.useEffect(()=>_.dispose,[_]),Ct.jsx(KX.Provider,{value:_,children:u})}function YX(u,_,E,R){let A=st.useContext(KX);st.useEffect(()=>{if(u)return R&&_?u.play(R,E||void 0):u.stop(),A?(A.onMount(u),()=>A.onUnmount(u)):()=>{u.isPlaying&&u.stop()}},[u,R,_,A,E])}function zX(u,_){let E=st.useContext(KX);bV(()=>{if(u)return _?u.play():u.stop(),E?(E.onMount(u),()=>E.onUnmount(u)):()=>{u.isPlaying&&u.stop()}},[u,_,E])}function LZ({track:u,play:_=!1,volume:E,disabled:R,muted:A,children:P}){let G=IZ(u);return zX(G,_),st.useEffect(()=>{G&&E!=null&&G.setVolume(E)},[G,E]),st.useEffect(()=>{G&&R!=null&&G.setEnabled(!R).catch(console.warn)},[R,G]),st.useEffect(()=>{G&&A!=null&&G.setMuted(A).catch(console.warn)},[A,G]),P?Ct.jsx(Ct.Fragment,{children:P}):null}var kZ={position:"relative",width:"100%",height:"100%",overflow:"hidden",background:"#000"},MZ={width:"100%",height:"100%"},qX={position:"absolute",top:0,left:0,width:"100%",height:"100%",overflow:"hidden",zIndex:2},OV=(u,_)=>st.useMemo(()=>({...u,..._}),[u,_]);function UZ({track:u,play:_,disabled:E,muted:R,style:A,videoPlayerConfig:P,...G}){let q=OV(MZ,A),[ee,de]=st.useState(null),Ie=IZ(u);return YX(Ie,_,P,ee),st.useEffect(()=>{Ie&&E!=null&&Ie.setEnabled(!E).catch(console.warn)},[E,Ie]),st.useEffect(()=>{Ie&&R!=null&&Ie.setMuted(R).catch(console.warn)},[R,Ie]),Ct.jsx("div",{...G,ref:de,style:q})}var Qte={width:"100%",height:"100%",background:"#1a1e21 center/cover no-repeat",filter:"blur(16px) brightness(0.4)"},Zte={position:"absolute",top:"50%",left:"50%",maxWidth:"50%",maxHeight:"50%",aspectRatio:"1",transform:"translate(-50%, -50%)",borderRadius:"50%",overflow:"hidden",objectFit:"cover"};function xZ({cover:u}){return Ct.jsx("div",{style:qX,children:typeof u=="string"?Ct.jsxs(Ct.Fragment,{children:[Ct.jsx("div",{style:{...Qte,backgroundImage:`url(${u})`}}),Ct.jsx("img",{src:u,style:Zte})]}):u()})}function $te({micOn:u,cameraOn:_,audioTrack:E,videoTrack:R,playAudio:A,playVideo:P,volume:G,cover:q,children:ee,style:de,...Ie}){let he=OV(kZ,de);return P=P??!!_,A=A??!!u,Ct.jsxs("div",{...Ie,style:he,children:[Ct.jsx(UZ,{disabled:!_,play:P,track:R}),Ct.jsx(LZ,{disabled:!u,play:A,track:E,volume:G}),q&&!_&&Ct.jsx(xZ,{cover:q}),Ct.jsx("div",{style:qX,children:ee})]})}function VZ({track:u,play:_=!1,playbackDeviceId:E,volume:R,children:A}){return zX(u,_),st.useEffect(()=>{u&&E!=null&&u.setPlaybackDevice(E).catch(console.warn)},[u,E]),st.useEffect(()=>{u&&R!=null&&u.setVolume(R)},[u,R]),A?Ct.jsx(Ct.Fragment,{children:A}):null}function FZ({track:u,play:_,style:E,videoPlayerConfig:R,...A}){let P=OV(MZ,E),[G,q]=st.useState(null);return YX(u,_,R,G),Ct.jsx("div",{...A,ref:q,style:P})}function eie({user:u,playVideo:_,playAudio:E,playbackDeviceId:R,volume:A,cover:P,style:G,children:q,videoPlayerConfig:ee,...de}){let Ie=OV(kZ,G),{track:he}=qq(u,"video"),{track:me}=qq(u,"audio");return _=_??(u==null?void 0:u.hasVideo),E=E??(u==null?void 0:u.hasAudio),Ct.jsxs("div",{...de,style:Ie,children:[Ct.jsx(FZ,{play:_,track:he,videoPlayerConfig:ee}),Ct.jsx(VZ,{play:E,playbackDeviceId:R,track:me,volume:A}),P&&!_&&Ct.jsx(xZ,{cover:P}),Ct.jsx("div",{style:qX,children:q})]})}var tie=WR(HR()),iie=class{constructor(){p1(this,"appType",1001);tie.default.setAppType(this.appType)}};new iie;var rie="2.5.1";Ite(yZ,WR(HR()));var nie=Ate.default;const oie=Ete.createClient({mode:"rtc",codec:"vp8"});function sie(){const[u,_]=st.useState(!1),{localMicrophoneTrack:E}=DZ(u);OZ({appid:"161ad5133c9045ac92e07b16d06711b3",channel:"main-room",token:null},u),NZ([E]);const R=PZ();return Ct.jsxs("div",{style:{padding:"10px",background:u?"#e8f5e9":"#f5f5f5",borderBottom:"1px solid #ddd",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[Ct.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px"},children:[Ct.jsx("button",{onClick:()=>_(!u),style:{backgroundColor:u?"#ff4d4d":"#4CAF50",color:"white",padding:"8px 16px",border:"none",borderRadius:"20px",cursor:"pointer",fontWeight:"bold",fontSize:"12px"},children:u?"End Call ":"Join Voice Room "}),u&&Ct.jsx("span",{style:{color:"green",fontSize:"12px"},children:" Mic Live"})]}),Ct.jsxs("span",{style:{fontSize:"12px",color:"#666"},children:["Users: ",Ct.jsx("strong",{children:R.length+(u?1:0)})]})]})}function aie(){return Ct.jsx(wZ,{client:oie,children:Ct.jsx(sie,{})})}const cie=()=>{const[u,_]=st.useState(null),[E,R]=st.useState(""),[A,P]=st.useState([{role:"ai",text:"Hello! Upload a PDF to start chatting."}]),[G,q]=st.useState(!1),[ee,de]=st.useState(""),Ie=st.useRef(null);st.useEffect(()=>{var ge;(ge=Ie.current)==null||ge.scrollIntoView({behavior:"smooth"})},[A]);const he=ge=>new Promise((Ge,pe)=>{const ce=new FileReader;ce.readAsDataURL(ge),ce.onload=()=>Ge(ce.result.split(",")[1]),ce.onerror=fe=>pe(fe)}),me=async ge=>{const Ge=ge.target.files[0];if(Ge){const pe=URL.createObjectURL(Ge);_(pe),de("Uploading to Brain... ");try{const ce=await he(Ge);(await fetch("http://localhost:5000/extract",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pdf:ce})})).ok?(de(" Ready! Ask me anything."),P(We=>[...We,{role:"ai",text:"I have read the document! What do you want to know?"}])):de(" Upload Failed.")}catch(ce){console.error(ce),de(" Server Error (Is Backend Running?)")}}},je=async()=>{if(!E.trim())return;const ge=E;R(""),P(Ge=>[...Ge,{role:"user",text:ge}]),q(!0);try{const Ge=await fetch("http://localhost:5000/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:ge})}),pe=await Ge.json();Ge.status===400&&pe.error==="No PDF uploaded yet"?P(ce=>[...ce,{role:"ai",text:" I lost the file! Please upload the PDF again."}]):P(ce=>[...ce,{role:"ai",text:pe.answer||"I didn't get an answer."}])}catch{P(pe=>[...pe,{role:"ai",text:" Error: Could not connect to Backend."}])}q(!1)},ve=ge=>{ge.key==="Enter"&&je()};return Ct.jsxs("div",{style:{height:"100%",display:"flex",flexDirection:"column",fontFamily:"Arial, sans-serif"},children:[Ct.jsxs("div",{style:{padding:"15px",background:"#333",color:"white",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[Ct.jsx("h2",{style:{margin:0},children:" DocuChat & Call"}),Ct.jsxs("div",{children:[Ct.jsx("input",{type:"file",accept:"application/pdf",onChange:me,style:{color:"white"}}),Ct.jsx("span",{style:{marginLeft:"10px",fontSize:"14px",color:"#4CAF50"},children:ee})]})]}),Ct.jsxs("div",{style:{flex:1,display:"flex",overflow:"hidden"},children:[Ct.jsx("div",{style:{flex:1,borderRight:"2px solid #ddd",background:"#525659"},children:u?Ct.jsx("iframe",{src:u,width:"100%",height:"100%",style:{border:"none"},title:"PDF"}):Ct.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",color:"white"},children:Ct.jsx("p",{children:" Upload a PDF to see it here"})})}),Ct.jsxs("div",{style:{width:"400px",display:"flex",flexDirection:"column",background:"#f5f5f5"},children:[Ct.jsx(aie,{}),Ct.jsx("div",{style:{padding:"10px",background:"#2c3e50",color:"white",textAlign:"center"},children:Ct.jsx("h4",{style:{margin:0},children:" AI Assistant"})}),Ct.jsxs("div",{style:{flex:1,padding:"20px",overflowY:"auto",display:"flex",flexDirection:"column",gap:"15px"},children:[A.map((ge,Ge)=>Ct.jsxs("div",{style:{alignSelf:ge.role==="user"?"flex-end":"flex-start",maxWidth:"80%",padding:"12px 16px",borderRadius:"12px",background:ge.role==="user"?"#007bff":"white",color:ge.role==="user"?"white":"black",boxShadow:"0 1px 2px rgba(0,0,0,0.1)",lineHeight:"1.4"},children:[Ct.jsxs("strong",{children:[ge.role==="user"?"You":"AI",":"]})," ",ge.text]},Ge)),G&&Ct.jsx("div",{style:{alignSelf:"flex-start",fontStyle:"italic",color:"#666"},children:"Thinking... "}),Ct.jsx("div",{ref:Ie})]}),Ct.jsxs("div",{style:{padding:"20px",background:"white",borderTop:"1px solid #ddd",display:"flex",gap:"10px"},children:[Ct.jsx("input",{type:"text",value:E,onChange:ge=>R(ge.target.value),onKeyDown:ve,placeholder:"Ask a question...",style:{flex:1,padding:"12px",borderRadius:"4px",border:"1px solid #ccc",fontSize:"16px"}}),Ct.jsx("button",{onClick:je,disabled:G,style:{padding:"12px 24px",background:G?"#ccc":"#28a745",color:"white",border:"none",borderRadius:"4px",cursor:G?"not-allowed":"pointer",fontWeight:"bold"},children:"Send"})]})]})]})]})};function die(){return Ct.jsx(Ct.Fragment,{children:Ct.jsx(fte,{children:Ct.jsx(cie,{})})})}EZ(document.getElementById("root")).render(Ct.jsx(st.StrictMode,{children:Ct.jsx(die,{})}));
